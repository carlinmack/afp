<div id="Alternate">
<div class="head">
<h1>Theory Alternate</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Alternating Function Iteration›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Alternate
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">alternate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">alternate</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">0</span> <span class="main">=</span> id"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">alternate</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">alternate</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> alternate_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"alternate <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> even <span class="free">k</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="keyword1">else</span> <span class="free">g</span><span class="main">)</span> <span class="main">∘</span> alternate <span class="free">f</span> <span class="free">g</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>0<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"alternate <span class="skolem">f</span> <span class="skolem">g</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> alternate <span class="skolem">g</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> even <span class="skolem">k</span> <span class="keyword1">then</span> <span class="skolem">g</span> <span class="keyword1">else</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span>alternate <span class="skolem">g</span> <span class="skolem">f</span> <span class="skolem">k</span> <span class="main">∘</span> <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> even <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="keyword1">then</span> <span class="skolem">f</span> <span class="keyword1">else</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">∘</span> alternate <span class="skolem">f</span> <span class="skolem">g</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">declare</span></span> alternate.simps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

  <span class="keyword1"><span class="command">lemma</span></span> alternate_antimono<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"antimono <span class="main">(</span>alternate <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">l</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> le_Suc_ex 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"alternate <span class="free">f</span> <span class="free">g</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> alternate <span class="free">f</span> <span class="free">g</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>0<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"alternate <span class="free">f</span> <span class="free">g</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> alternate <span class="free">f</span> <span class="free">g</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_funI<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> alternate <span class="free">f</span> <span class="free">g</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"alternate <span class="free">f</span> <span class="free">g</span> <span class="skolem">l</span> <span class="main">≤</span> alternate <span class="free">f</span> <span class="free">g</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">unfolding</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Graph">
<div class="head">
<h1>Theory Graph</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Run Graphs›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Graph
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Transition_Systems_and_Automata/NBA.html">Transition_Systems_and_Automata.NBA</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'state</span> node <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> <span class="tfree">'state</span>"</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">ginitial</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">×</span> initial <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gaccepting</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> accepting <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∘</span> snd"</span></span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> graph<span class="main">:</span> transition_system_initial
    <span class="quoted"><span class="quoted">"const"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">u</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="free">w</span> <span class="main">!!</span> <span class="bound">k</span> <span class="main">∈</span> alphabet <span class="free">A</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> <span class="main">{</span>Suc <span class="bound">k</span><span class="main">}</span> <span class="main">×</span> transition <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∩</span> <span class="free">V</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> ginitial <span class="free">A</span> <span class="main">∩</span> <span class="free">V</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">A</span> <span class="free">w</span> <span class="free">V</span>
    <span class="keyword2"><span class="keyword">defines</span></span>
      gpath <span class="main">=</span> <span class="quoted">graph.path</span> <span class="keyword2"><span class="keyword">and</span></span> grun <span class="main">=</span> <span class="quoted">graph.run</span> <span class="keyword2"><span class="keyword">and</span></span>
      greachable <span class="main">=</span> <span class="quoted">graph.reachable</span> <span class="keyword2"><span class="keyword">and</span></span> gnodes <span class="main">=</span> <span class="quoted">graph.nodes</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We disable rules that are degenerate due to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">execute</span></span> <span class="main"><span class="main">=</span></span> const"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
  <span class="keyword1"><span class="command">declare</span></span> graph.reachable.execute<span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> graph.nodes.execute<span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword">del</span><span class="main">]</span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gtarget</span> <span class="main">≡</span> graph.target"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gstates</span> <span class="main">≡</span> graph.states"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gtrace</span> <span class="main">≡</span> graph.trace"</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">gsuccessors</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'label</span> stream <span class="main">⇒</span>
    <span class="tfree">'state</span> node set <span class="main">⇒</span> <span class="tfree">'state</span> node <span class="main">⇒</span> <span class="tfree">'state</span> node set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">gsuccessors</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">≡</span> graph.successors <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'label</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gusuccessors</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> gsuccessors <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> UNIV"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gupath</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> gpath <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> UNIV"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gurun</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> grun <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> UNIV"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gureachable</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> greachable <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> UNIV"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gunodes</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> gnodes <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> UNIV"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> gtarget_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"gtarget <span class="free">r</span> <span class="free">v</span> <span class="main">=</span> last <span class="main">(</span><span class="free">v</span> <span class="main">#</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fold_const <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">lemma</span></span> gstates_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"gstates <span class="free">r</span> <span class="free">v</span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">lemma</span></span> gtrace_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"gtrace <span class="free">r</span> <span class="free">v</span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">lemma</span></span> gpath_elim<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gpath <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="free">s</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span> <span class="free">k</span> <span class="free">p</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="main">[</span>Suc <span class="free">k</span> <span class="main">..&lt;</span> Suc <span class="free">k</span> <span class="main">+</span> length <span class="free">r</span><span class="main">]</span> <span class="main">||</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">||</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">t</span> <span class="main">=</span> length <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> zip_map_fst_snd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">[</span>Suc <span class="skolem">k</span> <span class="main">..&lt;</span> Suc <span class="skolem">k</span> <span class="main">+</span> length <span class="skolem">r</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms 1 2
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>nil <span class="skolem">v</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_0_right le_add1 length_0_conv length_zip min.idem upt_conv_Nil<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">u</span> <span class="skolem">v</span> <span class="skolem">s</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">||</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span>hd <span class="skolem">t</span><span class="main">,</span> hd <span class="skolem">r</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>tl <span class="skolem">t</span> <span class="main">||</span> tl <span class="skolem">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> hd_Cons_tl neq_Nil_conv zip.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> zip_Cons_Cons zip_Nil<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> tl <span class="skolem">t</span> <span class="main">||</span> tl <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cons 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> hd <span class="skolem">t</span> <span class="main">#</span> tl <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cons<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hd_Cons_tl list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> zip_Nil<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">t</span> <span class="main">=</span> Suc <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> cons.hyps<span class="main">(</span>1<span class="main">)</span> cons.prems<span class="main">(</span>1<span class="main">)</span> cons.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tl <span class="skolem">t</span> <span class="main">=</span> <span class="main">[</span>Suc <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">..&lt;</span> Suc <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">+</span> length <span class="main">(</span>tl <span class="skolem">r</span><span class="main">)</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cons<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 2<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> <span class="quoted"><span class="quoted">‹hd <span class="skolem">t</span> <span class="main">=</span> Suc <span class="skolem">k</span>›</span></span> cons.prems<span class="main">(</span>1<span class="main">)</span> cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> cons.prems<span class="main">(</span>2<span class="main">)</span> upt_rec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that 1 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> gpath_path<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">A</span> <span class="main">(</span>stake <span class="main">(</span>length <span class="free">r</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="free">k</span> <span class="free">w</span><span class="main">)</span> <span class="main">||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span> <span class="main">⟷</span>
    gpath <span class="free">A</span> <span class="free">w</span> UNIV <span class="main">(</span><span class="main">[</span>Suc <span class="free">k</span> <span class="main">..&lt;</span> Suc <span class="free">k</span> <span class="main">+</span> length <span class="free">r</span><span class="main">]</span> <span class="main">||</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nil<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">q</span> <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">A</span> <span class="main">(</span>stake <span class="main">(</span>length <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">||</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">⟷</span>
      gpath <span class="free">A</span> <span class="free">w</span> UNIV <span class="main">(</span><span class="main">[</span>Suc <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">..&lt;</span> Suc <span class="skolem">k</span> <span class="main">+</span> length <span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">)</span><span class="main">]</span> <span class="main">||</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>length <span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="skolem">k</span> <span class="free">w</span><span class="main">)</span> <span class="main">||</span> <span class="skolem">q</span> <span class="main">#</span> <span class="skolem">r</span> <span class="main">=</span>
      <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>stake <span class="main">(</span>length <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">||</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path <span class="free">A</span> <span class="main">…</span> <span class="skolem">p</span> <span class="main">⟷</span>
      gpath <span class="free">A</span> <span class="free">w</span> UNIV <span class="main">(</span><span class="main">(</span>Suc <span class="skolem">k</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span>Suc <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">..&lt;</span> Suc <span class="skolem">k</span> <span class="main">+</span> length <span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">)</span><span class="main">]</span> <span class="main">||</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="skolem">k</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span>Suc <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">..&lt;</span> Suc <span class="skolem">k</span> <span class="main">+</span> length <span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">)</span><span class="main">]</span> <span class="main">||</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span>
      Suc <span class="skolem">k</span> <span class="main">#</span> <span class="main">[</span>Suc <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">..&lt;</span> Suc <span class="skolem">k</span> <span class="main">+</span> length <span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">)</span><span class="main">]</span> <span class="main">||</span> <span class="skolem">q</span> <span class="main">#</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> zip_Cons_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span> <span class="main">#</span> <span class="main">[</span>Suc <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">..&lt;</span> Suc <span class="skolem">k</span> <span class="main">+</span> length <span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span>Suc <span class="skolem">k</span> <span class="main">..&lt;</span> Suc <span class="skolem">k</span> <span class="main">+</span> length <span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">)</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_rec<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> grun_elim<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"grun <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="free">s</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span> <span class="free">k</span> <span class="free">p</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> fromN <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">|||</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">|||</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> szip_smap <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> fromN <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> 1 2
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> eq_scons <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> graph.run.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that 1 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> run_grun<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="main">(</span>sdrop <span class="free">k</span> <span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gurun <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>fromN <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nba.run.cases<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> grun_run<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"grun <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="main">(</span>fromN <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="main">(</span>sdrop <span class="free">k</span> <span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">ka</span> <span class="bound">wa</span><span class="main">.</span> sdrop <span class="skolem">k</span> <span class="main">(</span>stl <span class="skolem">w</span> <span class="main">::</span> <span class="tfree">'a</span> stream<span class="main">)</span> <span class="main">=</span> sdrop <span class="bound">ka</span> <span class="bound">wa</span> <span class="main">∧</span> <span class="skolem">P</span> <span class="bound">ka</span> <span class="bound">wa</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">P</span> <span class="skolem">k</span> <span class="skolem">w</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sdrop.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> 2 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> graph.run.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> greachable_reachable<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">l</span> <span class="free">q</span> <span class="free">k</span> <span class="free">p</span>
    <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≡</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≡</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> reachable <span class="free">A</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span> 1<span class="main">,</span> 2<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> reflexive
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>execute <span class="skolem">u</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> successors <span class="free">A</span> <span class="main">(</span>snd <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> execute <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">u</span> <span class="main">∈</span> reachable <span class="free">A</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> execute <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> reachable <span class="free">A</span> <span class="main">(</span>snd <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> gnodes_nodes<span class="main">:</span> <span class="quoted"><span class="quoted">"gnodes <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="main">⊆</span> UNIV <span class="main">×</span> nodes <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> gnodes <span class="free">A</span> <span class="free">w</span> <span class="free">V</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> UNIV <span class="main">×</span> nodes <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> gpath_subset<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gpath <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="free">r</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>gstates <span class="free">r</span> <span class="free">v</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gpath <span class="free">A</span> <span class="free">w</span> <span class="free">U</span> <span class="free">r</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">lemma</span></span> grun_subset<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"grun <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="free">r</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span>gtrace <span class="free">r</span> <span class="free">v</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"grun <span class="free">A</span> <span class="free">w</span> <span class="free">U</span> <span class="free">r</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>run <span class="skolem">a</span> <span class="skolem">s</span> <span class="skolem">r</span> <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"grun <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="skolem">s</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> run<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> gusuccessors <span class="free">A</span> <span class="free">w</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> run<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 run<span class="main">(</span>1<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> greachable_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="free">v</span> <span class="main">⊆</span> insert <span class="free">v</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> insert <span class="free">v</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> gtrace_infinite<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"grun <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="free">r</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>sset <span class="main">(</span>gtrace <span class="free">r</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> grun_elim gtrace_alt_def infinite_Ici sset_fromN sset_szip_finite<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> infinite_greachable_gtrace<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"grun <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="free">r</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> sset <span class="main">(</span>gtrace <span class="free">r</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> gtrace <span class="free">r</span> <span class="free">v</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sset_range imageE assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"gtarget <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 sscan_snth <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>sset <span class="main">(</span>sdrop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>gtrace <span class="free">r</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gtrace_infinite<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set finite_Un sset_shift stake_sdrop<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sdrop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>gtrace <span class="free">r</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> gtrace <span class="main">(</span>sdrop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sset <span class="main">…</span> <span class="main">⊆</span> greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="free">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> graph.reachable.reflexive graph.reachable_trace graph.run_sdrop<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> finite_nodes_gsuccessors<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>gusuccessors <span class="free">A</span> <span class="free">w</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gusuccessors <span class="free">A</span> <span class="free">w</span> <span class="free">v</span> <span class="main">⊆</span> gureachable <span class="free">A</span> <span class="free">w</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> UNIV <span class="main">×</span> nodes <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gnodes_nodes <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"gusuccessors <span class="free">A</span> <span class="free">w</span> <span class="free">v</span> <span class="main">⊆</span> UNIV <span class="main">×</span> nodes <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gusuccessors <span class="free">A</span> <span class="free">w</span> <span class="free">v</span> <span class="main">⊆</span> <span class="main">{</span>Suc <span class="main">(</span>fst <span class="free">v</span><span class="main">)</span><span class="main">}</span> <span class="main">×</span> nodes <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Ranking">
<div class="head">
<h1>Theory Ranking</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Rankings›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Ranking
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Alternate.html">Alternate</a>"</span>
  <span class="quoted">"<a href="Graph.html">Graph</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Rankings›</span></span>

  <span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'state</span> ranking <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> node <span class="main">⇒</span> nat"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">ranking</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'label</span> stream <span class="main">⇒</span> <span class="tfree">'state</span> ranking <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ranking</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">∈</span> gunodes <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">v</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">∈</span> gunodes <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">.</span> <span class="main">∀</span> <span class="bound">u</span> <span class="main">∈</span> gusuccessors <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">u</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">v</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">∈</span> gunodes <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">.</span> gaccepting <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">v</span> <span class="main">⟶</span> even <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">∈</span> gunodes <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">.</span> <span class="main">∀</span> <span class="bound">r</span> <span class="bound">k</span><span class="main">.</span> gurun <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">r</span> <span class="bound">v</span> <span class="main">⟶</span> smap <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>gtrace <span class="bound">r</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> sconst <span class="bound">k</span> <span class="main">⟶</span> odd <span class="bound">k</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Ranking Implies Word not in Language›</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> ranking_stuck<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ranking <span class="free">A</span> <span class="free">w</span> <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"gurun <span class="free">A</span> <span class="free">w</span> <span class="free">r</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">n</span> <span class="free">k</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"smap <span class="free">f</span> <span class="main">(</span>gtrace <span class="main">(</span>sdrop <span class="free">n</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="free">n</span> <span class="free">r</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sconst <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">u</span> <span class="main">≤</span> <span class="free">f</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> gusuccessors <span class="free">A</span> <span class="free">w</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span> <span class="skolem">u</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> that <span class="keyword1"><span class="command">unfolding</span></span> ranking_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span><span class="free">v</span> <span class="main">##</span> gtrace <span class="free">r</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"sdescending <span class="main">(</span>smap <span class="free">f</span> <span class="main">(</span><span class="free">v</span> <span class="main">##</span> gtrace <span class="free">r</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sdescending.coinduct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> sdescending
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">##</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> stream.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sdescending<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"gurun <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">##</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sdescending<span class="main">(</span>2<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> gusuccessors <span class="free">A</span> <span class="free">w</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> gureachable <span class="free">A</span> <span class="free">w</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> graph.reachable_successors 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> 1
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI disjI1<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">u</span> <span class="main">≤</span> <span class="free">f</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 2 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span><span class="skolem">u</span> <span class="main">##</span> gtrace <span class="skolem">s</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gurun <span class="free">A</span> <span class="free">w</span> <span class="skolem">s</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"smap <span class="free">f</span> <span class="main">(</span><span class="free">v</span> <span class="main">##</span> gtrace <span class="free">r</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">@-</span> sconst <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sdescending_stuck<span class="main">[</span><span class="operator">OF</span> 2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gtrace <span class="main">(</span>sdrop <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> sdrop <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>gtrace <span class="free">r</span> <span class="free">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sscan_sdrop <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smap <span class="free">f</span> <span class="main">…</span> <span class="main">=</span> sdrop <span class="main">(</span>length <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>smap <span class="free">f</span> <span class="main">(</span><span class="free">v</span> <span class="main">##</span> gtrace <span class="free">r</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"3"</span> id_apply sdrop_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sdrop_smap sdrop_stl shift_eq siterate.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> stream.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sconst <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 3 <span class="keyword1"><span class="command">using</span></span> shift_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> ranking_stuck_odd<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ranking <span class="free">A</span> <span class="free">w</span> <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"gurun <span class="free">A</span> <span class="free">w</span> <span class="free">r</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">n</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Ball <span class="main">(</span>sset <span class="main">(</span>smap <span class="free">f</span> <span class="main">(</span>gtrace <span class="main">(</span>sdrop <span class="free">n</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="free">n</span> <span class="free">r</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> odd"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"smap <span class="free">f</span> <span class="main">(</span>gtrace <span class="main">(</span>sdrop <span class="skolem">n</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="skolem">n</span> <span class="free">r</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sconst <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ranking_stuck assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"gtarget <span class="main">(</span>stake <span class="skolem">n</span> <span class="free">r</span><span class="main">)</span> <span class="free">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> graph.nodes_target graph.run_stake<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"gurun <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>sdrop <span class="skolem">n</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="skolem">n</span> <span class="free">r</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> graph.run_sdrop<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"odd <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3 assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> ranking_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
    <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"Ball <span class="main">(</span>sset <span class="main">(</span>smap <span class="free">f</span> <span class="main">(</span>gtrace <span class="main">(</span>sdrop <span class="skolem">n</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="skolem">n</span> <span class="free">r</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> odd"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> ranking_language<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ranking <span class="free">A</span> <span class="free">w</span> <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∉</span> language <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> language <span class="free">A</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> initial <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>accepting <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fromN <span class="main">1</span> <span class="main">|||</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"gurun <span class="free">A</span> <span class="free">w</span> <span class="var">?r</span> <span class="var">?v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> run_grun<span class="main">)</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"Ball <span class="main">(</span>sset <span class="main">(</span>smap <span class="free">f</span> <span class="main">(</span>gtrace <span class="main">(</span>sdrop <span class="skolem">n</span> <span class="var">?r</span><span class="main">)</span> <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="skolem">n</span> <span class="var">?r</span><span class="main">)</span> <span class="var">?v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> odd"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ranking_stuck_odd assms 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"stake <span class="skolem">n</span> <span class="var">?r</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sdrop <span class="skolem">n</span> <span class="var">?r</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gtarget <span class="var">?s</span> <span class="var">?v</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span>gtrace <span class="var">?t</span> <span class="var">?u</span><span class="main">)</span> <span class="main">⊆</span> gureachable <span class="free">A</span> <span class="free">w</span> <span class="var">?v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> graph.reachable_trace graph.reachable_target graph.reachable.reflexive<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gupath <span class="free">A</span> <span class="free">w</span> <span class="var">?s</span> <span class="var">?v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> graph.run_stake 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gurun <span class="free">A</span> <span class="free">w</span> <span class="var">?t</span> <span class="var">?u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> graph.run_sdrop 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span>gtrace <span class="var">?t</span> <span class="var">?u</span><span class="main">)</span> <span class="main">⊆</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span> <span class="main">⟹</span> gaccepting <span class="free">A</span> <span class="bound">p</span> <span class="main">⟹</span> even <span class="main">(</span><span class="free">f</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ranking_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 9<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> sset <span class="main">(</span>gtrace <span class="var">?t</span> <span class="var">?u</span><span class="main">)</span> <span class="main">⟹</span> gaccepting <span class="free">A</span> <span class="bound">p</span> <span class="main">⟹</span> even <span class="main">(</span><span class="free">f</span> <span class="bound">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 7 8 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> 19<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>accepting <span class="free">A</span><span class="main">)</span> <span class="main">(</span>smap snd <span class="var">?r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 18<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>gaccepting <span class="free">A</span><span class="main">)</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 19 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 17<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>gaccepting <span class="free">A</span><span class="main">)</span> <span class="main">(</span>gtrace <span class="var">?r</span> <span class="var">?v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 18 <span class="keyword1"><span class="command">unfolding</span></span> gtrace_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 16<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>gaccepting <span class="free">A</span><span class="main">)</span> <span class="main">(</span>gtrace <span class="main">(</span><span class="var">?s</span> <span class="main">@-</span> <span class="var">?t</span><span class="main">)</span> <span class="var">?v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 17 <span class="keyword1"><span class="command">unfolding</span></span> stake_sdrop <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 15<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>gaccepting <span class="free">A</span><span class="main">)</span> <span class="main">(</span>gtrace <span class="var">?t</span> <span class="var">?u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 16 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 13<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>even <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>gtrace <span class="var">?t</span> <span class="var">?u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> infs_mono<span class="main">[</span><span class="operator">OF</span> _ 15<span class="main">]</span> 9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 12<span class="main">:</span> <span class="quoted"><span class="quoted">"infs even <span class="main">(</span>smap <span class="free">f</span> <span class="main">(</span>gtrace <span class="var">?t</span> <span class="var">?u</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 13 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"Bex <span class="main">(</span>sset <span class="main">(</span>smap <span class="free">f</span> <span class="main">(</span>gtrace <span class="var">?t</span> <span class="var">?u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> even"</span></span> <span class="keyword1"><span class="command">using</span></span> 12 infs_any <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> 4 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Word not in Language Implies Ranking›</span></span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Removal of Endangered Nodes›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">clean</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'label</span> stream <span class="main">⇒</span> <span class="tfree">'state</span> node set <span class="main">⇒</span> <span class="tfree">'state</span> node set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">clean</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">v</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">.</span> infinite <span class="main">(</span>greachable <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="bound">v</span><span class="main">)</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> clean_decreasing<span class="main">:</span> <span class="quoted"><span class="quoted">"clean <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> clean_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">lemma</span></span> clean_successors<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> gusuccessors <span class="free">A</span> <span class="free">w</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> clean <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> clean <span class="free">A</span> <span class="free">w</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> clean <span class="free">A</span> <span class="free">w</span> <span class="free">V</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> clean_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> graph.reachable.execute assms<span class="main">(</span>2<span class="main">)</span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="free">u</span> <span class="main">⊆</span> greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> infinite_super<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> clean <span class="free">A</span> <span class="free">w</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> clean_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Removal of Safe Nodes›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">prune</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'label</span> stream <span class="main">⇒</span> <span class="tfree">'state</span> node set <span class="main">⇒</span> <span class="tfree">'state</span> node set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">prune</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">v</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">.</span> <span class="main">∃</span> <span class="bound">u</span> <span class="main">∈</span> greachable <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="bound">v</span><span class="main">.</span> gaccepting <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">u</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> prune_decreasing<span class="main">:</span> <span class="quoted"><span class="quoted">"prune <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prune_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">lemma</span></span> prune_successors<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> gusuccessors <span class="free">A</span> <span class="free">w</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> prune <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> prune <span class="free">A</span> <span class="free">w</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> prune <span class="free">A</span> <span class="free">w</span> <span class="free">V</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="free">u</span><span class="main">.</span> gaccepting <span class="free">A</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> prune_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> graph.reachable.execute assms<span class="main">(</span>2<span class="main">)</span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="free">u</span> <span class="main">⊆</span> greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> prune <span class="free">A</span> <span class="free">w</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prune_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 2<span class="main">(</span>2<span class="main">)</span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Run Graph Interation›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">graph</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'label</span> stream <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'state</span> node set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">graph</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> alternate <span class="main">(</span>clean <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="main">(</span>prune <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>gunodes <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">level</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">v</span></span> <span class="main">∈</span> graph <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">.</span> fst <span class="bound">v</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> graph_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"graph <span class="free">A</span> <span class="free">w</span> <span class="main">0</span> <span class="main">=</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> graph_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">lemma</span></span> graph_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> even <span class="free">k</span> <span class="keyword1">then</span> clean <span class="free">A</span> <span class="free">w</span> <span class="keyword1">else</span> prune <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="main">(</span>graph <span class="free">A</span> <span class="free">w</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> graph_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">lemma</span></span> graph_antimono<span class="main">:</span> <span class="quoted"><span class="quoted">"antimono <span class="main">(</span>graph <span class="free">A</span> <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alternate_antimono clean_decreasing prune_decreasing
    <span class="keyword1"><span class="command">unfolding</span></span> antimono_def le_fun_def graph_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">lemma</span></span> graph_nodes<span class="main">:</span> <span class="quoted"><span class="quoted">"graph <span class="free">A</span> <span class="free">w</span> <span class="free">k</span> <span class="main">⊆</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> graph_0 graph_antimono le0 antimonoD <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">lemma</span></span> graph_successors<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> gusuccessors <span class="free">A</span> <span class="free">w</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> graph <span class="free">A</span> <span class="free">w</span> <span class="free">k</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> graph <span class="free">A</span> <span class="free">w</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 0<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> graph <span class="free">A</span> <span class="free">w</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">using</span></span> antimono_iff_le_Suc graph_antimono rev_subsetD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> clean_successors<span class="main">[</span><span class="operator">OF</span> 1 Suc<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> prune_successors<span class="main">[</span><span class="operator">OF</span> 1 Suc<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> graph_level_finite<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>level <span class="free">A</span> <span class="free">w</span> <span class="free">k</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"level <span class="free">A</span> <span class="free">w</span> <span class="free">k</span> <span class="free">l</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound"><span class="bound">v</span></span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span><span class="main">.</span> fst <span class="bound">v</span> <span class="main">=</span> <span class="free">l</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> graph_nodes subset_CollectI<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">v</span></span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span><span class="main">.</span> fst <span class="bound">v</span> <span class="main">=</span> <span class="free">l</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">l</span><span class="main">}</span> <span class="main">×</span> nodes <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gnodes_nodes <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">{</span><span class="free">l</span><span class="main">}</span> <span class="main">×</span> nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> find_safe<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∉</span> language <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">⟹</span> gsuccessors <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="main">∈</span> greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="free">v</span><span class="main">.</span> <span class="main">¬</span> gaccepting <span class="free">A</span> <span class="bound">u</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">thesis</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">u</span> <span class="main">∈</span> greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="bound">v</span><span class="main">.</span> gaccepting <span class="free">A</span> <span class="bound">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> initial <span class="free">A</span> <span class="main">⟹</span> run <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">v</span> <span class="main">⟹</span> fins <span class="main">(</span>accepting <span class="free">A</span><span class="main">)</span> <span class="bound">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"gaccepting <span class="free">A</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> 50<span class="main">:</span> <span class="quoted"><span class="quoted">"gpath <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="skolem">y</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> gtarget <span class="skolem">y</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"grun <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="skolem">r</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">∧</span> gaccepting <span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> graph.recurring_condition<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">∧</span> gaccepting <span class="free">A</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> greachable_subset 4 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">∧</span> gaccepting <span class="free">A</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 20<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> gsuccessors <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> IntE equals0I<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 21<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 20 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 22<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span> <span class="main">∈</span> greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="skolem">v'</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">∧</span> gaccepting <span class="free">A</span> <span class="bound">u</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> greachable_subset 2 21 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> 30<span class="main">:</span> <span class="quoted"><span class="quoted">"gpath <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="skolem">r</span> <span class="skolem">v'</span>"</span></span> <span class="quoted"><span class="quoted">"gtarget <span class="skolem">r</span> <span class="skolem">v'</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">∧</span> gaccepting <span class="free">A</span> <span class="main">(</span>gtarget <span class="skolem">r</span> <span class="skolem">v'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 22 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> gpath <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="bound">r</span> <span class="skolem">v</span> <span class="main">∧</span> gtarget <span class="bound">r</span> <span class="skolem">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">∧</span> gaccepting <span class="free">A</span> <span class="main">(</span>gtarget <span class="bound">r</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">#</span> <span class="skolem">r</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gpath <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="main">(</span><span class="skolem">v'</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 20 30 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gtarget <span class="main">(</span><span class="skolem">v'</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 30 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gaccepting <span class="free">A</span> <span class="main">(</span>gtarget <span class="main">(</span><span class="skolem">v'</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 30 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> 100<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> ginitial <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> gureachable <span class="free">A</span> <span class="free">w</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> 101<span class="main">:</span> <span class="quoted"><span class="quoted">"gupath <span class="free">A</span> <span class="free">w</span> <span class="skolem">y</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gpath_subset 50<span class="main">(</span>1<span class="main">)</span> subset_UNIV <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 102<span class="main">:</span> <span class="quoted"><span class="quoted">"gurun <span class="free">A</span> <span class="free">w</span> <span class="skolem">r</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grun_subset 6<span class="main">(</span>1<span class="main">)</span> subset_UNIV <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> 103<span class="main">:</span> <span class="quoted"><span class="quoted">"gupath <span class="free">A</span> <span class="free">w</span> <span class="skolem">t</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> gtarget <span class="skolem">t</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 100<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">have</span></span> 104<span class="main">:</span> <span class="quoted"><span class="quoted">"gurun <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">y</span> <span class="main">@-</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 101 102 103 50<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">y</span> <span class="main">@-</span> <span class="skolem">r</span> <span class="main">=</span> fromN <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> grun_elim<span class="main">[</span><span class="operator">OF</span> 104<span class="main">]</span> 100<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grun_run<span class="main">[</span><span class="operator">OF</span> 104<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> 7<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 9<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> initial <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 100<span class="main">(</span>1<span class="main">)</span> 7<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 91<span class="main">:</span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span>trace <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">⊆</span> reachable <span class="free">A</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nba.reachable_trace nba.reachable.reflexive 8 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"fins <span class="main">(</span>accepting <span class="free">A</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 9 8 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 12<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>gaccepting <span class="free">A</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> infs_mono<span class="main">[</span><span class="operator">OF</span> _ 6<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> smap snd <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">y</span> <span class="main">@-</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 7<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>accepting <span class="free">A</span><span class="main">)</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 12 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 13<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>accepting <span class="free">A</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> 10 13 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> remove_run<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∉</span> language <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"clean <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v</span> <span class="free">r</span>
    <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"grun <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="free">r</span> <span class="free">v</span>"</span></span>
      <span class="quoted"><span class="quoted">"sset <span class="main">(</span>gtrace <span class="free">r</span> <span class="free">v</span><span class="main">)</span> <span class="main">⊆</span> clean <span class="free">A</span> <span class="free">w</span> <span class="free">V</span>"</span></span>
      <span class="quoted"><span class="quoted">"sset <span class="main">(</span>gtrace <span class="free">r</span> <span class="free">v</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">-</span> prune <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>clean <span class="free">A</span> <span class="free">w</span> <span class="free">V</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> clean <span class="free">A</span> <span class="free">w</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> greachable <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>clean <span class="free">A</span> <span class="free">w</span> <span class="free">V</span><span class="main">)</span> <span class="skolem">u</span><span class="main">.</span> <span class="main">¬</span> gaccepting <span class="free">A</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> find_safe<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∉</span> language <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"clean <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"clean <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="main">⊆</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> clean_decreasing subset_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> clean <span class="free">A</span> <span class="free">w</span> <span class="free">V</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 clean_decreasing <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 clean_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gsuccessors <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="skolem">v</span> <span class="main">⊆</span> gusuccessors <span class="free">A</span> <span class="free">w</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 assms<span class="main">(</span>1<span class="main">,</span> 3<span class="main">)</span> finite_nodes_gsuccessors <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>gsuccessors <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>insert <span class="skolem">v</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="main">(</span>greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>gsuccessors <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> graph.reachable_step 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> gsuccessors <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> clean <span class="free">A</span> <span class="free">w</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 6 <span class="keyword1"><span class="command">unfolding</span></span> clean_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gsuccessors <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>clean <span class="free">A</span> <span class="free">w</span> <span class="free">V</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 6<span class="main">(</span>1<span class="main">)</span> 7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> clean_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> clean_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>gsuccessors <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that greachable_subset 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gsuccessors <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="skolem">v</span> <span class="main">⊆</span> gusuccessors <span class="free">A</span> <span class="free">w</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 assms<span class="main">(</span>1<span class="main">,</span> 3<span class="main">)</span> finite_nodes_gsuccessors <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"grun <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="skolem">r</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> graph.koenig<span class="main">[</span><span class="operator">OF</span> 3 4<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"greachable <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="skolem">u</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 greachable_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span>gtrace <span class="skolem">r</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> graph.reachable_trace<span class="main">[</span><span class="operator">OF</span> graph.reachable.reflexive 5<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span>gtrace <span class="skolem">r</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">⊆</span> clean <span class="free">A</span> <span class="free">w</span> <span class="free">V</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> clean_def <span class="keyword1"><span class="command">using</span></span> 7 infinite_greachable_gtrace<span class="main">[</span><span class="operator">OF</span> 5<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 9<span class="main">:</span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span>gtrace <span class="skolem">r</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">⊆</span> greachable <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>clean <span class="free">A</span> <span class="free">w</span> <span class="free">V</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 5 8 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> graph.reachable.reflexive graph.reachable_trace grun_subset<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"grun <span class="free">A</span> <span class="free">w</span> <span class="free">V</span> <span class="skolem">r</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span>gtrace <span class="skolem">r</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">⊆</span> clean <span class="free">A</span> <span class="free">w</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 8 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span>gtrace <span class="skolem">r</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">-</span> prune <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>clean <span class="free">A</span> <span class="free">w</span> <span class="free">V</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> subsetI ComplI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
        <span class="keyword3"><span class="command">assume</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> sset <span class="main">(</span>gtrace <span class="skolem">r</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> prune <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>clean <span class="free">A</span> <span class="free">w</span> <span class="free">V</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 20<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> greachable <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>clean <span class="free">A</span> <span class="free">w</span> <span class="free">V</span><span class="main">)</span> <span class="skolem">p</span><span class="main">.</span> gaccepting <span class="free">A</span> <span class="bound">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 10<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> prune_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 30<span class="main">:</span> <span class="quoted"><span class="quoted">"greachable <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>clean <span class="free">A</span> <span class="free">w</span> <span class="free">V</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">⊆</span> greachable <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>clean <span class="free">A</span> <span class="free">w</span> <span class="free">V</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 10<span class="main">(</span>1<span class="main">)</span> 9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> 20 30 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> level_bounded<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∉</span> language <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">n</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">≥</span> <span class="free">n</span> <span class="main">⟹</span> card <span class="main">(</span>level <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">k</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span> <span class="main">-</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">thesis</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>0<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> 0<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="main">::</span> <span class="quoted">nat</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">{</span><span class="skolem">l</span><span class="main">}</span> <span class="main">×</span> nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"level <span class="free">A</span> <span class="free">w</span> <span class="main">0</span> <span class="skolem">l</span> <span class="main">⊆</span> <span class="main">{</span><span class="skolem">l</span><span class="main">}</span> <span class="main">×</span> nodes <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gnodes_nodes <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="main">(</span>card_mono<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">=</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>level <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span> <span class="main">-</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True prune_decreasing <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span>
        <span class="quoted"><span class="quoted">"grun <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span> <span class="skolem">v</span>"</span></span>
        <span class="quoted"><span class="quoted">"sset <span class="main">(</span>gtrace <span class="skolem">r</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">⊆</span> graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"sset <span class="main">(</span>gtrace <span class="skolem">r</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">-</span> graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> remove_run<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∉</span> language <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"clean <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">⊆</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> graph_nodes <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> 90<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">l</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="bound">l</span> <span class="main">⟹</span> card <span class="main">(</span>level <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
        <span class="keyword3"><span class="command">assume</span></span> 100<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> Suc <span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> graph_antimono antimono_iff_le_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> 101<span class="main">:</span> <span class="quoted"><span class="quoted">"gtrace <span class="skolem">r</span> <span class="skolem">v</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">∈</span> graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> snth_sset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 102<span class="main">:</span> <span class="quoted"><span class="quoted">"gtrace <span class="skolem">r</span> <span class="skolem">v</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">∉</span> graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">)</span> snth_sset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> 103<span class="main">:</span> <span class="quoted"><span class="quoted">"gtrace <span class="skolem">r</span> <span class="skolem">v</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">∈</span> level <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> 100 101 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> grun_elim<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> 104<span class="main">:</span> <span class="quoted"><span class="quoted">"gtrace <span class="skolem">r</span> <span class="skolem">v</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">∉</span> level <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 100 102 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"level <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">=</span> level <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊂</span> level <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 103 104 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> level <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_mono clean_def<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 105<span class="main">:</span> <span class="quoted"><span class="quoted">"level <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">⊂</span> level <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>level <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">&lt;</span> card <span class="main">(</span>level <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 105 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> graph_level_finite psubset_card_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 90 100 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>level <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span> <span class="main">-</span> Suc <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> graph_empty<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∉</span> language <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">≥</span> <span class="skolem">n</span> <span class="main">⟹</span> card <span class="main">(</span>level <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> level_bounded<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span> 2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">l</span> <span class="main">∈</span> <span class="main">{..&lt;</span> <span class="skolem">n</span><span class="main">}</span><span class="main">.</span> level <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span> <span class="main">∪</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">..}</span><span class="main">.</span> level <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">..}</span><span class="main">.</span> level <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> graph_level_finite assms<span class="main">(</span>1<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span><span class="main">⋃</span> <span class="bound">l</span> <span class="main">∈</span> <span class="main">{..&lt;</span> <span class="skolem">n</span><span class="main">}</span><span class="main">.</span> level <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> graph_level_finite assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 100<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 101<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>greachable <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
      <span class="keyword1"><span class="command">using</span></span> 100 greachable_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> finite_insert infinite_super <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 101 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> clean_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> graph_le<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∉</span> language <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> graph <span class="free">A</span> <span class="free">w</span> <span class="free">k</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> graph_empty graph_antimono assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_leI antimono_def basic_trans_rules<span class="main"><span class="main">(</span></span>30<span class="main"><span class="main">)</span></span> empty_iff not_le_imp_less<span class="main">)</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Node Ranks›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">rank</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'label</span> stream <span class="main">⇒</span> <span class="tfree">'state</span> node <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">rank</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="keyword1">GREATEST</span> <span class="bound">k</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∈</span> graph <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">k</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> rank_member<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∉</span> language <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>rank <span class="free">A</span> <span class="free">w</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rank_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> GreatestI_nat<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> graph <span class="free">A</span> <span class="free">w</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> graph <span class="free">A</span> <span class="free">w</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">using</span></span> graph_le assms<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> rank_removed<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∉</span> language <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="main">(</span>rank <span class="free">A</span> <span class="free">w</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="main">(</span>rank <span class="free">A</span> <span class="free">w</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>rank <span class="free">A</span> <span class="free">w</span> <span class="free">v</span><span class="main">)</span> <span class="main">≤</span> rank <span class="free">A</span> <span class="free">w</span> <span class="free">v</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rank_def <span class="keyword1"><span class="command">using</span></span> Greatest_le_nat graph_le assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> rank_le<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∉</span> language <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> gusuccessors <span class="free">A</span> <span class="free">w</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="free">w</span> <span class="free">u</span> <span class="main">≤</span> rank <span class="free">A</span> <span class="free">w</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rank_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Greatest_le_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> gureachable <span class="free">A</span> <span class="free">w</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> graph.reachable_successors assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">k</span><span class="main">.</span> <span class="free">u</span> <span class="main">∈</span> graph <span class="free">A</span> <span class="free">w</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rank_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> graph_successors<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> gusuccessors <span class="free">A</span> <span class="free">w</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>rank <span class="free">A</span> <span class="free">w</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rank_member assms<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> graph <span class="free">A</span> <span class="free">w</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">using</span></span> graph_le assms<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> language_ranking<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∉</span> language <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ranking <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>rank <span class="free">A</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ranking_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI ballI allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>rank <span class="free">A</span> <span class="free">w</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rank_member assms 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="free">w</span> <span class="skolem">v</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> graph_le assms 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">u</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> gusuccessors <span class="free">A</span> <span class="free">w</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="free">w</span> <span class="skolem">u</span> <span class="main">≤</span> rank <span class="free">A</span> <span class="free">w</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rank_le assms 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"gaccepting <span class="free">A</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>rank <span class="free">A</span> <span class="free">w</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rank_member assms 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="main">(</span>rank <span class="free">A</span> <span class="free">w</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rank_removed assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> prune <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>rank <span class="free">A</span> <span class="free">w</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> prune_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="main">(</span>rank <span class="free">A</span> <span class="free">w</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> prune <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>rank <span class="free">A</span> <span class="free">w</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span>rank <span class="free">A</span> <span class="free">w</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">r</span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"gurun <span class="free">A</span> <span class="free">w</span> <span class="skolem">r</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"smap <span class="main">(</span>rank <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="main">(</span>gtrace <span class="skolem">r</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> sconst <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span>gtrace <span class="skolem">r</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">⊆</span> gureachable <span class="free">A</span> <span class="free">w</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> graph.reachable.reflexive graph.reachable_trace<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span>gtrace <span class="skolem">r</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">⊆</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> 60<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="free">w</span> <span class="main">`</span> sset <span class="main">(</span>gtrace <span class="skolem">r</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="skolem">k</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> equalityD1 sset_sconst stream.set_map<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 50<span class="main">:</span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span>gtrace <span class="skolem">r</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">⊆</span> graph <span class="free">A</span> <span class="free">w</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rank_member<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> subsetD<span class="main">[</span><span class="operator">OF</span> 6<span class="main">]</span> 60 <span class="keyword1"><span class="command">unfolding</span></span> image_subset_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 70<span class="main">:</span> <span class="quoted"><span class="quoted">"grun <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>graph <span class="free">A</span> <span class="free">w</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">r</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grun_subset 1<span class="main">(</span>2<span class="main">)</span> 50 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span>gtrace <span class="skolem">r</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">⊆</span> clean <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>graph <span class="free">A</span> <span class="free">w</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> clean_def <span class="keyword1"><span class="command">using</span></span> 50 infinite_greachable_gtrace<span class="main">[</span><span class="operator">OF</span> 70<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span>gtrace <span class="skolem">r</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∩</span> graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rank_removed<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> 60 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> 9<span class="main">:</span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span>gtrace <span class="skolem">r</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> stream.set_sel<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"graph <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">≠</span> clean <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>graph <span class="free">A</span> <span class="free">w</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 7 8 9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"odd <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 <span class="keyword1"><span class="command">unfolding</span></span> graph_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness Theorem›</span></span>

  <span class="keyword1"><span class="command">theorem</span></span> language_ranking_iff<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∉</span> language <span class="free">A</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">f</span><span class="main">.</span> ranking <span class="free">A</span> <span class="free">w</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ranking_language language_ranking assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Complementation">
<div class="head">
<h1>Theory Complementation</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Complementation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Complementation
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../Transition_Systems_and_Automata/Maps.html">Transition_Systems_and_Automata.Maps</a>"</span>
  <span class="quoted">"<a href="Ranking.html">Ranking</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Level Rankings and Complementation States›</span></span>

  <span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'state</span> lr <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇀</span> nat"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">lr_succ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> lr <span class="main">⇒</span> <span class="tfree">'state</span> lr set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">lr_succ</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">g</span><span class="main">.</span>
      dom <span class="bound">g</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>transition <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">`</span> dom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">.</span> <span class="main">∀</span> <span class="bound">q</span> <span class="main">∈</span> transition <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">p</span><span class="main">.</span> the <span class="main">(</span><span class="bound">g</span> <span class="bound">q</span><span class="main">)</span> <span class="main">≤</span> the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound">q</span> <span class="main">∈</span> dom <span class="bound">g</span><span class="main">.</span> accepting <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">q</span> <span class="main">⟶</span> even <span class="main">(</span>the <span class="main">(</span><span class="bound">g</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'state</span> st <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> set"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">st_succ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> lr <span class="main">⇒</span> <span class="tfree">'state</span> st <span class="main">⇒</span> <span class="tfree">'state</span> st"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">st_succ</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> dom <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="keyword1">else</span> <span class="main">⋃</span> <span class="main">(</span>transition <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">.</span> even <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'state</span> cs <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> lr <span class="main">×</span> <span class="tfree">'state</span> st"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">complement_succ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> cs <span class="main">⇒</span> <span class="tfree">'state</span> cs set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">complement_succ</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">P</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">g</span><span class="main">,</span> st_succ <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">g</span> <span class="bound">P</span><span class="main">)</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> lr_succ <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">f</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">complement</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span> cs<span class="main">)</span> nba"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">complement</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> nba
      <span class="main">(</span>alphabet <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
      <span class="main">(</span><span class="main">{</span>const <span class="main">(</span>Some <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`</span> initial <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span>
      <span class="main">(</span>complement_succ <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">P</span><span class="main">)</span><span class="main">.</span> <span class="bound">P</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> dom_nodes<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">fP</span> <span class="main">∈</span> nodes <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>fst <span class="free">fP</span><span class="main">)</span> <span class="main">⊆</span> nodes <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> complement_def complement_succ_def lr_succ_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">lemma</span></span> ran_nodes<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">fP</span> <span class="main">∈</span> nodes <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ran <span class="main">(</span>fst <span class="free">fP</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>initial <span class="skolem">fP</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> initial <span class="keyword1"><span class="command">unfolding</span></span> complement_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> eq_refl option.inject ran_restrictD<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>execute <span class="skolem">fP</span> <span class="skolem">agQ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fP</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"ran <span class="skolem">f</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> execute<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">agQ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prod_cases3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> dom <span class="skolem">f</span> <span class="main">⟹</span> <span class="skolem">q</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="skolem">a</span> <span class="skolem">p</span> <span class="main">⟹</span> the <span class="main">(</span><span class="skolem">g</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">≤</span> the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">q</span>
      <span class="keyword1"><span class="command">using</span></span> execute<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> 1 3 complement_def nba.simps complement_succ_def lr_succ_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">g</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="free">A</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>dom <span class="skolem">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> execute<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> 1 3 complement_def nba.simps complement_succ_def lr_succ_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> 1 3 ran_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> dom <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> dom <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="skolem">a</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 6 <span class="keyword1"><span class="command">unfolding</span></span> 8 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> the <span class="main">(</span><span class="skolem">g</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 7<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domD ranI subset_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> states_nodes<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">fP</span> <span class="main">∈</span> nodes <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">fP</span> <span class="main">⊆</span> nodes <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>initial <span class="skolem">fP</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> initial <span class="keyword1"><span class="command">unfolding</span></span> complement_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>execute <span class="skolem">fP</span> <span class="skolem">agQ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fP</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊆</span> nodes <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> execute<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">agQ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prod_cases3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> alphabet <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> execute<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 3 complement_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">∈</span> nodes <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> execute<span class="main">(</span>1<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 1 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">g</span> <span class="main">⊆</span> nodes <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dom_nodes<span class="main">[</span><span class="operator">OF</span> 10<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>transition <span class="free">A</span> <span class="skolem">a</span> <span class="main">`</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">⊆</span> nodes <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⊆</span> nodes <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> execute<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> 1 3 complement_def nba.simps complement_succ_def st_succ_def
      <span class="keyword1"><span class="command">using</span></span> 4 5
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 6 <span class="keyword1"><span class="command">unfolding</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">theorem</span></span> complement_finite<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lrs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">f</span><span class="main">.</span> dom <span class="bound">f</span> <span class="main">⊆</span> nodes <span class="free">A</span> <span class="main">∧</span> ran <span class="bound">f</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?lrs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_set_of_finite_maps' assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?states</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Pow <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?states</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nodes <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span> <span class="var">?lrs</span> <span class="main">×</span> <span class="var">?states</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_nodes ran_nodes states_nodes<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> complement_trace_snth<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≡</span> <span class="free">p</span> <span class="main">##</span> trace <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span>
      <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">m</span> <span class="main">!!</span> Suc <span class="free">k</span><span class="main">)</span> <span class="main">∈</span> lr_succ <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">m</span> <span class="main">!!</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">m</span> <span class="main">!!</span> Suc <span class="free">k</span><span class="main">)</span> <span class="main">=</span> st_succ <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">m</span> <span class="main">!!</span> Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">m</span> <span class="main">!!</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">!!</span> <span class="free">k</span> <span class="main">∈</span> transition <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">m</span> <span class="main">!!</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nba.run_snth assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">m</span> <span class="main">!!</span> Suc <span class="free">k</span><span class="main">)</span> <span class="main">∈</span> lr_succ <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">m</span> <span class="main">!!</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 1 <span class="keyword1"><span class="command">unfolding</span></span> complement_def complement_succ_def nba.trace_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">m</span> <span class="main">!!</span> Suc <span class="free">k</span><span class="main">)</span> <span class="main">=</span> st_succ <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">m</span> <span class="main">!!</span> Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">m</span> <span class="main">!!</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 1 <span class="keyword1"><span class="command">unfolding</span></span> complement_def complement_succ_def nba.trace_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Word in Complement Language Implies Ranking›</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> complement_ranking<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> language <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">f</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"ranking <span class="free">A</span> <span class="free">w</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span>
      <span class="quoted"><span class="quoted">"run <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> initial <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"infs <span class="main">(</span>accepting <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> 100<span class="main">:</span>
      <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> lr_succ <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> st_succ <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="keyword1"><span class="command">using</span></span> complement_trace_snth 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> nba.trace_alt_def szip_smap_snd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span>fst <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">k</span> <span class="main">≡</span> snd <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">v</span> <span class="main">∈</span> dom <span class="main">(</span>fst <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> fst <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>initial <span class="skolem">v</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> complement_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>execute <span class="skolem">v</span> <span class="skolem">u</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">u</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span>transition <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> fst <span class="skolem">v</span><span class="main">)</span> <span class="main">`</span> dom <span class="main">(</span>fst <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> fst <span class="skolem">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> execute<span class="main">(</span>2<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> dom <span class="main">(</span>fst <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> Suc <span class="main">(</span>fst <span class="skolem">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 100 <span class="keyword1"><span class="command">unfolding</span></span> lr_succ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>fst <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> fst <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> execute<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">u</span> <span class="main">≤</span> <span class="skolem">f</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> gusuccessors <span class="free">A</span> <span class="free">w</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span> <span class="skolem">v</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 15<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">u</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> fst <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 16<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">v</span> <span class="main">∈</span> dom <span class="main">(</span>fst <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> fst <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">u</span> <span class="main">=</span> the <span class="main">(</span>fst <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> fst <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">u</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">u</span> <span class="main">=</span> Suc <span class="main">(</span>fst <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>fst <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> <span class="main">…</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">u</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> the <span class="main">(</span>fst <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> fst <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 100 15 16 <span class="keyword1"><span class="command">unfolding</span></span> lr_succ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">u</span> <span class="main">≤</span> <span class="skolem">f</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">l</span></span> <span class="main">≥</span> <span class="skolem">k</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">l</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 15<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">P</span><span class="main">)</span><span class="main">.</span> <span class="bound">P</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="var">?m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> complement_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> 17<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≥</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 15 <span class="keyword1"><span class="command">unfolding</span></span> infs_snth <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> 19<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">l</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">using</span></span> 17 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 19 17<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> ranking_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI ballI impI allI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">v</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>initial <span class="skolem">v</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> complement_def f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>execute <span class="skolem">v</span> <span class="skolem">u</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">u</span> <span class="main">≤</span> <span class="skolem">f</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">[</span><span class="operator">OF</span> execute<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> execute<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> execute<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">u</span>
      <span class="keyword3"><span class="command">assume</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> gusuccessors <span class="free">A</span> <span class="free">w</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">u</span> <span class="main">≤</span> <span class="skolem">f</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 10 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"gaccepting <span class="free">A</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span><span class="skolem">f</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 10
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>initial<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> complement_def f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>execute <span class="skolem">u</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> 12<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">v</span> <span class="main">∈</span> dom <span class="main">(</span>fst <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> fst <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> execute graph.nodes.execute 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> 12<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">v</span> <span class="main">∈</span> dom <span class="main">(</span>fst <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> Suc <span class="main">(</span>fst <span class="skolem">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 12 execute<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 13<span class="main">:</span> <span class="quoted"><span class="quoted">"accepting <span class="free">A</span> <span class="main">(</span>snd <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">v</span> <span class="main">=</span> the <span class="main">(</span>fst <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> fst <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">v</span> <span class="main">=</span> Suc <span class="main">(</span>fst <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> execute<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span>the <span class="main">(</span>fst <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> Suc <span class="main">(</span>fst <span class="skolem">u</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 100 12 13 <span class="keyword1"><span class="command">unfolding</span></span> lr_succ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">s</span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"gurun <span class="free">A</span> <span class="free">w</span> <span class="skolem">s</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 12<span class="main">:</span> <span class="quoted"><span class="quoted">"smap <span class="skolem">f</span> <span class="main">(</span>gtrace <span class="skolem">s</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> sconst <span class="skolem">k</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"odd <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> 13<span class="main">:</span> <span class="quoted"><span class="quoted">"even <span class="skolem">k</span>"</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> 14<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> ginitial <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"gupath <span class="free">A</span> <span class="free">w</span> <span class="skolem">t</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> gtarget <span class="skolem">t</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> 15<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≥</span> length <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">l</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 30<span class="main">:</span> <span class="quoted"><span class="quoted">"gurun <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11 14 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 21<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">l</span>
          <span class="keyword1"><span class="command">unfolding</span></span> sscan_snth<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> 30 14<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> grun_elim<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> 17<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">P</span> <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>0<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> 20<span class="main">:</span> <span class="quoted"><span class="quoted">"gtarget <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 14 11 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 15<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> le_SucI graph.run_stake stake_shift<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span>
            dom <span class="main">(</span>fst <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> fst <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 2<span class="main">[</span><span class="operator">OF</span> 20<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 21 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 22<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> dom <span class="main">(</span>fst <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> Suc <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gtarget <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">=</span> gtrace <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">!!</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sscan_snth <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> gtrace <span class="skolem">s</span> <span class="skolem">v</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">-</span> length <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 15<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">…</span> <span class="main">=</span> smap <span class="skolem">f</span> <span class="main">(</span>gtrace <span class="skolem">s</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">-</span> length <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smap <span class="skolem">f</span> <span class="main">(</span>gtrace <span class="skolem">s</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> sconst <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sconst <span class="skolem">k</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">-</span> length <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 23<span class="main">:</span> <span class="quoted"><span class="quoted">"even <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 13 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span>
            <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> dom <span class="main">(</span>fst <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> Suc <span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> even <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 21 22 23 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> mem_Collect_eq prod.collapse<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> st_succ <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> Suc <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> 15<span class="main">(</span>2<span class="main">)</span> st_succ_def f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">P</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 100<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> 20<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> 21<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">+</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">l</span> <span class="main">+</span> Suc <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 21 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stake_shift<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gtarget <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">+</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">=</span> gtrace <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> sscan_snth <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∈</span> gusuccessors <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> graph.run_snth<span class="main">[</span><span class="operator">OF</span> 30<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">+</span> Suc <span class="skolem">i</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 220<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span>
              transition <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 21 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> 22<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">+</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span>
            <span class="main">⋃</span> <span class="main">(</span>transition <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">P</span> <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 220 Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gtarget <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">+</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">=</span> gtrace <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> sscan_snth <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> gtrace <span class="skolem">s</span> <span class="skolem">v</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> Suc <span class="skolem">i</span> <span class="main">-</span> length <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 15<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute shift_snth_ge sscan_const trans_le_add2<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">…</span> <span class="main">=</span> smap <span class="skolem">f</span> <span class="main">(</span>gtrace <span class="skolem">s</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> Suc <span class="skolem">i</span> <span class="main">-</span> length <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smap <span class="skolem">f</span> <span class="main">(</span>gtrace <span class="skolem">s</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> sconst <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sconst <span class="skolem">k</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> Suc <span class="skolem">i</span> <span class="main">-</span> length <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 23<span class="main">:</span> <span class="quoted"><span class="quoted">"even <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">+</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 13 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">+</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">@-</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span>
            <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span>transition <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">P</span> <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> even <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 21 22 23 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> add_Suc_right mem_Collect_eq prod.collapse<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> st_succ <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="var">?m</span> <span class="main">!!</span> Suc <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> st_succ_def f_def <span class="keyword1"><span class="command">using</span></span> 20 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">P</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 100<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">folded</span> P_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">P</span> <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">+</span> Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 16<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">≥</span> Suc <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">l'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> 16 17 <span class="keyword1"><span class="command">using</span></span> nat_le_iff_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Ranking Implies Word in Complement Language›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">reach</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">reach</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">{</span>target <span class="bound">r</span> <span class="bound">p</span> <span class="main">|</span><span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> path <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">r</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> initial <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> map fst <span class="bound">r</span> <span class="main">=</span> stake <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> reach_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach <span class="free">A</span> <span class="free">w</span> <span class="main">0</span> <span class="main">=</span> initial <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> reach_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">lemma</span></span> reach_Suc_empty<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">!!</span> <span class="free">n</span> <span class="main">∉</span> alphabet <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reach <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> reach <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> target <span class="skolem">r</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">A</span> <span class="skolem">r</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> initial <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"map fst <span class="skolem">r</span> <span class="main">=</span> stake <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> reach_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">A</span> <span class="main">(</span>take <span class="free">n</span> <span class="skolem">r</span> <span class="main">@</span> drop <span class="free">n</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"map fst <span class="skolem">r</span> <span class="main">=</span> stake <span class="free">n</span> <span class="free">w</span> <span class="main">@</span> <span class="main">[</span><span class="free">w</span> <span class="main">!!</span> <span class="free">n</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>4<span class="main">)</span> stake_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="skolem">r</span> <span class="main">=</span> take <span class="free">n</span> <span class="main">(</span>map snd <span class="skolem">r</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">q</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">,</span> 4<span class="main">)</span> 4
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_inject Suc_neq_Zero Suc_pred append.right_neutral
        append_eq_conv_conj drop_map id_take_nth_drop last_ConsR last_conv_nth length_0_conv
        length_map length_stake lessI nba.target_alt_def nba.states_alt_def zero_less_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="free">n</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="free">n</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 5
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_conv_conj append_is_Nil_conv append_take_drop_id drop_map
        length_greater_0_conv length_stake stake_cycle_le stake_invert_Nil
        take_map zip_Cons_Cons zip_map_fst_snd<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 3 <span class="keyword1"><span class="command">unfolding</span></span> 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> reach_Suc_succ<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">!!</span> <span class="free">n</span> <span class="main">∈</span> alphabet <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reach <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>transition <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="free">n</span><span class="main">)</span> <span class="main">`</span> reach <span class="free">A</span> <span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> reach <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> target <span class="skolem">r</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">A</span> <span class="skolem">r</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> initial <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"map fst <span class="skolem">r</span> <span class="main">=</span> stake <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> reach_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">A</span> <span class="main">(</span>take <span class="free">n</span> <span class="skolem">r</span> <span class="main">@</span> drop <span class="free">n</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"map fst <span class="skolem">r</span> <span class="main">=</span> stake <span class="free">n</span> <span class="free">w</span> <span class="main">@</span> <span class="main">[</span><span class="free">w</span> <span class="main">!!</span> <span class="free">n</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>4<span class="main">)</span> stake_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="skolem">r</span> <span class="main">=</span> take <span class="free">n</span> <span class="main">(</span>map snd <span class="skolem">r</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">q</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">,</span> 4<span class="main">)</span> 4
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_inject Suc_neq_Zero Suc_pred append.right_neutral
        append_eq_conv_conj drop_map id_take_nth_drop last_ConsR last_conv_nth length_0_conv
        length_map length_stake lessI nba.target_alt_def nba.states_alt_def zero_less_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="free">n</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="free">n</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 5
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_conv_conj append_is_Nil_conv append_take_drop_id drop_map
        length_greater_0_conv length_stake stake_cycle_le stake_invert_Nil
        take_map zip_Cons_Cons zip_map_fst_snd<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="free">n</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>reach <span class="free">A</span> <span class="free">w</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> reach_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> UN_I CollectI exI conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"target <span class="main">(</span>take <span class="free">n</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> target <span class="main">(</span>take <span class="free">n</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"path <span class="free">A</span> <span class="main">(</span>take <span class="free">n</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> initial <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map fst <span class="main">(</span>take <span class="free">n</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> stake <span class="free">n</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_stake lessI nat.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
        stake_cycle_le stake_invert_Nil take_map take_stake<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>target <span class="main">(</span>take <span class="free">n</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">unfolding</span></span> 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> reach <span class="free">A</span> <span class="free">w</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="free">n</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> target <span class="skolem">r</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">A</span> <span class="skolem">r</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> initial <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"map fst <span class="skolem">r</span> <span class="main">=</span> stake <span class="free">n</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> reach_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> reach <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> reach_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> CollectI exI conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> target <span class="main">(</span><span class="skolem">r</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="free">n</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"path <span class="free">A</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="free">n</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 1<span class="main">(</span>2<span class="main">)</span> 2<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> initial <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map fst <span class="main">(</span><span class="skolem">r</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="free">n</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> stake <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_fst_iff list.simps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> map_append stake_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> reach_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">w</span> <span class="main">!!</span> <span class="free">n</span> <span class="main">∈</span> alphabet <span class="free">A</span>
    <span class="keyword1">then</span> <span class="main">⋃</span> <span class="main">(</span>transition <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="free">n</span><span class="main">)</span> <span class="main">`</span> reach <span class="free">A</span> <span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reach_Suc_empty reach_Suc_succ <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">lemma</span></span> reach_nodes<span class="main">:</span> <span class="quoted"><span class="quoted">"reach <span class="free">A</span> <span class="free">w</span> <span class="free">i</span> <span class="main">⊆</span> nodes <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">lemma</span></span> reach_gunodes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">×</span> reach <span class="free">A</span> <span class="free">w</span> <span class="free">i</span> <span class="main">⊆</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> graph.nodes.execute<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> ranking_complement<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> streams <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"ranking <span class="free">A</span> <span class="free">w</span> <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> language <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"ranking <span class="free">A</span> <span class="free">w</span> <span class="skolem">f'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ranking_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI ballI impI allI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span> <span class="main">⟹</span> <span class="skolem">f'</span> <span class="bound">v</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> ranking_def f'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">v</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span> <span class="main">⟹</span> <span class="bound">u</span> <span class="main">∈</span> gusuccessors <span class="free">A</span> <span class="free">w</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="skolem">f'</span> <span class="bound">u</span> <span class="main">≤</span> <span class="skolem">f'</span> <span class="bound">v</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> ranking_def f'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span> <span class="main">⟹</span> gaccepting <span class="free">A</span> <span class="bound">v</span> <span class="main">⟹</span> even <span class="main">(</span><span class="skolem">f'</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> ranking_def f'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span> <span class="main">⟹</span> gurun <span class="free">A</span> <span class="free">w</span> <span class="skolem">r</span> <span class="skolem">v</span> <span class="main">⟹</span> smap <span class="free">f</span> <span class="main">(</span>gtrace <span class="skolem">r</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> sconst <span class="skolem">k</span> <span class="main">⟹</span> odd <span class="skolem">k</span>"</span></span>
        <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span> <span class="skolem">r</span> <span class="skolem">k</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> ranking_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">r</span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"gurun <span class="free">A</span> <span class="free">w</span> <span class="skolem">r</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"smap <span class="skolem">f'</span> <span class="main">(</span>gtrace <span class="skolem">r</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> sconst <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 20<span class="main">:</span> <span class="quoted"><span class="quoted">"shd <span class="skolem">r</span> <span class="main">∈</span> gureachable <span class="free">A</span> <span class="free">w</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> graph.reachable.reflexive graph.reachable_trace gtrace_alt_def subsetD shd_sset<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> 3<span class="main">:</span>
        <span class="quoted"><span class="quoted">"shd <span class="skolem">r</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span>
        <span class="quoted"><span class="quoted">"gurun <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>stl <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>shd <span class="skolem">r</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"smap <span class="skolem">f'</span> <span class="main">(</span>gtrace <span class="main">(</span>stl <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>shd <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sconst <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 20 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> eq_id_iff graph.nodes_trans graph.run_scons_elim
          siterate.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sscan.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> stream.collapse stream.map_sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> sset <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="skolem">p</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ra</span></span> <span class="skolem"><span class="skolem">ka</span></span> <span class="skolem"><span class="skolem">pa</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> fromN <span class="main">(</span>Suc <span class="skolem">ka</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">ra</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ka</span><span class="main">,</span> <span class="skolem">pa</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> grun_elim<span class="main">[</span><span class="operator">OF</span> 2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> sset <span class="main">(</span>fromN <span class="main">(</span>Suc <span class="skolem">ka</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> that
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_eqI prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> szip_smap_fst stream.set_map<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"smap <span class="skolem">f'</span> <span class="main">(</span>gtrace <span class="main">(</span>stl <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>shd <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> smap <span class="free">f</span> <span class="main">(</span>gtrace <span class="main">(</span>stl <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>shd <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> stream.map_cong<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gtrace <span class="main">(</span>stl <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>shd <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> gtrace <span class="main">(</span>stl <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>shd <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span>
        <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> sset <span class="main">(</span>gtrace <span class="main">(</span>stl <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>shd <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gtrace_alt_def prod.collapse stl_sset<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="skolem">z</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> f'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_beta<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"odd <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 3 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">i</span> <span class="skolem">p</span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="skolem">p</span> <span class="main">∈</span> reach <span class="free">A</span> <span class="free">w</span> <span class="skolem">i</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="skolem">f'</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> None"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">have</span></span> g_dom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="skolem">g</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> reach <span class="free">A</span> <span class="free">w</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> g_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">0</span> <span class="main">=</span> const <span class="main">(</span>Some <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`</span> initial <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> g_def f'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> g_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> lr_succ <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">unfolding</span></span> lr_succ_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> CollectI conjI ballI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>transition <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">`</span> dom <span class="main">(</span><span class="skolem">g</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snth_in assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span>
      <span class="keyword3"><span class="command">assume</span></span> 100<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> dom <span class="main">(</span><span class="skolem">g</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 101<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> reach <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snth_in assms<span class="main">(</span>2<span class="main">)</span> 100 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 102<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 100<span class="main">(</span>1<span class="main">)</span> reach_gunodes g_dom <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> 103<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="skolem">n</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> gusuccessors <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snth_in assms<span class="main">(</span>2<span class="main">)</span> 102 100<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 104<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> reach <span class="free">A</span> <span class="free">w</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 100<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">f'</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 101 <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">…</span> <span class="main">=</span> <span class="skolem">f'</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">f'</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">unfolding</span></span> ranking_def <span class="keyword1"><span class="command">using</span></span> 102 103 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> the <span class="main">(</span>Some <span class="main">(</span><span class="skolem">f'</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="skolem">f'</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">g</span> <span class="skolem">n</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 104 <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">≤</span> the <span class="main">(</span><span class="skolem">g</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> 100<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> dom <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"accepting <span class="free">A</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 101<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> reach <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 100<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 102<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="skolem">n</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 101 reach_gunodes <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> 103<span class="main">:</span> <span class="quoted"><span class="quoted">"gaccepting <span class="free">A</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 100<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f'</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 101 <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"even <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">unfolding</span></span> ranking_def <span class="keyword1"><span class="command">using</span></span> 102 103 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span>the <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≡</span> rec_nat <span class="main">{}</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> st_succ <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> P_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">0</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> P_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> st_succ <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> P_reach<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">n</span> <span class="main">⊆</span> reach <span class="free">A</span> <span class="free">w</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">using</span></span> snth_in assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> st_succ_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">n</span> <span class="main">⊆</span> reach <span class="free">A</span> <span class="free">w</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="keyword1"><span class="command">using</span></span> P_reach <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="skolem">n</span> <span class="main">⊆</span> nodes <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="keyword1"><span class="command">using</span></span> reach_nodes <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> P_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">P</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≡</span> smap <span class="skolem">g</span> nats <span class="main">|||</span> smap <span class="skolem">P</span> nats"</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> stl <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>shd <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> nba.snth_run conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stake.simps stake_szip<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">!!</span> <span class="skolem">k</span> <span class="main">∈</span> alphabet <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snth_in assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> complement_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stl <span class="skolem">s</span> <span class="main">!!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">!!</span> Suc <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∈</span> complement_succ <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> complement_succ_def s_def <span class="keyword1"><span class="command">using</span></span> P_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> complement_succ <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>target <span class="main">(</span>stake <span class="skolem">k</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> stl <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>shd <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> sscan_scons_snth<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> nba.trace_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> transition <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>target <span class="main">(</span>stake <span class="skolem">k</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> stl <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>shd <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> complement_def nba.sel <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stl <span class="skolem">s</span> <span class="main">!!</span> <span class="skolem">k</span> <span class="main">∈</span>
          transition <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>target <span class="main">(</span>stake <span class="skolem">k</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> stl <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>shd <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"shd <span class="skolem">s</span> <span class="main">∈</span> initial <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> complement_def s_def <span class="keyword1"><span class="command">using</span></span> P_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>accepting <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>shd <span class="skolem">s</span> <span class="main">##</span> stl <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">n</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">k</span></span> <span class="main">≥</span> <span class="bound">n</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> 20<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">n</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">k</span></span> <span class="main">≥</span> <span class="bound">n</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> 22<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="keyword1"><span class="command">using</span></span> 20 <span class="keyword1"><span class="command">using</span></span> le_add1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="skolem">n</span> <span class="skolem">S</span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span>transition <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span><span class="main">.</span> even <span class="main">(</span>the <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="skolem">S</span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="skolem">i</span> <span class="skolem">n</span> <span class="skolem">S</span> <span class="main">≡</span> rec_nat <span class="skolem">S</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">m</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">n</span> <span class="skolem">S</span>
          <span class="keyword1"><span class="command">have</span></span> R_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">0</span> <span class="skolem">n</span> <span class="main">=</span> id"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="keyword1"><span class="command">unfolding</span></span> R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> R_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">m</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">R</span> <span class="skolem">i</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">n</span> <span class="keyword1"><span class="command">unfolding</span></span> R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> R_Suc'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">R</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">m</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">n</span> <span class="keyword1"><span class="command">unfolding</span></span> R_Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> R_reach<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="skolem">i</span> <span class="skolem">n</span> <span class="skolem">S</span> <span class="main">⊆</span> reach <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">⊆</span> reach <span class="free">A</span> <span class="free">w</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">n</span> <span class="skolem">S</span>
            <span class="keyword1"><span class="command">using</span></span> snth_in assms<span class="main">(</span>2<span class="main">)</span> that m_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> P_R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">R</span> <span class="skolem">i</span> <span class="skolem">k</span> <span class="main">(</span><span class="skolem">P</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
            <span class="keyword1"><span class="command">using</span></span> 22 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta' m_def st_succ_def<span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span> 50<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="skolem">i</span> <span class="skolem">n</span> <span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> <span class="skolem">R</span> <span class="skolem">i</span> <span class="skolem">n</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">n</span> <span class="skolem">S</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m_def prod.case_eq_if<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> 51<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">n</span> <span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="skolem">i</span> <span class="skolem">n</span> <span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">n</span> <span class="skolem">S</span>
            <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m_def prod.case_eq_if<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> 52<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="skolem">j</span> <span class="skolem">n</span> <span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="skolem">i</span> <span class="skolem">n</span> <span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">n</span> <span class="skolem">S</span>
            <span class="keyword1"><span class="command">using</span></span> 51 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_add_diff_inverse that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> that<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">R</span> <span class="bound">i</span> <span class="skolem">n</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
            <span class="keyword2"><span class="keyword">if</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">R</span> <span class="bound">i</span> <span class="skolem">n</span> <span class="skolem">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="skolem">S</span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">R</span> <span class="bound">i</span> <span class="skolem">n</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">⟹</span> <span class="skolem">R</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">p</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">(</span>Sup <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> 52<span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">p</span> <span class="main">≤</span> Sup <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_cSup_finite<span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 that <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">(</span>Sup <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">n</span> <span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> <span class="skolem">R</span> <span class="main">(</span>Sup <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 50 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">(</span>Sup <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">n</span> <span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>2<span class="main">)</span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">R</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 22 P_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">P</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">R</span> <span class="bound">i</span> <span class="skolem">k</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">[</span><span class="operator">OF</span> P_finite 2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="skolem">n</span> <span class="skolem">p</span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">R</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">P</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="skolem">p</span>
          <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">q</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="bound">q</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="skolem">n</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="skolem">p</span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">P</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">R</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> Q_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> 12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">using</span></span> 11<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
            <span class="keyword1"><span class="command">have</span></span> 13<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">using</span></span> 12 <span class="keyword1"><span class="command">unfolding</span></span> R_Suc' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">p</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">P</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> reach <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P_reach <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">1</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span> <span class="main">⊆</span> reach <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R_reach <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> nodes <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach_nodes <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 14<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">m</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 14<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="skolem">m</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">R</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="skolem">q</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> 1<span class="main">[</span><span class="operator">OF</span> 14 13<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> Q_def prod.case
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> bexI conjI allI<span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">R</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="skolem">q</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 14<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="skolem">P</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> 14<span class="main">(</span>1<span class="main">)</span> 11<span class="main">(</span>1<span class="main">)</span> 22 <span class="keyword1"><span class="command">unfolding</span></span> m_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> st_succ_def<span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 14<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> m_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> 23<span class="main">:</span>
            <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="skolem">r</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Q</span> <span class="bound">i</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> trace <span class="skolem">r</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> fst <span class="main">(</span><span class="skolem">r</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nba.invariant_run_index<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Q</span></span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">n</span></span> <span class="bound"><span class="bound">p</span></span> <span class="bound"><span class="bound">a</span></span><span class="main"><span class="main">.</span></span> fst <span class="bound"><span class="bound">a</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">w</span></span> <span class="main"><span class="main">!!</span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">k</span></span> <span class="main"><span class="main">+</span></span> <span class="bound"><span class="bound">n</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">0</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Q_def <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">a</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span> <span class="main">∧</span> snd <span class="bound">a</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="main">(</span>fst <span class="bound">a</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∧</span>
              <span class="skolem">Q</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> fst <span class="bound">a</span> <span class="main">=</span> <span class="free">w</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="skolem">n</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="skolem">p</span>
              <span class="keyword1"><span class="command">using</span></span> snth_in assms<span class="main">(</span>2<span class="main">)</span> 5 that <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> 20<span class="main">:</span> <span class="quoted"><span class="quoted">"smap fst <span class="skolem">r</span> <span class="main">=</span> sdrop <span class="skolem">k</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 23<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eqI_snth<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> 21<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> smap snd <span class="skolem">r</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">P</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
            <span class="keyword1"><span class="command">using</span></span> 23<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> Q_def <span class="keyword1"><span class="command">unfolding</span></span> nba.trace_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> 23<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="main">(</span>sdrop <span class="skolem">k</span> <span class="free">w</span> <span class="main">|||</span> stl <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>shd <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">r</span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">P</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 20 21 23<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stream.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> stream.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> szip_smap<span class="main">)</span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span><span class="main">,</span> shd <span class="skolem">r</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fromN <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">|||</span> stl <span class="skolem">r</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"shd <span class="skolem">r</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">!!</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∈</span> <span class="skolem">P</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 23<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> reach <span class="free">A</span> <span class="free">w</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P_reach <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 24<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">∈</span> gunodes <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach_gunodes <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> 25<span class="main">:</span> <span class="quoted"><span class="quoted">"gurun <span class="free">A</span> <span class="free">w</span> <span class="var">?r</span> <span class="var">?v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> run_grun 23<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> 26<span class="main">:</span> <span class="quoted"><span class="quoted">"Ball <span class="main">(</span>sset <span class="main">(</span>smap <span class="skolem">f'</span> <span class="main">(</span>gtrace <span class="main">(</span>sdrop <span class="skolem">l</span> <span class="var">?r</span><span class="main">)</span> <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="skolem">l</span> <span class="var">?r</span><span class="main">)</span> <span class="var">?v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> odd"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ranking_stuck_odd 0 24 25 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">have</span></span> 27<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">l</span><span class="main">)</span><span class="main">,</span> <span class="skolem">r</span> <span class="main">!!</span> Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span>
            shd <span class="main">(</span>smap <span class="skolem">f'</span> <span class="main">(</span>gtrace <span class="main">(</span>sdrop <span class="skolem">l</span> <span class="var">?r</span><span class="main">)</span> <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="skolem">l</span> <span class="var">?r</span><span class="main">)</span> <span class="var">?v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∈</span> sset <span class="main">(</span>smap <span class="skolem">f'</span> <span class="main">(</span>gtrace <span class="main">(</span>sdrop <span class="skolem">l</span> <span class="var">?r</span><span class="main">)</span> <span class="main">(</span>gtarget <span class="main">(</span>stake <span class="skolem">l</span> <span class="var">?r</span><span class="main">)</span> <span class="var">?v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> shd_sset <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 28<span class="main">:</span> <span class="quoted"><span class="quoted">"odd <span class="main">(</span><span class="skolem">f'</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">l</span><span class="main">)</span><span class="main">,</span> <span class="skolem">r</span> <span class="main">!!</span> Suc <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 26 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">!!</span> Suc <span class="skolem">l</span> <span class="main">∈</span> <span class="skolem">P</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 23<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_Suc_right<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span>transition <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">P</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
            even <span class="main">(</span>the <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 23<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> st_succ_def<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> even <span class="main">(</span>the <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 29<span class="main">:</span> <span class="quoted"><span class="quoted">"even <span class="main">(</span>the <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">!!</span> Suc <span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> 30<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">!!</span> Suc <span class="skolem">l</span> <span class="main">∈</span> reach <span class="free">A</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 23<span class="main">(</span>2<span class="main">)</span> P_reach <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_Suc_right subsetCE<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> 31<span class="main">:</span> <span class="quoted"><span class="quoted">"even <span class="main">(</span><span class="skolem">f'</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">l</span><span class="main">)</span><span class="main">,</span> <span class="skolem">r</span> <span class="main">!!</span> Suc <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 29 30 <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> 28 31 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> nats"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 <span class="keyword1"><span class="command">unfolding</span></span> infs_snth <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span><span class="main">λ</span> <span class="bound">S</span><span class="main">.</span> <span class="bound">S</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">(</span>smap snd <span class="main">(</span>smap <span class="skolem">g</span> nats <span class="main">|||</span> smap <span class="skolem">P</span> nats<span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 11 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> snd <span class="bound">x</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">(</span>smap <span class="skolem">g</span> nats <span class="main">|||</span> smap <span class="skolem">P</span> nats<span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> szip_smap_snd<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">P</span><span class="main">)</span><span class="main">.</span> <span class="bound">P</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">(</span>smap <span class="skolem">g</span> nats <span class="main">|||</span> smap <span class="skolem">P</span> nats<span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">P</span><span class="main">)</span><span class="main">.</span> <span class="bound">P</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">(</span>stl <span class="main">(</span>smap <span class="skolem">g</span> nats <span class="main">|||</span> smap <span class="skolem">P</span> nats<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">P</span><span class="main">)</span><span class="main">.</span> <span class="bound">P</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">(</span>smap snd <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> stl <span class="main">(</span>smap <span class="skolem">g</span> nats <span class="main">|||</span> smap <span class="skolem">P</span> nats<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">P</span><span class="main">)</span><span class="main">.</span> <span class="bound">P</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">(</span>stl <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> complement_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness Theorem›</span></span>

  <span class="keyword1"><span class="command">theorem</span></span> complement_language<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"language <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span> <span class="main">=</span> streams <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">-</span> language <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> notI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"alphabet <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span> <span class="main">=</span> alphabet <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> complement_def nba.sel <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> streams <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> language <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">w</span>
      <span class="keyword1"><span class="command">using</span></span> nba.language_alphabet that 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∉</span> language <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> language <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">w</span>
      <span class="keyword1"><span class="command">using</span></span> complement_ranking ranking_language that <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> language <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> streams <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∉</span> language <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">w</span>
      <span class="keyword1"><span class="command">using</span></span> language_ranking ranking_complement assms that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Complementation_Implement">
<div class="head">
<h1>Theory Complementation_Implement</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Complementation Implementation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Complementation_Implement
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Lattice_Syntax.html">HOL-Library.Lattice_Syntax</a>"</span>
  <span class="quoted">"<a href="../Transition_Systems_and_Automata/NBA_Implement.html">Transition_Systems_and_Automata.NBA_Implement</a>"</span>
  <span class="quoted">"<a href="Complementation.html">Complementation</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">type_synonym</span></span> item <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> bool"</span></span>
  <span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'state</span> items <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇀</span> item"</span></span>

  <span class="keyword1"><span class="command">type_synonym</span></span> state <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> item<span class="main">)</span> list"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">item_rel</span> <span class="main">≡</span> nat_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> bool_rel"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">state_rel</span> <span class="main">≡</span> <span class="main">⟨</span>nat_rel<span class="main">,</span> item_rel<span class="main">⟩</span> list_map_rel"</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">pred</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∈</span> transition <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">p</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Phase 1›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">cs_lr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> items <span class="main">⇒</span> <span class="tfree">'state</span> lr"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">cs_lr</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> map_option fst <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">cs_st</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> items <span class="main">⇒</span> <span class="tfree">'state</span> st"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">cs_st</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">-`</span> Some <span class="main">`</span> snd <span class="main">-`</span> <span class="main">{</span>True<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cs_abs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> items <span class="main">⇒</span> <span class="tfree">'state</span> cs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">cs_abs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">(</span>cs_lr <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> cs_st <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">cs_rep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> cs <span class="main">⇒</span> <span class="tfree">'state</span> items"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">cs_rep</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span> <span class="bound">P</span><span class="main">)</span> <span class="bound">p</span><span class="main">.</span> map_option <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">p</span> <span class="main">∈</span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">g</span> <span class="bound">p</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> cs_abs_rep<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cs_rep <span class="main">(</span>cs_abs <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cs_rep <span class="main">(</span>cs_abs <span class="free">f</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">unfolding</span></span> cs_lr_def cs_st_def cs_rep_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> cs_rep_lr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cs_lr <span class="main">(</span>cs_rep <span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cs_lr <span class="main">(</span>cs_rep <span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">unfolding</span></span> cs_rep_def cs_lr_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> cs_rep_st<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cs_st <span class="main">(</span>cs_rep <span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span> <span class="main">∩</span> dom <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cs_rep_def cs_st_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">lemma</span></span> cs_lr_dom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>cs_lr <span class="free">f</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cs_lr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">lemma</span></span> cs_lr_apply<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> dom <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>cs_lr <span class="free">f</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> cs_lr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">lemma</span></span> cs_rep_dom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>cs_rep <span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cs_rep_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">lemma</span></span> cs_rep_apply<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> dom <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>the <span class="main">(</span>cs_rep <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> cs_rep_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cs_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span> items <span class="main">×</span> <span class="tfree">'state</span> cs<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">cs_rel</span> <span class="main">≡</span> br cs_abs top"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> cs_rel_inv_single_valued<span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span>cs_rel<span class="main">¯</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inj_onI<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> cs_abs_rep<span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">refresh_1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> items <span class="main">⇒</span> <span class="tfree">'state</span> items"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">refresh_1</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> True <span class="main">∈</span> snd <span class="main">`</span> ran <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">else</span> map_option <span class="main">(</span>apsnd top<span class="main">)</span> <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">ranks_1</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> items <span class="main">⇒</span> <span class="tfree">'state</span> items set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ranks_1</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">g</span><span class="main">.</span>
      dom <span class="bound">g</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">.</span> <span class="main">∀</span> <span class="bound">q</span> <span class="main">∈</span> transition <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">p</span><span class="main">.</span> fst <span class="main">(</span>the <span class="main">(</span><span class="bound">g</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> fst <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound">q</span> <span class="main">∈</span> dom <span class="bound">g</span><span class="main">.</span> accepting <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">q</span> <span class="main">⟶</span> even <span class="main">(</span>fst <span class="main">(</span>the <span class="main">(</span><span class="bound">g</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      cs_st <span class="bound">g</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>cs_st <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> even <span class="main">(</span>fst <span class="main">(</span>the <span class="main">(</span><span class="bound">g</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">complement_succ_1</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> items <span class="main">⇒</span> <span class="tfree">'state</span> items set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">complement_succ_1</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> ranks_1 <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∘</span> refresh_1"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">complement_1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span> items<span class="main">)</span> nba"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">complement_1</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> nba
      <span class="main">(</span>alphabet <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
      <span class="main">(</span><span class="main">{</span>const <span class="main">(</span>Some <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">,</span> False<span class="main">)</span><span class="main">)</span> <span class="main">|`</span> initial <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span><span class="main">)</span>
      <span class="main">(</span>complement_succ_1 <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> cs_st <span class="bound">f</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> refresh_1_dom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>refresh_1 <span class="free">f</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> refresh_1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">lemma</span></span> refresh_1_apply<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>the <span class="main">(</span>refresh_1 <span class="free">f</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> refresh_1_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">p</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">lemma</span></span> refresh_1_cs_st<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cs_st <span class="main">(</span>refresh_1 <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> cs_st <span class="free">f</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> dom <span class="free">f</span> <span class="keyword1">else</span> cs_st <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> refresh_1_def cs_st_def ran_def image_def vimage_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">lemma</span></span> complement_succ_1_abs<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> complement_succ_1 <span class="free">A</span> <span class="free">a</span> <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cs_abs <span class="free">g</span> <span class="main">∈</span> complement_succ <span class="free">A</span> <span class="free">a</span> <span class="main">(</span>cs_abs <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> complement_succ_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span>
      <span class="quoted"><span class="quoted">"dom <span class="free">g</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="free">A</span> <span class="free">a</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> dom <span class="free">f</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">q</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="free">a</span> <span class="bound">p</span><span class="main">.</span> fst <span class="main">(</span>the <span class="main">(</span><span class="free">g</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> fst <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> dom <span class="free">g</span><span class="main">.</span> accepting <span class="free">A</span> <span class="bound">p</span> <span class="main">⟶</span> even <span class="main">(</span>fst <span class="main">(</span>the <span class="main">(</span><span class="free">g</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> complement_succ_1_def ranks_1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cs_lr <span class="free">g</span> <span class="main">∈</span> lr_succ <span class="free">A</span> <span class="free">a</span> <span class="main">(</span>cs_lr <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lr_succ_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> CollectI conjI ballI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>cs_lr <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>transition <span class="free">A</span> <span class="free">a</span> <span class="main">`</span> dom <span class="main">(</span>cs_lr <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span>
      <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> dom <span class="main">(</span>cs_lr <span class="free">f</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="free">a</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> dom <span class="main">(</span>cs_lr <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>cs_lr <span class="free">g</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">≤</span> the <span class="main">(</span>cs_lr <span class="free">f</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> dom <span class="main">(</span>cs_lr <span class="free">g</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"accepting <span class="free">A</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span>the <span class="main">(</span>cs_lr <span class="free">g</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"cs_st <span class="free">g</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span>transition <span class="free">A</span> <span class="free">a</span> <span class="main">`</span> cs_st <span class="main">(</span>refresh_1 <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> even <span class="main">(</span>fst <span class="main">(</span>the <span class="main">(</span><span class="free">g</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> complement_succ_1_def ranks_1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cs_st <span class="free">g</span> <span class="main">=</span> st_succ <span class="free">A</span> <span class="free">a</span> <span class="main">(</span>cs_lr <span class="free">g</span><span class="main">)</span> <span class="main">(</span>cs_st <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"cs_st <span class="free">f</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>cs_lr <span class="free">g</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>the <span class="main">(</span><span class="free">g</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="free">A</span> <span class="free">a</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">q</span>
        <span class="keyword1"><span class="command">using</span></span> that 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 3 <span class="keyword1"><span class="command">unfolding</span></span> st_succ_def refresh_1_cs_st True cs_lr_dom 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>cs_lr <span class="free">g</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>the <span class="main">(</span><span class="free">g</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="free">A</span> <span class="free">a</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>cs_st <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">q</span>
        <span class="keyword1"><span class="command">using</span></span> that 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> 
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cs_lr_apply<span class="main">)</span>
          <span class="main">(</span><span class="operator">metis</span> IntE UN_iff cs_abs_rep cs_lr_dom cs_rep_st domD prod.collapse<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs_st <span class="free">g</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span>transition <span class="free">A</span> <span class="free">a</span> <span class="main">`</span> cs_st <span class="main">(</span>refresh_1 <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> even <span class="main">(</span>fst <span class="main">(</span>the <span class="main">(</span><span class="free">g</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs_st <span class="main">(</span>refresh_1 <span class="free">f</span><span class="main">)</span> <span class="main">=</span> cs_st <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="free">A</span> <span class="free">a</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>cs_st <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> even <span class="main">(</span>fst <span class="main">(</span>the <span class="main">(</span><span class="free">g</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
        <span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="free">A</span> <span class="free">a</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>cs_st <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> even <span class="main">(</span>the <span class="main">(</span>cs_lr <span class="free">g</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> st_succ <span class="free">A</span> <span class="free">a</span> <span class="main">(</span>cs_lr <span class="free">g</span><span class="main">)</span> <span class="main">(</span>cs_st <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> st_succ_def <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> complement_succ_1_rep<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊆</span> dom <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">Q</span><span class="main">)</span> <span class="main">∈</span> complement_succ <span class="free">A</span> <span class="free">a</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cs_rep <span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">Q</span><span class="main">)</span> <span class="main">∈</span> complement_succ_1 <span class="free">A</span> <span class="free">a</span> <span class="main">(</span>cs_rep <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> complement_succ_1_def ranks_1_def comp_apply
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> CollectI conjI ballI impI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span>
      <span class="quoted"><span class="quoted">"dom <span class="free">g</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="free">A</span> <span class="free">a</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> dom <span class="free">f</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">q</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="free">a</span> <span class="bound">p</span><span class="main">.</span> the <span class="main">(</span><span class="free">g</span> <span class="bound">q</span><span class="main">)</span> <span class="main">≤</span> the <span class="main">(</span><span class="free">f</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> dom <span class="free">g</span><span class="main">.</span> accepting <span class="free">A</span> <span class="bound">p</span> <span class="main">⟶</span> even <span class="main">(</span>the <span class="main">(</span><span class="free">g</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> complement_succ_def lr_succ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> <span class="keyword1">if</span> <span class="free">P</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> dom <span class="free">g</span> <span class="keyword1">else</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="free">A</span> <span class="free">a</span><span class="main">)</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span><span class="main">.</span> even <span class="main">(</span>the <span class="main">(</span><span class="free">g</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> complement_succ_def st_succ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊆</span> dom <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>cs_rep <span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>transition <span class="free">A</span> <span class="free">a</span> <span class="main">`</span> dom <span class="main">(</span>refresh_1 <span class="main">(</span>cs_rep <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> dom <span class="main">(</span>refresh_1 <span class="main">(</span>cs_rep <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">q</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="free">a</span> <span class="bound">p</span> <span class="main">⟹</span>
      fst <span class="main">(</span>the <span class="main">(</span>cs_rep <span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">Q</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> fst <span class="main">(</span>the <span class="main">(</span>refresh_1 <span class="main">(</span>cs_rep <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> UN_I cs_rep_apply domI option.sel<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> dom <span class="main">(</span>cs_rep <span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> accepting <span class="free">A</span> <span class="bound">p</span> <span class="main">⟹</span> even <span class="main">(</span>fst <span class="main">(</span>the <span class="main">(</span>cs_rep <span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">Q</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cs_st <span class="main">(</span>cs_rep <span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span>transition <span class="free">A</span> <span class="free">a</span> <span class="main">`</span> cs_st <span class="main">(</span>refresh_1 <span class="main">(</span>cs_rep <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
      even <span class="main">(</span>fst <span class="main">(</span>the <span class="main">(</span>cs_rep <span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">Q</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs_st <span class="main">(</span>cs_rep <span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> dom <span class="free">g</span><span class="main">.</span> even <span class="main">(</span>the <span class="main">(</span><span class="free">g</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2 <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> dom <span class="free">g</span><span class="main">.</span> even <span class="main">(</span>fst <span class="main">(</span>the <span class="main">(</span>cs_rep <span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">Q</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cs_rep_apply <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">g</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="free">A</span> <span class="free">a</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">=</span> cs_st <span class="main">(</span>refresh_1 <span class="main">(</span>cs_rep <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>the <span class="main">(</span>cs_rep <span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">Q</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="free">g</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="free">A</span> <span class="free">a</span><span class="main">)</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">q</span>
        <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> that assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cs_rep_apply<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs_st <span class="main">(</span>cs_rep <span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="free">A</span> <span class="free">a</span><span class="main">)</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span><span class="main">.</span> even <span class="main">(</span>the <span class="main">(</span><span class="free">g</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2 <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="free">A</span> <span class="free">a</span><span class="main">)</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span><span class="main">.</span> even <span class="main">(</span>fst <span class="main">(</span>the <span class="main">(</span>cs_rep <span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">Q</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">(</span>cs_st <span class="main">(</span>refresh_1 <span class="main">(</span>cs_rep <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> complement_succ_1_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>complement_succ_1<span class="main">,</span> complement_succ<span class="main">)</span> <span class="main">∈</span>
    Id <span class="main">→</span> Id <span class="main">→</span> cs_rel <span class="main">→</span> <span class="main">⟨</span>cs_rel<span class="main">⟩</span> set_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> br_set_rel_alt in_br_conv<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> nba"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">f</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"complement_succ <span class="skolem">A</span> <span class="skolem">a</span> <span class="main">(</span>cs_abs <span class="skolem">f</span><span class="main">)</span> <span class="main">=</span> cs_abs <span class="main">`</span> complement_succ_1 <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span> <span class="skolem">Q</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">∈</span> complement_succ <span class="skolem">A</span> <span class="skolem">a</span> <span class="main">(</span>cs_abs <span class="skolem">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⊆</span> dom <span class="skolem">g</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> complement_succ_def lr_succ_def st_succ_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> IntE cs_abs_rep cs_lr_dom cs_rep_st<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"cs_st <span class="skolem">f</span> <span class="main">⊆</span> dom <span class="main">(</span>cs_lr <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cs_st_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">∈</span> cs_abs <span class="main">`</span> complement_succ_1 <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">=</span> cs_abs <span class="main">(</span>cs_rep <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs_rep <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">∈</span> complement_succ_1 <span class="skolem">A</span> <span class="skolem">a</span> <span class="main">(</span>cs_rep <span class="main">(</span>cs_abs <span class="skolem">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> complement_succ_1_rep 3 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs_rep <span class="main">(</span>cs_abs <span class="skolem">f</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cs_rep <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">∈</span> complement_succ_1 <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> complement_succ_1 <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cs_abs <span class="skolem">g</span> <span class="main">∈</span> complement_succ <span class="skolem">A</span> <span class="skolem">a</span> <span class="main">(</span>cs_abs <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> complement_succ_1_abs 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> complement_1_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>complement_1<span class="main">,</span> complement<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> nba_rel <span class="main">→</span> <span class="main">⟨</span>Id<span class="main">,</span> cs_rel<span class="main">⟩</span> nba_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> complement_1_def complement_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">parametricity</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> nba"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> nba_rel"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>const <span class="main">(</span>Some <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="skolem">B</span><span class="main">)</span><span class="main">,</span> False<span class="main">)</span><span class="main">)</span> <span class="main">|`</span> initial <span class="skolem">B</span><span class="main">,</span>
      const <span class="main">(</span>Some <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="skolem">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`</span> initial <span class="skolem">B</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> cs_rel"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> cs_lr_def cs_st_def in_br_conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>complement_succ_1 <span class="skolem">A</span><span class="main">,</span> complement_succ <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> cs_rel <span class="main">→</span> <span class="main">⟨</span>cs_rel<span class="main">⟩</span> set_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> complement_succ_1_refine 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{</span>const <span class="main">(</span>Some <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="skolem">A</span><span class="main">)</span><span class="main">,</span> False<span class="main">)</span><span class="main">)</span> <span class="main">|`</span> initial <span class="skolem">A</span><span class="main">}</span><span class="main">,</span>
      <span class="main">{</span>const <span class="main">(</span>Some <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="skolem">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`</span> initial <span class="skolem">B</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>cs_rel<span class="main">⟩</span> set_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">parametricity</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> cs_st <span class="bound">f</span> <span class="main">=</span> <span class="main">{}</span><span class="main">,</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">P</span><span class="main">)</span><span class="main">.</span> <span class="bound">P</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> cs_rel <span class="main">→</span> bool_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Phase 2›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">ranks_2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> items <span class="main">⇒</span> <span class="tfree">'state</span> items set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ranks_2</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">g</span><span class="main">.</span>
      dom <span class="bound">g</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound">q</span> <span class="bound">l</span> <span class="bound">d</span><span class="main">.</span> <span class="bound">g</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="bound">l</span> <span class="main">≤</span> <span class="main">⨅</span> <span class="main">(</span>fst <span class="main">`</span> Some <span class="main">-`</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">`</span> pred <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">q</span><span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span><span class="bound">d</span> <span class="main">⟷</span> <span class="main">⨆</span> <span class="main">(</span>snd <span class="main">`</span> Some <span class="main">-`</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">`</span> pred <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">q</span><span class="main">)</span> <span class="main">∧</span> even <span class="bound">l</span><span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span>accepting <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">q</span> <span class="main">⟶</span> even <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">complement_succ_2</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> items <span class="main">⇒</span> <span class="tfree">'state</span> items set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">complement_succ_2</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> ranks_2 <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∘</span> refresh_1"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">complement_2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span> items<span class="main">)</span> nba"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">complement_2</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> nba
      <span class="main">(</span>alphabet <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
      <span class="main">(</span><span class="main">{</span>const <span class="main">(</span>Some <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">,</span> False<span class="main">)</span><span class="main">)</span> <span class="main">|`</span> initial <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span><span class="main">)</span>
      <span class="main">(</span>complement_succ_2 <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> True <span class="main">∉</span> snd <span class="main">`</span> ran <span class="bound">f</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> ranks_2_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"ranks_2 <span class="main">=</span> ranks_1"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> nba"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="skolem">f</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ranks_2 <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">f</span> <span class="main">=</span> ranks_1 <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> ranks_2 <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">g</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="skolem">A</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>dom <span class="skolem">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> ranks_2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">l</span> <span class="main">≤</span> <span class="main">⨅</span> <span class="main">(</span>fst <span class="main">`</span> Some <span class="main">-`</span> <span class="skolem">f</span> <span class="main">`</span> pred <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">q</span> <span class="skolem">l</span> <span class="skolem">d</span>
        <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> ranks_2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">d</span> <span class="main">⟷</span> <span class="main">⨆</span> <span class="main">(</span>snd <span class="main">`</span> Some <span class="main">-`</span> <span class="skolem">f</span> <span class="main">`</span> pred <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∧</span> even <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">q</span> <span class="skolem">l</span> <span class="skolem">d</span>
        <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> ranks_2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">⟹</span> accepting <span class="skolem">A</span> <span class="skolem">q</span> <span class="main">⟹</span> even <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">q</span> <span class="skolem">l</span> <span class="skolem">d</span>
        <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> ranks_2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> ranks_1 <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ranks_1_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> CollectI conjI ballI impI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">g</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="skolem">A</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>dom <span class="skolem">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span>
        <span class="keyword3"><span class="command">assume</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> dom <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> transition <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> dom <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> 13<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>the <span class="main">(</span><span class="skolem">g</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 13 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">⨅</span> <span class="main">(</span>fst <span class="main">`</span> Some <span class="main">-`</span> <span class="skolem">f</span> <span class="main">`</span> pred <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 13 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> cInf_lower<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> fst <span class="main">`</span> Some <span class="main">-`</span> <span class="skolem">f</span> <span class="main">`</span> pred <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11 10<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bdd_below <span class="main">(</span>fst <span class="main">`</span> Some <span class="main">-`</span> <span class="skolem">f</span> <span class="main">`</span> pred <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fst <span class="main">(</span>the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>the <span class="main">(</span><span class="skolem">g</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> fst <span class="main">(</span>the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
        <span class="keyword3"><span class="command">assume</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> dom <span class="skolem">g</span>"</span></span> <span class="quoted"><span class="quoted">"accepting <span class="skolem">A</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span>fst <span class="main">(</span>the <span class="main">(</span><span class="skolem">g</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cs_st <span class="skolem">g</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="skolem">A</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>cs_st <span class="skolem">f</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> even <span class="main">(</span>fst <span class="main">(</span>the <span class="main">(</span><span class="skolem">g</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cs_st <span class="skolem">g</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="skolem">A</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>cs_st <span class="skolem">f</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> even <span class="main">(</span>fst <span class="main">(</span>the <span class="main">(</span><span class="skolem">g</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">unfolding</span></span> cs_st_def image_def vimage_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="skolem">A</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>cs_st <span class="skolem">f</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> even <span class="main">(</span>fst <span class="main">(</span>the <span class="main">(</span><span class="skolem">g</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> cs_st <span class="skolem">g</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span>
            <span class="keyword3"><span class="command">assume</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"even <span class="main">(</span>fst <span class="main">(</span>the <span class="main">(</span><span class="skolem">g</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> cs_st <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> transition <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">p</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> 12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> dom <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 2 <span class="keyword1"><span class="command">unfolding</span></span> cs_st_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> cs_st <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 4 12 <span class="keyword1"><span class="command">unfolding</span></span> cs_st_def image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> ranks_1 <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">g</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="skolem">A</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>dom <span class="skolem">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> ranks_1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> dom <span class="skolem">f</span> <span class="main">⟹</span> <span class="bound">q</span> <span class="main">∈</span> transition <span class="skolem">A</span> <span class="skolem">a</span> <span class="bound">p</span> <span class="main">⟹</span> fst <span class="main">(</span>the <span class="main">(</span><span class="skolem">g</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> fst <span class="main">(</span>the <span class="main">(</span><span class="skolem">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> ranks_1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> dom <span class="skolem">g</span> <span class="main">⟹</span> accepting <span class="skolem">A</span> <span class="bound">q</span> <span class="main">⟹</span> even <span class="main">(</span>fst <span class="main">(</span>the <span class="main">(</span><span class="skolem">g</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> ranks_1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"cs_st <span class="skolem">g</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="skolem">A</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>cs_st <span class="skolem">f</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> even <span class="main">(</span>fst <span class="main">(</span>the <span class="main">(</span><span class="skolem">g</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> ranks_1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> ranks_2 <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ranks_2_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> CollectI conjI allI impI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">g</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="skolem">A</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>dom <span class="skolem">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">l</span> <span class="skolem">d</span>
        <span class="keyword3"><span class="command">assume</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> dom <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="main">⨅</span> <span class="main">(</span>fst <span class="main">`</span> Some <span class="main">-`</span> <span class="skolem">f</span> <span class="main">`</span> pred <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> cInf_greatest<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> Some <span class="main">-`</span> <span class="skolem">f</span> <span class="main">`</span> pred <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">q</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11 <span class="keyword1"><span class="command">unfolding</span></span> 2 image_def vimage_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> fst <span class="main">`</span> Some <span class="main">-`</span> <span class="skolem">f</span> <span class="main">`</span> pred <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">q</span> <span class="main">⟹</span> <span class="skolem">l</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 3 10 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> domI fst_conv option.sel<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">⟷</span> <span class="skolem">q</span> <span class="main">∈</span> cs_st <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cs_st_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 10<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs_st <span class="skolem">g</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="skolem">A</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>cs_st <span class="skolem">f</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> even <span class="main">(</span>fst <span class="main">(</span>the <span class="main">(</span><span class="skolem">g</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> cs_st <span class="skolem">f</span><span class="main">.</span> <span class="skolem">q</span> <span class="main">∈</span> transition <span class="skolem">A</span> <span class="skolem">a</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> even <span class="skolem">l</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> mem_Collect_eq 10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">⨆</span> <span class="main">(</span>snd <span class="main">`</span> Some <span class="main">-`</span> <span class="skolem">f</span> <span class="main">`</span> pred <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∧</span> even <span class="skolem">l</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> cs_st_def image_def vimage_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">⟷</span> <span class="main">⨆</span> <span class="main">(</span>snd <span class="main">`</span> Some <span class="main">-`</span> <span class="skolem">f</span> <span class="main">`</span> pred <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∧</span> even <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"accepting <span class="skolem">A</span> <span class="skolem">q</span> <span class="main">⟹</span> even <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 10 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> complement_2_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>complement_2<span class="main">,</span> complement_1<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> nba_rel <span class="main">→</span> <span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> nba_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> complement_2_def complement_1_def complement_succ_2_def complement_succ_1_def
    <span class="keyword1"><span class="command">unfolding</span></span> ranks_2_refine cs_st_def image_def vimage_def ran_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Phase 3›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">bounds_3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> items <span class="main">⇒</span> <span class="tfree">'state</span> items"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">bounds_3</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">q</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">S</span> <span class="main">=</span> Some <span class="main">-`</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">`</span> pred <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">q</span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> <span class="bound">S</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span><span class="main">⨅</span><span class="main">(</span>fst <span class="main">`</span> <span class="bound">S</span><span class="main">)</span><span class="main">,</span> <span class="main">⨆</span><span class="main">(</span>snd <span class="main">`</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">items_3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> item <span class="main">⇒</span> item set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">items_3</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">c</span> <span class="main">∧</span> even <span class="bound">l</span><span class="main">)</span> <span class="main">|</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="main">(</span>accepting <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟶</span> even <span class="bound">l</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'state</span> items <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span> <span class="main">⇀</span> item set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">get_3</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> map_option <span class="main">(</span>items_3 <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">complement_succ_3</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> items <span class="main">⇒</span> <span class="tfree">'state</span> items set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">complement_succ_3</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> expand_map <span class="main">∘</span> get_3 <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∘</span> bounds_3 <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∘</span> refresh_1"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">complement_3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span> items<span class="main">)</span> nba"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">complement_3</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> nba
      <span class="main">(</span>alphabet <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
      <span class="main">(</span><span class="main">{</span><span class="main">(</span>Some <span class="main">∘</span> <span class="main">(</span>const <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">,</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`</span> initial <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span><span class="main">)</span>
      <span class="main">(</span>complement_succ_3 <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> <span class="main">∀</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> map_to_set <span class="bound">f</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">c</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> bounds_3_dom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>bounds_3 <span class="free">A</span> <span class="free">a</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="free">A</span> <span class="free">a</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bounds_3_def Let_def dom_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> items_3_nonempty<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"items_3 <span class="free">A</span> <span class="free">p</span> <span class="free">s</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> items_3_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">lemma</span></span> items_3_finite<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>items_3 <span class="free">A</span> <span class="free">p</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> items_3_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> get_3_dom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>get_3 <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> get_3_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bind_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">lemma</span></span> get_3_finite<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∈</span> ran <span class="main">(</span>get_3 <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> get_3_def ran_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">lemma</span></span> get_3_update<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"get_3 <span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>get_3 <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">↦</span> items_3 <span class="free">A</span> <span class="free">p</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> get_3_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">lemma</span></span> expand_map_get_bounds_3<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_map <span class="main">∘</span> get_3 <span class="free">A</span> <span class="main">∘</span> bounds_3 <span class="free">A</span> <span class="free">a</span> <span class="main">=</span> ranks_2 <span class="free">A</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ext set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> comp_apply<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">g</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="bound">S</span> <span class="bound">y</span><span class="main">.</span> get_3 <span class="free">A</span> <span class="main">(</span>bounds_3 <span class="free">A</span> <span class="free">a</span> <span class="skolem">f</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">S</span> <span class="main">⟶</span> <span class="skolem">g</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">S</span><span class="main">)</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound">q</span> <span class="bound">S</span> <span class="bound">l</span> <span class="bound">d</span><span class="main">.</span> get_3 <span class="free">A</span> <span class="main">(</span>bounds_3 <span class="free">A</span> <span class="free">a</span> <span class="skolem">f</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">S</span> <span class="main">⟶</span> <span class="skolem">g</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">S</span><span class="main">.</span> get_3 <span class="free">A</span> <span class="main">(</span>bounds_3 <span class="free">A</span> <span class="free">a</span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="bound">S</span> <span class="main">⟶</span> <span class="skolem">g</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">S</span><span class="main">)</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="skolem">g</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">l</span> <span class="main">≤</span> <span class="main">⨅</span><span class="main">(</span>fst <span class="main">`</span> <span class="main">(</span>Some <span class="main">-`</span> <span class="skolem">f</span> <span class="main">`</span> pred <span class="free">A</span> <span class="free">a</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="skolem">d</span> <span class="main">⟷</span> <span class="main">⨆</span><span class="main">(</span>snd <span class="main">`</span> <span class="main">(</span>Some <span class="main">-`</span> <span class="skolem">f</span> <span class="main">`</span> pred <span class="free">A</span> <span class="free">a</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> even <span class="skolem">l</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>accepting <span class="free">A</span> <span class="skolem">q</span> <span class="main">⟶</span> even <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">g</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>transition <span class="free">A</span> <span class="free">a</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>dom <span class="skolem">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">q</span> <span class="skolem">l</span> <span class="skolem">d</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∉</span> dom <span class="skolem">g</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">-`</span> <span class="skolem">f</span> <span class="main">`</span> pred <span class="free">A</span> <span class="free">a</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 3 <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> get_3_def items_3_def bounds_3_def Let_def <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> expand_map <span class="main">(</span>get_3 <span class="free">A</span> <span class="main">(</span>bounds_3 <span class="free">A</span> <span class="free">a</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="skolem">g</span> <span class="main">∈</span> ranks_2 <span class="free">A</span> <span class="free">a</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> expand_map_alt_def ranks_2_def mem_Collect_eq
      <span class="keyword1"><span class="command">unfolding</span></span> get_3_dom bounds_3_dom 1 <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> complement_succ_3_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"complement_succ_3 <span class="main">=</span> complement_succ_2"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> complement_succ_3_def complement_succ_2_def expand_map_get_bounds_3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command">lemma</span></span> complement_initial_3_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>const <span class="main">(</span>Some <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">,</span> False<span class="main">)</span><span class="main">)</span> <span class="main">|`</span> initial <span class="free">A</span><span class="main">}</span> <span class="main">=</span>
    <span class="main">{</span><span class="main">(</span>Some <span class="main">∘</span> <span class="main">(</span>const <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">,</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`</span> initial <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> comp_apply <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command">lemma</span></span> complement_accepting_3_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"True <span class="main">∉</span> snd <span class="main">`</span> ran <span class="free">f</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> map_to_set <span class="free">f</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_to_set_def ran_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">lemma</span></span> complement_3_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>complement_3<span class="main">,</span> complement_2<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> nba_rel <span class="main">→</span> <span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> nba_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> complement_3_def complement_2_def
    <span class="keyword1"><span class="command">unfolding</span></span> complement_succ_3_refine complement_initial_3_refine complement_accepting_3_refine
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Phase 4›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">items_4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> item <span class="main">⇒</span> item set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">items_4</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">c</span> <span class="main">∧</span> even <span class="bound">l</span><span class="main">)</span> <span class="main">|</span><span class="bound">l</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> Suc <span class="bound">l</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="main">(</span>accepting <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟶</span> even <span class="bound">l</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'state</span> items <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span> <span class="main">⇀</span> item set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">get_4</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> map_option <span class="main">(</span>items_4 <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">complement_succ_4</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> items <span class="main">⇒</span> <span class="tfree">'state</span> items set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">complement_succ_4</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> expand_map <span class="main">∘</span> get_4 <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∘</span> bounds_3 <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∘</span> refresh_1"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">complement_4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span> items<span class="main">)</span> nba"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">complement_4</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> nba
      <span class="main">(</span>alphabet <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
      <span class="main">(</span><span class="main">{</span><span class="main">(</span>Some <span class="main">∘</span> <span class="main">(</span>const <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>nodes <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">,</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`</span> initial <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span><span class="main">)</span>
      <span class="main">(</span>complement_succ_4 <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> <span class="main">∀</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> map_to_set <span class="bound">f</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">c</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> get_4_dom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>get_4 <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> get_4_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bind_splits<span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> items rel"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">.</span>
      dom <span class="bound">f</span> <span class="main">=</span> dom <span class="bound">g</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> dom <span class="bound">f</span><span class="main">.</span> fst <span class="main">(</span>the <span class="main">(</span><span class="bound">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> fst <span class="main">(</span>the <span class="main">(</span><span class="bound">g</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> dom <span class="bound">f</span><span class="main">.</span> snd <span class="main">(</span>the <span class="main">(</span><span class="bound">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> snd <span class="main">(</span>the <span class="main">(</span><span class="bound">g</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> bounds_R<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> R"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bounds_3 <span class="free">A</span> <span class="free">a</span> <span class="main">(</span>refresh_1 <span class="free">f</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bounds_3 <span class="free">A</span> <span class="free">a</span> <span class="main">(</span>refresh_1 <span class="free">g</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⟷</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span>
      <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">=</span> dom <span class="free">g</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> dom <span class="free">f</span><span class="main">.</span> fst <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> fst <span class="main">(</span>the <span class="main">(</span><span class="free">g</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> dom <span class="free">f</span><span class="main">.</span> snd <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> snd <span class="main">(</span>the <span class="main">(</span><span class="free">g</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">⨅</span><span class="main">(</span>fst <span class="main">`</span> <span class="main">(</span>Some <span class="main">-`</span> refresh_1 <span class="free">f</span> <span class="main">`</span> pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> bounds_3_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> Some <span class="main">-`</span> refresh_1 <span class="free">f</span> <span class="main">`</span> pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">=</span> fst <span class="main">`</span> Some <span class="main">-`</span> <span class="free">f</span> <span class="main">`</span> pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" fst <span class="main">`</span> Some <span class="main">-`</span> refresh_1 <span class="free">f</span> <span class="main">`</span> pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">⊆</span> fst <span class="main">`</span> Some <span class="main">-`</span> <span class="free">f</span> <span class="main">`</span> pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> refresh_1_def image_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_option_case <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span> <span class="main">(</span><span class="operator">force</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> Some <span class="main">-`</span> <span class="free">f</span> <span class="main">`</span> pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">⊆</span> fst <span class="main">`</span> Some <span class="main">-`</span> refresh_1 <span class="free">f</span> <span class="main">`</span> pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> refresh_1_def image_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_option_case <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> fst_conv option.sel<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fst <span class="main">`</span> Some <span class="main">-`</span> <span class="free">f</span> <span class="main">`</span> <span class="main">(</span>pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">∩</span> dom <span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> dom_def image_def Int_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fst <span class="main">`</span> the <span class="main">`</span> <span class="free">f</span> <span class="main">`</span> <span class="main">(</span>pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">∩</span> dom <span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> dom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">∘</span> the <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">∩</span> dom <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span><span class="main">(</span><span class="main">(</span>fst <span class="main">∘</span> the <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">∩</span> dom <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
      <span class="main">⨅</span><span class="main">(</span><span class="main">(</span>fst <span class="main">∘</span> the <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">∩</span> dom <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> cINF_mono<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">∩</span> dom <span class="free">g</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> bounds_3_def refresh_1_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span> <span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bdd_below <span class="main">(</span><span class="main">(</span>fst <span class="main">∘</span> the <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">∩</span> dom <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span> <span class="main">∈</span> pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">∩</span> dom <span class="free">f</span><span class="main">.</span> <span class="main">(</span>fst <span class="main">∘</span> the <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="bound">n</span> <span class="main">≤</span> <span class="main">(</span>fst <span class="main">∘</span> the <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∈</span> pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">∩</span> dom <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span> <span class="keyword1"><span class="command">using</span></span> 1 that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">∘</span> the <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">∩</span> dom <span class="free">g</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">`</span> the <span class="main">`</span> <span class="free">g</span> <span class="main">`</span> <span class="main">(</span>pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">∩</span> dom <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fst <span class="main">`</span> Some <span class="main">-`</span> <span class="free">g</span> <span class="main">`</span> <span class="main">(</span>pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">∩</span> dom <span class="free">g</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> dom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fst <span class="main">`</span> Some <span class="main">-`</span> <span class="free">g</span> <span class="main">`</span> pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> dom_def image_def Int_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fst <span class="main">`</span> Some <span class="main">-`</span> refresh_1 <span class="free">g</span> <span class="main">`</span> pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> Some <span class="main">-`</span> <span class="free">g</span> <span class="main">`</span> pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">⊆</span> fst <span class="main">`</span> Some <span class="main">-`</span> refresh_1 <span class="free">g</span> <span class="main">`</span> pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> refresh_1_def image_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_option_case <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> fst_conv option.sel<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> Some <span class="main">-`</span> refresh_1 <span class="free">g</span> <span class="main">`</span> pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">⊆</span> fst <span class="main">`</span> Some <span class="main">-`</span> <span class="free">g</span> <span class="main">`</span> pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> refresh_1_def image_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_option_case <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span> <span class="main">(</span><span class="operator">force</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span><span class="main">(</span>fst <span class="main">`</span> <span class="main">(</span>Some <span class="main">-`</span> refresh_1 <span class="free">g</span> <span class="main">`</span> pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> bounds_3_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⟷</span> <span class="main">⨆</span><span class="main">(</span>snd <span class="main">`</span> <span class="main">(</span>Some <span class="main">-`</span> refresh_1 <span class="free">f</span> <span class="main">`</span> pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> bounds_3_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> Some <span class="main">-`</span> refresh_1 <span class="free">f</span> <span class="main">`</span> pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">=</span> snd <span class="main">`</span> Some <span class="main">-`</span> refresh_1 <span class="free">f</span> <span class="main">`</span> <span class="main">(</span>pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">∩</span> dom <span class="main">(</span>refresh_1 <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> dom_def image_def Int_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> snd <span class="main">`</span> the <span class="main">`</span> refresh_1 <span class="free">f</span> <span class="main">`</span> <span class="main">(</span>pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">∩</span> dom <span class="main">(</span>refresh_1 <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> dom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>snd <span class="main">∘</span> the <span class="main">∘</span> refresh_1 <span class="free">f</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">∩</span> dom <span class="main">(</span>refresh_1 <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>snd <span class="main">∘</span> the <span class="main">∘</span> refresh_1 <span class="free">g</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">∩</span> dom <span class="main">(</span>refresh_1 <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> image_cong<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">∩</span> dom <span class="main">(</span>refresh_1 <span class="free">f</span><span class="main">)</span> <span class="main">=</span> pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">∩</span> dom <span class="main">(</span>refresh_1 <span class="free">g</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> refresh_1_dom 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="main">∘</span> the <span class="main">∘</span> refresh_1 <span class="free">f</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">⟷</span> <span class="main">(</span>snd <span class="main">∘</span> the <span class="main">∘</span> refresh_1 <span class="free">g</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">∩</span> dom <span class="main">(</span>refresh_1 <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">q</span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> ran <span class="free">f</span><span class="main">.</span> <span class="main">¬</span> snd <span class="bound">x</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> True<span class="main">)</span> <span class="main">∈</span> ran <span class="free">g</span> <span class="main">⟹</span> <span class="free">g</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="skolem">k</span> <span class="skolem">c</span>
          <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> dom_def ran_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Collect_inj<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> option.sel snd_conv<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> True<span class="main">)</span> <span class="main">⟹</span> <span class="free">f</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="skolem">k</span> <span class="skolem">c</span>
          <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> dom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> ran <span class="free">g</span><span class="main">.</span> <span class="main">¬</span> snd <span class="bound">x</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> True<span class="main">)</span> <span class="main">∈</span> ran <span class="free">f</span> <span class="main">⟹</span> False"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
          <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> dom_def ran_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Collect_inj<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> option.sel snd_conv<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="main">∘</span> the <span class="main">∘</span> refresh_1 <span class="free">f</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">⟹</span> <span class="main">(</span>snd <span class="main">∘</span> the <span class="main">∘</span> refresh_1 <span class="free">g</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">,</span> 3<span class="main">)</span> 2 3 <span class="keyword1"><span class="command">unfolding</span></span> refresh_1_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="main">∘</span> the <span class="main">∘</span> refresh_1 <span class="free">g</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">⟹</span> <span class="main">(</span>snd <span class="main">∘</span> the <span class="main">∘</span> refresh_1 <span class="free">f</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">,</span> 3<span class="main">)</span> 2 4 5 <span class="keyword1"><span class="command">unfolding</span></span> refresh_1_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_option_case <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span> <span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> snd <span class="main">`</span> the <span class="main">`</span> refresh_1 <span class="free">g</span> <span class="main">`</span> <span class="main">(</span>pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">∩</span> dom <span class="main">(</span>refresh_1 <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> snd <span class="main">`</span> Some <span class="main">-`</span> refresh_1 <span class="free">g</span> <span class="main">`</span> <span class="main">(</span>pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">∩</span> dom <span class="main">(</span>refresh_1 <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> dom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> snd <span class="main">`</span> Some <span class="main">-`</span> refresh_1 <span class="free">g</span> <span class="main">`</span> pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> dom_def image_def Int_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨆</span><span class="main">(</span>snd <span class="main">`</span> <span class="main">(</span>Some <span class="main">-`</span> refresh_1 <span class="free">g</span> <span class="main">`</span> pred <span class="free">A</span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">c</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> bounds_3_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⟷</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> complement_4_language_1<span class="main">:</span> <span class="quoted"><span class="quoted">"language <span class="main">(</span>complement_3 <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span> language <span class="main">(</span>complement_4 <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> simulation_language<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"alphabet <span class="main">(</span>complement_3 <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span> alphabet <span class="main">(</span>complement_4 <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> complement_3_def complement_4_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">q</span> <span class="main">∈</span> initial <span class="main">(</span>complement_4 <span class="free">A</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span> <span class="main">∈</span> R"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> initial <span class="main">(</span>complement_3 <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> complement_3_def complement_4_def R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">g'</span> <span class="main">∈</span> transition <span class="main">(</span>complement_4 <span class="free">A</span><span class="main">)</span> <span class="skolem">a</span> <span class="skolem">g</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f'</span><span class="main">,</span> <span class="bound">g'</span><span class="main">)</span> <span class="main">∈</span> R"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">∈</span> transition <span class="main">(</span>complement_3 <span class="free">A</span><span class="main">)</span> <span class="skolem">a</span> <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">∈</span> R"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">g</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">∈</span> expand_map <span class="main">(</span>get_3 <span class="free">A</span> <span class="main">(</span>bounds_3 <span class="free">A</span> <span class="skolem">a</span> <span class="main">(</span>refresh_1 <span class="skolem">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> complement_3_def complement_succ_3_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span>
        <span class="quoted"><span class="quoted">"dom <span class="skolem">f</span> <span class="main">=</span> dom <span class="skolem">g</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> dom <span class="skolem">f</span><span class="main">.</span> fst <span class="main">(</span>the <span class="main">(</span><span class="skolem">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> fst <span class="main">(</span>the <span class="main">(</span><span class="skolem">g</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> dom <span class="skolem">f</span><span class="main">.</span> snd <span class="main">(</span>the <span class="main">(</span><span class="skolem">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> snd <span class="main">(</span>the <span class="main">(</span><span class="skolem">g</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">f'</span> <span class="main">=</span> dom <span class="main">(</span>get_3 <span class="free">A</span> <span class="main">(</span>bounds_3 <span class="free">A</span> <span class="skolem">a</span> <span class="main">(</span>refresh_1 <span class="skolem">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> expand_map_dom 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> dom <span class="main">(</span>bounds_3 <span class="free">A</span> <span class="skolem">a</span> <span class="main">(</span>refresh_1 <span class="skolem">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">f'</span> <span class="main">=</span> dom <span class="main">(</span>bounds_3 <span class="free">A</span> <span class="skolem">a</span> <span class="main">(</span>refresh_1 <span class="skolem">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="skolem">p</span> <span class="main">≡</span> <span class="keyword1">do</span>
      <span class="main">{</span>
        <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">←</span> bounds_3 <span class="free">A</span> <span class="skolem">a</span> <span class="main">(</span>refresh_1 <span class="skolem">g</span><span class="main">)</span> <span class="skolem">p</span><span class="main">;</span>
        <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span> <span class="main">←</span> <span class="skolem">f'</span> <span class="skolem">p</span><span class="main">;</span>
        Some <span class="main">(</span><span class="keyword1">if</span> even <span class="bound">k</span> <span class="main">=</span> even <span class="bound">l</span> <span class="keyword1">then</span> <span class="bound">k</span> <span class="keyword1">else</span> <span class="bound">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span>
      <span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="skolem">p</span> <span class="main">=</span> <span class="keyword1">do</span>
      <span class="main">{</span>
        <span class="bound">kc</span> <span class="main">←</span> bounds_3 <span class="free">A</span> <span class="skolem">a</span> <span class="main">(</span>refresh_1 <span class="skolem">g</span><span class="main">)</span> <span class="skolem">p</span><span class="main">;</span>
        <span class="bound">ld</span> <span class="main">←</span> <span class="skolem">f'</span> <span class="skolem">p</span><span class="main">;</span>
        Some <span class="main">(</span><span class="keyword1">if</span> even <span class="main">(</span>fst <span class="bound">kc</span><span class="main">)</span> <span class="main">=</span> even <span class="main">(</span>fst <span class="bound">ld</span><span class="main">)</span> <span class="keyword1">then</span> fst <span class="bound">kc</span> <span class="keyword1">else</span> fst <span class="bound">kc</span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> snd <span class="bound">ld</span><span class="main">)</span>
      <span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="keyword1"><span class="command">unfolding</span></span> g'_def case_prod_beta <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">g'</span> <span class="main">=</span> dom <span class="main">(</span>bounds_3 <span class="free">A</span> <span class="skolem">a</span> <span class="main">(</span>refresh_1 <span class="skolem">g</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> dom <span class="skolem">f'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 bind_eq_Some_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> dom <span class="skolem">f'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">g'</span> <span class="main">=</span> dom <span class="skolem">f'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> items_3 <span class="free">A</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"bounds_3 <span class="free">A</span> <span class="skolem">a</span> <span class="main">(</span>refresh_1 <span class="skolem">f</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">k</span> <span class="skolem">c</span> <span class="skolem">l</span> <span class="skolem">d</span>
        <span class="keyword1"><span class="command">using</span></span> 1 that <span class="keyword1"><span class="command">unfolding</span></span> expand_map_alt_def get_3_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> complement_4_def nba.sel complement_succ_4_def comp_apply
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f'</span><span class="main">,</span> <span class="skolem">g'</span><span class="main">)</span> <span class="main">∈</span> R"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> R_def mem_Collect_eq prod.case
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI ballI<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">f'</span> <span class="main">=</span> dom <span class="skolem">g'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
          <span class="keyword3"><span class="command">assume</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> dom <span class="skolem">f'</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> dom <span class="main">(</span>bounds_3 <span class="free">A</span> <span class="skolem">a</span> <span class="main">(</span>refresh_1 <span class="skolem">g</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> 3 10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> 12<span class="main">:</span> <span class="quoted"><span class="quoted">"bounds_3 <span class="free">A</span> <span class="skolem">a</span> <span class="main">(</span>refresh_1 <span class="skolem">g</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> 13<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> 14<span class="main">:</span> <span class="quoted"><span class="quoted">"bounds_3 <span class="free">A</span> <span class="skolem">a</span> <span class="main">(</span>refresh_1 <span class="skolem">f</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
          <span class="keyword1"><span class="command">have</span></span> 15<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> items_3 <span class="free">A</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 6 14 13 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">have</span></span> 16<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bounds_R<span class="main">(</span>1<span class="main">)</span> that<span class="main">(</span>2<span class="main">)</span> 14 12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">have</span></span> 17<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 15 16 <span class="keyword1"><span class="command">unfolding</span></span> items_3_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> 18<span class="main">:</span> <span class="quoted"><span class="quoted">"even <span class="skolem">k</span> <span class="main">⟷</span> odd <span class="skolem">l</span> <span class="main">⟹</span> <span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">⟹</span> <span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
          <span class="keyword1"><span class="command">have</span></span> 19<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">⟷</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bounds_R<span class="main">(</span>2<span class="main">)</span> that<span class="main">(</span>2<span class="main">)</span> 14 12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>the <span class="main">(</span><span class="skolem">f'</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> fst <span class="main">(</span>the <span class="main">(</span><span class="skolem">g'</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 17 18 <span class="keyword1"><span class="command">unfolding</span></span> 4 12 13 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>the <span class="main">(</span><span class="skolem">f'</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> snd <span class="main">(</span>the <span class="main">(</span><span class="skolem">g'</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 19 <span class="keyword1"><span class="command">unfolding</span></span> 4 12 13 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">∈</span> expand_map <span class="main">(</span>get_4 <span class="free">A</span> <span class="main">(</span>bounds_3 <span class="free">A</span> <span class="skolem">a</span> <span class="main">(</span>refresh_1 <span class="skolem">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> expand_map_alt_def mem_Collect_eq
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI allI impI<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">g'</span> <span class="main">=</span> dom <span class="main">(</span>get_4 <span class="free">A</span> <span class="main">(</span>bounds_3 <span class="free">A</span> <span class="skolem">a</span> <span class="main">(</span>refresh_1 <span class="skolem">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> 3 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">S</span> <span class="skolem">xy</span>
          <span class="keyword3"><span class="command">assume</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"get_4 <span class="free">A</span> <span class="main">(</span>bounds_3 <span class="free">A</span> <span class="skolem">a</span> <span class="main">(</span>refresh_1 <span class="skolem">g</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="skolem">S</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="skolem">xy</span>"</span></span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> 12<span class="main">:</span> <span class="quoted"><span class="quoted">"bounds_3 <span class="free">A</span> <span class="skolem">a</span> <span class="main">(</span>refresh_1 <span class="skolem">g</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> items_4 <span class="free">A</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 10 <span class="keyword1"><span class="command">unfolding</span></span> get_4_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> 13<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xy</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> even <span class="skolem">k</span> <span class="main">⟷</span> even <span class="skolem">l</span> <span class="keyword1">then</span> <span class="skolem">k</span> <span class="keyword1">else</span> <span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 11 12 <span class="keyword1"><span class="command">unfolding</span></span> g'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bind_splits<span class="main">)</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> 14<span class="main">:</span> <span class="quoted"><span class="quoted">"bounds_3 <span class="free">A</span> <span class="skolem">a</span> <span class="main">(</span>refresh_1 <span class="skolem">f</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 13<span class="main">(</span>1<span class="main">)</span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
          <span class="keyword1"><span class="command">have</span></span> 15<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> items_3 <span class="free">A</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 6 14 13<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">have</span></span> 16<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bounds_R<span class="main">(</span>1<span class="main">)</span> that<span class="main">(</span>2<span class="main">)</span> 14 12<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">have</span></span> 17<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">⟷</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bounds_R<span class="main">(</span>2<span class="main">)</span> that<span class="main">(</span>2<span class="main">)</span> 14 12<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xy</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 15 16 17 <span class="keyword1"><span class="command">unfolding</span></span> 12<span class="main">(</span>2<span class="main">)</span> 13<span class="main">(</span>2<span class="main">)</span> items_3_def items_4_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span> <span class="main">∈</span> R <span class="main">⟹</span> accepting <span class="main">(</span>complement_3 <span class="free">A</span><span class="main">)</span> <span class="bound">p</span> <span class="main">⟹</span> accepting <span class="main">(</span>complement_4 <span class="free">A</span><span class="main">)</span> <span class="bound">q</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> complement_3_def complement_4_def R_def map_to_set_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> domIff eq_snd_iff option.exhaust_sel option.sel<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> complement_4_less<span class="main">:</span> <span class="quoted"><span class="quoted">"complement_4 <span class="free">A</span> <span class="main">≤</span> complement_3 <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_nba_def
  <span class="keyword1"><span class="command">unfolding</span></span> complement_4_def complement_3_def nba.sel
  <span class="keyword1"><span class="command">unfolding</span></span> complement_succ_4_def complement_succ_3_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> comp_apply<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">f</span> <span class="skolem">g</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> expand_map <span class="main">(</span>get_4 <span class="free">A</span> <span class="main">(</span>bounds_3 <span class="free">A</span> <span class="skolem">a</span> <span class="main">(</span>refresh_1 <span class="skolem">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> expand_map <span class="main">(</span>get_3 <span class="free">A</span> <span class="main">(</span>bounds_3 <span class="free">A</span> <span class="skolem">a</span> <span class="main">(</span>refresh_1 <span class="skolem">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> get_4_def get_3_def items_4_def items_3_def expand_map_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> complement_4_language_2<span class="main">:</span> <span class="quoted"><span class="quoted">"language <span class="main">(</span>complement_4 <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span> language <span class="main">(</span>complement_3 <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> language_mono complement_4_less <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> monoD<span class="main">)</span>
  <span class="keyword1"><span class="command">lemma</span></span> complement_4_language<span class="main">:</span> <span class="quoted"><span class="quoted">"language <span class="main">(</span>complement_3 <span class="free">A</span><span class="main">)</span> <span class="main">=</span> language <span class="main">(</span>complement_4 <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> complement_4_language_1 complement_4_language_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">lemma</span></span> complement_4_finite<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="main">(</span>complement_4 <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nodes <span class="main">(</span>complement_3 <span class="free">A</span><span class="main">)</span><span class="main">,</span> nodes <span class="main">(</span>complement_2 <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">⟩</span> set_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> complement_3_refine <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nodes <span class="main">(</span>complement_2 <span class="free">A</span><span class="main">)</span><span class="main">,</span> nodes <span class="main">(</span>complement_1 <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">⟩</span> set_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> complement_2_refine <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nodes <span class="main">(</span>complement_1 <span class="free">A</span><span class="main">)</span><span class="main">,</span> nodes <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>cs_rel<span class="main">⟩</span> set_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> complement_1_refine <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nodes <span class="main">(</span>complement_3 <span class="free">A</span><span class="main">)</span><span class="main">,</span> nodes <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>cs_rel<span class="main">⟩</span> set_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> complement_finite assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="main">(</span>complement_3 <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_set_rel_transfer_back 1 cs_rel_inv_single_valued 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"nodes <span class="main">(</span>complement_4 <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span> nodes <span class="main">(</span>complement_3 <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nodes_mono complement_4_less <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> monoD<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="main">(</span>complement_4 <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_subset 4 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> complement_4_correct<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"language <span class="main">(</span>complement_4 <span class="free">A</span><span class="main">)</span> <span class="main">=</span> streams <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">-</span> language <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"language <span class="main">(</span>complement_4 <span class="free">A</span><span class="main">)</span> <span class="main">=</span> language <span class="main">(</span>complement_3 <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> complement_4_language <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>language <span class="main">(</span>complement_3 <span class="free">A</span><span class="main">)</span><span class="main">,</span> language <span class="main">(</span>complement_2 <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⟨</span>Id<span class="main">⟩</span> stream_rel<span class="main">⟩</span> set_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> complement_3_refine <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>language <span class="main">(</span>complement_2 <span class="free">A</span><span class="main">)</span><span class="main">,</span> language <span class="main">(</span>complement_1 <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⟨</span>Id<span class="main">⟩</span> stream_rel<span class="main">⟩</span> set_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> complement_2_refine <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>language <span class="main">(</span>complement_1 <span class="free">A</span><span class="main">)</span><span class="main">,</span> language <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⟨</span>Id<span class="main">⟩</span> stream_rel<span class="main">⟩</span> set_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> complement_1_refine <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"language <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span> <span class="main">=</span> streams <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">-</span> language <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> complement_language assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"language <span class="main">(</span>complement_4 <span class="free">A</span><span class="main">)</span> <span class="main">=</span> streams <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">-</span> language <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Phase 5›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">refresh_5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> items <span class="main">⇒</span> <span class="tfree">'state</span> items nres"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">refresh_5</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="main">∃</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> map_to_set <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">.</span> <span class="bound">c</span>
      <span class="keyword1">then</span> RETURN <span class="free"><span class="bound"><span class="entity">f</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">do</span>
      <span class="main">{</span>
        ASSUME <span class="main">(</span>finite <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        FOREACH <span class="main">(</span>map_to_set <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="bound">m</span><span class="main">.</span> <span class="keyword1">do</span>
        <span class="main">{</span>
          ASSERT <span class="main">(</span><span class="bound">p</span> <span class="main">∉</span> dom <span class="bound">m</span><span class="main">)</span><span class="main">;</span>
          RETURN <span class="main">(</span><span class="bound">m</span> <span class="main">(</span><span class="bound">p</span> <span class="main">↦</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">}</span>
        <span class="main">)</span> Map.empty
      <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">merge_5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"item <span class="main">⇒</span> item option <span class="main">⇒</span> item"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">merge_5</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="main">λ</span> None <span class="main">⇒</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">|</span> Some <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">k</span> <span class="main">⊓</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">c</span> <span class="main">⊔</span> <span class="bound">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">bounds_5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> items <span class="main">⇒</span> <span class="tfree">'state</span> items nres"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">bounds_5</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span>
    <span class="main">{</span>
      ASSUME <span class="main">(</span>finite <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      ASSUME <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span><span class="main">.</span> finite <span class="main">(</span>transition <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      FOREACH <span class="main">(</span>map_to_set <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">m</span><span class="main">.</span>
        FOREACH <span class="main">(</span>transition <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">q</span> <span class="bound">f</span><span class="main">.</span>
          RETURN <span class="main">(</span><span class="bound">f</span> <span class="main">(</span><span class="bound">q</span> <span class="main">↦</span> merge_5 <span class="bound">s</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="bound">m</span><span class="main">)</span>
      Map.empty
    <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">items_5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> item <span class="main">⇒</span> item set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">items_5</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span>
    <span class="main">{</span>
      <span class="keyword1">let</span> <span class="bound">values</span> <span class="main">=</span> <span class="keyword1">if</span> accepting <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> Set.filter even <span class="main">{</span><span class="bound">k</span> <span class="main">-</span> <span class="main">1</span> <span class="main">..</span> <span class="bound">k</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{</span><span class="bound">k</span> <span class="main">-</span> <span class="main">1</span> <span class="main">..</span> <span class="bound">k</span><span class="main">}</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">item</span> <span class="main">=</span> <span class="main">λ</span> <span class="bound">l</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">c</span> <span class="main">∧</span> even <span class="bound">l</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">item</span> <span class="main">`</span> <span class="bound">values</span>
    <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'state</span> items <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span> <span class="main">⇀</span> item set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">get_5</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> map_option <span class="main">(</span>items_5 <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">expand_5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span> set nres"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">expand_5</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> FOREACH <span class="main">(</span>map_to_set <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span> <span class="bound">X</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
        ASSERT <span class="main">(</span><span class="main">∀</span> <span class="bound">g</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> dom <span class="bound">g</span><span class="main">)</span><span class="main">;</span>
        ASSERT <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> <span class="bound">S</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">b</span> <span class="main">∈</span> <span class="bound">S</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≠</span> <span class="bound">b</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">(</span><span class="bound">x</span> <span class="main">↦</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">a</span> <span class="main">∩</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">(</span><span class="bound">x</span> <span class="main">↦</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">b</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span><span class="main">;</span>
        RETURN <span class="main">(</span><span class="main">⋃</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">(</span><span class="bound">x</span> <span class="main">↦</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="bound">X</span><span class="main">)</span>
      <span class="main">}</span><span class="main">)</span> <span class="main">{</span>Map.empty<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">complement_succ_5</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> items <span class="main">⇒</span> <span class="tfree">'state</span> items set nres"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">complement_succ_5</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span>
    <span class="main">{</span>
      <span class="bound">f</span> <span class="main">←</span> refresh_5 <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
      <span class="bound">f</span> <span class="main">←</span> bounds_5 <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">f</span><span class="main">;</span>
      ASSUME <span class="main">(</span>finite <span class="main">(</span>dom <span class="bound">f</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      expand_5 <span class="main">(</span>get_5 <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">f</span><span class="main">)</span>
    <span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> bounds_3_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"bounds_3 <span class="free">A</span> <span class="free">a</span> Map.empty <span class="main">=</span> Map.empty"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bounds_3_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">lemma</span></span> bounds_3_update<span class="main">:</span> <span class="quoted"><span class="quoted">"bounds_3 <span class="free">A</span> <span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    override_on <span class="main">(</span>bounds_3 <span class="free">A</span> <span class="free">a</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">∘</span> merge_5 <span class="free">s</span> <span class="main">∘</span> bounds_3 <span class="free">A</span> <span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">p</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>transition <span class="free">A</span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">note</span></span> fun_upd_image<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bounds_3 <span class="free">A</span> <span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">=</span>
      override_on <span class="main">(</span>bounds_3 <span class="free">A</span> <span class="free">a</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">∘</span> merge_5 <span class="free">s</span> <span class="main">∘</span> bounds_3 <span class="free">A</span> <span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">p</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>transition <span class="free">A</span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="free">a</span> <span class="free">p</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">≡</span> Some <span class="main">-`</span> <span class="free">f</span> <span class="main">`</span> <span class="main">(</span>pred <span class="free">A</span> <span class="free">a</span> <span class="skolem">q</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="main">-`</span> <span class="free">f</span> <span class="main">(</span><span class="free">p</span> <span class="main">:=</span> Some <span class="free">s</span><span class="main">)</span> <span class="main">`</span> pred <span class="free">A</span> <span class="free">a</span> <span class="skolem">q</span> <span class="main">=</span> insert <span class="free">s</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="main">-`</span> <span class="free">f</span> <span class="main">(</span><span class="free">p</span> <span class="main">:=</span> None<span class="main">)</span> <span class="main">`</span> pred <span class="free">A</span> <span class="free">a</span> <span class="skolem">q</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounds_3 <span class="free">A</span> <span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">⨅</span><span class="main">(</span>fst <span class="main">`</span> <span class="main">(</span>insert <span class="free">s</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">⨆</span><span class="main">(</span>snd <span class="main">`</span> <span class="main">(</span>insert <span class="free">s</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> bounds_3_def 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Some <span class="main">(</span>merge_5 <span class="free">s</span> <span class="main">(</span>bounds_3 <span class="free">A</span> <span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">p</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> 2 bounds_3_def merge_5_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cInf_insert<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> override_on <span class="main">(</span>bounds_3 <span class="free">A</span> <span class="free">a</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">∘</span> merge_5 <span class="free">s</span> <span class="main">∘</span> bounds_3 <span class="free">A</span> <span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">p</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>transition <span class="free">A</span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred <span class="free">A</span> <span class="free">a</span> <span class="skolem">q</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">p</span><span class="main">}</span> <span class="main">=</span> pred <span class="free">A</span> <span class="free">a</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bounds_3_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> refresh_5_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>refresh_5<span class="main">,</span> <span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> RETURN <span class="main">(</span>refresh_1 <span class="bound">f</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> <span class="main">⟨</span>Id<span class="main">⟩</span> nres_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> item option"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> map_to_set <span class="skolem">f</span><span class="main">.</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟷</span> True <span class="main">∈</span> snd <span class="main">`</span> ran <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> image_def map_to_set_def ran_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>refresh_5 <span class="skolem">f</span><span class="main">,</span> RETURN <span class="main">(</span>refresh_1 <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">⟩</span> nres_rel"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> refresh_5_def refresh_1_def 1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_vcg</span> FOREACH_rule_map_eq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">m</span><span class="main">.</span> map_option <span class="main">(</span>apsnd <span class="main">⊤</span><span class="main">)</span> <span class="main">∘</span> <span class="bound">m</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> bounds_5_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bounds_5 <span class="free">A</span> <span class="free">a</span><span class="main">,</span> <span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> RETURN <span class="main">(</span>bounds_3 <span class="free">A</span> <span class="free">a</span> <span class="bound">f</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> <span class="main">⟨</span>Id<span class="main">⟩</span> nres_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bounds_5_def <span class="keyword1"><span class="command">by</span></span>
      <span class="main">(</span><span class="operator">refine_vcg</span> FOREACH_rule_map_eq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"bounds_3 <span class="free">A</span> <span class="free">a</span>"</span></span><span class="main"><span class="main">]</span></span> FOREACH_rule_insert_eq<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> override_on_insert bounds_3_empty bounds_3_update<span class="main">)</span>
  <span class="keyword1"><span class="command">lemma</span></span> items_5_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"items_5 <span class="main">=</span> items_4"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> items_5_def items_4_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">lemma</span></span> get_5_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"get_5 <span class="main">=</span> get_4"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> get_5_def get_4_def items_5_refine <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command">lemma</span></span> expand_5_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>expand_5 <span class="free">f</span><span class="main">,</span> ASSERT <span class="main">(</span>finite <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">⪢</span> RETURN <span class="main">(</span>expand_map <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">⟩</span> nres_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> expand_5_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_vcg</span> FOREACH_rule_map_eq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">expand_map</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> expand_map_dom map_upd_eqD1<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> complement_succ_5_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>complement_succ_5<span class="main">,</span> RETURN <span class="main">∘∘∘</span> complement_succ_4<span class="main">)</span> <span class="main">∈</span>
    Id <span class="main">→</span> Id <span class="main">→</span> Id <span class="main">→</span> <span class="main">⟨</span>Id<span class="main">⟩</span> nres_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> complement_succ_5_def complement_succ_4_def get_5_refine comp_apply
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_vcg</span> vcg1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refresh_5_refine<span class="main"><span class="main">]</span></span> vcg1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bounds_5_refine<span class="main"><span class="main">]</span></span> vcg0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> expand_5_refine<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Phase 6›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">expand_map_get_6</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'state</span> items <span class="main">⇒</span> <span class="tfree">'state</span> items set nres"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">expand_map_get_6</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> FOREACH <span class="main">(</span>map_to_set <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="bound">X</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      ASSERT <span class="main">(</span><span class="main">∀</span> <span class="bound">g</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∉</span> dom <span class="bound">g</span><span class="main">)</span><span class="main">;</span>
      ASSERT <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> <span class="main">(</span>items_5 <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">k</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">b</span> <span class="main">∈</span> <span class="main">(</span>items_5 <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">k</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≠</span> <span class="bound">b</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">(</span><span class="bound">k</span> <span class="main">↦</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">a</span> <span class="main">∩</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">(</span><span class="bound">k</span> <span class="main">↦</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">b</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span><span class="main">;</span>
      RETURN <span class="main">(</span><span class="main">⋃</span> <span class="bound">y</span> <span class="main">∈</span> items_5 <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">k</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">(</span><span class="bound">k</span> <span class="main">↦</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="bound">X</span><span class="main">)</span>
      <span class="main">}</span><span class="main">)</span> <span class="main">{</span>Map.empty<span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> expand_map_get_6_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>expand_map_get_6<span class="main">,</span> expand_5 <span class="main">∘∘</span> get_5<span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> Id <span class="main">→</span> <span class="main">⟨</span>Id<span class="main">⟩</span> nres_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> expand_map_get_6_def expand_5_def get_5_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> FOREACH_rule_map_map<span class="main"><span class="main">[</span></span><span class="operator">param_fo</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">complement_succ_6</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> items <span class="main">⇒</span> <span class="tfree">'state</span> items set nres"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">complement_succ_6</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span>
    <span class="main">{</span>
      <span class="bound">f</span> <span class="main">←</span> refresh_5 <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
      <span class="bound">f</span> <span class="main">←</span> bounds_5 <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">f</span><span class="main">;</span>
      ASSUME <span class="main">(</span>finite <span class="main">(</span>dom <span class="bound">f</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      expand_map_get_6 <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">f</span>
    <span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> complement_succ_6_refine<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>complement_succ_6<span class="main">,</span> complement_succ_5<span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> Id <span class="main">→</span> Id <span class="main">→</span> <span class="main">⟨</span>Id<span class="main">⟩</span> nres_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> complement_succ_6_def complement_succ_5_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_vcg</span> vcg2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> expand_map_get_6_refine<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> refine_IdI<span class="main">)</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Phase 7›</span></span>

  <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

  <span class="keyword1"><span class="command">context</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">fi</span> <span class="free">f</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> fi<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fi</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span> <span class="main">∈</span> state_rel"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> list_map_rel_finite fi <span class="keyword1"><span class="command">unfolding</span></span> finite_map_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

    <span class="keyword1"><span class="command">schematic_goal</span></span> refresh_7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">::</span> <span class="tvar">?'a</span><span class="main">,</span> refresh_5 <span class="free">f</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> refresh_5_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">autoref_monadic</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">plain</span><span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">refresh_7</span> <span class="keyword2"><span class="keyword">uses</span></span> refresh_7

  <span class="keyword1"><span class="command">lemma</span></span> refresh_7_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> RETURN <span class="main">(</span>refresh_7 <span class="bound">f</span><span class="main">)</span><span class="main">,</span> refresh_5<span class="main">)</span> <span class="main">∈</span> state_rel <span class="main">→</span> <span class="main">⟨</span>state_rel<span class="main">⟩</span> nres_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> refresh_7.refine <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

  <span class="keyword1"><span class="command">context</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> nat<span class="main">)</span> nba"</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">succi</span> <span class="free">a</span> <span class="free">fi</span> <span class="free">f</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> succi<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">succi</span><span class="main">,</span> transition <span class="free">A</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> nat_rel <span class="main">→</span> <span class="main">⟨</span>nat_rel<span class="main">⟩</span> list_set_rel"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> fi<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fi</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span> <span class="main">∈</span> state_rel"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>transition <span class="free">A</span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> list_set_rel_finite succi<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> finite_set_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fi <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"transition <span class="free">A</span> <span class="free">a</span> <span class="main">≡</span> <span class="keyword1">OP</span> <span class="main">(</span>transition <span class="free">A</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>min<span class="main">,</span> min<span class="main">)</span> <span class="main">∈</span> nat_rel <span class="main">→</span> nat_rel <span class="main">→</span> nat_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">schematic_goal</span></span> bounds_7<span class="main">:</span> 
      <span class="keyword2"><span class="keyword">notes</span></span> ty_REL<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>nat_rel<span class="main">,</span> item_rel<span class="main">⟩</span> dflt_ahm_rel"</span></span><span class="main">,</span> <span class="operator">autoref_tyrel</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">::</span> <span class="tvar">?'a</span><span class="main">,</span> bounds_5 <span class="free">A</span> <span class="free">a</span> <span class="free">f</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> bounds_5_def merge_5_def sup_bool_def inf_nat_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">autoref_monadic</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">plain</span><span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">bounds_7</span> <span class="keyword2"><span class="keyword">uses</span></span> bounds_7

  <span class="keyword1"><span class="command">lemma</span></span> bounds_7_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">si</span><span class="main">,</span> transition <span class="free">A</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> nat_rel <span class="main">→</span> <span class="main">⟨</span>nat_rel<span class="main">⟩</span> list_set_rel <span class="main">⟹</span>
    <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> RETURN <span class="main">(</span>bounds_7 <span class="free">si</span> <span class="bound">p</span><span class="main">)</span><span class="main">,</span> bounds_5 <span class="free">A</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span>
    state_rel <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span>nat_rel<span class="main">,</span> item_rel<span class="main">⟩</span> dflt_ahm_rel<span class="main">⟩</span> nres_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bounds_7.refine <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">context</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> nat<span class="main">)</span> nba"</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">acci</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">acci</span><span class="main">,</span> accepting <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> nat_rel <span class="main">→</span> bool_rel"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"accepting <span class="free">A</span> <span class="main">≡</span> <span class="keyword1">OP</span> <span class="main">(</span>accepting <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">(dvd)</span><span class="main">,</span> <span class="keyword1">(dvd)</span><span class="main">)</span> <span class="main">∈</span> nat_rel <span class="main">→</span> nat_rel <span class="main">→</span> bool_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">k</span> <span class="bound">l</span><span class="main">.</span> upt <span class="bound">k</span> <span class="main">(</span>Suc <span class="bound">l</span><span class="main">)</span><span class="main">,</span> atLeastAtMost<span class="main">)</span> <span class="main">∈</span>
      nat_rel <span class="main">→</span> nat_rel <span class="main">→</span> <span class="main">⟨</span>nat_rel<span class="main">⟩</span> list_set_rel"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_set_rel_def in_br_conv<span class="main">)</span>

    <span class="keyword1"><span class="command">schematic_goal</span></span> items_7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">::</span> <span class="tvar">?'a</span><span class="main">,</span> items_5 <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> items_5_def Let_def Set.filter_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">autoref</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">items_7</span> <span class="keyword2"><span class="keyword">uses</span></span> items_7

  <span class="comment1">(* TODO: use generic expand_map implementation *)</span>
  <span class="keyword1"><span class="command">context</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> nat<span class="main">)</span> nba"</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ai</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">fi</span> <span class="free">f</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> ai<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ai</span><span class="main">,</span> accepting <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> nat_rel <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> fi<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fi</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>nat_rel<span class="main">,</span> item_rel<span class="main">⟩</span> dflt_ahm_rel"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dflt_ahm_rel_finite_nat fi <span class="keyword1"><span class="command">unfolding</span></span> finite_map_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> dom <span class="bound">m</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> dom_def inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> fun_upd_triv fun_upd_upd<span class="main">)</span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> op_map_update_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>

    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"items_5 <span class="free">A</span> <span class="main">≡</span> <span class="keyword1">OP</span> <span class="main">(</span>items_5 <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> items_7.refine<span class="main">[</span><span class="operator">OF</span> ai<span class="main">]</span>

    <span class="keyword1"><span class="command">schematic_goal</span></span> expand_map_get_7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span><span class="main">,</span> expand_map_get_6 <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="main">∈</span>
      <span class="main">⟨</span><span class="main">⟨</span>state_rel<span class="main">⟩</span> list_set_rel<span class="main">⟩</span> nres_rel"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> expand_map_get_6_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">autoref_monadic</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">plain</span><span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">expand_map_get_7</span> <span class="keyword2"><span class="keyword">uses</span></span> expand_map_get_7

  <span class="keyword1"><span class="command">lemma</span></span> expand_map_get_7_refine<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ai</span><span class="main">,</span> accepting <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> nat_rel <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">fi</span><span class="main">.</span> RETURN <span class="main">(</span>expand_map_get_7 <span class="free">ai</span> <span class="bound">fi</span><span class="main">)</span><span class="main">,</span>
      <span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> ASSUME <span class="main">(</span>finite <span class="main">(</span>dom <span class="bound">f</span><span class="main">)</span><span class="main">)</span> <span class="main">⪢</span> expand_map_get_6 <span class="free">A</span> <span class="bound">f</span><span class="main">)</span> <span class="main">∈</span>
      <span class="main">⟨</span>nat_rel<span class="main">,</span> item_rel<span class="main">⟩</span> dflt_ahm_rel <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span>state_rel<span class="main">⟩</span> list_set_rel<span class="main">⟩</span> nres_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> expand_map_get_7.refine<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">context</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> nat<span class="main">)</span> nba"</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span>"</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat items"</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Ai</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ai</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">pi</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> Ai<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> nbai_nba_rel"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> ai<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ai</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> Id"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> pi<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">pi</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> state_rel"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemmas</span></span> succi <span class="main">=</span> nbai_nba_param<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> fun_relD<span class="main">,</span> <span class="operator">OF</span> Ai<span class="main">,</span> <span class="operator">THEN</span> fun_relD<span class="main">,</span> <span class="operator">OF</span> ai<span class="main">]</span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemmas</span></span> acceptingi <span class="main">=</span> nbai_nba_param<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> fun_relD<span class="main">,</span> <span class="operator">OF</span> Ai<span class="main">]</span>

    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">g</span><span class="main">.</span> ASSUME <span class="main">(</span>finite <span class="main">(</span>dom <span class="bound">g</span><span class="main">)</span><span class="main">)</span> <span class="main">⪢</span> expand_map_get_6 <span class="free">A</span> <span class="bound">g</span><span class="main">)</span> <span class="main">≡</span>
      <span class="keyword1">OP</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">g</span><span class="main">.</span> ASSUME <span class="main">(</span>finite <span class="main">(</span>dom <span class="bound">g</span><span class="main">)</span><span class="main">)</span> <span class="main">⪢</span> expand_map_get_6 <span class="free">A</span> <span class="bound">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bounds_5 <span class="free">A</span> <span class="free">a</span> <span class="main">≡</span> <span class="keyword1">OP</span> <span class="main">(</span>bounds_5 <span class="free">A</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span>
      refresh_7_refine
      bounds_7_refine<span class="main">[</span><span class="operator">OF</span> succi<span class="main">]</span>
      expand_map_get_7_refine<span class="main">[</span><span class="operator">OF</span> acceptingi<span class="main">]</span>

    <span class="keyword1"><span class="command">schematic_goal</span></span> complement_succ_7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">::</span> <span class="tvar">?'a</span><span class="main">,</span> complement_succ_6 <span class="free">A</span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> complement_succ_6_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">autoref_monadic</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">plain</span><span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">complement_succ_7</span> <span class="keyword2"><span class="keyword">uses</span></span> complement_succ_7

  <span class="keyword1"><span class="command">lemma</span></span> complement_succ_7_refine<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>RETURN <span class="main">∘∘∘</span> complement_succ_7<span class="main">,</span> complement_succ_6<span class="main">)</span> <span class="main">∈</span>
      <span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> nbai_nba_rel <span class="main">→</span> Id <span class="main">→</span> state_rel <span class="main">→</span>
      <span class="main">⟨</span><span class="main">⟨</span>state_rel<span class="main">⟩</span> list_set_rel<span class="main">⟩</span> nres_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> complement_succ_7.refine <span class="keyword1"><span class="command">unfolding</span></span> comp_apply <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

  <span class="keyword1"><span class="command">context</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> nat<span class="main">)</span> nba"</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Ai</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="free">ni</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> Ai<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> nbai_nba_rel"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> ni<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ni</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> Id"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"initial <span class="free">A</span> <span class="main">≡</span> <span class="keyword1">OP</span> <span class="main">(</span>initial <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> nbai_nba_param<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> fun_relD<span class="main">,</span> <span class="operator">OF</span> Ai<span class="main">]</span>

    <span class="keyword1"><span class="command">schematic_goal</span></span> complement_initial_7<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span>Some <span class="main">∘</span> <span class="main">(</span>const <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">,</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`</span> initial <span class="free">A</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>state_rel<span class="main">⟩</span> list_set_rel"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">autoref</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">complement_initial_7</span> <span class="keyword2"><span class="keyword">uses</span></span> complement_initial_7

  <span class="keyword1"><span class="command">schematic_goal</span></span> complement_accepting_7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span><span class="main">,</span> <span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> <span class="main">∀</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> map_to_set <span class="bound">f</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∈</span>
    state_rel <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">autoref</span>

  <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">complement_accepting_7</span> <span class="keyword2"><span class="keyword">uses</span></span> complement_accepting_7

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">complement_7</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> nat<span class="main">)</span> nbai <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> state<span class="main">)</span> nbai"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">complement_7</span> <span class="free"><span class="bound"><span class="entity">Ai</span></span></span> <span class="free"><span class="bound"><span class="entity">ni</span></span></span> <span class="main">≡</span> nbai
      <span class="main">(</span>alphabeti <span class="free"><span class="bound"><span class="entity">Ai</span></span></span><span class="main">)</span>
      <span class="main">(</span>complement_initial_7 <span class="free"><span class="bound"><span class="entity">Ai</span></span></span> <span class="free"><span class="bound"><span class="entity">ni</span></span></span><span class="main">)</span>
      <span class="main">(</span>complement_succ_7 <span class="free"><span class="bound"><span class="entity">Ai</span></span></span><span class="main">)</span>
      <span class="main">(</span>complement_accepting_7<span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> complement_7_refine<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> nbai_nba_rel"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ni</span><span class="main">,</span>
      <span class="main">(</span><span class="keyword1">OP</span> card <span class="main">:::</span> <span class="main">⟨</span>Id<span class="main">⟩</span> ahs_rel <span class="free">bhc</span> <span class="main">→</span> nat_rel<span class="main">)</span> <span class="main">$</span>
      <span class="main">(</span><span class="main">(</span><span class="keyword1">OP</span> nodes <span class="main">:::</span> <span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> nbai_nba_rel <span class="main">→</span> <span class="main">⟨</span>Id<span class="main">⟩</span> ahs_rel <span class="free">bhc</span><span class="main">)</span> <span class="main">$</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> nat_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>complement_7 <span class="free">Ai</span> <span class="free">ni</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">OP</span> complement_4 <span class="main">:::</span>
      <span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> nbai_nba_rel <span class="main">→</span> <span class="main">⟨</span>Id<span class="main">,</span> state_rel<span class="main">⟩</span> nbai_nba_rel<span class="main">)</span> <span class="main">$</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> state_rel<span class="main">⟩</span> nbai_nba_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> complement_succ_7_refine
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> complement_succ_6_refine
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> complement_succ_5_refine
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>complement_succ_7<span class="main">,</span> complement_succ_4<span class="main">)</span> <span class="main">∈</span>
      <span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> nbai_nba_rel <span class="main">→</span> Id <span class="main">→</span> state_rel <span class="main">→</span> <span class="main">⟨</span>state_rel<span class="main">⟩</span> list_set_rel"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> nres_rel_comp <span class="keyword1"><span class="command">unfolding</span></span> nres_rel_def <span class="keyword1"><span class="command">unfolding</span></span> fun_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> complement_7_def complement_4_def
      <span class="keyword1"><span class="command">using</span></span> 1 complement_initial_7.refine complement_accepting_7.refine assms
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Formula">
<div class="head">
<h1>Theory Formula</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Boolean Formulae›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Formula
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> formula <span class="main">=</span>
    False <span class="main">|</span>
    True <span class="main">|</span>
    Variable <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span>
    Negation <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula"</span></span> <span class="main">|</span>
    Conjunction <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula"</span></span> <span class="main">|</span>
    Disjunction <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula"</span></span>

  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">satisfies</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> formula <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> False <span class="main">⟷</span> HOL.False"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> True <span class="main">⟷</span> HOL.True"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>Variable <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>Negation <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">¬</span> <span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>Conjunction <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>Disjunction <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∨</span> <span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Complementation_Final">
<div class="head">
<h1>Theory Complementation_Final</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Final Instantiation of Algorithms Related to Complementation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Complementation_Final
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Complementation_Implement.html">Complementation_Implement</a>"</span>
  <span class="quoted">"<a href="Formula.html">Formula</a>"</span>
  <span class="quoted">"<a href="../Transition_Systems_and_Automata/NBA_Translate.html">Transition_Systems_and_Automata.NBA_Translate</a>"</span>
  <span class="quoted">"<a href="../Transition_Systems_and_Automata/NGBA_Algorithms.html">Transition_Systems_and_Automata.NGBA_Algorithms</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Permutation.html">HOL-Library.Permutation</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntax›</span></span>

  <span class="comment1">(* TODO: this syntax has unnecessarily high inner binding strength, requiring extra parentheses
    the regular let syntax correctly uses inner binding strength 0: ("(2_ =/ _)" 10) *)</span>
  <span class="keyword1"><span class="command">no_syntax</span></span> <span class="quoted">"_do_let"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrn<span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">⇒</span> do_bind"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span><span class="keyword1">let</span> _ <span class="keyword1">=</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>1000<span class="main">,</span> 13<span class="main">]</span> 13<span class="main">)</span>
  <span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_do_let"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrn<span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">⇒</span> do_bind"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span><span class="keyword1">let</span> _ <span class="keyword1">=</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> 13<span class="main">)</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Hashcodes on Complement States›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">hci</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> uint32_of_nat <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">*</span> <span class="numeral">1103515245</span> <span class="main">+</span> <span class="numeral">12345</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">hc</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> hci <span class="bound">p</span> <span class="main">+</span> hci <span class="bound">q</span> <span class="main">*</span> <span class="numeral">31</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">list_hash</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> fold <span class="main">(</span><span class="keyword1">(XOR)</span> <span class="main">∘</span> hc<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">0</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> list_hash_eq<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> set <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_hash <span class="free">xs</span> <span class="main">=</span> list_hash <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"remdups <span class="free">xs</span> <span class="main">&lt;~~&gt;</span> remdups <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_set_perm_remdups assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">&lt;~~&gt;</span> <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_remdups_id<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="keyword1">(XOR)</span> <span class="main">∘</span> hc<span class="main">)</span> <span class="free">xs</span> <span class="skolem">a</span> <span class="main">=</span> fold <span class="main">(</span><span class="keyword1">(XOR)</span> <span class="main">∘</span> hc<span class="main">)</span> <span class="free">ys</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>swap <span class="skolem">y</span> <span class="skolem">x</span> <span class="skolem">l</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">XOR</span> <span class="skolem">y</span> <span class="keyword1">XOR</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">y</span> <span class="keyword1">XOR</span> <span class="skolem">x</span> <span class="keyword1">XOR</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> word_bw_lcs<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> list_hash_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">state_hash</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> Complementation_Implement.state <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">state_hash</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> nat_of_hashcode <span class="main">(</span>list_hash <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> state_hash_bounded_hashcode<span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_bounded_hashcode state_rel
    <span class="main">(</span>gen_equals <span class="main">(</span>Gen_Map.gen_ball <span class="main">(</span>foldli <span class="main">∘</span> list_map_to_list<span class="main">)</span><span class="main">)</span> <span class="main">(</span>list_map_lookup <span class="main">(=)</span><span class="main">)</span>
    <span class="main">(</span>prod_eq <span class="main">(=)</span> <span class="main">(⟷)</span><span class="main">)</span><span class="main">)</span> state_hash"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gen_equals <span class="main">(</span>Gen_Map.gen_ball <span class="main">(</span>foldli <span class="main">∘</span> list_map_to_list<span class="main">)</span><span class="main">)</span> <span class="main">(</span>list_map_lookup <span class="main">(=)</span><span class="main">)</span>
      <span class="main">(</span>prod_eq <span class="main">(=)</span> <span class="main">(⟷)</span><span class="main">)</span><span class="main">,</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">∈</span> state_rel <span class="main">→</span> state_rel <span class="main">→</span> bool_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">autoref</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"state_hash <span class="skolem">n</span> <span class="skolem">xs</span> <span class="main">=</span> state_hash <span class="skolem">n</span> <span class="skolem">ys</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> Domain state_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> Domain state_rel"</span></span>
      <span class="quoted"><span class="quoted">"gen_equals <span class="main">(</span>Gen_Map.gen_ball <span class="main">(</span>foldli <span class="main">∘</span> list_map_to_list<span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>list_map_lookup <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span>prod_eq <span class="main">(=)</span> <span class="main">(=)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> list_map_rel_def list_map_invar_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> distinct_mapI<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> map_of <span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> state_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ys</span><span class="main">,</span> map_of <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> state_rel"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> list_map_rel_def list_map_invar_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gen_equals <span class="main">(</span>Gen_Map.gen_ball <span class="main">(</span>foldli <span class="main">∘</span> list_map_to_list<span class="main">)</span><span class="main">)</span> <span class="main">(</span>list_map_lookup <span class="main">(=)</span><span class="main">)</span>
        <span class="main">(</span>prod_eq <span class="main">(=)</span> <span class="main">(⟷)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">,</span> map_of <span class="skolem">xs</span> <span class="main">=</span> map_of <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> bool_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"map_to_set <span class="main">(</span>map_of <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> map_to_set <span class="main">(</span>map_of <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>3<span class="main">)</span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> set <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> map_to_set_map_of 1 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"state_hash <span class="skolem">n</span> <span class="skolem">xs</span> <span class="main">=</span> state_hash <span class="skolem">n</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> state_hash_def <span class="keyword1"><span class="command">using</span></span> list_hash_eq 2 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"state_hash <span class="skolem">n</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> state_hash_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Complementation›</span></span>

  <span class="keyword1"><span class="command">schematic_goal</span></span> complement_impl<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>NBA.nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> nat_rel<span class="main">⟩</span> nbai_nba_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">::</span> <span class="tvar">?'c</span><span class="main">,</span> op_translate <span class="main">(</span>complement_4 <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">autoref_monadic</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">plain</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">complement_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> complement_impl

  <span class="keyword1"><span class="command">theorem</span></span> complement_impl_correct<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>NBA.nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> nat_rel<span class="main">⟩</span> nbai_nba_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"NBA.language <span class="main">(</span>nbae_nba <span class="main">(</span>nbaei_nbae <span class="main">(</span>complement_impl <span class="free">Ai</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      streams <span class="main">(</span>nba.alphabet <span class="free">A</span><span class="main">)</span> <span class="main">-</span> NBA.language <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> op_translate_language<span class="main">[</span><span class="operator">OF</span> complement_impl.refine<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> complement_4_correct<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Language Subset›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">op_language_subset</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> NBA.language <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊆</span> NBA.language <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span> <span class="main">=</span> op_language_subset_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

  <span class="keyword1"><span class="command">schematic_goal</span></span> language_subset_impl<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>NBA.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> nat_rel<span class="main">⟩</span> nbai_nba_rel"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Bi</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> nat_rel<span class="main">⟩</span> nbai_nba_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">::</span> <span class="tvar">?'c</span><span class="main">,</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="keyword1">let</span> <span class="bound">AB'</span> <span class="main">=</span> intersect' <span class="free">A</span> <span class="main">(</span>complement_4 <span class="free">B</span><span class="main">)</span><span class="main">;</span>
      ASSERT <span class="main">(</span>finite <span class="main">(</span>NGBA.nodes <span class="bound">AB'</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      RETURN <span class="main">(</span>NGBA.language <span class="bound">AB'</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>
    <span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
		<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">autoref_monadic</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">plain</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">language_subset_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> language_subset_impl
  <span class="keyword1"><span class="command">lemma</span></span> language_subset_impl_refine<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span>finite <span class="main">(</span>NBA.nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span>finite <span class="main">(</span>NBA.nodes <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span>nba.alphabet <span class="free">A</span> <span class="main">⊆</span> nba.alphabet <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> nat_rel<span class="main">⟩</span> nbai_nba_rel"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Bi</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> nat_rel<span class="main">⟩</span> nbai_nba_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>language_subset_impl <span class="free">Ai</span> <span class="free">Bi</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">OP</span> op_language_subset <span class="main">:::</span>
      <span class="main">⟨</span>Id<span class="main">,</span> nat_rel<span class="main">⟩</span> nbai_nba_rel <span class="main">→</span> <span class="main">⟨</span>Id<span class="main">,</span> nat_rel<span class="main">⟩</span> nbai_nba_rel <span class="main">→</span> bool_rel<span class="main">)</span> <span class="main">$</span> <span class="free">A</span> <span class="main">$</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> bool_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RETURN <span class="main">(</span>language_subset_impl <span class="free">Ai</span> <span class="free">Bi</span><span class="main">)</span><span class="main">,</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="keyword1">let</span> <span class="bound">AB'</span> <span class="main">=</span> intersect' <span class="free">A</span> <span class="main">(</span>complement_4 <span class="free">B</span><span class="main">)</span><span class="main">;</span>
      ASSERT <span class="main">(</span>finite <span class="main">(</span>NGBA.nodes <span class="bound">AB'</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      RETURN <span class="main">(</span>NGBA.language <span class="bound">AB'</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>
    <span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>bool_rel<span class="main">⟩</span> nres_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> language_subset_impl.refine assms<span class="main">(</span>2<span class="main">,</span> 4<span class="main">,</span> 5<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
      <span class="keyword1">let</span> <span class="bound">AB'</span> <span class="main">=</span> intersect' <span class="free">A</span> <span class="main">(</span>complement_4 <span class="free">B</span><span class="main">)</span><span class="main">;</span>
      ASSERT <span class="main">(</span>finite <span class="main">(</span>NGBA.nodes <span class="bound">AB'</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      RETURN <span class="main">(</span>NGBA.language <span class="bound">AB'</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>
    <span class="main">}</span><span class="main">,</span> RETURN <span class="main">(</span>NBA.language <span class="free">A</span> <span class="main">⊆</span> NBA.language <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>bool_rel<span class="main">⟩</span> nres_rel"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">refine_vcg</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>NGBA.nodes <span class="main">(</span>intersect' <span class="free">A</span> <span class="main">(</span>complement_4 <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"NBA.language <span class="free">A</span> <span class="main">⊆</span> streams <span class="main">(</span>nba.alphabet <span class="free">B</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nba.language_alphabet streams_mono2 assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"NBA.language <span class="main">(</span>complement_4 <span class="free">B</span><span class="main">)</span> <span class="main">=</span> streams <span class="main">(</span>nba.alphabet <span class="free">B</span><span class="main">)</span> <span class="main">-</span> NBA.language <span class="free">B</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> complement_4_correct assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>NGBA.language <span class="main">(</span>intersect' <span class="free">A</span> <span class="main">(</span>complement_4 <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
        NBA.language <span class="free">A</span> <span class="main">⊆</span> NBA.language <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> bool_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RETURN_nres_relD <span class="keyword1"><span class="command">unfolding</span></span> nres_rel_comp <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Language Equality›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">op_language_equal</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> NBA.language <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> NBA.language <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span> <span class="main">=</span> op_language_equal_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

  <span class="keyword1"><span class="command">schematic_goal</span></span> language_equal_impl<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>NBA.nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>NBA.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nba.alphabet <span class="free">A</span> <span class="main">=</span> nba.alphabet <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> nat_rel<span class="main">⟩</span> nbai_nba_rel"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Bi</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> nat_rel<span class="main">⟩</span> nbai_nba_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">::</span> <span class="tvar">?'c</span><span class="main">,</span> NBA.language <span class="free">A</span> <span class="main">⊆</span> NBA.language <span class="free">B</span> <span class="main">∧</span> NBA.language <span class="free">B</span> <span class="main">⊆</span> NBA.language <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">autoref</span>
  <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">language_equal_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> language_equal_impl
  <span class="keyword1"><span class="command">lemma</span></span> language_equal_impl_refine<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span>finite <span class="main">(</span>NBA.nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span>finite <span class="main">(</span>NBA.nodes <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span>nba.alphabet <span class="free">A</span> <span class="main">=</span> nba.alphabet <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> nat_rel<span class="main">⟩</span> nbai_nba_rel"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Bi</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> nat_rel<span class="main">⟩</span> nbai_nba_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>language_equal_impl <span class="free">Ai</span> <span class="free">Bi</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">OP</span> op_language_equal <span class="main">:::</span>
      <span class="main">⟨</span>Id<span class="main">,</span> nat_rel<span class="main">⟩</span> nbai_nba_rel <span class="main">→</span> <span class="main">⟨</span>Id<span class="main">,</span> nat_rel<span class="main">⟩</span> nbai_nba_rel <span class="main">→</span> bool_rel<span class="main">)</span> <span class="main">$</span> <span class="free">A</span> <span class="main">$</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> bool_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> language_equal_impl.refine<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">schematic_goal</span></span> product_impl<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>NBA.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> nat_rel<span class="main">⟩</span> nbai_nba_rel"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Bi</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> nat_rel<span class="main">⟩</span> nbai_nba_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">::</span> <span class="tvar">?'c</span><span class="main">,</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="keyword1">let</span> <span class="bound">AB'</span> <span class="main">=</span> intersect <span class="free">A</span> <span class="main">(</span>complement_4 <span class="free">B</span><span class="main">)</span><span class="main">;</span>
      ASSERT <span class="main">(</span>finite <span class="main">(</span>NBA.nodes <span class="bound">AB'</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      op_translate <span class="bound">AB'</span>
    <span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
		<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">autoref_monadic</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">plain</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">product_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> product_impl

  <span class="comment1">(* TODO: possible optimizations:
    - introduce op_map_map operation for maps instead of manually iterating via FOREACH
    - consolidate various binds and maps in expand_map_get_7 *)</span>
  <span class="keyword1"><span class="command">export_code</span></span>
    <span class="quoted"><span class="quoted">Set.empty</span></span> <span class="quoted"><span class="quoted">Set.insert</span></span> <span class="quoted"><span class="quoted">Set.member</span></span>
    <span class="quoted"><span class="quoted"><span class="quoted">"Inf <span class="main">::</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Sup <span class="main">::</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span></span> <span class="quoted"><span class="quoted">image</span></span> <span class="quoted"><span class="quoted">Pow</span></span> <span class="quoted"><span class="quoted">set</span></span>
    <span class="quoted"><span class="quoted">nat_of_integer</span></span> <span class="quoted"><span class="quoted">integer_of_nat</span></span>
    <span class="quoted"><span class="quoted">Variable</span></span> <span class="quoted"><span class="quoted">Negation</span></span> <span class="quoted"><span class="quoted">Conjunction</span></span> <span class="quoted"><span class="quoted">Disjunction</span></span> <span class="quoted"><span class="quoted">satisfies</span></span> <span class="quoted"><span class="quoted">map_formula</span></span>
    <span class="quoted"><span class="quoted">nbaei</span></span> <span class="quoted"><span class="quoted">alphabetei</span></span> <span class="quoted"><span class="quoted">initialei</span></span> <span class="quoted"><span class="quoted">transitionei</span></span> <span class="quoted"><span class="quoted">acceptingei</span></span>
    <span class="quoted"><span class="quoted">nbae_nba_impl</span></span> <span class="quoted"><span class="quoted">complement_impl</span></span> <span class="quoted"><span class="quoted">language_equal_impl</span></span> <span class="quoted"><span class="quoted">product_impl</span></span>
    <span class="keyword2"><span class="keyword">in</span></span> SML <span class="keyword2"><span class="keyword">module_name</span></span> Complementation <span class="keyword2"><span class="keyword">file_prefix</span></span> Complementation

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Complementation_Build">
<div class="head">
<h1>Theory Complementation_Build</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Build and test exported program with MLton›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Complementation_Build
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Complementation_Final.html">Complementation_Final</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">external_file</span></span> <span class="quoted">‹code/Autool.mlb›</span>
<span class="keyword1"><span class="command">external_file</span></span> <span class="quoted">‹code/Prelude.sml›</span>
<span class="keyword1"><span class="command">external_file</span></span> <span class="quoted">‹code/Autool.sml›</span>

<span class="keyword1"><span class="command">compile_generated_files</span></span> <span class="comment1">✐<span class="quoted">‹contributor Makarius›</span></span>
  <span class="quoted"><span class="entity">‹code/Complementation.ML›</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> <a href="Complementation_Final.html">Complementation_Final</a><span class="main">)</span>
  <span class="keyword2"><span class="keyword">external_files</span></span>
    <span class="quoted">‹code/Autool.mlb›</span>
    <span class="quoted">‹code/Prelude.sml›</span>
    <span class="quoted">‹code/Autool.sml›</span>
  <span class="keyword2"><span class="keyword">export_files</span></span> <span class="quoted">‹code/Complementation.sml›</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">‹code/Autool›</span> <span class="main">(</span>exe<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted">‹<span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">dir</span> <span class="main">=&gt;</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">exec</span> <span class="main">=</span> <span class="entity">Generated_Files.execute</span> <span class="main">(</span><span class="entity">dir</span> + Path.basic <span class="inner_quoted">"code"</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">exec</span> <span class="antiquoted"><span class="entity"><span class="operator">‹</span>Prepare›</span></span> <span class="inner_quoted">"mv Complementation.ML Complementation.sml"</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">exec</span> <span class="antiquoted"><span class="entity"><span class="operator">‹</span>Compilation›</span></span> <span class="main">(</span>File.bash_path <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">path</span><span class="hidden">&gt;</span></span>‹$ISABELLE_MLTON›</span></span> ^
            <span class="inner_quoted">" -profile time -default-type intinf Autool.mlb"</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">exec</span> <span class="antiquoted"><span class="entity"><span class="operator">‹</span>Test›</span></span> <span class="inner_quoted">"./Autool help"</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>›</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="files/code/Autool.mlb">
<div class="head">
<h1>File ‹code/Autool.mlb›</h1>
</div>
<pre class="source">$(SML_LIB)/basis/basis.mlb
Prelude.sml
ann
	"nonexhaustiveBind ignore"
	"nonexhaustiveMatch ignore"
	"redundantBind ignore"
	"redundantMatch ignore"
in
	Complementation.sml
end
Autool.sml
</pre>
</div><div id="files/code/Prelude.sml">
<div class="head">
<h1>File ‹code/Prelude.sml›</h1>
</div>
<pre class="source">structure Unsynchronized =
struct

datatype ref = datatype ref;

end;

fun tracing msg = TextIO.output (TextIO.stdErr, msg ^ "\n");
</pre>
</div><div id="files/code/Autool.sml">
<div class="head">
<h1>File ‹code/Autool.sml›</h1>
</div>
<pre class="source">open Complementation
open String
open List

fun eq x y = (x = y)

fun println w = print (w ^ "\n")

fun return x = [x]
fun bind xs f = concat (map f xs)
fun foldl' y f [] = y
  | foldl' y f (x :: xs) = foldl f x xs
fun takeWhile P [] = []
  | takeWhile P (x :: xs) = if P x then x :: takeWhile P xs else []
fun lookup x [] = NONE |
    lookup x ((k, v) :: xs) = if x = k then SOME v else lookup x xs
fun upto k = if k = 0 then [] else (k - 1) :: upto (k - 1)

fun splitFirst u w =
	if w = ""
	then if u = "" then SOME ("", "") else NONE
	else
		if isPrefix u w
		then SOME ("", extract (w, size u, NONE))
		else case splitFirst u (extract (w, 1, NONE)) of
			NONE =&gt; NONE |
			SOME (v, w') =&gt; SOME (str (sub (w, 0)) ^ v, w')
fun split u w = case splitFirst u w of NONE =&gt; [w] | SOME (v, w') =&gt; v :: split u w'

fun showInt k = Int.toString k
fun parseInt w = case Int.fromString w of SOME n =&gt; n

fun showNat k = showInt (integer_of_nat k)
fun parseNat w = nat_of_integer (parseInt w)

fun showString w = "\"" ^ w ^ "\""
fun parseString w = substring (w, 1, size w - 2)

fun showTuple f g (x, y) = "(" ^ f x ^ ", " ^ g y ^ ")"
fun showSequence f xs = concatWith ", " (map f xs)
fun showList f xs = "[" ^ showSequence f xs ^ "]"
fun showSet f (Set xs) = "{" ^ showSequence f xs ^ "}"
  | showSet f (Coset xs) = "- {" ^ showSequence f xs ^ "}"

fun showFormula f False = "f"
  | showFormula f True = "t"
  | showFormula f (Variable v) = f v
  | showFormula f (Negation x) = "!" ^ showFormula f x
  | showFormula f (Conjunction (x, y)) = "(" ^ showFormula f x ^ " &amp; " ^ showFormula f y ^ ")"
  | showFormula f (Disjunction (x, y)) = "(" ^ showFormula f x ^ " | " ^ showFormula f y ^ ")"
fun parseFormula parseVariable input = let
  fun parseConstant w cs = if isPrefix w (implode cs) then [(w, drop (cs, size w))] else []
  fun parseAtom input1 =
    bind (parseConstant "f" input1) (fn (_, input2) =&gt;
    return (False, input2))
    @
    bind (parseConstant "t" input1) (fn (_, input2) =&gt;
    return (True, input2))
    @
    bind (parseVariable input1) (fn (variable, input2) =&gt;
    return (Variable variable, input2))
    @
    bind (parseConstant "(" input1) (fn (_, input2) =&gt;
    bind (parseDisjunction input2) (fn (disjunction, input3) =&gt;
    bind (parseConstant ")" input3) (fn (_, input4) =&gt;
    return (disjunction, input4))))
  and parseLiteral input1 =
    bind (parseAtom input1) (fn (atom, input2) =&gt;
    return (atom, input2))
    @
    bind (parseConstant "!" input1) (fn (_, input2) =&gt;
    bind (parseAtom input2) (fn (atom, input3) =&gt;
    return (Negation atom, input3)))
  and parseConjunction input1 =
    bind (parseLiteral input1) (fn (literal, input2) =&gt;
    return (literal, input2))
    @
    bind (parseLiteral input1) (fn (literal, input2) =&gt;
    bind (parseConstant "&amp;" input2) (fn (_, input3) =&gt;
    bind (parseConjunction input3) (fn (conjunction, input4) =&gt;
    return (Conjunction (literal, conjunction), input4))))
  and parseDisjunction input1 =
    bind (parseConjunction input1) (fn (conjunction, input2) =&gt;
    return (conjunction, input2))
    @
    bind (parseConjunction input1) (fn (conjunction, input2) =&gt;
    bind (parseConstant "|" input2) (fn (_, input3) =&gt;
    bind (parseDisjunction input3) (fn (disjunction, input4) =&gt;
    return (Disjunction (conjunction, disjunction), input4))))
  val input' = filter (not o Char.isSpace) (explode input)
  val result = map (fn (exp, _) =&gt; exp) (filter (fn (exp, rest) =&gt; null rest) (parseDisjunction input'))
  in hd result end

datatype hoaProperty =
  HoaVersion of string |
  HoaName of string |
  HoaProperties of string list |
  HoaAtomicPropositions of nat * string list |
  HoaAcceptanceConditionName of string |
  HoaAcceptanceCondition of string |
  HoaStartState of nat |
  HoaStateCount of nat |
  HoaProperty of string * string
datatype hoaTransition = HoaTransition of nat formula * nat
datatype hoaState = HoaState of nat * nat list * hoaTransition list
datatype hoaAutomaton = HoaAutomaton of hoaProperty list * hoaState list

fun showHoaAutomaton (HoaAutomaton (ps, ss)) = let
  fun showProperty (HoaVersion w) = "HOA: " ^ w ^ "\n"
    | showProperty (HoaName w) = "name: " ^ showString w ^ "\n"
    | showProperty (HoaProperties ws) = "properties: " ^ concatWith " " ws ^ "\n"
    | showProperty (HoaAtomicPropositions (n, ps)) = "AP: " ^ showNat n ^ " " ^ concatWith " " (map showString ps) ^ "\n"
    | showProperty (HoaAcceptanceConditionName w) = "acc-name: " ^ w ^ "\n"
    | showProperty (HoaAcceptanceCondition w) = "Acceptance: " ^ w ^ "\n"
    | showProperty (HoaStartState p) = "Start: " ^ showNat p ^ "\n"
    | showProperty (HoaStateCount n) = "States: " ^ showNat n ^ "\n"
    | showProperty (HoaProperty (name, value)) = name ^ ": " ^ value ^ "\n"
  fun showTransition (HoaTransition (a, q)) = "[" ^ showFormula showNat a ^ "]" ^ " " ^ showNat q ^ "\n"
  fun showState (HoaState (p, cs, ts)) = "State: " ^ showNat p ^ " " ^ showSet showNat (Set cs) ^ "\n" ^ String.concat (map showTransition ts)
  in String.concat (map showProperty ps) ^ "--BODY--" ^ "\n" ^ String.concat (map showState ss) ^ "--END--" ^ "\n" end
fun parseHoaAutomaton path = let
  fun parseVariable cs = case takeWhile Char.isDigit cs of
    [] =&gt; [] | xs =&gt; [(parseNat (implode xs), drop (cs, length xs))]
	fun inputLine input = case TextIO.inputLine input of SOME w =&gt; substring (w, 0, size w - 1)
	fun parseProperty w = case split ": " w of
	  ["HOA", u] =&gt; HoaVersion u |
	  ["name", u] =&gt; HoaName (substring (u, 1, size u - 2)) |
	  ["properties", u] =&gt; HoaProperties (split " " u) |
	  ["AP", u] =&gt; (case split " " u of v :: vs =&gt; HoaAtomicPropositions (parseNat v, map parseString vs)) |
	  ["acc-name", u] =&gt; HoaAcceptanceConditionName u |
	  ["Acceptance", u] =&gt; HoaAcceptanceCondition u |
	  ["Start", u] =&gt; HoaStartState (parseNat u) |
	  ["States", u] =&gt; HoaStateCount (parseNat u) |
	  [name, value] =&gt; HoaProperty (name, value)
	fun parseProperties input = case inputLine input of w =&gt;
	  if w = "--BODY--" then []
	  else parseProperty w :: parseProperties input
	fun parseTransition w = case split "] " (substring (w, 1, size w - 1)) of
	  [u, v] =&gt; HoaTransition (parseFormula parseVariable u, parseNat v)
	fun parseTransitions input = case inputLine input of w =&gt;
	  if isPrefix "State" w orelse w = "--END--" then ([], w)
	  else case parseTransitions input of (ts, w') =&gt; (parseTransition w :: ts, w')
	fun parseStateHeader w = case split " {" w of
	  [u] =&gt; (parseNat u, []) |
	  [u, "}"] =&gt; (parseNat u, []) |
	  [u, v] =&gt; (parseNat u, map parseNat (split ", " (substring (v, 0, size v - 1))))
	fun parseState input w =
	  case split ": " w of ["State", u] =&gt;
	  case parseStateHeader u of (p, cs) =&gt;
	  case parseTransitions input of (ts, w') =&gt;
	  (HoaState (p, cs, ts), w')
	fun parseStates input w =
	  if w = "--END--" then []
	  else case parseState input w of (p, w') =&gt; p :: parseStates input w'
	val input = TextIO.openIn path
	val properties = parseProperties input
	val states = parseStates input (inputLine input)
	in HoaAutomaton (properties, states) before TextIO.closeIn input end

fun toNbaei (HoaAutomaton (properties, states)) = let
  fun atomicPropositions (HoaAtomicPropositions (_, ps) :: properties) = ps
    | atomicPropositions (_ :: properties) = atomicPropositions properties
  val aps = atomicPropositions properties
  val alphabet = case pow {equal = eq} (Set aps) of Set pps =&gt; pps
  fun startStates [] = []
    | startStates (HoaStartState p :: properties) = p :: startStates properties
    | startStates (property :: properties) = startStates properties
  val initial = startStates properties
  fun mapFormula f = map_formula (fn k =&gt; nth (aps, integer_of_nat k)) f
  fun expandTransition p f q = map (fn P =&gt; (p, (P, q))) (filter (fn x =&gt; satisfies {equal = eq} x f) alphabet)
  fun stateTransitions (HoaState (p, cs, ts)) = concat (map (fn HoaTransition (f, q) =&gt; expandTransition p (mapFormula f) q) ts)
  val transitions = concat (map stateTransitions states)
  val accepting = map (fn HoaState (p, cs, ts) =&gt; p) (filter (fn HoaState (p, cs, ts) =&gt; not (null cs)) states)
  in (aps, Nbaei (alphabet, initial, transitions, accepting)) end
fun toHoaAutomaton aps (Nbaei (a, i, t, c)) = let
  val Set nodes = sup_seta {equal = eq}
    (image (fn (p, (_, q)) =&gt; insert {equal = eq} p (insert {equal = eq} q bot_set)) (Set t));
  val properties =
    [HoaVersion "v1"] @
    [HoaProperties ["trans-labels", "explicit-labels", "state-acc"]] @
    [HoaAtomicPropositions (nat_of_integer (length aps), aps)] @
    [HoaAcceptanceConditionName "Buchi"] @
    [HoaAcceptanceCondition "1 Inf(0)"] @
    map HoaStartState i @
    [HoaStateCount (nat_of_integer (length nodes))]
  fun literal ps k = if member {equal = eq} (nth (aps, k)) ps
    then Variable (nat_of_integer k) else Negation (Variable (nat_of_integer k))
  fun formula ps = foldl' True Conjunction (map (literal ps) (upto (length aps)))
  fun transitions p = map (fn (p, (a, q)) =&gt; HoaTransition (formula a, q)) (filter (fn (p', (a, q)) =&gt; p' = p) t)
  fun state p = HoaState (p, if member {equal = eq} p (Set c) then [nat_of_integer 0] else [], transitions p)
  val states = map state nodes
  in HoaAutomaton (properties, states) end

fun showNbaei f g (Nbaei (a, i, t, c)) =
  showList f a ^ "\n" ^
  showList g i ^ "\n" ^
  showList (showTuple g (showTuple f g)) t ^ "\n" ^
  showList g c ^ "\n"
fun write_automaton f path automaton = let
	fun t (p, (a, q)) = Int.toString (integer_of_nat p) ^ " " ^ f a ^ " " ^ Int.toString (integer_of_nat q) ^ "\n"
	val output = TextIO.openOut path
	fun write [] = () | write (x :: xs) = (TextIO.output (output, t x); write xs)
	val _ = write (transitionei automaton)
	val _ = TextIO.closeOut output
	in () end

val parameters = CommandLine.arguments ()
val _ = case hd parameters of
	"help" =&gt; println "Available Commands: help | complement &lt;automaton&gt; | equivalence &lt;automaton1&gt; &lt;automaton2&gt;" |
	"complement" =&gt; let
	  val (aps, nbaei) = toNbaei (parseHoaAutomaton (nth (parameters, 1)))
	  val nbai = nbae_nba_impl eq eq nbaei
	  val complement = toHoaAutomaton aps (complement_impl nbai)
	  in print (showHoaAutomaton complement) end |
	"complement_quick" =&gt; let
	  val (aps, nbaei) = toNbaei (parseHoaAutomaton (nth (parameters, 1)))
	  val nbai = nbae_nba_impl eq eq nbaei
	  val complement = complement_impl nbai
	  in write_automaton (showSet showString) (nth (parameters, 2)) complement end |
	"equivalence" =&gt; let
	  val (aps1, nbaei1) = toNbaei (parseHoaAutomaton (nth (parameters, 1)))
	  val (aps2, nbaei2) = toNbaei (parseHoaAutomaton (nth (parameters, 2)))
	  val nbai1 = nbae_nba_impl eq eq nbaei1
	  val nbai2 = nbae_nba_impl eq eq nbaei2
	  in println (Bool.toString (language_equal_impl {equal = eq} nbai1 nbai2)) end |
	"product" =&gt; let
	  val (aps1, nbaei1) = toNbaei (parseHoaAutomaton (nth (parameters, 1)))
	  val (aps2, nbaei2) = toNbaei (parseHoaAutomaton (nth (parameters, 2)))
	  val nbai1 = nbae_nba_impl eq eq nbaei1
	  val nbai2 = nbae_nba_impl eq eq nbaei2
	  val product = product_impl {equal = eq} nbai1 nbai2
	  in write_automaton (showSet showString) (nth (parameters, 3)) product end |
	"parse" =&gt; let
	  val ha = parseHoaAutomaton (nth (parameters, 1))
	  val (aps, nbaei) = toNbaei ha
	  val _ = println (showNbaei (showSet showString) showNat nbaei)
	  in print (showHoaAutomaton (toHoaAutomaton aps nbaei)) end
</pre>
</div>