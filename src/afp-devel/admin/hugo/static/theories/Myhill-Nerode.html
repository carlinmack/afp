<div id="Folds">
<div class="head">
<h1>Theory Folds</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Xingyuan Zhang, Chunhan Wu, Christian Urban *)</span>
<span class="keyword1"><span class="command">theory</span></span> Folds
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Regular-Sets/Regular_Exp.html">Regular-Sets.Regular_Exp</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹``Summation'' for regular expressions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  To obtain equational system out of finite set of equivalence classes, a fold operation
  on finite sets <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>folds›</span></span></span></span> is defined. The use of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SOME›</span></span></span></span> makes <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>folds›</span></span></span></span>
  more robust than the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fold›</span></span></span></span> in the Isabelle library. The expression <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>folds f›</span></span></span></span>
  makes sense when <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> is not <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>associative›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>commutitive›</span></span></span></span>,
  while <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fold f›</span></span></span></span> does not.  
›</span></span>


<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">folds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">folds</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> fold_graph <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="bound">x</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Plus-combination for a set of regular expressions›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">Setalt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp set <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⨄</span>_"</span> <span class="main">[</span>1000<span class="main">]</span> 999<span class="main">)</span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⨄</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> folds Plus Zero <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  For finite sets, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Setalt</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is preserved under <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">lang</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1" id="Folds-folds_plus_simp"><span class="command">lemma</span></span> folds_plus_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">rs</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span><span class="main">⨄</span><span class="free">rs</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>lang <span class="main">`</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> folds_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> someI2_ex<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> finite_imp_fold_graph<span class="main"><span class="main">[</span></span><span class="operator">OF</span> a<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> fold_graph.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Myhill_1">
<div class="head">
<h1>Theory Myhill_1</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Xingyuan Zhang, Chunhan Wu, Christian Urban *)</span>
<span class="keyword1"><span class="command">theory</span></span> Myhill_1
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Folds.html">Folds</a>
        <span class="quoted">"<a href="../../HOL/HOL-Library/While_Combinator.html">HOL-Library.While_Combinator</a>"</span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹First direction of MN: <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>finite partition ⇒ regular language›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">notation</span></span> 
  conc <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⋅</span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  star <span class="main">(</span><span class="quoted">"_<span class="keyword1">⋆</span>"</span> <span class="main">[</span>101<span class="main">]</span> 102<span class="main">)</span>

<span class="keyword1" id="Myhill_1-Pair_Collect"><span class="command">lemma</span></span> Pair_Collect <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span> <span class="main">⟷</span> <span class="free">P</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Myhill-Nerode relation›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">str_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">≈</span>_"</span> <span class="main">[</span>100<span class="main">]</span> 100<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">≈</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span>  <span class="main">(</span><span class="main">∀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">x</span> <span class="main">@</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟷</span> <span class="bound">y</span> <span class="main">@</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">str_eq_applied</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">≈</span>_ _"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">≈</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="main">≈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1" id="Myhill_1-str_eq_conv_Derivs"><span class="command">lemma</span></span> str_eq_conv_Derivs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"str_eq <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> Derivs <span class="bound">u</span> <span class="free">A</span> <span class="main">=</span> Derivs <span class="bound">v</span> <span class="free">A</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> str_eq_def Derivs_def<span class="main">)</span>  

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">finals</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">finals</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">≈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">``</span> <span class="main">{</span><span class="bound">s</span><span class="main">}</span> <span class="main">|</span> <span class="bound">s</span> <span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Myhill_1-lang_is_union_of_finals"><span class="command">lemma</span></span> lang_is_union_of_finals<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>finals <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> finals_def
<span class="keyword1"><span class="command">unfolding</span></span> Image_def
<span class="keyword1"><span class="command">unfolding</span></span> str_eq_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> append_Nil2<span class="main">)</span>

<span class="keyword1" id="Myhill_1-finals_in_partitions"><span class="command">lemma</span></span> finals_in_partitions<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finals <span class="free">A</span> <span class="main">⊆</span> <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> finals_def quotient_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Equational systems›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The two kinds of terms in the rhs of equations.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> trm <span class="main">=</span> 
   Lam <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp"</span></span>            <span class="comment1">(* Lambda-marker *)</span>
 <span class="main">|</span> Trn <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lang"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp"</span></span>     <span class="comment1">(* Transition *)</span>

<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">lang_trm</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lang_trm</span> <span class="main">(</span>Lam <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> lang <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lang_trm</span> <span class="main">(</span>Trn <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⋅</span> lang <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">lang_rhs</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> trm<span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">lang_rhs</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>lang_trm <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Myhill_1-lang_rhs_set"><span class="command">lemma</span></span> lang_rhs_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang_rhs <span class="main">{</span>Trn <span class="free">X</span> <span class="bound">r</span> <span class="main">|</span> <span class="bound">r</span><span class="main">.</span> <span class="free">P</span> <span class="bound">r</span><span class="main">}</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span>lang_trm <span class="main">(</span>Trn <span class="free">X</span> <span class="bound">r</span><span class="main">)</span> <span class="main">|</span> <span class="bound">r</span><span class="main">.</span> <span class="free">P</span> <span class="bound">r</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Myhill_1-lang_rhs_union_distrib"><span class="command">lemma</span></span> lang_rhs_union_distrib<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang_rhs <span class="free">A</span> <span class="main">∪</span> lang_rhs <span class="free">B</span> <span class="main">=</span> lang_rhs <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Transitions between equivalence classes›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">transition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊨</span>_<span class="keyword1">⇒</span>_"</span> <span class="main">[</span>100<span class="main">,</span>100<span class="main">,</span>100<span class="main">]</span> 100<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main"><span class="free">⊨</span></span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">⋅</span> <span class="main">{</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">]</span><span class="main">}</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Initial equational system›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Init_rhs</span> <span class="free"><span class="bound"><span class="entity">CS</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span>  
      <span class="keyword1">if</span> <span class="main">(</span><span class="main">[]</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="keyword1">then</span> 
          <span class="main">{</span>Lam One<span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>Trn <span class="bound">Y</span> <span class="main">(</span>Atom <span class="bound">c</span><span class="main">)</span> <span class="main">|</span> <span class="bound">Y</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">Y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">CS</span></span></span> <span class="main">∧</span> <span class="bound">Y</span> <span class="main">⊨</span><span class="bound">c</span><span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">}</span>
      <span class="keyword1">else</span> 
          <span class="main">{</span>Trn <span class="bound">Y</span> <span class="main">(</span>Atom <span class="bound">c</span><span class="main">)</span><span class="main">|</span> <span class="bound">Y</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">Y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">CS</span></span></span> <span class="main">∧</span> <span class="bound">Y</span> <span class="main">⊨</span><span class="bound">c</span><span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">Init</span> <span class="free"><span class="bound"><span class="entity">CS</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">X</span><span class="main">,</span> Init_rhs <span class="free"><span class="bound"><span class="entity">CS</span></span></span> <span class="bound">X</span><span class="main">)</span> <span class="main">|</span> <span class="bound">X</span><span class="main">.</span>  <span class="bound">X</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">CS</span></span></span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Arden Operation on equations›</span></span>

<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">Append_rexp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> trm <span class="main">⇒</span> <span class="tfree">'a</span> trm"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Append_rexp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Lam <span class="free"><span class="bound"><span class="entity">rexp</span></span></span><span class="main">)</span>   <span class="main">=</span> Lam <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">rexp</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Append_rexp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Trn <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">rexp</span></span></span><span class="main">)</span> <span class="main">=</span> Trn <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">rexp</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Append_rexp_rhs</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="free"><span class="bound"><span class="entity">rexp</span></span></span> <span class="main">≡</span> <span class="main">(</span>Append_rexp <span class="free"><span class="bound"><span class="entity">rexp</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">Arden</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main">≡</span> 
     Append_rexp_rhs <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main">-</span> <span class="main">{</span>Trn <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="bound">r</span> <span class="main">|</span> <span class="bound">r</span><span class="main">.</span> Trn <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="bound">r</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>Star <span class="main">(</span><span class="main">⨄</span> <span class="main">{</span><span class="bound">r</span><span class="main">.</span> Trn <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="bound">r</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Substitution Operation on equations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">Subst</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">xrhs</span></span></span> <span class="main">≡</span> 
        <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main">-</span> <span class="main">{</span>Trn <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="bound">r</span> <span class="main">|</span> <span class="bound">r</span><span class="main">.</span> Trn <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="bound">r</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>Append_rexp_rhs <span class="free"><span class="bound"><span class="entity">xrhs</span></span></span> <span class="main">(</span><span class="main">⨄</span> <span class="main">{</span><span class="bound">r</span><span class="main">.</span> Trn <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="bound">r</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">Subst_all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> lang <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> trm<span class="main">)</span> set<span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> trm<span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> lang <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> trm<span class="main">)</span> set<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Subst_all</span> <span class="free"><span class="bound"><span class="entity">ES</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">xrhs</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">Y</span><span class="main">,</span> Subst <span class="bound">yrhs</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">xrhs</span></span></span><span class="main">)</span> <span class="main">|</span> <span class="bound">Y</span> <span class="bound">yrhs</span><span class="main">.</span> <span class="main">(</span><span class="bound">Y</span><span class="main">,</span> <span class="bound">yrhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ES</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Remove</span> <span class="free"><span class="bound"><span class="entity">ES</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">xrhs</span></span></span> <span class="main">≡</span> 
      Subst_all  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ES</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xrhs</span></span></span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>Arden <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">xrhs</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹While-combinator and invariants›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">Iter</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">ES</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">Y</span><span class="main">,</span> <span class="bound">yrhs</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">SOME</span> <span class="main">(</span><span class="bound">Y</span><span class="main">,</span> <span class="bound">yrhs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">Y</span><span class="main">,</span> <span class="bound">yrhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ES</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≠</span> <span class="bound">Y</span>
                <span class="keyword1">in</span> Remove <span class="free"><span class="bound"><span class="entity">ES</span></span></span> <span class="bound">Y</span> <span class="bound">yrhs</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Myhill_1-IterI2"><span class="command">lemma</span></span> IterI2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Y</span><span class="main">,</span> <span class="free">yrhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ES</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Y</span> <span class="bound">yrhs</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="bound">Y</span><span class="main">,</span> <span class="bound">yrhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ES</span><span class="main">;</span> <span class="free">X</span> <span class="main">≠</span> <span class="bound">Y</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span>Remove <span class="free">ES</span> <span class="bound">Y</span> <span class="bound">yrhs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span>Iter <span class="free">X</span> <span class="free">ES</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Iter_def <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Y</span><span class="main">,</span> <span class="free">yrhs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> someI2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Cond</span> <span class="free"><span class="bound"><span class="entity">ES</span></span></span> <span class="main">≡</span> card <span class="free"><span class="bound"><span class="entity">ES</span></span></span> <span class="main">≠</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">Solve</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">ES</span></span></span> <span class="main">≡</span> while Cond <span class="main">(</span>Iter <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ES</span></span></span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">distinctness</span> <span class="free"><span class="bound"><span class="entity">ES</span></span></span> <span class="main">≡</span> 
     <span class="main">∀</span> <span class="bound">X</span> <span class="bound">rhs</span> <span class="bound">rhs'</span><span class="main">.</span> <span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ES</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">rhs'</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ES</span></span></span> <span class="main">⟶</span> <span class="bound">rhs</span> <span class="main">=</span> <span class="bound">rhs'</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">soundness</span> <span class="free"><span class="bound"><span class="entity">ES</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ES</span></span></span><span class="main">.</span> <span class="bound">X</span> <span class="main">=</span> lang_rhs <span class="bound">rhs</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">ardenable</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">Y</span> <span class="bound">r</span><span class="main">.</span> Trn <span class="bound">Y</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main">⟶</span> <span class="main">[]</span> <span class="main">∉</span> lang <span class="bound">r</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">ardenable_all</span> <span class="free"><span class="bound"><span class="entity">ES</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ES</span></span></span><span class="main">.</span> ardenable <span class="bound">rhs</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">finite_rhs</span> <span class="free"><span class="bound"><span class="entity">ES</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ES</span></span></span><span class="main">.</span> finite <span class="bound">rhs</span>"</span></span>

<span class="keyword1" id="Myhill_1-finite_rhs_def2"><span class="command">lemma</span></span> finite_rhs_def2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite_rhs <span class="free">ES</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">X</span> <span class="bound">rhs</span><span class="main">.</span> <span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ES</span> <span class="main">⟶</span> finite <span class="bound">rhs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> finite_rhs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">rhss</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">X</span> <span class="main">|</span> <span class="bound">X</span> <span class="bound">r</span><span class="main">.</span> Trn <span class="bound">X</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lhss</span> <span class="free"><span class="bound"><span class="entity">ES</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">Y</span> <span class="main">|</span> <span class="bound">Y</span> <span class="bound">yrhs</span><span class="main">.</span> <span class="main">(</span><span class="bound">Y</span><span class="main">,</span> <span class="bound">yrhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ES</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">validity</span> <span class="free"><span class="bound"><span class="entity">ES</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ES</span></span></span><span class="main">.</span> rhss <span class="bound">rhs</span> <span class="main">⊆</span> lhss <span class="free"><span class="bound"><span class="entity">ES</span></span></span>"</span></span>

<span class="keyword1" id="Myhill_1-rhss_union_distrib"><span class="command">lemma</span></span> rhss_union_distrib<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rhss <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> rhss <span class="free">A</span> <span class="main">∪</span> rhss <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rhss_def<span class="main">)</span>

<span class="keyword1" id="Myhill_1-lhss_union_distrib"><span class="command">lemma</span></span> lhss_union_distrib<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lhss <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> lhss <span class="free">A</span> <span class="main">∪</span> lhss <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lhss_def<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free"><span class="bound"><span class="entity">ES</span></span></span> <span class="main">≡</span> finite <span class="free"><span class="bound"><span class="entity">ES</span></span></span>
                <span class="main">∧</span> finite_rhs <span class="free"><span class="bound"><span class="entity">ES</span></span></span>
                <span class="main">∧</span> soundness <span class="free"><span class="bound"><span class="entity">ES</span></span></span> 
                <span class="main">∧</span> distinctness <span class="free"><span class="bound"><span class="entity">ES</span></span></span> 
                <span class="main">∧</span> ardenable_all <span class="free"><span class="bound"><span class="entity">ES</span></span></span> 
                <span class="main">∧</span> validity <span class="free"><span class="bound"><span class="entity">ES</span></span></span>"</span></span>


<span class="keyword1" id="Myhill_1-invariantI"><span class="command">lemma</span></span> invariantI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"soundness <span class="free">ES</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">ES</span>"</span></span> <span class="quoted"><span class="quoted">"distinctness <span class="free">ES</span>"</span></span> <span class="quoted"><span class="quoted">"ardenable_all <span class="free">ES</span>"</span></span> 
          <span class="quoted"><span class="quoted">"finite_rhs <span class="free">ES</span>"</span></span> <span class="quoted"><span class="quoted">"validity <span class="free">ES</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="free">ES</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invariant_def<span class="main">)</span>


<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_Collect<span class="main">]</span><span class="main">]</span>

<span class="keyword1" id="Myhill_1-finite_Trn"><span class="command">lemma</span></span> finite_Trn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">rhs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">r</span><span class="main">.</span> Trn <span class="free">Y</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">rhs</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_vimageI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>

<span class="keyword1" id="Myhill_1-finite_Lam"><span class="command">lemma</span></span> finite_Lam<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">rhs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">r</span><span class="main">.</span> Lam <span class="bound">r</span> <span class="main">∈</span> <span class="free">rhs</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_vimageI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>

<span class="keyword1" id="Myhill_1-trm_soundness"><span class="command">lemma</span></span> trm_soundness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span><span class="quoted"><span class="quoted">"finite <span class="free">rhs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang_rhs <span class="main">(</span><span class="main">{</span>Trn <span class="free">X</span> <span class="bound">r</span><span class="main">|</span> <span class="bound">r</span><span class="main">.</span> Trn <span class="free">X</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">rhs</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span> <span class="main">⋅</span> <span class="main">(</span>lang <span class="main">(</span><span class="main">⨄</span><span class="main">{</span><span class="bound">r</span><span class="main">.</span> Trn <span class="free">X</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">rhs</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">r</span><span class="main">.</span> Trn <span class="free">X</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">rhs</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_Trn<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite<span class="main"><span class="main">]</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lang_rhs <span class="main">(</span><span class="main">{</span>Trn <span class="free">X</span> <span class="bound">r</span><span class="main">|</span> <span class="bound">r</span><span class="main">.</span> Trn <span class="free">X</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">rhs</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span> <span class="main">⋅</span> <span class="main">(</span>lang <span class="main">(</span><span class="main">⨄</span><span class="main">{</span><span class="bound">r</span><span class="main">.</span> Trn <span class="free">X</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">rhs</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> lang_rhs_set lang_trm.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conc_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Myhill_1-lang_of_append_rexp"><span class="command">lemma</span></span> lang_of_append_rexp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lang_trm <span class="main">(</span>Append_rexp <span class="free">r</span> <span class="free">trm</span><span class="main">)</span> <span class="main">=</span> lang_trm <span class="free">trm</span> <span class="main">⋅</span> lang <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Append_rexp.induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conc_assoc<span class="main">)</span>

<span class="keyword1" id="Myhill_1-lang_of_append_rexp_rhs"><span class="command">lemma</span></span> lang_of_append_rexp_rhs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lang_rhs <span class="main">(</span>Append_rexp_rhs <span class="free">rhs</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lang_rhs <span class="free">rhs</span> <span class="main">⋅</span> lang <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Append_rexp_rhs_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conc_def lang_of_append_rexp<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Intial Equational Systems›</span></span>

<span class="keyword1" id="Myhill_1-defined_by_str"><span class="command">lemma</span></span> defined_by_str<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">≈</span><span class="free">A</span> <span class="main">``</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">unfolding</span></span> quotient_def Image_def str_eq_def 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Myhill_1-every_eqclass_has_transition"><span class="command">lemma</span></span> every_eqclass_has_transition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> has_str<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">@</span> <span class="main">[</span><span class="free">c</span><span class="main">]</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     in_CS<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">Y</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∈</span> UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">⋅</span> <span class="main">{</span><span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> <span class="main">≈</span><span class="free">A</span> <span class="main">``</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> Y_def quotient_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">≈</span><span class="free">A</span> <span class="main">``</span> <span class="main">{</span><span class="free">s</span> <span class="main">@</span> <span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> has_str in_CS defined_by_str <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">⋅</span> <span class="main">{</span><span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> Y_def Image_def conc_def
    <span class="keyword1"><span class="command">unfolding</span></span> str_eq_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Y_def 
    <span class="keyword1"><span class="command">unfolding</span></span> Image_def str_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Myhill_1-l_eq_r_in_eqs"><span class="command">lemma</span></span> l_eq_r_in_eqs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> X_in_eqs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span> <span class="main">∈</span> Init <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> lang_rhs <span class="free">rhs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> lang_rhs <span class="free">rhs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> in_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang_rhs <span class="free">rhs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X_in_eqs in_X
        <span class="keyword1"><span class="command">unfolding</span></span> Init_def Init_rhs_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> decom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rev_cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X_in_eqs <span class="keyword1"><span class="command">unfolding</span></span> Init_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">⋅</span> <span class="main">{</span><span class="main">[</span><span class="skolem">c</span><span class="main">]</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="skolem">Y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> decom in_X every_eqclass_has_transition <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang_rhs <span class="main">{</span>Trn <span class="bound">Y</span> <span class="main">(</span>Atom <span class="bound">c</span><span class="main">)</span><span class="main">|</span> <span class="bound">Y</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">Y</span> <span class="main">∈</span> UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span> <span class="main">∧</span> <span class="bound">Y</span> <span class="main">⊨</span><span class="bound">c</span><span class="main">⇒</span> <span class="free">X</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> transition_def
        <span class="keyword1"><span class="command">using</span></span> decom <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conc_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang_rhs <span class="free">rhs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X_in_eqs in_X
        <span class="keyword1"><span class="command">unfolding</span></span> Init_def Init_rhs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang_rhs <span class="free">rhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lang_rhs <span class="free">rhs</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X_in_eqs
    <span class="keyword1"><span class="command">unfolding</span></span> Init_def Init_rhs_def transition_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Myhill_1-finite_Init_rhs"><span class="command">lemma</span></span> finite_Init_rhs<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">CS</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> lang<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">CS</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Init_rhs <span class="free">CS</span> <span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Init_rhs_def transition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1" id="Myhill_1-Init_ES_satisfies_invariant"><span class="command">lemma</span></span> Init_ES_satisfies_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> lang<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_CS<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>Init <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invariantI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"soundness <span class="main">(</span>Init <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> soundness_def 
    <span class="keyword1"><span class="command">using</span></span> l_eq_r_in_eqs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Init <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_CS
    <span class="keyword1"><span class="command">unfolding</span></span> Init_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinctness <span class="main">(</span>Init <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>     
    <span class="keyword1"><span class="command">unfolding</span></span> distinctness_def Init_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ardenable_all <span class="main">(</span>Init <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ardenable_all_def Init_def Init_rhs_def ardenable_def
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite_rhs <span class="main">(</span>Init <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_Init_rhs<span class="main">[</span><span class="operator">OF</span> finite_CS<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> finite_rhs_def Init_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"validity <span class="main">(</span>Init <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> validity_def Init_def Init_rhs_def rhss_def lhss_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Interations›</span></span>

<span class="keyword1" id="Myhill_1-Arden_preserves_soundness"><span class="command">lemma</span></span> Arden_preserves_soundness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> l_eq_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> lang_rhs <span class="free">rhs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"ardenable <span class="free">rhs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">rhs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> lang_rhs <span class="main">(</span>Arden <span class="free">X</span> <span class="free">rhs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> lang <span class="main">(</span><span class="main">⨄</span><span class="main">{</span><span class="bound">r</span><span class="main">.</span> Trn <span class="free">X</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">rhs</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="main">{</span>Trn <span class="free">X</span> <span class="bound">r</span> <span class="main">|</span> <span class="bound">r</span><span class="main">.</span> Trn <span class="free">X</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">rhs</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> lang_rhs <span class="main">(</span><span class="free">rhs</span> <span class="main">-</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> not_empty2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∉</span> <span class="skolem">A</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> finite_Trn<span class="main">[</span><span class="operator">OF</span> finite<span class="main">]</span> not_empty
    <span class="keyword1"><span class="command">unfolding</span></span> A_def ardenable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> lang_rhs <span class="free">rhs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l_eq_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lang_rhs <span class="main">(</span><span class="skolem">b</span> <span class="main">∪</span> <span class="main">(</span><span class="free">rhs</span> <span class="main">-</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> b_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lang_rhs <span class="skolem">b</span> <span class="main">∪</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> lang_rhs_union_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">X</span> <span class="main">⋅</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> b_def
    <span class="keyword1"><span class="command">unfolding</span></span> trm_soundness<span class="main">[</span><span class="operator">OF</span> finite<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> A_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">X</span> <span class="main">⋅</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="skolem">B</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">⋆</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reversed_Arden<span class="main"><span class="main">[</span></span><span class="operator">OF</span> not_empty2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lang_rhs <span class="main">(</span>Arden <span class="free">X</span> <span class="free">rhs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Arden_def A_def B_def b_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> lang_of_append_rexp_rhs lang.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> lang_rhs <span class="main">(</span>Arden <span class="free">X</span> <span class="free">rhs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1" id="Myhill_1-Append_preserves_finite"><span class="command">lemma</span></span> Append_preserves_finite<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">rhs</span> <span class="main">⟹</span> finite <span class="main">(</span>Append_rexp_rhs <span class="free">rhs</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Append_rexp_rhs_def<span class="main">)</span>

<span class="keyword1" id="Myhill_1-Arden_preserves_finite"><span class="command">lemma</span></span> Arden_preserves_finite<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">rhs</span> <span class="main">⟹</span> finite <span class="main">(</span>Arden <span class="free">X</span> <span class="free">rhs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Arden_def Append_preserves_finite<span class="main">)</span>

<span class="keyword1" id="Myhill_1-Append_preserves_ardenable"><span class="command">lemma</span></span> Append_preserves_ardenable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ardenable <span class="free">rhs</span> <span class="main">⟹</span> ardenable <span class="main">(</span>Append_rexp_rhs <span class="free">rhs</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ardenable_def Append_rexp_rhs_def<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_def<span class="main">)</span>

<span class="keyword1" id="Myhill_1-ardenable_set_sub"><span class="command">lemma</span></span> ardenable_set_sub<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ardenable <span class="free">rhs</span> <span class="main">⟹</span> ardenable <span class="main">(</span><span class="free">rhs</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>ardenable_def<span class="main">)</span>

<span class="keyword1" id="Myhill_1-ardenable_set_union"><span class="command">lemma</span></span> ardenable_set_union<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>ardenable <span class="free">rhs</span><span class="main">;</span> ardenable <span class="free">rhs'</span><span class="main">⟧</span> <span class="main">⟹</span> ardenable <span class="main">(</span><span class="free">rhs</span> <span class="main">∪</span> <span class="free">rhs'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>ardenable_def<span class="main">)</span>

<span class="keyword1" id="Myhill_1-Arden_preserves_ardenable"><span class="command">lemma</span></span> Arden_preserves_ardenable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ardenable <span class="free">rhs</span> <span class="main">⟹</span> ardenable <span class="main">(</span>Arden <span class="free">X</span> <span class="free">rhs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>Arden_def Append_preserves_ardenable ardenable_set_sub<span class="main">)</span>


<span class="keyword1" id="Myhill_1-Subst_preserves_ardenable"><span class="command">lemma</span></span> Subst_preserves_ardenable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>ardenable <span class="free">rhs</span><span class="main">;</span> ardenable <span class="free">xrhs</span><span class="main">⟧</span> <span class="main">⟹</span> ardenable <span class="main">(</span>Subst <span class="free">rhs</span> <span class="free">X</span> <span class="free">xrhs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Subst_def Append_preserves_ardenable ardenable_set_union ardenable_set_sub<span class="main">)</span>

<span class="keyword1" id="Myhill_1-Subst_preserves_soundness"><span class="command">lemma</span></span> Subst_preserves_soundness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> substor<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> lang_rhs <span class="free">xrhs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">rhs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang_rhs <span class="main">(</span>Subst <span class="free">rhs</span> <span class="free">X</span> <span class="free">xrhs</span><span class="main">)</span> <span class="main">=</span> lang_rhs <span class="free">rhs</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Left</span> <span class="main">=</span> <span class="var">?Right</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> lang_rhs <span class="main">(</span><span class="free">rhs</span> <span class="main">-</span> <span class="main">{</span>Trn <span class="free">X</span> <span class="bound">r</span> <span class="main">|</span> <span class="bound">r</span><span class="main">.</span> Trn <span class="free">X</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">rhs</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Left</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">∪</span> lang_rhs <span class="main">(</span>Append_rexp_rhs <span class="free">xrhs</span> <span class="main">(</span><span class="main">⨄</span><span class="main">{</span><span class="bound">r</span><span class="main">.</span> Trn <span class="free">X</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">rhs</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Subst_def
    <span class="keyword1"><span class="command">unfolding</span></span> lang_rhs_union_distrib<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Right</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">∪</span> lang_rhs <span class="main">{</span>Trn <span class="free">X</span> <span class="bound">r</span> <span class="main">|</span> <span class="bound">r</span><span class="main">.</span> Trn <span class="free">X</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">rhs</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">rhs</span> <span class="main">=</span> <span class="main">(</span><span class="free">rhs</span> <span class="main">-</span> <span class="main">{</span>Trn <span class="free">X</span> <span class="bound">r</span> <span class="main">|</span> <span class="bound">r</span><span class="main">.</span> Trn <span class="free">X</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">rhs</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span>Trn <span class="free">X</span> <span class="bound">r</span> <span class="main">|</span> <span class="bound">r</span><span class="main">.</span> Trn <span class="free">X</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">rhs</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> A_def
      <span class="keyword1"><span class="command">unfolding</span></span> lang_rhs_union_distrib
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lang_rhs <span class="main">(</span>Append_rexp_rhs <span class="free">xrhs</span> <span class="main">(</span><span class="main">⨄</span><span class="main">{</span><span class="bound">r</span><span class="main">.</span> Trn <span class="free">X</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">rhs</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lang_rhs <span class="main">{</span>Trn <span class="free">X</span> <span class="bound">r</span> <span class="main">|</span> <span class="bound">r</span><span class="main">.</span> Trn <span class="free">X</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">rhs</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> finite substor <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> lang_of_append_rexp_rhs trm_soundness<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Myhill_1-Subst_preserves_finite_rhs"><span class="command">lemma</span></span> Subst_preserves_finite_rhs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>finite <span class="free">rhs</span><span class="main">;</span> finite <span class="free">yrhs</span><span class="main">⟧</span> <span class="main">⟹</span> finite <span class="main">(</span>Subst <span class="free">rhs</span> <span class="free">Y</span> <span class="free">yrhs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Subst_def Append_preserves_finite<span class="main">)</span>

<span class="keyword1" id="Myhill_1-Subst_all_preserves_finite"><span class="command">lemma</span></span> Subst_all_preserves_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">ES</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Subst_all <span class="free">ES</span> <span class="free">Y</span> <span class="free">yrhs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Subst_all_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> finite_Collect<span class="main">]</span><span class="main">]</span>

<span class="keyword1" id="Myhill_1-Subst_all_preserves_finite_rhs"><span class="command">lemma</span></span> Subst_all_preserves_finite_rhs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>finite_rhs <span class="free">ES</span><span class="main">;</span> finite <span class="free">yrhs</span><span class="main">⟧</span> <span class="main">⟹</span> finite_rhs <span class="main">(</span>Subst_all <span class="free">ES</span> <span class="free">Y</span> <span class="free">yrhs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>Subst_preserves_finite_rhs <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Subst_all_def finite_rhs_def<span class="main">)</span>

<span class="keyword1" id="Myhill_1-append_rhs_preserves_cls"><span class="command">lemma</span></span> append_rhs_preserves_cls<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rhss <span class="main">(</span>Append_rexp_rhs <span class="free">rhs</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> rhss <span class="free">rhs</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rhss_def Append_rexp_rhs_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">xa</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Times <span class="improper">ra</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Trn <span class="improper">x</span> <span class="improper">ra</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="Myhill_1-Arden_removes_cl"><span class="command">lemma</span></span> Arden_removes_cl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rhss <span class="main">(</span>Arden <span class="free">Y</span> <span class="free">yrhs</span><span class="main">)</span> <span class="main">=</span> rhss <span class="free">yrhs</span> <span class="main">-</span> <span class="main">{</span><span class="free">Y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Arden_def append_rhs_preserves_cls<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rhss_def<span class="main">)</span>

<span class="keyword1" id="Myhill_1-lhss_preserves_cls"><span class="command">lemma</span></span> lhss_preserves_cls<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lhss <span class="main">(</span>Subst_all <span class="free">ES</span> <span class="free">Y</span> <span class="free">yrhs</span><span class="main">)</span> <span class="main">=</span> lhss <span class="free">ES</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lhss_def Subst_all_def<span class="main">)</span>

<span class="keyword1" id="Myhill_1-Subst_updates_cls"><span class="command">lemma</span></span> Subst_updates_cls<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∉</span> rhss <span class="free">xrhs</span> <span class="main">⟹</span> 
      rhss <span class="main">(</span>Subst <span class="free">rhs</span> <span class="free">X</span> <span class="free">xrhs</span><span class="main">)</span> <span class="main">=</span> rhss <span class="free">rhs</span> <span class="main">∪</span> rhss <span class="free">xrhs</span> <span class="main">-</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>Subst_def append_rhs_preserves_cls rhss_union_distrib<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rhss_def<span class="main">)</span>

<span class="keyword1" id="Myhill_1-Subst_all_preserves_validity"><span class="command">lemma</span></span> Subst_all_preserves_validity<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sc<span class="main">:</span> <span class="quoted"><span class="quoted">"validity <span class="main">(</span><span class="free">ES</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">Y</span><span class="main">,</span> <span class="free">yrhs</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"validity <span class="var">?A</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"validity <span class="main">(</span>Subst_all <span class="free">ES</span> <span class="free">Y</span> <span class="main">(</span>Arden <span class="free">Y</span> <span class="free">yrhs</span><span class="main">)</span><span class="main">)</span>"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"validity <span class="var">?B</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">xrhs'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="skolem">xrhs'</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xrhs</span></span> 
      <span class="keyword2"><span class="keyword">where</span></span> xrhs_xrhs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xrhs'</span> <span class="main">=</span> Subst <span class="skolem">xrhs</span> <span class="free">Y</span> <span class="main">(</span>Arden <span class="free">Y</span> <span class="free">yrhs</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> X_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="skolem">xrhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ES</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Subst_all_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rhss <span class="skolem">xrhs'</span> <span class="main">⊆</span> lhss <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lhss <span class="var">?B</span> <span class="main">=</span> lhss <span class="free">ES</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>lhss_def Subst_all_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rhss <span class="skolem">xrhs'</span> <span class="main">⊆</span> lhss <span class="free">ES</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rhss <span class="skolem">xrhs'</span> <span class="main">⊆</span>  rhss <span class="skolem">xrhs</span> <span class="main">∪</span> rhss <span class="main">(</span>Arden <span class="free">Y</span> <span class="free">yrhs</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">Y</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∉</span> rhss <span class="main">(</span>Arden <span class="free">Y</span> <span class="free">yrhs</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> Arden_removes_cl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> xrhs_xrhs' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Subst_updates_cls<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rhss <span class="skolem">xrhs</span> <span class="main">⊆</span> lhss <span class="free">ES</span> <span class="main">∪</span> <span class="main">{</span><span class="free">Y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X_in sc
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>validity_def lhss_union_distrib<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="skolem">xrhs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>lhss_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rhss <span class="main">(</span>Arden <span class="free">Y</span> <span class="free">yrhs</span><span class="main">)</span> <span class="main">⊆</span> lhss <span class="free">ES</span> <span class="main">∪</span> <span class="main">{</span><span class="free">Y</span><span class="main">}</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> sc 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Arden_removes_cl validity_def lhss_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>Subst_all_def validity_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Myhill_1-Subst_all_satisfies_invariant"><span class="command">lemma</span></span> Subst_all_satisfies_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invariant_ES<span class="main">:</span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span><span class="free">ES</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">Y</span><span class="main">,</span> <span class="free">yrhs</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>Subst_all <span class="free">ES</span> <span class="free">Y</span> <span class="main">(</span>Arden <span class="free">Y</span> <span class="free">yrhs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invariantI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Y_eq_yrhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> lang_rhs <span class="free">yrhs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> invariant_ES <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>invariant_def soundness_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
   <span class="keyword1"><span class="command">have</span></span> finite_yrhs<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">yrhs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> invariant_ES <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>invariant_def finite_rhs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ardenable_yrhs<span class="main">:</span> <span class="quoted"><span class="quoted">"ardenable <span class="free">yrhs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> invariant_ES <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>invariant_def ardenable_all_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"soundness <span class="main">(</span>Subst_all <span class="free">ES</span> <span class="free">Y</span> <span class="main">(</span>Arden <span class="free">Y</span> <span class="free">yrhs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> lang_rhs <span class="main">(</span>Arden <span class="free">Y</span> <span class="free">yrhs</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Y_eq_yrhs invariant_ES finite_yrhs
      <span class="keyword1"><span class="command">using</span></span> finite_Trn<span class="main">[</span><span class="operator">OF</span> finite_yrhs<span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> Arden_preserves_soundness<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> invariant_def ardenable_all_def ardenable_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> invariant_ES
      <span class="keyword1"><span class="command">unfolding</span></span> invariant_def finite_rhs_def2 soundness_def Subst_all_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Subst_preserves_soundness <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> lang_rhs.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Subst_all <span class="free">ES</span> <span class="free">Y</span> <span class="main">(</span>Arden <span class="free">Y</span> <span class="free">yrhs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> invariant_ES <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>invariant_def Subst_all_preserves_finite<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinctness <span class="main">(</span>Subst_all <span class="free">ES</span> <span class="free">Y</span> <span class="main">(</span>Arden <span class="free">Y</span> <span class="free">yrhs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> invariant_ES 
    <span class="keyword1"><span class="command">unfolding</span></span> distinctness_def Subst_all_def invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ardenable_all <span class="main">(</span>Subst_all <span class="free">ES</span> <span class="free">Y</span> <span class="main">(</span>Arden <span class="free">Y</span> <span class="free">yrhs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">rhs</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ES</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ardenable <span class="skolem">rhs</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> invariant_ES  
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>invariant_def ardenable_all_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> ardenable_yrhs 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ardenable <span class="main">(</span>Subst <span class="skolem">rhs</span> <span class="free">Y</span> <span class="main">(</span>Arden <span class="free">Y</span> <span class="free">yrhs</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ardenable_yrhs 
               Subst_preserves_ardenable Arden_preserves_ardenable<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ardenable_all_def Subst_all_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite_rhs <span class="main">(</span>Subst_all <span class="free">ES</span> <span class="free">Y</span> <span class="main">(</span>Arden <span class="free">Y</span> <span class="free">yrhs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite_rhs <span class="free">ES</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invariant_ES 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>invariant_def finite_rhs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Arden <span class="free">Y</span> <span class="free">yrhs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">yrhs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invariant_ES 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>invariant_def finite_rhs_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Arden_preserves_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Subst_all_preserves_finite_rhs<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"validity <span class="main">(</span>Subst_all <span class="free">ES</span> <span class="free">Y</span> <span class="main">(</span>Arden <span class="free">Y</span> <span class="free">yrhs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invariant_ES Subst_all_preserves_validity <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invariant_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Myhill_1-Remove_in_card_measure"><span class="command">lemma</span></span> Remove_in_card_measure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">ES</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     in_ES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ES</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Remove <span class="free">ES</span> <span class="free">X</span> <span class="free">rhs</span><span class="main">,</span> <span class="free">ES</span><span class="main">)</span> <span class="main">∈</span> measure card"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span> lang<span class="main">,</span> Subst <span class="main">(</span>snd <span class="skolem">x</span><span class="main">)</span> <span class="free">X</span> <span class="main">(</span>Arden <span class="free">X</span> <span class="free">rhs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ES'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ES'</span> <span class="main">=</span> <span class="free">ES</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Subst_all <span class="skolem">ES'</span> <span class="free">X</span> <span class="main">(</span>Arden <span class="free">X</span> <span class="free">rhs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">`</span> <span class="skolem">ES'</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Subst_all_def f_def image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">Y</span><span class="main">,</span> <span class="improper">yrhs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>Subst_all <span class="skolem">ES'</span> <span class="free">X</span> <span class="main">(</span>Arden <span class="free">X</span> <span class="free">rhs</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="skolem">ES'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ES'_def <span class="keyword1"><span class="command">using</span></span> finite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_image_le<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> card <span class="free">ES</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ES'_def 
    <span class="keyword1"><span class="command">using</span></span> in_ES finite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> card_Diff1_less<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Remove <span class="free">ES</span> <span class="free">X</span> <span class="free">rhs</span><span class="main">,</span> <span class="free">ES</span><span class="main">)</span> <span class="main">∈</span> measure card"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> Remove_def ES'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
    

<span class="keyword1" id="Myhill_1-Subst_all_cls_remains"><span class="command">lemma</span></span> Subst_all_cls_remains<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">xrhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ES</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">xrhs'</span><span class="main">.</span> <span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="bound">xrhs'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>Subst_all <span class="free">ES</span> <span class="free">Y</span> <span class="free">yrhs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Subst_all_def<span class="main">)</span>

<span class="keyword1" id="Myhill_1-card_noteq_1_has_more"><span class="command">lemma</span></span> card_noteq_1_has_more<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> card<span class="main">:</span><span class="quoted"><span class="quoted">"Cond <span class="free">ES</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> e_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">xrhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ES</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">ES</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">Y</span><span class="main">,</span> <span class="bound">yrhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ES</span><span class="main">.</span> <span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">xrhs</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="bound">Y</span><span class="main">,</span> <span class="bound">yrhs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">ES</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card e_in finite 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"card <span class="free">ES</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">ES</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">xrhs</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite e_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ES</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">xrhs</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">Y</span><span class="main">,</span> <span class="bound">yrhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ES</span><span class="main">.</span> <span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">xrhs</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="bound">Y</span><span class="main">,</span> <span class="bound">yrhs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Myhill_1-iteration_step_measure"><span class="command">lemma</span></span> iteration_step_measure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Inv_ES<span class="main">:</span> <span class="quoted"><span class="quoted">"invariant <span class="free">ES</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>    X_in_ES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">xrhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ES</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>    Cnd<span class="main">:</span>     <span class="quoted"><span class="quoted">"Cond <span class="free">ES</span> "</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Iter <span class="free">X</span> <span class="free">ES</span><span class="main">,</span> <span class="free">ES</span><span class="main">)</span> <span class="main">∈</span> measure card"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">ES</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Inv_ES <span class="keyword1"><span class="command">unfolding</span></span> invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="skolem"><span class="skolem">yrhs</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> Y_in_ES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Y</span><span class="main">,</span> <span class="skolem">yrhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ES</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> not_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">xrhs</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="skolem">Y</span><span class="main">,</span> <span class="skolem">yrhs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Cnd X_in_ES <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> card_noteq_1_has_more<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Y</span><span class="main">,</span> <span class="skolem">yrhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ES</span> "</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="skolem">Y</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> X_in_ES Inv_ES <span class="keyword1"><span class="command">unfolding</span></span> invariant_def distinctness_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Iter <span class="free">X</span> <span class="free">ES</span><span class="main">,</span> <span class="free">ES</span><span class="main">)</span> <span class="main">∈</span> measure card"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> IterI2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Remove_in_card_measure<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fin<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Myhill_1-iteration_step_invariant"><span class="command">lemma</span></span> iteration_step_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Inv_ES<span class="main">:</span> <span class="quoted"><span class="quoted">"invariant <span class="free">ES</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>    X_in_ES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">xrhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ES</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>    Cnd<span class="main">:</span> <span class="quoted"><span class="quoted">"Cond <span class="free">ES</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>Iter <span class="free">X</span> <span class="free">ES</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> finite_ES<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">ES</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Inv_ES <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invariant_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="skolem"><span class="skolem">yrhs</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> Y_in_ES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Y</span><span class="main">,</span> <span class="skolem">yrhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ES</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> not_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">xrhs</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="skolem">Y</span><span class="main">,</span> <span class="skolem">yrhs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Cnd X_in_ES <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> card_noteq_1_has_more<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Y</span><span class="main">,</span> <span class="skolem">yrhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ES</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="skolem">Y</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> X_in_ES Inv_ES <span class="keyword1"><span class="command">unfolding</span></span> invariant_def distinctness_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>Iter <span class="free">X</span> <span class="free">ES</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> IterI2<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span> <span class="skolem">yrhs</span>
    <span class="keyword3"><span class="command">assume</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Y</span><span class="main">,</span> <span class="skolem">yrhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ES</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ES</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="skolem">Y</span><span class="main">,</span> <span class="skolem">yrhs</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="skolem">Y</span><span class="main">,</span> <span class="skolem">yrhs</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="free">ES</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>Remove <span class="free">ES</span> <span class="skolem">Y</span> <span class="skolem">yrhs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Remove_def
      <span class="keyword1"><span class="command">using</span></span> Inv_ES
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Subst_all_satisfies_invariant<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Myhill_1-iteration_step_ex"><span class="command">lemma</span></span> iteration_step_ex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Inv_ES<span class="main">:</span> <span class="quoted"><span class="quoted">"invariant <span class="free">ES</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>    X_in_ES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">xrhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ES</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>    Cnd<span class="main">:</span> <span class="quoted"><span class="quoted">"Cond <span class="free">ES</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xrhs'</span><span class="main">.</span> <span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="bound">xrhs'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>Iter <span class="free">X</span> <span class="free">ES</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> finite_ES<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">ES</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Inv_ES <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invariant_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="skolem"><span class="skolem">yrhs</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Y</span><span class="main">,</span> <span class="skolem">yrhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ES</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">xrhs</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="skolem">Y</span><span class="main">,</span> <span class="skolem">yrhs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Cnd X_in_ES <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> card_noteq_1_has_more<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Y</span><span class="main">,</span> <span class="skolem">yrhs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ES</span> "</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="skolem">Y</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> X_in_ES Inv_ES <span class="keyword1"><span class="command">unfolding</span></span> invariant_def distinctness_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xrhs'</span><span class="main">.</span> <span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="bound">xrhs'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>Iter <span class="free">X</span> <span class="free">ES</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> IterI2<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> Remove_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Subst_all_cls_remains<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> X_in_ES
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The conclusion of the first direction›</span></span>

<span class="keyword1" id="Myhill_1-Solve"><span class="command">lemma</span></span> Solve<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> lang"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     X_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">rhs</span><span class="main">.</span> Solve <span class="free">X</span> <span class="main">(</span>Init <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">}</span> <span class="main">∧</span> invariant <span class="main">{</span><span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Inv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Inv</span> <span class="skolem">ES</span> <span class="main">⟷</span> invariant <span class="skolem">ES</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">rhs</span><span class="main">.</span> <span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">ES</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ES</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Inv</span> <span class="main">(</span>Init <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Inv_def
      <span class="keyword1"><span class="command">using</span></span> fin X_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Init_ES_satisfies_invariant<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Init_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ES</span>
    <span class="keyword3"><span class="command">assume</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Inv</span> <span class="skolem">ES</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> crd<span class="main">:</span> <span class="quoted"><span class="quoted">"Cond <span class="skolem">ES</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Inv</span> <span class="main">(</span>Iter <span class="free">X</span> <span class="skolem">ES</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Inv_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iteration_step_invariant iteration_step_ex<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ES</span>
    <span class="keyword3"><span class="command">assume</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Inv</span> <span class="skolem">ES</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> not_crd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Cond <span class="skolem">ES</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> inv <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rhs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">ES</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> not_crd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">ES</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ES</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Suc_eq<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">rhs'</span><span class="main">.</span> <span class="skolem">ES</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="bound">rhs'</span><span class="main">)</span><span class="main">}</span> <span class="main">∧</span> invariant <span class="main">{</span><span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="bound">rhs'</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv
      <span class="keyword1"><span class="command">unfolding</span></span> Inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>measure card<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ES</span>
    <span class="keyword3"><span class="command">assume</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Inv</span> <span class="skolem">ES</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> crd<span class="main">:</span> <span class="quoted"><span class="quoted">"Cond <span class="skolem">ES</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Iter <span class="free">X</span> <span class="skolem">ES</span><span class="main">,</span> <span class="skolem">ES</span><span class="main">)</span> <span class="main">∈</span> measure card"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Inv_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> iteration_step_measure<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">rhs</span><span class="main">.</span> Solve <span class="free">X</span> <span class="main">(</span>Init <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">}</span> <span class="main">∧</span> invariant <span class="main">{</span><span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> Solve_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> while_rule<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Myhill_1-every_eqcl_has_reg"><span class="command">lemma</span></span> every_eqcl_has_reg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> lang"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_CS<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> X_in_CS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> lang <span class="bound">r</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> finite_CS X_in_CS 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xrhs</span></span> <span class="keyword2"><span class="keyword">where</span></span> Inv_ES<span class="main">:</span> <span class="quoted"><span class="quoted">"invariant <span class="main">{</span><span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="skolem">xrhs</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Solve <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> Arden <span class="free">X</span> <span class="skolem">xrhs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rhss <span class="skolem">xrhs</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Inv_ES 
    <span class="keyword1"><span class="command">unfolding</span></span> validity_def invariant_def rhss_def lhss_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rhss <span class="skolem">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Arden_removes_cl<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Lam <span class="bound">r</span> <span class="main">|</span> <span class="bound">r</span><span class="main">.</span> Lam <span class="bound">r</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rhss_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Inv_ES <span class="keyword1"><span class="command">unfolding</span></span> A_def invariant_def finite_rhs_def
    <span class="keyword1"><span class="command">using</span></span> Arden_preserves_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">r</span><span class="main">.</span> Lam <span class="bound">r</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_Lam<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> lang_rhs <span class="skolem">xrhs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Inv_ES <span class="keyword1"><span class="command">unfolding</span></span> invariant_def soundness_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> lang_rhs <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Inv_ES 
    <span class="keyword1"><span class="command">unfolding</span></span> A_def invariant_def ardenable_all_def finite_rhs_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Arden_preserves_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_Trn<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> lang_rhs <span class="main">{</span>Lam <span class="bound">r</span> <span class="main">|</span> <span class="bound">r</span><span class="main">.</span> Lam <span class="bound">r</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> lang <span class="main">(</span><span class="main">⨄</span><span class="main">{</span><span class="bound">r</span><span class="main">.</span> Lam <span class="bound">r</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fin <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> lang <span class="bound">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Myhill_1-bchoice_finite_set"><span class="command">lemma</span></span> bchoice_finite_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span>     b<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="main">⋃</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∧</span> finite <span class="bound">ys</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> bchoice<span class="main">[</span><span class="operator">OF</span> a<span class="main">]</span> b
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule_tac</span> exE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">fa</span> <span class="main">`</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> Myhill_Nerode1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> lang"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_CS<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free">A</span> <span class="main">=</span> lang <span class="bound">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>finals <span class="free">A</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> finals_in_partitions finite_CS <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="bound">X</span> <span class="main">=</span> lang <span class="bound">r</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> finite_CS every_eqcl_has_reg <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> finals <span class="free">A</span><span class="main">.</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="bound">X</span> <span class="main">=</span> lang <span class="bound">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finals_in_partitions <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>finals <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>lang <span class="main">`</span> <span class="skolem">rs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fin <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> bchoice_finite_set<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> lang <span class="main">(</span><span class="main">⨄</span><span class="skolem">rs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> lang_is_union_of_finals<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free">A</span> <span class="main">=</span> lang <span class="bound">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> 


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Myhill_2">
<div class="head">
<h1>Theory Myhill_2</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Xingyuan Zhang, Chunhan Wu, Christian Urban *)</span>
<span class="keyword1"><span class="command">theory</span></span> Myhill_2
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Myhill_1.html">Myhill_1</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Sublist.html">HOL-Library.Sublist</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Second direction of MN: <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>regular language ⇒ finite partition›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Tagging functions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
   <span class="entity">tag_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">=</span>_<span class="keyword1">=</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="main"><span class="free">=</span></span><span class="free"><span class="bound"><span class="entity">tag</span></span></span><span class="main"><span class="free">=</span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="bound">y</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
   <span class="entity">tag_eq_applied</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">=</span>_<span class="keyword1">=</span> _"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">=</span></span><span class="free"><span class="bound"><span class="entity">tag</span></span></span><span class="main"><span class="free">=</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="main">=</span><span class="free"><span class="bound"><span class="entity">tag</span></span></span><span class="main">=</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">≈</span><span class="free">A</span><span class="main">)</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">≈</span><span class="free">A</span><span class="main">)</span> <span class="main">``</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≈</span><span class="free">A</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> str_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Myhill_2-refined_intro"><span class="command">lemma</span></span> refined_intro<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">=</span><span class="free">tag</span><span class="main">=</span> <span class="bound">y</span><span class="main">;</span> <span class="bound">x</span> <span class="main">@</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">@</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">=</span><span class="free">tag</span><span class="main">=</span> <span class="main">⊆</span> <span class="main">≈</span><span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> str_eq_def tag_eq_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_use</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Myhill_2-finite_eq_tag_rel"><span class="command">lemma</span></span> finite_eq_tag_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rng_fnt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">tag</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">=</span><span class="free">tag</span><span class="main">=</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span>"</span></span> <span class="main">=</span>  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="free">tag</span> <span class="main">`</span> <span class="bound">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UNIV <span class="main">//</span> <span class="main">=</span><span class="free">tag</span><span class="main">=</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?f</span> <span class="main">`</span> <span class="var">?A</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"range <span class="var">?f</span> <span class="main">⊆</span> <span class="main">(</span>Pow <span class="main">(</span>range <span class="free">tag</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Pow_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Pow <span class="main">(</span>range <span class="free">tag</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rng_fnt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="var">?f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> image_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`</span> <span class="var">?A</span> <span class="main">⊆</span> range <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?f</span> <span class="main">`</span> <span class="var">?A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev_finite_subset<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="var">?f</span> <span class="var">?A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span>
      <span class="keyword3"><span class="command">assume</span></span> X_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span>  Y_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span>  tag_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">X</span> <span class="main">=</span> <span class="var">?f</span> <span class="skolem">Y</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> 
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">tag</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">tag</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> quotient_def Image_def image_def tag_eq_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> X_in Y_in 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="skolem">Y</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> quotient_def tag_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="var">?f</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">=</span><span class="free">tag</span><span class="main">=</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_imageD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Myhill_2-refined_partition_finite"><span class="command">lemma</span></span> refined_partition_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fnt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="free">R1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> refined<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">⊆</span> <span class="free">R2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"equiv UNIV <span class="free">R1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"equiv UNIV <span class="free">R2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="free">R2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="main">{</span><span class="free">R1</span> <span class="main">``</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">}</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">//</span> <span class="free">R2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">//</span> <span class="free">R1</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`</span> <span class="var">?A</span> <span class="main">⊆</span> Pow <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> image_def Pow_def quotient_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Pow <span class="var">?B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fnt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?f</span> <span class="main">`</span> <span class="var">?A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="var">?f</span> <span class="var">?A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span>
      <span class="keyword3"><span class="command">assume</span></span> X_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Y_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">X</span> <span class="main">=</span> <span class="var">?f</span> <span class="skolem">Y</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> quotientE <span class="main">[</span><span class="operator">OF</span> X_in<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="free">R2</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> equiv_class_self<span class="main">[</span><span class="operator">OF</span> eq2<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> x_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">``</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> <span class="var">?f</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> eq_f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> <span class="var">?f</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> 
        <span class="keyword2"><span class="keyword">where</span></span> y_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">Y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq_r1_xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">=</span> <span class="free">R1</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> eq_equiv_class<span class="main">[</span><span class="operator">OF</span> _ eq1<span class="main">]</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> refined <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> quotient_eqI <span class="main">[</span><span class="operator">OF</span> eq2 X_in Y_in x_in y_in<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">}</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="var">?f</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="free">R2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_imageD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Myhill_2-tag_finite_imageD"><span class="command">lemma</span></span> tag_finite_imageD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rng_fnt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">tag</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span>     refined<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">=</span><span class="free">tag</span><span class="main">=</span>  <span class="main">⊆</span> <span class="main">≈</span><span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> refined_partition_finite <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">=</span></span><span class="free"><span class="free">tag</span></span><span class="main"><span class="main">=</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">=</span><span class="free">tag</span><span class="main">=</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_eq_tag_rel<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rng_fnt<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">=</span><span class="free">tag</span><span class="main">=</span> <span class="main">⊆</span> <span class="main">≈</span><span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> refined <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"equiv UNIV <span class="main">=</span><span class="free">tag</span><span class="main">=</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"equiv UNIV <span class="main">(</span><span class="main">≈</span><span class="free">A</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> equiv_def str_eq_def tag_eq_def refl_on_def sym_def trans_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Base cases: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Zero<span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> One<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Atom<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="Myhill_2-quot_zero_eq"><span class="command">lemma</span></span> quot_zero_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"UNIV <span class="main">//</span> <span class="main">≈</span><span class="main">{}</span> <span class="main">=</span> <span class="main">{</span>UNIV<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> quotient_def Image_def str_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Myhill_2-quot_zero_finiteI"><span class="command">lemma</span></span> quot_zero_finiteI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> quot_zero_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1" id="Myhill_2-quot_one_subset"><span class="command">lemma</span></span> quot_one_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"UNIV <span class="main">//</span> <span class="main">≈</span><span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">,</span> UNIV <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> UNIV <span class="main">//</span> <span class="main">≈</span><span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">{</span><span class="bound">z</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">≈</span><span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="bound">z</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> quotient_def Image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> h <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> str_eq_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">,</span> UNIV <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> h <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> UNIV <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> str_eq_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">,</span> UNIV <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">,</span> UNIV <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Myhill_2-quot_one_finiteI"><span class="command">lemma</span></span> quot_one_finiteI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> quot_one_subset<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>


<span class="keyword1" id="Myhill_2-quot_atom_subset"><span class="command">lemma</span></span> quot_atom_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"UNIV <span class="main">//</span> <span class="main">(</span><span class="main">≈</span><span class="main">{</span><span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">}</span><span class="main">,</span> UNIV <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">}</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> UNIV <span class="main">//</span> <span class="main">≈</span><span class="main">{</span><span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">{</span><span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="main">≈</span><span class="main">{</span><span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">}</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> quotient_def Image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">}</span><span class="main">,</span> UNIV <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> str_eq_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span> 
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">[</span><span class="free">c</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">{</span><span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> str_eq_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span> 
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="main">[</span><span class="free">c</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">@</span> <span class="bound">z</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[</span><span class="free">c</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≠</span> <span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">p</span> <span class="main">@</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">p</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> UNIV <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">,</span><span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> str_eq_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> 
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Myhill_2-quot_atom_finiteI"><span class="command">lemma</span></span> quot_atom_finiteI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="main">{</span><span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> quot_atom_subset<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Case for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Plus<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">tag_Plus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> lang <span class="main">×</span> <span class="tfree">'a</span> lang<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tag_Plus</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">≈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">``</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">,</span> <span class="main">≈</span><span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">``</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Myhill_2-quot_plus_finiteI"><span class="command">lemma</span></span> quot_plus_finiteI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     finite2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> tag <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"tag_Plus <span class="free">A</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> tag_finite_imageD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> finite1 finite2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="main">(</span>tag_Plus <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tag_Plus_def quotient_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev_finite_subset<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">=</span>tag_Plus <span class="free">A</span> <span class="free">B</span><span class="main">=</span> <span class="main">⊆</span> <span class="main">≈</span><span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tag_eq_def tag_Plus_def str_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Case for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Times›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Partitions</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">x<span class="hidden">⇩</span><sub>p</sub></span><span class="main">,</span> <span class="bound">x<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span><span class="main">.</span> <span class="bound">x<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">@</span> <span class="bound">x<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Myhill_2-conc_partitions_elim"><span class="command">lemma</span></span> conc_partitions_elim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⋅</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> Partitions <span class="free">x</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> conc_def Partitions_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Myhill_2-conc_partitions_intro"><span class="command">lemma</span></span> conc_partitions_intro<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> Partitions <span class="free">x</span> <span class="main">∧</span> <span class="free">u</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span>  <span class="free">v</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⋅</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> conc_def Partitions_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Myhill_2-equiv_class_member"><span class="command">lemma</span></span> equiv_class_member<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">≈</span><span class="free">A</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">≈</span><span class="free">A</span> <span class="main">``</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> str_eq_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> append_Nil2<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">tag_Times</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">×</span> <span class="tfree">'a</span> lang set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tag_Times</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">≈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">``</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="main">≈</span><span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">``</span> <span class="main">{</span><span class="bound">x<span class="hidden">⇩</span><sub>s</sub></span><span class="main">}</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x<span class="hidden">⇩</span><sub>p</sub></span> <span class="bound">x<span class="hidden">⇩</span><sub>s</sub></span><span class="main">.</span> <span class="bound">x<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x<span class="hidden">⇩</span><sub>p</sub></span><span class="main">,</span> <span class="bound">x<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">∈</span> Partitions <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Myhill_2-tag_Times_injI"><span class="command">lemma</span></span> tag_Times_injI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"tag_Times <span class="free">A</span> <span class="free">B</span> <span class="free">x</span> <span class="main">=</span> tag_Times <span class="free">A</span> <span class="free">B</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">@</span> <span class="free">z</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⋅</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">@</span> <span class="free">z</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⋅</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> c <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> Partitions <span class="main">(</span><span class="free">x</span> <span class="main">@</span> <span class="free">z</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> conc_partitions_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> h1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">@</span> <span class="free">z</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Partitions_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">us</span> <span class="main">∧</span> <span class="skolem">us</span> <span class="main">@</span> <span class="free">z</span> <span class="main">=</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">x</span> <span class="main">@</span> <span class="skolem">us</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="free">z</span> <span class="main">=</span> <span class="skolem">us</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_eq_append_conv2<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">us</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">@</span> <span class="free">z</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">≈</span><span class="free">B</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">us</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">(</span>tag_Times <span class="free">A</span> <span class="free">B</span> <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Partitions_def tag_Times_def <span class="keyword1"><span class="command">using</span></span> h2 eq 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> str_eq_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">≈</span><span class="free">B</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">us</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">(</span>tag_Times <span class="free">A</span> <span class="free">B</span> <span class="free">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">us'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      q1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      q2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">≈</span><span class="free">B</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">us</span><span class="main">}</span> <span class="main">=</span> <span class="main">≈</span><span class="free">B</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">us'</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      q3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u'</span><span class="main">,</span> <span class="skolem">us'</span><span class="main">)</span> <span class="main">∈</span> Partitions <span class="free">y</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> tag_Times_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> q2 h3 eq 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us'</span> <span class="main">@</span> <span class="free">z</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Image_def str_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">@</span> <span class="free">z</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⋅</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q1 q3 
      <span class="keyword1"><span class="command">unfolding</span></span> Partitions_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">@</span> <span class="skolem">us</span> <span class="main">=</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> <span class="skolem">us</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">≈</span><span class="free">A</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>tag_Times <span class="free">A</span> <span class="free">B</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tag_Times_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">≈</span><span class="free">A</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>tag_Times <span class="free">A</span> <span class="free">B</span> <span class="free">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">≈</span><span class="free">A</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">≈</span><span class="free">A</span> <span class="main">``</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tag_Times_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">@</span> <span class="skolem">us</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h2 eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">@</span> <span class="skolem">us</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> equiv_class_member 
      <span class="keyword1"><span class="command">unfolding</span></span> Image_def str_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span> <span class="main">@</span> <span class="skolem">us</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">v</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⋅</span> <span class="free">B</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> h3 <span class="keyword1"><span class="command">unfolding</span></span> conc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">@</span> <span class="free">z</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⋅</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">@</span> <span class="free">z</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⋅</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Myhill_2-quot_conc_finiteI"><span class="command">lemma</span></span> quot_conc_finiteI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span>     fin2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">B</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="main">(</span><span class="free">A</span> <span class="main">⋅</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> tag <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"tag_Times <span class="free">A</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> tag_finite_imageD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">⟦</span>tag_Times <span class="free">A</span> <span class="free">B</span> <span class="bound">x</span> <span class="main">=</span> tag_Times <span class="free">A</span> <span class="free">B</span> <span class="bound">y</span><span class="main">;</span> <span class="bound">x</span> <span class="main">@</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⋅</span> <span class="free">B</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">@</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⋅</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tag_Times_injI<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tag_Times_def tag_eq_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">=</span>tag_Times <span class="free">A</span> <span class="free">B</span><span class="main">=</span> <span class="main">⊆</span> <span class="main">≈</span><span class="main">(</span><span class="free">A</span> <span class="main">⋅</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refined_intro<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tag_eq_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fin1 fin2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="main">(</span>tag_Times <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> tag_Times_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ *<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> quotient_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Case for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> "Star"<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="Myhill_2-star_partitions_elim"><span class="command">lemma</span></span> star_partitions_elim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">@</span> <span class="free">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> Partitions <span class="main">(</span><span class="free">x</span> <span class="main">@</span> <span class="free">z</span><span class="main">)</span><span class="main">.</span> strict_prefix <span class="bound">u</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">x</span> <span class="main">@</span> <span class="free">z</span><span class="main">)</span> <span class="main">∈</span> Partitions <span class="main">(</span><span class="free">x</span> <span class="main">@</span> <span class="free">z</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"strict_prefix <span class="main">[]</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">@</span> <span class="free">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Partitions_def strict_prefix_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> Partitions <span class="main">(</span><span class="free">x</span> <span class="main">@</span> <span class="free">z</span><span class="main">)</span><span class="main">.</span> strict_prefix <span class="bound">u</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Myhill_2-finite_set_has_max2"><span class="command">lemma</span></span> finite_set_has_max2<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>finite <span class="free">A</span><span class="main">;</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">max</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> length <span class="bound">a</span> <span class="main">≤</span> length <span class="bound">max</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>finite.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> all_not_in_conv insert_iff linorder_le_cases order_trans<span class="main">)</span>

<span class="keyword1" id="Myhill_2-finite_strict_prefix_set"><span class="command">lemma</span></span> finite_strict_prefix_set<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">xa</span><span class="main">.</span> strict_prefix <span class="bound">xa</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span> list<span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">xa</span><span class="main">.</span> strict_prefix <span class="bound">xa</span> <span class="main">(</span><span class="improper">xs</span> <span class="main">@</span> <span class="main">[</span><span class="improper">x</span><span class="main">]</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">xa</span><span class="main">.</span> strict_prefix <span class="bound">xa</span> <span class="improper">xs</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="improper">xs</span><span class="main">}</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>strict_prefix_def<span class="main">)</span>

<span class="keyword1" id="Myhill_2-append_eq_cases"><span class="command">lemma</span></span> append_eq_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">@</span> <span class="free">y</span> <span class="main">=</span> <span class="free">m</span> <span class="main">@</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prefix <span class="free">x</span> <span class="free">m</span> <span class="main">∨</span> strict_prefix <span class="free">m</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> prefix_def strict_prefix_def <span class="keyword1"><span class="command">using</span></span> a
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_eq_append_conv2<span class="main">)</span>

<span class="keyword1" id="Myhill_2-star_spartitions_elim2"><span class="command">lemma</span></span> star_spartitions_elim2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">@</span> <span class="free">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span>     b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> Partitions <span class="free">x</span><span class="main">.</span> <span class="main">∃</span> <span class="main">(</span><span class="bound">u'</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">∈</span> Partitions <span class="free">z</span><span class="main">.</span> strict_prefix <span class="bound">u</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">@</span> <span class="bound">u'</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">v'</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound">u</span> <span class="main">|</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> Partitions <span class="free">x</span> <span class="main">∧</span> strict_prefix <span class="bound">u</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">@</span> <span class="free">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">u</span><span class="main">.</span> strict_prefix <span class="bound">u</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_strict_prefix_set<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev_finite_subset<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a b <span class="keyword1"><span class="command">unfolding</span></span> S_def Partitions_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strict_prefix_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u_max</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> length <span class="bound">u</span> <span class="main">≤</span> length <span class="bound">u_max</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> finite_set_has_max2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u_max</span></span> <span class="skolem"><span class="skolem">v</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u_max</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> Partitions <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_prefix <span class="skolem">u_max</span> <span class="free">x</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u_max</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">@</span> <span class="free">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span>  
    <span class="keyword2"><span class="keyword">and</span></span> h4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> Partitions <span class="free">x</span> <span class="main">∧</span> strict_prefix <span class="bound">u</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">@</span> <span class="free">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span> <span class="main">⟶</span> length <span class="bound">u</span> <span class="main">≤</span> length <span class="skolem">u_max</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> S_def Partitions_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h0 h1 b <span class="keyword1"><span class="command">unfolding</span></span> Partitions_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> h3 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> Partitions <span class="main">(</span><span class="skolem">v</span> <span class="main">@</span> <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   i3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   i4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Partitions_def
    <span class="keyword1"><span class="command">using</span></span> q <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> star_decom<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix <span class="skolem">v</span> <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>prefix <span class="skolem">v</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> i1 <span class="keyword1"><span class="command">have</span></span> i1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">@</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">@</span> <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Partitions_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix <span class="skolem">a</span> <span class="skolem">v</span> <span class="main">∨</span> strict_prefix <span class="skolem">v</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> append_eq_cases q <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_prefix <span class="skolem">a</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">unfolding</span></span> strict_prefix_def prefix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">@</span> <span class="skolem">as</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> strict_prefix_def prefix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u_max</span> <span class="main">@</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">∈</span> Partitions <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq h0 <span class="keyword1"><span class="command">unfolding</span></span> Partitions_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"strict_prefix <span class="main">(</span><span class="skolem">u_max</span> <span class="main">@</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h0 eq q <span class="keyword1"><span class="command">unfolding</span></span> Partitions_def prefix_def strict_prefix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u_max</span> <span class="main">@</span> <span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i2 h2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">@</span> <span class="free">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i1' i2 i3 eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">u_max</span> <span class="main">@</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">≤</span> length <span class="skolem">u_max</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> i4 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> i1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">za</span></span> <span class="skolem"><span class="skolem">zb</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> k1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">@</span> <span class="skolem">za</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   k2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">za</span><span class="main">,</span> <span class="skolem">zb</span><span class="main">)</span> <span class="main">∈</span> Partitions <span class="free">z</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span>   k4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zb</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> Partitions_def prefix_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_eq_append_conv2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> Partitions <span class="free">x</span><span class="main">.</span> <span class="main">∃</span> <span class="main">(</span><span class="bound">u'</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">∈</span> Partitions <span class="free">z</span><span class="main">.</span> strict_prefix <span class="bound">u</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">@</span> <span class="bound">u'</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">v'</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h0 h1 h2 i2 i3 k1 k2 k4 <span class="keyword1"><span class="command">unfolding</span></span> Partitions_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">tag_Star</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> lang<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tag_Star</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="main">≈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">``</span> <span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> strict_prefix <span class="bound">u</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⋆</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> Partitions <span class="bound">x</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Myhill_2-tag_Star_non_empty_injI"><span class="command">lemma</span></span> tag_Star_non_empty_injI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"tag_Star <span class="free">A</span> <span class="free">x</span> <span class="main">=</span> tag_Star <span class="free">A</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">@</span> <span class="free">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">@</span> <span class="free">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">v'</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span>  <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> Partitions <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u'</span><span class="main">,</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">∈</span> Partitions <span class="free">z</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   a2<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_prefix <span class="skolem">u</span> <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   a3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   a4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">@</span> <span class="skolem">u'</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span>   a5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c d <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> star_spartitions_elim2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">≈</span><span class="free">A</span><span class="main">)</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">v</span><span class="main">}</span> <span class="main">∈</span> tag_Star <span class="free">A</span> <span class="free">x</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tag_Star_def Partitions_def str_eq_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> a1 a2 a3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Partitions_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">≈</span><span class="free">A</span><span class="main">)</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">v</span><span class="main">}</span> <span class="main">∈</span> tag_Star <span class="free">A</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u1</span></span> <span class="skolem"><span class="skolem">v1</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> b1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≈</span><span class="free">A</span> <span class="skolem">v1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   b3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u1</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   b4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u1</span><span class="main">,</span> <span class="skolem">v1</span><span class="main">)</span> <span class="main">∈</span> Partitions <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tag_Star_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">@</span> <span class="skolem">u'</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b1 a4 <span class="keyword1"><span class="command">unfolding</span></span> str_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u1</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">v1</span> <span class="main">@</span> <span class="skolem">u'</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">v'</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> b3 c a5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> append_in_starI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">@</span> <span class="free">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b4 a1 
    <span class="keyword1"><span class="command">unfolding</span></span> Partitions_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1" id="Myhill_2-tag_Star_empty_injI"><span class="command">lemma</span></span> tag_Star_empty_injI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"tag_Star <span class="free">A</span> <span class="free">x</span> <span class="main">=</span> tag_Star <span class="free">A</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">@</span> <span class="free">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">@</span> <span class="free">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">=</span> tag_Star <span class="free">A</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> tag_Star_def <span class="keyword1"><span class="command">using</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tag_Star_def Partitions_def strict_prefix_def prefix_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Nil_in_star append_self_conv2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">@</span> <span class="free">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c d <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Myhill_2-quot_star_finiteI"><span class="command">lemma</span></span> quot_star_finiteI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="main">(</span><span class="free">A</span><span class="main">⋆</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> tag <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"tag_Star <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> tag_finite_imageD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">⟦</span>tag_Star <span class="free">A</span> <span class="bound">x</span> <span class="main">=</span> tag_Star <span class="free">A</span> <span class="bound">y</span><span class="main">;</span> <span class="bound">x</span> <span class="main">@</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">@</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> tag_Star_empty_injI tag_Star_non_empty_injI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">=</span><span class="main">(</span>tag_Star <span class="free">A</span><span class="main">)</span><span class="main">=</span> <span class="main">⊆</span> <span class="main">≈</span><span class="main">(</span><span class="free">A</span><span class="main">⋆</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refined_intro<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tag_eq_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Pow <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> finite1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="main">(</span>tag_Star <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tag_Star_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ *<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quotient_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The conclusion of the second direction›</span></span>

<span class="keyword1" id="Myhill_2-Myhill_Nerode2"><span class="command">lemma</span></span> Myhill_Nerode2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">r</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="main">(</span>lang <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Myhill">
<div class="head">
<h1>Theory Myhill</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Xingyuan Zhang, Chunhan Wu, Christian Urban *)</span>

<span class="keyword1"><span class="command">theory</span></span> Myhill
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Myhill_2.html">Myhill_2</a> <span class="quoted">"<a href="../Regular-Sets/Derivatives.html">Regular-Sets.Derivatives</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The theorem›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Myhill_Nerode<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> lang"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free">A</span> <span class="main">=</span> lang <span class="bound">r</span><span class="main">)</span> <span class="main">⟷</span> finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Myhill_Nerode1 Myhill_Nerode2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Second direction proved using partial derivatives›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An alternaive proof using the notion of partial derivatives for regular 
  expressions due to Antimirov \cite{Antimirov95}.
›</span></span>

<span class="keyword1" id="Myhill-MN_Rel_Derivs"><span class="command">lemma</span></span> MN_Rel_Derivs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≈</span><span class="free">A</span> <span class="free">y</span> <span class="main">⟷</span> Derivs <span class="free">x</span> <span class="free">A</span> <span class="main">=</span> Derivs <span class="free">y</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Derivs_def str_eq_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Myhill-Myhill_Nerode3"><span class="command">lemma</span></span> Myhill_Nerode3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">r</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="main">(</span>lang <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pderivs <span class="bound">x</span> <span class="free">r</span><span class="main">)</span><span class="main">=</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pderivs <span class="bound">x</span> <span class="free">r</span><span class="main">)</span> <span class="main">⊆</span> Pow <span class="main">(</span>pderivs_lang UNIV <span class="free">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pderivs_lang_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Pow <span class="main">(</span>pderivs_lang UNIV <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_pderivs_lang<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pderivs <span class="bound">x</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pderivs <span class="bound">x</span> <span class="free">r</span><span class="main">)</span><span class="main">=</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_eq_tag_rel<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pderivs <span class="bound">x</span> <span class="free">r</span><span class="main">)</span><span class="main">=</span> <span class="main">⊆</span> <span class="main">≈</span><span class="main">(</span>lang <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tag_eq_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MN_Rel_Derivs Derivs_pderivs<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equiv UNIV <span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pderivs <span class="bound">x</span> <span class="free">r</span><span class="main">)</span><span class="main">=</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"equiv UNIV <span class="main">(</span><span class="main">≈</span><span class="main">(</span>lang <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> equiv_def refl_on_def sym_def trans_def
    <span class="keyword1"><span class="command">unfolding</span></span> tag_eq_def str_eq_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="main">(</span>lang <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refined_partition_finite<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Closures">
<div class="head">
<h1>Theory Closures</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Christian Urban, Xingyuan Zhang, Chunhan Wu *)</span>
<span class="keyword1"><span class="command">theory</span></span> Closures
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Myhill.html">Myhill</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Infinite_Set.html">HOL-Library.Infinite_Set</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Closure properties of regular languages›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">regular</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lang <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">regular</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> lang <span class="bound">r</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Closure under <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>∪›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⋅›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⋆›</span></span></span></span>›</span></span>

<span class="keyword1" id="Closures-closure_union"><span class="command">lemma</span></span> closure_union <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"regular <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"regular <span class="free">B</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="skolem"><span class="skolem">r2</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"lang <span class="skolem">r1</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"lang <span class="skolem">r2</span> <span class="main">=</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∪</span> <span class="free">B</span> <span class="main">=</span> lang <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Closures-closure_seq"><span class="command">lemma</span></span> closure_seq <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"regular <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"regular <span class="free">B</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span><span class="free">A</span> <span class="main">⋅</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="skolem"><span class="skolem">r2</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"lang <span class="skolem">r1</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"lang <span class="skolem">r2</span> <span class="main">=</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⋅</span> <span class="free">B</span> <span class="main">=</span> lang <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span><span class="free">A</span> <span class="main">⋅</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Closures-closure_star"><span class="command">lemma</span></span> closure_star <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"regular <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span><span class="free">A</span><span class="main">⋆</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"lang <span class="skolem">r</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">⋆</span> <span class="main">=</span> lang <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span><span class="free">A</span><span class="main">⋆</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Closure under complementation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Closure under complementation is proved via the 
  Myhill-Nerode theorem›</span></span>

<span class="keyword1" id="Closures-closure_complement"><span class="command">lemma</span></span> closure_complement <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> lang"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"regular <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span><span class="main">-</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Myhill_Nerode<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="main">(</span><span class="main">-</span><span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> str_eq_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span><span class="main">-</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Myhill_Nerode<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Closure under <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>-›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>∩›</span></span></span></span>›</span></span>

<span class="keyword1" id="Closures-closure_difference"><span class="command">lemma</span></span> closure_difference <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> lang"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"regular <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"regular <span class="free">B</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">-</span> <span class="free">B</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span><span class="main">-</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="main">-</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Closures-closure_intersection"><span class="command">lemma</span></span> closure_intersection <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> lang"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"regular <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"regular <span class="free">B</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span><span class="main">-</span> <span class="free">A</span> <span class="main">∪</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="main">-</span> <span class="free">A</span> <span class="main">∪</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Closure under string reversal›</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">Rev</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Rev</span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Rev</span> One <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Rev</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> Atom <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Rev</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">Rev</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">Rev</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Rev</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> Times <span class="main">(</span><span class="free">Rev</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">Rev</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Rev</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Star <span class="main">(</span><span class="free">Rev</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Closures-rev_seq"><span class="command">lemma</span></span> rev_seq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rev <span class="main">`</span> <span class="main">(</span><span class="free">B</span> <span class="main">⋅</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>rev <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span>rev <span class="main">`</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> conc_def image_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> rev_append<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Closures-rev_star1"><span class="command">lemma</span></span> rev_star1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="main">(</span>rev <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">⋆</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> rev <span class="main">`</span> <span class="main">(</span><span class="free">A</span><span class="main">⋆</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> a
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> star_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>append <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span>rev<span class="main">::</span><span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">∈</span> rev <span class="main">`</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">∈</span> rev <span class="main">`</span> <span class="main">(</span><span class="free">A</span><span class="main">⋆</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x1</span></span> <span class="skolem"><span class="skolem">x2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x2</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eqs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">=</span> rev <span class="skolem">x1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">=</span> rev <span class="skolem">x2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x2</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x2</span> <span class="main">@</span> <span class="skolem">x1</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rev <span class="main">(</span><span class="skolem">x2</span> <span class="main">@</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">∈</span> rev <span class="main">`</span> <span class="free">A</span><span class="main">⋆</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inj <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> inj_image_mem_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">@</span> <span class="skolem">s2</span> <span class="main">∈</span>  rev <span class="main">`</span> <span class="free">A</span><span class="main">⋆</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eqs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Closures-rev_star2"><span class="command">lemma</span></span> rev_star2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⋆</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">s</span> <span class="main">∈</span> <span class="main">(</span>rev <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">⋆</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> a
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> star_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>append <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span>rev<span class="main">::</span><span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">∈</span> <span class="free">A</span>"</span></span><span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rev <span class="skolem">s1</span> <span class="main">∈</span> rev <span class="main">`</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inj <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> inj_image_mem_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rev <span class="skolem">s1</span> <span class="main">∈</span> <span class="main">(</span>rev <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">⋆</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rev <span class="skolem">s2</span> <span class="main">∈</span> <span class="main">(</span>rev <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">⋆</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rev <span class="main">(</span><span class="skolem">s1</span> <span class="main">@</span> <span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span>  <span class="main">(</span>rev <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">⋆</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Closures-rev_star"><span class="command">lemma</span></span> rev_star <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">" rev <span class="main">`</span> <span class="main">(</span><span class="free">A</span><span class="main">⋆</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>rev <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">⋆</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> rev_star1 rev_star2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Closures-rev_lang"><span class="command">lemma</span></span> rev_lang<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rev <span class="main">`</span> <span class="main">(</span>lang <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lang <span class="main">(</span>Rev <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_Un<span class="main">)</span>

<span class="keyword1" id="Closures-closure_reversal"><span class="command">lemma</span></span> closure_reversal <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"regular <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span>rev <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> lang <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>Rev <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> rev <span class="main">`</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_lang<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span>rev<span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Closure under left-quotients›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Deriv_lang</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> Derivs <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>

<span class="keyword1" id="Closures-closure_left_quotient"><span class="command">lemma</span></span> closure_left_quotient<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"regular <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span>Deriv_lang <span class="free">B</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="skolem">r</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pderivs_lang <span class="free">B</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_pderivs_lang<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Deriv_lang <span class="free">B</span> <span class="main">(</span>lang <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>lang <span class="main">`</span> pderivs_lang <span class="free">B</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derivs_pderivs pderivs_lang_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lang <span class="main">(</span><span class="main">⨄</span><span class="main">(</span>pderivs_lang <span class="free">B</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fin <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Deriv_lang <span class="free">B</span> <span class="free">A</span> <span class="main">=</span> lang <span class="main">(</span><span class="main">⨄</span><span class="main">(</span>pderivs_lang <span class="free">B</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span>Deriv_lang <span class="free">B</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Finite and co-finite sets are regular›</span></span>

<span class="keyword1" id="Closures-singleton_regular"><span class="command">lemma</span></span> singleton_regular<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">=</span> lang <span class="main">(</span>One<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">{</span><span class="skolem">s</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">=</span> lang <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">}</span> <span class="main">=</span> lang <span class="main">(</span>Times <span class="main">(</span>Atom <span class="skolem">c</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conc_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">{</span><span class="skolem">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Closures-finite_regular"><span class="command">lemma</span></span> finite_regular<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"regular <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">=</span> lang <span class="main">(</span>Zero<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">s</span> <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">{</span><span class="skolem">s</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> singleton_regular<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span><span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> closure_union<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span>insert <span class="skolem">s</span> <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Closures-cofinite_regular"><span class="command">lemma</span></span> cofinite_regular<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>finite lang"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">-</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"regular <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span><span class="main">-</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_regular<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="main">-</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> closure_complement<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"regular <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Continuation lemma for showing non-regularity of languages›</span></span>

<span class="keyword1" id="Closures-continuation_lemma"><span class="command">lemma</span></span> continuation_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="free">B</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>finite lang"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> reg<span class="main">:</span> <span class="quoted"><span class="quoted">"regular <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     inf<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≈</span><span class="free">A</span> <span class="bound">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">eqfun</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">eqfun</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">x</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite list<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">≈</span><span class="bound">A</span><span class="main">)</span> <span class="main">``</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span><span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Myhill_Nerode<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">eqfun</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> <span class="free">B</span> <span class="main">⊆</span> UNIV <span class="main">//</span> <span class="main">(</span><span class="main">≈</span><span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eqfun_def quotient_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span><span class="skolem">eqfun</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev_finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> infinite <span class="main">{</span><span class="bound"><span class="bound">b</span></span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="skolem">eqfun</span> <span class="free">A</span> <span class="bound">b</span> <span class="main">=</span> <span class="skolem">eqfun</span> <span class="free">A</span> <span class="bound">a</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pigeonhole_infinite<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> in_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound"><span class="bound">b</span></span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="skolem">eqfun</span> <span class="free">A</span> <span class="bound">b</span> <span class="main">=</span> <span class="skolem">eqfun</span> <span class="free">A</span> <span class="skolem">a</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">b</span></span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="skolem">eqfun</span> <span class="free">A</span> <span class="bound">b</span> <span class="main">=</span> <span class="skolem">eqfun</span> <span class="free">A</span> <span class="skolem">a</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">b</span></span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="bound">b</span> <span class="main">≈</span><span class="free">A</span> <span class="skolem">a</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eqfun_def Image_def str_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound"><span class="bound">b</span></span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="bound">b</span> <span class="main">≈</span><span class="free">A</span> <span class="skolem">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">b</span></span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="bound">b</span> <span class="main">≈</span><span class="free">A</span> <span class="skolem">a</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">b</span></span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="bound">b</span> <span class="main">≈</span><span class="free">A</span> <span class="skolem">a</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">b</span></span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="bound">b</span> <span class="main">≈</span><span class="free">A</span> <span class="skolem">a</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main">≠</span> <span class="skolem">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound"><span class="bound">b</span></span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="bound">b</span> <span class="main">≈</span><span class="free">A</span> <span class="skolem">a</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main">≠</span> <span class="skolem">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">b</span></span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="bound">b</span> <span class="main">≈</span><span class="free">A</span> <span class="skolem">a</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main">≠</span> <span class="skolem">a</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite.emptyI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≠</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≈</span><span class="free">A</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> in_a <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≈</span><span class="free">A</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The language <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a<span class="hidden">⇧</span><sup>n</sup> b<span class="hidden">⇧</span><sup>n</sup>›</span></span></span></span> is not regular›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">replicate_rev</span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">^^^</span> _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span> 100<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free">^^^</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1" id="Closures-an_bn_not_regular"><span class="command">lemma</span></span> an_bn_not_regular<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> regular <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="main">{</span><span class="keyword1">CHR</span> <span class="inner_quoted">''a''</span> <span class="main">^^^</span> <span class="bound">n</span> <span class="main">@</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''b''</span> <span class="main">^^^</span> <span class="bound">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="main">{</span><span class="keyword1">CHR</span> <span class="inner_quoted">''a''</span> <span class="main">^^^</span> <span class="bound">n</span> <span class="main">@</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''b''</span> <span class="main">^^^</span> <span class="bound">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"regular <span class="skolem">A</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="main">{</span><span class="keyword1">CHR</span> <span class="inner_quoted">''a''</span> <span class="main">^^^</span> <span class="bound">n</span><span class="main">}</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> sameness<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''a''</span> <span class="main">^^^</span> <span class="bound">i</span> <span class="main">@</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''b''</span> <span class="main">^^^</span> <span class="bound">j</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">⟷</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">j</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> A_def 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule_tac</span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">(=)</span> <span class="main">(</span><span class="keyword1">CHR</span> <span class="inner_quoted">''a''</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">(=)</span> <span class="main">(</span><span class="keyword1">CHR</span> <span class="inner_quoted">''b''</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> arg_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> infinite_iff_countable_subset
    <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def B_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''a''</span> <span class="main">^^^</span> <span class="bound">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">B</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="main">(</span><span class="bound">x</span> <span class="main">≈</span><span class="skolem">A</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> B_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> str_eq_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="keyword1">CHR</span> <span class="inner_quoted">''b''</span> <span class="main">^^^</span> <span class="improper">xa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sameness<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> continuation_lemma<span class="main">[</span><span class="operator">OF</span> as<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Closures2">
<div class="head">
<h1>Theory Closures2</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Closures2
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="Closures.html">Closures</a>
  <a href="../Well_Quasi_Orders/Well_Quasi_Orders.html">Well_Quasi_Orders.Well_Quasi_Orders</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Closure under <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SUBSEQ›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SUPSEQ›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Properties about the embedding relation›</span></span>

<span class="keyword1" id="Closures2-subseq_strict_length"><span class="command">lemma</span></span> subseq_strict_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"subseq <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">x</span> <span class="main">&lt;</span> length <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> a
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_Suc_eq<span class="main">)</span>

<span class="keyword1" id="Closures2-subseq_wf"><span class="command">lemma</span></span> subseq_wf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> subseq <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>measure length<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> subseq <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span><span class="main">}</span> <span class="main">⊆</span> measure length"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> measure_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subseq_strict_length<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> subseq <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Closures2-subseq_good"><span class="command">lemma</span></span> subseq_good<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"good subseq <span class="main">(</span><span class="free">f</span> <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> list<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> wqo_on_imp_good<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">f</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> wqo_on_lists_over_finite_sets<span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Closures2-subseq_Higman_antichains"><span class="command">lemma</span></span> subseq_Higman_antichains<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> list<span class="main">)</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="main">¬</span><span class="main">(</span>subseq <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span>subseq <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"infinite <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>finite list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="skolem">f</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> infinite_iff_countable_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> subseq_good<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">f</span>"</span></span><span class="main">]</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"subseq <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">f</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">j</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> good_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">f</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b d <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">j</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>subseq <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> e <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sub- and Supersequences›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">SUBSEQ</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">x</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> list<span class="main">.</span> <span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> subseq <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">SUPSEQ</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">x</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> list<span class="main">.</span> <span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> subseq <span class="bound">y</span> <span class="bound">x</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Closures2-SUPSEQ_simps"><span class="command">lemma</span></span> SUPSEQ_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SUPSEQ <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"SUPSEQ <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">=</span> UNIV"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> SUPSEQ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Closures2-SUPSEQ_atom"><span class="command">lemma</span></span> SUPSEQ_atom <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SUPSEQ <span class="main">{</span><span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">}</span> <span class="main">=</span> UNIV <span class="main">⋅</span> <span class="main">{</span><span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">}</span> <span class="main">⋅</span> UNIV"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> SUPSEQ_def conc_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_emb_ConsD<span class="main">)</span>

<span class="keyword1" id="Closures2-SUPSEQ_union"><span class="command">lemma</span></span> SUPSEQ_union <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SUPSEQ <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> SUPSEQ <span class="free">A</span> <span class="main">∪</span> SUPSEQ <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> SUPSEQ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Closures2-SUPSEQ_conc"><span class="command">lemma</span></span> SUPSEQ_conc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SUPSEQ <span class="main">(</span><span class="free">A</span> <span class="main">⋅</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> SUPSEQ <span class="free">A</span> <span class="main">⋅</span> SUPSEQ <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> SUPSEQ_def conc_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> list_emb_appendD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_emb_append_mono<span class="main">)</span>

<span class="keyword1" id="Closures2-SUPSEQ_star"><span class="command">lemma</span></span> SUPSEQ_star <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SUPSEQ <span class="main">(</span><span class="free">A</span><span class="main">⋆</span><span class="main">)</span> <span class="main">=</span> UNIV"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> star_unfold_left<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> SUPSEQ_union<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Regular expression that recognises every character›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">Allreg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>finite rexp"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Allreg</span> <span class="main">≡</span> <span class="main">⨄</span><span class="main">(</span>Atom <span class="main">`</span> UNIV<span class="main">)</span>"</span></span>

<span class="keyword1" id="Closures2-Allreg_lang"><span class="command">lemma</span></span> Allreg_lang <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang Allreg <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span><span class="main">[</span><span class="bound">a</span><span class="main">]</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Allreg_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span><span class="main">[</span><span class="bound">a</span><span class="main">]</span><span class="main">}</span><span class="main">)</span><span class="main">⋆</span> <span class="main">=</span> UNIV"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="improper">a</span><span class="main">]</span> <span class="main">@</span> <span class="improper">list</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span><span class="main">[</span><span class="bound">a</span><span class="main">]</span><span class="main">}</span><span class="main">)</span><span class="main">⋆</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> append_in_starI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Closures2-Star_Allreg_lang"><span class="command">lemma</span></span> Star_Allreg_lang <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>Star Allreg<span class="main">)</span> <span class="main">=</span> UNIV"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">UP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>finite rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">UP</span> <span class="main">(</span>Zero<span class="main">)</span> <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">UP</span> <span class="main">(</span>One<span class="main">)</span> <span class="main">=</span> Star Allreg"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">UP</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> Times <span class="main">(</span>Star Allreg<span class="main">)</span> <span class="main">(</span>Times <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>Star Allreg<span class="main">)</span><span class="main">)</span>"</span></span>   
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">UP</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">UP</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">UP</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">UP</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> Times <span class="main">(</span><span class="free">UP</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">UP</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">UP</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Star Allreg"</span></span>

<span class="keyword1" id="Closures2-lang_UP"><span class="command">lemma</span></span> lang_UP<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">r</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>finite rexp"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>UP <span class="free">r</span><span class="main">)</span> <span class="main">=</span> SUPSEQ <span class="main">(</span>lang <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Closures2-SUPSEQ_regular"><span class="command">lemma</span></span> SUPSEQ_regular<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>finite lang"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"regular <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span>SUPSEQ <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>finite rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"lang <span class="skolem">r</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>UP <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> SUPSEQ <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lang_UP<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span>SUPSEQ <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Closures2-SUPSEQ_subset"><span class="command">lemma</span></span> SUPSEQ_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>finite list set"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> SUPSEQ <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> SUPSEQ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Closures2-SUBSEQ_complement"><span class="command">lemma</span></span> SUBSEQ_complement<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="main">(</span>SUBSEQ <span class="free">A</span><span class="main">)</span> <span class="main">=</span> SUPSEQ <span class="main">(</span><span class="main">-</span> <span class="main">(</span>SUBSEQ <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="main">(</span>SUBSEQ <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span> SUPSEQ <span class="main">(</span><span class="main">-</span> <span class="main">(</span>SUBSEQ <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SUPSEQ_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SUPSEQ <span class="main">(</span><span class="main">-</span> <span class="main">(</span>SUBSEQ <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">-</span> <span class="main">(</span>SUBSEQ <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>SUPSEQ <span class="main">(</span><span class="main">-</span> <span class="main">(</span>SUBSEQ <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">-</span> <span class="main">(</span>SUBSEQ <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
       a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> SUPSEQ <span class="main">(</span><span class="main">-</span> <span class="main">(</span>SUBSEQ <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
       b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="main">-</span> <span class="main">(</span>SUBSEQ <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> a <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">-</span> <span class="main">(</span>SUBSEQ <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"subseq <span class="skolem">y</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SUPSEQ_def<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> SUBSEQ <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"subseq <span class="skolem">x</span> <span class="skolem">x'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SUBSEQ_def<span class="main">)</span>
    
    <span class="keyword1"><span class="command">from</span></span> d e <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subseq <span class="skolem">y</span> <span class="skolem">x'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subseq_order.order_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> SUBSEQ <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SUBSEQ_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> c <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="main">(</span>SUBSEQ <span class="free">A</span><span class="main">)</span> <span class="main">=</span> SUPSEQ <span class="main">(</span><span class="main">-</span> <span class="main">(</span>SUBSEQ <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">minimal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>finite list <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minimal</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> subseq <span class="bound">y</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟶</span> subseq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">y</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Closures2-main_lemma"><span class="command">lemma</span></span> main_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">M</span><span class="main">.</span> finite <span class="bound">M</span> <span class="main">∧</span> SUPSEQ <span class="free">A</span> <span class="main">=</span> SUPSEQ <span class="bound">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> minimal <span class="bound">x</span> <span class="free">A</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">M</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> M_def minimal_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subseq_Higman_antichains<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subseq_order.antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SUPSEQ <span class="free">A</span> <span class="main">⊆</span> SUPSEQ <span class="skolem">M</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> SUPSEQ <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"subseq <span class="skolem">y</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SUPSEQ_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">y'</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> subseq <span class="bound">y'</span> <span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"subseq <span class="skolem">z</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> subseq <span class="bound">y</span> <span class="skolem">z</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">≠</span> <span class="skolem">z</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∉</span> <span class="main">{</span><span class="bound"><span class="bound">y'</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> subseq <span class="bound">y'</span> <span class="skolem">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wfE_min<span class="main">[</span><span class="operator">OF</span> subseq_wf a<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">M</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> M_def minimal_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subseq_order.order_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> b<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> SUPSEQ <span class="skolem">M</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SUPSEQ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SUPSEQ <span class="skolem">M</span> <span class="main">⊆</span> SUPSEQ <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SUPSEQ_def M_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">M</span><span class="main">.</span> finite <span class="bound">M</span> <span class="main">∧</span> SUPSEQ <span class="free">A</span> <span class="main">=</span> SUPSEQ <span class="bound">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Closure of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> SUBSEQ<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> SUPSEQ<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="Closures2-closure_SUPSEQ"><span class="command">lemma</span></span> closure_SUPSEQ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>finite lang"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span>SUPSEQ <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"SUPSEQ <span class="free">A</span> <span class="main">=</span> SUPSEQ <span class="skolem">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> main_lemma <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_regular<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span>SUPSEQ <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SUPSEQ_regular<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span>SUPSEQ <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Closures2-closure_SUBSEQ"><span class="command">lemma</span></span> closure_SUBSEQ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>finite lang"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span>SUBSEQ <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span>SUPSEQ <span class="main">(</span><span class="main">-</span> SUBSEQ <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> closure_SUPSEQ<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span><span class="main">-</span> SUBSEQ <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> SUBSEQ_complement<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span>SUBSEQ <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> closure_complement<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span>SUBSEQ <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Non_Regular_Languages">
<div class="head">
<h1>Theory Non_Regular_Languages</h1>
</div>
<pre class="source"><span class="comment1">(* 
  File:     Non_Regular_Languages.thy
  Author:   Manuel Eberl &lt;eberlm@in.tum.de&gt;
  
  This file provides some tools for showing the non-regularity of a language, either 
  via an infinite set of equivalence classes or via the Pumping Lemma.
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Tools for showing non-regularity of a language›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Non_Regular_Languages
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Myhill.html">Myhill</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary material›</span></span>

<span class="keyword1" id="Non_Regular_Languages-bij_betw_image_quotient"><span class="command">lemma</span></span> bij_betw_image_quotient<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">//</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def inj_on_def image_image quotient_def<span class="main">)</span>
   
<span class="keyword1" id="Non_Regular_Languages-regular_Derivs_finite"><span class="command">lemma</span></span> regular_Derivs_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> finite rexp"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> Derivs <span class="bound">w</span> <span class="main">(</span>lang <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="main">⟷</span> finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span>lang <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> str_eq_conv_Derivs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_finite bij_betw_image_quotient<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Myhill_Nerode <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="Non_Regular_Languages-Nil_in_Derivs_iff"><span class="command">lemma</span></span> Nil_in_Derivs_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> Derivs <span class="free">w</span> <span class="free">A</span> <span class="main">⟷</span> <span class="free">w</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Derivs_def<span class="main">)</span>

<span class="comment1">(* TODO: Move to distribution? *)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following operation repeats a list $n$ times (usually written as $w ^ n$).
›</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">repeat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">repeat</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">repeat</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="free">repeat</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
  
<span class="keyword1" id="Non_Regular_Languages-repeat_Cons_left"><span class="command">lemma</span></span> repeat_Cons_left<span class="main">:</span> <span class="quoted"><span class="quoted">"repeat <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> repeat <span class="free">n</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
<span class="keyword1" id="Non_Regular_Languages-repeat_Cons_right"><span class="command">lemma</span></span> repeat_Cons_right<span class="main">:</span> <span class="quoted"><span class="quoted">"repeat <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> repeat <span class="free">n</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    
<span class="keyword1" id="Non_Regular_Languages-repeat_Cons_append_commute"><span class="command">lemma</span></span> repeat_Cons_append_commute <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"repeat <span class="free">n</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> repeat <span class="free">n</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> repeat_Cons_right <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    
<span class="keyword1" id="Non_Regular_Languages-repeat_Cons_add"><span class="command">lemma</span></span> repeat_Cons_add <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"repeat <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> repeat <span class="free">m</span> <span class="free">xs</span> <span class="main">@</span> repeat <span class="free">n</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    
<span class="keyword1" id="Non_Regular_Languages-repeat_Nil"><span class="command">lemma</span></span> repeat_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"repeat <span class="free">n</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    
<span class="keyword1" id="Non_Regular_Languages-repeat_conv_replicate"><span class="command">lemma</span></span> repeat_conv_replicate<span class="main">:</span> <span class="quoted"><span class="quoted">"repeat <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span> concat <span class="main">(</span>replicate <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">simp_all</span>

    
<span class="comment1">(* TODO: Move to distribution? *)</span>
<span class="keyword1" id="Non_Regular_Languages-nth_prefixes"><span class="command">lemma</span></span> nth_prefixes <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span> prefixes <span class="free">xs</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> take <span class="free">n</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
    
<span class="keyword1" id="Non_Regular_Languages-nth_suffixes"><span class="command">lemma</span></span> nth_suffixes <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span> suffixes <span class="free">xs</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> suffixes_conv_prefixes<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_take<span class="main">)</span>

<span class="keyword1" id="Non_Regular_Languages-length_take_prefixes"><span class="command">lemma</span></span> length_take_prefixes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="free">n</span> <span class="main">(</span>prefixes <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> Suc <span class="main">(</span>length <span class="free">ys</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> take <span class="skolem">i</span> <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> nth_image <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≤</span> length <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prefix_length_le<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Non-regularity by giving an infinite set of equivalence classes›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Non-regularity can be shown by giving an infinite set of non-equivalent words (w.r.t. the 
  Myhill--Nerode relation).
›</span></span>
<span class="keyword1" id="Non_Regular_Languages-not_regular_langI"><span class="command">lemma</span></span> not_regular_langI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"infinite <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="bound">x</span> <span class="main">@</span> <span class="bound">w</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟷</span> <span class="bound">y</span> <span class="main">@</span> <span class="bound">w</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span>regular_lang <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> finite list set<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> Derivs <span class="bound">w</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> <span class="free">B</span> <span class="main">⊆</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> Derivs <span class="bound">w</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> Derivs <span class="bound">w</span> <span class="free">A</span><span class="main">)</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def Derivs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> Derivs <span class="bound">w</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_imageD<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> Derivs <span class="bound">w</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> infinite_super<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> regular_Derivs_finite <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Non_Regular_Languages-not_regular_langI'"><span class="command">lemma</span></span> not_regular_langI'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"infinite <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">@</span> <span class="bound">w</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟷</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">@</span> <span class="bound">w</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span>regular_lang <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> finite list set<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> not_regular_langI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹infinite <span class="free">B</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_image_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Pumping Lemma›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The Pumping lemma can be shown very easily from the Myhill--Nerode theorem: if we have 
  a word whose length is more than the (finite) number of equivalence classes, then it must 
  have two different prefixes in the same class and the difference between these two 
  prefixes can then be ``pumped''.
›</span></span>
<span class="keyword1" id="Non_Regular_Languages-pumping_lemma_aux"><span class="command">lemma</span></span> pumping_lemma_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">w</span><span class="main">.</span> Derivs <span class="bound">w</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≡</span> card <span class="main">(</span>range <span class="free">δ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">δ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">z</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span> <span class="bound">w</span><span class="main">.</span> <span class="free">z</span> <span class="main">=</span> <span class="bound">u</span> <span class="main">@</span> <span class="bound">v</span> <span class="main">@</span> <span class="bound">w</span> <span class="main">∧</span> length <span class="main">(</span><span class="bound">u</span> <span class="main">@</span> <span class="bound">v</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">u</span> <span class="main">@</span> repeat <span class="bound">i</span> <span class="bound">v</span> <span class="main">@</span> <span class="bound">w</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> set <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>prefixes <span class="free">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">z</span> <span class="main">≥</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">P</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> distinct_card<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> distinct_take<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> length_le<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">y</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> length_take_prefixes<span class="main">[</span><span class="operator">OF</span> that <span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> P_def<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">δ</span> <span class="main">`</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>range <span class="free">δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono assms<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> card <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>inj_on <span class="free">δ</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pigeonhole<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"Derivs <span class="skolem">a</span> <span class="free">A</span> <span class="main">=</span> Derivs <span class="skolem">b</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def δ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ab <span class="keyword1"><span class="command">have</span></span> prefix_ab<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix <span class="skolem">a</span> <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"prefix <span class="skolem">b</span> <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_takeD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ab <span class="keyword1"><span class="command">have</span></span> length_ab<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">a</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">b</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_le<span class="main">)</span>
      
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword2"><span class="keyword">if</span></span> uz'<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix <span class="skolem">u</span> <span class="skolem">z'</span>"</span></span> <span class="quoted"><span class="quoted">"prefix <span class="skolem">z'</span> <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">z'</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> 
            <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≠</span> <span class="skolem">z'</span>"</span></span> <span class="quoted"><span class="quoted">"Derivs <span class="skolem">z'</span> <span class="free">A</span> <span class="main">=</span> Derivs <span class="skolem">u</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span> <span class="skolem">z'</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹prefix <span class="skolem">u</span> <span class="skolem">z'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">≠</span> <span class="skolem">z'</span>›</span></span> 
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z'</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefix_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹prefix <span class="skolem">z'</span> <span class="free">z</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">w</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefix_def<span class="main">)</span>
      
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Derivs <span class="main">(</span>repeat <span class="skolem">i</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>Derivs <span class="skolem">u</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Derivs <span class="skolem">u</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> uz' <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Derivs <span class="free">z</span> <span class="free">A</span> <span class="main">=</span> Derivs <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> repeat <span class="skolem">i</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">w</span><span class="main">)</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">using</span></span> uz' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">z</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> uz' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">u</span> <span class="main">@</span> repeat <span class="bound">i</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nil_in_Derivs_iff <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">z'</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">from</span></span> prefix_ab <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">∨</span> prefix <span class="skolem">b</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prefix_same_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> *<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> ab <span class="keyword2"><span class="keyword">and</span></span> prefix_ab <span class="keyword2"><span class="keyword">and</span></span> length_ab <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> pumping_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> finite rexp"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">n</span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> lang <span class="free">r</span> <span class="main">⟹</span> length <span class="bound">z</span> <span class="main">≥</span> <span class="free">n</span> <span class="main">⟹</span> 
            <span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">u</span> <span class="main">@</span> <span class="bound">v</span> <span class="main">@</span> <span class="bound">w</span> <span class="main">∧</span> length <span class="main">(</span><span class="bound">u</span> <span class="main">@</span> <span class="bound">v</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">u</span> <span class="main">@</span> repeat <span class="bound">i</span> <span class="bound">v</span> <span class="main">@</span> <span class="bound">w</span> <span class="main">∈</span> lang <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> Derivs <span class="bound">w</span> <span class="main">(</span>lang <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span> <span class="bound">w</span><span class="main">.</span> <span class="skolem">z</span> <span class="main">=</span> <span class="bound">u</span> <span class="main">@</span> <span class="bound">v</span> <span class="main">@</span> <span class="bound">w</span> <span class="main">∧</span> length <span class="main">(</span><span class="bound">u</span> <span class="main">@</span> <span class="bound">v</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?n</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">u</span> <span class="main">@</span> repeat <span class="bound">i</span> <span class="bound">v</span> <span class="main">@</span> <span class="bound">w</span> <span class="main">∈</span> lang <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> lang <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">z</span> <span class="main">≥</span> <span class="var">?n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pumping_lemma_aux<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">z</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> that regular_Derivs_finite<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">corollary</span></span> pumping_lemma_not_regular_lang<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> finite list set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> length <span class="main">(</span><span class="free">z</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≥</span> <span class="bound">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">z</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">u</span> <span class="bound">v</span> <span class="bound">w</span><span class="main">.</span> <span class="free">z</span> <span class="bound">n</span> <span class="main">=</span> <span class="bound">u</span> <span class="main">@</span> <span class="bound">v</span> <span class="main">@</span> <span class="bound">w</span> <span class="main">⟹</span> length <span class="main">(</span><span class="bound">u</span> <span class="main">@</span> <span class="bound">v</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">n</span> <span class="main">⟹</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> 
             <span class="bound">u</span> <span class="main">@</span> repeat <span class="main">(</span><span class="free">i</span> <span class="bound">n</span> <span class="bound">u</span> <span class="bound">v</span> <span class="bound">w</span><span class="main">)</span> <span class="bound">v</span> <span class="main">@</span> <span class="bound">w</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span>regular_lang <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"regular_lang <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="skolem">r</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> pumping_lemma<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> n <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="skolem">n</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">n</span></span></span></span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">w</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">u</span> <span class="main">@</span> repeat <span class="bound">i</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">w</span> <span class="main">∈</span> lang <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> r<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> r<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Examples›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The language of all words containing the same number of $a$s and $b$s is not regular.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>regular_lang <span class="main">{</span><span class="bound">w</span><span class="main">.</span> length <span class="main">(</span>filter id <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>filter Not <span class="bound">w</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>regular_lang <span class="var">?A</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> not_regular_langI'<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>UNIV <span class="main">::</span> nat set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≠</span> <span class="skolem">n</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"replicate <span class="skolem">m</span> True <span class="main">@</span> replicate <span class="skolem">m</span> False <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"replicate <span class="skolem">n</span> True <span class="main">@</span> replicate <span class="skolem">m</span> False <span class="main">∉</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span>replicate <span class="skolem">m</span> True <span class="main">@</span> <span class="bound">w</span> <span class="main">∈</span> <span class="var">?A</span> <span class="main">⟷</span> replicate <span class="skolem">n</span> True <span class="main">@</span> <span class="bound">w</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The language $\{a^i b^i\ |\ i \in \mathbb{N}\}$ is not regular.
›</span></span>
<span class="keyword1" id="Non_Regular_Languages-eq_replicate_iff"><span class="command">lemma</span></span> eq_replicate_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> replicate <span class="free">n</span> <span class="free">x</span> <span class="main">⟷</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∧</span> length <span class="free">xs</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> replicate_length_same<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eq_commute<span class="main">)</span> <span class="operator">auto</span>
    
<span class="keyword1" id="Non_Regular_Languages-replicate_eq_appendE"><span class="command">lemma</span></span> replicate_eq_appendE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">=</span> replicate <span class="free">n</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">i</span> <span class="free">j</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> replicate <span class="free">i</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> replicate <span class="free">j</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> length <span class="main">(</span>replicate <span class="free">n</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> assms <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">+</span> length <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> replicate <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> replicate <span class="main">(</span>length <span class="free">ys</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_replicate_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>regular_lang <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> replicate <span class="bound">i</span> True <span class="main">@</span> replicate <span class="bound">i</span> False<span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>regular_lang <span class="var">?A</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> pumping_lemma_not_regular_lang<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>replicate <span class="skolem">n</span> True <span class="main">@</span> replicate <span class="skolem">n</span> False<span class="main">)</span> <span class="main">≥</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"replicate <span class="skolem">n</span> True <span class="main">@</span> replicate <span class="skolem">n</span> False <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">u</span> <span class="skolem">v</span> <span class="skolem">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"replicate <span class="skolem">n</span> True <span class="main">@</span> replicate <span class="skolem">n</span> False <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">w</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> length_le<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">w1</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="main">=</span> take <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> length <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span> <span class="main">=</span> drop <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> length <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">w</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> w_decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">w1</span> <span class="main">@</span> <span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> w1_def w2_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"replicate <span class="skolem">n</span> True <span class="main">=</span> take <span class="skolem">n</span> <span class="main">(</span>replicate <span class="skolem">n</span> True <span class="main">@</span> replicate <span class="skolem">n</span> False<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> decomp
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">n</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">w1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> length_le <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> w1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">@</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">w1</span> <span class="main">=</span> replicate <span class="skolem">n</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">k</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> uvw1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">j</span> <span class="main">+</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> replicate <span class="skolem">i</span> True"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> replicate <span class="skolem">j</span> True"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="main">=</span> replicate <span class="skolem">k</span> True"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> replicate_eq_appendE<span class="main">)</span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"replicate <span class="skolem">n</span> False <span class="main">=</span> drop <span class="skolem">n</span> <span class="main">(</span>replicate <span class="skolem">n</span> True <span class="main">@</span> replicate <span class="skolem">n</span> False<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> decomp
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span> <span class="main">=</span> replicate <span class="skolem">n</span> False"</span></span> <span class="keyword1"><span class="command">using</span></span> length_le <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> w2_def<span class="main">)</span>
      
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">@</span> repeat <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">w</span> <span class="main">=</span> replicate <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span> True <span class="main">@</span> replicate <span class="skolem">n</span> False"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> uvw1 w_decomp replicate_add <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∉</span> <span class="var">?A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"replicate <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span> True <span class="main">@</span> replicate <span class="skolem">n</span> False <span class="main">=</span> 
                       replicate <span class="skolem">m</span> True <span class="main">@</span> replicate <span class="skolem">m</span> False"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="main">(</span>filter Not <span class="var">?lhs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> *
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter Not <span class="var">?rhs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> uvw1<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">@</span> repeat <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">w</span> <span class="main">∉</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>