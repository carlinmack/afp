<div id="Regular_Set">
<div class="head">
<h1>Theory Regular_Set</h1>
</div>
<pre class="source"><span class="comment1">(*  Author: Tobias Nipkow, Alex Krauss, Christian Urban  *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Regular sets"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Regular_Set
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> lang <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">conc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">@@</span>"</span> 75<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">@@</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">xs</span><span class="main">@</span><span class="bound">ys</span> <span class="main">|</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="bound">xs</span><span class="main">:</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">&amp;</span> <span class="bound">ys</span><span class="main">:</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹checks the code preprocessor for set comprehensions›</span></span>
<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">conc</span></span> <span class="keyword2"><span class="keyword">checking</span></span> SML

<span class="keyword1"><span class="command">overloading</span></span> lang_pow <span class="main">==</span> <span class="quoted"><span class="quoted">"compow <span class="main">::</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lang_pow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lang_pow</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">lang_pow</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">@@</span> <span class="main">(</span><span class="free">lang_pow</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹for code generation›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lang_pow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  lang_pow_code_def <span class="main">[</span><span class="operator">code_abbrev</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lang_pow</span> <span class="main">=</span> compow"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lang_pow <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span> <span class="main">@@</span> <span class="main">(</span>lang_pow <span class="free">n</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"lang_pow <span class="main">0</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lang_pow_code_def<span class="main">)</span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> lang_pow

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">star</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">star</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(@@)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="Regular_Set-concI"><span class="command">lemma</span></span> concI<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">:</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">:</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">u</span><span class="main">@</span><span class="free">v</span> <span class="main">:</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conc_def<span class="main">)</span>

<span class="keyword1" id="Regular_Set-concE"><span class="command">lemma</span></span> concE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> 
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u</span> <span class="free">v</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">u</span><span class="main">@</span><span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_def<span class="main">)</span>

<span class="keyword1" id="Regular_Set-conc_mono"><span class="command">lemma</span></span> conc_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">C</span> <span class="main">@@</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_def<span class="main">)</span> 

<span class="keyword1" id="Regular_Set-conc_empty"><span class="command">lemma</span></span> conc_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">@@</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">@@</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Regular_Set-conc_epsilon"><span class="command">lemma</span></span> conc_epsilon<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">@@</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">@@</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>conc_def<span class="main">)</span>

<span class="keyword1" id="Regular_Set-conc_assoc"><span class="command">lemma</span></span> conc_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span> <span class="main">@@</span> <span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="main">@@</span> <span class="main">(</span><span class="free">B</span> <span class="main">@@</span> <span class="free">C</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> concE<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> append_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> concI<span class="main">)</span>

<span class="keyword1" id="Regular_Set-conc_Un_distrib"><span class="command">lemma</span></span> conc_Un_distrib<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">@@</span> <span class="main">(</span><span class="free">B</span> <span class="main">∪</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span> <span class="main">∪</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">C</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">@@</span> <span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">C</span> <span class="main">∪</span> <span class="free">B</span> <span class="main">@@</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Regular_Set-conc_UNION_distrib"><span class="command">lemma</span></span> conc_UNION_distrib<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">@@</span> <span class="main">⋃</span><span class="main">(</span><span class="free">M</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">%</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">M</span> <span class="bound">i</span><span class="main">)</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="free">M</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span> <span class="main">@@</span> <span class="free">A</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">%</span><span class="bound">i</span><span class="main">.</span> <span class="free">M</span> <span class="bound">i</span> <span class="main">@@</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Regular_Set-conc_subset_lists"><span class="command">lemma</span></span> conc_subset_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> lists <span class="free">S</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> lists <span class="free">S</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span> <span class="main">⊆</span> lists <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_def in_lists_conv_set<span class="main">)</span>

<span class="keyword1" id="Regular_Set-Nil_in_conc"><span class="command">lemma</span></span> Nil_in_conc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span> <span class="main">⟷</span> <span class="main">[]</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="main">[]</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_is_Nil_conv concE concI<span class="main">)</span>

<span class="keyword1" id="Regular_Set-concI_if_Nil1"><span class="command">lemma</span></span> concI_if_Nil1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">:</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil concI<span class="main">)</span>

<span class="keyword1" id="Regular_Set-conc_Diff_if_Nil1"><span class="command">lemma</span></span> conc_Diff_if_Nil1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span> <span class="main">@@</span> <span class="free">B</span> <span class="main">∪</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> concI_if_Nil1<span class="main">)</span>

<span class="keyword1" id="Regular_Set-concI_if_Nil2"><span class="command">lemma</span></span> concI_if_Nil2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">:</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil2 concI<span class="main">)</span>

<span class="keyword1" id="Regular_Set-conc_Diff_if_Nil2"><span class="command">lemma</span></span> conc_Diff_if_Nil2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span> <span class="main">=</span> <span class="free">A</span> <span class="main">@@</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> concI_if_Nil2<span class="main">)</span>

<span class="keyword1" id="Regular_Set-singleton_in_conc"><span class="command">lemma</span></span> singleton_in_conc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">:</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span> <span class="main">⟷</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">:</span> <span class="free">A</span> <span class="main">∧</span> <span class="main">[]</span> <span class="main">:</span> <span class="free">B</span> <span class="main">∨</span> <span class="main">[]</span> <span class="main">:</span> <span class="free">A</span> <span class="main">∧</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">:</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons_eq_append_conv append_eq_Cons_conv
       conc_Diff_if_Nil1 conc_Diff_if_Nil2<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span> <span class="main"><span class="main">^^</span></span> <span class="free"><span class="free">n</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="Regular_Set-lang_pow_add"><span class="command">lemma</span></span> lang_pow_add<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">^^</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">^^</span> <span class="free">n</span> <span class="main">@@</span> <span class="free">A</span> <span class="main">^^</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_assoc<span class="main">)</span>

<span class="keyword1" id="Regular_Set-lang_pow_empty"><span class="command">lemma</span></span> lang_pow_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">^^</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Regular_Set-lang_pow_empty_Suc"><span class="command">lemma</span></span> lang_pow_empty_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{}</span><span class="main">::</span><span class="tfree">'a</span> lang<span class="main">)</span> <span class="main">^^</span> Suc <span class="free">n</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lang_pow_empty<span class="main">)</span>

<span class="keyword1" id="Regular_Set-conc_pow_comm"><span class="command">lemma</span></span> conc_pow_comm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="main">@@</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conc_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Regular_Set-length_lang_pow_ub"><span class="command">lemma</span></span> length_lang_pow_ub<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> length <span class="bound">w</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">:</span> <span class="free">A</span><span class="main">^^</span><span class="free">n</span> <span class="main">⟹</span> length <span class="free">w</span> <span class="main">≤</span> <span class="free">k</span><span class="main">*</span><span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Regular_Set-length_lang_pow_lb"><span class="command">lemma</span></span> length_lang_pow_lb<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> length <span class="bound">w</span> <span class="main">≥</span> <span class="free">k</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">:</span> <span class="free">A</span><span class="main">^^</span><span class="free">n</span> <span class="main">⟹</span> length <span class="free">w</span> <span class="main">≥</span> <span class="free">k</span><span class="main">*</span><span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Regular_Set-lang_pow_subset_lists"><span class="command">lemma</span></span> lang_pow_subset_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> lists <span class="free">S</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">^^</span> <span class="free">n</span> <span class="main">⊆</span> lists <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_subset_lists<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> star<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="Regular_Set-star_subset_lists"><span class="command">lemma</span></span> star_subset_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> lists <span class="free">S</span> <span class="main">⟹</span> star <span class="free">A</span> <span class="main">⊆</span> lists <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> star_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lang_pow_subset_lists<span class="main">)</span>

<span class="keyword1" id="Regular_Set-star_if_lang_pow"><span class="command">lemma</span></span> star_if_lang_pow<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">:</span> <span class="free">A</span> <span class="main">^^</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">:</span> star <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> star_def<span class="main">)</span>

<span class="keyword1" id="Regular_Set-Nil_in_star"><span class="command">lemma</span></span> Nil_in_star<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">:</span> star <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> star_if_lang_pow<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">:</span> <span class="free">A</span> <span class="main">^^</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Regular_Set-star_if_lang"><span class="command">lemma</span></span> star_if_lang<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">:</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">:</span> star <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> star_if_lang_pow<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">:</span> <span class="free">A</span> <span class="main">^^</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">:</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Regular_Set-append_in_starI"><span class="command">lemma</span></span> append_in_starI<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">:</span> star <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">:</span> star <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">@</span><span class="free">v</span> <span class="main">:</span> star <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">:</span> star <span class="free">A</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">:</span> <span class="free">A</span> <span class="main">^^</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> star_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">:</span> star <span class="free">A</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">:</span> <span class="free">A</span> <span class="main">^^</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> star_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">@</span><span class="free">v</span> <span class="main">:</span> <span class="free">A</span> <span class="main">^^</span> <span class="main">(</span><span class="skolem">m</span><span class="main">+</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lang_pow_add<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Regular_Set-conc_star_star"><span class="command">lemma</span></span> conc_star_star<span class="main">:</span> <span class="quoted"><span class="quoted">"star <span class="free">A</span> <span class="main">@@</span> star <span class="free">A</span> <span class="main">=</span> star <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_def<span class="main">)</span>

<span class="keyword1" id="Regular_Set-conc_star_comm"><span class="command">lemma</span></span> conc_star_comm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">@@</span> star <span class="free">A</span> <span class="main">=</span> star <span class="free">A</span> <span class="main">@@</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> star_def conc_pow_comm conc_UNION_distrib
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Regular_Set-star_induct"><span class="command">lemma</span></span> star_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Nil append<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> star<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">:</span> star <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">u</span> <span class="main">:</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">v</span> <span class="main">:</span> star <span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">u</span><span class="main">@</span><span class="bound">v</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">:</span> <span class="free">A</span> <span class="main">^^</span> <span class="skolem">n</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">[]</span>›</span></span> step star_if_lang_pow<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">:</span> star <span class="free">A</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> star_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Regular_Set-star_empty"><span class="command">lemma</span></span> star_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"star <span class="main">{}</span> <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> star_induct<span class="main">)</span>

<span class="keyword1" id="Regular_Set-star_epsilon"><span class="command">lemma</span></span> star_epsilon<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"star <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> star_induct<span class="main">)</span>

<span class="keyword1" id="Regular_Set-star_idemp"><span class="command">lemma</span></span> star_idemp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"star <span class="main">(</span>star <span class="free">A</span><span class="main">)</span> <span class="main">=</span> star <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> star_induct<span class="main">)</span>

<span class="keyword1" id="Regular_Set-star_unfold_left"><span class="command">lemma</span></span> star_unfold_left<span class="main">:</span> <span class="quoted"><span class="quoted">"star <span class="free">A</span> <span class="main">=</span> <span class="free">A</span> <span class="main">@@</span> star <span class="free">A</span> <span class="main">∪</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> star_induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Regular_Set-concat_in_star"><span class="command">lemma</span></span> concat_in_star<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">ws</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> concat <span class="free">ws</span> <span class="main">:</span> star <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ws</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Regular_Set-in_star_iff_concat"><span class="command">lemma</span></span> in_star_iff_concat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> star <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ws</span><span class="main">.</span> set <span class="bound">ws</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">=</span> concat <span class="bound">ws</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ws</span><span class="main">.</span> <span class="var">?R</span> <span class="free">w</span> <span class="bound">ws</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">:</span> star <span class="free">A</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ws</span><span class="main">.</span> <span class="var">?R</span> <span class="free">w</span> <span class="bound">ws</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>append <span class="skolem">u</span> <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ws</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> <span class="skolem">v</span> <span class="main">=</span> concat <span class="skolem">ws</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> append <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">v</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u</span><span class="main">#</span><span class="skolem">ws</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">us</span><span class="main">.</span> <span class="var">?R</span> <span class="free">w</span> <span class="bound">us</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">:</span> star <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> concat_in_star<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Regular_Set-star_conv_concat"><span class="command">lemma</span></span> star_conv_concat<span class="main">:</span> <span class="quoted"><span class="quoted">"star <span class="free">A</span> <span class="main">=</span> <span class="main">{</span>concat <span class="bound">ws</span><span class="main">|</span><span class="bound">ws</span><span class="main">.</span> set <span class="bound">ws</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_star_iff_concat<span class="main">)</span>

<span class="keyword1" id="Regular_Set-star_insert_eps"><span class="command">lemma</span></span> star_insert_eps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"star <span class="main">(</span>insert <span class="main">[]</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> star<span class="main">(</span><span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">us</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">us</span> <span class="main">⊆</span> insert <span class="main">[]</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">vs</span><span class="main">.</span> concat <span class="skolem">us</span> <span class="main">=</span> concat <span class="bound">vs</span> <span class="main">∧</span> set <span class="bound">vs</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">vs</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">vs</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?vs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">%</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">us</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">⟹</span> <span class="var">?Q</span> <span class="var">?vs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">us</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> star_conv_concat<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Regular_Set-star_unfold_left_Nil"><span class="command">lemma</span></span> star_unfold_left_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"star <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span> <span class="main">@@</span> <span class="main">(</span>star <span class="free">A</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_Diff_single star_insert_eps star_unfold_left<span class="main">)</span>

<span class="keyword1" id="Regular_Set-star_Diff_Nil_fold"><span class="command">lemma</span></span> star_Diff_Nil_fold<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span> <span class="main">@@</span> star <span class="free">A</span> <span class="main">=</span> star <span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∉</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span> <span class="main">@@</span> star <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> star_unfold_left_Nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Regular_Set-star_decom"><span class="command">lemma</span></span> star_decom<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> star <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">@</span> <span class="bound">b</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main">∈</span> star <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> star_induct<span class="main">)</span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Left-Quotients of languages›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Deriv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Deriv</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">xs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="bound">xs</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">}</span>"</span></span>
    
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Derivs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Derivs</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">ys</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">Derivss</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> lang set <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Derivss</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">≡</span> <span class="main">⋃</span> <span class="main">(</span>Derivs <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">As</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1" id="Regular_Set-Deriv_empty"><span class="command">lemma</span></span> Deriv_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"Deriv <span class="free">a</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Deriv_epsilon<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Deriv <span class="free">a</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Deriv_char<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>    <span class="quoted"><span class="quoted">"Deriv <span class="free">a</span> <span class="main">{</span><span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Deriv_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"Deriv <span class="free">a</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Deriv <span class="free">a</span> <span class="free">A</span> <span class="main">∪</span> Deriv <span class="free">a</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Deriv_inter<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"Deriv <span class="free">a</span> <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Deriv <span class="free">a</span> <span class="free">A</span> <span class="main">∩</span> Deriv <span class="free">a</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Deriv_compl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"Deriv <span class="free">a</span> <span class="main">(</span><span class="main">-</span><span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> Deriv <span class="free">a</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Deriv_Union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"Deriv <span class="free">a</span> <span class="main">(</span>Union <span class="free">M</span><span class="main">)</span> <span class="main">=</span> Union<span class="main">(</span>Deriv <span class="free">a</span> <span class="main">`</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Deriv_UN<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>      <span class="quoted"><span class="quoted">"Deriv <span class="free">a</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">x</span><span class="main">:</span><span class="free">I</span><span class="main">.</span> <span class="free">S</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">x</span><span class="main">:</span><span class="free">I</span><span class="main">.</span> Deriv <span class="free">a</span> <span class="main">(</span><span class="free">S</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Deriv_def<span class="main">)</span>

<span class="keyword1" id="Regular_Set-Der_conc"><span class="command">lemma</span></span> Der_conc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Deriv <span class="free">c</span> <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Deriv <span class="free">c</span> <span class="free">A</span><span class="main">)</span> <span class="main">@@</span> <span class="free">B</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">[]</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> Deriv <span class="free">c</span> <span class="free">B</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Deriv_def conc_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_eq_append_conv<span class="main">)</span>

<span class="keyword1" id="Regular_Set-Deriv_star"><span class="command">lemma</span></span> Deriv_star <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Deriv <span class="free">c</span> <span class="main">(</span>star <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Deriv <span class="free">c</span> <span class="free">A</span><span class="main">)</span> <span class="main">@@</span> star <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Deriv <span class="free">c</span> <span class="main">(</span>star <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Deriv <span class="free">c</span> <span class="main">(</span><span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">∪</span> <span class="free">A</span> <span class="main">@@</span> star <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> star_unfold_left sup.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Deriv <span class="free">c</span> <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> star <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Deriv_union <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>Deriv <span class="free">c</span> <span class="free">A</span><span class="main">)</span> <span class="main">@@</span> <span class="main">(</span>star <span class="free">A</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">[]</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> Deriv <span class="free">c</span> <span class="main">(</span>star <span class="free">A</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="main">(</span>Deriv <span class="free">c</span> <span class="free">A</span><span class="main">)</span> <span class="main">@@</span> star <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> conc_def Deriv_def
    <span class="keyword1"><span class="command">using</span></span> star_decom <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_eq_append_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Deriv <span class="free">c</span> <span class="main">(</span>star <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Deriv <span class="free">c</span> <span class="free">A</span><span class="main">)</span> <span class="main">@@</span> star <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Regular_Set-Deriv_diff"><span class="command">lemma</span></span> Deriv_diff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>   
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Deriv <span class="free">c</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Deriv <span class="free">c</span> <span class="free">A</span> <span class="main">-</span> Deriv <span class="free">c</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Deriv_def<span class="main">)</span>

<span class="keyword1" id="Regular_Set-Deriv_lists"><span class="command">lemma</span></span> Deriv_lists<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">:</span> <span class="free">S</span> <span class="main">⟹</span> Deriv <span class="free">c</span> <span class="main">(</span>lists <span class="free">S</span><span class="main">)</span> <span class="main">=</span> lists <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Deriv_def<span class="main">)</span>

<span class="keyword1" id="Regular_Set-Derivs_simps"><span class="command">lemma</span></span> Derivs_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Derivs <span class="main">[]</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"Derivs <span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="free">s</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> Derivs <span class="free">s</span> <span class="main">(</span>Deriv <span class="free">c</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"Derivs <span class="main">(</span><span class="free">s1</span> <span class="main">@</span> <span class="free">s2</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> Derivs <span class="free">s2</span> <span class="main">(</span>Derivs <span class="free">s1</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Derivs_def Deriv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Regular_Set-in_fold_Deriv"><span class="command">lemma</span></span> in_fold_Deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> fold Deriv <span class="free">w</span> <span class="free">L</span> <span class="main">⟷</span> <span class="free">w</span> <span class="main">@</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Deriv_def<span class="main">)</span>

<span class="keyword1" id="Regular_Set-Derivs_alt_def"><span class="command">lemma</span></span> Derivs_alt_def <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Derivs <span class="free">w</span> <span class="free">L</span> <span class="main">=</span> fold Deriv <span class="free">w</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Regular_Set-Deriv_code"><span class="command">lemma</span></span> Deriv_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Deriv <span class="free">x</span> <span class="free">A</span> <span class="main">=</span> tl <span class="main">`</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">xs</span> <span class="keyword1">of</span> <span class="bound">x'</span> <span class="main">#</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">x'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Deriv_def Set.filter_def image_iff tl_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Shuffle product›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Shuffle</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">∥</span>"</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Shuffle</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span>shuffles <span class="bound">xs</span> <span class="bound">ys</span> <span class="main">|</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> <span class="bound">ys</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Regular_Set-Deriv_Shuffle"><span class="command">lemma</span></span> Deriv_Shuffle<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Deriv <span class="free">a</span> <span class="main">(</span><span class="free">A</span> <span class="main">∥</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Deriv <span class="free">a</span> <span class="free">A</span> <span class="main">∥</span> <span class="free">B</span> <span class="main">∪</span> <span class="free">A</span> <span class="main">∥</span> Deriv <span class="free">a</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Shuffle_def Deriv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons_in_shuffles_iff neq_Nil_conv<span class="main">)</span>

<span class="keyword1" id="Regular_Set-shuffle_subset_lists"><span class="command">lemma</span></span> shuffle_subset_lists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> lists <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> lists <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∥</span> <span class="free">B</span> <span class="main">⊆</span> lists <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Shuffle_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">zs</span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> zs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">∈</span> shuffles <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">zs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> lists <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> lists <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> zs <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> shuffles.induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Regular_Set-Nil_in_Shuffle"><span class="command">lemma</span></span> Nil_in_Shuffle<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∥</span> <span class="free">B</span> <span class="main">⟷</span> <span class="main">[]</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="main">[]</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Shuffle_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Regular_Set-shuffle_Un_distrib"><span class="command">lemma</span></span> shuffle_Un_distrib<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∥</span> <span class="main">(</span><span class="free">B</span> <span class="main">∪</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∥</span> <span class="free">B</span> <span class="main">∪</span> <span class="free">A</span> <span class="main">∥</span> <span class="free">C</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∥</span> <span class="main">(</span><span class="free">B</span> <span class="main">∪</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∥</span> <span class="free">B</span> <span class="main">∪</span> <span class="free">A</span> <span class="main">∥</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Shuffle_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Regular_Set-shuffle_UNION_distrib"><span class="command">lemma</span></span> shuffle_UNION_distrib<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∥</span> <span class="main">⋃</span><span class="main">(</span><span class="free">M</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">%</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">∥</span> <span class="free">M</span> <span class="bound">i</span><span class="main">)</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="free">M</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span> <span class="main">∥</span> <span class="free">A</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">%</span><span class="bound">i</span><span class="main">.</span> <span class="free">M</span> <span class="bound">i</span> <span class="main">∥</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Shuffle_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Regular_Set-Shuffle_empty"><span class="command">lemma</span></span> Shuffle_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∥</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∥</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Shuffle_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Regular_Set-Shuffle_eps"><span class="command">lemma</span></span> Shuffle_eps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∥</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">∥</span> <span class="free">B</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Shuffle_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Arden's Lemma›</span></span>

<span class="keyword1" id="Regular_Set-arden_helper"><span class="command">lemma</span></span> arden_helper<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="free">n</span><span class="main">)</span> <span class="main">@@</span> <span class="free">X</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">@@</span> <span class="free">X</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">@@</span> <span class="free">X</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">@@</span> <span class="free">X</span> <span class="main">∪</span> <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conc_Un_distrib conc_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> conc_pow_comm<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">@@</span> <span class="free">X</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span>Suc <span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atMost_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">@@</span> <span class="free">X</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span>Suc <span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Regular_Set-Arden"><span class="command">lemma</span></span> Arden<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∉</span> <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">B</span> <span class="main">⟷</span> <span class="free">X</span> <span class="main">=</span> star <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">:</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"size <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[]</span> <span class="main">∉</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> length <span class="bound">u</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 add_leD2 le_0_eq length_0_conv not_less_eq_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">A</span><span class="main">^^</span><span class="main">(</span><span class="var">?n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">.</span> length <span class="bound">u</span> <span class="main">≥</span> <span class="var">?n</span><span class="main">+</span><span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_lang_pow_lb nat_mult_1<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">A</span><span class="main">^^</span><span class="main">(</span><span class="var">?n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">@@</span><span class="free">X</span><span class="main">.</span> length <span class="bound">u</span> <span class="main">≥</span> <span class="var">?n</span><span class="main">+</span><span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> conc_def length_append<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∉</span> <span class="free">A</span><span class="main">^^</span><span class="main">(</span><span class="var">?n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">@@</span><span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">:</span> star <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">:</span> <span class="free">X</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> arden_helper<span class="main">[</span><span class="operator">OF</span> eq<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?n</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_def conc_UNION_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">:</span> star <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="free">A</span><span class="main">^^</span><span class="bound">n</span> <span class="main">@@</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_def star_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">:</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> arden_helper<span class="main">[</span><span class="operator">OF</span> eq<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> star <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> star <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"star <span class="free">A</span> <span class="main">=</span> <span class="free">A</span> <span class="main">@@</span> star <span class="free">A</span> <span class="main">∪</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> star_unfold_left<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"star <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> star <span class="free">A</span> <span class="main">∪</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span> <span class="main">@@</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> star <span class="free">A</span><span class="main">)</span> <span class="main">@@</span> <span class="free">B</span> <span class="main">∪</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> conc_Un_distrib <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">A</span> <span class="main">@@</span> <span class="main">(</span>star <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span> <span class="main">∪</span> <span class="free">B</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> conc_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">B</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Regular_Set-reversed_arden_helper"><span class="command">lemma</span></span> reversed_arden_helper<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">X</span> <span class="main">@@</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">X</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="free">n</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="free">B</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">X</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span><span class="main">0</span><span class="main">.</span> <span class="free">B</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">X</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="free">B</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">@@</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="free">B</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">X</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">B</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="free">B</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conc_Un_distrib conc_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">X</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span>Suc <span class="skolem">n</span><span class="main">.</span> <span class="free">B</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atMost_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">X</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span>Suc <span class="skolem">n</span><span class="main">.</span> <span class="free">B</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> reversed_Arden<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">X</span> <span class="main">@@</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span> <span class="main">⟷</span> <span class="free">X</span> <span class="main">=</span> <span class="free">B</span> <span class="main">@@</span> star <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
 <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">X</span> <span class="main">@@</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">:</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"size <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[]</span> <span class="main">∉</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> length <span class="bound">u</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 add_leD2 le_0_eq length_0_conv not_less_eq_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">A</span><span class="main">^^</span><span class="main">(</span><span class="var">?n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">.</span> length <span class="bound">u</span> <span class="main">≥</span> <span class="var">?n</span><span class="main">+</span><span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_lang_pow_lb nat_mult_1<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">@@</span> <span class="free">A</span><span class="main">^^</span><span class="main">(</span><span class="var">?n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">.</span> length <span class="bound">u</span> <span class="main">≥</span> <span class="var">?n</span><span class="main">+</span><span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> conc_def length_append<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∉</span> <span class="free">X</span> <span class="main">@@</span> <span class="free">A</span><span class="main">^^</span><span class="main">(</span><span class="var">?n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">:</span> <span class="free">B</span> <span class="main">@@</span> star <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">:</span> <span class="free">X</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> reversed_arden_helper<span class="main">[</span><span class="operator">OF</span> eq<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?n</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_def conc_UNION_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">:</span> <span class="free">B</span> <span class="main">@@</span> star <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">@@</span> <span class="free">A</span><span class="main">^^</span><span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_def star_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">:</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reversed_arden_helper<span class="main">[</span><span class="operator">OF</span> eq<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">B</span> <span class="main">@@</span> star <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">B</span> <span class="main">@@</span> star <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"star <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">∪</span> star <span class="free">A</span> <span class="main">@@</span> <span class="free">A</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> conc_star_comm<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> Un_commute star_unfold_left<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">@@</span> star <span class="free">A</span> <span class="main">=</span> <span class="free">B</span> <span class="main">@@</span> <span class="main">(</span><span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">∪</span> star <span class="free">A</span> <span class="main">@@</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">B</span> <span class="main">∪</span> <span class="free">B</span> <span class="main">@@</span> <span class="main">(</span>star <span class="free">A</span> <span class="main">@@</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> conc_Un_distrib <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">B</span> <span class="main">∪</span> <span class="main">(</span><span class="free">B</span> <span class="main">@@</span> star <span class="free">A</span><span class="main">)</span> <span class="main">@@</span> <span class="free">A</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> conc_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">X</span> <span class="main">@@</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Regular_Exp">
<div class="head">
<h1>Theory Regular_Exp</h1>
</div>
<pre class="source"><span class="comment1">(*  Author: Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Regular expressions"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Regular_Exp
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Regular_Set.html">Regular_Set</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span>atoms<span class="main">:</span> <span class="tfree">'a</span><span class="main">)</span> rexp <span class="main">=</span>
  <span class="entity">is_Zero</span><span class="main">:</span> Zero <span class="main">|</span>
  <span class="entity">is_One</span><span class="main">:</span> One <span class="main">|</span>
  Atom <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span>
  Plus <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span>"</span></span> <span class="main">|</span>
  Times <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span>"</span></span> <span class="main">|</span>
  Star <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lang</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">=&gt;</span> <span class="tfree">'a</span> lang"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> Zero <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> One <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">Un</span> <span class="main">(</span><span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> conc <span class="main">(</span><span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> star<span class="main">(</span><span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">regular_lang</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">regular_lang</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> lang <span class="bound">r</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">nullable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">nullable</span> Zero <span class="main">=</span> False"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nullable</span> One <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nullable</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nullable</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">nullable</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main">∨</span> <span class="free">nullable</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nullable</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">nullable</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main">∧</span> <span class="free">nullable</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nullable</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>

<span class="keyword1" id="Regular_Exp-nullable_iff"><span class="command">lemma</span></span> nullable_iff <span class="main">[</span><span class="operator">code_abbrev</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nullable <span class="free">r</span> <span class="main">⟷</span> <span class="main">[]</span> <span class="main">∈</span> lang <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conc_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">rexp_empty</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rexp_empty</span> Zero <span class="main">⟷</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_empty</span> One <span class="main">⟷</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_empty</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">⟷</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_empty</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">rexp_empty</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free">rexp_empty</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_empty</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">rexp_empty</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∨</span> <span class="free">rexp_empty</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_empty</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">⟷</span> False"</span></span>

<span class="comment1">(* TODO Fixme: This code_abbrev rule does not work. Why? *)</span>
<span class="keyword1" id="Regular_Exp-rexp_empty_iff"><span class="command">lemma</span></span> rexp_empty_iff <span class="main">[</span><span class="operator">code_abbrev</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rexp_empty <span class="free">r</span> <span class="main">⟷</span> lang <span class="free">r</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>



<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Composition on rhs usually complicates matters:›</span></span>
<span class="keyword1" id="Regular_Exp-map_map_rexp"><span class="command">lemma</span></span> map_map_rexp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_rexp <span class="free">f</span> <span class="main">(</span>map_rexp <span class="free">g</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> map_rexp <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rexp.map_comp o_def <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Regular_Exp-map_rexp_ident"><span class="command">lemma</span></span> map_rexp_ident<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_rexp <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> id_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> fun_eq_iff rexp.map_id id_apply <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> allI refl<span class="main">)</span>

<span class="keyword1" id="Regular_Exp-atoms_lang"><span class="command">lemma</span></span> atoms_lang<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">:</span> lang <span class="free">r</span> <span class="main">⟹</span> set <span class="free">w</span> <span class="main">⊆</span> atoms <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Times <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Star <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_conv_concat<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Regular_Exp-lang_eq_ext"><span class="command">lemma</span></span> lang_eq_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lang <span class="free">r</span> <span class="main">=</span> lang <span class="free">s</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">w</span> <span class="main">∈</span> lists<span class="main">(</span>atoms <span class="free">r</span> <span class="main">∪</span> atoms <span class="free">s</span><span class="main">)</span><span class="main">.</span> <span class="bound">w</span> <span class="main">∈</span> lang <span class="free">r</span> <span class="main">⟷</span> <span class="bound">w</span> <span class="main">∈</span> lang <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atoms_lang<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> subset_iff<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Regular_Exp-lang_eq_ext_Nil_fold_Deriv"><span class="command">lemma</span></span> lang_eq_ext_Nil_fold_Deriv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">r</span> <span class="free">s</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔅</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span>fold Deriv <span class="bound">w</span> <span class="main">(</span>lang <span class="free">r</span><span class="main">)</span><span class="main">,</span> fold Deriv <span class="bound">w</span> <span class="main">(</span>lang <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">|</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">∈</span>lists <span class="main">(</span>atoms <span class="free">r</span> <span class="main">∪</span> atoms <span class="free">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">r</span> <span class="main">=</span> lang <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">K</span><span class="main">,</span> <span class="bound">L</span><span class="main">)</span> <span class="main">∈</span> <span class="free">𝔅</span><span class="main">.</span> <span class="main">[]</span> <span class="main">∈</span> <span class="bound">K</span> <span class="main">⟷</span> <span class="main">[]</span> <span class="main">∈</span> <span class="bound">L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lang_eq_ext 𝔅_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> in_fold_Deriv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Term ordering›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> rexp <span class="main">::</span> <span class="main">(</span><span class="quoted">order</span><span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>order<span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">le_rexp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>order<span class="main">)</span> rexp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>order<span class="main">)</span> rexp <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> Zero <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Zero <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> One <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> One <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main">(</span>Atom <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Atom <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">le_rexp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main">(</span>Star <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Star <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="free">le_rexp</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="keyword1">else</span> <span class="free">le_rexp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main">(</span>Plus <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Plus <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="free">le_rexp</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="keyword1">else</span> <span class="free">le_rexp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* The class instance stuff is by Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_eq_rexp</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> le_rexp <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_rexp</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> le_rexp <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1" id="Regular_Exp-le_rexp_Zero"><span class="command">lemma</span></span> le_rexp_Zero<span class="main">:</span> <span class="quoted"><span class="quoted">"le_rexp <span class="free">r</span> Zero <span class="main">⟹</span> <span class="free">r</span> <span class="main">=</span> Zero"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Regular_Exp-le_rexp_refl"><span class="command">lemma</span></span> le_rexp_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"le_rexp <span class="free">r</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Regular_Exp-le_rexp_antisym"><span class="command">lemma</span></span> le_rexp_antisym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>le_rexp <span class="free">r</span> <span class="free">s</span><span class="main">;</span> le_rexp <span class="free">s</span> <span class="free">r</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_rexp.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_rexp_Zero<span class="main">)</span>

<span class="keyword1" id="Regular_Exp-le_rexp_trans"><span class="command">lemma</span></span> le_rexp_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>le_rexp <span class="free">r</span> <span class="free">s</span><span class="main">;</span> le_rexp <span class="free">s</span> <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> le_rexp <span class="free">r</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_rexp.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Atom <span class="skolem">v</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"le_rexp One <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Plus <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"le_rexp One <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Times <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"le_rexp One <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Star <span class="skolem">s</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"le_rexp One <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">u</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Atom <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>Atom <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Atom <span class="skolem">u</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Atom <span class="skolem">v</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Plus <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Atom <span class="skolem">v</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Times <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Atom <span class="skolem">v</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Star <span class="skolem">s</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Atom <span class="skolem">v</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> le_rexp <span class="skolem">r</span> <span class="skolem">s</span> <span class="main">⟹</span> le_rexp <span class="skolem">s</span> <span class="bound">t</span> <span class="main">⟹</span> le_rexp <span class="skolem">r</span> <span class="bound">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>Star <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Star <span class="skolem">s</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Plus <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Times <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">r1</span> <span class="main">=</span> <span class="skolem">s1</span> <span class="main">⟹</span> le_rexp <span class="skolem">r2</span> <span class="skolem">s2</span> <span class="main">⟹</span> le_rexp <span class="skolem">s2</span> <span class="bound">t</span> <span class="main">⟹</span> le_rexp <span class="skolem">r2</span> <span class="bound">t</span>"</span></span>
         <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">r1</span> <span class="main">≠</span> <span class="skolem">s1</span> <span class="main">⟹</span> le_rexp <span class="skolem">r1</span> <span class="skolem">s1</span> <span class="main">⟹</span> le_rexp <span class="skolem">s1</span> <span class="bound">t</span> <span class="main">⟹</span> le_rexp <span class="skolem">r1</span> <span class="bound">t</span>"</span></span>
         <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">(</span>Plus <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Plus <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_rexp_antisym<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Times <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">r1</span> <span class="main">=</span> <span class="skolem">s1</span> <span class="main">⟹</span> le_rexp <span class="skolem">r2</span> <span class="skolem">s2</span> <span class="main">⟹</span> le_rexp <span class="skolem">s2</span> <span class="bound">t</span> <span class="main">⟹</span> le_rexp <span class="skolem">r2</span> <span class="bound">t</span>"</span></span>
         <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">r1</span> <span class="main">≠</span> <span class="skolem">s1</span> <span class="main">⟹</span> le_rexp <span class="skolem">r1</span> <span class="skolem">s1</span> <span class="main">⟹</span> le_rexp <span class="skolem">s1</span> <span class="bound">t</span> <span class="main">⟹</span> le_rexp <span class="skolem">r1</span> <span class="bound">t</span>"</span></span>
         <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">(</span>Times <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Times <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_rexp_antisym<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_rexp_def less_rexp_def
       <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_rexp_refl le_rexp_antisym le_rexp_trans<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> rexp <span class="main">::</span> <span class="main">(</span><span class="quoted">linorder</span><span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>linorder<span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Regular_Exp-le_rexp_total"><span class="command">lemma</span></span> le_rexp_total<span class="main">:</span> <span class="quoted"><span class="quoted">"le_rexp <span class="main">(</span><span class="free">r</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> linorder rexp<span class="main">)</span> <span class="free">s</span> <span class="main">∨</span> le_rexp <span class="free">s</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_rexp.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">unfold</span> less_eq_rexp_def less_rexp_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_rexp_total<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="NDerivative">
<div class="head">
<h1>Theory NDerivative</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Normalizing Derivative›</span></span>

<span class="keyword1"><span class="command">theory</span></span> NDerivative
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Regular_Exp.html">Regular_Exp</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Normalizing operations›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹associativity, commutativity, idempotence, zero›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nPlus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>order rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nPlus</span> Zero <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> Zero <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nPlus</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free">nPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free">nPlus</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> le_rexp <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span> Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free">nPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> le_rexp <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
      <span class="keyword1">else</span> Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="NDerivative-lang_nPlus"><span class="command">lemma</span></span> lang_nPlus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>nPlus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> lang <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nPlus.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹associativity, zero, one›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nTimes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>order rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nTimes</span> Zero <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nTimes</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nTimes</span> One <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nTimes</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> One <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nTimes</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free">nTimes</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nTimes</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1" id="NDerivative-lang_nTimes"><span class="command">lemma</span></span> lang_nTimes<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>nTimes <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> lang <span class="main">(</span>Times <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nTimes.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">norm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>order rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">norm</span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> One <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> nPlus <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> nTimes <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Star <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="NDerivative-lang_norm"><span class="command">lemma</span></span> lang_norm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>norm <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">nderiv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>order <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nderiv</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nderiv</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> One <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> One <span class="keyword1">else</span> Zero<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> nPlus <span class="main">(</span><span class="free">nderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">nderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">r's</span> <span class="main">=</span> nTimes <span class="main">(</span><span class="free">nderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
     <span class="keyword1">in</span> <span class="keyword1">if</span> nullable <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> nPlus <span class="bound">r's</span> <span class="main">(</span><span class="free">nderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">r's</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> nTimes <span class="main">(</span><span class="free">nderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="NDerivative-lang_nderiv"><span class="command">lemma</span></span> lang_nderiv<span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>nderiv <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Deriv <span class="free">a</span> <span class="main">(</span>lang <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def nullable_iff<span class="main">)</span>

<span class="keyword1" id="NDerivative-deriv_no_occurrence"><span class="command">lemma</span></span> deriv_no_occurrence<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> atoms <span class="free">r</span> <span class="main">⟹</span> nderiv <span class="free">x</span> <span class="free">r</span> <span class="main">=</span> Zero"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="NDerivative-atoms_nPlus"><span class="command">lemma</span></span> atoms_nPlus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atoms <span class="main">(</span>nPlus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> atoms <span class="free">r</span> <span class="main">∪</span> atoms <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nPlus.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="NDerivative-atoms_nTimes"><span class="command">lemma</span></span> atoms_nTimes<span class="main">:</span> <span class="quoted"><span class="quoted">"atoms <span class="main">(</span>nTimes <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">⊆</span> atoms <span class="free">r</span> <span class="main">∪</span> atoms <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nTimes.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="NDerivative-atoms_norm"><span class="command">lemma</span></span> atoms_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"atoms <span class="main">(</span>norm <span class="free">r</span><span class="main">)</span> <span class="main">⊆</span> atoms <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> atoms_nTimes<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="NDerivative-atoms_nderiv"><span class="command">lemma</span></span> atoms_nderiv<span class="main">:</span> <span class="quoted"><span class="quoted">"atoms <span class="main">(</span>nderiv <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">⊆</span> atoms <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> atoms_nTimes<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Equivalence_Checking">
<div class="head">
<h1>Theory Equivalence_Checking</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deciding Regular Expression Equivalence›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Equivalence_Checking
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="NDerivative.html">NDerivative</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/While_Combinator.html">HOL-Library.While_Combinator</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bisimulation between languages and regular expressions›</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">bisimilar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">⟷</span> <span class="main">[]</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> 
 <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">bisimilar</span> <span class="main">(</span>Deriv <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">)</span> <span class="main">(</span>Deriv <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span><span class="main">)</span>
 <span class="main">⟹</span> <span class="free">bisimilar</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span>"</span></span>

<span class="keyword1" id="Equivalence_Checking-equal_if_bisimilar"><span class="command">lemma</span></span> equal_if_bisimilar<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bisimilar <span class="free">K</span> <span class="free">L</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">=</span> <span class="free">L</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹bisimilar <span class="free">K</span> <span class="free">L</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="free">K</span> <span class="main">⟷</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">K</span></span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> bisimilar.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">w</span> <span class="skolem">K</span> <span class="skolem">L</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹bisimilar <span class="skolem">K</span> <span class="skolem">L</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bisimilar <span class="main">(</span>Deriv <span class="skolem">a</span> <span class="skolem">K</span><span class="main">)</span> <span class="main">(</span>Deriv <span class="skolem">a</span> <span class="skolem">L</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> bisimilar.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> Deriv <span class="skolem">a</span> <span class="skolem">K</span> <span class="main">⟷</span> <span class="skolem">w</span> <span class="main">∈</span> Deriv <span class="skolem">a</span> <span class="skolem">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Deriv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Equivalence_Checking-language_coinduct"><span class="command">lemma</span></span> language_coinduct<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∼</span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main"><span class="free">∼</span></span> <span class="free">L</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">K</span> <span class="bound">L</span><span class="main">.</span> <span class="bound">K</span> <span class="main"><span class="free">∼</span></span> <span class="bound">L</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">[]</span> <span class="main">∈</span> <span class="bound">K</span> <span class="main">⟷</span> <span class="main">[]</span> <span class="main">∈</span> <span class="bound">L</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">K</span> <span class="bound">L</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">K</span> <span class="main"><span class="free">∼</span></span> <span class="bound">L</span> <span class="main">⟹</span> Deriv <span class="bound">x</span> <span class="bound">K</span> <span class="main"><span class="free">∼</span></span> Deriv <span class="bound">x</span> <span class="bound">L</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">=</span> <span class="free">L</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equal_if_bisimilar<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bisimilar.coinduct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">K</span> <span class="main"><span class="free">∼</span></span> <span class="free">L</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> rexp_pair <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">*</span> <span class="tfree">'a</span> rexp"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> rexp_pairs <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp_pair list"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_bisimulation</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>order list <span class="main">⇒</span> <span class="tfree">'a</span> rexp_pair set <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_bisimulation</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">(</span>atoms <span class="bound">r</span> <span class="main">∪</span> atoms <span class="bound">s</span> <span class="main">⊆</span> set <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>nullable <span class="bound">r</span> <span class="main">⟷</span> nullable <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">.</span> <span class="main">(</span>nderiv <span class="bound">a</span> <span class="bound">r</span><span class="main">,</span> nderiv <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Equivalence_Checking-bisim_lang_eq"><span class="command">lemma</span></span> bisim_lang_eq<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"is_bisimulation <span class="free">as</span> <span class="free">ps</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ps</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">r</span> <span class="main">=</span> lang <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ps'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps'</span> <span class="main">=</span> insert <span class="main">(</span>Zero<span class="main">,</span> Zero<span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> bisim <span class="keyword1"><span class="command">have</span></span> bisim'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_bisimulation <span class="free">as</span> <span class="skolem">ps'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ps'_def is_bisimulation_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">K</span> <span class="bound">L</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span><span class="skolem">ps'</span><span class="main">.</span> <span class="bound">K</span> <span class="main">=</span> lang <span class="bound">r</span> <span class="main">∧</span> <span class="bound">L</span> <span class="main">=</span> lang <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> language_coinduct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?R</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ps</span>›</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">ps'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ps'_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">(</span>lang <span class="free">r</span><span class="main">)</span> <span class="main">(</span>lang <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">K</span> <span class="skolem">L</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="skolem">K</span> <span class="skolem">L</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">ps'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> KL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">=</span> lang <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> lang <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> bisim' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nullable <span class="skolem">r</span> <span class="main">⟷</span> nullable <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_bisimulation_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="skolem">K</span> <span class="main">⟷</span> <span class="main">[]</span> <span class="main">∈</span> <span class="skolem">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nullable_iff KL<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">(</span>Deriv <span class="skolem">a</span> <span class="skolem">K</span><span class="main">)</span> <span class="main">(</span>Deriv <span class="skolem">a</span> <span class="skolem">L</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="free">as</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> rs bisim'
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nderiv <span class="skolem">a</span> <span class="skolem">r</span><span class="main">,</span> nderiv <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">ps'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_bisimulation_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> KL lang_nderiv<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> set <span class="free">as</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> bisim' rs
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> atoms <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> atoms <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_bisimulation_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nderiv <span class="skolem">a</span> <span class="skolem">r</span> <span class="main">=</span> Zero"</span></span> <span class="quoted"><span class="quoted">"nderiv <span class="skolem">a</span> <span class="skolem">s</span> <span class="main">=</span> Zero"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> deriv_no_occurrence<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Deriv <span class="skolem">a</span> <span class="skolem">K</span> <span class="main">=</span> lang Zero"</span></span> 
        <span class="quoted"><span class="quoted">"Deriv <span class="skolem">a</span> <span class="skolem">L</span> <span class="main">=</span> lang Zero"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> KL lang_nderiv<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ps'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Closure computation›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">closure</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>order list <span class="main">⇒</span> <span class="tfree">'a</span> rexp_pair <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> rexp_pairs <span class="main">*</span> <span class="tfree">'a</span> rexp_pair set<span class="main">)</span> option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">closure</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">=</span> rtrancl_while <span class="main">(</span><span class="main">%</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> nullable <span class="bound">r</span> <span class="main">=</span> nullable <span class="bound">s</span><span class="main">)</span>
  <span class="main">(</span><span class="main">%</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span>nderiv <span class="bound">a</span> <span class="bound">r</span><span class="main">,</span> nderiv <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pre_bisim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>order list <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span>
 <span class="tfree">'a</span> rexp_pairs <span class="main">*</span> <span class="tfree">'a</span> rexp_pair set <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pre_bisim</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">ws</span><span class="main">,</span><span class="bound">R</span><span class="main">)</span><span class="main">.</span>
 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="bound">R</span> <span class="main">∧</span> set <span class="bound">ws</span> <span class="main">⊆</span> <span class="bound">R</span> <span class="main">∧</span>
 <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span> <span class="bound">R</span><span class="main">.</span> atoms <span class="bound">r</span> <span class="main">∪</span> atoms <span class="bound">s</span> <span class="main">⊆</span> set <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">∧</span>
 <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span> <span class="bound">R</span> <span class="main">-</span> set <span class="bound">ws</span><span class="main">.</span> <span class="main">(</span>nullable <span class="bound">r</span> <span class="main">⟷</span> nullable <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">.</span> <span class="main">(</span>nderiv <span class="bound">a</span> <span class="bound">r</span><span class="main">,</span> nderiv <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> closure_sound<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> result<span class="main">:</span> <span class="quoted"><span class="quoted">"closure <span class="free">as</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> atoms<span class="main">:</span> <span class="quoted"><span class="quoted">"atoms <span class="free">r</span> <span class="main">∪</span> atoms <span class="free">s</span> <span class="main">⊆</span> set <span class="free">as</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">r</span> <span class="main">=</span> lang <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?test</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"While_Combinator.rtrancl_while_test <span class="main">(</span><span class="main">%</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> nullable <span class="bound">r</span> <span class="main">=</span> nullable <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?step</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"While_Combinator.rtrancl_while_step <span class="main">(</span><span class="main">%</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span>nderiv <span class="bound">a</span> <span class="bound">r</span><span class="main">,</span> nderiv <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">st</span> <span class="keyword3"><span class="command">assume</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"pre_bisim <span class="free">as</span> <span class="free">r</span> <span class="free">s</span> <span class="skolem">st</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> test<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?test</span> <span class="skolem">st</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pre_bisim <span class="free">as</span> <span class="free">r</span> <span class="free">s</span> <span class="main">(</span><span class="var">?step</span> <span class="skolem">st</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">st</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ws</span> <span class="skolem">R</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ws</span><span class="main">,</span> <span class="skolem">R</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> test <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">t</span><span class="main">,</span> <span class="skolem">R</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nullable <span class="skolem">r</span> <span class="main">=</span> nullable <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ws</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> inv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> atoms_nderiv<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> atoms_nderiv<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> st rtrancl_while_test.simps rtrancl_while_step.simps pre_bisim_def Ball_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> atoms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pre_bisim <span class="free">as</span> <span class="free">r</span> <span class="free">s</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">]</span><span class="main">,</span><span class="main">{</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_bisim_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> pre_bisim_ps<span class="main">:</span> <span class="quoted"><span class="quoted">"pre_bisim <span class="free">as</span> <span class="free">r</span> <span class="free">s</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> while_option_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ result<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> closure_def rtrancl_while_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_bisimulation <span class="free">as</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_bisim_def is_bisimulation_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">r</span> <span class="main">=</span> lang <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bisim_lang_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bisimulation-free proof of closure computation›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The equivalence check can be viewed as the product construction
of two automata. The state space is the reflexive transitive closure of
the pair of next-state functions, i.e. derivatives.›</span></span>

<span class="keyword1" id="Equivalence_Checking-rtrancl_nderiv_nderivs"><span class="command">lemma</span></span> rtrancl_nderiv_nderivs<span class="main">:</span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">nderivs</span> <span class="main">==</span> foldl <span class="main">(</span><span class="main">%</span><span class="bound">r</span> <span class="bound">a</span><span class="main">.</span> nderiv <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>nderiv <span class="bound">a</span> <span class="bound">r</span><span class="main">,</span>nderiv <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">|</span> <span class="bound">r</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">:</span> <span class="free">A</span><span class="main">}</span><span class="main">^*</span> <span class="main">=</span>
       <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">nderivs</span> <span class="bound">r</span> <span class="bound">w</span><span class="main">,</span><span class="free">nderivs</span> <span class="bound">s</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span><span class="main">|</span> <span class="bound">r</span> <span class="bound">s</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">:</span> lists <span class="free">A</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> nderivs_def
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">r'</span> <span class="skolem">s'</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">r'</span><span class="main">,</span><span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="var">?L</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">r'</span><span class="main">,</span><span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtrancl_induct2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> refl <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> foldl.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> foldl.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">r'</span> <span class="skolem">s'</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">w</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span><span class="main">,</span> <span class="free">nderivs</span> <span class="skolem">r</span> <span class="skolem">w</span><span class="main">,</span> <span class="free">nderivs</span> <span class="skolem">s</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">:</span><span class="var">?L</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> snoc <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rtrancl_into_rtrancl<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">r'</span><span class="main">,</span><span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="var">?R</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">r'</span><span class="main">,</span><span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_lists_conv_set<span class="main">)</span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Equivalence_Checking-nullable_nderivs"><span class="command">lemma</span></span> nullable_nderivs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nullable <span class="main">(</span>foldl <span class="main">(</span><span class="main">%</span><span class="bound">r</span> <span class="bound">a</span><span class="main">.</span> nderiv <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span> <span class="free">r</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">w</span> <span class="main">:</span> lang <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nullable_iff lang_nderiv Deriv_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> closure_sound_complete<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> result<span class="main">:</span> <span class="quoted"><span class="quoted">"closure <span class="free">as</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="free">ws</span><span class="main">,</span><span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> atoms<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">as</span> <span class="main">=</span> atoms <span class="free">r</span> <span class="main">∪</span> atoms <span class="free">s</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> lang <span class="free">r</span> <span class="main">=</span> lang <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lang <span class="free">r</span> <span class="main">=</span> lang <span class="free">s</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">r'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r0</span><span class="main">,</span><span class="bound">s0</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>nderiv <span class="bound">a</span> <span class="bound">r0</span><span class="main">,</span>nderiv <span class="bound">a</span> <span class="bound">s0</span><span class="main">)</span><span class="main">)</span><span class="main">|</span> <span class="bound">r0</span> <span class="bound">s0</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">:</span> set <span class="free">as</span><span class="main">}</span><span class="main">^*</span> <span class="main">``</span> <span class="main">{</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
    nullable <span class="bound">r'</span> <span class="main">=</span> nullable <span class="bound">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atoms rtrancl_nderiv_nderivs Ball_def lang_eq_ext imp_ex nullable_nderivs
         <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>Un_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">q</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span>nderiv <span class="bound">a</span> <span class="bound">p</span><span class="main">,</span> nderiv <span class="bound">a</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
    <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">,</span> nderiv <span class="bound">a</span> <span class="bound">r</span><span class="main">,</span> nderiv <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span> <span class="main">|</span><span class="bound">r</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">as</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> atoms rtrancl_while_Some<span class="main">[</span><span class="operator">OF</span> result<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> closure_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leq Ball_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The overall procedure›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">add_atoms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_atoms</span> Zero <span class="main">=</span> id"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add_atoms</span> One <span class="main">=</span> id"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add_atoms</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> List.insert <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add_atoms</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">add_atoms</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">o</span> <span class="free">add_atoms</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add_atoms</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">add_atoms</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">o</span> <span class="free">add_atoms</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add_atoms</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">add_atoms</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1" id="Equivalence_Checking-set_add_atoms"><span class="command">lemma</span></span> set_add_atoms<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>add_atoms <span class="free">r</span> <span class="free">as</span><span class="main">)</span> <span class="main">=</span> atoms <span class="free">r</span> <span class="main">∪</span> set <span class="free">as</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_eqv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat rexp <span class="main">⇒</span> nat rexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">check_eqv</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">nr</span> <span class="main">=</span> norm <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span> <span class="bound">ns</span> <span class="main">=</span> norm <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span> <span class="bound">as</span> <span class="main">=</span> add_atoms <span class="bound">nr</span> <span class="main">(</span>add_atoms <span class="bound">ns</span> <span class="main">[]</span><span class="main">)</span>
   <span class="keyword1">in</span> <span class="keyword1">case</span> closure <span class="bound">as</span> <span class="main">(</span><span class="bound">nr</span><span class="main">,</span> <span class="bound">ns</span><span class="main">)</span> <span class="keyword1">of</span>
     Some<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>

<span class="keyword1" id="Equivalence_Checking-soundness"><span class="command">lemma</span></span> soundness<span class="main">:</span> 
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"check_eqv <span class="free">r</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">r</span> <span class="main">=</span> lang <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"norm <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"norm <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?as</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"add_atoms <span class="var">?nr</span> <span class="main">(</span>add_atoms <span class="var">?ns</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"closure <span class="var">?as</span> <span class="main">(</span><span class="var">?nr</span><span class="main">,</span><span class="var">?ns</span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> check_eqv_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.splits list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>norm <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lang <span class="main">(</span>norm <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> closure_sound<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_add_atoms <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> atoms_norm<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">r</span> <span class="main">=</span> lang <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Test:›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"check_eqv <span class="main">(</span>Plus One <span class="main">(</span>Times <span class="main">(</span>Atom <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Star<span class="main">(</span>Atom <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Star<span class="main">(</span>Atom <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Relation_Interpretation">
<div class="head">
<h1>Theory Relation_Interpretation</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Regular Expressions as Homogeneous Binary Relations›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Relation_Interpretation
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Regular_Exp.html">Regular_Exp</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">*</span> <span class="tfree">'b</span><span class="main">)</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">*</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rel</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> Zero <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rel</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> One <span class="main">=</span> Id"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rel</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rel</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">rel</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> <span class="free">rel</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rel</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">rel</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">O</span> <span class="free">rel</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rel</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">rel</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">^*</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">word_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">*</span> <span class="tfree">'b</span><span class="main">)</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">*</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">word_rel</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">[]</span> <span class="main">=</span> Id"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">word_rel</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">O</span> <span class="free">word_rel</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span>"</span></span>

<span class="keyword1" id="Relation_Interpretation-word_rel_append"><span class="command">lemma</span></span> word_rel_append<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"word_rel <span class="free">v</span> <span class="free">w</span> <span class="keyword1">O</span> word_rel <span class="free">v</span> <span class="free">w'</span> <span class="main">=</span> word_rel <span class="free">v</span> <span class="main">(</span><span class="free">w</span> <span class="main">@</span> <span class="free">w'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main">)</span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Relation_Interpretation-rel_word_rel"><span class="command">lemma</span></span> rel_word_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"rel <span class="free">v</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">w</span><span class="main">∈</span>lang <span class="free">r</span><span class="main">.</span> word_rel <span class="free">v</span> <span class="bound">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Times <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_def word_rel_append conc_def relcomp_UNION_distrib relcomp_UNION_distrib2<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel <span class="free">v</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">^^</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">w</span> <span class="main">∈</span> lang <span class="skolem">r</span> <span class="main">^^</span> <span class="skolem">n</span><span class="main">.</span> word_rel <span class="free">v</span> <span class="bound">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> relpow.simps relpow_commute<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Star conc_def word_rel_append
          relcomp_UNION_distrib relcomp_UNION_distrib2<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> rel.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rtrancl_power star_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Soundness:›</span></span>

<span class="keyword1" id="Relation_Interpretation-soundness"><span class="command">lemma</span></span> soundness<span class="main">:</span>
 <span class="quoted"><span class="quoted">"lang <span class="free">r</span> <span class="main">=</span> lang <span class="free">s</span> <span class="main">⟹</span> rel <span class="free">v</span> <span class="free">r</span> <span class="main">=</span> rel <span class="free">v</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rel_word_rel <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Regexp_Method">
<div class="head">
<h1>Theory Regexp_Method</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Proving Relation (In)equalities via Regular Expressions›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Regexp_Method
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Equivalence_Checking.html">Equivalence_Checking</a> <a href="Relation_Interpretation.html">Relation_Interpretation</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">rel_of_regexp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'a</span><span class="main">)</span> set list <span class="main">⇒</span> nat rexp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'a</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_of_regexp</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> Zero  <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">rel_of_regexp</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> One  <span class="main">=</span> Id"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">rel_of_regexp</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>  <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">rel_of_regexp</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>  <span class="main">=</span> <span class="free">rel_of_regexp</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>  <span class="main">∪</span> <span class="free">rel_of_regexp</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> "</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">rel_of_regexp</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>  <span class="main">=</span> <span class="free">rel_of_regexp</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">O</span> <span class="free">rel_of_regexp</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">rel_of_regexp</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>  <span class="main">=</span> <span class="main">(</span><span class="free">rel_of_regexp</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">^*</span>"</span></span>

<span class="keyword1" id="Regexp_Method-rel_of_regexp_rel"><span class="command">lemma</span></span> rel_of_regexp_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_of_regexp <span class="free">vs</span> <span class="free">r</span> <span class="main">=</span> rel <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">vs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">rel_eq</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_eq</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">=</span> <span class="main">(</span>rel_of_regexp <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> rel_of_regexp <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Regexp_Method-rel_eqI"><span class="command">lemma</span></span> rel_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"check_eqv <span class="free">r</span> <span class="free">s</span> <span class="main">⟹</span> rel_eq <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="free">vs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rel_eq.simps rel_of_regexp_rel
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Relation_Interpretation.soundness<span class="main">)</span>
 <span class="main">(</span><span class="operator">rule</span> Equivalence_Checking.soundness<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> regexp_reify <span class="main">=</span> rel_of_regexp.simps rel_eq.simps
<span class="keyword1"><span class="command">lemmas</span></span> regexp_unfold <span class="main">=</span> trancl_unfold_left subset_Un_eq

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="keyword2"><span class="keyword">local</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check_eqv</span> <span class="main">(</span><span class="entity">ct</span><span class="main">,</span> <span class="entity">b</span><span class="main">)</span> <span class="main">=</span> Thm.mk_binop <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">cterm</span> <span class="quoted">"Pure.eq <span class="main">::</span> bool <span class="main">⇒</span> bool <span class="main">⇒</span> prop"</span><span class="antiquote">}</span></span></span>
  <span class="entity">ct</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">b</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">cterm</span> <span class="quoted">True</span><span class="antiquote">}</span></span></span> <span class="keyword2"><span class="keyword">else</span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">cterm</span> <span class="quoted">False</span><span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">check_eqv_oracle</span><span class="main">)</span> <span class="main">=</span> Context.&gt;&gt;&gt; <span class="main">(</span>Context.map_theory_result
  <span class="main">(</span>Thm.add_oracle <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> check_eqv<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="entity">check_eqv</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword2"><span class="keyword">in</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">regexp_conv</span> <span class="main">=</span>
  <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">computation_conv</span> <span class="quoted">bool</span> <span class="quasi_keyword">terms</span><span class="main">:</span> <span class="quoted">check_eqv</span> <span class="quasi_keyword">datatypes</span><span class="main">:</span> <span class="quoted">"nat rexp"</span><span class="antiquote">}</span></span></span></span></span>
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">b</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ct</span> <span class="main">=&gt;</span> <span class="entity">check_eqv_oracle</span> <span class="main">(</span><span class="entity">ct</span><span class="main">,</span> <span class="entity">b</span><span class="main">)</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
›</span>
  
<span class="keyword1"><span class="command">method_setup</span></span> regexp <span class="main">=</span> <span class="quoted">‹
  Scan.succeed <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
    <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span>
      <span class="main">(</span>TRY o eresolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> rev_subsetD<span class="antiquote">}</span></span></span><span class="main">)</span>
      THEN' <span class="main">(</span><span class="entity">Subgoal.FOCUS_PARAMS</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt'</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span>
        TRY <span class="main">(</span>Local_Defs.unfold_tac <span class="entity">ctxt'</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> regexp_unfold<span class="antiquote">}</span></span></span><span class="main">)</span>
        THEN <span class="entity">Reification.tac</span> <span class="entity">ctxt'</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> regexp_reify<span class="antiquote">}</span></span></span> NONE <span class="inner_numeral">1</span>
        THEN resolve_tac <span class="entity">ctxt'</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> rel_eqI<span class="antiquote">}</span></span></span> <span class="inner_numeral">1</span>
        THEN CONVERSION <span class="main">(</span><span class="entity">HOLogic.Trueprop_conv</span> <span class="main">(</span><span class="entity">regexp_conv</span> <span class="entity">ctxt'</span><span class="main">)</span><span class="main">)</span> <span class="inner_numeral">1</span>
        THEN resolve_tac <span class="entity">ctxt'</span> <span class="main">[</span><span class="entity">TrueI</span><span class="main">]</span> <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
›</span> <span class="quoted">‹decide relation equalities via regular expressions›</span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> le_rexp nPlus nTimes norm nullable bisimilar is_bisimulation closure
  pre_bisim add_atoms check_eqv rel word_rel rel_eq

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Example:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="main">∪</span> <span class="free">s</span><span class="main">^+</span><span class="main">)</span><span class="main">^*</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">∪</span> <span class="free">s</span><span class="main">)</span><span class="main">^*</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">regexp</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Regexp_Constructions">
<div class="head">
<h1>Theory Regexp_Constructions</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Regexp_Constructions.thy
  Author:   Manuel Eberl &lt;eberlm@in.tum.de&gt;

  Some simple constructions on regular expressions to illustrate closure properties of regular
  languages: reversal, substitution, prefixes, suffixes, subwords ("fragments")
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Basic constructions on regular expressions›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Regexp_Constructions
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Sublist.html">HOL-Library.Sublist</a>"</span>
  <a href="Regular_Exp.html">Regular_Exp</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Reverse language›</span></span>

<span class="keyword1" id="Regexp_Constructions-rev_conc"><span class="command">lemma</span></span> rev_conc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> rev <span class="main">`</span> <span class="free">B</span> <span class="main">@@</span> rev <span class="main">`</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> conc_def image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Regexp_Constructions-rev_compower"><span class="command">lemma</span></span> rev_compower <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>rev <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">^^</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conc_pow_comm<span class="main">)</span>

<span class="keyword1" id="Regexp_Constructions-rev_star"><span class="command">lemma</span></span> rev_star <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="main">`</span> star <span class="free">A</span> <span class="main">=</span> star <span class="main">(</span>rev <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_def image_UN<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Substituting characters in a language›</span></span>    

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subst_word</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst_word</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> concat <span class="main">(</span>map <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword1" id="Regexp_Constructions-subst_word_Nil"><span class="command">lemma</span></span> subst_word_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_word <span class="free">f</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_word_def<span class="main">)</span>
    
<span class="keyword1" id="Regexp_Constructions-subst_word_singleton"><span class="command">lemma</span></span> subst_word_singleton <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_word <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_word_def<span class="main">)</span>
    
<span class="keyword1" id="Regexp_Constructions-subst_word_append"><span class="command">lemma</span></span> subst_word_append <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_word <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> subst_word <span class="free">f</span> <span class="free">xs</span> <span class="main">@</span> subst_word <span class="free">f</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_word_def<span class="main">)</span>
    
<span class="keyword1" id="Regexp_Constructions-subst_word_Cons"><span class="command">lemma</span></span> subst_word_Cons <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_word <span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span> <span class="main">@</span> subst_word <span class="free">f</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_word_def<span class="main">)</span>
    
<span class="keyword1" id="Regexp_Constructions-subst_word_conc"><span class="command">lemma</span></span> subst_word_conc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_word <span class="free">f</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> subst_word <span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">@@</span> subst_word <span class="free">f</span> <span class="main">`</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> conc_def image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 

<span class="keyword1" id="Regexp_Constructions-subst_word_compower"><span class="command">lemma</span></span> subst_word_compower <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_word <span class="free">f</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>subst_word <span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">^^</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    
<span class="keyword1" id="Regexp_Constructions-subst_word_star"><span class="command">lemma</span></span> subst_word_star <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_word <span class="free">f</span> <span class="main">`</span> <span class="main">(</span>star <span class="free">A</span><span class="main">)</span> <span class="main">=</span> star <span class="main">(</span>subst_word <span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_def image_UN<span class="main">)</span>
    

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Suffix language›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Suffixes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Suffixes</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">w</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">@</span> <span class="bound">w</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Regexp_Constructions-Suffixes_altdef"><span class="command">lemma</span></span> Suffixes_altdef <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Suffixes <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">w</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> set <span class="main">(</span>suffixes <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Suffixes_def set_suffixes_eq suffix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Regexp_Constructions-Nil_in_Suffixes_iff"><span class="command">lemma</span></span> Nil_in_Suffixes_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> Suffixes <span class="free">A</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suffixes_def<span class="main">)</span>

<span class="keyword1" id="Regexp_Constructions-Suffixes_empty"><span class="command">lemma</span></span> Suffixes_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Suffixes <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suffixes_def<span class="main">)</span>
    
<span class="keyword1" id="Regexp_Constructions-Suffixes_empty_iff"><span class="command">lemma</span></span> Suffixes_empty_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Suffixes <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suffixes_altdef<span class="main">)</span>
    
<span class="keyword1" id="Regexp_Constructions-Suffixes_singleton"><span class="command">lemma</span></span> Suffixes_singleton <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Suffixes <span class="main">{</span><span class="free">xs</span><span class="main">}</span> <span class="main">=</span> set <span class="main">(</span>suffixes <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suffixes_altdef<span class="main">)</span>
    
<span class="keyword1" id="Regexp_Constructions-Suffixes_insert"><span class="command">lemma</span></span> Suffixes_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"Suffixes <span class="main">(</span>insert <span class="free">xs</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>suffixes <span class="free">xs</span><span class="main">)</span> <span class="main">∪</span> Suffixes <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suffixes_altdef<span class="main">)</span>

<span class="keyword1" id="Regexp_Constructions-Suffixes_conc"><span class="command">lemma</span></span> Suffixes_conc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> Suffixes <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Suffixes <span class="free">B</span> <span class="main">∪</span> <span class="main">(</span>Suffixes <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Suffixes_altdef conc_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> suffix_append<span class="main">)</span>
    
<span class="keyword1" id="Regexp_Constructions-Suffixes_union"><span class="command">lemma</span></span> Suffixes_union <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Suffixes <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Suffixes <span class="free">A</span> <span class="main">∪</span> Suffixes <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suffixes_def<span class="main">)</span>
  
<span class="keyword1" id="Regexp_Constructions-Suffixes_UNION"><span class="command">lemma</span></span> Suffixes_UNION <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Suffixes <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Suffixes <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suffixes_def<span class="main">)</span>

<span class="keyword1" id="Regexp_Constructions-Suffixes_compower"><span class="command">lemma</span></span> Suffixes_compower<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Suffixes <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">[]</span> <span class="main">(</span>Suffixes <span class="free">A</span> <span class="main">@@</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">A</span> <span class="main">^^</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suffixes <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> 
                   insert <span class="main">[]</span> <span class="main">(</span>Suffixes <span class="free">A</span> <span class="main">@@</span> <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">k</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="free">A</span> <span class="main">^^</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∪</span> <span class="free">A</span> <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms conc_Un_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">k</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="free">A</span> <span class="main">^^</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∪</span> <span class="free">A</span> <span class="main">^^</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">k</span><span class="main">∈</span>insert <span class="skolem">n</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="free">A</span> <span class="main">^^</span> <span class="bound">k</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">n</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">{..&lt;</span>Suc <span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Regexp_Constructions-Suffixes_star"><span class="command">lemma</span></span> Suffixes_star <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Suffixes <span class="main">(</span>star <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Suffixes <span class="free">A</span> <span class="main">@@</span> star <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"star <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="free">A</span> <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> star_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suffixes <span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> Suffixes <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> insert <span class="main">[]</span> <span class="main">(</span>Suffixes <span class="free">A</span> <span class="main">@@</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">k</span><span class="main">&lt;</span><span class="bound">n</span><span class="main">.</span> <span class="free">A</span> <span class="main">^^</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Suffixes_compower<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> insert <span class="main">[]</span> <span class="main">(</span>Suffixes <span class="free">A</span> <span class="main">@@</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">k</span><span class="main">&lt;</span><span class="bound">n</span><span class="main">.</span> <span class="free">A</span> <span class="main">^^</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conc_UNION_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">k</span><span class="main">&lt;</span><span class="bound">n</span><span class="main">.</span> <span class="free">A</span> <span class="main">^^</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="free">A</span> <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> star <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> star_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="main">[]</span> <span class="main">(</span>Suffixes <span class="free">A</span> <span class="main">@@</span> star <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Suffixes <span class="free">A</span> <span class="main">@@</span> star <span class="free">A</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Prefix language›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Prefixes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Prefixes</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">w</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="bound">w</span> <span class="main">@</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Regexp_Constructions-Prefixes_altdef"><span class="command">lemma</span></span> Prefixes_altdef <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Prefixes <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">w</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> set <span class="main">(</span>prefixes <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Prefixes_def set_prefixes_eq prefix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Regexp_Constructions-Nil_in_Prefixes_iff"><span class="command">lemma</span></span> Nil_in_Prefixes_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> Prefixes <span class="free">A</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Prefixes_def<span class="main">)</span>

<span class="keyword1" id="Regexp_Constructions-Prefixes_empty"><span class="command">lemma</span></span> Prefixes_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Prefixes <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Prefixes_def<span class="main">)</span>
    
<span class="keyword1" id="Regexp_Constructions-Prefixes_empty_iff"><span class="command">lemma</span></span> Prefixes_empty_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Prefixes <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Prefixes_altdef<span class="main">)</span>
    
<span class="keyword1" id="Regexp_Constructions-Prefixes_singleton"><span class="command">lemma</span></span> Prefixes_singleton <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Prefixes <span class="main">{</span><span class="free">xs</span><span class="main">}</span> <span class="main">=</span> set <span class="main">(</span>prefixes <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Prefixes_altdef<span class="main">)</span>
    
<span class="keyword1" id="Regexp_Constructions-Prefixes_insert"><span class="command">lemma</span></span> Prefixes_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"Prefixes <span class="main">(</span>insert <span class="free">xs</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>prefixes <span class="free">xs</span><span class="main">)</span> <span class="main">∪</span> Prefixes <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Prefixes_altdef<span class="main">)</span>

<span class="keyword1" id="Regexp_Constructions-Prefixes_conc"><span class="command">lemma</span></span> Prefixes_conc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> Prefixes <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Prefixes <span class="free">A</span> <span class="main">∪</span> <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> Prefixes <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Prefixes_altdef conc_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefix_append<span class="main">)</span>
    
<span class="keyword1" id="Regexp_Constructions-Prefixes_union"><span class="command">lemma</span></span> Prefixes_union <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Prefixes <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Prefixes <span class="free">A</span> <span class="main">∪</span> Prefixes <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Prefixes_def<span class="main">)</span>
  
<span class="keyword1" id="Regexp_Constructions-Prefixes_UNION"><span class="command">lemma</span></span> Prefixes_UNION <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Prefixes <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Prefixes <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Prefixes_def<span class="main">)</span>


<span class="keyword1" id="Regexp_Constructions-Prefixes_rev"><span class="command">lemma</span></span> Prefixes_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"Prefixes <span class="main">(</span>rev <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> rev <span class="main">`</span> Suffixes <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Prefixes_altdef prefixes_rev Suffixes_altdef<span class="main">)</span>

<span class="keyword1" id="Regexp_Constructions-Suffixes_rev"><span class="command">lemma</span></span> Suffixes_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"Suffixes <span class="main">(</span>rev <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> rev <span class="main">`</span> Prefixes <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Prefixes_altdef suffixes_rev Suffixes_altdef<span class="main">)</span>    


<span class="keyword1" id="Regexp_Constructions-Prefixes_compower"><span class="command">lemma</span></span> Prefixes_compower<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Prefixes <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">[]</span> <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">A</span> <span class="main">^^</span> <span class="bound">k</span><span class="main">)</span> <span class="main">@@</span> Prefixes <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">^^</span> <span class="free">n</span> <span class="main">=</span> rev <span class="main">`</span> <span class="main">(</span><span class="main">(</span>rev <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_image<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Prefixes <span class="main">…</span> <span class="main">=</span> insert <span class="main">[]</span> <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">A</span> <span class="main">^^</span> <span class="bound">k</span><span class="main">)</span> <span class="main">@@</span> Prefixes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Prefixes_rev 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Suffixes_compower<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_UN image_image Suffixes_rev assms<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Regexp_Constructions-Prefixes_star"><span class="command">lemma</span></span> Prefixes_star <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Prefixes <span class="main">(</span>star <span class="free">A</span><span class="main">)</span> <span class="main">=</span> star <span class="free">A</span> <span class="main">@@</span> Prefixes <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"star <span class="free">A</span> <span class="main">=</span> rev <span class="main">`</span> star <span class="main">(</span>rev <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_image<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Prefixes <span class="main">…</span> <span class="main">=</span> star <span class="free">A</span> <span class="main">@@</span> Prefixes <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Prefixes_rev
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Suffixes_star<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms image_image Suffixes_rev<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Subword language›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The language of all sub-words, i.e. all words that are a contiguous sublist of a word in
  the original language.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Sublists</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Sublists</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">w</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> sublist <span class="bound">w</span> <span class="bound">q</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Regexp_Constructions-Sublists_altdef"><span class="command">lemma</span></span> Sublists_altdef <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Sublists <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">w</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> set <span class="main">(</span>sublists <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sublists_def<span class="main">)</span>

<span class="keyword1" id="Regexp_Constructions-Sublists_empty"><span class="command">lemma</span></span> Sublists_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Sublists <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sublists_def<span class="main">)</span>
    
<span class="keyword1" id="Regexp_Constructions-Sublists_singleton"><span class="command">lemma</span></span> Sublists_singleton <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Sublists <span class="main">{</span><span class="free">w</span><span class="main">}</span> <span class="main">=</span> set <span class="main">(</span>sublists <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sublists_altdef<span class="main">)</span>

<span class="keyword1" id="Regexp_Constructions-Sublists_insert"><span class="command">lemma</span></span> Sublists_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"Sublists <span class="main">(</span>insert <span class="free">w</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>sublists <span class="free">w</span><span class="main">)</span> <span class="main">∪</span> Sublists <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sublists_altdef<span class="main">)</span>
    
<span class="keyword1" id="Regexp_Constructions-Sublists_Un"><span class="command">lemma</span></span> Sublists_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Sublists <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Sublists <span class="free">A</span> <span class="main">∪</span> Sublists <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sublists_altdef<span class="main">)</span>

<span class="keyword1" id="Regexp_Constructions-Sublists_UN"><span class="command">lemma</span></span> Sublists_UN <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Sublists <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Sublists <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sublists_altdef<span class="main">)</span>

<span class="keyword1" id="Regexp_Constructions-Sublists_conv_Prefixes"><span class="command">lemma</span></span> Sublists_conv_Prefixes<span class="main">:</span> <span class="quoted"><span class="quoted">"Sublists <span class="free">A</span> <span class="main">=</span> Prefixes <span class="main">(</span>Suffixes <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sublists_def Prefixes_def Suffixes_def sublist_def<span class="main">)</span>
    
<span class="keyword1" id="Regexp_Constructions-Sublists_conv_Suffixes"><span class="command">lemma</span></span> Sublists_conv_Suffixes<span class="main">:</span> <span class="quoted"><span class="quoted">"Sublists <span class="free">A</span> <span class="main">=</span> Suffixes <span class="main">(</span>Prefixes <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sublists_def Prefixes_def Suffixes_def sublist_def<span class="main">)</span>

<span class="keyword1" id="Regexp_Constructions-Sublists_conc"><span class="command">lemma</span></span> Sublists_conc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Sublists <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Sublists <span class="free">A</span> <span class="main">∪</span> Sublists <span class="free">B</span> <span class="main">∪</span> Suffixes <span class="free">A</span> <span class="main">@@</span> Prefixes <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Sublists_conv_Suffixes <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Regexp_Constructions-star_not_empty"><span class="command">lemma</span></span> star_not_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"star <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
<span class="keyword1" id="Regexp_Constructions-Sublists_star"><span class="command">lemma</span></span> Sublists_star<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> Sublists <span class="main">(</span>star <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Sublists <span class="free">A</span> <span class="main">∪</span> Suffixes <span class="free">A</span> <span class="main">@@</span> star <span class="free">A</span> <span class="main">@@</span> Prefixes <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sublists_conv_Prefixes<span class="main">)</span>

<span class="keyword1" id="Regexp_Constructions-Prefixes_subset_Sublists"><span class="command">lemma</span></span> Prefixes_subset_Sublists<span class="main">:</span> <span class="quoted"><span class="quoted">"Prefixes <span class="free">A</span> <span class="main">⊆</span> Sublists <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Prefixes_def Sublists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Regexp_Constructions-Suffixes_subset_Sublists"><span class="command">lemma</span></span> Suffixes_subset_Sublists<span class="main">:</span> <span class="quoted"><span class="quoted">"Suffixes <span class="free">A</span> <span class="main">⊆</span> Sublists <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Suffixes_def Sublists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Fragment language›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following is the fragment language of a given language, i.e. the set of all words that
  are (not necessarily contiguous) sub-sequences of a word in the original language.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Subseqs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Subseqs</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">w</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> set <span class="main">(</span>subseqs <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Regexp_Constructions-Subseqs_empty"><span class="command">lemma</span></span> Subseqs_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Subseqs <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Subseqs_def<span class="main">)</span>

<span class="keyword1" id="Regexp_Constructions-Subseqs_insert"><span class="command">lemma</span></span> Subseqs_insert <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Subseqs <span class="main">(</span>insert <span class="free">xs</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>subseqs <span class="free">xs</span><span class="main">)</span> <span class="main">∪</span> Subseqs <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Subseqs_def<span class="main">)</span>
    
<span class="keyword1" id="Regexp_Constructions-Subseqs_singleton"><span class="command">lemma</span></span> Subseqs_singleton <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Subseqs <span class="main">{</span><span class="free">xs</span><span class="main">}</span> <span class="main">=</span> set <span class="main">(</span>subseqs <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
<span class="keyword1" id="Regexp_Constructions-Subseqs_Un"><span class="command">lemma</span></span> Subseqs_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Subseqs <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Subseqs <span class="free">A</span> <span class="main">∪</span> Subseqs <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Subseqs_def<span class="main">)</span>
    
<span class="keyword1" id="Regexp_Constructions-Subseqs_UNION"><span class="command">lemma</span></span> Subseqs_UNION <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Subseqs <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Subseqs <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Subseqs_def<span class="main">)</span>
  
<span class="keyword1" id="Regexp_Constructions-Subseqs_conc"><span class="command">lemma</span></span> Subseqs_conc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Subseqs <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Subseqs <span class="free">A</span> <span class="main">@@</span> Subseqs <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> Subseqs <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"subseq <span class="skolem">xs</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Subseqs_def conc_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs1</span></span> <span class="skolem"><span class="skolem">xs2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">xs1</span> <span class="main">@</span> <span class="skolem">xs2</span>"</span></span> <span class="quoted"><span class="quoted">"subseq <span class="skolem">xs1</span> <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"subseq <span class="skolem">xs2</span> <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subseq_appendE<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> *<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> Subseqs <span class="free">A</span> <span class="main">@@</span> Subseqs <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Subseqs_def set_subseqs_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> Subseqs <span class="free">A</span> <span class="main">@@</span> Subseqs <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs1</span></span> <span class="skolem"><span class="skolem">xs2</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">zs</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">xs1</span> <span class="main">@</span> <span class="skolem">xs2</span>"</span></span> <span class="quoted"><span class="quoted">"subseq <span class="skolem">xs1</span> <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"subseq <span class="skolem">xs2</span> <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_def Subseqs_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> Subseqs <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Subseqs_def conc_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list_emb_append_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Regexp_Constructions-Subseqs_compower"><span class="command">lemma</span></span> Subseqs_compower <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Subseqs <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Subseqs <span class="free">A</span> <span class="main">^^</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    
<span class="keyword1" id="Regexp_Constructions-Subseqs_star"><span class="command">lemma</span></span> Subseqs_star <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Subseqs <span class="main">(</span>star <span class="free">A</span><span class="main">)</span> <span class="main">=</span> star <span class="main">(</span>Subseqs <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_def<span class="main">)</span>
    
<span class="keyword1" id="Regexp_Constructions-Sublists_subset_Subseqs"><span class="command">lemma</span></span> Sublists_subset_Subseqs<span class="main">:</span> <span class="quoted"><span class="quoted">"Sublists <span class="free">A</span> <span class="main">⊆</span> Subseqs <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sublists_def Subseqs_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sublist_imp_subseq<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Various regular expression constructions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A construction for language reversal of a regular expression:›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">rexp_rev</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rexp_rev</span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_rev</span> One <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_rev</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Atom <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_rev</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">rexp_rev</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rexp_rev</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_rev</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Times <span class="main">(</span><span class="free">rexp_rev</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rexp_rev</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_rev</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Star <span class="main">(</span><span class="free">rexp_rev</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Regexp_Constructions-lang_rexp_rev"><span class="command">lemma</span></span> lang_rexp_rev <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>rexp_rev <span class="free">r</span><span class="main">)</span> <span class="main">=</span> rev <span class="main">`</span> lang <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_Un<span class="main">)</span>  
    

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The obvious construction for a singleton-language regular expression:›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rexp_of_word</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rexp_of_word</span> <span class="main">[]</span> <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_word</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">=</span> Atom <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_word</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> Times <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rexp_of_word</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword1" id="Regexp_Constructions-lang_rexp_of_word"><span class="command">lemma</span></span> lang_rexp_of_word <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>rexp_of_word <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">xs</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rexp_of_word.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conc_def<span class="main">)</span>

<span class="keyword1" id="Regexp_Constructions-size_rexp_of_word"><span class="command">lemma</span></span> size_rexp_of_word <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>rexp_of_word <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rexp_of_word.induct<span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Character substitution in a regular expression:›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">rexp_subst</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rexp_subst</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_subst</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> One <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_subst</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> rexp_of_word <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_subst</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">rexp_subst</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rexp_subst</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_subst</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Times <span class="main">(</span><span class="free">rexp_subst</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rexp_subst</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_subst</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Star <span class="main">(</span><span class="free">rexp_subst</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Regexp_Constructions-lang_rexp_subst"><span class="command">lemma</span></span> lang_rexp_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>rexp_subst <span class="free">f</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> subst_word <span class="free">f</span> <span class="main">`</span> lang <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_Un<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Suffix language of a regular expression:›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">suffix_rexp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">suffix_rexp</span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">suffix_rexp</span> One <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">suffix_rexp</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">suffix_rexp</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">suffix_rexp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">suffix_rexp</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">suffix_rexp</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> rexp_empty <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> Zero <span class="keyword1">else</span> Plus <span class="main">(</span>Times <span class="main">(</span><span class="free">suffix_rexp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">suffix_rexp</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">suffix_rexp</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> rexp_empty <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> One <span class="keyword1">else</span> Times <span class="main">(</span><span class="free">suffix_rexp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> lang_suffix_rexp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lang <span class="main">(</span>suffix_rexp <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Suffixes <span class="main">(</span>lang <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rexp_empty_iff<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Prefix language of a regular expression:›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">prefix_rexp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prefix_rexp</span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">prefix_rexp</span> One <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">prefix_rexp</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">prefix_rexp</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">prefix_rexp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">prefix_rexp</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">prefix_rexp</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> rexp_empty <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> Zero <span class="keyword1">else</span> Plus <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free">prefix_rexp</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">prefix_rexp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">prefix_rexp</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> rexp_empty <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> One <span class="keyword1">else</span> Times <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">prefix_rexp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> lang_prefix_rexp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lang <span class="main">(</span>prefix_rexp <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Prefixes <span class="main">(</span>lang <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rexp_empty_iff<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Sub-word language of a regular expression›</span></span>    

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">sublist_rexp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sublist_rexp</span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sublist_rexp</span> One <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sublist_rexp</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sublist_rexp</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">sublist_rexp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">sublist_rexp</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sublist_rexp</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> rexp_empty <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∨</span> rexp_empty <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> Zero <span class="keyword1">else</span> 
       Plus <span class="main">(</span><span class="free">sublist_rexp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Plus <span class="main">(</span><span class="free">sublist_rexp</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>Times <span class="main">(</span>suffix_rexp <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>prefix_rexp <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sublist_rexp</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> rexp_empty <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> One <span class="keyword1">else</span> 
       Plus <span class="main">(</span><span class="free">sublist_rexp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Times <span class="main">(</span>suffix_rexp <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Times <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>prefix_rexp <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> lang_sublist_rexp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lang <span class="main">(</span>sublist_rexp <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Sublists <span class="main">(</span>lang <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rexp_empty_iff Sublists_star<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Fragment language of a regular expression:›</span></span>
  
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">subseqs_rexp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subseqs_rexp</span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subseqs_rexp</span> One <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subseqs_rexp</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subseqs_rexp</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">subseqs_rexp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">subseqs_rexp</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subseqs_rexp</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Times <span class="main">(</span><span class="free">subseqs_rexp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">subseqs_rexp</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subseqs_rexp</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Star <span class="main">(</span><span class="free">subseqs_rexp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Regexp_Constructions-lang_subseqs_rexp"><span class="command">lemma</span></span> lang_subseqs_rexp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>subseqs_rexp <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Subseqs <span class="main">(</span>lang <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Subword language of a regular expression›</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Derivatives">
<div class="head">
<h1>Theory Derivatives</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Derivatives of regular expressions"</span></span>

<span class="comment1">(* Author: Christian Urban *)</span>

<span class="keyword1"><span class="command">theory</span></span> Derivatives
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Regular_Exp.html">Regular_Exp</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This theory is based on work by Brozowski \cite{Brzozowski64} and Antimirov \cite{Antimirov95}.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Brzozowski's derivatives of regular expressions›</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">deriv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Zero<span class="main">)</span> <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>One<span class="main">)</span> <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="keyword1">then</span> One <span class="keyword1">else</span> Zero<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> nullable <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="keyword1">then</span> Plus <span class="main">(</span>Times <span class="main">(</span><span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="keyword1">else</span> Times <span class="main">(</span><span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Times <span class="main">(</span><span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> 
  <span class="entity">derivs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">derivs</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">derivs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free">derivs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>deriv <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1" id="Derivatives-atoms_deriv_subset"><span class="command">lemma</span></span> atoms_deriv_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"atoms <span class="main">(</span>deriv <span class="free">x</span> <span class="free">r</span><span class="main">)</span> <span class="main">⊆</span> atoms <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Derivatives-atoms_derivs_subset"><span class="command">lemma</span></span> atoms_derivs_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"atoms <span class="main">(</span>derivs <span class="free">w</span> <span class="free">r</span><span class="main">)</span> <span class="main">⊆</span> atoms <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> atoms_deriv_subset<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Derivatives-lang_deriv"><span class="command">lemma</span></span> lang_deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>deriv <span class="free">c</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Deriv <span class="free">c</span> <span class="main">(</span>lang <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nullable_iff<span class="main">)</span>

<span class="keyword1" id="Derivatives-lang_derivs"><span class="command">lemma</span></span> lang_derivs<span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>derivs <span class="free">s</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Derivs <span class="free">s</span> <span class="main">(</span>lang <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lang_deriv<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A regular expression matcher:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">matcher</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">matcher</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> nullable <span class="main">(</span>derivs <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Derivatives-matcher_correctness"><span class="command">lemma</span></span> matcher_correctness<span class="main">:</span> <span class="quoted"><span class="quoted">"matcher <span class="free">r</span> <span class="free">s</span> <span class="main">⟷</span> <span class="free">s</span> <span class="main">∈</span> lang <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nullable_iff lang_deriv matcher_def Deriv_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Antimirov's partial derivatives›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Timess</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r'</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">.</span> <span class="main">{</span>Times <span class="bound">r'</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Derivatives-Timess_eq_image"><span class="command">lemma</span></span> Timess_eq_image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Timess <span class="free">rs</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r'</span><span class="main">.</span> Times <span class="bound">r'</span> <span class="free">r</span><span class="main">)</span> <span class="main">`</span> <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">pderiv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> Zero <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> One <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="keyword1">then</span> <span class="main">{</span>One<span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">pderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">pderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> nullable <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="keyword1">then</span> Timess <span class="main">(</span><span class="free">pderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="main">∪</span> <span class="free">pderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="keyword1">else</span> Timess <span class="main">(</span><span class="free">pderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Timess <span class="main">(</span><span class="free">pderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">pderivs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pderivs</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pderivs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">pderivs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">`</span> pderiv <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
 <span class="entity">pderiv_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> rexp set <span class="main">⇒</span> <span class="tfree">'a</span> rexp set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pderiv_set</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">≡</span> <span class="main">⋃</span> <span class="main">(</span>pderiv <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">pderivs_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> rexp set <span class="main">⇒</span> <span class="tfree">'a</span> rexp set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pderivs_set</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">≡</span> <span class="main">⋃</span> <span class="main">(</span>pderivs <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Derivatives-pderivs_append"><span class="command">lemma</span></span> pderivs_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pderivs <span class="main">(</span><span class="free">s1</span> <span class="main">@</span> <span class="free">s2</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>pderivs <span class="free">s2</span> <span class="main">`</span> pderivs <span class="free">s1</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Derivatives-pderivs_snoc"><span class="command">lemma</span></span> pderivs_snoc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pderivs <span class="main">(</span><span class="free">s</span> <span class="main">@</span> <span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> pderiv_set <span class="free">c</span> <span class="main">(</span>pderivs <span class="free">s</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pderivs_append<span class="main">)</span>

<span class="keyword1" id="Derivatives-pderivs_simps"><span class="command">lemma</span></span> pderivs_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pderivs <span class="free">s</span> Zero <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">s</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">{</span>Zero<span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"pderivs <span class="free">s</span> One <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">s</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">{</span>One<span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"pderivs <span class="free">s</span> <span class="main">(</span>Plus <span class="free">r1</span> <span class="free">r2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">s</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">{</span>Plus <span class="free">r1</span> <span class="free">r2</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">(</span>pderivs <span class="free">s</span> <span class="free">r1</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>pderivs <span class="free">s</span> <span class="free">r2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Derivatives-pderivs_Atom"><span class="command">lemma</span></span> pderivs_Atom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pderivs <span class="free">s</span> <span class="main">(</span>Atom <span class="free">c</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>Atom <span class="free">c</span><span class="main">,</span> One<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Relating left-quotients and partial derivatives›</span></span>

<span class="keyword1" id="Derivatives-Deriv_pderiv"><span class="command">lemma</span></span> Deriv_pderiv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Deriv <span class="free">c</span> <span class="main">(</span>lang <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>lang <span class="main">`</span> pderiv <span class="free">c</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nullable_iff conc_UNION_distrib<span class="main">)</span>

<span class="keyword1" id="Derivatives-Derivs_pderivs"><span class="command">lemma</span></span> Derivs_pderivs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Derivs <span class="free">s</span> <span class="main">(</span>lang <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>lang <span class="main">`</span> pderivs <span class="free">s</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> Derivs <span class="skolem">s</span> <span class="main">(</span>lang <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>lang <span class="main">`</span> pderivs <span class="skolem">s</span> <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Derivs <span class="main">(</span><span class="skolem">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>lang <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> Derivs <span class="skolem">s</span> <span class="main">(</span>Deriv <span class="skolem">c</span> <span class="main">(</span>lang <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Derivs <span class="skolem">s</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>lang <span class="main">`</span> pderiv <span class="skolem">c</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Deriv_pderiv<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Derivss <span class="skolem">s</span> <span class="main">(</span>lang <span class="main">`</span> <span class="main">(</span>pderiv <span class="skolem">c</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  Derivs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>lang <span class="main">`</span> <span class="main">(</span>pderivs_set <span class="skolem">s</span> <span class="main">(</span>pderiv <span class="skolem">c</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>lang <span class="main">`</span> <span class="main">(</span>pderivs <span class="main">(</span><span class="skolem">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Derivs <span class="main">(</span><span class="skolem">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>lang <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>lang <span class="main">`</span> pderivs <span class="main">(</span><span class="skolem">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derivs_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Relating derivatives and partial derivatives›</span></span>

<span class="keyword1" id="Derivatives-deriv_pderiv"><span class="command">lemma</span></span> deriv_pderiv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>lang <span class="main">`</span> <span class="main">(</span>pderiv <span class="free">c</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lang <span class="main">(</span>deriv <span class="free">c</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> lang_deriv Deriv_pderiv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Derivatives-derivs_pderivs"><span class="command">lemma</span></span> derivs_pderivs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>lang <span class="main">`</span> <span class="main">(</span>pderivs <span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lang <span class="main">(</span>derivs <span class="free">s</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> lang_derivs Derivs_pderivs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Finiteness property of partial derivatives›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">pderivs_lang</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pderivs_lang</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> pderivs <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1" id="Derivatives-pderivs_lang_subsetI"><span class="command">lemma</span></span> pderivs_lang_subsetI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> pderivs <span class="bound">s</span> <span class="free">r</span> <span class="main">⊆</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pderivs_lang <span class="free">A</span> <span class="free">r</span> <span class="main">⊆</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> pderivs_lang_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> UN_least<span class="main">)</span>

<span class="keyword1" id="Derivatives-pderivs_lang_union"><span class="command">lemma</span></span> pderivs_lang_union<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pderivs_lang <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span>pderivs_lang <span class="free">A</span> <span class="free">r</span> <span class="main">∪</span> pderivs_lang <span class="free">B</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pderivs_lang_def<span class="main">)</span>

<span class="keyword1" id="Derivatives-pderivs_lang_subset"><span class="command">lemma</span></span> pderivs_lang_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> pderivs_lang <span class="free">A</span> <span class="free">r</span> <span class="main">⊆</span> pderivs_lang <span class="free">B</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pderivs_lang_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">UNIV1</span> <span class="main">≡</span> UNIV <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Derivatives-pderivs_lang_Zero"><span class="command">lemma</span></span> pderivs_lang_Zero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pderivs_lang UNIV1 Zero <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> UNIV1_def pderivs_lang_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Derivatives-pderivs_lang_One"><span class="command">lemma</span></span> pderivs_lang_One <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pderivs_lang UNIV1 One <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> UNIV1_def pderivs_lang_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="Derivatives-pderivs_lang_Atom"><span class="command">lemma</span></span> pderivs_lang_Atom <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pderivs_lang UNIV1 <span class="main">(</span>Atom <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>One<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> UNIV1_def pderivs_lang_def 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> rev_subsetD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pderivs_Atom<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">xa</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Derivatives-pderivs_lang_Plus"><span class="command">lemma</span></span> pderivs_lang_Plus <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pderivs_lang UNIV1 <span class="main">(</span>Plus <span class="free">r1</span> <span class="free">r2</span><span class="main">)</span> <span class="main">=</span> pderivs_lang UNIV1 <span class="free">r1</span> <span class="main">∪</span> pderivs_lang UNIV1 <span class="free">r2</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> UNIV1_def pderivs_lang_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Non-empty suffixes of a string (needed for the cases of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Times<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Star<span class="antiquote"><span class="antiquote">}</span></span></span></span> below)›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">PSuf</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">@</span> <span class="bound">v</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Derivatives-PSuf_snoc"><span class="command">lemma</span></span> PSuf_snoc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"PSuf <span class="main">(</span><span class="free">s</span> <span class="main">@</span> <span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>PSuf <span class="free">s</span><span class="main">)</span> <span class="main">@@</span> <span class="main">{</span><span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> PSuf_def conc_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_eq_append_conv2 append_eq_Cons_conv<span class="main">)</span>

<span class="keyword1" id="Derivatives-PSuf_Union"><span class="command">lemma</span></span> PSuf_Union<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">v</span> <span class="main">∈</span> PSuf <span class="free">s</span> <span class="main">@@</span> <span class="main">{</span><span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">v</span> <span class="main">∈</span> PSuf <span class="free">s</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">v</span> <span class="main">@</span> <span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conc_def<span class="main">)</span>

<span class="keyword1" id="Derivatives-pderivs_lang_snoc"><span class="command">lemma</span></span> pderivs_lang_snoc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pderivs_lang <span class="main">(</span>PSuf <span class="free">s</span> <span class="main">@@</span> <span class="main">{</span><span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">}</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span>pderiv_set <span class="free">c</span> <span class="main">(</span>pderivs_lang <span class="main">(</span>PSuf <span class="free">s</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> pderivs_lang_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PSuf_Union pderivs_snoc<span class="main">)</span>

<span class="keyword1" id="Derivatives-pderivs_Times"><span class="command">lemma</span></span> pderivs_Times<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pderivs <span class="free">s</span> <span class="main">(</span>Times <span class="free">r1</span> <span class="free">r2</span><span class="main">)</span> <span class="main">⊆</span> Timess <span class="main">(</span>pderivs <span class="free">s</span> <span class="free">r1</span><span class="main">)</span> <span class="free">r2</span> <span class="main">∪</span> <span class="main">(</span>pderivs_lang <span class="main">(</span>PSuf <span class="free">s</span><span class="main">)</span> <span class="free">r2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"pderivs <span class="skolem">s</span> <span class="main">(</span>Times <span class="free">r1</span> <span class="free">r2</span><span class="main">)</span> <span class="main">⊆</span> Timess <span class="main">(</span>pderivs <span class="skolem">s</span> <span class="free">r1</span><span class="main">)</span> <span class="free">r2</span> <span class="main">∪</span> <span class="main">(</span>pderivs_lang <span class="main">(</span>PSuf <span class="skolem">s</span><span class="main">)</span> <span class="free">r2</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pderivs <span class="main">(</span><span class="skolem">s</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Times <span class="free">r1</span> <span class="free">r2</span><span class="main">)</span> <span class="main">=</span> pderiv_set <span class="skolem">c</span> <span class="main">(</span>pderivs <span class="skolem">s</span> <span class="main">(</span>Times <span class="free">r1</span> <span class="free">r2</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pderivs_snoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> pderiv_set <span class="skolem">c</span> <span class="main">(</span>Timess <span class="main">(</span>pderivs <span class="skolem">s</span> <span class="free">r1</span><span class="main">)</span> <span class="free">r2</span> <span class="main">∪</span> <span class="main">(</span>pderivs_lang <span class="main">(</span>PSuf <span class="skolem">s</span><span class="main">)</span> <span class="free">r2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pderiv_set <span class="skolem">c</span> <span class="main">(</span>Timess <span class="main">(</span>pderivs <span class="skolem">s</span> <span class="free">r1</span><span class="main">)</span> <span class="free">r2</span><span class="main">)</span> <span class="main">∪</span> pderiv_set <span class="skolem">c</span> <span class="main">(</span>pderivs_lang <span class="main">(</span>PSuf <span class="skolem">s</span><span class="main">)</span> <span class="free">r2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pderiv_set <span class="skolem">c</span> <span class="main">(</span>Timess <span class="main">(</span>pderivs <span class="skolem">s</span> <span class="free">r1</span><span class="main">)</span> <span class="free">r2</span><span class="main">)</span> <span class="main">∪</span> pderivs_lang <span class="main">(</span>PSuf <span class="skolem">s</span> <span class="main">@@</span> <span class="main">{</span><span class="main">[</span><span class="skolem">c</span><span class="main">]</span><span class="main">}</span><span class="main">)</span> <span class="free">r2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pderivs_lang_snoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> pderiv_set <span class="skolem">c</span> <span class="main">(</span>Timess <span class="main">(</span>pderivs <span class="skolem">s</span> <span class="free">r1</span><span class="main">)</span> <span class="free">r2</span><span class="main">)</span> <span class="main">∪</span> pderiv <span class="skolem">c</span> <span class="free">r2</span> <span class="main">∪</span> pderivs_lang <span class="main">(</span>PSuf <span class="skolem">s</span> <span class="main">@@</span> <span class="main">{</span><span class="main">[</span><span class="skolem">c</span><span class="main">]</span><span class="main">}</span><span class="main">)</span> <span class="free">r2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> Timess <span class="main">(</span>pderiv_set <span class="skolem">c</span> <span class="main">(</span>pderivs <span class="skolem">s</span> <span class="free">r1</span><span class="main">)</span><span class="main">)</span> <span class="free">r2</span> <span class="main">∪</span> pderiv <span class="skolem">c</span> <span class="free">r2</span> <span class="main">∪</span> pderivs_lang <span class="main">(</span>PSuf <span class="skolem">s</span> <span class="main">@@</span> <span class="main">{</span><span class="main">[</span><span class="skolem">c</span><span class="main">]</span><span class="main">}</span><span class="main">)</span> <span class="free">r2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Timess <span class="main">(</span>pderivs <span class="main">(</span><span class="skolem">s</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span><span class="main">)</span> <span class="free">r1</span><span class="main">)</span> <span class="free">r2</span> <span class="main">∪</span> pderiv <span class="skolem">c</span> <span class="free">r2</span> <span class="main">∪</span> pderivs_lang <span class="main">(</span>PSuf <span class="skolem">s</span> <span class="main">@@</span> <span class="main">{</span><span class="main">[</span><span class="skolem">c</span><span class="main">]</span><span class="main">}</span><span class="main">)</span> <span class="free">r2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pderivs_snoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> Timess <span class="main">(</span>pderivs <span class="main">(</span><span class="skolem">s</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span><span class="main">)</span> <span class="free">r1</span><span class="main">)</span> <span class="free">r2</span> <span class="main">∪</span> pderivs_lang <span class="main">(</span>PSuf <span class="main">(</span><span class="skolem">s</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">r2</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pderivs_lang_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PSuf_snoc<span class="main">)</span>  
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> 

<span class="keyword1" id="Derivatives-pderivs_lang_Times_aux1"><span class="command">lemma</span></span> pderivs_lang_Times_aux1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> UNIV1"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pderivs_lang <span class="main">(</span>PSuf <span class="free">s</span><span class="main">)</span> <span class="free">r</span> <span class="main">⊆</span> pderivs_lang UNIV1 <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">unfolding</span></span> UNIV1_def PSuf_def pderivs_lang_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Derivatives-pderivs_lang_Times_aux2"><span class="command">lemma</span></span> pderivs_lang_Times_aux2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> UNIV1"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Timess <span class="main">(</span>pderivs <span class="free">s</span> <span class="free">r1</span><span class="main">)</span> <span class="free">r2</span> <span class="main">⊆</span> Timess <span class="main">(</span>pderivs_lang UNIV1 <span class="free">r1</span><span class="main">)</span> <span class="free">r2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">unfolding</span></span> pderivs_lang_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Derivatives-pderivs_lang_Times"><span class="command">lemma</span></span> pderivs_lang_Times<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pderivs_lang UNIV1 <span class="main">(</span>Times <span class="free">r1</span> <span class="free">r2</span><span class="main">)</span> <span class="main">⊆</span> Timess <span class="main">(</span>pderivs_lang UNIV1 <span class="free">r1</span><span class="main">)</span> <span class="free">r2</span> <span class="main">∪</span> pderivs_lang UNIV1 <span class="free">r2</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pderivs_lang_subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pderivs_Times<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> pderivs_lang_Times_aux1 pderivs_lang_Times_aux2
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Derivatives-pderivs_Star"><span class="command">lemma</span></span> pderivs_Star<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pderivs <span class="free">s</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span> <span class="main">⊆</span> Timess <span class="main">(</span>pderivs_lang <span class="main">(</span>PSuf <span class="free">s</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> a
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> pderivs <span class="skolem">s</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span> <span class="main">⊆</span> Timess <span class="main">(</span>pderivs_lang <span class="main">(</span>PSuf <span class="skolem">s</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pderivs <span class="main">(</span><span class="skolem">s</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span> <span class="main">=</span> pderiv_set <span class="skolem">c</span> <span class="main">(</span>pderivs <span class="skolem">s</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pderivs_snoc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> pderiv_set <span class="skolem">c</span> <span class="main">(</span>Timess <span class="main">(</span>pderivs_lang <span class="main">(</span>PSuf <span class="skolem">s</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">OF</span> asm<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> Timess <span class="main">(</span>pderiv_set <span class="skolem">c</span> <span class="main">(</span>pderivs_lang <span class="main">(</span>PSuf <span class="skolem">s</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span> <span class="main">∪</span> pderiv <span class="skolem">c</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> Timess <span class="main">(</span>pderivs_lang <span class="main">(</span>PSuf <span class="main">(</span><span class="skolem">s</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>Timess <span class="main">(</span>pderiv <span class="skolem">c</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> PSuf_snoc pderivs_lang_snoc pderivs_lang_union<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pderivs_lang_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Timess <span class="main">(</span>pderivs_lang <span class="main">(</span>PSuf <span class="main">(</span><span class="skolem">s</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PSuf_snoc PSuf_Union pderivs_snoc pderivs_lang_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pderivs_lang_def pderivs_snoc PSuf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Derivatives-pderivs_lang_Star"><span class="command">lemma</span></span> pderivs_lang_Star<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pderivs_lang UNIV1 <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span> <span class="main">⊆</span> Timess <span class="main">(</span>pderivs_lang UNIV1 <span class="free">r</span><span class="main">)</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pderivs_lang_subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pderivs_Star<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> UNIV1_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> UNIV1_def PSuf_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pderivs_lang_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Derivatives-finite_Timess"><span class="command">lemma</span></span> finite_Timess <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Timess <span class="free">A</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Derivatives-finite_pderivs_lang_UNIV1"><span class="command">lemma</span></span> finite_pderivs_lang_UNIV1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pderivs_lang UNIV1 <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 
  finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pderivs_lang_Times<span class="main"><span class="main">]</span></span>
  finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pderivs_lang_Star<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
<span class="keyword1" id="Derivatives-pderivs_lang_UNIV"><span class="command">lemma</span></span> pderivs_lang_UNIV<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pderivs_lang UNIV <span class="free">r</span> <span class="main">=</span> pderivs <span class="main">[]</span> <span class="free">r</span> <span class="main">∪</span> pderivs_lang UNIV1 <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> UNIV1_def pderivs_lang_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Derivatives-finite_pderivs_lang_UNIV"><span class="command">lemma</span></span> finite_pderivs_lang_UNIV<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pderivs_lang UNIV <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> pderivs_lang_UNIV
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_pderivs_lang_UNIV1<span class="main">)</span>

<span class="keyword1" id="Derivatives-finite_pderivs_lang"><span class="command">lemma</span></span> finite_pderivs_lang<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pderivs_lang <span class="free">A</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_pderivs_lang_UNIV pderivs_lang_subset rev_finite_subset subset_UNIV<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The following relationship between the alphabetic width of regular expressions
(called <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>awidth›</span></span></span></span> below) and the number of partial derivatives was proved
by Antimirov~\cite{Antimirov95} and formalized by Max Haslbeck.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">awidth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">awidth</span> Zero <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">awidth</span> One <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">awidth</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">awidth</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">awidth</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main">+</span> <span class="free">awidth</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">awidth</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">awidth</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main">+</span> <span class="free">awidth</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">awidth</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">awidth</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span>"</span></span>

<span class="keyword1" id="Derivatives-card_Timess_pderivs_lang_le"><span class="command">lemma</span></span> card_Timess_pderivs_lang_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"card <span class="main">(</span>Timess <span class="main">(</span>pderivs_lang <span class="free">A</span> <span class="free">r</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>pderivs_lang <span class="free">A</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_pderivs_lang <span class="keyword1"><span class="command">unfolding</span></span> Timess_eq_image <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_image_le<span class="main">)</span>

<span class="keyword1" id="Derivatives-card_pderivs_lang_UNIV1_le_awidth"><span class="command">lemma</span></span> card_pderivs_lang_UNIV1_le_awidth<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>pderivs_lang UNIV1 <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> awidth <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>pderivs_lang UNIV1 <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>pderivs_lang UNIV1 <span class="skolem">r1</span> <span class="main">∪</span> pderivs_lang UNIV1 <span class="skolem">r2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="main">(</span>pderivs_lang UNIV1 <span class="skolem">r1</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span>pderivs_lang UNIV1 <span class="skolem">r2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Un_le<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> awidth <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Plus.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>pderivs_lang UNIV1 <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>Timess <span class="main">(</span>pderivs_lang UNIV1 <span class="skolem">r1</span><span class="main">)</span> <span class="skolem">r2</span> <span class="main">∪</span> pderivs_lang UNIV1 <span class="skolem">r2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_mono finite_pderivs_lang pderivs_lang_Times<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="main">(</span>Timess <span class="main">(</span>pderivs_lang UNIV1 <span class="skolem">r1</span><span class="main">)</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span>pderivs_lang UNIV1 <span class="skolem">r2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Un_le<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="main">(</span>pderivs_lang UNIV1 <span class="skolem">r1</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span>pderivs_lang UNIV1 <span class="skolem">r2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Timess_pderivs_lang_le<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> awidth <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Times.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>pderivs_lang UNIV1 <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>Timess <span class="main">(</span>pderivs_lang UNIV1 <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_mono finite_pderivs_lang pderivs_lang_Star<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="main">(</span>pderivs_lang UNIV1 <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_Timess_pderivs_lang_le<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> awidth <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Star.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Antimirov's Theorem 3.4:›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> card_pderivs_lang_UNIV_le_awidth<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>pderivs_lang UNIV <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> awidth <span class="free">r</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="free">r</span> <span class="main">(</span>pderivs_lang UNIV1 <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> Suc <span class="main">(</span>card <span class="main">(</span>pderivs_lang UNIV1 <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_insert_if<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_pderivs_lang_UNIV1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> Suc <span class="main">(</span>awidth <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_pderivs_lang_UNIV1_le_awidth<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pderivs_lang_UNIV<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Antimirov's Corollary 3.5:›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> card_pderivs_lang_le_awidth<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>pderivs_lang <span class="free">A</span> <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> awidth <span class="free">r</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span>
  card_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_pderivs_lang_UNIV pderivs_lang_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subset_UNIV<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span>
  card_pderivs_lang_UNIV_le_awidth<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="pEquivalence_Checking">
<div class="head">
<h1>Theory pEquivalence_Checking</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deciding Regular Expression Equivalence (2)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> pEquivalence_Checking
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Equivalence_Checking.html">Equivalence_Checking</a> <a href="Derivatives.html">Derivatives</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹\noindent Similar to theory <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> "<a href="Equivalence_Checking.html"></a><a href="Equivalence_Checking.html">Regular-Sets.Equivalence_Checking</a>"<span class="antiquote"><span class="antiquote">}</span></span></span></span>, but
with partial derivatives instead of derivatives.›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Lifting many notions to sets:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Lang</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">==</span> <span class="keyword1">UN</span> <span class="bound">r</span><span class="main">:</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> lang <span class="bound">r</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Nullable</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">==</span> <span class="keyword1">EX</span> <span class="bound">r</span><span class="main">:</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> nullable <span class="bound">r</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Pderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">==</span> <span class="keyword1">UN</span> <span class="bound">r</span><span class="main">:</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> pderiv <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">r</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Atoms</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">==</span> <span class="keyword1">UN</span> <span class="bound">r</span><span class="main">:</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> atoms <span class="bound">r</span>"</span></span>

<span class="comment1">(* FIXME: rename pderiv_set in Derivatives to Pderiv and drop the one above *)</span>

<span class="keyword1" id="pEquivalence_Checking-Atoms_pderiv"><span class="command">lemma</span></span> Atoms_pderiv<span class="main">:</span> <span class="quoted"><span class="quoted">"Atoms<span class="main">(</span>pderiv <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">⊆</span> atoms <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Atoms_def UN_subset_iff<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pEquivalence_Checking-Atoms_Pderiv"><span class="command">lemma</span></span> Atoms_Pderiv<span class="main">:</span> <span class="quoted"><span class="quoted">"Atoms<span class="main">(</span>Pderiv <span class="free">a</span> <span class="free">R</span><span class="main">)</span> <span class="main">⊆</span> Atoms <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Atoms_pderiv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Atoms_def Pderiv_def<span class="main">)</span>

<span class="keyword1" id="pEquivalence_Checking-pderiv_no_occurrence"><span class="command">lemma</span></span> pderiv_no_occurrence<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> atoms <span class="free">r</span> <span class="main">⟹</span> pderiv <span class="free">x</span> <span class="free">r</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="pEquivalence_Checking-Pderiv_no_occurrence"><span class="command">lemma</span></span> Pderiv_no_occurrence<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> Atoms <span class="free">R</span> <span class="main">⟹</span> Pderiv <span class="free">x</span> <span class="free">R</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>pderiv_no_occurrence Atoms_def Pderiv_def<span class="main">)</span>

<span class="keyword1" id="pEquivalence_Checking-Deriv_Lang"><span class="command">lemma</span></span> Deriv_Lang<span class="main">:</span> <span class="quoted"><span class="quoted">"Deriv <span class="free">c</span> <span class="main">(</span>Lang <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Lang <span class="main">(</span>Pderiv <span class="free">c</span> <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Deriv_pderiv Pderiv_def Lang_def<span class="main">)</span>

<span class="keyword1" id="pEquivalence_Checking-Nullable_pderiv"><span class="command">lemma</span></span> Nullable_pderiv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Nullable<span class="main">(</span>pderivs <span class="free">w</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">w</span> <span class="main">:</span> lang <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nullable_def nullable_iff singleton_iff<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> eqset_imp_iff<span class="main">[</span><span class="operator">OF</span> Deriv_pderiv<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nullable_def Deriv_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> Rexp_pair <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp set <span class="main">*</span> <span class="tfree">'a</span> rexp set"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> Rexp_pairs <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Rexp_pair list"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_Bisimulation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> Rexp_pairs <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_Bisimulation</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">R</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span><span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">.</span> Atoms <span class="bound">R</span> <span class="main">∪</span> Atoms <span class="bound">S</span> <span class="main">⊆</span> set <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">∧</span>
    <span class="main">(</span>Nullable <span class="bound">R</span> <span class="main">⟷</span> Nullable <span class="bound">S</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">.</span> <span class="main">(</span>Pderiv <span class="bound">a</span> <span class="bound">R</span><span class="main">,</span> Pderiv <span class="bound">a</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="pEquivalence_Checking-Bisim_Lang_eq"><span class="command">lemma</span></span> Bisim_Lang_eq<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> Bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"is_Bisimulation <span class="free">as</span> <span class="free">ps</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Lang <span class="free">R</span> <span class="main">=</span> Lang <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ps'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps'</span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">#</span> <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Bisim <span class="keyword1"><span class="command">have</span></span> Bisim'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_Bisimulation <span class="free">as</span> <span class="skolem">ps'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ps'_def is_Bisimulation_def UN_subset_iff Pderiv_def Atoms_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">K</span> <span class="bound">L</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">R</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">ps'</span><span class="main">.</span> <span class="bound">K</span> <span class="main">=</span> Lang <span class="bound">R</span> <span class="main">∧</span> <span class="bound">L</span> <span class="main">=</span> Lang <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> language_coinduct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?R</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">R</span><span class="main">,</span><span class="free">S</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ps</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R</span><span class="main">,</span><span class="free">S</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ps'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ps'_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">(</span>Lang <span class="free">R</span><span class="main">)</span> <span class="main">(</span>Lang <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">K</span> <span class="skolem">L</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="skolem">K</span> <span class="skolem">L</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">R</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ps'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> KL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">=</span> Lang <span class="skolem">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> Lang <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Bisim' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Nullable <span class="skolem">R</span> <span class="main">⟷</span> Nullable <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_Bisimulation_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="skolem">K</span> <span class="main">⟷</span> <span class="main">[]</span> <span class="main">∈</span> <span class="skolem">L</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nullable_iff KL Nullable_def Lang_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">(</span>Deriv <span class="skolem">a</span> <span class="skolem">K</span><span class="main">)</span> <span class="main">(</span>Deriv <span class="skolem">a</span> <span class="skolem">L</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="free">as</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> rs Bisim'
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Pderiv <span class="skolem">a</span> <span class="skolem">R</span><span class="main">,</span> Pderiv <span class="skolem">a</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ps'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_Bisimulation_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> KL Deriv_Lang<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> set <span class="free">as</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> Bisim' rs
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> Atoms <span class="skolem">R</span> <span class="main">∪</span> Atoms <span class="skolem">S</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_Bisimulation_def UN_subset_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Pderiv <span class="skolem">a</span> <span class="skolem">R</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"Pderiv <span class="skolem">a</span> <span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pderiv_no_occurrence Un_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Deriv <span class="skolem">a</span> <span class="skolem">K</span> <span class="main">=</span> Lang <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"Deriv <span class="skolem">a</span> <span class="skolem">L</span> <span class="main">=</span> Lang <span class="main">{}</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> KL Deriv_Lang <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ps'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Closure computation›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">test</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Rexp_pairs <span class="main">*</span> <span class="tfree">'a</span> Rexp_pairs <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">test</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span>  False <span class="main">|</span> <span class="main">(</span><span class="bound">R</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span><span class="main">#</span><span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Nullable <span class="bound">R</span> <span class="main">=</span> Nullable <span class="bound">S</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span>
  <span class="tfree">'a</span> Rexp_pairs <span class="main">*</span> <span class="tfree">'a</span> Rexp_pairs <span class="main">⇒</span> <span class="tfree">'a</span> Rexp_pairs <span class="main">*</span> <span class="tfree">'a</span> Rexp_pairs"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span>
      <span class="main">(</span><span class="bound">R</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span> <span class="main">=</span> hd <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">;</span>
      <span class="bound">ps'</span> <span class="main">=</span> <span class="main">(</span><span class="bound">R</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">;</span>
      <span class="bound">succs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span>Pderiv <span class="bound">a</span> <span class="bound">R</span><span class="main">,</span> Pderiv <span class="bound">a</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">;</span>
      <span class="bound">new</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∉</span> set <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">∪</span> set <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">)</span> <span class="bound">succs</span>
    <span class="keyword1">in</span> <span class="main">(</span>remdups <span class="bound">new</span> <span class="main">@</span> tl <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">,</span> <span class="bound">ps'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">closure</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> Rexp_pairs <span class="main">*</span> <span class="tfree">'a</span> Rexp_pairs
   <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> Rexp_pairs <span class="main">*</span> <span class="tfree">'a</span> Rexp_pairs<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">closure</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">=</span> while_option test <span class="main">(</span>step <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pre_Bisim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> rexp set <span class="main">⇒</span> <span class="tfree">'a</span> rexp set <span class="main">⇒</span>
 <span class="tfree">'a</span> Rexp_pairs <span class="main">*</span> <span class="tfree">'a</span> Rexp_pairs <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pre_Bisim</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">ws</span><span class="main">,</span><span class="bound">ps</span><span class="main">)</span><span class="main">.</span>
 <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">ws</span> <span class="main">∪</span> set <span class="bound">ps</span><span class="main">)</span> <span class="main">∧</span>
 <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">R</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span><span class="main">∈</span> set <span class="bound">ws</span> <span class="main">∪</span> set <span class="bound">ps</span><span class="main">.</span> Atoms <span class="bound">R</span> <span class="main">∪</span> Atoms <span class="bound">S</span> <span class="main">⊆</span> set <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">∧</span>
 <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">R</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span><span class="main">∈</span> set <span class="bound">ps</span><span class="main">.</span> <span class="main">(</span>Nullable <span class="bound">R</span> <span class="main">⟷</span> Nullable <span class="bound">S</span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">.</span> <span class="main">(</span>Pderiv <span class="bound">a</span> <span class="bound">R</span><span class="main">,</span> Pderiv <span class="bound">a</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">ps</span> <span class="main">∪</span> set <span class="bound">ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="pEquivalence_Checking-step_set_eq"><span class="command">lemma</span></span> step_set_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> test <span class="main">(</span><span class="free">ws</span><span class="main">,</span><span class="free">ps</span><span class="main">)</span><span class="main">;</span> step <span class="free">as</span> <span class="main">(</span><span class="free">ws</span><span class="main">,</span><span class="free">ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ws'</span><span class="main">,</span><span class="free">ps'</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> set <span class="free">ws'</span> <span class="main">∪</span> set <span class="free">ps'</span> <span class="main">=</span>
     set <span class="free">ws</span> <span class="main">∪</span> set <span class="free">ps</span>
     <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">∈</span>set <span class="free">as</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span>Pderiv <span class="bound">a</span> <span class="main">(</span>fst<span class="main">(</span>hd <span class="free">ws</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Pderiv <span class="bound">a</span> <span class="main">(</span>snd<span class="main">(</span>hd <span class="free">ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> closure_sound<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> result<span class="main">:</span> <span class="quoted"><span class="quoted">"closure <span class="free">as</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">R</span><span class="main">,</span><span class="free">S</span><span class="main">)</span><span class="main">]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">ps</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> atoms<span class="main">:</span> <span class="quoted"><span class="quoted">"Atoms <span class="free">R</span> <span class="main">∪</span> Atoms <span class="free">S</span> <span class="main">⊆</span> set <span class="free">as</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Lang <span class="free">R</span> <span class="main">=</span> Lang <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">st</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pre_Bisim <span class="free">as</span> <span class="free">R</span> <span class="free">S</span> <span class="skolem">st</span> <span class="main">⟹</span> test <span class="skolem">st</span> <span class="main">⟹</span> pre_Bisim <span class="free">as</span> <span class="free">R</span> <span class="free">S</span> <span class="main">(</span>step <span class="free">as</span> <span class="skolem">st</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pre_Bisim_def
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">split</span> prod.splits<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> case_prodE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">ws</span> <span class="skolem">ps</span> <span class="skolem">ws'</span> <span class="skolem">ps'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> prems<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹test <span class="skolem">st</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wstl</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">R</span><span class="main">,</span><span class="skolem">S</span><span class="main">)</span><span class="main">#</span><span class="skolem">wstl</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹step <span class="free">as</span> <span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ws'</span><span class="main">,</span><span class="skolem">ps'</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">R</span><span class="main">,</span><span class="skolem">S</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ws'</span> <span class="main">=</span> remdups<span class="main">(</span>filter <span class="skolem">P</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span>Pderiv <span class="bound">a</span> <span class="skolem">R</span><span class="main">,</span> Pderiv <span class="bound">a</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">wstl</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">R'</span><span class="main">,</span><span class="bound">S'</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">wstl</span> <span class="main">∪</span> set <span class="skolem">ps'</span><span class="main">.</span> Atoms <span class="bound">R'</span> <span class="main">∪</span> Atoms <span class="bound">S'</span> <span class="main">⊆</span> set <span class="free">as</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="free">as</span><span class="main">.</span> Atoms<span class="main">(</span>Pderiv <span class="bound">a</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">∪</span> Atoms<span class="main">(</span>Pderiv <span class="bound">a</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">as</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> Atoms_Pderiv order_trans<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits list.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">hypsubst_thin</span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> atoms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pre_Bisim <span class="free">as</span> <span class="free">R</span> <span class="free">S</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">R</span><span class="main">,</span><span class="free">S</span><span class="main">)</span><span class="main">]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_Bisim_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> pre_Bisim_ps<span class="main">:</span> <span class="quoted"><span class="quoted">"pre_Bisim <span class="free">as</span> <span class="free">R</span> <span class="free">S</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> while_option_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ result<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> closure_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_Bisimulation <span class="free">as</span> <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R</span><span class="main">,</span><span class="free">S</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_Bisim_def is_Bisimulation_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Lang <span class="free">R</span> <span class="main">=</span> Lang <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Bisim_Lang_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The overall procedure›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_eqv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">check_eqv</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> closure <span class="main">(</span>add_atoms <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>add_atoms <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="keyword1">of</span>
     Some<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>

<span class="keyword1" id="pEquivalence_Checking-soundness"><span class="command">lemma</span></span> soundness<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"check_eqv <span class="free">r</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">r</span> <span class="main">=</span> lang <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?as</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"add_atoms <span class="free">r</span> <span class="main">(</span>add_atoms <span class="free">s</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"closure <span class="var">?as</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">{</span><span class="free">r</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">)</span><span class="main">]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> check_eqv_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.splits list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">r</span> <span class="main">=</span> lang <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> closure_sound<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{</span></span></span><span class="free"><span class="free"><span class="free">r</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{</span></span></span><span class="free"><span class="free"><span class="free">s</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> Lang_def<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_add_atoms Atoms_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">r</span> <span class="main">=</span> lang <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Test:›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"check_eqv
  <span class="main">(</span>Plus One <span class="main">(</span>Times <span class="main">(</span>Atom <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Star<span class="main">(</span>Atom <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>Star<span class="main">(</span>Atom<span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Termination and Completeness"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PDERIVS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp set <span class="main">=&gt;</span> <span class="tfree">'a</span> rexp set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">PDERIVS</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">r</span><span class="main">:</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> pderivs_lang UNIV <span class="bound">r</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="pEquivalence_Checking-PDERIVS_incr"><span class="command">lemma</span></span> PDERIVS_incr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊆</span> PDERIVS <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PDERIVS_def pderivs_lang_def<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pderivs.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insertI1<span class="main">)</span>

<span class="keyword1" id="pEquivalence_Checking-Pderiv_PDERIVS"><span class="command">lemma</span></span> Pderiv_PDERIVS<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">⊆</span> PDERIVS <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Pderiv <span class="free">a</span> <span class="free">R'</span> <span class="main">⊆</span> PDERIVS <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">:</span> Pderiv <span class="free">a</span> <span class="free">R'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">:</span> <span class="free">R'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">:</span> pderiv <span class="free">a</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Pderiv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">:</span> <span class="free">R'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R'</span> <span class="main">⊆</span> PDERIVS <span class="free">R</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">:</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">:</span> pderivs <span class="skolem">w</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> PDERIVS_def pderivs_lang_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> pderivs <span class="main">(</span><span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">:</span> pderiv <span class="free">a</span> <span class="skolem">r'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pderivs_snoc<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">:</span> PDERIVS <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">:</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> PDERIVS_def pderivs_lang_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="pEquivalence_Checking-finite_PDERIVS"><span class="command">lemma</span></span> finite_PDERIVS<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">R</span> <span class="main">⟹</span> finite<span class="main">(</span>PDERIVS <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PDERIVS_def finite_pderivs_lang_UNIV<span class="main">)</span>

<span class="keyword1" id="pEquivalence_Checking-closure_Some"><span class="command">lemma</span></span> closure_Some<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">R0</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S0</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> closure <span class="free">as</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">R0</span><span class="main">,</span><span class="free">S0</span><span class="main">)</span><span class="main">]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> closure_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Inv</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="main">(</span><span class="bound">ws</span><span class="main">,</span><span class="bound">bs</span><span class="main">)</span><span class="main">.</span>  distinct <span class="bound">ws</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">ALL</span> <span class="main">(</span><span class="bound">R</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span> <span class="main">:</span> set <span class="bound">ws</span><span class="main">.</span> <span class="bound">R</span> <span class="main">⊆</span> PDERIVS <span class="free">R0</span> <span class="main">∧</span> <span class="bound">S</span> <span class="main">⊆</span> PDERIVS <span class="free">S0</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">R</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span> <span class="main">∉</span> set <span class="bound">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">bs</span><span class="main">.</span> Pow<span class="main">(</span>PDERIVS <span class="free">R0</span><span class="main">)</span> <span class="main">×</span> Pow<span class="main">(</span>PDERIVS <span class="free">S0</span><span class="main">)</span> <span class="main">-</span> set <span class="bound">bs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="main">(</span><span class="bound">ws</span><span class="main">,</span><span class="bound">bs</span><span class="main">)</span><span class="main">.</span> card<span class="main">(</span><span class="var">?m1</span> <span class="bound">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> Inv0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Inv</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">R0</span><span class="main">,</span> <span class="free">S0</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"test <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Inv</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ws</span><span class="main">,</span><span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹test <span class="skolem">s</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="skolem"><span class="skolem">ws'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">R</span><span class="main">,</span><span class="skolem">S</span><span class="main">)</span><span class="main">#</span><span class="skolem">ws'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits list.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bs'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">R</span><span class="main">,</span><span class="skolem">S</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">bs</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?succs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span>Pderiv <span class="bound">a</span> <span class="skolem">R</span><span class="main">,</span> Pderiv <span class="bound">a</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="free">as</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?new</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∉</span> set <span class="skolem">bs</span> <span class="main">∪</span> set <span class="skolem">ws</span><span class="main">)</span> <span class="var">?succs</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ws'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"remdups <span class="var">?new</span> <span class="main">@</span> <span class="skolem">ws'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Inv</span> <span class="main">(</span>step <span class="free">as</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?Inv</span> <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="var">?ws'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ALL</span> <span class="main">(</span><span class="bound">R</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span> <span class="main">:</span> set <span class="var">?ws'</span><span class="main">.</span> <span class="bound">R</span> <span class="main">⊆</span> PDERIVS <span class="free">R0</span> <span class="main">∧</span> <span class="bound">S</span> <span class="main">⊆</span> PDERIVS <span class="free">S0</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">R</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span> <span class="main">∉</span> set <span class="var">?bs'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?Inv</span> <span class="skolem">s</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ball_def image_iff<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Pderiv_PDERIVS<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="var">?ws'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m2</span><span class="main">(</span>step <span class="free">as</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">&lt;</span> <span class="var">?m2</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite<span class="main">(</span><span class="var">?m1</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> assms finite_Diff finite_PDERIVS finite_cartesian_product finite_Pow_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m2</span><span class="main">(</span>step <span class="free">as</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">&lt;</span> <span class="var">?m2</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?Inv</span> <span class="skolem">s</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> psubset_card_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite<span class="main">(</span><span class="var">?m1</span> <span class="skolem">bs</span><span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?Inv</span> <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">note</span></span> * <span class="keyword2"><span class="keyword">and</span></span> this
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> while_option test <span class="main">(</span>step <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">R0</span><span class="main">,</span> <span class="free">S0</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">p</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> measure_while_option_Some <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?Inv</span></span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?m2</span></span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ Inv0<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> closure_Some_Inv<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closure <span class="free">as</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">{</span><span class="free">r</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">)</span><span class="main">]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">p</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">R</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span><span class="main">∈</span>set<span class="main">(</span>fst <span class="free">p</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="bound">R</span> <span class="main">=</span> pderivs <span class="bound">w</span> <span class="free">r</span> <span class="main">∧</span> <span class="bound">S</span> <span class="main">=</span> pderivs <span class="bound">w</span> <span class="free">s</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Inv</span> <span class="free">p</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"while_option test <span class="main">(</span>step <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">{</span><span class="free">r</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">)</span><span class="main">]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closure_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Inv0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Inv</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">{</span><span class="free">r</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">)</span><span class="main">]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> pderivs.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Inv</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"test <span class="skolem">p</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ws</span><span class="main">,</span><span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹test <span class="skolem">p</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="skolem"><span class="skolem">ws'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">R</span><span class="main">,</span><span class="skolem">S</span><span class="main">)</span><span class="main">#</span><span class="skolem">ws'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits list.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?succs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span>Pderiv <span class="bound">a</span> <span class="skolem">R</span><span class="main">,</span> Pderiv <span class="bound">a</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="free">as</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?new</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∉</span> set <span class="skolem">bs</span> <span class="main">∪</span> set <span class="skolem">ws</span><span class="main">)</span> <span class="var">?succs</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ws'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"remdups <span class="var">?new</span> <span class="main">@</span> <span class="skolem">ws'</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?Inv</span> <span class="skolem">p</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> pderivs <span class="skolem">w</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> pderivs <span class="skolem">w</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">:</span> set <span class="free">as</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">EX</span> <span class="bound">w</span><span class="main">.</span> Pderiv <span class="skolem">x</span> <span class="skolem">R</span> <span class="main">=</span> pderivs <span class="bound">w</span> <span class="free">r</span> <span class="main">∧</span> Pderiv <span class="skolem">x</span> <span class="skolem">S</span> <span class="main">=</span> pderivs <span class="bound">w</span> <span class="free">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">@</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pderivs_append Pderiv_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?Inv</span> <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Inv</span> <span class="main">(</span>step <span class="free">as</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> Inv_step <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> while_option_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Inv_step<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Inv0<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="pEquivalence_Checking-closure_complete"><span class="command">lemma</span></span> closure_complete<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">r</span> <span class="main">=</span> lang <span class="free">s</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">EX</span> <span class="bound">bs</span><span class="main">.</span> closure <span class="free">as</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">{</span><span class="free">r</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">)</span><span class="main">]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="bound">bs</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?C</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="skolem"><span class="skolem">bs</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"closure <span class="free">as</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">{</span><span class="free">r</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">)</span><span class="main">]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="main">(</span><span class="skolem">R</span><span class="main">,</span><span class="skolem">S</span><span class="main">)</span><span class="main">#</span><span class="skolem">ws</span><span class="main">,</span><span class="skolem">bs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> closure_Some<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">r</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> list.exhaust prod.exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms closure_Some_Inv<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    while_option_stop<span class="main">[</span><span class="operator">OF</span> cl<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> closure_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> completeness<span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="free">r</span> <span class="main">=</span> lang <span class="free">s</span> <span class="main">⟹</span> check_eqv <span class="free">r</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_eqv_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> closure_complete
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split list.split<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Regular_Exp2">
<div class="head">
<h1>Theory Regular_Exp2</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Extended Regular Expressions"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Regular_Exp2
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Regular_Set.html">Regular_Set</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span>atoms<span class="main">:</span> <span class="tfree">'a</span><span class="main">)</span> rexp <span class="main">=</span>
  <span class="entity">is_Zero</span><span class="main">:</span> Zero <span class="main">|</span>
  <span class="entity">is_One</span><span class="main">:</span> One <span class="main">|</span>
  Atom <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span>
  Plus <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span>"</span></span> <span class="main">|</span>
  Times <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span>"</span></span> <span class="main">|</span>
  Star <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span>"</span></span> <span class="main">|</span>
  Not <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span>"</span></span> <span class="main">|</span>
  Inter <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lang</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">=&gt;</span> <span class="tfree">'a</span> lang"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> Zero <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> One <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">Un</span> <span class="main">(</span><span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> conc <span class="main">(</span><span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> star<span class="main">(</span><span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> lists <span class="free">S</span> <span class="main">-</span> <span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">Int</span> <span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Regular_Exp2-lang_subset_lists"><span class="command">lemma</span></span> lang_subset_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"atoms <span class="free">r</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span> lang <span class="free">S</span> <span class="free">r</span> <span class="main">⊆</span> lists <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_subset_lists star_subset_lists<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">nullable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">nullable</span> Zero <span class="main">=</span> False"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nullable</span> One <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nullable</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nullable</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">nullable</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main">∨</span> <span class="free">nullable</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nullable</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">nullable</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main">∧</span> <span class="free">nullable</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nullable</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nullable</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="free">nullable</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nullable</span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">nullable</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free">nullable</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Regular_Exp2-nullable_iff"><span class="command">lemma</span></span> nullable_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"nullable <span class="free">r</span> <span class="main">⟷</span> <span class="main">[]</span> <span class="main">∈</span> lang <span class="free">S</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conc_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Equivalence_Checking2">
<div class="head">
<h1>Theory Equivalence_Checking2</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deciding Equivalence of Extended Regular Expressions›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Equivalence_Checking2
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Regular_Exp2.html">Regular_Exp2</a> <span class="quoted">"<a href="../../HOL/HOL-Library/While_Combinator.html">HOL-Library.While_Combinator</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Term ordering›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">le_rexp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat rexp <span class="main">⇒</span> nat rexp <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> Zero <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Zero <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> One <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> One <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main">(</span>Atom <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Atom <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">le_rexp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main">(</span>Star <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Star <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">le_rexp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main">(</span>Not <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Not <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="free">le_rexp</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="keyword1">else</span> <span class="free">le_rexp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main">(</span>Plus <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Plus <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="free">le_rexp</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="keyword1">else</span> <span class="free">le_rexp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main">(</span>Times <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Times <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">le_rexp</span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="free">le_rexp</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="keyword1">else</span> <span class="free">le_rexp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Normalizing operations›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹associativity, commutativity, idempotence, zero›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nPlus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat rexp <span class="main">⇒</span> nat rexp <span class="main">⇒</span> nat rexp"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nPlus</span> Zero <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> Zero <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nPlus</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free">nPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free">nPlus</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> le_rexp <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span> Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free">nPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> le_rexp <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
      <span class="keyword1">else</span> Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Equivalence_Checking2-lang_nPlus"><span class="command">lemma</span></span> lang_nPlus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="free">S</span> <span class="main">(</span>nPlus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">S</span> <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nPlus.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹associativity, zero, one›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nTimes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat rexp <span class="main">⇒</span> nat rexp <span class="main">⇒</span> nat rexp"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nTimes</span> Zero <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nTimes</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nTimes</span> One <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nTimes</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> One <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nTimes</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free">nTimes</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nTimes</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1" id="Equivalence_Checking2-lang_nTimes"><span class="command">lemma</span></span> lang_nTimes<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="free">S</span> <span class="main">(</span>nTimes <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">S</span> <span class="main">(</span>Times <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nTimes.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹more optimisations:›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nInter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat rexp <span class="main">⇒</span> nat rexp <span class="main">⇒</span> nat rexp"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nInter</span> Zero <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nInter</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nInter</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Inter <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1" id="Equivalence_Checking2-lang_nInter"><span class="command">lemma</span></span> lang_nInter<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="free">S</span> <span class="main">(</span>nInter <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">S</span> <span class="main">(</span>Inter <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nInter.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">norm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat rexp <span class="main">⇒</span> nat rexp"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">norm</span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> One <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> nPlus <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> nTimes <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Star <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Not <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> nInter <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Equivalence_Checking2-lang_norm"><span class="command">lemma</span></span> lang_norm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="free">S</span> <span class="main">(</span>norm <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">S</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derivative›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">nderiv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat rexp <span class="main">⇒</span> nat rexp"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nderiv</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nderiv</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> One <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> One <span class="keyword1">else</span> Zero<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> nPlus <span class="main">(</span><span class="free">nderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">nderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">r's</span> <span class="main">=</span> nTimes <span class="main">(</span><span class="free">nderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
     <span class="keyword1">in</span> <span class="keyword1">if</span> nullable <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> nPlus <span class="bound">r's</span> <span class="main">(</span><span class="free">nderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">r's</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> nTimes <span class="main">(</span><span class="free">nderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Not <span class="main">(</span><span class="free">nderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> nInter <span class="main">(</span><span class="free">nderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">nderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Equivalence_Checking2-lang_nderiv"><span class="command">lemma</span></span> lang_nderiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">:</span><span class="free">S</span> <span class="main">⟹</span> lang <span class="free">S</span> <span class="main">(</span>nderiv <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Deriv <span class="free">a</span> <span class="main">(</span>lang <span class="free">S</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def nullable_iff<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">S</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Equivalence_Checking2-atoms_nPlus"><span class="command">lemma</span></span> atoms_nPlus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atoms <span class="main">(</span>nPlus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> atoms <span class="free">r</span> <span class="main">∪</span> atoms <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nPlus.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Equivalence_Checking2-atoms_nTimes"><span class="command">lemma</span></span> atoms_nTimes<span class="main">:</span> <span class="quoted"><span class="quoted">"atoms <span class="main">(</span>nTimes <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">⊆</span> atoms <span class="free">r</span> <span class="main">∪</span> atoms <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nTimes.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Equivalence_Checking2-atoms_nInter"><span class="command">lemma</span></span> atoms_nInter<span class="main">:</span> <span class="quoted"><span class="quoted">"atoms <span class="main">(</span>nInter <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">⊆</span> atoms <span class="free">r</span> <span class="main">∪</span> atoms <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nInter.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Equivalence_Checking2-atoms_norm"><span class="command">lemma</span></span> atoms_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"atoms <span class="main">(</span>norm <span class="free">r</span><span class="main">)</span> <span class="main">⊆</span> atoms <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> atoms_nTimes<span class="main"><span class="main">]</span></span>subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> atoms_nInter<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Equivalence_Checking2-atoms_nderiv"><span class="command">lemma</span></span> atoms_nderiv<span class="main">:</span> <span class="quoted"><span class="quoted">"atoms <span class="main">(</span>nderiv <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">⊆</span> atoms <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> atoms_nTimes<span class="main"><span class="main">]</span></span>subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> atoms_nInter<span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bisimulation between languages and regular expressions›</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">bisimilar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">⊆</span> lists <span class="free">S</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">⊆</span> lists <span class="free">S</span>
 <span class="main">⟹</span> <span class="main">(</span><span class="main">[]</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">⟷</span> <span class="main">[]</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> 
 <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">:</span><span class="free">S</span> <span class="main">⟹</span> <span class="free">bisimilar</span> <span class="main">(</span>Deriv <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">)</span> <span class="main">(</span>Deriv <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span><span class="main">)</span>
 <span class="main">⟹</span> <span class="free">bisimilar</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span>"</span></span>

<span class="keyword1" id="Equivalence_Checking2-equal_if_bisimilar"><span class="command">lemma</span></span> equal_if_bisimilar<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> lists <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">⊆</span> lists <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"bisimilar <span class="free">K</span> <span class="free">L</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">=</span> <span class="free">L</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="free">K</span> <span class="main">⟷</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">K</span></span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> bisimilar.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">w</span> <span class="skolem">K</span> <span class="skolem">L</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">:</span> <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹bisimilar <span class="skolem">K</span> <span class="skolem">L</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bisimilar <span class="main">(</span>Deriv <span class="skolem">a</span> <span class="skolem">K</span><span class="main">)</span> <span class="main">(</span>Deriv <span class="skolem">a</span> <span class="skolem">L</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> bisimilar.cases<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> Deriv <span class="skolem">a</span> <span class="skolem">K</span> <span class="main">⟷</span> <span class="skolem">w</span> <span class="main">∈</span> Deriv <span class="skolem">a</span> <span class="skolem">L</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.IH bisimilar.cases<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Deriv_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Equivalence_Checking2-language_coinduct"><span class="command">lemma</span></span> language_coinduct<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∼</span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">K</span> <span class="bound">L</span><span class="main">.</span> <span class="bound">K</span> <span class="main"><span class="free">∼</span></span> <span class="bound">L</span> <span class="main">⟹</span> <span class="bound">K</span> <span class="main">⊆</span> lists <span class="free">S</span> <span class="main">∧</span> <span class="bound">L</span> <span class="main">⊆</span> lists <span class="free">S</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main"><span class="free">∼</span></span> <span class="free">L</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">K</span> <span class="bound">L</span><span class="main">.</span> <span class="bound">K</span> <span class="main"><span class="free">∼</span></span> <span class="bound">L</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">[]</span> <span class="main">∈</span> <span class="bound">K</span> <span class="main">⟷</span> <span class="main">[]</span> <span class="main">∈</span> <span class="bound">L</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">K</span> <span class="bound">L</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">K</span> <span class="main"><span class="free">∼</span></span> <span class="bound">L</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">:</span> <span class="free">S</span> <span class="main">⟹</span> Deriv <span class="bound">x</span> <span class="bound">K</span> <span class="main"><span class="free">∼</span></span> Deriv <span class="bound">x</span> <span class="bound">L</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">=</span> <span class="free">L</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equal_if_bisimilar<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bisimilar.coinduct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">K</span> <span class="main"><span class="free">∼</span></span> <span class="free">L</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> rexp_pair <span class="main">=</span> <span class="quoted"><span class="quoted">"nat rexp <span class="main">*</span> nat rexp"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> rexp_pairs <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_pair list"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_bisimulation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> rexp_pairs <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_bisimulation</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">.</span> <span class="main">(</span>atoms <span class="bound">r</span> <span class="main">∪</span> atoms <span class="bound">s</span> <span class="main">⊆</span> set <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>nullable <span class="bound">r</span> <span class="main">⟷</span> nullable <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">.</span> <span class="main">(</span>nderiv <span class="bound">a</span> <span class="bound">r</span><span class="main">,</span> nderiv <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1" id="Equivalence_Checking2-bisim_lang_eq"><span class="command">lemma</span></span> bisim_lang_eq<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"is_bisimulation <span class="free">as</span> <span class="free">ps</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> lang <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">K</span> <span class="bound">L</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span>set <span class="free">ps</span><span class="main">.</span> <span class="bound">K</span> <span class="main">=</span> lang <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="bound">r</span> <span class="main">∧</span> <span class="bound">L</span> <span class="main">=</span> lang <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> language_coinduct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?R</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> S <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"set <span class="free"><span class="free">as</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ps</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">(</span>lang <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>lang <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">K</span> <span class="skolem">L</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="skolem">K</span> <span class="skolem">L</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> KL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">=</span> lang <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> lang <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> bisim <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nullable <span class="skolem">r</span> <span class="main">⟷</span> nullable <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_bisimulation_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="skolem">K</span> <span class="main">⟷</span> <span class="main">[]</span> <span class="main">∈</span> <span class="skolem">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nullable_iff<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"set <span class="free">as</span>"</span></span><span class="main"><span class="main">]</span></span> KL<span class="main">)</span>
  <span class="keyword1"><span class="command">txt</span></span><span class="quoted"><span class="plain_text">‹next case, but shared context›</span></span>
    <span class="keyword1"><span class="command">from</span></span> bisim rs KL lang_subset_lists<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"set <span class="free">as</span>"</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">⊆</span> lists <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">L</span> <span class="main">⊆</span> lists <span class="main">(</span>set <span class="free">as</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_bisimulation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">txt</span></span><span class="quoted"><span class="plain_text">‹next case, but shared context›</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="free">as</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> rs bisim
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nderiv <span class="skolem">a</span> <span class="skolem">r</span><span class="main">,</span> nderiv <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_bisimulation_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">(</span>Deriv <span class="skolem">a</span> <span class="skolem">K</span><span class="main">)</span> <span class="main">(</span>Deriv <span class="skolem">a</span> <span class="skolem">L</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> set <span class="free">as</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> KL lang_nderiv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Closure computation›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">test</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rexp_pairs <span class="main">*</span> rexp_pairs <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">test</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span>  False <span class="main">|</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">q</span><span class="main">)</span><span class="main">#</span><span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> nullable <span class="bound">p</span> <span class="main">=</span> nullable <span class="bound">q</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> rexp_pairs <span class="main">*</span> rexp_pairs <span class="main">⇒</span> rexp_pairs <span class="main">*</span> rexp_pairs"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> 
      <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> hd <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">;</span>
      <span class="bound">ps'</span> <span class="main">=</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">;</span>
      <span class="bound">succs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span>nderiv <span class="bound">a</span> <span class="bound">r</span><span class="main">,</span> nderiv <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">;</span>
      <span class="bound">new</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∉</span> set <span class="bound">ps'</span> <span class="main">∪</span> set <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">)</span> <span class="bound">succs</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">new</span> <span class="main">@</span> tl <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">,</span> <span class="bound">ps'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">closure</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> rexp_pairs <span class="main">*</span> rexp_pairs
   <span class="main">⇒</span> <span class="main">(</span>rexp_pairs <span class="main">*</span> rexp_pairs<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">closure</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">=</span> while_option test <span class="main">(</span>step <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pre_bisim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> nat rexp <span class="main">⇒</span> nat rexp <span class="main">⇒</span>
 rexp_pairs <span class="main">*</span> rexp_pairs <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pre_bisim</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">ws</span><span class="main">,</span><span class="bound">ps</span><span class="main">)</span><span class="main">.</span>
 <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">ws</span> <span class="main">∪</span> set <span class="bound">ps</span><span class="main">)</span> <span class="main">∧</span>
 <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span> set <span class="bound">ws</span> <span class="main">∪</span> set <span class="bound">ps</span><span class="main">.</span> atoms <span class="bound">r</span> <span class="main">∪</span> atoms <span class="bound">s</span> <span class="main">⊆</span> set <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">∧</span>
 <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span> set <span class="bound">ps</span><span class="main">.</span> <span class="main">(</span>nullable <span class="bound">r</span> <span class="main">⟷</span> nullable <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">.</span> <span class="main">(</span>nderiv <span class="bound">a</span> <span class="bound">r</span><span class="main">,</span> nderiv <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">ps</span> <span class="main">∪</span> set <span class="bound">ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> closure_sound<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> result<span class="main">:</span> <span class="quoted"><span class="quoted">"closure <span class="free">as</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">ps</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> atoms<span class="main">:</span> <span class="quoted"><span class="quoted">"atoms <span class="free">r</span> <span class="main">∪</span> atoms <span class="free">s</span> <span class="main">⊆</span> set <span class="free">as</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> lang <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">st</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pre_bisim <span class="free">as</span> <span class="free">r</span> <span class="free">s</span> <span class="skolem">st</span> <span class="main">⟹</span> test <span class="skolem">st</span> <span class="main">⟹</span> pre_bisim <span class="free">as</span> <span class="free">r</span> <span class="free">s</span> <span class="main">(</span>step <span class="free">as</span> <span class="skolem">st</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pre_bisim_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">st</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits prod.splits
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> atoms_nderiv<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> atoms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pre_bisim <span class="free">as</span> <span class="free">r</span> <span class="free">s</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_bisim_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> pre_bisim_ps<span class="main">:</span> <span class="quoted"><span class="quoted">"pre_bisim <span class="free">as</span> <span class="free">r</span> <span class="free">s</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> while_option_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ result<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> closure_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_bisimulation <span class="free">as</span> <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_bisim_def is_bisimulation_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> lang <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bisim_lang_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The overall procedure›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">add_atoms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat rexp <span class="main">⇒</span> nat list <span class="main">⇒</span> nat list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_atoms</span> Zero <span class="main">=</span> id"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add_atoms</span> One <span class="main">=</span> id"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add_atoms</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> List.insert <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add_atoms</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">add_atoms</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">o</span> <span class="free">add_atoms</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add_atoms</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">add_atoms</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">o</span> <span class="free">add_atoms</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add_atoms</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">add_atoms</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add_atoms</span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">add_atoms</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">o</span> <span class="free">add_atoms</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add_atoms</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">add_atoms</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1" id="Equivalence_Checking2-set_add_atoms"><span class="command">lemma</span></span> set_add_atoms<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>add_atoms <span class="free">r</span> <span class="free">as</span><span class="main">)</span> <span class="main">=</span> atoms <span class="free">r</span> <span class="main">∪</span> set <span class="free">as</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_eqv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> nat rexp <span class="main">⇒</span> nat rexp <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">check_eqv</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟷</span> set<span class="main">(</span>add_atoms <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>add_atoms <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">∧</span>
  <span class="main">(</span><span class="keyword1">case</span> closure <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span><span class="main">[</span><span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> norm <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="keyword1">of</span>
     Some<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>

<span class="keyword1" id="Equivalence_Checking2-soundness"><span class="command">lemma</span></span> soundness<span class="main">:</span> 
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"check_eqv <span class="free">as</span> <span class="free">r</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> lang <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"closure <span class="free">as</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span>norm <span class="free">r</span><span class="main">,</span>norm <span class="free">s</span><span class="main">)</span><span class="main">]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> at<span class="main">:</span> <span class="quoted"><span class="quoted">"atoms <span class="free">r</span> <span class="main">∪</span> atoms <span class="free">s</span> <span class="main">⊆</span> set <span class="free">as</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> check_eqv_def set_add_atoms <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.splits list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"atoms<span class="main">(</span>norm <span class="free">r</span><span class="main">)</span> <span class="main">∪</span> atoms<span class="main">(</span>norm <span class="free">s</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">as</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> atoms_norm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="main">(</span>norm <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lang <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="main">(</span>norm <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> closure_sound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cl<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> lang <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"check_eqv <span class="main">[</span><span class="main">0</span><span class="main">]</span> <span class="main">(</span>Plus One <span class="main">(</span>Times <span class="main">(</span>Atom <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Star<span class="main">(</span>Atom <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Star<span class="main">(</span>Atom <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"check_eqv <span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">]</span> <span class="main">(</span>Not<span class="main">(</span>Atom <span class="main">0</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>Plus One <span class="main">(</span>Times <span class="main">(</span>Plus <span class="main">(</span>Atom <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Times <span class="main">(</span>Atom <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Plus <span class="main">(</span>Atom <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Atom <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">(</span>Star<span class="main">(</span>Plus <span class="main">(</span>Atom <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Atom <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"check_eqv <span class="main">[</span><span class="main">0</span><span class="main">]</span> <span class="main">(</span>Atom <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Inter <span class="main">(</span>Star <span class="main">(</span>Atom <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Atom <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>