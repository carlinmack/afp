<div id="Util">
<div class="head">
<h1>Theory Util</h1>
</div>
<pre class="source"><span class="comment1">(* Victor B. F. Gomes, University of Cambridge
   Martin Kleppmann, University of Cambridge
   Dominic P. Mulligan, University of Cambridge
   Alastair R. Beresford, University of Cambridge
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Technical Lemmas›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This section contains a list of helper definitions and lemmas about sets, lists and
     the option monad.›</span></span>

<span class="keyword1"><span class="command">theory</span></span>
  Util
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Monad_Syntax.html">HOL-Library.Monad_Syntax</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Kleisli arrow composition›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">kleisli</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> option<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⊳</span>"</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">⊳</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> kleisli_comm_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊳</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⊳</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⊳</span> <span class="free">x</span> <span class="main">⊳</span> <span class="free">y</span> <span class="main">=</span> <span class="free">z</span> <span class="main">⊳</span> <span class="free">y</span> <span class="main">⊳</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kleisli_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> kleisli_assoc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">z</span> <span class="main">⊳</span> <span class="free">x</span><span class="main">)</span> <span class="main">⊳</span> <span class="free">y</span> <span class="main">=</span> <span class="free">z</span> <span class="main">⊳</span> <span class="main">(</span><span class="free">x</span> <span class="main">⊳</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kleisli_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Lemmas about sets›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_set_notin <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_membership_equality_technicalD <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>set <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_equality_technical<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>set <span class="free">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="free">xs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> set <span class="free">ys</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>set <span class="free">xs</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
    
<span class="keyword1"><span class="command">lemma</span></span> set_elem_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">m</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span> <span class="main">(</span><span class="operator">meson</span> in_set_conv_nth<span class="main">)</span>
    
<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Lemmas about list›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_nil_or_snoc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span><span class="main">@</span><span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> suffix_eq_distinct_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span><span class="main">@</span><span class="free">suf1</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span><span class="main">@</span><span class="free">suf2</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">suf1</span> <span class="main">=</span> <span class="free">suf2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">suf1</span></span> <span class="quoted"><span class="free">suf2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> append_eq_append_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pre_suf_eq_distinct_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">pre1</span><span class="main">@</span><span class="free">ys</span><span class="main">@</span><span class="free">suf1</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">pre2</span><span class="main">@</span><span class="free">ys</span><span class="main">@</span><span class="free">suf2</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">pre1</span> <span class="main">=</span> <span class="free">pre2</span> <span class="main">∧</span> <span class="free">suf1</span> <span class="main">=</span> <span class="free">suf2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">pre1</span></span> <span class="quoted"><span class="free">pre2</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">pre1</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="improper"><span class="improper">pre2</span></span>"</span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> suffix_eq_distinct_list append_Nil<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> Un_iff append_eq_Cons_conv distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_append suffix_eq_distinct_list<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> Un_iff append_eq_Cons_conv distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_append suffix_eq_distinct_list<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hd_append2 list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> tl_append2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_head_unaffected<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span><span class="free">x</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">,</span> <span class="free">z</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span><span class="free">x</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span>   <span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hd_append list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_head_butlast<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">xs</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>butlast <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hd_conv_nth length_butlast length_greater_0_conv less_trans nth_butlast zero_less_diff zero_less_one<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_head_length_one<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">xs</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_length_conv hd_Cons_tl length_0_conv list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_two_at_end<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs'</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">xs'</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"length <span class="improper">xs</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> append_self_conv2 length_0_conv length_Suc_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"butlast <span class="improper">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"last <span class="improper">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_nth_split_technical<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> length <span class="free">cs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">cs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">cs</span> <span class="main">=</span> <span class="bound">xs</span><span class="main">@</span><span class="main">(</span><span class="free">cs</span><span class="main">!</span><span class="free">m</span><span class="main">)</span><span class="main">#</span><span class="bound">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">meson</span> in_set_conv_decomp nth_mem<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> in_set_conv_decomp length_list_update set_swap set_update_memI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_nth_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> length <span class="free">cs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">cs</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">cs</span> <span class="main">=</span> <span class="bound">xs</span><span class="main">@</span><span class="main">(</span><span class="free">cs</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">#</span><span class="bound">ys</span><span class="main">@</span><span class="main">(</span><span class="free">cs</span><span class="main">!</span><span class="free">m</span><span class="main">)</span><span class="main">#</span><span class="bound">zs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">cs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> list_nth_split_technical<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">cs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">-</span><span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">as</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">m</span><span class="main">-</span><span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">as</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">as</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">m</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">#</span><span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> 
      <span class="keyword1"><span class="command">using</span></span> Suc Cons <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_split_two_elems<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">cs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">pre</span> <span class="bound">mid</span> <span class="bound">suf</span><span class="main">.</span> <span class="free">cs</span> <span class="main">=</span> <span class="bound">pre</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">mid</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="bound">suf</span> <span class="main">∨</span> <span class="free">cs</span> <span class="main">=</span> <span class="bound">pre</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="bound">mid</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">suf</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xi</span></span> <span class="skolem"><span class="skolem">yi</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xi</span> <span class="main">&lt;</span> length <span class="free">cs</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> <span class="free">cs</span> <span class="main">!</span> <span class="skolem">xi</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yi</span> <span class="main">&lt;</span> length <span class="free">cs</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="free">cs</span> <span class="main">!</span> <span class="skolem">yi</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xi</span> <span class="main">≠</span> <span class="skolem">yi</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_elem_nth linorder_neqE_nat assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_nth_split One_nat_def less_Suc_eq linorder_neqE_nat not_less_zero<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> split_list_unique_prefix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">pre</span> <span class="bound">suf</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">pre</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">suf</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="bound">pre</span><span class="main">.</span> <span class="free">x</span> <span class="main">≠</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">=</span><span class="free">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">suf</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">pre</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">suf</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="skolem">pre</span><span class="main">.</span> <span class="free">x</span> <span class="main">≠</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> split_list_first <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_filter_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"List.map_filter <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> List.map_filter <span class="free">P</span> <span class="free">xs</span> <span class="main">@</span> List.map_filter <span class="free">P</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> List.map_filter_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Convergence">
<div class="head">
<h1>Theory Convergence</h1>
</div>
<pre class="source"><span class="comment1">(* Victor B. F. Gomes, University of Cambridge
   Martin Kleppmann, University of Cambridge
   Dominic P. Mulligan, University of Cambridge
   Alastair R. Beresford, University of Cambridge
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Strong Eventual Consistency›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In this section we formalise the notion of strong eventual consistency.
     We do not make any assumptions about networks or data structures; instead,
     we use an abstract model of operations that may be reordered, and we reason about
    the properties that those operations must satisfy.
    We then provide concrete implementations of that abstract model in later sections.›</span></span>
  
<span class="keyword1"><span class="command">theory</span></span>
  Convergence
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Util.html">Util</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The \emph{happens-before} relation, as introduced by \cite{Lamport:1978jq}, captures 
     causal dependencies between operations. It can be defined in terms of sending and receiving
     messages on a network.
     However, for now, we keep it abstract, our only restriction on the happens-before relation is
     that it must be a \emph{strict partial order},
     that is, it must be irreflexive and transitive, which implies that it is also antisymmetric.
     We describe the state of a node using an abstract type variable.
     To model state changes, we assume the existence of an \emph{interpretation} function \isa{interp}
     which lifts an operation into a \emph{state transformer}---a function that either maps
     an old state to a new state, or fails.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> happens_before <span class="main">=</span> preorder <span class="quoted"><span class="free">hb_weak</span></span> <span class="quoted"><span class="free">hb</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">hb_weak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≼</span>"</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">hb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>       <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≺</span>"</span> 50<span class="main">)</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">interp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇀</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1">⟨</span></span>_<span class="keyword1"><span class="keyword1">⟩</span></span>"</span> <span class="main">[</span>0<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Concurrent operations›</span></span>
<span class="comment1">(*************************************************************************)</span>
  
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We say that two operations $x$ and $y$ are \emph{concurrent}, written
    $\isa{x} \mathbin{\isasymparallel} \isa{y}$, whenever one does not happen before the other:
    $\neg (\isa{x} \prec \isa{y})$ and $\neg (\isa{y} \prec \isa{x})$.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">concurrent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">∥</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main"><span class="free">∥</span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">≡</span> <span class="main">¬</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main"><span class="free">≺</span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main"><span class="free">≺</span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> concurrentI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">s1</span> <span class="main"><span class="free">≺</span></span> <span class="free">s2</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="free">s2</span> <span class="main"><span class="free">≺</span></span> <span class="free">s1</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">s1</span> <span class="main">∥</span> <span class="free">s2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> concurrent_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> concurrentD1 <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">∥</span> <span class="free">s2</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="free">s1</span> <span class="main"><span class="free">≺</span></span> <span class="free">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> concurrent_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> concurrentD2 <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">∥</span> <span class="free">s2</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="free">s2</span> <span class="main"><span class="free">≺</span></span> <span class="free">s1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> concurrent_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> concurrent_refl <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∥</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> concurrent_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> concurrent_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">∥</span> <span class="free">s2</span> <span class="main">⟷</span> <span class="free">s2</span> <span class="main">∥</span> <span class="free">s1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> concurrent_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">concurrent_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">concurrent_set</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∥</span> <span class="bound">y</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> concurrent_set_empty <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"concurrent_set <span class="free">x</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> concurrent_set_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> concurrent_set_ConsE <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"concurrent_set <span class="free">a</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"concurrent_set <span class="free">a</span> <span class="free">xs</span> <span class="main">⟹</span> concurrent <span class="free">x</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">G</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> concurrent_set_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> concurrent_set_ConsI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"concurrent_set <span class="free">a</span> <span class="free">xs</span> <span class="main">⟹</span> concurrent <span class="free">a</span> <span class="free">x</span> <span class="main">⟹</span> concurrent_set <span class="free">a</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> concurrent_set_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> concurrent_set_appendI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"concurrent_set <span class="free">a</span> <span class="free">xs</span> <span class="main">⟹</span> concurrent_set <span class="free">a</span> <span class="free">ys</span> <span class="main">⟹</span> concurrent_set <span class="free">a</span> <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> concurrent_set_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> concurrent_set_Cons_Snoc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"concurrent_set <span class="free">a</span> <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> concurrent_set <span class="free">a</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> concurrent_set_def<span class="main">)</span>

<span class="comment1">(*************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Happens-before consistency›</span></span>
<span class="comment1">(*************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The purpose of the happens-before relation is to require that some operations must be applied
     in a particular order, while allowing concurrent operations to be reordered with respect to each other.
     We assume that each node applies operations in some sequential order (a standard assumption
     for distributed algorithms), and so we can model the execution history of a node as a list of operations.›</span></span>
  
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">hb_consistent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hb_consistent</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">hb_consistent</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">≺</span></span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">hb_consistent</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹As a result, whenever two operations $\isa{x}$ and $\isa{y}$ appear in a hb-consistent list,
     and $\isa{x}\prec\isa{y}$, then $\isa{x}$ must appear before $\isa{y}$ in the list.
     However, if $\isa{x}\mathbin{\isasymparallel}\isa{y}$, the operations can appear in the list
     in either order.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main"><span class="free">≺</span></span> <span class="free">y</span> <span class="main">∨</span> concurrent <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="free">y</span> <span class="main"><span class="free">≺</span></span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> less_asym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> consistentI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hb_consistent <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> <span class="free">z</span> <span class="main"><span class="free">≺</span></span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"hb_consistent <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">z</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms hb_consistent.intros append_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">inductive_cases</span></span>  hb_consistent_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"hb_consistent <span class="main">[]</span>"</span></span>
  <span class="quoted"><span class="quoted">"hb_consistent <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"hb_consistent <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"hb_consistent <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">@</span><span class="main">[</span><span class="free">z</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span>  hb_consistent_elim_gen<span class="main">:</span>
  <span class="quoted"><span class="quoted">"hb_consistent <span class="free">zs</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hb_consistent_append_D1 <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hb_consistent <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"hb_consistent <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> hb_consistent_append_D2 <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hb_consistent <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"hb_consistent <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hb_consistent_append_elim_ConsD <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hb_consistent <span class="main">(</span><span class="free">y</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"hb_consistent <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms hb_consistent_append_D2 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> append_Cons append_Nil<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hb_consistent_remove1 <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hb_consistent <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"hb_consistent <span class="main">(</span>remove1 <span class="free">x</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hb_consistent.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> remove1_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hb_consistent_singleton <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hb_consistent <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> hb_consistent.intros <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> hb_consistent_prefix_suffix_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hb_consistent <span class="free">ys</span>"</span></span>
          <span class="quoted"><span class="quoted">"hb_consistent <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">xs</span> <span class="main">=</span> set <span class="free">ys</span>"</span></span>
          <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"distinct <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">prefix</span> <span class="bound">suffix</span><span class="main">.</span> <span class="free">ys</span> <span class="main">=</span> <span class="bound">prefix</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">suffix</span> <span class="main">∧</span> concurrent_set <span class="free">x</span> <span class="bound">suffix</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hb_consistent.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span>
  <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> hb_consistent <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span>
               <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set <span class="bound">xs</span> <span class="main">=</span> set <span class="skolem">ys</span> <span class="main">⟹</span>
               distinct <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="skolem">ys</span> <span class="main">⟹</span>
             <span class="main">∃</span><span class="bound">prefix</span> <span class="bound">suffix</span><span class="main">.</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="bound">prefix</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">suffix</span> <span class="main">∧</span> concurrent_set <span class="free">x</span> <span class="bound">suffix</span><span class="main">)</span> "</span></span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"hb_consistent <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">ys</span><span class="main">.</span> <span class="main">¬</span> <span class="free">hb</span> <span class="skolem">y</span> <span class="bound">x</span>"</span></span>
                <span class="quoted"><span class="quoted">"hb_consistent <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
                <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set <span class="skolem">xs</span> <span class="main">=</span> set <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
                <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">prefix</span> <span class="bound">suffix</span><span class="main">.</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> <span class="bound">prefix</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">suffix</span> <span class="main">∧</span> concurrent_set <span class="free">x</span> <span class="bound">suffix</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> y_in_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>set <span class="skolem">xs</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> set_equality_technical<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> remove_y_in_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set <span class="main">(</span>remove1 <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hb_consistent <span class="main">(</span><span class="main">(</span>remove1 <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms hb_consistent_remove1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>        
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="main">(</span>remove1 <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">prefix</span></span> <span class="skolem"><span class="skolem">suffix</span></span> <span class="keyword2"><span class="keyword">where</span></span> ys_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">prefix</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">suffix</span> <span class="main">∧</span> concurrent_set <span class="free">x</span> <span class="skolem">suffix</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"concurrent <span class="free">x</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms y_in_xs remove_y_in_xs concurrent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"concurrent_set <span class="free">x</span> <span class="main">(</span><span class="skolem">suffix</span><span class="main">@</span><span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ys_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">prefix</span> <span class="bound">suffix</span><span class="main">.</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> <span class="bound">prefix</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">suffix</span> <span class="main">∧</span> concurrent_set <span class="free">x</span> <span class="bound">suffix</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">prefix</span> <span class="bound">suffix</span><span class="main">.</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> <span class="bound">prefix</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">suffix</span> <span class="main">∧</span> concurrent_set <span class="free">x</span> <span class="bound">suffix</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hb_consistent_append <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hb_consistent <span class="free">suffix</span>"</span></span>
          <span class="quoted"><span class="quoted">"hb_consistent <span class="free">prefix</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> set <span class="free">suffix</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">prefix</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="bound">s</span> <span class="main"><span class="free">≺</span></span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hb_consistent <span class="main">(</span><span class="free">prefix</span> <span class="main">@</span> <span class="free">suffix</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hb_consistent.induct<span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hb_consistent_append_porder<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hb_consistent <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">y</span> <span class="main"><span class="free">≺</span></span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="comment1">(*************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Apply operations›</span></span>
<span class="comment1">(*************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We can now define a function \isa{apply-operations} that composes an arbitrary list of operations
     into a state transformer. We first map \isa{interp} across the list to obtain a state transformer
     for each operation, and then collectively compose them using the Kleisli arrow composition combinator.›</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">apply_operations</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇀</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">apply_operations</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">≡</span> foldl <span class="main">(⊳)</span> Some <span class="main">(</span>map <span class="free">interp</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> apply_operations_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"apply_operations <span class="main">[]</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apply_operations_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> apply_operations_Snoc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"apply_operations <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>apply_operations <span class="free">xs</span><span class="main">)</span> <span class="main">⊳</span> <span class="main"><span class="free">⟨</span></span><span class="free">x</span><span class="main"><span class="free">⟩</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_operations_def kleisli_def<span class="main">)</span>

<span class="comment1">(*************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Concurrent operations commute›</span></span>
<span class="comment1">(*************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We say that two operations $\isa{x}$ and $\isa{y}$ \emph{commute} whenever
     $\langle\isa{x}\rangle \mathbin{\isasymrhd} \langle\isa{y}\rangle = \langle\isa{y}\rangle \mathbin{\isasymrhd} \langle\isa{x}\rangle$,
     i.e. when we can swap the order of the composition of their interpretations without changing
     the resulting state transformer. For our purposes, requiring that this property holds for
     \emph{all} pairs of operations is too strong. Rather, the commutation property is only required
     to hold for operations that are concurrent.›</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">concurrent_ops_commute</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">concurrent_ops_commute</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span>
    <span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">}</span> <span class="main">⊆</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟶</span> concurrent <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="main"><span class="free">⟨</span></span><span class="bound">x</span><span class="main"><span class="free">⟩</span></span><span class="main">⊳</span><span class="main"><span class="free">⟨</span></span><span class="bound">y</span><span class="main"><span class="free">⟩</span></span> <span class="main">=</span> <span class="main"><span class="free">⟨</span></span><span class="bound">y</span><span class="main"><span class="free">⟩</span></span><span class="main">⊳</span><span class="main"><span class="free">⟨</span></span><span class="bound">x</span><span class="main"><span class="free">⟩</span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> concurrent_ops_commute_empty <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"concurrent_ops_commute <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> concurrent_ops_commute_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> concurrent_ops_commute_singleton <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"concurrent_ops_commute <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> concurrent_ops_commute_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> concurrent_ops_commute_appendD <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"concurrent_ops_commute <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"concurrent_ops_commute <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> concurrent_ops_commute_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> concurrent_ops_commute_rearrange<span class="main">:</span>
  <span class="quoted"><span class="quoted">"concurrent_ops_commute <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">x</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span> <span class="main">=</span> concurrent_ops_commute <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> concurrent_ops_commute_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> concurrent_ops_commute_concurrent_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"concurrent_ops_commute <span class="main">(</span><span class="free">prefix</span><span class="main">@</span><span class="free">suffix</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"concurrent_set <span class="free">x</span> <span class="free">suffix</span>"</span></span>
          <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">prefix</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">suffix</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"apply_operations <span class="main">(</span><span class="free">prefix</span> <span class="main">@</span> <span class="free">suffix</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> apply_operations <span class="main">(</span><span class="free">prefix</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">suffix</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">suffix</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"concurrent_ops_commute <span class="main">(</span><span class="free">prefix</span> <span class="main">@</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span>
              concurrent_set <span class="free">x</span> <span class="skolem">xs</span> <span class="main">⟹</span> distinct <span class="main">(</span><span class="free">prefix</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟹</span> 
              apply_operations <span class="main">(</span><span class="free">prefix</span> <span class="main">@</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> apply_operations <span class="main">(</span><span class="free">prefix</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"concurrent_ops_commute <span class="main">(</span><span class="free">prefix</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
                <span class="quoted"><span class="quoted">"concurrent_set <span class="free">x</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">prefix</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> ac_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="skolem">a</span><span class="main"><span class="free">⟩</span></span> <span class="main">⊳</span> <span class="main"><span class="free">⟨</span></span><span class="free">x</span><span class="main"><span class="free">⟩</span></span> <span class="main">=</span> <span class="main"><span class="free">⟨</span></span><span class="free">x</span><span class="main"><span class="free">⟩</span></span> <span class="main">⊳</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">a</span><span class="main"><span class="free">⟩</span></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> concurrent_ops_commute_def<span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> copc<span class="main">:</span> <span class="quoted"><span class="quoted">"concurrent_ops_commute <span class="main">(</span><span class="free">prefix</span> <span class="main">@</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> concurrent_ops_commute_def<span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="main">(</span><span class="main">(</span><span class="free">prefix</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>apply_operations <span class="main">(</span><span class="free">prefix</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊳</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">a</span><span class="main"><span class="free">⟩</span></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> append_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>apply_operations <span class="main">(</span><span class="free">prefix</span> <span class="main">@</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⊳</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">a</span><span class="main"><span class="free">⟩</span></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IH assms copc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>apply_operations <span class="main">(</span><span class="free">prefix</span> <span class="main">@</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊳</span> <span class="main"><span class="free">⟨</span></span><span class="free">x</span><span class="main"><span class="free">⟩</span></span><span class="main">)</span> <span class="main">⊳</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">a</span><span class="main"><span class="free">⟩</span></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> append_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>apply_operations <span class="main">(</span><span class="free">prefix</span> <span class="main">@</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊳</span> <span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="skolem">a</span><span class="main"><span class="free">⟩</span></span> <span class="main">⊳</span> <span class="main"><span class="free">⟨</span></span><span class="free">x</span><span class="main"><span class="free">⟩</span></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ac_comm kleisli_comm_cong kleisli_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="main">(</span><span class="free">prefix</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> apply_operations <span class="main">(</span><span class="free">prefix</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons_eq_appendI append_assoc apply_operations_Snoc kleisli_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Abstract convergence theorem›</span></span>
<span class="comment1">(*************************************************************************)</span>
  
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We can now state and prove our main theorem, $\isa{convergence}$.
     This theorem states that two hb-consistent lists of distinct operations, which are permutations
     of each other and in which concurrent operations commute, have the same interpretation.›</span></span>
  
<span class="keyword1"><span class="command">theorem</span></span>  convergence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> set <span class="free">ys</span>"</span></span>
          <span class="quoted"><span class="quoted">"concurrent_ops_commute <span class="free">xs</span>"</span></span>
          <span class="quoted"><span class="quoted">"concurrent_ops_commute <span class="free">ys</span>"</span></span>
          <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
          <span class="quoted"><span class="quoted">"distinct <span class="free">ys</span>"</span></span>
          <span class="quoted"><span class="quoted">"hb_consistent <span class="free">xs</span>"</span></span>
          <span class="quoted"><span class="quoted">"hb_consistent <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"apply_operations <span class="free">xs</span> <span class="main">=</span> apply_operations <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> assms<span class="main">:</span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">prefix</span></span> <span class="skolem"><span class="skolem">suffix</span></span> <span class="keyword2"><span class="keyword">where</span></span> ys_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">prefix</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">suffix</span> <span class="main">∧</span> concurrent_set <span class="skolem">x</span> <span class="skolem">suffix</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hb_consistent_prefix_suffix_exists <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="skolem">prefix</span> <span class="main">@</span> <span class="skolem">suffix</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"hb_consistent <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hb_consistent <span class="skolem">prefix</span>"</span></span> <span class="quoted"><span class="quoted">"hb_consistent <span class="skolem">suffix</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ys_split assms hb_consistent_append_D2 hb_consistent_append_elim_ConsD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"hb_consistent <span class="main">(</span><span class="skolem">prefix</span> <span class="main">@</span> <span class="skolem">suffix</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> hb_consistent_append hb_consistent_append_porder list.set_intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ys_split<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"concurrent_ops_commute <span class="main">(</span><span class="skolem">prefix</span> <span class="main">@</span> <span class="skolem">suffix</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms ys_split <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> concurrent_ops_commute_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"concurrent_ops_commute <span class="main">(</span><span class="skolem">prefix</span> <span class="main">@</span> <span class="skolem">suffix</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> append_assoc <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="skolem">xs</span> <span class="main">=</span> apply_operations <span class="main">(</span><span class="skolem">prefix</span><span class="main">@</span><span class="skolem">suffix</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> Diff_insert_absorb Un_iff * concurrent_ops_commute_appendD set_append<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="main">(</span><span class="skolem">prefix</span><span class="main">@</span><span class="skolem">suffix</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> apply_operations <span class="main">(</span><span class="skolem">prefix</span><span class="main">@</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">suffix</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ys_split assms ** concurrent_ops_commute_concurrent_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ys_split <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> append_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> append_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> convergence_ext<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> set <span class="free">ys</span>"</span></span>
          <span class="quoted"><span class="quoted">"concurrent_ops_commute <span class="free">xs</span>"</span></span>
          <span class="quoted"><span class="quoted">"concurrent_ops_commute <span class="free">ys</span>"</span></span>
          <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
          <span class="quoted"><span class="quoted">"distinct <span class="free">ys</span>"</span></span>
          <span class="quoted"><span class="quoted">"hb_consistent <span class="free">xs</span>"</span></span>
          <span class="quoted"><span class="quoted">"hb_consistent <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"apply_operations <span class="free">xs</span> <span class="free">s</span> <span class="main">=</span> apply_operations <span class="free">ys</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> convergence assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Convergence and progress›</span></span>
  
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Besides convergence, another required property of SEC is \emph{progress}: if a valid operation
     was issued on one node, then applying that operation on other nodes must also succeed---that is,
     the execution must not become stuck in an error state.
     Although the type signature of the interpretation function allows operations to fail, we need to
     prove that in all $\isa{hb-consistent}$ network behaviours such failure never actually occurs.
     We capture the combined requirements in the $\isa{strong-eventual-consistency}$ locale,
     which extends $\isa{happens-before}$.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> strong_eventual_consistency <span class="main">=</span> happens_before <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">op_history</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">initial_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> causality<span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="free">op_history</span> <span class="free">xs</span> <span class="main">⟹</span> hb_consistent <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinctness<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">op_history</span> <span class="free">xs</span> <span class="main">⟹</span> distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> commutativity<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">op_history</span> <span class="free">xs</span> <span class="main">⟹</span> concurrent_ops_commute <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> no_failure<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="free">op_history</span><span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> apply_operations <span class="free">xs</span> <span class="free">initial_state</span> <span class="main">=</span> Some <span class="free">state</span> <span class="main">⟹</span> <span class="main"><span class="free">⟨</span></span><span class="free">x</span><span class="main"><span class="free">⟩</span></span> <span class="free">state</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trunc_history<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">op_history</span><span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">op_history</span> <span class="free">xs</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">theorem</span></span> sec_convergence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> set <span class="free">ys</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">op_history</span> <span class="free">xs</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">op_history</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"apply_operations <span class="free">xs</span> <span class="main">=</span> apply_operations <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms convergence causality commutativity distinctness<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> sec_progress<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">op_history</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"apply_operations <span class="free">xs</span> <span class="free">initial_state</span> <span class="main">≠</span> None"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="skolem">xs</span> <span class="free">initial_state</span> <span class="main">≠</span> None"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc.IH snoc.prems trunc_history kleisli_def bind_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> apply_operations <span class="skolem">xs</span> <span class="main">⊳</span> <span class="main"><span class="free">⟨</span></span><span class="skolem">x</span><span class="main"><span class="free">⟩</span></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> no_failure snoc.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kleisli_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bind_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Network">
<div class="head">
<h1>Theory Network</h1>
</div>
<pre class="source"><span class="comment1">(* Victor B. F. Gomes, University of Cambridge
   Martin Kleppmann, University of Cambridge
   Dominic P. Mulligan, University of Cambridge
   Alastair R. Beresford, University of Cambridge
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Axiomatic network models›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In this section we develop a formal definition of an \emph{asynchronous unreliable causal broadcast network}.
     We choose this model because it satisfies the causal delivery requirements of many operation-based
     CRDTs~\cite{Almeida:2015fc,Baquero:2014ed}. Moreover, it is suitable for use in decentralised settings,
     as motivated in the introduction, since it does not require waiting for communication with
     a central server or a quorum of nodes.›</span></span>

<span class="keyword1"><span class="command">theory</span></span>
  Network
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Convergence.html">Convergence</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Node histories›</span></span>
  
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We model a distributed system as an unbounded number of communicating nodes.
     We assume nothing about the communication pattern of nodes---we assume only that each node is
     uniquely identified by a natural number, and that the flow of execution at each node consists
     of a finite, totally ordered sequence of execution steps (events).
     We call that sequence of events at node $i$ the \emph{history} of that node.
     For convenience, we assume that every event or execution step is unique within a node's history.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> node_histories <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">history</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'evt</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> histories_distinct <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> node_histories<span class="main">)</span> history_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> node_histories<span class="main">)</span> <span class="entity">history_order</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'evt</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'evt</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword3">/ </span><span class="keyword1">⊏⇧</span>_<span class="keyword3">/ </span>_"</span> <span class="main">[</span>50<span class="main">,</span>1000<span class="main">,</span>50<span class="main">]</span>50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">⊏⇧</span></span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="bound">xs</span><span class="main">@</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="bound">ys</span><span class="main">@</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">#</span><span class="bound">zs</span> <span class="main">=</span> <span class="free">history</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> node_histories<span class="main">)</span> node_total_order_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">⊏⇧</span><span class="free">i</span> <span class="free">e2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e2</span> <span class="main">⊏⇧</span><span class="free">i</span> <span class="free">e3</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">⊏⇧</span><span class="free">i</span> <span class="free">e3</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs1</span></span> <span class="skolem"><span class="skolem">xs2</span></span> <span class="skolem"><span class="skolem">ys1</span></span> <span class="skolem"><span class="skolem">ys2</span></span> <span class="skolem"><span class="skolem">zs1</span></span> <span class="skolem"><span class="skolem">zs2</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs1</span> <span class="main">@</span> <span class="free">e1</span> <span class="main">#</span> <span class="skolem">ys1</span> <span class="main">@</span> <span class="free">e2</span> <span class="main">#</span> <span class="skolem">zs1</span> <span class="main">=</span> <span class="free">history</span> <span class="free">i</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">xs2</span> <span class="main">@</span> <span class="free">e2</span> <span class="main">#</span> <span class="skolem">ys2</span> <span class="main">@</span> <span class="free">e3</span> <span class="main">#</span> <span class="skolem">zs2</span> <span class="main">=</span> <span class="free">history</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> history_order_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs1</span> <span class="main">@</span> <span class="free">e1</span> <span class="main">#</span> <span class="skolem">ys1</span> <span class="main">=</span> <span class="skolem">xs2</span> <span class="main">∧</span> <span class="skolem">zs1</span> <span class="main">=</span> <span class="skolem">ys2</span> <span class="main">@</span> <span class="free">e3</span> <span class="main">#</span> <span class="skolem">zs2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule_tac</span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">history</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ys<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">e2</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> pre_suf_eq_distinct_list<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> history_order_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> append.assoc append_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> node_histories<span class="main">)</span> local_order_carrier_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">⊏⇧</span><span class="free">i</span> <span class="free">e2</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">e1</span><span class="main">,</span><span class="free">e2</span><span class="main">}</span> <span class="main">⊆</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> history_order_def<span class="main">)</span>
    <span class="main">(</span><span class="operator">metis</span> in_set_conv_decomp Un_iff Un_subset_iff insert_subset list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span>
        set_append set_subset_Cons<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> node_histories<span class="main">)</span> node_total_order_irrefl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">e</span> <span class="main">⊏⇧</span><span class="free">i</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> history_order_def<span class="main">)</span>
    <span class="main">(</span><span class="operator">metis</span> Un_iff histories_distinct distinct_append distinct_set_notin
        list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> node_histories<span class="main">)</span> node_total_order_antisym<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">⊏⇧</span><span class="free">i</span> <span class="free">e2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e2</span> <span class="main">⊏⇧</span><span class="free">i</span> <span class="free">e1</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms node_total_order_irrefl node_total_order_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> node_histories<span class="main">)</span> node_order_is_total<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e2</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">≠</span> <span class="free">e2</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">⊏⇧</span><span class="free">i</span> <span class="free">e2</span> <span class="main">∨</span> <span class="free">e2</span> <span class="main">⊏⇧</span><span class="free">i</span> <span class="free">e1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> history_order_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> list_split_two_elems histories_distinct<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> node_histories<span class="main">)</span> <span class="entity">prefix_of_node_history</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'evt</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">prefix</span> <span class="keyword1">of</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1"><span class="free">prefix</span></span> <span class="keyword1"><span class="free">of</span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">@</span><span class="bound">ys</span> <span class="main">=</span> <span class="free">history</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> node_histories<span class="main">)</span> carriers_head_lt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">#</span><span class="free">ys</span> <span class="main">=</span> <span class="free">history</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">x</span> <span class="main">⊏⇧</span><span class="free">i</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> history_order_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> xs1 ys1 zs1<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">xs1</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="improper">ys1</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="improper">zs1</span> <span class="main">=</span> <span class="free">ys</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">history</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ys<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> pre_suf_eq_distinct_list<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> node_histories<span class="main">)</span> prefix_of_ConsD <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">#</span> <span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefix_of_node_history_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> node_histories<span class="main">)</span> prefix_of_appendD <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefix_of_node_history_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> node_histories<span class="main">)</span> prefix_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefix_of_node_history_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> histories_distinct distinct_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> node_histories<span class="main">)</span> prefix_to_carriers <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefix_of_node_history_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Un_iff set_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> node_histories<span class="main">)</span> prefix_elem_to_carriers<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefix_of_node_history_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Un_iff set_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> node_histories<span class="main">)</span> local_order_prefix_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊏⇧</span><span class="free">i</span> <span class="free">y</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="free">history</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms prefix_of_node_history_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">cs</span> <span class="main">=</span> <span class="free">history</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms history_order_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">suf</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">pre</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">suf</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms split_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">bs</span> <span class="main">∧</span> <span class="skolem">suf</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">history</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ys<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> pre_suf_eq_distinct_list<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms * <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> node_histories<span class="main">)</span> local_order_prefix_closed_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊏⇧</span><span class="free">i</span> <span class="free">y</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> local_order_prefix_closed<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_total_order_irrefl prefix_to_carriers<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> node_histories<span class="main">)</span> events_before_exist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">pre</span><span class="main">.</span> <span class="bound">pre</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">idx</span><span class="main">.</span> <span class="bound">idx</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span> <span class="main">!</span> <span class="bound">idx</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_elem_nth<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> append_take_drop_id take_Suc_conv_app_nth prefix_of_node_history_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> node_histories<span class="main">)</span> events_in_local_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="main">@</span> <span class="main">[</span><span class="free">e2</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">∈</span> set <span class="free">pre</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">⊏⇧</span><span class="free">i</span> <span class="free">e2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms split_list <span class="keyword1"><span class="command">unfolding</span></span> history_order_def prefix_of_node_history_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Asynchronous broadcast networks›</span></span>
  
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We define a new locale $\isa{network}$ containing three axioms that define how broadcast
     and deliver events may interact, with these axioms defining the properties of our network model.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'msg</span> event
  <span class="main">=</span> Broadcast <span class="tfree"><span class="quoted"><span class="tfree">'msg</span></span></span>
  <span class="main">|</span> Deliver <span class="tfree"><span class="quoted"><span class="tfree">'msg</span></span></span>

<span class="keyword1"><span class="command">locale</span></span> network <span class="main">=</span> node_histories <span class="quoted"><span class="free">history</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">history</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'msg</span> event list"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">msg_id</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg</span> <span class="main">⇒</span> <span class="tfree">'msgid</span>"</span></span>
  <span class="comment1">(* Broadcast/Deliver interaction *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> delivery_has_a_cause<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Deliver <span class="free">m</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
                                    <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> Broadcast <span class="free">m</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> deliver_locally<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Broadcast <span class="free">m</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
                                    Broadcast <span class="free">m</span> <span class="main">⊏⇧</span><span class="free">i</span> Deliver <span class="free">m</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> msg_id_unique<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Broadcast <span class="free">m1</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span><span class="main">;</span>
                            Broadcast <span class="free">m2</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span><span class="main">;</span>
                            <span class="free">msg_id</span> <span class="free">m1</span> <span class="main">=</span> <span class="free">msg_id</span> <span class="free">m2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span> <span class="main">∧</span> <span class="free">m1</span> <span class="main">=</span> <span class="free">m2</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
The axioms can be understood as follows:
\begin{description}
    \item[delivery-has-a-cause:] If some message $\isa{m}$ was delivered at some node, then there exists some node on which $\isa{m}$ was broadcast.
        With this axiom, we assert that messages are not created ``out of thin air'' by the network itself, and that the only source of messages are the nodes.
    \item[deliver-locally:] If a node broadcasts some message $\isa{m}$, then the same node must subsequently also deliver $\isa{m}$ to itself.
        Since $\isa{m}$ does not actually travel over the network, this local delivery is always possible, even if the network is interrupted.
        Local delivery may seem redundant, since the effect of the delivery could also be implemented by the broadcast event itself; however, it is standard practice in the description of broadcast protocols that the sender of a message also sends it to itself, since this property simplifies the definition of algorithms built on top of the broadcast abstraction \cite{Cachin:2011wt}.
    \item[msg-id-unique:] We do not assume that the message type $\isacharprime\isa{msg}$ has any particular structure; we only assume the existence of a function $\isa{msg-id} \mathbin{\isacharcolon\isacharcolon} \isacharprime\isa{msg} \mathbin{\isasymRightarrow} \isacharprime\isa{msgid}$ that maps every message to some globally unique identifier of type $\isacharprime\isa{msgid}$.
        We assert this uniqueness by stating that if $\isa{m1}$ and $\isa{m2}$ are any two messages broadcast by any two nodes, and their $\isa{msg-id}$s are the same, then they were in fact broadcast by the same node and the two messages are identical. 
        In practice, these globally unique IDs can by implemented using unique node identifiers, sequence numbers or timestamps.
\end{description}
›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network<span class="main">)</span> broadcast_before_delivery<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="free">m</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> Broadcast <span class="free">m</span> <span class="main">⊏⇧</span><span class="bound">j</span> Deliver <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms deliver_locally delivery_has_a_cause <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network<span class="main">)</span> broadcasts_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="free">m</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="free">m</span> <span class="main">∉</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms msg_id_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Based on the well-known definition by \cite{Lamport:1978jq}, we say that
    $\isa{m1}\prec\isa{m2}$ if any of the following is true:
    \begin{enumerate}
      \item $\isa{m1}$ and $\isa{m2}$ were broadcast by the same node, and $\isa{m1}$ was broadcast before $\isa{m2}$.
      \item The node that broadcast $\isa{m2}$ had delivered $\isa{m1}$ before it broadcast $\isa{m2}$.
      \item There exists some operation $\isa{m3}$ such that $\isa{m1} \prec \isa{m3}$ and $\isa{m3} \prec \isa{m2}$.
    \end{enumerate}›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network<span class="main">)</span> <span class="entity">hb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg</span> <span class="main">⇒</span> <span class="tfree">'msg</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  hb_broadcast<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Broadcast <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">⊏⇧</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> Broadcast <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">hb</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span>"</span></span> <span class="main">|</span>
  hb_deliver<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Deliver <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">⊏⇧</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> Broadcast <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">hb</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span>"</span></span> <span class="main">|</span>
  hb_trans<span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">hb</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">;</span> <span class="free">hb</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">m3</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">hb</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m3</span></span></span>"</span></span>
  
<span class="keyword1"><span class="command">inductive_cases</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network<span class="main">)</span> hb_elim<span class="main">:</span> <span class="quoted"><span class="quoted">"hb <span class="free">x</span> <span class="free">y</span>"</span></span>
        
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network<span class="main">)</span> <span class="entity">weak_hb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg</span> <span class="main">⇒</span> <span class="tfree">'msg</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">weak_hb</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">≡</span> hb <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> causal_network <span class="main">=</span> network <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> causal_delivery<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="free">m2</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span> hb <span class="free">m1</span> <span class="free">m2</span> <span class="main">⟹</span> Deliver <span class="free">m1</span> <span class="main">⊏⇧</span><span class="free">j</span> Deliver <span class="free">m2</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> causal_network<span class="main">)</span> causal_broadcast<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="free">m2</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="free">m1</span> <span class="main">⊏⇧</span><span class="free">i</span> Broadcast <span class="free">m2</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="free">m1</span> <span class="main">⊏⇧</span><span class="free">j</span> Deliver <span class="free">m2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms causal_delivery hb.intros<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network<span class="main">)</span> hb_broadcast_exists1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hb <span class="free">m1</span> <span class="free">m2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> Broadcast <span class="free">m1</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hb.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">meson</span> insert_subset node_histories.local_order_carrier_closed node_histories_axioms<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">meson</span> delivery_has_a_cause insert_subset local_order_carrier_closed<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network<span class="main">)</span> hb_broadcast_exists2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hb <span class="free">m1</span> <span class="free">m2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> Broadcast <span class="free">m2</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hb.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">meson</span> insert_subset node_histories.local_order_carrier_closed node_histories_axioms<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">meson</span> delivery_has_a_cause insert_subset local_order_carrier_closed<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Causal networks›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> causal_network<span class="main">)</span> hb_has_a_reason<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hb <span class="free">m1</span> <span class="free">m2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="free">m2</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="free">m1</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span> <span class="main">∨</span> Broadcast <span class="free">m1</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hb.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> insert_subset local_order_carrier_closed network.broadcasts_unique network_axioms<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> insert_subset local_order_carrier_closed network.broadcasts_unique network_axioms<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> hb_trans causal_delivery local_order_carrier_closed <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> causal_network<span class="main">)</span> hb_cross_node_delivery<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hb <span class="free">m1</span> <span class="free">m2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="free">m1</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="free">m2</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="free">m1</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hb.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> broadcasts_unique insert_subset local_order_carrier_closed<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> insert_subset local_order_carrier_closed network.broadcasts_unique network_axioms<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> broadcasts_unique hb.intros<span class="main">(</span>3<span class="main">)</span> hb_has_a_reason <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> causal_network<span class="main">)</span> hb_irrefl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hb <span class="free">m1</span> <span class="free">m2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">≠</span> <span class="free">m2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hb.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hb_broadcast <span class="skolem">m1</span> <span class="skolem">i</span> <span class="skolem">m2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> node_total_order_antisym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hb_deliver <span class="skolem">m1</span> <span class="skolem">i</span> <span class="skolem">m2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">meson</span> causal_broadcast insert_subset local_order_carrier_closed node_total_order_irrefl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hb_trans <span class="skolem">m1</span> <span class="skolem">m2</span> <span class="skolem">m3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="skolem">m3</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="skolem">m2</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hb_broadcast_exists2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms hb_trans <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> causal_network.causal_delivery causal_network_axioms
        deliver_locally insert_subset network.hb.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> network_axioms 
        node_histories.local_order_carrier_closed assms hb_trans
        node_histories_axioms node_total_order_irrefl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> causal_network<span class="main">)</span> hb_broadcast_broadcast_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hb <span class="free">m1</span> <span class="free">m2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="free">m1</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="free">m2</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="free">m1</span> <span class="main">⊏⇧</span><span class="free">i</span> Broadcast <span class="free">m2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hb.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hb_broadcast <span class="skolem">m1</span> <span class="skolem">i</span> <span class="skolem">m2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> insertI1 local_order_carrier_closed network.broadcasts_unique network_axioms subsetCE<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hb_deliver <span class="skolem">m1</span> <span class="skolem">i</span> <span class="skolem">m2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> broadcasts_unique insert_subset local_order_carrier_closed
          network.broadcast_before_delivery network_axioms node_total_order_trans<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hb_trans <span class="skolem">m1</span> <span class="skolem">m2</span> <span class="skolem">m3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Broadcast <span class="skolem">m2</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> hb_trans node_total_order_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="skolem">m2</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m1</span> <span class="main">≠</span> <span class="skolem">m2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m2</span> <span class="main">≠</span> <span class="skolem">m3</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> hb_has_a_reason hb_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> hb_trans event.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> hb.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> hb_irrefl network.hb.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> network_axioms node_order_is_total hb_irrefl<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> causal_network<span class="main">)</span> hb_antisym<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hb <span class="free">x</span> <span class="free">y</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hb <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"False"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hb.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m1</span> <span class="skolem">i</span> <span class="skolem">m2</span>  
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"hb <span class="skolem">m2</span> <span class="skolem">m1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="skolem">m1</span> <span class="main">⊏⇧</span><span class="skolem">i</span> Broadcast <span class="skolem">m2</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">erule</span> hb_elim<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ia</span><span class="main">.</span> Broadcast <span class="skolem">m1</span> <span class="main">⊏⇧</span><span class="skolem">i</span> Broadcast <span class="skolem">m2</span> <span class="main">⟹</span> Broadcast <span class="skolem">m2</span> <span class="main">⊏⇧</span><span class="bound">ia</span> Broadcast <span class="skolem">m1</span> <span class="main">⟹</span> False"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> broadcasts_unique insert_subset local_order_carrier_closed node_total_order_irrefl node_total_order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ia</span><span class="main">.</span> Broadcast <span class="skolem">m1</span> <span class="main">⊏⇧</span><span class="skolem">i</span> Broadcast <span class="skolem">m2</span> <span class="main">⟹</span> Deliver <span class="skolem">m2</span> <span class="main">⊏⇧</span><span class="bound">ia</span> Broadcast <span class="skolem">m1</span> <span class="main">⟹</span> False"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> broadcast_before_delivery broadcasts_unique insert_subset local_order_carrier_closed node_total_order_irrefl node_total_order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m2a</span><span class="main">.</span> Broadcast <span class="skolem">m1</span> <span class="main">⊏⇧</span><span class="skolem">i</span> Broadcast <span class="skolem">m2</span> <span class="main">⟹</span> hb <span class="skolem">m2</span> <span class="bound">m2a</span> <span class="main">⟹</span> hb <span class="bound">m2a</span> <span class="skolem">m1</span> <span class="main">⟹</span> False"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> hb.intros<span class="main">(</span>3<span class="main">)</span> hb_irrefl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m1</span> <span class="skolem">i</span> <span class="skolem">m2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"hb <span class="skolem">m2</span> <span class="skolem">m1</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="skolem">m1</span> <span class="main">⊏⇧</span><span class="skolem">i</span> Broadcast <span class="skolem">m2</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">erule</span> hb_elim<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ia</span><span class="main">.</span> Deliver <span class="skolem">m1</span> <span class="main">⊏⇧</span><span class="skolem">i</span> Broadcast <span class="skolem">m2</span> <span class="main">⟹</span> Broadcast <span class="skolem">m2</span> <span class="main">⊏⇧</span><span class="bound">ia</span> Broadcast <span class="skolem">m1</span> <span class="main">⟹</span> False"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> broadcast_before_delivery broadcasts_unique insert_subset local_order_carrier_closed node_total_order_irrefl node_total_order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ia</span><span class="main">.</span> Deliver <span class="skolem">m1</span> <span class="main">⊏⇧</span><span class="skolem">i</span> Broadcast <span class="skolem">m2</span> <span class="main">⟹</span> Deliver <span class="skolem">m2</span> <span class="main">⊏⇧</span><span class="bound">ia</span> Broadcast <span class="skolem">m1</span> <span class="main">⟹</span> False"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> causal_network.causal_delivery causal_network_axioms hb.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hb.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> insert_subset local_order_carrier_closed node_total_order_irrefl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m2a</span><span class="main">.</span> Deliver <span class="skolem">m1</span> <span class="main">⊏⇧</span><span class="skolem">i</span> Broadcast <span class="skolem">m2</span> <span class="main">⟹</span> hb <span class="skolem">m2</span> <span class="bound">m2a</span> <span class="main">⟹</span> hb <span class="bound">m2a</span> <span class="skolem">m1</span> <span class="main">⟹</span> False"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> causal_delivery hb.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> insert_subset local_order_carrier_closed network.hb.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> network_axioms node_total_order_irrefl<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m1</span> <span class="skolem">m2</span> <span class="skolem">m3</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"hb <span class="skolem">m1</span> <span class="skolem">m2</span>"</span></span> <span class="quoted"><span class="quoted">"hb <span class="skolem">m2</span> <span class="skolem">m3</span>"</span></span> <span class="quoted"><span class="quoted">"hb <span class="skolem">m3</span> <span class="skolem">m1</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>hb <span class="skolem">m2</span> <span class="skolem">m1</span> <span class="main">⟹</span> False<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>hb <span class="skolem">m3</span> <span class="skolem">m2</span> <span class="main">⟹</span> False<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hb.intros<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network<span class="main">)</span> <span class="entity">node_deliver_messages</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg</span> event list <span class="main">⇒</span> <span class="tfree">'msg</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">node_deliver_messages</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">≡</span> List.map_filter <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">e</span> <span class="keyword1">of</span> Deliver <span class="bound">m</span> <span class="main">⇒</span> Some <span class="bound">m</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network<span class="main">)</span> node_deliver_messages_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"node_deliver_messages <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_deliver_messages_def List.map_filter_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network<span class="main">)</span> node_deliver_messages_Cons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"node_deliver_messages <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>node_deliver_messages <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_deliver_messages_def map_filter_def<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network<span class="main">)</span> node_deliver_messages_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"node_deliver_messages <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>node_deliver_messages <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_deliver_messages_def map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network<span class="main">)</span> node_deliver_messages_Broadcast <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"node_deliver_messages <span class="main">[</span>Broadcast <span class="free">m</span><span class="main">]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> node_deliver_messages_def map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network<span class="main">)</span> node_deliver_messages_Deliver <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"node_deliver_messages <span class="main">[</span>Deliver <span class="free">m</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">m</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> node_deliver_messages_def map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network<span class="main">)</span> prefix_msg_in_history<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">es</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="free">m</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms prefix_to_carriers <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> node_deliver_messages_def map_filter_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> event.split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network<span class="main">)</span> prefix_contains_msg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">es</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="free">m</span> <span class="main">∈</span> set <span class="free">es</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> node_deliver_messages_def map_filter_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> event.split_asm<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network<span class="main">)</span> node_deliver_messages_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms snoc prefix_distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_filter_def node_deliver_messages_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> * prefix_contains_msg snoc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_deliver_messages_append node_deliver_messages_def map_filter_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network<span class="main">)</span> drop_last_message<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">evts</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"node_deliver_messages <span class="free">evts</span> <span class="main">=</span> <span class="free">msgs</span> <span class="main">@</span> <span class="main">[</span><span class="free">last_msg</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">pre</span><span class="main">.</span> <span class="bound">pre</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span> <span class="main">∧</span> node_deliver_messages <span class="bound">pre</span> <span class="main">=</span> <span class="free">msgs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="free">last_msg</span> <span class="main">∈</span> set <span class="free">evts</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms network.prefix_contains_msg network_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">idx</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&lt;</span> length <span class="free">evts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">evts</span> <span class="main">!</span> <span class="skolem">idx</span> <span class="main">=</span> Deliver <span class="free">last_msg</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> set_elem_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">suf</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">evts</span> <span class="main">=</span> <span class="skolem">pre</span> <span class="main">@</span> <span class="main">(</span><span class="free">evts</span> <span class="main">!</span> <span class="skolem">idx</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">suf</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> id_take_nth_drop <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">evts</span> <span class="main">=</span> <span class="skolem">pre</span> <span class="main">@</span> <span class="main">(</span>Deliver <span class="free">last_msg</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">suf</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>node_deliver_messages <span class="main">(</span><span class="main">[</span>Deliver <span class="free">last_msg</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">suf</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> distinct_singleton node_deliver_messages_Cons node_deliver_messages_Deliver
        node_deliver_messages_append node_deliver_messages_distinct not_Cons_self2 pre_suf_eq_distinct_list<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"node_deliver_messages <span class="main">(</span><span class="main">[</span>Deliver <span class="free">last_msg</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">suf</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free">last_msg</span><span class="main">]</span> <span class="main">@</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_self_conv assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> node_deliver_messages_Cons node_deliver_messages_Deliver
        node_deliver_messages_append node_deliver_messages_distinct not_Cons_self2 pre_suf_eq_distinct_list<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms * ** <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append1_eq_conv append_Cons append_Nil node_deliver_messages_append prefix_of_appendD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">locale</span></span> network_with_ops <span class="main">=</span> causal_network <span class="quoted"><span class="free">history</span></span> <span class="quoted">fst</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">history</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'msgid</span> <span class="main">×</span> <span class="tfree">'op</span><span class="main">)</span> event list"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">interp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇀</span> <span class="tfree">'state</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">initial_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> network_with_ops <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">interp_msg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msgid</span> <span class="main">×</span> <span class="tfree">'op</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇀</span> <span class="tfree">'state</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">interp_msg</span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">≡</span> <span class="free">interp</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> hb<span class="main">:</span> happens_before <span class="quoted">weak_hb</span> <span class="quoted">hb</span> <span class="quoted">interp_msg</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msgid</span> <span class="main">×</span> <span class="tfree">'op</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hb <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span>weak_hb <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="main">¬</span> weak_hb <span class="skolem">y</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> weak_hb_def <span class="keyword1"><span class="command">using</span></span> hb_antisym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"weak_hb <span class="skolem">x</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> weak_hb_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"weak_hb <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"weak_hb <span class="skolem">y</span> <span class="skolem">z</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"weak_hb <span class="skolem">x</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> weak_hb_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> network.hb.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> network_axioms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network_with_ops<span class="main">)</span> <span class="entity">apply_operations</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msgid</span> <span class="main">×</span> <span class="tfree">'op</span><span class="main">)</span> event list <span class="main">⇀</span> <span class="tfree">'state</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">apply_operations</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">≡</span> hb.apply_operations <span class="main">(</span>node_deliver_messages <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="free">initial_state</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network_with_ops<span class="main">)</span> <span class="entity">node_deliver_ops</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msgid</span> <span class="main">×</span> <span class="tfree">'op</span><span class="main">)</span> event list <span class="main">⇒</span> <span class="tfree">'op</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">node_deliver_ops</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">≡</span> map snd <span class="main">(</span>node_deliver_messages <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network_with_ops<span class="main">)</span> apply_operations_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="main">[]</span> <span class="main">=</span> Some <span class="free">initial_state</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_operations_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network_with_ops<span class="main">)</span> apply_operations_Broadcast <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span>Broadcast <span class="free">m</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> apply_operations <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_operations_def node_deliver_messages_def map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network_with_ops<span class="main">)</span> apply_operations_Deliver <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span>Deliver <span class="free">m</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>apply_operations <span class="free">xs</span> <span class="main">⤜</span> interp_msg <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_operations_def node_deliver_messages_def map_filter_def kleisli_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network_with_ops<span class="main">)</span> hb_consistent_technical<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">m</span> <span class="main">&lt;</span> length <span class="free">cs</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="main">⟹</span> <span class="free">cs</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">⊏⇧</span><span class="free">i</span> <span class="free">cs</span> <span class="main">!</span> <span class="bound">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"hb.hb_consistent <span class="main">(</span>node_deliver_messages <span class="free">cs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">cs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_deliver_messages_def hb.hb_consistent.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> map_filter_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">m</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">m</span> <span class="main">&lt;</span> length <span class="skolem">xs</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="main">⟹</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">⊏⇧</span><span class="free">i</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">-</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">m</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Broadcast <span class="skolem">x1</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_deliver_messages_append<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Deliver <span class="skolem">x2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc * <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_deliver_messages_def map_filter_def map_filter_append<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> m m1 m2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">m</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> set_elem_nth<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"length <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_allE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> causal_delivery insert_subset local_order_carrier_closed
        node_total_order_antisym<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network_with_ops<span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hb.hb_consistent <span class="main">(</span>node_deliver_messages <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hb_consistent_technical history_order_def less_one linorder_neqE_nat list_nth_split zero_order<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network_with_ops<span class="main">)</span> hb_consistent_prefix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hb.hb_consistent <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefix_of_node_history_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> hb_consistent_technical<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="skolem">n</span> <span class="skolem">ys</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="free">history</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>a<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span> <span class="main">(</span>b<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[</span><span class="bound">c</span><span class="main">]</span>"</span></span> <span class="main">|</span> <span class="main">(</span>c<span class="main">)</span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_pred length_Suc_conv length_greater_0_conv zero_less_diff<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">⊏⇧</span><span class="free">i</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> a <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> b <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms * <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> c <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms * <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> list_nth_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> c<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> append.assoc append.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> history_order_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">locale</span></span> network_with_constrained_ops <span class="main">=</span> network_with_ops <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">valid_msg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> broadcast_only_valid_msgs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="main">@</span> <span class="main">[</span>Broadcast <span class="free">m</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span> <span class="main">⟹</span>
             <span class="main">∃</span><span class="bound">state</span><span class="main">.</span> apply_operations <span class="free">pre</span> <span class="main">=</span> Some <span class="bound">state</span> <span class="main">∧</span> <span class="free">valid_msg</span> <span class="bound">state</span> <span class="free">m</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network_with_constrained_ops<span class="main">)</span> broadcast_is_valid<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="free">m</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">state</span><span class="main">.</span> <span class="free">valid_msg</span> <span class="bound">state</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms broadcast_only_valid_msgs events_before_exist <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network_with_constrained_ops<span class="main">)</span> deliver_is_valid<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="free">m</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span> <span class="bound">pre</span> <span class="bound">state</span><span class="main">.</span> <span class="bound">pre</span> <span class="main">@</span> <span class="main">[</span>Broadcast <span class="free">m</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="bound">j</span> <span class="main">∧</span> apply_operations <span class="bound">pre</span> <span class="main">=</span> Some <span class="bound">state</span> <span class="main">∧</span> <span class="free">valid_msg</span> <span class="bound">state</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> delivery_has_a_cause<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> broadcast_only_valid_msgs events_before_exist <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> network_with_constrained_ops<span class="main">)</span> deliver_in_prefix_is_valid<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="free">m</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">state</span><span class="main">.</span> <span class="free">valid_msg</span> <span class="bound">state</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms network_with_constrained_ops.deliver_is_valid network_with_constrained_ops_axioms prefix_elem_to_carriers<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Dummy network models›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> trivial_node_histories<span class="main">:</span> node_histories <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">interpretation</span></span> trivial_network<span class="main">:</span> network <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="main">[]</span>"</span></span> <span class="quoted">id</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">auto</span>
    
<span class="keyword1"><span class="command">interpretation</span></span> trivial_causal_network<span class="main">:</span> causal_network <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="main">[]</span>"</span></span> <span class="quoted">id</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">interpretation</span></span> trivial_network_with_ops<span class="main">:</span> network_with_ops <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> Some <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="main">0</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">auto</span>
    
<span class="keyword1"><span class="command">interpretation</span></span> trivial_network_with_constrained_ops<span class="main">:</span> network_with_constrained_ops <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> Some <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> True"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trivial_node_histories.prefix_of_node_history_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Ordered_List">
<div class="head">
<h1>Theory Ordered_List</h1>
</div>
<pre class="source"><span class="comment1">(* Victor B. F. Gomes, University of Cambridge
   Martin Kleppmann, University of Cambridge
   Dominic P. Mulligan, University of Cambridge
   Alastair R. Beresford, University of Cambridge
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Replicated Growable Array›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The RGA, introduced by \cite{Roh:2011dw}, is a replicated ordered list (sequence) datatype
     that supports \emph{insert} and \emph{delete} operations.›</span></span>
  
<span class="keyword1"><span class="command">theory</span></span>
  Ordered_List
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Util.html">Util</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> elt <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'id</span> <span class="main">×</span> <span class="tfree">'v</span> <span class="main">×</span> bool"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Insert and delete operations›</span></span>
 
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Insertion operations place the new element \emph{after} an existing list element with a given ID, or at the head of the list if no ID is given.
Deletion operations refer to the ID of the list element that is to be deleted.
However, it is not safe for a deletion operation to completely remove a list element, because then a concurrent insertion after the deleted element would not be able to locate the insertion position.
Instead, the list retains so-called \emph{tombstones}: a deletion operation merely sets a flag on a list element to mark it as deleted, but the element actually remains in the list.
A separate garbage collection process can be used to eventually purge tombstones \cite{Roh:2011dw}, but we do not consider tombstone removal here.›</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> insert

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert_body</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'id</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> elt list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> elt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> elt list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_body</span> <span class="main">[]</span>     <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_body</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> fst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> fst <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span>
        <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span>
      <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free">insert_body</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'id</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> elt list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> elt <span class="main">⇒</span> <span class="tfree">'id</span> option <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> elt list option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>     <span class="free"><span class="bound"><span class="entity">e</span></span></span> None     <span class="main">=</span> Some <span class="main">(</span>insert_body <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="main">[]</span>     <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> fst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span>
        Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span>insert_body <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span>
        <span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">delete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'id</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> elt list <span class="main">⇒</span> <span class="tfree">'id</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> elt list option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">delete</span> <span class="main">[]</span>                 <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> None"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">delete</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span>
        Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> True<span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span>
        <span class="free">delete</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">flag</span></span></span><span class="main">)</span><span class="main">#</span><span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Well-definedness of insert and delete›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_no_failure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> None <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> <span class="free">i</span> <span class="main">=</span> Some <span class="bound">i'</span> <span class="main">∧</span> <span class="bound">i'</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs'</span><span class="main">.</span> insert <span class="free">xs</span> <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> Some <span class="bound">xs'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> insert.induct<span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_None_index_neq_None <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">xs</span> <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> None"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> insert_Some_None_index_not_in <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">xs</span> <span class="free">e</span> <span class="main">(</span>Some <span class="free">i</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm bind_splits<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> index_not_in_insert_Some_None <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"insert <span class="free">xs</span> <span class="free">e</span> <span class="main">(</span>Some <span class="free">i</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> delete_no_failure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs'</span><span class="main">.</span> delete <span class="free">xs</span> <span class="free">i</span> <span class="main">=</span> Some <span class="bound">xs'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> delete_None_index_not_in <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"delete <span class="free">xs</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm bind_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fst_eq_Domain<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> index_not_in_delete_None <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"delete <span class="free">xs</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Preservation of element indices›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_body_preserve_indices <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="main">(</span>insert_body <span class="free">xs</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">`</span> set <span class="free">xs</span> <span class="main">∪</span> <span class="main">{</span>fst <span class="free">e</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_preserve_indices<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> insert <span class="free">xs</span> <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> Some <span class="bound">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="main">(</span>the <span class="main">(</span>insert <span class="free">xs</span> <span class="free">e</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">`</span> set <span class="free">xs</span> <span class="main">∪</span> <span class="main">{</span>fst <span class="free">e</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_commute <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bind_splits<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> insert_preserve_indices'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">xs</span> <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> Some <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="main">(</span>the <span class="main">(</span>insert <span class="free">xs</span> <span class="free">e</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">`</span> set <span class="free">xs</span> <span class="main">∪</span> <span class="main">{</span>fst <span class="free">e</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms insert_preserve_indices <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> delete_preserve_indices<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"delete <span class="free">xs</span> <span class="free">i</span> <span class="main">=</span> Some <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="free">xs</span> <span class="main">=</span> fst <span class="main">`</span> set <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm bind_splits<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Commutativity of concurrent operations›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_body_commutes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">e1</span> <span class="main">≠</span> fst <span class="free">e2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"insert_body <span class="main">(</span>insert_body <span class="free">xs</span> <span class="free">e1</span><span class="main">)</span> <span class="free">e2</span> <span class="main">=</span> insert_body <span class="main">(</span>insert_body <span class="free">xs</span> <span class="free">e2</span><span class="main">)</span> <span class="free">e1</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_insert_body<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">e1</span> <span class="main">≠</span> fst <span class="free">e2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i2</span> <span class="main">≠</span> Some <span class="main">(</span>fst <span class="free">e1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"insert <span class="main">(</span>insert_body <span class="free">xs</span> <span class="free">e1</span><span class="main">)</span> <span class="free">e2</span> <span class="free">i2</span> <span class="main">=</span> insert <span class="free">xs</span> <span class="free">e2</span> <span class="free">i2</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> Some <span class="main">(</span>insert_body <span class="bound">ys</span> <span class="free">e1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">i2</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_body_commutes<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_Nil_None<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">e1</span> <span class="main">≠</span> fst <span class="free">e2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> fst <span class="free">e2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i2</span> <span class="main">≠</span> Some <span class="main">(</span>fst <span class="free">e1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"insert <span class="main">[]</span> <span class="free">e2</span> <span class="free">i2</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> insert <span class="bound">ys</span> <span class="free">e1</span> <span class="main">(</span>Some <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i2</span>"</span></span><span class="main">)</span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_insert_body_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> fst <span class="free">e1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">e1</span> <span class="main">≠</span> fst <span class="free">e2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"insert <span class="main">(</span>insert_body <span class="free">xs</span> <span class="free">e1</span><span class="main">)</span> <span class="free">e2</span> <span class="main">(</span>Some <span class="free">i</span><span class="main">)</span> <span class="main">=</span>
             insert <span class="free">xs</span> <span class="free">e2</span> <span class="main">(</span>Some <span class="free">i</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> Some <span class="main">(</span>insert_body <span class="bound">y</span> <span class="free">e1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_body_commutes<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_commutes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">e1</span> <span class="main">≠</span> fst <span class="free">e2</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">i1</span> <span class="main">≠</span> Some <span class="main">(</span>fst <span class="free">e2</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">i2</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">i2</span> <span class="main">≠</span> Some <span class="main">(</span>fst <span class="free">e1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"insert <span class="free">xs</span> <span class="free">e1</span> <span class="free">i1</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> insert <span class="bound">ys</span> <span class="free">e2</span> <span class="free">i2</span><span class="main">)</span> <span class="main">=</span>
           insert <span class="free">xs</span> <span class="free">e2</span> <span class="free">i2</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> insert <span class="bound">ys</span> <span class="free">e1</span> <span class="free">i1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> insert.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> elt"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i2</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">i2</span> <span class="main">≠</span> Some <span class="main">(</span>fst <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">e</span> <span class="main">≠</span> fst <span class="free">e2</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">xs</span> <span class="skolem">e</span> None <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> insert <span class="bound">ys</span> <span class="free">e2</span> <span class="free">i2</span><span class="main">)</span> <span class="main">=</span> insert <span class="skolem">xs</span> <span class="free">e2</span> <span class="free">i2</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> insert <span class="bound">ys</span> <span class="skolem">e</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_body_commutes <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> insert_insert_body<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> elt"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">e</span> <span class="main">≠</span> fst <span class="free">e2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i2</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">i2</span> <span class="main">≠</span> Some <span class="main">(</span>fst <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Some <span class="skolem">i</span> <span class="main">=</span> None <span class="main">∨</span> Some <span class="skolem">i</span> <span class="main">≠</span> Some <span class="main">(</span>fst <span class="free">e2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"insert <span class="main">[]</span> <span class="skolem">e</span> <span class="main">(</span>Some <span class="skolem">i</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> insert <span class="bound">ys</span> <span class="free">e2</span> <span class="free">i2</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">[]</span> <span class="free">e2</span> <span class="free">i2</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> insert <span class="bound">ys</span> <span class="skolem">e</span> <span class="main">(</span>Some <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> insert_Nil_None<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">i</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> elt"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">i</span> <span class="main">⟹</span>
               fst <span class="skolem">e</span> <span class="main">≠</span> fst <span class="free">e2</span> <span class="main">⟹</span>
               Some <span class="skolem">i</span> <span class="main">=</span> None <span class="main">∨</span> Some <span class="skolem">i</span> <span class="main">≠</span> Some <span class="main">(</span>fst <span class="free">e2</span><span class="main">)</span> <span class="main">⟹</span>
               <span class="free">i2</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">i2</span> <span class="main">≠</span> Some <span class="main">(</span>fst <span class="skolem">e</span><span class="main">)</span> <span class="main">⟹</span>
               insert <span class="skolem">xs</span> <span class="skolem">e</span> <span class="main">(</span>Some <span class="skolem">i</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> insert <span class="bound">ys</span> <span class="free">e2</span> <span class="free">i2</span><span class="main">)</span> <span class="main">=</span> insert <span class="skolem">xs</span> <span class="free">e2</span> <span class="free">i2</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> insert <span class="bound">ys</span> <span class="skolem">e</span> <span class="main">(</span>Some <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">e</span> <span class="main">≠</span> fst <span class="free">e2</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Some <span class="skolem">i</span> <span class="main">=</span> None <span class="main">∨</span> Some <span class="skolem">i</span> <span class="main">≠</span> Some <span class="main">(</span>fst <span class="free">e2</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i2</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">i2</span> <span class="main">≠</span> Some <span class="main">(</span>fst <span class="skolem">e</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">e</span> <span class="main">(</span>Some <span class="skolem">i</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> insert <span class="bound">ys</span> <span class="free">e2</span> <span class="free">i2</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">e2</span> <span class="free">i2</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> insert <span class="bound">ys</span> <span class="skolem">e</span> <span class="main">(</span>Some <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">i2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_body_commutes insert_insert_body_commute<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">i2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> Option.bind_cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_insert_body <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bind_splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> delete_commutes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"delete <span class="free">xs</span> <span class="free">i1</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> delete <span class="bound">ys</span> <span class="free">i2</span><span class="main">)</span> <span class="main">=</span> delete <span class="free">xs</span> <span class="free">i2</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> delete <span class="bound">ys</span> <span class="free">i1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bind_splits if_split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_body_delete_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i2</span> <span class="main">≠</span> fst <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"delete <span class="main">(</span>insert_body <span class="free">xs</span> <span class="free">e</span><span class="main">)</span> <span class="free">i2</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> Some <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            delete <span class="free">xs</span> <span class="free">i2</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> Some <span class="main">(</span><span class="free">x</span><span class="main">#</span>insert_body <span class="bound">y</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bind_splits if_split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_delete_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i2</span> <span class="main">≠</span> fst <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"insert <span class="free">xs</span> <span class="free">e</span> <span class="free">i1</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> delete <span class="bound">ys</span> <span class="free">i2</span><span class="main">)</span> <span class="main">=</span> delete <span class="free">xs</span> <span class="free">i2</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> insert <span class="bound">ys</span> <span class="free">e</span> <span class="free">i1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">i1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bind_splits if_split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_body_delete_commute<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Alternative definition of insert›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'id</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> elt list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> elt <span class="main">⇒</span> <span class="tfree">'id</span> option <span class="main">⇀</span> <span class="main">(</span><span class="tfree">'id</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> elt list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert'</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>     None     <span class="main">=</span> Some <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">insert'</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>     <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">insert'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> None     <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> fst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> fst <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span>
        Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span>
        <span class="keyword1">case</span> <span class="free">insert'</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> None <span class="keyword1">of</span>
          None   <span class="main">⇒</span> None
        <span class="main">|</span> Some <span class="bound">t</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">insert'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> fst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span>
        <span class="keyword1">case</span> <span class="free">insert'</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> None <span class="keyword1">of</span>
          None   <span class="main">⇒</span> None
        <span class="main">|</span> Some <span class="bound">t</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="bound">t</span><span class="main">)</span>
      <span class="keyword1">else</span>
        <span class="keyword1">case</span> <span class="free">insert'</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
          None   <span class="main">⇒</span> None
        <span class="main">|</span> Some <span class="bound">t</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert' <span class="free">xs</span> <span class="free">e</span> None <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"False"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm option.split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_body_insert'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert' <span class="free">xs</span> <span class="free">e</span> None <span class="main">=</span> Some <span class="main">(</span>insert_body <span class="free">xs</span> <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_insert'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">xs</span> <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> insert' <span class="free">xs</span> <span class="free">e</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_body_insert'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_body_stop_iteration<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">e</span> <span class="main">&gt;</span> fst <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_body <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="free">e</span><span class="main">#</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_body_contains_new_elem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span> <span class="bound">s</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">@</span> <span class="bound">s</span> <span class="main">∧</span> insert_body <span class="free">xs</span> <span class="free">e</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">@</span> <span class="free">e</span> <span class="main">#</span> <span class="bound">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">@</span> <span class="skolem">s</span> <span class="main">∧</span> insert_body <span class="skolem">xs</span> <span class="free">e</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">@</span> <span class="free">e</span> <span class="main">#</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">#</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_between_elements<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">pre</span><span class="main">@</span><span class="free">ref</span><span class="main">#</span><span class="free">suf</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i'</span><span class="main">.</span> <span class="bound">i'</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">i'</span> <span class="main">&lt;</span> fst <span class="free">e</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">xs</span> <span class="free">e</span> <span class="main">(</span>Some <span class="main">(</span>fst <span class="free">ref</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="free">ref</span> <span class="main">#</span> <span class="free">e</span> <span class="main">#</span> <span class="free">suf</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">pre</span></span> <span class="quoted"><span class="free">ref</span></span> <span class="quoted"><span class="free">suf</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">pre</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">suf</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_position_element_technical<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">as</span><span class="main">.</span> <span class="free">a</span> <span class="main">≠</span> fst <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_body <span class="main">(</span><span class="free">cs</span> <span class="main">@</span> <span class="free">ds</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="free">cs</span> <span class="main">@</span> <span class="free">e</span> <span class="main">#</span> <span class="free">ds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">aa</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">#</span> <span class="free">cs</span> <span class="main">@</span> <span class="free">ds</span><span class="main">)</span> <span class="free">e</span> <span class="main">(</span>Some <span class="free">a</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">aa</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">#</span> <span class="free">cs</span> <span class="main">@</span> <span class="free">e</span> <span class="main">#</span> <span class="free">ds</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">ds</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> split_tuple_list_by_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">pre</span> <span class="bound">suf</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">pre</span> <span class="main">@</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">#</span> <span class="bound">suf</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="bound">pre</span><span class="main">.</span> fst <span class="bound">y</span> <span class="main">≠</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">suf</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">pre</span> <span class="main">@</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">suf</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="skolem">pre</span><span class="main">.</span> fst <span class="bound">y</span> <span class="main">≠</span> <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">#</span><span class="skolem">pre</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_preserves_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> None <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> <span class="free">i</span> <span class="main">=</span> Some <span class="bound">i'</span> <span class="main">∧</span> <span class="bound">i'</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">pre</span> <span class="bound">suf</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">pre</span><span class="main">@</span><span class="bound">suf</span> <span class="main">∧</span> insert <span class="free">xs</span> <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">pre</span> <span class="main">@</span> <span class="free">e</span> <span class="main">#</span> <span class="bound">suf</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">metis</span> insert_body_contains_new_elem<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> <span class="free">i</span> <span class="main">=</span> Some <span class="bound">i'</span> <span class="main">∧</span> <span class="bound">i'</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">v</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">as</span><span class="main">@</span><span class="main">(</span><span class="skolem">j</span><span class="main">,</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span><span class="main">#</span><span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">as</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> split_tuple_list_by_id<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"insert_body <span class="skolem">bs</span> <span class="free">e</span> <span class="main">=</span> <span class="skolem">cs</span><span class="main">@</span><span class="free">e</span><span class="main">#</span><span class="skolem">ds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span><span class="main">@</span><span class="skolem">ds</span> <span class="main">=</span> <span class="skolem">bs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> insert_body_contains_new_elem<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">as</span><span class="main">@</span><span class="main">(</span><span class="skolem">j</span><span class="main">,</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span><span class="main">#</span><span class="skolem">cs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span><span class="main">(</span><span class="operator">metis</span> insert_position_element_technical<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="RGA">
<div class="head">
<h1>Theory RGA</h1>
</div>
<pre class="source"><span class="comment1">(* Victor B. F. Gomes, University of Cambridge
   Martin Kleppmann, University of Cambridge
   Dominic P. Mulligan, University of Cambridge
   Alastair R. Beresford, University of Cambridge
*)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Network›</span></span>

<span class="keyword1"><span class="command">theory</span></span>
  RGA
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Network.html">Network</a>
  <a href="Ordered_List.html">Ordered_List</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> operation <span class="main">=</span>
  Insert <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> elt"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'id</span> option"</span></span> <span class="main">|</span>
  Delete <span class="quoted"><span class="quoted">"<span class="tfree">'id</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">interpret_opers</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'id</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> operation <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> elt list <span class="main">⇀</span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> elt list"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">⟩</span>"</span> <span class="main">[</span>0<span class="main">]</span> 1000<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">interpret_opers</span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>  <span class="main">=</span> insert <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">interpret_opers</span> <span class="main">(</span>Delete <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>   <span class="free"><span class="bound"><span class="entity">xs</span></span></span>  <span class="main">=</span> delete <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">element_ids</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> elt list <span class="main">⇒</span> <span class="tfree">'id</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">element_ids</span> <span class="free"><span class="bound"><span class="entity">list</span></span></span> <span class="main">≡</span> set <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">list</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valid_rga_msg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> elt list <span class="main">⇒</span> <span class="tfree">'id</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'id</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> operation <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">valid_rga_msg</span> <span class="free"><span class="bound"><span class="entity">list</span></span></span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Insert <span class="bound">e</span>  None     <span class="main">)</span> <span class="main">⇒</span> fst <span class="bound">e</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">|</span>
    <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Insert <span class="bound">e</span> <span class="main">(</span>Some <span class="bound">pos</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> fst <span class="bound">e</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">pos</span> <span class="main">∈</span> element_ids <span class="free"><span class="bound"><span class="entity">list</span></span></span> <span class="main">|</span>
    <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Delete         <span class="bound">pos</span> <span class="main">)</span> <span class="main">⇒</span> <span class="bound">pos</span> <span class="main">∈</span> element_ids <span class="free"><span class="bound"><span class="entity">list</span></span></span>"</span></span>

<span class="comment1">(* Replicated Growable Array Network *)</span>
<span class="keyword1"><span class="command">locale</span></span> rga <span class="main">=</span> network_with_constrained_ops _ <span class="quoted">interpret_opers</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted">valid_rga_msg</span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">indices</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'id</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> operation<span class="main">)</span> event list <span class="main">⇒</span> <span class="tfree">'id</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">indices</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span>
     List.map_filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Deliver <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Insert <span class="bound">e</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span>fst <span class="bound">e</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> indices_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"indices <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indices_def map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> indices_append <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"indices <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span> <span class="main">=</span> indices <span class="free">xs</span> <span class="main">@</span> indices <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indices_def map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> indices_Broadcast_singleton <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"indices <span class="main">[</span>Broadcast <span class="free">b</span><span class="main">]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indices_def map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> indices_Deliver_Insert <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"indices <span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">n</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span>fst <span class="free">e</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indices_def map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> indices_Deliver_Delete <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"indices <span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Delete <span class="free">n</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indices_def map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> idx_in_elem_inserted <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fst <span class="free">e</span> <span class="main">∈</span> set <span class="main">(</span>indices <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indices_def map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> apply_opers_idx_elems<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="free">es</span> <span class="main">=</span> Some <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"element_ids <span class="free">xs</span> <span class="main">=</span> set <span class="main">(</span>indices <span class="free">es</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> element_ids_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Deliver <span class="skolem">e</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bind_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_msg_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Un_insert_right append.right_neutral insert_preserve_indices' list.set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
              option.sel prefix_of_appendD prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_append<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> delete_preserve_indices prefix_of_appendD<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> delete_does_not_change_element_ids<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="main">@</span> <span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Delete <span class="free">n</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="free">es</span> <span class="main">=</span> Some <span class="free">xs1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="main">(</span><span class="free">es</span> <span class="main">@</span> <span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Delete <span class="free">n</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">xs2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"element_ids <span class="free">xs1</span> <span class="main">=</span> element_ids <span class="free">xs2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"indices <span class="free">es</span> <span class="main">=</span> indices <span class="main">(</span><span class="free">es</span> <span class="main">@</span> <span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Delete <span class="free">n</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> assms prefix_of_appendD rga.apply_opers_idx_elems rga_axioms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> someone_inserted_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="main">@</span> <span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="free">es</span> <span class="main">=</span> Some <span class="free">xs1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="main">(</span><span class="free">es</span> <span class="main">@</span> <span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">xs2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> element_ids <span class="free">xs2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> element_ids <span class="free">xs1</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms apply_opers_idx_elems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> deliver_insert_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="free">es</span> <span class="main">=</span> Some <span class="free">xs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> element_ids <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="bound">v</span> <span class="bound">f</span> <span class="bound">n</span><span class="main">.</span> Deliver <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Insert <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="bound">v</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">es</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> element_ids_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Broadcast <span class="skolem">e</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> image_eqI prefix_of_appendD prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Deliver <span class="skolem">e</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"apply_operations <span class="skolem">xs</span> <span class="main">=</span> Some <span class="skolem">xs'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms snoc <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Insert <span class="skolem">el</span> _<span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> snoc Deliver * **
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">el</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">el</span> <span class="main">=</span> <span class="free">a</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> element_ids_def prefix_of_appendD set_map snoc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
                      snoc.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> someone_inserted_id<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Delete _<span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> snoc Deliver ** <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> prefix_of_appendD<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv interp_msg_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> delete_preserve_indices image_eqI prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>    
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> insert_in_apply_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="main">@</span> <span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="main">(</span>Some <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i'</span><span class="main">,</span> Insert <span class="free">e'</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">es</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="free">es</span> <span class="main">=</span> Some <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">e'</span> <span class="main">∈</span> element_ids <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms apply_opers_idx_elems idx_in_elem_inserted prefix_of_appendD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> insert_msg_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">e</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">state</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_rga_msg <span class="skolem">state</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms broadcast_is_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">e</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_rga_msg_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> allowed_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> None <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span> <span class="bound">e'</span> <span class="bound">n'</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> Some <span class="main">(</span>fst <span class="bound">e'</span><span class="main">)</span> <span class="main">∧</span> Deliver <span class="main">(</span><span class="bound">i'</span><span class="main">,</span> Insert <span class="bound">e'</span> <span class="bound">n'</span><span class="main">)</span> <span class="main">⊏⇧</span><span class="free">j</span> Broadcast <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span> <span class="main">@</span> <span class="main">[</span>Broadcast <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">n</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms events_before_exist <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">state</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"apply_operations <span class="skolem">pre</span> <span class="main">=</span> Some <span class="skolem">state</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_rga_msg <span class="skolem">state</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> broadcast_only_valid_msgs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> None <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span> <span class="bound">e'</span> <span class="bound">n'</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> Some <span class="main">(</span>fst <span class="bound">e'</span><span class="main">)</span> <span class="main">∧</span> Deliver <span class="main">(</span><span class="bound">i'</span><span class="main">,</span> Insert <span class="bound">e'</span> <span class="bound">n'</span><span class="main">)</span> <span class="main">⊏⇧</span><span class="free">j</span> Broadcast <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">assume</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> Some <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> element_ids <span class="skolem">state</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="free">e</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_rga_msg_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i'</span> <span class="bound">v'</span> <span class="bound">f'</span> <span class="bound">n'</span><span class="main">.</span> Deliver <span class="main">(</span><span class="bound">i'</span><span class="main">,</span> Insert <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="bound">v'</span><span class="main">,</span> <span class="bound">f'</span><span class="main">)</span> <span class="bound">n'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> deliver_insert_exists 2 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> None <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span> <span class="bound">e'</span> <span class="bound">n'</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> Some <span class="main">(</span>fst <span class="bound">e'</span><span class="main">)</span> <span class="main">∧</span> Deliver <span class="main">(</span><span class="bound">i'</span><span class="main">,</span> Insert <span class="bound">e'</span> <span class="bound">n'</span><span class="main">)</span> <span class="main">⊏⇧</span><span class="free">j</span> Broadcast <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> events_in_local_order 1 4 5 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> fst_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> allowed_delete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="main">(</span><span class="free">i</span><span class="main">,</span> Delete <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i'</span> <span class="bound">n'</span> <span class="bound">v</span> <span class="bound">b</span><span class="main">.</span> Deliver <span class="main">(</span><span class="bound">i'</span><span class="main">,</span> Insert <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">n'</span><span class="main">)</span> <span class="main">⊏⇧</span><span class="free">j</span> Broadcast <span class="main">(</span><span class="free">i</span><span class="main">,</span> Delete <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span> <span class="main">@</span> <span class="main">[</span>Broadcast <span class="main">(</span><span class="free">i</span><span class="main">,</span> Delete <span class="free">x</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms events_before_exist <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">state</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"apply_operations <span class="skolem">pre</span> <span class="main">=</span> Some <span class="skolem">state</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"valid_rga_msg <span class="skolem">state</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> Delete <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> broadcast_only_valid_msgs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> element_ids <span class="skolem">state</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> apply_opers_idx_elems <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_rga_msg_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i'</span> <span class="bound">v'</span> <span class="bound">f'</span> <span class="bound">n'</span><span class="main">.</span> Deliver <span class="main">(</span><span class="bound">i'</span><span class="main">,</span> Insert <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">v'</span><span class="main">,</span> <span class="bound">f'</span><span class="main">)</span> <span class="bound">n'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> deliver_insert_exists 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i'</span> <span class="bound">n'</span> <span class="bound">v</span> <span class="bound">b</span><span class="main">.</span> Deliver <span class="main">(</span><span class="bound">i'</span><span class="main">,</span> Insert <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">n'</span><span class="main">)</span> <span class="main">⊏⇧</span><span class="free">j</span> Broadcast <span class="main">(</span><span class="free">i</span><span class="main">,</span> Delete <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> events_in_local_order 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> insert_id_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">e1</span> <span class="main">=</span> fst <span class="free">e2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="main">(</span><span class="free">i1</span><span class="main">,</span> Insert <span class="free">e1</span> <span class="free">n1</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="main">(</span><span class="free">i2</span><span class="main">,</span> Insert <span class="free">e2</span> <span class="free">n2</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Insert <span class="free">e1</span> <span class="free">n1</span> <span class="main">=</span> Insert <span class="free">e2</span> <span class="free">n2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms insert_msg_id msg_id_unique Pair_inject fst_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> allowed_delete_deliver<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Delete <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i'</span> <span class="bound">n'</span> <span class="bound">v</span> <span class="bound">b</span><span class="main">.</span> Deliver <span class="main">(</span><span class="bound">i'</span><span class="main">,</span> Insert <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">n'</span><span class="main">)</span> <span class="main">⊏⇧</span><span class="free">j</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Delete <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> allowed_delete bot_least causal_broadcast delivery_has_a_cause insert_subset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> allowed_delete_deliver_in_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">es</span><span class="main">@</span><span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Delete <span class="free">m</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i'</span> <span class="bound">n</span> <span class="bound">v</span> <span class="bound">b</span><span class="main">.</span> Deliver <span class="main">(</span><span class="bound">i'</span><span class="main">,</span> Insert <span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="bound">v</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">es</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Un_insert_right insert_iff list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> assms
    local_order_prefix_closed_last rga.allowed_delete_deliver rga_axioms set_append subsetCE prefix_to_carriers<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> allowed_insert_deliver<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> None <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span> <span class="bound">n'</span> <span class="bound">n''</span> <span class="bound">v</span> <span class="bound">b</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> Some <span class="bound">n'</span> <span class="main">∧</span> Deliver <span class="main">(</span><span class="bound">i'</span><span class="main">,</span> Insert <span class="main">(</span><span class="bound">n'</span><span class="main">,</span> <span class="bound">v</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">n''</span><span class="main">)</span> <span class="main">⊏⇧</span><span class="free">j</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ja</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Broadcast <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">ja</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delivery_has_a_cause <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> None <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span> <span class="bound">n'</span> <span class="bound">n''</span> <span class="bound">v</span> <span class="bound">b</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> Some <span class="bound">n'</span> <span class="main">∧</span> Deliver <span class="main">(</span><span class="bound">i'</span><span class="main">,</span> Insert <span class="main">(</span><span class="bound">n'</span><span class="main">,</span> <span class="bound">v</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">n''</span><span class="main">)</span> <span class="main">⊏⇧</span><span class="free">j</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">assume</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> Some <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="skolem">a</span> <span class="main">=</span> Some <span class="main">(</span>fst <span class="skolem">e'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        2<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="skolem">i'</span><span class="main">,</span> Insert <span class="skolem">e'</span> <span class="skolem">n'</span><span class="main">)</span> <span class="main">⊏⇧</span><span class="skolem">ja</span> Broadcast <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> allowed_insert 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="skolem">i'</span><span class="main">,</span> Insert <span class="skolem">e'</span> <span class="skolem">n'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">ja</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">ja</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> local_order_carrier_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">jaa</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">jaa</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> delivery_has_a_cause <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i'</span> <span class="bound">n'</span> <span class="bound">n''</span> <span class="bound">v</span> <span class="bound">b</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> Some <span class="bound">n'</span> <span class="main">∧</span> Deliver <span class="main">(</span><span class="bound">i'</span><span class="main">,</span> Insert <span class="main">(</span><span class="bound">n'</span><span class="main">,</span> <span class="bound">v</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">n''</span><span class="main">)</span> <span class="main">⊏⇧</span><span class="free">j</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 3 4 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> assms causal_broadcast prod.collapse<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> None <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span> <span class="bound">n'</span> <span class="bound">n''</span> <span class="bound">v</span> <span class="bound">b</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> Some <span class="bound">n'</span> <span class="main">∧</span> Deliver <span class="main">(</span><span class="bound">i'</span><span class="main">,</span> Insert <span class="main">(</span><span class="bound">n'</span><span class="main">,</span> <span class="bound">v</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">n''</span><span class="main">)</span> <span class="main">⊏⇧</span><span class="free">j</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> allowed_insert_deliver_in_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">es</span><span class="main">@</span><span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">m</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> None <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span> <span class="bound">m'</span> <span class="bound">n</span> <span class="bound">v</span> <span class="bound">b</span><span class="main">.</span> <span class="free">m</span> <span class="main">=</span> Some <span class="bound">m'</span> <span class="main">∧</span> Deliver <span class="main">(</span><span class="bound">i'</span><span class="main">,</span> Insert <span class="main">(</span><span class="bound">m'</span><span class="main">,</span> <span class="bound">v</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">es</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> assms Un_insert_right insert_subset list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> set_append prefix_to_carriers
    allowed_insert_deliver local_order_prefix_closed_last<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> Insert_no_failure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="main">@</span> <span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">n</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="free">es</span> <span class="main">=</span> Some <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> insert <span class="free">s</span> <span class="free">e</span> <span class="free">n</span> <span class="main">=</span> Some <span class="bound">ys</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> element_ids_def allowed_insert_deliver_in_set assms fst_conv
    insert_in_apply_set insert_no_failure set_map<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> delete_no_failure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="main">@</span> <span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Delete <span class="free">n</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="free">es</span> <span class="main">=</span> Some <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> delete <span class="free">s</span> <span class="free">n</span> <span class="main">=</span> Some <span class="bound">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">na</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="skolem">i'</span><span class="main">,</span> Insert <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="skolem">v</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="skolem">na</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">es</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms allowed_delete_deliver_in_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="skolem">v</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>indices <span class="free">es</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms idx_in_elem_inserted calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this assms <span class="keyword2"><span class="keyword">and</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> delete <span class="free">s</span> <span class="free">n</span> <span class="main">=</span> Some <span class="bound">ys</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> delete_no_failure<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> apply_opers_idx_elems element_ids_def prefix_of_appendD prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_map<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> Insert_equal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">e1</span> <span class="main">=</span> fst <span class="free">e2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="main">(</span><span class="free">i1</span><span class="main">,</span> Insert <span class="free">e1</span> <span class="free">n1</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="main">(</span><span class="free">i2</span><span class="main">,</span> Insert <span class="free">e2</span> <span class="free">n2</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Insert <span class="free">e1</span> <span class="free">n1</span> <span class="main">=</span> Insert <span class="free">e2</span> <span class="free">n2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> insert_id_unique assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> same_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">e1</span> <span class="main">=</span> fst <span class="free">e2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i1</span><span class="main">,</span> Insert <span class="free">e1</span> <span class="free">n1</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i2</span><span class="main">,</span> Insert <span class="free">e2</span> <span class="free">n2</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Insert <span class="free">e1</span> <span class="free">n1</span> <span class="main">=</span> Insert <span class="free">e2</span> <span class="free">n2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i1</span><span class="main">,</span> Insert <span class="free">e1</span> <span class="free">n1</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_deliver_messages_def prefix_msg_in_history<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Broadcast <span class="main">(</span><span class="free">i1</span><span class="main">,</span> Insert <span class="free">e1</span> <span class="free">n1</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> delivery_has_a_cause <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i2</span><span class="main">,</span> Insert <span class="free">e2</span> <span class="free">n2</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_deliver_messages_def prefix_msg_in_history<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"Broadcast <span class="main">(</span><span class="free">i2</span><span class="main">,</span> Insert <span class="free">e2</span> <span class="free">n2</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> delivery_has_a_cause <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Insert <span class="free">e1</span> <span class="free">n1</span> <span class="main">=</span> Insert <span class="free">e2</span> <span class="free">n2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> Insert_equal<span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> 1 2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> insert_commute_assms<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">n</span><span class="main">)</span><span class="main">,</span> Deliver <span class="main">(</span><span class="free">i'</span><span class="main">,</span> Insert <span class="free">e'</span> <span class="free">n'</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hb.concurrent <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">i'</span><span class="main">,</span> Insert <span class="free">e'</span> <span class="free">n'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">n</span> <span class="main">≠</span> Some <span class="main">(</span>fst <span class="free">e'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hb.concurrent_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e'</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> delivery_has_a_cause<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> delivery_has_a_cause<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> allowed_insert<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> Insert_equal delivery_has_a_cause fst_conv hb.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> insert_subset
    local_order_carrier_closed insert_msg_id<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> subset_reorder<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">b</span><span class="main">,</span> <span class="free">a</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> Insert_Insert_concurrent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">k</span><span class="main">)</span><span class="main">,</span> Deliver <span class="main">(</span><span class="free">i'</span><span class="main">,</span> Insert <span class="free">e'</span> <span class="main">(</span>Some <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hb.concurrent <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">i'</span><span class="main">,</span> Insert <span class="free">e'</span> <span class="main">(</span>Some <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">e</span> <span class="main">≠</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> assms subset_reorder hb.concurrent_comm insert_commute_assms option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> insert_valid_assms<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">n</span> <span class="main">≠</span> Some <span class="main">(</span>fst <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">meson</span> allowed_insert_deliver hb.concurrent_def hb.less_asym insert_subset
      local_order_carrier_closed rga.insert_commute_assms rga_axioms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> Insert_Delete_concurrent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">n</span><span class="main">)</span><span class="main">,</span> Deliver <span class="main">(</span><span class="free">i'</span><span class="main">,</span> Delete <span class="free">n'</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hb.concurrent <span class="main">(</span><span class="free">i</span><span class="main">,</span> Insert <span class="free">e</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">i'</span><span class="main">,</span> Delete <span class="free">n'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n'</span> <span class="main">≠</span> fst <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms Insert_equal allowed_delete delivery_has_a_cause fst_conv hb.concurrent_def
  hb.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> insert_subset local_order_carrier_closed rga.insert_msg_id rga_axioms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> concurrent_operations_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hb.concurrent_ops_commute <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">}</span> <span class="main">⊆</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> hb.concurrent <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> interp_msg <span class="bound">x</span> <span class="main">⊳</span> interp_msg <span class="bound">y</span> <span class="main">=</span> interp_msg <span class="bound">y</span> <span class="main">⊳</span> interp_msg <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">ii</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">}</span> <span class="main">⊆</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"hb.concurrent <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x1</span></span> <span class="skolem"><span class="skolem">x2</span></span> <span class="skolem"><span class="skolem">y1</span></span> <span class="skolem"><span class="skolem">y2</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> <span class="skolem">y2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>interp_msg <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span> <span class="main">⊳</span> interp_msg <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> <span class="skolem">y2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ii</span> <span class="main">=</span> <span class="main">(</span>interp_msg <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> <span class="skolem">y2</span><span class="main">)</span> <span class="main">⊳</span> interp_msg <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ii</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y2</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ix1</span> <span class="skolem">ix2</span> <span class="skolem">iy1</span> <span class="skolem">iy2</span>
      <span class="keyword3"><span class="command">assume</span></span> X2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x2</span> <span class="main">=</span> Insert <span class="skolem">ix1</span> <span class="skolem">ix2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Y2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y2</span> <span class="main">=</span> Insert <span class="skolem">iy1</span> <span class="skolem">iy2</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>interp_msg <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span> <span class="main">⊳</span> interp_msg <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> <span class="skolem">y2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ii</span> <span class="main">=</span> <span class="main">(</span>interp_msg <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> <span class="skolem">y2</span><span class="main">)</span> <span class="main">⊳</span> interp_msg <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ii</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">ix1</span> <span class="main">=</span> fst <span class="skolem">iy1</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">ix1</span> <span class="main">=</span> fst <span class="skolem">iy1</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Insert <span class="skolem">ix1</span> <span class="skolem">ix2</span> <span class="main">=</span> Insert <span class="skolem">iy1</span> <span class="skolem">iy2</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> same_insert<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> 1 2 X Y X2 Y2 assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ix1</span> <span class="main">=</span> <span class="skolem">iy1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ix2</span> <span class="main">=</span> <span class="skolem">iy2</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> X2 Y2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>interp_msg <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span> <span class="main">⊳</span> interp_msg <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> <span class="skolem">y2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ii</span> <span class="main">=</span> <span class="main">(</span>interp_msg <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> <span class="skolem">y2</span><span class="main">)</span> <span class="main">⊳</span> interp_msg <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ii</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kleisli_def interp_msg_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> NEQ<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">ix1</span> <span class="main">≠</span> fst <span class="skolem">iy1</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ix2</span> <span class="main">=</span> None <span class="main">∨</span> <span class="skolem">ix2</span> <span class="main">≠</span> Some <span class="main">(</span>fst <span class="skolem">iy1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> insert_commute_assms<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> prefix_msg_in_history<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> X Y X2 Y2 1 2
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> C 1 2 X2 Y2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">iy2</span> <span class="main">=</span> None <span class="main">∨</span> <span class="skolem">iy2</span> <span class="main">≠</span> Some <span class="main">(</span>fst <span class="skolem">ix1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> insert_commute_assms<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> prefix_msg_in_history<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> X Y X2 Y2 1 2
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> <span class="quoted">"2"</span> C X2 Y2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">ii</span> <span class="skolem">ix1</span> <span class="skolem">ix2</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> insert <span class="bound">x</span> <span class="skolem">iy1</span> <span class="skolem">iy2</span><span class="main">)</span> <span class="main">=</span> insert <span class="skolem">ii</span> <span class="skolem">iy1</span> <span class="skolem">iy2</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> insert <span class="bound">x</span> <span class="skolem">ix1</span> <span class="skolem">ix2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> NEQ insert_commutes <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>interp_msg <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span> <span class="main">⊳</span> interp_msg <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> <span class="skolem">y2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ii</span> <span class="main">=</span> <span class="main">(</span>interp_msg <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> <span class="skolem">y2</span><span class="main">)</span> <span class="main">⊳</span> interp_msg <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ii</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_msg_def X2 Y2 kleisli_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ix1</span> <span class="skolem">ix2</span> <span class="skolem">yd</span>
      <span class="keyword3"><span class="command">assume</span></span> X2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x2</span> <span class="main">=</span> Insert <span class="skolem">ix1</span> <span class="skolem">ix2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Y2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y2</span> <span class="main">=</span> Delete <span class="skolem">yd</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hb.concurrent <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> Insert <span class="skolem">ix1</span> <span class="skolem">ix2</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> Delete <span class="skolem">yd</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> C X2 Y2 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Deliver <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> Insert <span class="skolem">ix1</span> <span class="skolem">ix2</span><span class="main">)</span><span class="main">,</span> Deliver <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> Delete <span class="skolem">yd</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prefix_msg_in_history assms X2 Y2 X Y 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yd</span> <span class="main">≠</span> fst <span class="skolem">ix1</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Insert_Delete_concurrent<span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">ii</span> <span class="skolem">ix1</span> <span class="skolem">ix2</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> delete <span class="bound">x</span> <span class="skolem">yd</span><span class="main">)</span> <span class="main">=</span> delete <span class="skolem">ii</span> <span class="skolem">yd</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> insert <span class="bound">x</span> <span class="skolem">ix1</span> <span class="skolem">ix2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> insert_delete_commute<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>interp_msg <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span> <span class="main">⊳</span> interp_msg <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> <span class="skolem">y2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ii</span> <span class="main">=</span> <span class="main">(</span>interp_msg <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> <span class="skolem">y2</span><span class="main">)</span> <span class="main">⊳</span> interp_msg <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ii</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_msg_def kleisli_def X2 Y2<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xd</span> <span class="skolem">iy1</span> <span class="skolem">iy2</span>
      <span class="keyword3"><span class="command">assume</span></span> X2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x2</span> <span class="main">=</span> Delete <span class="skolem">xd</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Y2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y2</span> <span class="main">=</span> Insert <span class="skolem">iy1</span> <span class="skolem">iy2</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hb.concurrent <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> Delete <span class="skolem">xd</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> Insert <span class="skolem">iy1</span> <span class="skolem">iy2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> C X2 Y2 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Deliver <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> Delete <span class="skolem">xd</span><span class="main">)</span><span class="main">,</span> Deliver <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> Insert <span class="skolem">iy1</span> <span class="skolem">iy2</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> set <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prefix_msg_in_history assms X2 Y2 X Y 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xd</span> <span class="main">≠</span> fst <span class="skolem">iy1</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Insert_Delete_concurrent<span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"delete <span class="skolem">ii</span> <span class="skolem">xd</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> insert <span class="bound">x</span> <span class="skolem">iy1</span> <span class="skolem">iy2</span><span class="main">)</span> <span class="main">=</span> insert <span class="skolem">ii</span> <span class="skolem">iy1</span> <span class="skolem">iy2</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> delete <span class="bound">x</span> <span class="skolem">xd</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> insert_delete_commute<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>interp_msg <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span> <span class="main">⊳</span> interp_msg <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> <span class="skolem">y2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ii</span> <span class="main">=</span> <span class="main">(</span>interp_msg <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> <span class="skolem">y2</span><span class="main">)</span> <span class="main">⊳</span> interp_msg <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ii</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_msg_def kleisli_def X2 Y2<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xd</span> <span class="skolem">yd</span>
      <span class="keyword3"><span class="command">assume</span></span> X2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x2</span> <span class="main">=</span> Delete <span class="skolem">xd</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Y2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y2</span> <span class="main">=</span> Delete <span class="skolem">yd</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"delete <span class="skolem">ii</span> <span class="skolem">xd</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> delete <span class="bound">x</span> <span class="skolem">yd</span><span class="main">)</span> <span class="main">=</span> delete <span class="skolem">ii</span> <span class="skolem">yd</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> delete <span class="bound">x</span> <span class="skolem">xd</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> delete_commutes<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>interp_msg <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span> <span class="main">⊳</span> interp_msg <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> <span class="skolem">y2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ii</span> <span class="main">=</span> <span class="main">(</span>interp_msg <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> <span class="skolem">y2</span><span class="main">)</span> <span class="main">⊳</span> interp_msg <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ii</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_msg_def kleisli_def X2 Y2<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>   
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>interp_msg <span class="skolem">x</span> <span class="main">⊳</span> interp_msg <span class="skolem">y</span><span class="main">)</span> <span class="skolem">ii</span> <span class="main">=</span> <span class="main">(</span>interp_msg <span class="skolem">y</span> <span class="main">⊳</span> interp_msg <span class="skolem">x</span><span class="main">)</span> <span class="skolem">ii</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"hb.concurrent_ops_commute <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hb.concurrent_ops_commute_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> concurrent_operations_commute'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hb.concurrent_ops_commute <span class="main">(</span>node_deliver_messages <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> concurrent_operations_commute append.right_neutral prefix_of_node_history_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> apply_operations_never_fails<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="free">xs</span> <span class="main">≠</span> None"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="main">[]</span> <span class="main">≠</span> None"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span> <span class="main">⟹</span> apply_operations <span class="skolem">xs</span> <span class="main">≠</span> None"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Broadcast <span class="skolem">b</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
    <span class="keyword3"><span class="command">assume</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Deliver <span class="skolem">d</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">d</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">assume</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Deliver <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> apply_operations <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span>Deliver <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">aa</span> <span class="skolem">aaa</span> <span class="skolem">ba</span> <span class="skolem">x12</span>
        <span class="keyword3"><span class="command">assume</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> Insert <span class="main">(</span><span class="skolem">aa</span><span class="main">,</span> <span class="skolem">aaa</span><span class="main">,</span> <span class="skolem">ba</span><span class="main">)</span> <span class="skolem">x12</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> apply_operations <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span>Deliver <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> Insert <span class="main">(</span><span class="skolem">aa</span><span class="main">,</span> <span class="skolem">aaa</span><span class="main">,</span> <span class="skolem">ba</span><span class="main">)</span> <span class="skolem">x12</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">y</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1 interp_msg_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_splits<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"1"</span> <span class="quoted">"3"</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rga.Insert_no_failure<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> rga_axioms<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> 4 5 6 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x2</span>
        <span class="keyword3"><span class="command">assume</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> Delete <span class="skolem">x2</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> apply_operations <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span>Deliver <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> Delete <span class="skolem">x2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">y</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_msg_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_splits<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1 3<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> delete_no_failure<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> 4 5 6 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> apply_operations_never_fails'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="main">(</span><span class="free">history</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">meson</span> apply_operations_never_fails append.right_neutral prefix_of_node_history_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rga<span class="main">)</span> rga_convergence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>node_deliver_messages <span class="free">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="free">xs</span> <span class="main">=</span> apply_operations <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_operations_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> hb.convergence_ext
      concurrent_operations_commute node_deliver_messages_distinct hb_consistent_prefix<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Strong eventual consistency›</span></span>
              
<span class="keyword1"><span class="command">context</span></span> rga <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> sec<span class="main">:</span> strong_eventual_consistency <span class="quoted">weak_hb</span> <span class="quoted">hb</span> <span class="quoted">interp_msg</span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ops</span><span class="main">.</span><span class="main">∃</span><span class="bound">xs</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="bound">i</span> <span class="main">∧</span> node_deliver_messages <span class="bound">xs</span> <span class="main">=</span> <span class="bound">ops</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xsa</span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xsa</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"hb.hb_consistent <span class="main">(</span>node_deliver_messages <span class="skolem">xsa</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hb_consistent_prefix<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xsa</span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xsa</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>node_deliver_messages <span class="skolem">xsa</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_deliver_messages_distinct<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xsa</span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xsa</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"hb.concurrent_ops_commute <span class="main">(</span>node_deliver_messages <span class="skolem">xsa</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> concurrent_operations_commute<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">state</span> <span class="skolem">xsa</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"hb.apply_operations <span class="skolem">xs</span> <span class="main">[]</span> <span class="main">=</span> Some <span class="skolem">state</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"node_deliver_messages <span class="skolem">xsa</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xsa</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> interp_msg <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="skolem">state</span> <span class="main">=</span> Some <span class="bound">y</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> apply_operations_def bind.bind_lunit not_None_eq
       hb.apply_operations_Snoc kleisli_def apply_operations_never_fails interp_msg_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">xsa</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"node_deliver_messages <span class="skolem">xsa</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xsa</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xsa</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">xsa</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> node_deliver_messages <span class="bound">xsa</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> drop_last_message <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
  
<span class="keyword1"><span class="command">interpretation</span></span> trivial_rga_implementation<span class="main">:</span> rga <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trivial_node_histories.history_order_def
      trivial_node_histories.prefix_of_node_history_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Counter">
<div class="head">
<h1>Theory Counter</h1>
</div>
<pre class="source"><span class="comment1">(* Victor B. F. Gomes, University of Cambridge
   Martin Kleppmann, University of Cambridge
   Dominic P. Mulligan, University of Cambridge
   Alastair R. Beresford, University of Cambridge
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Increment-Decrement Counter›</span></span>
  
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The Increment-Decrement Counter is perhaps the simplest CRDT, and a paradigmatic example of a
    replicated data structure with commutative operations.›</span></span>

<span class="keyword1"><span class="command">theory</span></span>
  Counter
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Network.html">Network</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> operation <span class="main">=</span> Increment <span class="main">|</span> Decrement

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">counter_op</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"operation <span class="main">⇒</span> int <span class="main">⇀</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">counter_op</span> Increment <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">counter_op</span> Decrement <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> counter <span class="main">=</span> network_with_ops _ <span class="quoted">counter_op</span> <span class="quoted"><span class="main">0</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> counter<span class="main">)</span> <span class="quoted"><span class="quoted">"counter_op <span class="free">x</span> <span class="main">⊳</span> counter_op <span class="free">y</span> <span class="main">=</span> counter_op <span class="free">y</span> <span class="main">⊳</span> counter_op <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kleisli_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> counter<span class="main">)</span> concurrent_operations_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hb.concurrent_ops_commute <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hb.concurrent_ops_commute_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> a b x y<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">y</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_msg_def kleisli_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> counter<span class="main">)</span> counter_convergence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>node_deliver_messages <span class="free">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="free">xs</span> <span class="main">=</span> apply_operations <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_operations_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> hb.convergence_ext
      concurrent_operations_commute node_deliver_messages_distinct hb_consistent_prefix<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> counter <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> sec<span class="main">:</span> strong_eventual_consistency <span class="quoted">weak_hb</span> <span class="quoted">hb</span> <span class="quoted">interp_msg</span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ops</span><span class="main">.</span> <span class="main">∃</span><span class="bound">xs</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="bound">i</span> <span class="main">∧</span> node_deliver_messages <span class="bound">xs</span> <span class="main">=</span> <span class="bound">ops</span>"</span></span> <span class="quoted"><span class="main">0</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hb_consistent_prefix drop_last_message
      node_deliver_messages_distinct concurrent_operations_commute<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> interp_msg_def counter_op.elims<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> drop_last_message <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ORSet">
<div class="head">
<h1>Theory ORSet</h1>
</div>
<pre class="source"><span class="comment1">(* Victor B. F. Gomes, University of Cambridge
   Martin Kleppmann, University of Cambridge
   Dominic P. Mulligan, University of Cambridge
   Alastair R. Beresford, University of Cambridge
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Observed-Remove Set›</span></span>
 
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The ORSet is a well-known CRDT for implementing replicated sets, supporting two operations:
     the \emph{insertion} and \emph{deletion} of an arbitrary element in the shared set.›</span></span>

<span class="keyword1"><span class="command">theory</span></span>
  ORSet
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Network.html">Network</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> operation <span class="main">=</span> Add <span class="quoted"><span class="quoted">"<span class="tfree">'id</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span> <span class="main">|</span> Rem <span class="quoted"><span class="quoted">"<span class="tfree">'id</span> set"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> state <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'id</span> set"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">op_elem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> operation <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">op_elem</span> <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="keyword1">of</span> Add <span class="bound">i</span> <span class="bound">e</span> <span class="main">⇒</span> <span class="bound">e</span> <span class="main">|</span> Rem <span class="bound">is</span> <span class="bound">e</span> <span class="main">⇒</span> <span class="bound">e</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">interpret_op</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> operation <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇀</span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">⟩</span>"</span> <span class="main">[</span>0<span class="main">]</span> 1000<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">interpret_op</span> <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">≡</span>
     <span class="keyword1">let</span> <span class="bound">before</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">(</span>op_elem <span class="free"><span class="bound"><span class="entity">oper</span></span></span><span class="main">)</span><span class="main">;</span>
         <span class="bound">after</span>  <span class="main">=</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="keyword1">of</span> Add <span class="bound">i</span> <span class="bound">e</span> <span class="main">⇒</span> <span class="bound">before</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">i</span><span class="main">}</span> <span class="main">|</span> Rem <span class="bound">is</span> <span class="bound">e</span> <span class="main">⇒</span> <span class="bound">before</span> <span class="main">-</span> <span class="bound">is</span>
     <span class="keyword1">in</span>  Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">(</span><span class="main">(</span>op_elem <span class="free"><span class="bound"><span class="entity">oper</span></span></span><span class="main">)</span> <span class="main">:=</span> <span class="bound">after</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valid_behaviours</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="tfree">'id</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> operation <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_behaviours</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span> <span class="main">≡</span>
     <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span> <span class="keyword1">of</span>
       <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Add <span class="bound">j</span>  <span class="bound">e</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="main">|</span>
       <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Rem <span class="bound">is</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">is</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="bound">e</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> orset <span class="main">=</span> network_with_constrained_ops _ <span class="quoted">interpret_op</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">{}</span>"</span></span> <span class="quoted">valid_behaviours</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> orset<span class="main">)</span> add_add_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Add <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Add <span class="free">i2</span> <span class="free">e2</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Add <span class="free">i2</span> <span class="free">e2</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Add <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interpret_op_def op_elem_def kleisli_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> orset<span class="main">)</span> add_rem_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">is</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Add <span class="free">i</span> <span class="free">e1</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Rem <span class="free">is</span> <span class="free">e2</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Rem <span class="free">is</span> <span class="free">e2</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Add <span class="free">i</span> <span class="free">e1</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interpret_op_def kleisli_def op_elem_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> orset<span class="main">)</span> apply_operations_never_fails<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="free">xs</span> <span class="main">≠</span> None"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Broadcast <span class="skolem">e</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Deliver <span class="skolem">e</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> interpret_op_def interp_msg_def bind.bind_lunit prefix_of_appendD<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> orset<span class="main">)</span> add_id_valid<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i1</span><span class="main">,</span> Add <span class="free">i2</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">=</span> <span class="free">i2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> valid_behaviours <span class="bound">s</span> <span class="main">(</span><span class="free">i1</span><span class="main">,</span> Add <span class="free">i2</span> <span class="free">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms deliver_in_prefix_is_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_behaviours_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> orset<span class="main">)</span> <span class="entity">added_ids</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'id</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> operation<span class="main">)</span> event list <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'id</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">added_ids</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> List.map_filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Deliver <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Add <span class="bound">j</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">e</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> Some <span class="bound">j</span> <span class="keyword1">else</span> None <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> orset<span class="main">)</span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"added_ids <span class="main">[]</span> <span class="free">e</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_ids_def map_filter_def<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> orset<span class="main">)</span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"added_ids <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> added_ids <span class="free">xs</span> <span class="free">e</span> <span class="main">@</span> added_ids <span class="free">ys</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_ids_def map_filter_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> orset<span class="main">)</span> added_ids_Broadcast_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"added_ids <span class="main">(</span><span class="main">[</span>Broadcast <span class="free">e</span><span class="main">]</span><span class="main">)</span> <span class="free">e'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_ids_def map_filter_append map_filter_def<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> orset<span class="main">)</span> added_ids_Deliver_Rem_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"added_ids <span class="main">(</span><span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Rem <span class="free">is</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">e'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_ids_def map_filter_append map_filter_def<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> orset<span class="main">)</span> added_ids_Deliver_Add_diff_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">≠</span> <span class="free">e'</span> <span class="main">⟹</span> added_ids <span class="main">(</span><span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Add <span class="free">j</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">e'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_ids_def map_filter_append map_filter_def<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> orset<span class="main">)</span> added_ids_Deliver_Add_same_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"added_ids <span class="main">(</span><span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Add <span class="free">j</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="main">[</span><span class="free">j</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_ids_def map_filter_append map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> orset<span class="main">)</span> added_id_not_in_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">∉</span> set <span class="main">(</span>added_ids <span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Add <span class="free">i2</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">≠</span> <span class="free">i2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> orset<span class="main">)</span> apply_operations_added_ids<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="free">es</span> <span class="main">=</span> Some <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">⊆</span> set <span class="main">(</span>added_ids <span class="free">es</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Deliver <span class="skolem">e</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interp_msg_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bind_splits<span class="main"><span class="keyword3">,</span></span>
                    <span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> op_elem_def interpret_op_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> orset<span class="main">)</span> Deliver_added_ids<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>added_ids <span class="free">xs</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Add <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Deliver <span class="skolem">e'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> added_ids_Deliver_Add_diff_collapse added_ids_Deliver_Add_same_collapse
              empty_iff list.set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_ConsD add_id_valid in_set_conv_decomp prefix_of_appendD<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> orset<span class="main">)</span> Broadcast_Deliver_prefix_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="main">[</span>Broadcast <span class="main">(</span><span class="free">r</span><span class="main">,</span> Rem <span class="free">ix</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">ix</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Add <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="free">xs</span> <span class="main">=</span> Some <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms broadcast_only_valid_msgs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">ix</span> <span class="main">=</span> <span class="skolem">y</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> broadcast_only_valid_msgs operation.case<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> option.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
     valid_behaviours_def case_prodD<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms Deliver_added_ids apply_operations_added_ids <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> orset<span class="main">)</span> Broadcast_Deliver_prefix_closed2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="main">(</span><span class="free">r</span><span class="main">,</span> Rem <span class="free">ix</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">ix</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Add <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms Broadcast_Deliver_prefix_closed <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> orset<span class="main">)</span> concurrent_add_remove_independent_technical<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">is</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Add <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ir</span><span class="main">,</span> Rem <span class="free">is</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hb <span class="main">(</span><span class="free">i</span><span class="main">,</span> Add <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Rem <span class="free">is</span> <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span><span class="main">@</span><span class="main">[</span>Broadcast <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Rem <span class="free">is</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delivery_has_a_cause events_before_exist prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Add <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Broadcast_Deliver_prefix_closed assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> hb.intros<span class="main">(</span>2<span class="main">)</span> events_in_local_order <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> orset<span class="main">)</span> Deliver_Add_same_id_same_message<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Add <span class="free">i</span> <span class="free">e1</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Add <span class="free">i</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">=</span> <span class="free">e2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre1</span></span> <span class="skolem"><span class="skolem">pre2</span></span> <span class="skolem"><span class="skolem">k1</span></span> <span class="skolem"><span class="skolem">k2</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre1</span><span class="main">@</span><span class="main">[</span>Broadcast <span class="main">(</span><span class="free">i</span><span class="main">,</span> Add <span class="free">i</span> <span class="free">e1</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">k1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pre2</span><span class="main">@</span><span class="main">[</span>Broadcast <span class="main">(</span><span class="free">i</span><span class="main">,</span> Add <span class="free">i</span> <span class="free">e2</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">k2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delivery_has_a_cause events_before_exist <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="main">(</span><span class="free">i</span><span class="main">,</span> Add <span class="free">i</span> <span class="free">e1</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">k1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Broadcast <span class="main">(</span><span class="free">i</span><span class="main">,</span> Add <span class="free">i</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">k2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> node_histories.prefix_to_carriers node_histories_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> msg_id_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> orset<span class="main">)</span> ids_imply_messages_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">is</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Add <span class="free">i</span> <span class="free">e1</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ir</span><span class="main">,</span> Rem <span class="free">is</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">=</span> <span class="free">e2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span><span class="main">@</span><span class="main">[</span>Broadcast <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Rem <span class="free">is</span> <span class="free">e2</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delivery_has_a_cause events_before_exist prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Add <span class="free">i</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Broadcast_Deliver_prefix_closed assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Add <span class="free">i</span> <span class="free">e1</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv msg_id_unique network.delivery_has_a_cause network_axioms operation.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
        prefix_elem_to_carriers prefix_of_appendD prod.inject<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> orset<span class="main">)</span> concurrent_add_remove_independent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hb <span class="main">(</span><span class="free">i</span><span class="main">,</span> Add <span class="free">i</span> <span class="free">e1</span><span class="main">)</span> <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Rem <span class="free">is</span> <span class="free">e2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hb <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Rem <span class="free">is</span> <span class="free">e2</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> Add <span class="free">i</span> <span class="free">e1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Add <span class="free">i</span> <span class="free">e1</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ir</span><span class="main">,</span> Rem <span class="free">is</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">is</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms ids_imply_messages_same concurrent_add_remove_independent_technical <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> orset<span class="main">)</span> rem_rem_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Rem <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Rem <span class="free">i2</span> <span class="free">e2</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Rem <span class="free">i2</span> <span class="free">e2</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Rem <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold</span> interpret_op_def op_elem_def kleisli_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> orset<span class="main">)</span> concurrent_operations_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hb.concurrent_ops_commute <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>                     
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
           <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
           <span class="quoted"><span class="quoted">"hb.concurrent <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"interp_msg <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">⊳</span> interp_msg <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> interp_msg <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">⊳</span> interp_msg <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> interp_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">y</span></span>"</span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_add_commute rem_rem_commute hb.concurrent_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_id_valid add_rem_commute assms concurrent_add_remove_independent hb.concurrentD1 hb.concurrentD2 prefix_contains_msg<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hb.concurrent_ops_commute_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> orset<span class="main">)</span> convergence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>node_deliver_messages <span class="free">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="free">xs</span> <span class="main">=</span> apply_operations <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_operations_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> hb.convergence_ext concurrent_operations_commute
                node_deliver_messages_distinct hb_consistent_prefix<span class="main">)</span>
              
<span class="keyword1"><span class="command">context</span></span> orset <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> sec<span class="main">:</span> strong_eventual_consistency <span class="quoted">weak_hb</span> <span class="quoted">hb</span> <span class="quoted">interp_msg</span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ops</span><span class="main">.</span><span class="main">∃</span><span class="bound">xs</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="bound">i</span> <span class="main">∧</span> node_deliver_messages <span class="bound">xs</span> <span class="main">=</span> <span class="bound">ops</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span><span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hb_consistent_prefix node_deliver_messages_distinct
        concurrent_operations_commute<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> apply_operations_def bind.bind_lunit not_None_eq
     hb.apply_operations_Snoc kleisli_def apply_operations_never_fails interp_msg_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> drop_last_message <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

  
</pre>
</div>