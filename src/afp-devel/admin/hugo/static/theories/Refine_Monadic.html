<div id="Refine_Chapter">
<div class="head">
<h1>Theory Refine_Chapter</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Refinement Framework›</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Refine_Chapter
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Refine_Mono_Prover">
<div class="head">
<h1>Theory Refine_Mono_Prover</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Refine_Mono_Prover
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="../Automatic_Refinement/Refine_Lib.html">Automatic_Refinement.Refine_Lib</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹refine_mono_prover.ML›</span>

  <span class="keyword1"><span class="command">setup</span></span> <span class="entity">Refine_Mono_Prover.setup</span>
  <span class="keyword1"><span class="command">declaration</span></span> <span class="entity">Refine_Mono_Prover.decl_setup</span>

  <span class="keyword1"><span class="command">method_setup</span></span> refine_mono <span class="main">=</span> 
    <span class="quoted">‹Scan.succeed <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span>
      <span class="entity">Refine_Mono_Prover.untriggered_mono_tac</span> <span class="entity">ctxt</span>
    <span class="main">)</span><span class="main">)</span>›</span> 
    <span class="quoted">"Refinement framework: Monotonicity prover"</span>

  <span class="keyword1"><span class="command">locale</span></span> mono_setup_loc <span class="main">=</span> 
    <span class="comment1">― ‹Locale to set up monotonicity prover for given ordering operator›</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">le</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="free">x</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>
    <span class="keyword1"><span class="command">lemma</span></span> monoI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">f</span> <span class="bound">g</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">le</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">le</span> <span class="main">(</span><span class="free">B</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="bound">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">⟹</span> monotone <span class="main">(</span>fun_ord <span class="free">le</span><span class="main">)</span> <span class="main">(</span>fun_ord <span class="free">le</span><span class="main">)</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> monotone_def fun_ord_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
    <span class="keyword1"><span class="command">lemma</span></span> mono_if<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">le</span> <span class="free">t</span> <span class="free">t'</span><span class="main">;</span> <span class="free">le</span> <span class="free">e</span> <span class="free">e'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">le</span> <span class="main">(</span>If <span class="free">b</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span> <span class="main">(</span>If <span class="free">b</span> <span class="free">t'</span> <span class="free">e'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">lemma</span></span> mono_let<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">le</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">le</span> <span class="main">(</span>Let <span class="free">x</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Let <span class="free">x</span> <span class="free">f'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">lemmas</span></span> mono_thms<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span> <span class="main">=</span> monoI mono_if mono_let refl

    <span class="keyword1"><span class="command">declaration</span></span> <span class="quoted">‹<span class="entity">Refine_Mono_Prover.declare_mono_triggers</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> monoI<span class="antiquote">}</span></span></span>›</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">interpretation</span></span> order_mono_setup<span class="main">:</span> mono_setup_loc <span class="quoted"><span class="quoted">"<span class="main">(≤)</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>preorder <span class="main">⇒</span> <span class="main">_</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">declaration</span></span> <span class="quoted">‹<span class="entity">Refine_Mono_Prover.declare_mono_triggers</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> Orderings.monoI<span class="antiquote">}</span></span></span>›</span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span> <span class="main">=</span> 
    lfp_mono<span class="main">[</span><span class="operator">OF</span> le_funI<span class="main">,</span> <span class="operator">THEN</span> le_funD<span class="main">]</span> 
    gfp_mono<span class="main">[</span><span class="operator">OF</span> le_funI<span class="main">,</span> <span class="operator">THEN</span> le_funD<span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="files/refine_mono_prover.ML">
<div class="head">
<h1>File ‹refine_mono_prover.ML›</h1>
</div>
<pre class="source">
<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">REFINE_MONO_PROVER</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
  <span class="comment1">(* A generic automatic case splitter *)</span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">pat_extractor</span> <span class="main">=</span> 
    term <span class="main">-&gt;</span> <span class="main">(</span>term * <span class="main">(</span><span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv<span class="main">)</span><span class="main">)</span> option

  <span class="keyword1"><span class="keyword">val</span></span> gen_split_cases_tac<span class="main">:</span> <span class="entity">pat_extractor</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>

  <span class="comment1">(* Recognizes all patterns of the form _ (case x of ...) (case x of ...) *)</span>
  <span class="keyword1"><span class="keyword">val</span></span> split_cases_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>

  <span class="comment1">(* Monotonicity prover *)</span>
  <span class="keyword1"><span class="keyword">val</span></span> get_mono_thms<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm list
  <span class="keyword1"><span class="keyword">val</span></span> add_mono_thm<span class="main">:</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
  <span class="keyword1"><span class="keyword">val</span></span> del_mono_thm<span class="main">:</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
  <span class="keyword1"><span class="keyword">val</span></span> mono_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>

  <span class="comment1">(* Monotonicity solver *)</span>
  <span class="keyword1"><span class="keyword">val</span></span> untriggered_mono_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
  <span class="keyword1"><span class="keyword">val</span></span> declare_mono_triggers<span class="main">:</span> thm list <span class="main">-&gt;</span> morphism <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic

  <span class="comment1">(* Setup *)</span>
  <span class="keyword1"><span class="keyword">val</span></span> decl_setup<span class="main">:</span> morphism <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
  <span class="keyword1"><span class="keyword">val</span></span> setup<span class="main">:</span> theory <span class="main">-&gt;</span> theory

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Refine_Mono_Prover</span> <span class="main">:</span> <span class="entity">REFINE_MONO_PROVER</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">pat_extractor</span> <span class="main">=</span> 
    term <span class="main">-&gt;</span> <span class="main">(</span>term * <span class="main">(</span><span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv<span class="main">)</span><span class="main">)</span> option

  <span class="comment1">(* Case Splitter, taken from Krauss' partial_function. *)</span>
  <span class="keyword2"><span class="keyword">local</span></span>
    <span class="comment1">(*rewrite conclusion with k-th assumtion*)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rewrite_with_asm_tac</span> <span class="entity">ctxt</span> <span class="entity">k</span> <span class="main">=</span>
      <span class="entity">Subgoal.FOCUS</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt'</span><span class="main">,</span> <span class="entity">prems</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span>
        Local_Defs.unfold_tac <span class="entity">ctxt'</span> <span class="main">[</span>nth <span class="entity">prems</span> <span class="entity">k</span><span class="main">]</span><span class="main">)</span> <span class="entity">ctxt</span><span class="main">;</span>
    
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_case</span> <span class="entity">ctxt</span> <span class="entity">t</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">case</span></span> strip_comb <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="main">(</span>Const <span class="main">(</span><span class="entity">case_comb</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="entity">args</span><span class="main">)</span> <span class="main">=&gt;</span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">Ctr_Sugar.ctr_sugar_of_case</span> <span class="entity">ctxt</span> <span class="entity">case_comb</span> <span class="keyword2"><span class="keyword">of</span></span>
             NONE <span class="main">=&gt;</span> NONE
           <span class="main">|</span> SOME <span class="main">{</span><span class="entity">case_thms</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span>
               <span class="keyword2"><span class="keyword">let</span></span>
                 <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lhs</span> <span class="main">=</span> Thm.prop_of <span class="main">(</span>hd <span class="entity">case_thms</span><span class="main">)</span>
                   |&gt; <span class="entity">HOLogic.dest_Trueprop</span> |&gt; <span class="entity">HOLogic.dest_eq</span> |&gt; fst<span class="main">;</span>
                 <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">arity</span> <span class="main">=</span> length <span class="main">(</span>snd <span class="main">(</span>strip_comb <span class="entity">lhs</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                 <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> length <span class="entity">args</span> - <span class="entity">arity</span> &gt;= <span class="inner_numeral">0</span> 
                   <span class="keyword1"><span class="keyword">orelse</span></span> <span class="keyword3"><span class="keyword">raise</span></span> TERM<span class="main">(</span><span class="inner_quoted">"dest_case: arity"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span> 
                     <span class="comment1">(* funpow on negative argument loops until stack overflow *)</span>
                 <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">conv</span> <span class="main">=</span> funpow <span class="main">(</span>length <span class="entity">args</span> - <span class="entity">arity</span><span class="main">)</span> Conv.fun_conv
                   <span class="main">(</span>Conv.rewrs_conv <span class="main">(</span>map <span class="entity">mk_meta_eq</span> <span class="entity">case_thms</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
               <span class="keyword2"><span class="keyword">in</span></span>
                 SOME <span class="main">(</span>nth <span class="entity">args</span> <span class="main">(</span><span class="entity">arity</span> - <span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span> <span class="entity">conv</span><span class="main">)</span>
               <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> NONE<span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>  
    <span class="comment1">(*split on case expressions*)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_split_cases_tac</span> <span class="main">(</span><span class="entity">extract_pat</span><span class="main">:</span><span class="entity">pat_extractor</span><span class="main">)</span> 
    <span class="main">=</span> <span class="entity">Subgoal.FOCUS</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context<span class="main">=</span><span class="entity">ctxt</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span> 
      SUBGOAL <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">extract_pat</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
        SOME <span class="main">(</span><span class="entity">body</span><span class="main">,</span> <span class="entity">mk_conv</span><span class="main">)</span> <span class="main">=&gt;</span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">dest_case</span> <span class="entity">ctxt</span> <span class="entity">body</span> <span class="keyword2"><span class="keyword">of</span></span>
             NONE <span class="main">=&gt;</span> no_tac
           <span class="main">|</span> SOME <span class="main">(</span><span class="entity">arg</span><span class="main">,</span> <span class="entity">conv</span><span class="main">)</span> <span class="main">=&gt;</span>
               <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> Conv <span class="keyword2"><span class="keyword">in</span></span>
                  <span class="keyword2"><span class="keyword">if</span></span> Term.is_open <span class="entity">arg</span> <span class="keyword2"><span class="keyword">then</span></span> no_tac
                  <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span>
                      <span class="main">(</span>DETERM o <span class="entity">Induct.cases_tac</span> <span class="entity">ctxt</span> false <span class="main">[</span><span class="main">[</span>SOME <span class="entity">arg</span><span class="main">]</span><span class="main">]</span> NONE <span class="main">[</span><span class="main">]</span><span class="main">)</span>
                      THEN_ALL_NEW <span class="main">(</span><span class="entity">rewrite_with_asm_tac</span> <span class="entity">ctxt</span> <span class="inner_numeral">0</span><span class="main">)</span>
                      THEN_ALL_NEW eresolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> thin_rl<span class="antiquote">}</span></span></span>
                      THEN_ALL_NEW <span class="main">(</span>
                        CONVERSION <span class="main">(</span>params_conv <span class="inner_numeral">~1</span> <span class="main">(</span><span class="entity">mk_conv</span> <span class="main">(</span>K <span class="entity">conv</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">)</span> <span class="entity">i</span>
               <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> no_tac<span class="main">)</span> <span class="inner_numeral">1</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">end</span></span>
       
  <span class="keyword2"><span class="keyword">local</span></span> 
    <span class="keyword3"><span class="keyword">open</span></span> Conv    
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">extract</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span><span class="main">_</span> <span class="var">?t1.0</span> <span class="var">?t2.0</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span></span> 
        <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">let</span></span> 
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">last</span> <span class="main">=</span> <span class="main">#</span><span class="inner_numeral">2</span> o split_last
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">hd1</span><span class="main">,</span><span class="entity">args1</span><span class="main">)</span> <span class="main">=</span> strip_comb <span class="entity">t1</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">hd2</span><span class="main">,</span><span class="entity">args2</span><span class="main">)</span> <span class="main">=</span> strip_comb <span class="entity">t2</span>  
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">x1</span> <span class="main">=</span> <span class="entity">last</span> <span class="entity">args1</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">x2</span> <span class="main">=</span> <span class="entity">last</span> <span class="entity">args2</span>
            <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_conv</span> <span class="entity">conv</span> <span class="entity">ctxt</span> <span class="main">=</span> 
              arg_conv <span class="main">(</span>binop_conv <span class="main">(</span><span class="entity">conv</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span> 
            <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">hd1</span> aconv <span class="entity">hd2</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">x1</span> aconv <span class="entity">x2</span> <span class="keyword2"><span class="keyword">then</span></span> 
              SOME <span class="main">(</span><span class="entity">t1</span><span class="main">,</span> <span class="entity">mk_conv</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">else</span></span> NONE
          <span class="keyword2"><span class="keyword">end</span></span> 
          <span class="keyword3"><span class="keyword">handle</span></span> List.Empty <span class="main">=&gt;</span> NONE<span class="main">)</span>
      <span class="main">|</span> <span class="entity">extract</span> <span class="main">_</span> <span class="main">=</span> NONE
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">split_cases_tac</span> <span class="main">=</span> <span class="entity">gen_split_cases_tac</span> <span class="entity">extract</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*
        = SOME (t,fn conv =&gt; fn ctxt =&gt; 
            arg_conv (arg_conv (abs_conv (#2 #&gt; conv) ctxt)))
*)</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">split_meta_conjunction</span> <span class="entity">thm</span> <span class="main">=</span> 
    <span class="keyword2"><span class="keyword">case</span></span> Thm.prop_of <span class="entity">thm</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> "Pure.conjunction"<span class="antiquote">}</span></span>$<span class="main">_</span>$<span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span> 
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">t1</span><span class="main">,</span><span class="entity">t2</span><span class="main">)</span> <span class="main">=</span> Conjunction.elim <span class="entity">thm</span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">split_meta_conjunction</span> <span class="entity">t1</span> @ <span class="entity">split_meta_conjunction</span> <span class="entity">t2</span> <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">thm</span><span class="main">]</span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Mono_Thms</span> <span class="main">=</span> <span class="entity">Named_Sorted_Thms</span> <span class="main">(</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> refine_mono<span class="antiquote">}</span></span></span> 
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Refinement Framework: Monotonicity theorems"</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sort</span> <span class="main">=</span> K I
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">transform</span> <span class="main">=</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">context</span> <span class="main">=&gt;</span> <span class="entity">split_meta_conjunction</span> #&gt; map <span class="main">(</span>norm_hhf <span class="main">(</span>Context.proof_of <span class="entity">context</span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">get_mono_thms</span> <span class="main">=</span> <span class="entity">Mono_Thms.get</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">add_mono_thm</span> <span class="main">=</span> <span class="entity">Mono_Thms.add_thm</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">del_mono_thm</span> <span class="main">=</span> <span class="entity">Mono_Thms.del_thm</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mono_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> REPEAT_ALL_NEW <span class="main">(</span>
    FIRST' <span class="main">[</span>
      <span class="entity">Method.assm_tac</span> <span class="entity">ctxt</span><span class="main">,</span>
      resolve_tac <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">Mono_Thms.get</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">,</span>
      <span class="entity">split_cases_tac</span> <span class="entity">ctxt</span>
    <span class="main">]</span>
  <span class="main">)</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">untriggered_mono_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">mono_tac</span> <span class="entity">ctxt</span> 
    THEN_ALL_NEW <span class="main">(</span>TRY o <span class="entity">Tagged_Solver.solve_tac</span> <span class="entity">ctxt</span><span class="main">)</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mono_solver_bnd</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> refine_mono<span class="antiquote">}</span></span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mono_solver_name</span> <span class="main">=</span> <span class="inner_quoted">"Refine_Mono_Prover.refine_mono"</span> <span class="comment1">(* TODO: HACK! *)</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">declare_mono_triggers</span> <span class="main">=</span>
    <span class="entity">Tagged_Solver.add_triggers</span> <span class="entity">mono_solver_name</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">decl_setup</span> <span class="main">=</span> 
    <span class="entity">Tagged_Solver.declare_solver</span> 
      <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> monoI monotoneI<span class="main">[</span><span class="operator">of</span> <span class="quoted">"<span class="main">(≤)</span>"</span> <span class="quoted">"<span class="main">(≤)</span>"</span><span class="main">]</span><span class="antiquote">}</span></span></span> <span class="entity">mono_solver_bnd</span>
      <span class="inner_quoted">"Refine_Monadic: Monotonicity prover"</span> 
      <span class="entity">mono_tac</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">setup</span> <span class="main">=</span> I
    #&gt; <span class="entity">Mono_Thms.setup</span>
<span class="keyword2"><span class="keyword">end</span></span>


</pre>
</div><div id="Refine_Misc">
<div class="head">
<h1>Theory Refine_Misc</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Miscellanneous Lemmas and Tools›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Refine_Misc
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="../Automatic_Refinement/Automatic_Refinement.html">Automatic_Refinement.Automatic_Refinement</a>
  <a href="Refine_Mono_Prover.html">Refine_Mono_Prover</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Basic configuration for monotonicity prover:›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span> <span class="main">=</span> monoI monotoneI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(≤)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(≤)</span>"</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span> <span class="main">=</span> TrueI le_funI order_refl

<span class="keyword1"><span class="command">lemma</span></span> case_prod_mono<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">p</span><span class="main">=</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">≤</span> <span class="free">f'</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">⟧</span> <span class="main">⟹</span> case_prod <span class="free">f</span> <span class="free">p</span> <span class="main">≤</span> case_prod <span class="free">f'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> case_option_mono<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">fn</span> <span class="main">≤</span> <span class="free">fn'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="free">x</span><span class="main">=</span>Some <span class="bound">v</span> <span class="main">⟹</span> <span class="free">fs</span> <span class="bound">v</span> <span class="main">≤</span> <span class="free">fs'</span> <span class="bound">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"case_option <span class="free">fn</span> <span class="free">fs</span> <span class="free">x</span> <span class="main">≤</span> case_option <span class="free">fn'</span> <span class="free">fs'</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> case_list_mono<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">fn</span> <span class="main">≤</span> <span class="free">fn'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="free">l</span><span class="main">=</span><span class="bound">x</span><span class="main">#</span><span class="bound">xs</span> <span class="main">⟹</span> <span class="free">fc</span> <span class="bound">x</span> <span class="bound">xs</span> <span class="main">≤</span> <span class="free">fc'</span> <span class="bound">x</span> <span class="bound">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"case_list <span class="free">fn</span> <span class="free">fc</span> <span class="free">l</span> <span class="main">≤</span> case_list <span class="free">fn'</span> <span class="free">fc'</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> if_mono<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">⟹</span> <span class="free">m1</span> <span class="main">≤</span> <span class="free">m1'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">b</span> <span class="main">⟹</span> <span class="free">m2</span> <span class="main">≤</span> <span class="free">m2'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">m1</span> <span class="keyword1">else</span> <span class="free">m2</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">m1'</span> <span class="keyword1">else</span> <span class="free">m2'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> let_mono<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">f'</span> <span class="free">x'</span> <span class="main">⟹</span> Let <span class="free">x</span> <span class="free">f</span> <span class="main">≤</span> Let <span class="free">x'</span> <span class="free">f'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Uncategorized Lemmas›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> all_nat_split_at<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">k</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&gt;</span><span class="free">k</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> 
  <span class="main">⟹</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> linorder_neq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Well-Foundedness›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_no_infinite_down_chainI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="main">⟦</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="bound">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">r</span><span class="main">⟧</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms wf_iff_no_infinite_down_chain<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This lemma transfers well-foundedness over a simulation relation.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> sim_wf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span><span class="free">S'</span><span class="main">¯</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STARTR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x0</span><span class="main">,</span><span class="free">x0'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> SIM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span> <span class="bound">t</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span><span class="main">;</span> <span class="main">(</span><span class="free">x0'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">S'</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">t'</span><span class="main">)</span><span class="main">∈</span><span class="free">S'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">t'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> CLOSED<span class="main">:</span> <span class="quoted"><span class="quoted">"Domain <span class="free">S</span>  <span class="main">⊆</span> <span class="free">S</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="main">{</span><span class="free">x0</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span><span class="free">S</span><span class="main">¯</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> wf_no_infinite_down_chainI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹
    Informal proof:
    Assume there is an infinite chain in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S›</span></span></span></span>.
    Due to the closedness property of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S›</span></span></span></span>, it can be extended to 
    start at <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x0›</span></span></span></span>.
    Now, we inductively construct an infinite chain in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S'›</span></span></span></span>, such that
    each element of the new chain is in relation with the corresponding 
    element of the original chain:
      The first element is <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x0'›</span></span></span></span>. 
      For any element <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i+1›</span></span></span></span>, the simulation property yields the next
      element.
    This chain contradicts well-foundedness of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S'›</span></span></span></span>.
›</span></span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
  <span class="keyword3"><span class="command">assume</span></span> CHAIN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Extend to start with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x0›</span></span></span></span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> CHAIN'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f'</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">f'</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> CHAIN <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">0</span> <span class="main">∈</span> Domain <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> CLOSED <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x0</span><span class="main">,</span><span class="skolem">x</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> G0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">g</span> <span class="skolem">k</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> CH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">k</span><span class="main">.</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">g</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
        <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> step.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span> <span class="skolem">k</span> 
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">g</span> <span class="skolem">k</span>"</span></span> 
            <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">k</span><span class="main">.</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">g</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span>"</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step.prems<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">g</span><span class="main">(</span>Suc <span class="skolem">k</span> <span class="main">:=</span> <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> k<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">i</span><span class="main">&lt;</span><span class="skolem">k</span> <span class="keyword1">then</span> <span class="skolem">g</span> <span class="skolem">i</span> <span class="keyword1">else</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">i</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f'</span><span class="main">.</span> <span class="bound">f'</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">f'</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">f'</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> f'_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> S X G0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> k<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> all_nat_split_at<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CH<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> Suc <span class="improper">i</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> CH X<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CHAIN<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="improper">i</span> <span class="main">-</span> <span class="skolem">k</span> <span class="main">=</span> Suc <span class="main">(</span><span class="improper">i</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> CHAIN <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f'</span> <span class="bound">i</span><span class="main">,</span><span class="skolem">f'</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Construct chain in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S'›</span></span></span></span>›</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">=</span> rec_nat <span class="free">x0'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">SOME</span> <span class="bound">x'</span><span class="main">.</span> 
          <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">S'</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">f'</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x0'</span><span class="main">,</span> <span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">S'</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> g'_def
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g'</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">g'</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">S'</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">f'</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">,</span><span class="skolem">g'</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> 
      <span class="main">∧</span> <span class="main">(</span><span class="free">x0'</span><span class="main">,</span><span class="skolem">g'</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">S'</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0 
      <span class="keyword1"><span class="command">from</span></span> SIM<span class="main">[</span><span class="operator">OF</span> STARTR<span class="main">]</span> CHAIN'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x0'</span><span class="main">,</span><span class="skolem">t'</span><span class="main">)</span><span class="main">∈</span><span class="free">S'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f'</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">,</span><span class="skolem">t'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x0'</span><span class="main">,</span><span class="skolem">t'</span><span class="main">)</span><span class="main">∈</span><span class="free">S'</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> someI2 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> STARTR<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> SIM<span class="main">[</span><span class="operator">OF</span> _ CHAIN'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> LS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g'</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">,</span><span class="skolem">t'</span><span class="main">)</span><span class="main">∈</span><span class="free">S'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f'</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="skolem">t'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> LS Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x0'</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">∈</span><span class="free">S'</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> someI2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">hence</span></span> S'CHAIN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">g'</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">g'</span><span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">S'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹This contradicts well-foundedness›</span></span>
  <span class="keyword1"><span class="command">with</span></span> WF <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> wf_no_infinite_down_chainE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">g'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Well-founded relation that approximates a finite set from below.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">finite_psupset</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span><span class="bound">Q'</span><span class="main">,</span><span class="bound">Q</span><span class="main">)</span><span class="main">.</span> <span class="bound">Q</span><span class="main">⊂</span><span class="bound">Q'</span> <span class="main">∧</span> <span class="bound">Q'</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> finite_psupset_wf<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> wf <span class="main">(</span>finite_psupset <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> finite_psupset_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_bounded_supset<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">less_than_bool</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span><span class="main">&lt;</span><span class="main">(</span><span class="bound">b</span><span class="main">::</span>bool<span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> wf_less_than_bool<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>less_than_bool<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_than_bool_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> less_than_bool_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">∈</span>less_than_bool <span class="main">⟷</span> <span class="free">x</span><span class="main">=</span>False <span class="main">∧</span> <span class="free">y</span><span class="main">=</span>True"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_than_bool_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">greater_bounded</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">≡</span> inv_image less_than <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">-</span><span class="bound">x</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">lemma</span></span> wf_greater_bounded<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>greater_bounded <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> greater_bounded_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> greater_bounded_Suc_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="free">x</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">∈</span>greater_bounded <span class="free">N</span> <span class="main">⟷</span> Suc <span class="free">x</span> <span class="main">≤</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> greater_bounded_def<span class="main">)</span>

    
    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Monotonicity and Orderings›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mono_const<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> monoI<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> mono_if<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>mono <span class="free">S1</span><span class="main">;</span> mono <span class="free">S2</span><span class="main">⟧</span> <span class="main">⟹</span>
  mono <span class="main">(</span><span class="main">λ</span><span class="bound">F</span> <span class="bound">s</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">b</span> <span class="bound">s</span> <span class="keyword1">then</span> <span class="free">S1</span> <span class="bound">F</span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="free">S2</span> <span class="bound">F</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> monoD<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> le_funD<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> mono_infI<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> mono <span class="free">g</span> <span class="main">⟹</span> mono <span class="main">(</span>inf <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inf_fun_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monoI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> inf_mono monoD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> mono_infI'<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> mono <span class="free">g</span> <span class="main">⟹</span> mono <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> inf <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'b</span><span class="main">::</span>lattice<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mono_infI<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> inf_fun_def<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_infArg<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>lattice <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>order"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> mono <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>inf <span class="bound">x</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monoI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> monoD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> inf_mono order_refl<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> mono_Sup<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> Sup <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span>Sup <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> imageE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> monoD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Sup_upper<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> mono_SupI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S'</span><span class="main">⊆</span><span class="free">f</span><span class="main">`</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Sup <span class="free">S'</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span>Sup <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sup_subset_mono assms mono_Sup order_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_Inf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span>Inf <span class="free">S</span><span class="main">)</span> <span class="main">≤</span> Inf <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Inf_greatest<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> imageE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> monoD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Inf_lower<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> mono_funpow<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>order <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⟹</span> mono <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> monoI<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> monoD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> mono_id<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mono id"</span></span>
  <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> monoI<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> SUP_insert<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> semilattice_inf<span class="main">)</span> le_infD1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> inf <span class="free">b</span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> le_infE<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> semilattice_inf<span class="main">)</span> le_infD2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> inf <span class="free">b</span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> le_infE<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> semilattice_inf<span class="main">)</span> inf_leI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span><span class="main">≤</span><span class="free">a</span><span class="main">;</span> <span class="bound">x</span><span class="main">≤</span><span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">x</span><span class="main">≤</span><span class="free">c</span> <span class="main">⟧</span> <span class="main">⟹</span> inf <span class="free">a</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inf_le1 inf_le2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> top_Sup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>top<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>complete_lattice<span class="main">)</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟹</span> Sup <span class="free">A</span> <span class="main">=</span> top"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sup_upper top_le<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> bot_Inf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bot<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>complete_lattice<span class="main">)</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟹</span> Inf <span class="free">A</span> <span class="main">=</span> bot"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Inf_lower le_bot<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_compD<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">≤</span><span class="free">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="keyword1">o</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="keyword1">o</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> monoD le_funD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Galois Connections›</span></span>
<span class="keyword1"><span class="command">locale</span></span> galois_connection <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">γ</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> galois<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> <span class="free">γ</span><span class="main">(</span><span class="free">a</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">α</span><span class="main">(</span><span class="free">c</span><span class="main">)</span> <span class="main">≤</span> <span class="free">a</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> αγ_defl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span><span class="main">(</span><span class="free">γ</span><span class="main">(</span><span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">γ</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> galois <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span><span class="main">(</span><span class="free">γ</span><span class="main">(</span><span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> γα_infl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">γ</span><span class="main">(</span><span class="free">α</span><span class="main">(</span><span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">α</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> galois <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">γ</span><span class="main">(</span><span class="free">α</span><span class="main">(</span><span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
    
  <span class="keyword1"><span class="command">lemma</span></span> α_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">α</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">y</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">≤</span><span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> γα_infl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">α</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> galois<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> γ_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span> <span class="main">(</span><span class="operator">metis</span> αγ_defl galois inf_absorb1 le_infE<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> dist_γ<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">(</span>inf <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> inf <span class="main">(</span><span class="free">γ</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">γ</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_antisym<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mono_inf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> γ_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> galois<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> galois<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">lemma</span></span> dist_α<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">(</span>sup <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> sup <span class="main">(</span><span class="free">α</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">α</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> α_mono galois mono_sup order_antisym 
      sup_ge1 sup_ge2 sup_least<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Fixed Points›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> mono_lfp_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> MONO<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FIXP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> LEAST<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">≤</span><span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lfp <span class="free">f</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lfp_lowerbound<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FIXP<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LEAST MONO lfp_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_gfp_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> MONO<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FIXP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> GREATEST<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">x</span><span class="main">≤</span><span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gfp <span class="free">f</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> GREATEST MONO gfp_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> gfp_upperbound<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FIXP<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> lfp_le_gfp'<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> lfp <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> gfp <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lfp_le_gfp<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="comment1">(* Just a reformulation of lfp_induct *)</span>
<span class="keyword1"><span class="command">lemma</span></span> lfp_induct'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">m</span> <span class="main">≤</span> lfp <span class="free">f</span><span class="main">;</span> <span class="bound">m</span> <span class="main">≤</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">m</span> <span class="main">≤</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lfp <span class="free">f</span> <span class="main">≤</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lfp_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> M<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> IS<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> lfp_gen_induct<span class="main">:</span>
  <span class="comment1">― ‹Induction lemma for generalized lfps›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">notes</span></span> MONO'<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span> <span class="main">=</span> monoD<span class="main">[</span><span class="operator">OF</span> M<span class="main">]</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m0</span> <span class="main">≤</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="main">⟦</span>
      <span class="bound">m</span> <span class="main">≤</span> lfp <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> sup <span class="free">m0</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>  <span class="comment1">― ‹Assume already established invariants›</span>
      <span class="bound">m</span> <span class="main">≤</span> <span class="free">P</span><span class="main">;</span>                       <span class="comment1">― ‹Assume invariant›</span>
      <span class="free">f</span> <span class="bound">m</span> <span class="main">≤</span> lfp <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> sup <span class="free">m0</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="comment1">― ‹Assume that step preserved est. invars›</span>
    <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">m</span> <span class="main">≤</span> <span class="free">P</span>"</span></span>                 <span class="comment1">― ‹Show that step preserves invariant›</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lfp <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> sup <span class="free">m0</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lfp_induct'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> MONO' monoI order_mono_setup.refl sup_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sup_least<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> I0<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> IS<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lfp_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> MONO' monoI order_mono_setup.refl sup_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_supI2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> M<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">.</span></span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Connecting Complete Lattices and 
  Chain-Complete Partial Orders›</span></span>
<span class="comment1">(* Note: Also connected by subclass now. However, we need both directions
  of embedding*)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> complete_lattice<span class="main">)</span> is_ccpo<span class="main">:</span> <span class="quoted"><span class="quoted">"class.ccpo Sup <span class="main">(≤)</span> <span class="main">(&lt;)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Sup_upper<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Sup_least<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> complete_lattice<span class="main">)</span> is_dual_ccpo<span class="main">:</span> <span class="quoted"><span class="quoted">"class.ccpo Inf <span class="main">(≥)</span> <span class="main">(&gt;)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> less_le_not_le<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Inf_lower<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Inf_greatest<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  
<span class="keyword1"><span class="command">lemma</span></span> ccpo_mono_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"monotone <span class="main">(≤)</span> <span class="main">(≤)</span> <span class="free">f</span> <span class="main">⟷</span> mono <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> monotone_def mono_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> ccpo_monoI<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> monotone <span class="main">(≤)</span> <span class="main">(≤)</span> <span class="free">f</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccpo_mono_simp<span class="main">)</span> 
<span class="keyword1"><span class="command">lemma</span></span> ccpo_monoD<span class="main">:</span> <span class="quoted"><span class="quoted">"monotone <span class="main">(≤)</span> <span class="main">(≤)</span> <span class="free">f</span> <span class="main">⟹</span> mono <span class="free">f</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccpo_mono_simp<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> dual_ccpo_mono_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"monotone <span class="main">(≥)</span> <span class="main">(≥)</span> <span class="free">f</span> <span class="main">⟷</span> mono <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> monotone_def mono_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> dual_ccpo_monoI<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> monotone <span class="main">(≥)</span> <span class="main">(≥)</span> <span class="free">f</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dual_ccpo_mono_simp<span class="main">)</span> 
<span class="keyword1"><span class="command">lemma</span></span> dual_ccpo_monoD<span class="main">:</span> <span class="quoted"><span class="quoted">"monotone <span class="main">(≥)</span> <span class="main">(≥)</span> <span class="free">f</span> <span class="main">⟹</span> mono <span class="free">f</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dual_ccpo_mono_simp<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> ccpo_lfp_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> mono <span class="bound">f</span> <span class="main">⟹</span> ccpo.fixp Sup <span class="main">(≤)</span> <span class="bound">f</span> <span class="main">=</span> lfp <span class="bound">f</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lfp_lowerbound<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> ccpo.fixp_unfold<span class="main"><span class="main">[</span></span><span class="operator">OF</span> is_ccpo ccpo_monoI<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccpo.fixp_lowerbound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> is_ccpo ccpo_monoI<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lfp_unfold<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> ccpo_gfp_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> mono <span class="bound">f</span> <span class="main">⟹</span> ccpo.fixp Inf <span class="main">(≥)</span> <span class="bound">f</span> <span class="main">=</span> gfp <span class="bound">f</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> gfp_upperbound<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> ccpo.fixp_unfold<span class="main"><span class="main">[</span></span><span class="operator">OF</span> is_dual_ccpo dual_ccpo_monoI<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccpo.fixp_lowerbound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> is_dual_ccpo dual_ccpo_monoI<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gfp_unfold<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">chain_admissible</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> ccpo.admissible Sup <span class="main">(≤)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_chain</span> <span class="main">≡</span> Complete_Partial_Order.chain <span class="main">(≤)</span>"</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> chain_admissibleI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main">?</span></span><span class="main">]</span> <span class="main">=</span> ccpo.admissibleI<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> lub<span class="main"><span class="main">=</span></span><span class="quoted">Sup</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ord<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(≤)</span>"</span></span><span class="main">]</span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">dual_chain_admissible</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> ccpo.admissible Inf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span><span class="main">≤</span><span class="bound">x</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_dual_chain</span> <span class="main">≡</span> Complete_Partial_Order.chain <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span><span class="main">≤</span><span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> dual_chain_admissibleI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main">?</span></span><span class="main">]</span> <span class="main">=</span> 
  ccpo.admissibleI<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> lub<span class="main"><span class="main">=</span></span><span class="quoted">Inf</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ord<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span><span class="main">≤</span><span class="bound">x</span><span class="main">)</span>"</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> dual_chain_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_dual_chain <span class="free">C</span> <span class="main">=</span> is_chain <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> chain_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> chain_dualI <span class="main">=</span> iffD1<span class="main">[</span><span class="operator">OF</span> dual_chain_iff<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> dual_chainI <span class="main">=</span> iffD2<span class="main">[</span><span class="operator">OF</span> dual_chain_iff<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> is_chain_empty<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_chain <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> chainI<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> is_dual_chain_empty<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_dual_chain <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dual_chainI<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> point_chainI<span class="main">:</span> <span class="quoted"><span class="quoted">"is_chain <span class="free">M</span> <span class="main">⟹</span> is_chain <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="free">x</span><span class="main">)</span><span class="main">`</span><span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> chainI le_funI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> chainD le_funD<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We transfer the admissible induction lemmas to complete
  lattices.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> lfp_cadm_induct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>chain_admissible <span class="free">P</span><span class="main">;</span> <span class="free">P</span> <span class="main">(</span>Sup <span class="main">{}</span><span class="main">)</span><span class="main">;</span> mono <span class="free">f</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>lfp <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ccpo_mono_simp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ccpo_lfp_simp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">rule</span> ccpo.fixp_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> is_ccpo<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gfp_cadm_induct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>dual_chain_admissible <span class="free">P</span><span class="main">;</span> <span class="free">P</span> <span class="main">(</span>Inf <span class="main">{}</span><span class="main">)</span><span class="main">;</span> mono <span class="free">f</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>gfp <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dual_ccpo_mono_simp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ccpo_gfp_simp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">rule</span> ccpo.fixp_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> is_dual_ccpo<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Continuity and Kleene Fixed Point Theorem›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cont</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">C</span><span class="main">.</span> <span class="bound">C</span><span class="main">≠</span><span class="main">{}</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Sup <span class="bound">C</span><span class="main">)</span> <span class="main">=</span> Sup <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">`</span><span class="bound">C</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">strict</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> bot <span class="main">=</span> bot"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inf_distrib</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> strict <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∧</span> cont <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> contI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="bound">C</span><span class="main">≠</span><span class="main">{}</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span>Sup <span class="bound">C</span><span class="main">)</span> <span class="main">=</span> Sup <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="bound">C</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> cont <span class="free">f</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> cont_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> contD<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span> <span class="main">⟹</span> <span class="free">C</span><span class="main">≠</span><span class="main">{}</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span>Sup <span class="free">C</span><span class="main">)</span> <span class="main">=</span> Sup <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cont_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> contD'<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span> <span class="main">⟹</span> <span class="free">C</span><span class="main">≠</span><span class="main">{}</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span>Sup <span class="free">C</span><span class="main">)</span> <span class="main">=</span> Sup <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> contD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> strictD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strict <span class="free">f</span> <span class="main">⟹</span> <span class="free">f</span> bot <span class="main">=</span> bot"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> strict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="comment1">― ‹We only add this lemma to the simpset for functions on the same type. 
    Otherwise, the simplifier tries it much too often.›</span>
<span class="keyword1"><span class="command">lemma</span></span> strictD_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strict <span class="free">f</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span>bot<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>bot<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>bot<span class="main">::</span><span class="tfree">'a</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> strict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> strictI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> bot <span class="main">=</span> bot <span class="main">⟹</span> strict <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> inf_distribD<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"inf_distrib <span class="free">f</span> <span class="main">⟹</span> strict <span class="free">f</span>"</span></span>
  <span class="quoted"><span class="quoted">"inf_distrib <span class="free">f</span> <span class="main">⟹</span> cont <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inf_distrib_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> inf_distribI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>strict <span class="free">f</span><span class="main">;</span> cont <span class="free">f</span><span class="main">⟧</span> <span class="main">⟹</span> inf_distrib <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inf_distrib_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> inf_distribD'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inf_distrib <span class="free">f</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span>Sup <span class="free">C</span><span class="main">)</span> <span class="main">=</span> Sup <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">=</span><span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> inf_distribD contD'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> inf_distribI'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>Sup <span class="bound">C</span><span class="main">)</span> <span class="main">=</span> Sup <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="bound">C</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inf_distrib <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> B<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> B<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> cont_is_mono<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span> <span class="main">⟹</span> mono <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monoI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="improper">x</span><span class="main">,</span><span class="improper">y</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> contD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_iff_sup<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> inf_distrib_is_mono<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inf_distrib <span class="free">f</span> <span class="main">⟹</span> mono <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Only proven for complete lattices here. Also holds for CCPOs.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gen_kleene_lfp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> CONT<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lfp <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sup <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="bound">i</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sup <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?K</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="bound">i</span><span class="main">)</span> <span class="free">m</span> <span class="main">|</span> <span class="bound">i</span> <span class="main">.</span> True<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> MONO<span class="main">=</span>cont_is_mono<span class="main">[</span><span class="operator">OF</span> CONT<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> MONO'<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span> <span class="main">=</span> monoD<span class="main">[</span><span class="operator">OF</span> MONO<span class="main">]</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="skolem">i</span><span class="main">)</span> <span class="free">m</span> <span class="main">≤</span> lfp <span class="var">?f</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lfp_unfold<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> MONO' monoI order_mono_setup.refl sup_mono<span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lfp_unfold<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> MONO' monoI order_mono_setup.refl sup_mono<span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> MONO' le_supI2<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="bound">i</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span> <span class="main">≤</span> lfp <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> SUP_least<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sup <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lfp <span class="var">?f</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="bound">i</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lfp_lowerbound<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sup_least<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ SUP_upper<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="main">0</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> contD <span class="main"><span class="main">[</span></span><span class="operator">OF</span> CONT<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_subset_mono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> range_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> kleene_lfp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> CONT<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lfp <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="bound">i</span><span class="main">)</span> bot<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gen_kleene_lfp<span class="main">[</span><span class="operator">OF</span> CONT<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted">bot</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="comment1">(* Detailed proof *)</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> CONT<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lfp <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="bound">i</span><span class="main">)</span> bot<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?K</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="bound">i</span><span class="main">)</span> bot <span class="main">|</span> <span class="bound">i</span> <span class="main">.</span> True<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> MONO<span class="main">=</span>cont_is_mono<span class="main">[</span><span class="operator">OF</span> CONT<span class="main">]</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="skolem">i</span><span class="main">)</span> bot <span class="main">≤</span> lfp <span class="free">f</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> MONO lfp_unfold monoD<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="bound">i</span><span class="main">)</span> bot<span class="main">)</span> <span class="main">≤</span> lfp <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> SUP_least<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lfp <span class="free">f</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="bound">i</span><span class="main">)</span> bot<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lfp_lowerbound<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> contD <span class="main"><span class="main">[</span></span><span class="operator">OF</span> CONT<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_subset_mono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> range_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Alternative proof of gen_kleene_lfp that re-uses standard Kleene, but is more tedious *)</span>
<span class="keyword1"><span class="command">lemma</span></span> SUP_funpow_contracting<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>complete_lattice<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="bound">i</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="bound">i</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="bound">i</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="bound">i</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> contD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="bound">i</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SUP_least<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> 1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SUP_upper<span class="main">)</span>
    <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_kleene_chain_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="bound">i</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sup <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">^^</span><span class="bound">i</span><span class="main">)</span> bot<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sup <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> antisym SUP_least<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> C <span class="keyword1"><span class="command">have</span></span> C'<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="var">?f'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> cont_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SUP_sup_distrib<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">m</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="var">?f'</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> bot<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ SUP_upper<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="main">1</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> cont_is_mono<span class="main">[</span><span class="operator">OF</span> C<span class="main">,</span> <span class="operator">THEN</span> monoD<span class="main">,</span> <span class="operator">OF</span> Suc<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sup <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> bot<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> sup <span class="free">m</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> SUP_funpow_contracting<span class="main">[</span><span class="operator">OF</span> C'<span class="main">]</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f'</span><span class="main">^^</span><span class="skolem">i</span><span class="main">)</span> bot <span class="main">≤</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="bound">i</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> monoD<span class="main">[</span><span class="operator">OF</span> cont_is_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span> Suc<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f'</span><span class="main">^^</span>Suc <span class="skolem">i</span><span class="main">)</span> bot <span class="main">≤</span> sup <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_supI2<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sup_least<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ SUP_upper<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="main">0</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SUP_funpow_contracting<span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
   
<span class="keyword1"><span class="command">theorem</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lfp <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sup <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="bound">i</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> gen_kleene_chain_conv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> kleene_lfp<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> C
    <span class="keyword1"><span class="command">unfolding</span></span> cont_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SUP_sup_distrib<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> galois_connection<span class="main">)</span> dual_inf_dist_γ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">(</span>Inf <span class="free">C</span><span class="main">)</span> <span class="main">=</span> Inf <span class="main">(</span><span class="free">γ</span><span class="main">`</span><span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Inf_greatest<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> γ_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Inf_lower<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> galois<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Inf_greatest<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> galois<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Inf_lower<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> galois_connection<span class="main">)</span> inf_dist_α<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_distrib <span class="free">α</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inf_distribI'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> galois<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> galois<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_upper<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> α_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_upper<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Maps›</span></span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Key-Value Set›</span></span>
  
  <span class="keyword1"><span class="command">lemma</span></span> map_to_set_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"map_to_set Map.empty <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="quoted"><span class="quoted">"map_to_set <span class="main">[</span><span class="free">a</span><span class="main">↦</span><span class="free">b</span><span class="main">]</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"map_to_set <span class="main">(</span><span class="free">m</span><span class="main">|`</span><span class="free">K</span><span class="main">)</span> <span class="main">=</span> map_to_set <span class="free">m</span> <span class="main">∩</span> <span class="free">K</span><span class="main">×</span>UNIV"</span></span>
    <span class="quoted"><span class="quoted">"map_to_set <span class="main">(</span><span class="free">m</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span>None<span class="main">)</span><span class="main">)</span> <span class="main">=</span> map_to_set <span class="free">m</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">×</span>UNIV"</span></span>
    <span class="quoted"><span class="quoted">"map_to_set <span class="main">(</span><span class="free">m</span><span class="main">(</span><span class="free">x</span><span class="main">↦</span><span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map_to_set <span class="free">m</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">×</span>UNIV <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"map_to_set <span class="free">m</span> <span class="main">∩</span> dom <span class="free">m</span><span class="main">×</span>UNIV <span class="main">=</span> map_to_set <span class="free">m</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span>map_to_set <span class="free">m</span>"</span></span>
    <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span>map_to_set <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_to_set_def restrict_map_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> single_valuedI<span class="main">)</span>
      
  <span class="keyword1"><span class="command">lemma</span></span> map_to_set_inj<span class="main">:</span>     
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span>map_to_set <span class="free">m</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span><span class="main">∈</span>map_to_set <span class="free">m</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_to_set_def<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="RefineG_Transfer">
<div class="head">
<h1>Theory RefineG_Transfer</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Transfer between Domains›</span></span>
<span class="keyword1"><span class="command">theory</span></span> RefineG_Transfer
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Refine_Misc.html">../Refine_Misc</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Currently, this theory is specialized to 
    transfers that include no data refinement.
›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">REFINEG_TRANSFER_POST_SIMP</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">REFINEG_TRANSFER_ALIGN</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">==</span> True"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> REFINEG_TRANSFER_ALIGNI<span class="main">:</span> <span class="quoted"><span class="quoted">"REFINEG_TRANSFER_ALIGN <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> START_REFINEG_TRANSFER<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"REFINEG_TRANSFER_ALIGN <span class="free">d</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">≤</span><span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"REFINEG_TRANSFER_POST_SIMP <span class="free">c</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">≤</span><span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> REFINEG_TRANSFER_POST_SIMP_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> STOP_REFINEG_TRANSFER<span class="main">:</span> <span class="quoted"><span class="quoted">"REFINEG_TRANSFER_POST_SIMP <span class="free">c</span> <span class="free">c</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> REFINEG_TRANSFER_POST_SIMP_def <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">RefineG_Transfer</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Post_Processors</span> <span class="main">=</span> Theory_Data <span class="main">(</span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span><span class="main">)</span> Symtab.table
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> Symtab.empty
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">merge</span> <span class="main">=</span> Symtab.join <span class="main">(</span>K snd<span class="main">)</span>
  <span class="main">)</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_post_processor</span> <span class="entity">name</span> <span class="entity">tac</span> <span class="main">=</span>
    Post_Processors.map <span class="main">(</span>Symtab.update_new <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">tac</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">delete_post_processor</span> <span class="entity">name</span> <span class="main">=</span>
    Post_Processors.map <span class="main">(</span>Symtab.delete <span class="entity">name</span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">get_post_processors</span> <span class="main">=</span> Post_Processors.get #&gt; Symtab.dest

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">post_process_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tacs</span> <span class="main">=</span> <span class="entity">get_post_processors</span> <span class="main">(</span>Proof_Context.theory_of <span class="entity">ctxt</span><span class="main">)</span>
      |&gt; map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">tac</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">tac</span> <span class="entity">ctxt</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tac</span> <span class="main">=</span> <span class="entity">REPEAT_DETERM'</span> <span class="main">(</span>CHANGED o EVERY' <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> TRY o <span class="entity">t</span><span class="main">)</span> <span class="entity">tacs</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">tac</span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Post_Simp</span> <span class="main">=</span> Generic_Data <span class="main">(</span>
      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> simpset
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> <span class="entity">HOL_basic_ss</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">merge</span> <span class="main">=</span> Raw_Simplifier.merge_ss
  <span class="main">)</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">post_simps_op</span> <span class="entity">f</span> <span class="entity">a</span> <span class="entity">context</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Context.proof_of <span class="entity">context</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">do_it</span> <span class="entity">ss</span> <span class="main">=</span> simpset_of <span class="main">(</span><span class="entity">f</span> <span class="main">(</span>put_simpset <span class="entity">ss</span> <span class="entity">ctxt</span><span class="main">,</span> <span class="entity">a</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    Post_Simp.map <span class="entity">do_it</span> <span class="entity">context</span>
  <span class="keyword2"><span class="keyword">end</span></span>
    
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">add_post_simps</span> <span class="main">=</span> <span class="entity">post_simps_op</span> <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> addsimps<span class="main">)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">del_post_simps</span> <span class="main">=</span> <span class="entity">post_simps_op</span> <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> delsimps<span class="main">)</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_post_ss</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ss</span> <span class="main">=</span> Post_Simp.get <span class="main">(</span>Context.Proof <span class="entity">ctxt</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> put_simpset <span class="entity">ss</span> <span class="entity">ctxt</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">ctxt</span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">post_subst</span> <span class="main">=</span> <span class="entity">Named_Thms</span>
    <span class="main">(</span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> refine_transfer_post_subst<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Refinement Framework: "</span> ^ 
        <span class="inner_quoted">"Transfer postprocessing substitutions"</span> <span class="main">)</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">post_subst_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">s_thms</span> <span class="main">=</span> <span class="entity">post_subst.get</span> <span class="entity">ctxt</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">dis_tac</span> <span class="main">=</span> <span class="main">(</span>ALLGOALS <span class="main">(</span><span class="entity">Tagged_Solver.solve_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cnv</span> <span class="main">=</span> <span class="entity">Cond_Rewr_Conv.cond_rewrs_conv</span> <span class="entity">dis_tac</span> <span class="entity">s_thms</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ts_conv</span> <span class="main">=</span> Conv.top_sweep_conv <span class="entity">cnv</span> <span class="entity">ctxt</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ss</span> <span class="main">=</span> <span class="entity">get_post_ss</span> <span class="entity">ctxt</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    REPEAT o CHANGED o 
    <span class="main">(</span><span class="entity">Simplifier.simp_tac</span> <span class="entity">ss</span> THEN' CONVERSION <span class="entity">ts_conv</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>


  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">transfer</span> <span class="main">=</span> <span class="entity">Named_Thms</span>
    <span class="main">(</span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> refine_transfer<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Refinement Framework: "</span> ^ 
        <span class="inner_quoted">"Transfer rules"</span> <span class="main">)</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">transfer_tac</span> <span class="entity">thms</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> 
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thms</span> <span class="main">=</span> <span class="entity">thms</span> @ <span class="entity">transfer.get</span> <span class="entity">ctxt</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ss</span> <span class="main">=</span> put_simpset <span class="entity">HOL_basic_ss</span> <span class="entity">ctxt</span> addsimps <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> nested_case_prod_simp<span class="antiquote">}</span></span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    REPEAT_DETERM1 <span class="main">(</span>
      COND <span class="main">(</span>has_fewer_prems <span class="main">(</span>Thm.nprems_of <span class="entity">st</span><span class="main">)</span><span class="main">)</span> no_tac <span class="main">(</span>
        FIRST <span class="main">[</span>
          <span class="entity">Method.assm_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span><span class="main">,</span>
          resolve_tac <span class="entity">ctxt</span> <span class="entity">thms</span> <span class="entity">i</span><span class="main">,</span>
          <span class="entity">Tagged_Solver.solve_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span><span class="main">,</span>
          CHANGED_PROP <span class="main">(</span><span class="entity">simp_tac</span> <span class="entity">ss</span> <span class="entity">i</span><span class="main">)</span><span class="main">]</span>
      <span class="main">)</span><span class="main">)</span> <span class="entity">st</span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="comment1">(* Adjust right term to have same structure as left one *)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">align_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">IF_EXGOAL</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st</span> <span class="main">=&gt;</span>
    <span class="keyword2"><span class="keyword">case</span></span> Logic.concl_of_goal <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> <span class="entity">i</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span>REFINEG_TRANSFER_ALIGN <span class="var">?c</span> <span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">c</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">c</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cT</span> <span class="main">=</span> Thm.ctyp_of_cterm <span class="entity">c</span>
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rl</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> REFINEG_TRANSFER_ALIGNI<span class="antiquote">}</span></span></span>
          |&gt; Thm.incr_indexes <span class="main">(</span>Thm.maxidx_of <span class="entity">st</span> + <span class="inner_numeral">1</span><span class="main">)</span>
          |&gt; Thm.instantiate' <span class="main">[</span>NONE<span class="main">,</span>SOME <span class="entity">cT</span><span class="main">]</span> <span class="main">[</span>NONE<span class="main">,</span>SOME <span class="entity">c</span><span class="main">]</span>
        <span class="comment1">(*val _ = tracing (@{make_string} rl)*)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">rl</span><span class="main">]</span> <span class="entity">i</span> <span class="entity">st</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Seq.empty
  <span class="main">)</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">post_transfer_tac</span> <span class="entity">thms</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> Autoref_Tacticals <span class="keyword2"><span class="keyword">in</span></span>
    resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> START_REFINEG_TRANSFER<span class="antiquote">}</span></span></span> 
    THEN' <span class="entity">align_tac</span> <span class="entity">ctxt</span> 
    THEN' <span class="entity">IF_SOLVED</span> <span class="main">(</span><span class="entity">transfer_tac</span> <span class="entity">thms</span> <span class="entity">ctxt</span><span class="main">)</span>
      <span class="main">(</span><span class="entity">post_process_tac</span> <span class="entity">ctxt</span> THEN' resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> STOP_REFINEG_TRANSFER<span class="antiquote">}</span></span></span><span class="main">)</span>
      <span class="main">(</span>K all_tac<span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_post_simp_rules</span> <span class="entity">context</span> <span class="main">=</span> Context.proof_of <span class="entity">context</span>
      |&gt; <span class="entity">get_post_ss</span>
      |&gt; simpset_of 
      |&gt; Raw_Simplifier.dest_ss
      |&gt; <span class="main">#</span>simps |&gt; map snd


  <span class="keyword2"><span class="keyword">local</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">add_ps</span> <span class="main">=</span> Thm.declaration_attribute <span class="main">(</span><span class="entity">add_post_simps</span> o single<span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">del_ps</span> <span class="main">=</span> Thm.declaration_attribute <span class="main">(</span><span class="entity">del_post_simps</span> o single<span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">setup</span> <span class="main">=</span> I
      #&gt; <span class="entity">add_post_processor</span> <span class="inner_quoted">"RefineG_Transfer.post_subst"</span> <span class="entity">post_subst_tac</span>
      #&gt; <span class="entity">post_subst.setup</span>
      #&gt; <span class="entity">transfer.setup</span>
      #&gt; <span class="entity">Attrib.setup</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> refine_transfer_post_simp<span class="antiquote">}</span></span></span> 
          <span class="main">(</span><span class="entity">Attrib.add_del</span> <span class="entity">add_ps</span> <span class="entity">del_ps</span><span class="main">)</span> 
          <span class="main">(</span><span class="inner_quoted">"declaration of transfer post simplification rules"</span><span class="main">)</span>
      #&gt; Global_Theory.add_thms_dynamic <span class="main">(</span>
           <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> refine_transfer_post_simps<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="entity">get_post_simp_rules</span><span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">RefineG_Transfer.setup</span>›</span>
<span class="keyword1"><span class="command">method_setup</span></span> refine_transfer <span class="main">=</span> 
  <span class="quoted">‹Scan.lift <span class="main">(</span>Args.mode <span class="inner_quoted">"post"</span><span class="main">)</span> -- <span class="entity">Attrib.thms</span> 
  &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">post</span><span class="main">,</span><span class="entity">thms</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span>
    <span class="main">(</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">post</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">RefineG_Transfer.post_transfer_tac</span> <span class="entity">thms</span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">RefineG_Transfer.transfer_tac</span> <span class="entity">thms</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
›</span> <span class="quoted">"Invoke transfer rules"</span>


<span class="keyword1"><span class="command">locale</span></span> transfer <span class="main">=</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>complete_lattice"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In the following, we define some transfer lemmas for general
  HOL - constructs.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> transfer_if<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">⟹</span> <span class="free">α</span> <span class="free">s1</span> <span class="main">≤</span> <span class="free">S1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">b</span> <span class="main">⟹</span> <span class="free">α</span> <span class="free">s2</span> <span class="main">≤</span> <span class="free">S2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">s1</span> <span class="keyword1">else</span> <span class="free">s2</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">S1</span> <span class="keyword1">else</span> <span class="free">S2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> transfer_prod<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">α</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="main">≤</span> <span class="free">F</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">(</span>case_prod <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>case_prod <span class="free">F</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> transfer_Let<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">α</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">F</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">(</span>Let <span class="free">x</span> <span class="free">f</span><span class="main">)</span> <span class="main">≤</span> Let <span class="free">x</span> <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> transfer_option<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="free">fa</span> <span class="main">≤</span> <span class="free">Fa</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">α</span> <span class="main">(</span><span class="free">fb</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Fb</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">(</span>case_option <span class="free">fa</span> <span class="free">fb</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> case_option <span class="free">Fa</span> <span class="free">Fb</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> transfer_sum<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> <span class="free">α</span> <span class="main">(</span><span class="free">fl</span> <span class="bound">l</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Fl</span> <span class="bound">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="free">α</span> <span class="main">(</span><span class="free">fr</span> <span class="bound">r</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Fr</span> <span class="bound">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">(</span>case_sum <span class="free">fl</span> <span class="free">fr</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>case_sum <span class="free">Fl</span> <span class="free">Fr</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> transfer_list<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="free">fn</span> <span class="main">≤</span> <span class="free">Fn</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="free">α</span> <span class="main">(</span><span class="free">fc</span> <span class="bound">x</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Fc</span> <span class="bound">x</span> <span class="bound">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">(</span>case_list <span class="free">fn</span> <span class="free">fc</span> <span class="free">l</span><span class="main">)</span> <span class="main">≤</span> case_list <span class="free">Fn</span> <span class="free">Fc</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> transfer_rec_list<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">α</span> <span class="main">(</span><span class="free">fn</span> <span class="bound">s</span><span class="main">)</span> <span class="main">≤</span> <span class="free">fn'</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">l</span> <span class="bound">rec</span> <span class="bound">rec'</span> <span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">α</span> <span class="main">(</span><span class="bound">rec</span> <span class="bound">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="bound">rec'</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">α</span> <span class="main">(</span><span class="free">fc</span> <span class="bound">x</span> <span class="bound">l</span> <span class="bound">rec</span> <span class="bound">s</span><span class="main">)</span> <span class="main">≤</span> <span class="free">fc'</span> <span class="bound">x</span> <span class="bound">l</span> <span class="bound">rec'</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">(</span>rec_list <span class="free">fn</span> <span class="free">fc</span> <span class="free">l</span> <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> rec_list <span class="free">fn'</span> <span class="free">fc'</span> <span class="free">l</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FN<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FC<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> transfer_rec_nat<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">α</span> <span class="main">(</span><span class="free">fn</span> <span class="bound">s</span><span class="main">)</span> <span class="main">≤</span> <span class="free">fn'</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">rec</span> <span class="bound">rec'</span> <span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">α</span> <span class="main">(</span><span class="bound">rec</span> <span class="bound">s</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">rec'</span> <span class="bound">s</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">α</span> <span class="main">(</span><span class="free">fs</span> <span class="bound">n</span> <span class="bound">rec</span> <span class="bound">s</span><span class="main">)</span> <span class="main">≤</span> <span class="free">fs'</span> <span class="bound">n</span> <span class="bound">rec'</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">(</span>rec_nat <span class="free">fn</span> <span class="free">fs</span> <span class="free">n</span> <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> rec_nat <span class="free">fn'</span> <span class="free">fs'</span> <span class="free">n</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FN<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FC<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Transfer into complete lattice structure›</span></span>
<span class="keyword1"><span class="command">locale</span></span> ordered_transfer <span class="main">=</span> transfer <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">constrains</span></span> α <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>complete_lattice"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Transfer into complete lattice structure with distributive
  transfer function.›</span></span>
<span class="keyword1"><span class="command">locale</span></span> dist_transfer <span class="main">=</span> ordered_transfer <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">constrains</span></span> α <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>complete_lattice"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> α_dist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> is_chain <span class="bound">A</span> <span class="main">⟹</span> <span class="free">α</span> <span class="main">(</span>Sup <span class="bound">A</span><span class="main">)</span> <span class="main">=</span> Sup <span class="main">(</span><span class="free">α</span><span class="main">`</span><span class="bound">A</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> α_mono<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">α</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"is_chain <span class="main">{</span><span class="improper">x</span><span class="main">,</span><span class="improper">y</span><span class="main">}</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> α_dist<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_iff_sup<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> chainI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">lemma</span></span> α_strict<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> bot <span class="main">=</span> bot"</span></span>
    <span class="keyword1"><span class="command">using</span></span> α_dist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Transfer into ccpo›</span></span>
<span class="keyword1"><span class="command">locale</span></span> ccpo_transfer <span class="main">=</span> transfer <span class="quoted"><span class="free">α</span></span> <span class="keyword2"><span class="keyword">for</span></span>
  <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span><span class="main">::</span>ccpo <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>complete_lattice"</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Transfer into ccpo with distributive
  transfer function.›</span></span>
<span class="keyword1"><span class="command">locale</span></span> dist_ccpo_transfer <span class="main">=</span> ccpo_transfer <span class="quoted"><span class="free">α</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span><span class="main">::</span>ccpo <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>complete_lattice"</span></span> <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> α_dist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> is_chain <span class="bound">A</span> <span class="main">⟹</span> <span class="free">α</span> <span class="main">(</span>Sup <span class="bound">A</span><span class="main">)</span> <span class="main">=</span> Sup <span class="main">(</span><span class="free">α</span><span class="main">`</span><span class="bound">A</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> α_mono<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">α</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'c</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> LE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">≤</span><span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> C<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_chain <span class="main">{</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> chainI<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> LE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="skolem">x</span> <span class="main">≤</span> sup <span class="main">(</span><span class="free">α</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">α</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Sup <span class="main">(</span><span class="free">α</span><span class="main">`</span><span class="main">{</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">α</span> <span class="main">(</span>Sup <span class="main">{</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> α_dist<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup <span class="main">{</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccpo_Sup_least<span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> LE <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccpo_Sup_upper<span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">α</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> α_strict<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">(</span>Sup <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> bot"</span></span>
    <span class="keyword1"><span class="command">using</span></span> α_dist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="RefineG_Domain">
<div class="head">
<h1>Theory RefineG_Domain</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹General Domain Theory›</span></span>
<span class="keyword1"><span class="command">theory</span></span> RefineG_Domain
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Refine_Misc.html">../Refine_Misc</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹General Order Theory Tools›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> chain_f_apply<span class="main">:</span> <span class="quoted"><span class="quoted">"Complete_Partial_Order.chain <span class="main">(</span>fun_ord <span class="free">le</span><span class="main">)</span> <span class="free">F</span>
    <span class="main">⟹</span> Complete_Partial_Order.chain <span class="free">le</span> <span class="main">{</span><span class="bound">y</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">f</span><span class="main">∈</span><span class="free">F</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">f</span> <span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Complete_Partial_Order.chain_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_ord_def<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> ccpo_lift<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"class.ccpo <span class="free">lub</span> <span class="free">le</span> <span class="free">lt</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"class.ccpo <span class="main">(</span>fun_lub <span class="free">lub</span><span class="main">)</span> <span class="main">(</span>fun_ord <span class="free">le</span><span class="main">)</span> <span class="main">(</span>mk_less <span class="main">(</span>fun_ord <span class="free">le</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">interpret</span></span> ccpo<span class="main">:</span> ccpo <span class="quoted"><span class="free">lub</span></span> <span class="quoted"><span class="free">le</span></span> <span class="quoted"><span class="free">lt</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mk_less_def fun_ord_def fun_lub_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> ccpo.order_trans <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">using</span></span> ccpo.antisym <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">using</span></span> ccpo.ccpo_Sup_upper <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> chain_f_apply<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> ccpo.ccpo_Sup_least <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> chain_f_apply<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="comment1">(* TODO: Move *)</span>
  <span class="keyword1"><span class="command">lemma</span></span> fun_lub_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"fun_lub <span class="free">lub</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">lub</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"fun_lub <span class="free">lub</span> <span class="main">{</span><span class="free">f</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">lub</span> <span class="main">{</span><span class="free">f</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fun_lub_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Flat Ordering›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> flat_ord_chain_cases<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"Complete_Partial_Order.chain <span class="main">(</span>flat_ord <span class="free">b</span><span class="main">)</span> <span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">=</span><span class="main">{}</span>"</span></span> 
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">=</span><span class="main">{</span><span class="free">b</span><span class="main">}</span>"</span></span> 
    <span class="main">|</span> <span class="free">x</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">≠</span><span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">=</span><span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> 
    <span class="main">|</span> <span class="free">x</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">≠</span><span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">=</span><span class="main">{</span><span class="free">b</span><span class="main">,</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m1</span> <span class="bound">m2</span><span class="main">.</span> <span class="free">C</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">m1</span><span class="main">,</span><span class="bound">m2</span><span class="main">}</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">m1</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∨</span> <span class="bound">m2</span> <span class="main">=</span> <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m1</span> <span class="bound">m2</span><span class="main">.</span> <span class="free">C</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">m1</span><span class="main">,</span> <span class="bound">m2</span><span class="main">}</span> <span class="main">⟶</span> <span class="bound">m1</span><span class="main">≠</span><span class="free">b</span> <span class="main">∧</span> <span class="bound">m2</span><span class="main">≠</span><span class="free">b</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m1</span></span> <span class="skolem"><span class="skolem">m2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m1</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m2</span><span class="main">∈</span><span class="free">C</span>"</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">m1</span><span class="main">≠</span><span class="skolem">m2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m1</span><span class="main">≠</span><span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m2</span><span class="main">≠</span><span class="free">b</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">unfolding</span></span> Complete_Partial_Order.chain_def flat_ord_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> <span class="main">{</span><span class="skolem">m</span><span class="main">,</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">=</span><span class="free">b</span>"</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
    
  <span class="keyword1"><span class="command">lemma</span></span> flat_lub_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"flat_lub <span class="free">b</span> <span class="main">{}</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
    <span class="quoted"><span class="quoted">"flat_lub <span class="free">b</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"flat_lub <span class="free">b</span> <span class="main">(</span>insert <span class="free">b</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> flat_lub <span class="free">b</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> flat_lub_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">lemma</span></span> flat_ord_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"flat_ord <span class="free">b</span> <span class="free">b</span> <span class="free">x</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flat_ord_def<span class="main">)</span>

  <span class="keyword1"><span class="command">interpretation</span></span> flat_ord<span class="main">:</span> ccpo <span class="quoted"><span class="quoted">"flat_lub <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"flat_ord <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"mk_less <span class="main">(</span>flat_ord <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mk_less_def flat_ord_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> flat_ord_chain_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> flat_ord_chain_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">interpretation</span></span> flat_le_mono_setup<span class="main">:</span> mono_setup_loc <span class="quoted"><span class="quoted">"flat_ord <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Flat function Ordering›</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">flatf_ord</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">==</span> fun_ord <span class="main">(</span>flat_ord <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">flatf_lub</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">==</span> fun_lub <span class="main">(</span>flat_lub <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">interpretation</span></span> flatf_ord<span class="main">:</span> ccpo <span class="quoted"><span class="quoted">"flatf_lub <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"flatf_ord <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"mk_less <span class="main">(</span>flatf_ord <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccpo_lift<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Fixed Points in Flat Ordering›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    Fixed points in a flat ordering are used to express recursion.
    The bottom element is interpreted as non-termination.
›</span></span>  

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">flat_mono</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">==</span> monotone <span class="main">(</span>flat_ord <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>flat_ord <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">flatf_mono</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">==</span> monotone <span class="main">(</span>flatf_ord <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>flatf_ord <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">flatf_fp</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> flatf_ord.fixp <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> flatf_fp_mono<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span>
    <span class="comment1">― ‹The fixed point combinator is monotonic›</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"flatf_mono <span class="free">b</span> <span class="free">f</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"flatf_mono <span class="free">b</span> <span class="free">g</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Z</span> <span class="bound">x</span><span class="main">.</span> flat_ord <span class="free">b</span> <span class="main">(</span><span class="free">f</span> <span class="bound">Z</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">Z</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flat_ord <span class="free">b</span> <span class="main">(</span>flatf_fp <span class="free">b</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>flatf_fp <span class="free">b</span> <span class="free">g</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flatf_ord <span class="free">b</span> <span class="main">(</span>flatf_fp <span class="free">b</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>flatf_fp <span class="free">b</span> <span class="free">g</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> flatf_ord.fixp_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_ord_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fun_ord_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> flatf_admissible_pointwise<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟹</span> 
      ccpo.admissible <span class="main">(</span>flatf_lub <span class="free">b</span><span class="main">)</span> <span class="main">(</span>flatf_ord <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">(</span><span class="bound">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ccpo.admissibleI allI impI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> chain_f_apply<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> flat_ord_chain_cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_lub_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_lub_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_lub_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    If a property is defined pointwise, and holds for the bottom element,
    we can use fixed-point induction for it. 

    In the induction step, we can assume that the function is less or equal
    to the fixed-point.

    This rule covers refinement and transfer properties, 
    such as: Refinement of fixed-point combinators and transfer of 
    fixed-point combinators to different domains.
›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> flatf_fp_induct_pointwise<span class="main">:</span>
    <span class="comment1">― ‹Fixed-point induction for pointwise properties›</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> cond_bot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">x</span><span class="main">.</span> <span class="free">pre</span> <span class="bound">a</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">post</span> <span class="bound">a</span> <span class="bound">x</span> <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> MONO<span class="main">:</span> <span class="quoted"><span class="quoted">"flatf_mono <span class="free">b</span> <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> PRE0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="free">a</span> <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> STEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">a</span> <span class="bound">x</span><span class="main">.</span> 
      <span class="main">⟦</span><span class="main">⋀</span><span class="bound">a'</span> <span class="bound">x'</span><span class="main">.</span> <span class="free">pre</span> <span class="bound">a'</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="free">post</span> <span class="bound">a'</span> <span class="bound">x'</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x'</span><span class="main">)</span><span class="main">;</span> <span class="free">pre</span> <span class="bound">a</span> <span class="bound">x</span><span class="main">;</span> 
        flatf_ord <span class="free">b</span> <span class="bound">f</span> <span class="main">(</span>flatf_fp <span class="free">b</span> <span class="free">B</span><span class="main">)</span> <span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="free">post</span> <span class="bound">a</span> <span class="bound">x</span> <span class="main">(</span><span class="free">B</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">post</span> <span class="free">a</span> <span class="free">x</span> <span class="main">(</span>flatf_fp <span class="free">b</span> <span class="free">B</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ub</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ub</span> <span class="main">=</span> flatf_fp <span class="free">b</span> <span class="free">B</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">a</span><span class="main">.</span> <span class="free">pre</span> <span class="bound">a</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">post</span> <span class="bound">a</span> <span class="bound">x</span> <span class="main">(</span>flatf_fp <span class="free">b</span> <span class="free">B</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">∧</span> flatf_ord <span class="free">b</span> <span class="main">(</span>flatf_fp <span class="free">b</span> <span class="free">B</span><span class="main">)</span> <span class="skolem">ub</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> flatf_ord.fixp_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ MONO<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> admissible_conj<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> flatf_admissible_pointwise<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cond_bot<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccpo.admissibleI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> flatf_ord.ccpo_Sup_least<span class="main">)</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cond_bot <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_ord_def flat_ord_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> ub_def

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> STEP<span class="main">)</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> flatf_ord.fixp_unfold<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MONO<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> monotoneD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MONO<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">with</span></span> PRE0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    The next rule covers transfer between fixed points.
    It allows to lift a pointwise transfer condition 
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P x y ⟶ tr (f x) (f y)›</span></span></span></span> to fixed points.
    Note that one of the fixed points may be an arbitrary fixed point.
›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> flatf_fixp_transfer<span class="main">:</span>
    <span class="comment1">― ‹Transfer rule for fixed points›</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> TR_BOT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x'</span><span class="main">.</span> <span class="free">tr</span> <span class="free">b</span> <span class="bound">x'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> MONO<span class="main">:</span> <span class="quoted"><span class="quoted">"flatf_mono <span class="free">b</span> <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> FP'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fp'</span> <span class="main">=</span> <span class="free">B'</span> <span class="free">fp'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="free">x'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> RS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">f'</span> <span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span>
       <span class="main">⟦</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="free">tr</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">f'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">;</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">x'</span><span class="main">;</span> <span class="free">fp'</span> <span class="main">=</span> <span class="bound">f'</span><span class="main">⟧</span>
       <span class="main">⟹</span> <span class="free">tr</span> <span class="main">(</span><span class="free">B</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">B'</span> <span class="bound">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">tr</span> <span class="main">(</span>flatf_fp <span class="free">b</span> <span class="free">B</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">fp'</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> flatf_fp_induct_pointwise<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pre<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ MONO<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> R0<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> FP'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> RS<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Relation of Flat Ordering to Complete Lattices›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    In this section, we establish the relation between flat orderings 
    and complete lattices. This relation is exploited to show properties
    of fixed points wrt. a refinement ordering.
›</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">flat_le</span> <span class="main">≡</span> flat_ord bot"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">flat_ge</span> <span class="main">≡</span> flat_ord top"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">flatf_le</span> <span class="main">≡</span> flatf_ord bot"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">flatf_ge</span> <span class="main">≡</span> flatf_ord top"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The flat ordering implies the lattice ordering›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> flat_ord_compat<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> complete_lattice"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"flat_le <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
    <span class="quoted"><span class="quoted">"flat_ge <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≥</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> flat_ord_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">lemma</span></span> flatf_ord_compat<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">::</span> complete_lattice<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"flatf_le <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
    <span class="quoted"><span class="quoted">"flatf_ge <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≥</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> flat_ord_compat le_fun_def fun_ord_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">flat_mono_le</span> <span class="main">≡</span> flat_mono bot"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">flat_mono_ge</span> <span class="main">≡</span> flat_mono top"</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">flatf_mono_le</span> <span class="main">≡</span> flatf_mono bot"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">flatf_mono_ge</span> <span class="main">≡</span> flatf_mono top"</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">flatf_gfp</span> <span class="main">≡</span> flatf_ord.fixp top"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">flatf_lfp</span> <span class="main">≡</span> flatf_ord.fixp bot"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If a functor is monotonic wrt. both the flat and the 
    lattice ordering, the fixed points wrt. these orderings coincide. 
›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> lfp_eq_flatf_lfp<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> FM<span class="main">:</span> <span class="quoted"><span class="quoted">"flatf_mono_le <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lfp <span class="free">B</span> <span class="main">=</span> flatf_lfp <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> lfp_unfold<span class="main">[</span><span class="operator">OF</span> M<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">(</span>lfp <span class="free">B</span><span class="main">)</span> <span class="main">=</span> lfp <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"flatf_le <span class="main">(</span><span class="free">B</span> <span class="main">(</span>lfp <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lfp <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> flatf_ord.fixp_lowerbound<span class="main">[</span><span class="operator">OF</span> FM<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flatf_le <span class="main">(</span>flatf_lfp <span class="free">B</span><span class="main">)</span> <span class="main">(</span>lfp <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">with</span></span> flatf_ord_compat <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flatf_lfp <span class="free">B</span> <span class="main">≤</span> lfp <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">from</span></span> flatf_ord.fixp_unfold<span class="main">[</span><span class="operator">OF</span> FM<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">(</span>flatf_lfp <span class="free">B</span><span class="main">)</span> <span class="main">=</span> flatf_lfp <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">(</span>flatf_lfp <span class="free">B</span><span class="main">)</span> <span class="main">≤</span> flatf_lfp <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> lfp_lowerbound<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"flatf_lfp <span class="free">B</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lfp <span class="free">B</span> <span class="main">≤</span> flatf_lfp <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lfp <span class="free">B</span> <span class="main">=</span> flatf_lfp <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> gfp_eq_flatf_gfp<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> FM<span class="main">:</span> <span class="quoted"><span class="quoted">"flatf_mono_ge <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gfp <span class="free">B</span> <span class="main">=</span> flatf_gfp <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> gfp_unfold<span class="main">[</span><span class="operator">OF</span> M<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">(</span>gfp <span class="free">B</span><span class="main">)</span> <span class="main">=</span> gfp <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"flatf_ge <span class="main">(</span><span class="free">B</span> <span class="main">(</span>gfp <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>gfp <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> flatf_ord.fixp_lowerbound<span class="main">[</span><span class="operator">OF</span> FM<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flatf_ge <span class="main">(</span>flatf_gfp <span class="free">B</span><span class="main">)</span> <span class="main">(</span>gfp <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">with</span></span> flatf_ord_compat <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gfp <span class="free">B</span> <span class="main">≤</span> flatf_gfp <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">from</span></span> flatf_ord.fixp_unfold<span class="main">[</span><span class="operator">OF</span> FM<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">(</span>flatf_gfp <span class="free">B</span><span class="main">)</span> <span class="main">=</span> flatf_gfp <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"flatf_gfp <span class="free">B</span> <span class="main">≤</span> <span class="free">B</span> <span class="main">(</span>flatf_gfp <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> gfp_upperbound<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"flatf_gfp <span class="free">B</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flatf_gfp <span class="free">B</span> <span class="main">≤</span> gfp <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gfp <span class="free">B</span> <span class="main">=</span> flatf_gfp <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  

  <span class="comment1">(* TODO: This belongs to "General Recursion"*)</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    The following lemma provides a well-founded induction scheme for arbitrary 
    fixed point combinators.
›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> wf_fixp_induct<span class="main">:</span>
    <span class="comment1">― ‹Well-Founded induction for arbitrary fixed points›</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> fixp_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fp</span> <span class="free">B</span> <span class="main">=</span> <span class="free">B</span> <span class="main">(</span><span class="free">fp</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">V</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> P0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="free">a</span> <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> STEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">a</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> 
      <span class="main">⋀</span><span class="bound">a'</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">pre</span> <span class="bound">a'</span> <span class="bound">x'</span><span class="main">;</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">V</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">post</span> <span class="bound">a'</span> <span class="bound">x'</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x'</span><span class="main">)</span><span class="main">;</span> <span class="free">fp</span> <span class="free">B</span> <span class="main">=</span> <span class="bound">f</span><span class="main">;</span> <span class="free">pre</span> <span class="bound">a</span> <span class="bound">x</span> 
    <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">post</span> <span class="bound">a</span> <span class="bound">x</span> <span class="main">(</span><span class="free">B</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">post</span> <span class="free">a</span> <span class="free">x</span> <span class="main">(</span><span class="free">fp</span> <span class="free">B</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="free">pre</span> <span class="bound">a</span> <span class="free">x</span> <span class="main">⟶</span> <span class="free">post</span> <span class="bound">a</span> <span class="free">x</span> <span class="main">(</span><span class="free">fp</span> <span class="free">B</span> <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> WF
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_induct_rule<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fixp_unfold<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> STEP<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">with</span></span> P0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>


  <span class="keyword1"><span class="command">lemma</span></span> flatf_lfp_transfer<span class="main">:</span>
    <span class="comment1">― ‹Transfer rule for least fixed points›</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">B</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>order_bot<span class="main">)</span> <span class="main">⇒</span> <span class="main">_</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> TR_BOT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">tr</span> bot <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> MONO<span class="main">:</span> <span class="quoted"><span class="quoted">"flatf_mono_le <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> MONO'<span class="main">:</span> <span class="quoted"><span class="quoted">"flatf_mono_le <span class="free">B'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="free">x'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> RS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">f'</span> <span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span>
       <span class="main">⟦</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="free">tr</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">f'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">;</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">x'</span><span class="main">;</span> flatf_lfp <span class="free">B'</span> <span class="main">=</span> <span class="bound">f'</span><span class="main">⟧</span>
       <span class="main">⟹</span> <span class="free">tr</span> <span class="main">(</span><span class="free">B</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">B'</span> <span class="bound">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">tr</span> <span class="main">(</span>flatf_lfp <span class="free">B</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>flatf_lfp <span class="free">B'</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> flatf_fixp_transfer<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> tr<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">tr</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> fp'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"flatf_lfp <span class="free">B'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">P</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fact</span><span class="main"><span class="keyword3">|</span></span><span class="operator">rule</span> flatf_ord.fixp_unfold<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MONO'<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">lemma</span></span> flatf_gfp_transfer<span class="main">:</span>
    <span class="comment1">― ‹Transfer rule for greatest fixed points›</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">B</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>order_top<span class="main">)</span> <span class="main">⇒</span> <span class="main">_</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> TR_TOP<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">tr</span> <span class="bound">x</span> top"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> MONO<span class="main">:</span> <span class="quoted"><span class="quoted">"flatf_mono_ge <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> MONO'<span class="main">:</span> <span class="quoted"><span class="quoted">"flatf_mono_ge <span class="free">B'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="free">x'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> RS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">f'</span> <span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span>
       <span class="main">⟦</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="free">tr</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">f'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">;</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">x'</span><span class="main">;</span> flatf_gfp <span class="free">B</span> <span class="main">=</span> <span class="bound">f</span><span class="main">⟧</span>
       <span class="main">⟹</span> <span class="free">tr</span> <span class="main">(</span><span class="free">B</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">B'</span> <span class="bound">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">tr</span> <span class="main">(</span>flatf_gfp <span class="free">B</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>flatf_gfp <span class="free">B'</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> flatf_fixp_transfer<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
        tr<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">tr</span> <span class="bound">y</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> fp'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"flatf_gfp <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fact</span><span class="main"><span class="keyword3">|</span></span><span class="operator">assumption</span><span class="main"><span class="keyword3">|</span></span><span class="operator">rule</span> flatf_ord.fixp_unfold<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MONO<span class="main"><span class="main">]</span></span> RS<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">lemma</span></span> meta_le_everything_if_top<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span><span class="main">=</span>top<span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">(</span><span class="free">m</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>order_top<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">lemmas</span></span> flatf_lfp_refine <span class="main">=</span> flatf_lfp_transfer<span class="main">[</span>
    <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> tr <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≤</span> <span class="free">cf</span> <span class="bound">b</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">cf</span><span class="main">,</span> <span class="operator">OF</span> bot_least<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> flatf_gfp_refine <span class="main">=</span> flatf_gfp_transfer<span class="main">[</span>
    <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> tr <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≤</span> <span class="free">cf</span> <span class="bound">b</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">cf</span><span class="main">,</span> <span class="operator">OF</span> meta_le_everything_if_top<span class="main">]</span>


  <span class="keyword1"><span class="command">lemma</span></span> flat_ge_sup_mono<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">a'</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>complete_lattice<span class="main">.</span> 
    flat_ge <span class="bound">a</span> <span class="bound">a'</span> <span class="main">⟹</span> flat_ge <span class="free">b</span> <span class="free">b'</span> <span class="main">⟹</span> flat_ge <span class="main">(</span>sup <span class="bound">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>sup <span class="bound">a'</span> <span class="free">b'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> flat_ord_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">declare</span></span> sup_mono<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span>


<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="RefineG_Recursion">
<div class="head">
<h1>Theory RefineG_Recursion</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Generic Recursion Combinator for Complete Lattice Structured Domains›</span></span>
<span class="keyword1"><span class="command">theory</span></span> RefineG_Recursion
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Refine_Misc.html">../Refine_Misc</a>"</span> <a href="RefineG_Transfer.html">RefineG_Transfer</a> <a href="RefineG_Domain.html">RefineG_Domain</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We define a recursion combinator that asserts monotonicity.
›</span></span>


<span class="comment1">(* TODO: Move to Domain.*)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following lemma allows to compare least fixed points wrt.\ different flat
  orderings. At any point, the fixed points are either equal or have their 
  orderings bottom values.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> fp_compare<span class="main">:</span>
  <span class="comment1">― ‹At any point, fixed points wrt.\ different orderings are either equal, 
    or both bottom.›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M1<span class="main">:</span> <span class="quoted"><span class="quoted">"flatf_mono <span class="free">b1</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> M2<span class="main">:</span> <span class="quoted"><span class="quoted">"flatf_mono <span class="free">b2</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flatf_fp <span class="free">b1</span> <span class="free">B</span> <span class="free">x</span> <span class="main">=</span> flatf_fp <span class="free">b2</span> <span class="free">B</span> <span class="free">x</span> 
    <span class="main">∨</span> <span class="main">(</span>flatf_fp <span class="free">b1</span> <span class="free">B</span> <span class="free">x</span> <span class="main">=</span> <span class="free">b1</span> <span class="main">∧</span> flatf_fp <span class="free">b2</span> <span class="free">B</span> <span class="free">x</span> <span class="main">=</span> <span class="free">b2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> UNF1 <span class="main">=</span> flatf_ord.fixp_unfold<span class="main">[</span><span class="operator">OF</span> M1<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> UNF2 <span class="main">=</span> flatf_ord.fixp_unfold<span class="main">[</span><span class="operator">OF</span> M2<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>

  <span class="keyword1"><span class="command">from</span></span> UNF1 <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"flatf_ord <span class="free">b2</span> <span class="main">(</span><span class="free">B</span> <span class="main">(</span>flatf_fp <span class="free">b1</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>flatf_fp <span class="free">b1</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> UNF2 <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"flatf_ord <span class="free">b1</span> <span class="main">(</span><span class="free">B</span> <span class="main">(</span>flatf_fp <span class="free">b2</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>flatf_fp <span class="free">b2</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> flatf_ord.fixp_lowerbound<span class="main">[</span><span class="operator">OF</span> M2 1<span class="main">]</span> flatf_ord.fixp_lowerbound<span class="main">[</span><span class="operator">OF</span> M1 2<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fun_ord_def flat_ord_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> flat_ord_top<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"flat_ord <span class="free">b</span> <span class="free">b</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flat_ord_def<span class="main">)</span>


<span class="comment1">(* TODO: Move to Domain.*)</span>
<span class="keyword1"><span class="command">lemma</span></span> lfp_gfp_compare<span class="main">:</span>
  <span class="comment1">― ‹Least and greatest fixed point are either equal, or bot and top›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> MLE<span class="main">:</span> <span class="quoted"><span class="quoted">"flatf_mono_le <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> MGE<span class="main">:</span> <span class="quoted"><span class="quoted">"flatf_mono_ge <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flatf_lfp <span class="free">B</span> <span class="free">x</span> <span class="main">=</span> flatf_gfp <span class="free">B</span> <span class="free">x</span> 
    <span class="main">∨</span> <span class="main">(</span>flatf_lfp <span class="free">B</span> <span class="free">x</span> <span class="main">=</span> bot <span class="main">∧</span> flatf_gfp <span class="free">B</span> <span class="free">x</span> <span class="main">=</span> top<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fp_compare<span class="main">[</span><span class="operator">OF</span> MLE MGE<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>


<span class="comment1">(* TODO: Move to Domain *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">trimono</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>bot<span class="main">,</span>order<span class="main">,</span>top<span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">trimono</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="comment1">⌦‹flatf_mono_le B ∧›</span> flatf_mono_ge <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∧</span> mono <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> trimonoI<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>flatf_mono_ge <span class="free">B</span><span class="main">;</span> mono <span class="free">B</span><span class="main">⟧</span> <span class="main">⟹</span> trimono <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trimono_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> trimono_trigger<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">B</span> <span class="main">⟹</span> trimono <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">declaration</span></span> <span class="quoted">‹<span class="entity">Refine_Mono_Prover.declare_mono_triggers</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> trimono_trigger<span class="antiquote">}</span></span></span>›</span>

<span class="comment1">(*lemma trimonoD_flatf_le: "trimono B ⟹ flatf_mono_le B"
  unfolding trimono_def by auto*)</span>

<span class="keyword1"><span class="command">lemma</span></span> trimonoD_flatf_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">B</span> <span class="main">⟹</span> flatf_mono_ge <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trimono_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> trimonoD_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">B</span> <span class="main">⟹</span> mono <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trimono_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> trimonoD <span class="main">=</span> trimonoD_flatf_ge trimonoD_mono

<span class="comment1">(* TODO: Optimize mono-prover to only do derivations once. 
  Will cause problem with higher-order unification on ord - variable! *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">triords</span> <span class="main">≡</span> <span class="main">{</span>flat_ge<span class="main">,</span><span class="main">(≤)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> trimono_alt<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"trimono <span class="free">B</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ord</span><span class="main">∈</span>fun_ord<span class="main">`</span>triords<span class="main">.</span> monotone <span class="bound">ord</span> <span class="bound">ord</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trimono_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ccpo_mono_simp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> triords_def 
    fun_ord_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> le_fun_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trimonoI'<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ord</span><span class="main">.</span> <span class="bound">ord</span><span class="main">∈</span>triords <span class="main">⟹</span> monotone <span class="main">(</span>fun_ord <span class="bound">ord</span><span class="main">)</span> <span class="main">(</span>fun_ord <span class="bound">ord</span><span class="main">)</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trimono <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trimono_alt <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="comment1">(* TODO: Once complete_lattice and ccpo typeclass are unified,
  we should also define a REC-combinator for ccpos! *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">REC</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">REC</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> 
  <span class="keyword1">if</span> <span class="main">(</span>trimono <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>lfp <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>top<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>complete_lattice<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">RECT</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">REC<span class="hidden">⇩</span><sub>T</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">RECT</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> 
  <span class="keyword1">if</span> <span class="main">(</span>trimono <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>flatf_gfp <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>top<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>complete_lattice<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> RECT_gfp_def<span class="main">:</span> <span class="quoted"><span class="quoted">"RECT <span class="free">B</span> <span class="free">x</span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>trimono <span class="free">B</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>gfp <span class="free">B</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>top<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>complete_lattice<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RECT_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gfp_eq_flatf_gfp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> trimonoD_flatf_ge trimonoD_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> REC_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">B</span> <span class="main">⟹</span> REC <span class="free">B</span> <span class="main">=</span> <span class="free">B</span> <span class="main">(</span>REC <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> REC_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lfp_unfold<span class="main"><span class="main">[</span></span><span class="operator">OF</span> trimonoD_mono<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RECT_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>trimono <span class="free">B</span><span class="main">⟧</span> <span class="main">⟹</span> RECT <span class="free">B</span> <span class="main">=</span> <span class="free">B</span> <span class="main">(</span>RECT <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RECT_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flatf_ord.fixp_unfold<span class="main"><span class="main">[</span></span><span class="operator">OF</span> trimonoD_flatf_ge<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> REC_mono<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> LE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">F</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">B</span> <span class="bound">F</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">B'</span> <span class="bound">F</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>REC <span class="free">B</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>REC <span class="free">B'</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> REC_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lfp_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> le_funD<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> LE<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> le_funI<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> RECT_mono<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">B'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> LE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">F</span> <span class="bound">x</span><span class="main">.</span> flat_ge <span class="main">(</span><span class="free">B</span> <span class="bound">F</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">B'</span> <span class="bound">F</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flat_ge <span class="main">(</span>RECT <span class="free">B</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>RECT <span class="free">B'</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RECT_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> flatf_fp_mono<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trimonoD<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> LE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> REC_le_RECT<span class="main">:</span> <span class="quoted"><span class="quoted">"REC <span class="free">body</span> <span class="free">x</span> <span class="main">≤</span> RECT <span class="free">body</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> REC_def RECT_gfp_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"trimono <span class="free">body</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lfp_le_gfp<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> le_funD<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trimonoD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">print_statement</span></span> flatf_fp_induct_pointwise
<span class="keyword1"><span class="command">theorem</span></span> lfp_induct_pointwise<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ADM1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">x</span><span class="main">.</span> chain_admissible <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a</span> <span class="bound">x</span><span class="main">.</span> <span class="free">pre</span> <span class="bound">a</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">post</span> <span class="bound">a</span> <span class="bound">x</span> <span class="main">(</span><span class="bound">b</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ADM2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">x</span><span class="main">.</span> <span class="free">pre</span> <span class="bound">a</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">post</span> <span class="bound">a</span> <span class="bound">x</span> bot"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> MONO<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="free">a</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">a</span> <span class="bound">x</span><span class="main">.</span>
        <span class="main">⟦</span><span class="main">⋀</span><span class="bound">a'</span> <span class="bound">x'</span><span class="main">.</span> <span class="free">pre</span> <span class="bound">a'</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="free">post</span> <span class="bound">a'</span> <span class="bound">x'</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x'</span><span class="main">)</span><span class="main">;</span> <span class="free">pre</span> <span class="bound">a</span> <span class="bound">x</span><span class="main">;</span>
         <span class="bound">f</span> <span class="main">≤</span> <span class="main">(</span>lfp <span class="free">B</span><span class="main">)</span><span class="main">⟧</span>
        <span class="main">⟹</span> <span class="free">post</span> <span class="bound">a</span> <span class="bound">x</span> <span class="main">(</span><span class="free">B</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">post</span> <span class="free">a</span> <span class="free">x</span> <span class="main">(</span>lfp <span class="free">B</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> lfp <span class="free">B</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">≤</span>lfp <span class="free">B</span> <span class="main">⟹</span> <span class="free">B</span> <span class="bound">f</span> <span class="main">≤</span> lfp <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> MONO lfp_unfold monoD<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="bound">x</span><span class="main">.</span> <span class="free">pre</span> <span class="bound">a</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">post</span> <span class="bound">a</span> <span class="bound">x</span> <span class="main">(</span>lfp <span class="free">B</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> lfp <span class="free">B</span> <span class="main">≤</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lfp_cadm_induct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">B</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> admissible_conj<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ADM1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sup_least<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_fun_def ADM2<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI allI impI<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> u_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> IS<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> P0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> REC_rule_arb<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">arb</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'arb</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">body</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="free">arb</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">arb</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span>
    <span class="main">⋀</span><span class="bound">arb'</span> <span class="bound">x</span><span class="main">.</span> <span class="free">pre</span> <span class="bound">arb'</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">arb'</span> <span class="bound">x</span><span class="main">;</span> <span class="free">pre</span> <span class="bound">arb</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">f</span> <span class="main">≤</span> REC <span class="free">body</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">body</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">arb</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"REC <span class="free">body</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="free">arb</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> REC_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lfp_induct_pointwise<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pre<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">pre</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> chain_admissibleI SUP_least<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trimonoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> M<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> I0<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> IS<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> REC_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_funI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_funD<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> RECT_rule_arb<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">body</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span><span class="free">V</span><span class="main">::</span><span class="main">(</span><span class="tfree">'x</span><span class="main">×</span><span class="tfree">'x</span><span class="main">)</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="main">(</span><span class="free">arb</span><span class="main">::</span><span class="tfree">'arb</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">arb</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> 
      <span class="main">⋀</span><span class="bound">arb'</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">pre</span> <span class="bound">arb'</span> <span class="bound">x'</span><span class="main">;</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">V</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="bound">x'</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">arb'</span> <span class="bound">x'</span><span class="main">;</span> 
      <span class="free">pre</span> <span class="bound">arb</span> <span class="bound">x</span><span class="main">;</span>
      RECT <span class="free">body</span> <span class="main">=</span> <span class="bound">f</span>
    <span class="main">⟧</span>  <span class="main">⟹</span> <span class="free">body</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">arb</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RECT <span class="free">body</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="free">arb</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_fixp_induct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> fp<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">RECT</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> pre<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">pre</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">body</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> RECT_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WF<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> IS<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> REC_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">body</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">pre</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">x</span><span class="main">;</span> <span class="free">pre</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">f</span> <span class="main">≤</span> REC <span class="free">body</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">body</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"REC <span class="free">body</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> REC_rule_arb<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pre<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">pre</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
    
    
<span class="keyword1"><span class="command">lemma</span></span> RECT_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">body</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span><span class="free">V</span><span class="main">::</span><span class="main">(</span><span class="tfree">'x</span><span class="main">×</span><span class="tfree">'x</span><span class="main">)</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">pre</span> <span class="bound">x'</span><span class="main">;</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">V</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="bound">x'</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">x'</span><span class="main">;</span> <span class="free">pre</span> <span class="bound">x</span><span class="main">;</span> 
                        RECT <span class="free">body</span> <span class="main">=</span> <span class="bound">f</span>
    <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">body</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RECT <span class="free">body</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> RECT_rule_arb<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pre<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">pre</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>




<span class="comment1">(* TODO: Can we set-up induction method to work with such goals? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> REC_rule_arb2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">body</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="main">(</span><span class="free">arb</span><span class="main">::</span><span class="tfree">'arb</span><span class="main">)</span> <span class="main">(</span><span class="free">arc</span><span class="main">::</span><span class="tfree">'arc</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">arb</span> <span class="bound">arc</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> 
      <span class="main">⋀</span><span class="bound">arb'</span> <span class="bound">arc'</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">pre</span> <span class="bound">arb'</span> <span class="bound">arc'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="bound">x'</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">arb'</span> <span class="bound">arc'</span> <span class="bound">x'</span><span class="main">;</span> 
      <span class="free">pre</span> <span class="bound">arb</span> <span class="bound">arc</span> <span class="bound">x</span>
    <span class="main">⟧</span>  <span class="main">⟹</span> <span class="free">body</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">arb</span> <span class="bound">arc</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"REC <span class="free">body</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="free">arb</span> <span class="free">arc</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> REC_rule_arb<span class="main"><span class="main">[</span></span>
    <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pre<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"case_prod <span class="free">pre</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"case_prod <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> arb<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">arb</span><span class="main">,</span> <span class="free">arc</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span> 
    <span class="operator">OF</span> M<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> REC_rule_arb3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">body</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="main">(</span><span class="free">arb</span><span class="main">::</span><span class="tfree">'arb</span><span class="main">)</span> <span class="main">(</span><span class="free">arc</span><span class="main">::</span><span class="tfree">'arc</span><span class="main">)</span> <span class="main">(</span><span class="free">ard</span><span class="main">::</span><span class="tfree">'ard</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">arb</span> <span class="bound">arc</span> <span class="bound">ard</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> 
      <span class="main">⋀</span><span class="bound">arb'</span> <span class="bound">arc'</span> <span class="bound">ard'</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">pre</span> <span class="bound">arb'</span> <span class="bound">arc'</span> <span class="bound">ard'</span> <span class="bound">x'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="bound">x'</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">arb'</span> <span class="bound">arc'</span> <span class="bound">ard'</span> <span class="bound">x'</span><span class="main">;</span>
      <span class="free">pre</span> <span class="bound">arb</span> <span class="bound">arc</span> <span class="bound">ard</span> <span class="bound">x</span> 
    <span class="main">⟧</span>  <span class="main">⟹</span> <span class="free">body</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">arb</span> <span class="bound">arc</span> <span class="bound">ard</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"REC <span class="free">body</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="free">arb</span> <span class="free">arc</span> <span class="free">ard</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> REC_rule_arb2<span class="main"><span class="main">[</span></span>
    <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pre<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"case_prod <span class="free">pre</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"case_prod <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> arb<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">arb</span><span class="main">,</span> <span class="free">arc</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> arc<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">ard</span>"</span></span><span class="main"><span class="main">,</span></span> 
    <span class="operator">OF</span> M<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RECT_rule_arb2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">body</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span><span class="free">V</span><span class="main">::</span><span class="tfree">'x</span> rel<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="main">(</span><span class="free">arb</span><span class="main">::</span><span class="tfree">'arb</span><span class="main">)</span> <span class="main">(</span><span class="free">arc</span><span class="main">::</span><span class="tfree">'arc</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">arb</span> <span class="bound">arc</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> 
      <span class="main">⋀</span><span class="bound">arb'</span> <span class="bound">arc'</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">pre</span> <span class="bound">arb'</span> <span class="bound">arc'</span> <span class="bound">x'</span><span class="main">;</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">V</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="bound">x'</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">arb'</span> <span class="bound">arc'</span> <span class="bound">x'</span><span class="main">;</span> 
      <span class="free">pre</span> <span class="bound">arb</span> <span class="bound">arc</span> <span class="bound">x</span><span class="main">;</span>
      <span class="bound">f</span> <span class="main">≤</span> RECT <span class="free">body</span>
    <span class="main">⟧</span>  <span class="main">⟹</span> <span class="free">body</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">arb</span> <span class="bound">arc</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RECT <span class="free">body</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="free">arb</span> <span class="free">arc</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> RECT_rule_arb<span class="main"><span class="main">[</span></span>
    <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pre<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"case_prod <span class="free">pre</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"case_prod <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> arb<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">arb</span><span class="main">,</span> <span class="free">arc</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span> 
    <span class="operator">OF</span> M WF<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RECT_rule_arb3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">body</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span><span class="free">V</span><span class="main">::</span><span class="tfree">'x</span> rel<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="main">(</span><span class="free">arb</span><span class="main">::</span><span class="tfree">'arb</span><span class="main">)</span> <span class="main">(</span><span class="free">arc</span><span class="main">::</span><span class="tfree">'arc</span><span class="main">)</span> <span class="main">(</span><span class="free">ard</span><span class="main">::</span><span class="tfree">'ard</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">arb</span> <span class="bound">arc</span> <span class="bound">ard</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> 
      <span class="main">⋀</span><span class="bound">arb'</span> <span class="bound">arc'</span> <span class="bound">ard'</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">pre</span> <span class="bound">arb'</span> <span class="bound">arc'</span> <span class="bound">ard'</span> <span class="bound">x'</span><span class="main">;</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">V</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="bound">x'</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">arb'</span> <span class="bound">arc'</span> <span class="bound">ard'</span> <span class="bound">x'</span><span class="main">;</span> 
    <span class="free">pre</span> <span class="bound">arb</span> <span class="bound">arc</span> <span class="bound">ard</span> <span class="bound">x</span><span class="main">;</span>
    <span class="bound">f</span> <span class="main">≤</span> RECT <span class="free">body</span>
  <span class="main">⟧</span>  <span class="main">⟹</span> <span class="free">body</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">arb</span> <span class="bound">arc</span> <span class="bound">ard</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RECT <span class="free">body</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="free">arb</span> <span class="free">arc</span> <span class="free">ard</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> RECT_rule_arb2<span class="main"><span class="main">[</span></span>
    <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pre<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"case_prod <span class="free">pre</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"case_prod <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> arb<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">arb</span><span class="main">,</span> <span class="free">arc</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> arc<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">ard</span>"</span></span><span class="main"><span class="main">,</span></span> 
    <span class="operator">OF</span> M WF<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>



<span class="comment1">(* Obsolete, provide a variant to show nofail.
text {* The following lemma shows that greatest and least fixed point are equal,
  if we can provide a variant. *}
lemma RECT_eq_REC:
  assumes MONO: "flatf_mono_le body"
  assumes MONO_GE: "flatf_mono_ge body"
  assumes WF: "wf V"
  assumes I0: "I x"
  assumes IS: "⋀f x. I x ⟹ 
    body (λx'. if (I x' ∧ (x',x)∈V) then f x' else top) x ≤ body f x"
  shows "RECT body x = REC body x"
  unfolding RECT_def REC_def 
proof (simp add: MONO MONO_GE)
  have "I x ⟶ flatf_gfp body x ≤ flatf_lfp body x"
    using WF
    apply (induct rule: wf_induct_rule)
    apply (rule impI)
    apply (subst flatf_ord.fixp_unfold[OF MONO])
    apply (subst flatf_ord.fixp_unfold[OF MONO_GE])
    apply (rule order_trans[OF _ IS])
    apply (rule monoD[OF MONO,THEN le_funD])
    apply (rule le_funI)
    apply simp
    apply simp
    done
  


  from lfp_le_gfp' MONO have "lfp body x ≤ gfp body x" .
  moreover have "I x ⟶ gfp body x ≤ lfp body x"
    using WF
    apply (induct rule: wf_induct[consumes 1])
    apply (rule impI)
    apply (subst lfp_unfold[OF MONO])
    apply (subst gfp_unfold[OF MONO])
    apply (rule order_trans[OF _ IS])
    apply (rule monoD[OF MONO,THEN le_funD])
    apply (rule le_funI)
    apply simp
    apply simp
    done
  ultimately show ?thesis
    unfolding REC_def RECT_def gfp_eq_flatf_gfp[OF MONO_GE MONO, symmetric]
    apply (rule_tac antisym)
    using I0 MONO MONO_GE by auto
qed
*)</span>

<span class="keyword1"><span class="command">lemma</span></span> RECT_eq_REC<span class="main">:</span> 
  <span class="comment1">― ‹Partial and total correct recursion are equal if total 
    recursion does not fail.›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> NT<span class="main">:</span> <span class="quoted"><span class="quoted">"RECT <span class="free">body</span> <span class="free">x</span> <span class="main">≠</span> top"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RECT <span class="free">body</span> <span class="free">x</span> <span class="main">=</span> REC <span class="free">body</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"trimono <span class="free">body</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> M<span class="main">:</span> True 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> NT M
    <span class="keyword1"><span class="command">unfolding</span></span> RECT_def REC_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">from</span></span> lfp_unfold<span class="main">[</span><span class="operator">OF</span> trimonoD_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> M<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flatf_ge <span class="main">(</span><span class="free">body</span> <span class="main">(</span>lfp <span class="free">body</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lfp <span class="free">body</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">note</span></span> flatf_ord.fixp_lowerbound<span class="main">[</span>
      <span class="operator">OF</span> trimonoD_flatf_ge<span class="main"><span class="main">[</span></span><span class="operator">OF</span> M<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"lfp <span class="free">body</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"flatf_gfp <span class="free">body</span> <span class="free">x</span> <span class="main">≠</span> top"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"flatf_gfp <span class="free">body</span> <span class="free">x</span> <span class="main">=</span> lfp <span class="free">body</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_ord_def flat_ord_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> RECT_def REC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> RECT_eq_REC_tproof<span class="main">:</span>
  <span class="comment1">― ‹Partial and total correct recursion are equal if we can provide a 
    termination proof.›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">body</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="free">a</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">arb</span> <span class="bound">x</span><span class="main">.</span>
          <span class="main">⟦</span><span class="main">⋀</span><span class="bound">arb'</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">pre</span> <span class="bound">arb'</span> <span class="bound">x'</span><span class="main">;</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">V</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="bound">x'</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">arb'</span> <span class="bound">x'</span><span class="main">;</span> 
            <span class="free">pre</span> <span class="bound">arb</span> <span class="bound">x</span><span class="main">;</span> <span class="keyword1">REC<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">body</span> <span class="main">=</span> <span class="bound">f</span><span class="main">⟧</span>
          <span class="main">⟹</span> <span class="free">body</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">arb</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> NT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="free">a</span> <span class="free">x</span> <span class="main">≠</span> top"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RECT <span class="free">body</span> <span class="free">x</span> <span class="main">=</span> REC <span class="free">body</span> <span class="free">x</span> <span class="main">∧</span> RECT <span class="free">body</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="free">a</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"RECT <span class="free">body</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="free">a</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> RECT_rule_arb<span class="main"><span class="main">[</span></span><span class="operator">OF</span> M WF<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pre<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">pre</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> I0 IS<span class="main"><span class="main">]</span></span><span class="main">)</span>
  
  <span class="keyword1"><span class="command">with</span></span> NT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"RECT <span class="free">body</span> <span class="free">x</span> <span class="main">≠</span> top"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> top.extremum_unique<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"RECT <span class="free">body</span> <span class="free">x</span> <span class="main">=</span> REC <span class="free">body</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> RECT_eq_REC<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transfer›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> transfer<span class="main">)</span> transfer_RECT'<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REC_EQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">fr</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b</span> <span class="free">fr</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">F</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">α</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">F</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">α</span> <span class="main">(</span><span class="free">b</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">B</span> <span class="bound">F</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">(</span><span class="free">fr</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> RECT <span class="free">B</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RECT_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
  <span class="keyword3"><span class="command">assume</span></span> MONO<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">B</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">(</span><span class="free">fr</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> flatf_gfp <span class="free">B</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> flatf_fixp_transfer<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">B</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> fp'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">fr</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main"><span class="main">,</span></span> 
        <span class="operator">OF</span> _ trimonoD_flatf_ge<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MONO<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span> REF<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>    
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ordered_transfer<span class="main">)</span> transfer_RECT<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">F</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">α</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">F</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">α</span> <span class="main">(</span><span class="free">b</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">B</span> <span class="bound">F</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">(</span>RECT <span class="free">b</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> RECT <span class="free">B</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> transfer_RECT'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> RECT_unfold<span class="main"><span class="main">[</span></span><span class="operator">OF</span> M<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> fun_cong<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dist_transfer<span class="main">)</span> transfer_REC<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">F</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">α</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">F</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">α</span> <span class="main">(</span><span class="free">b</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">B</span> <span class="bound">F</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">(</span>REC <span class="free">b</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> REC <span class="free">B</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> REC_def
  <span class="comment1">(* TODO: Clean up *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lfp_induct_pointwise<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> pre<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> α_dist<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> chain_def le_fun_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trimonoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> M<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lfp_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trimonoD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> REF<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* TODO: Could we base the whole refine_transfer-stuff on arbitrary relations *)</span>
<span class="comment1">(* TODO: For enres-breakdown, we had to do antisymmetry, in order to get TR_top.
  What is the general shape of tr-relations for that, such that we could show equality directly?
*)</span>
<span class="keyword1"><span class="command">lemma</span></span> RECT_transfer_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">F</span>"</span></span> <span class="quoted"><span class="quoted">"trimono <span class="free">F'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> TR_top<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">tr</span> <span class="bound">x</span> top"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P_start<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="free">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">D</span> <span class="bound">D'</span> <span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="free">tr</span> <span class="main">(</span><span class="bound">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">D'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">;</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">x'</span><span class="main">;</span> RECT <span class="free">F</span> <span class="main">=</span> <span class="bound">D</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">tr</span> <span class="main">(</span><span class="free">F</span> <span class="bound">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">F'</span> <span class="bound">D'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">tr</span> <span class="main">(</span>RECT <span class="free">F</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>RECT <span class="free">F'</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RECT_def 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> flatf_gfp_transfer<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> tr<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">tr</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">P</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trimonoD_flatf_ge<span class="main">)</span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> IS<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> RECT_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> RECT_transfer_rel'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">F</span>"</span></span> <span class="quoted"><span class="quoted">"trimono <span class="free">F'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> TR_top<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">tr</span> <span class="bound">x</span> top"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P_start<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="free">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">D</span> <span class="bound">D'</span> <span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="free">tr</span> <span class="main">(</span><span class="bound">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">D'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">;</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">tr</span> <span class="main">(</span><span class="free">F</span> <span class="bound">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">F'</span> <span class="bound">D'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">tr</span> <span class="main">(</span>RECT <span class="free">F</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>RECT <span class="free">F'</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> RECT_transfer_rel<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> tr<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">tr</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P</span></span><span class="main">,</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> IS <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="RefineG_Assert">
<div class="head">
<h1>Theory RefineG_Assert</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹{Assert and Assume}›</span></span>
<span class="keyword1"><span class="command">theory</span></span> RefineG_Assert
<span class="keyword2"><span class="keyword">imports</span></span> <a href="RefineG_Transfer.html">RefineG_Transfer</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">iASSERT</span> <span class="free"><span class="bound"><span class="entity">return</span></span></span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">return</span></span></span> <span class="main">()</span> <span class="keyword1">else</span> top"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">iASSUME</span> <span class="free"><span class="bound"><span class="entity">return</span></span></span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">return</span></span></span> <span class="main">()</span> <span class="keyword1">else</span> bot"</span></span>

  <span class="keyword1"><span class="command">locale</span></span> generic_Assert <span class="main">=</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">bind</span> <span class="main">::</span> 
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'mu</span><span class="main">::</span>complete_lattice<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>unit <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ma</span><span class="main">::</span>complete_lattice<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'ma</span>"</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">return</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit <span class="main">⇒</span> <span class="tfree">'mu</span>"</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ASSERT</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ASSUME</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> ibind_strict<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="free">bind</span> bot <span class="free">f</span> <span class="main">=</span> bot"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="free">bind</span> top <span class="free">f</span> <span class="main">=</span> top"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> imonad1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bind</span> <span class="main">(</span><span class="free">return</span> <span class="free">u</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span> <span class="free">u</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> ASSERT_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ASSERT</span> <span class="main">≡</span> iASSERT <span class="free">return</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> ASSUME_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ASSUME</span> <span class="main">≡</span> iASSUME <span class="free">return</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>
     <span class="keyword1"><span class="command">lemma</span></span> ASSERT_simps<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="free">ASSERT</span> True <span class="main">=</span> <span class="free">return</span> <span class="main">()</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">ASSERT</span> False <span class="main">=</span> top"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ASSERT_eq iASSERT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">lemma</span></span> ASSUME_simps<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="free">ASSUME</span> True <span class="main">=</span> <span class="free">return</span> <span class="main">()</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">ASSUME</span> False <span class="main">=</span> bot"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ASSUME_eq iASSUME_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">lemma</span></span> le_ASSERTI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Φ</span> <span class="main">⟹</span> <span class="free">M</span><span class="main">≤</span><span class="free">M'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">≤</span> <span class="free">bind</span> <span class="main">(</span><span class="free">ASSERT</span> <span class="free">Φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ibind_strict imonad1<span class="main">)</span>

    <span class="keyword1"><span class="command">lemma</span></span> le_ASSERTI_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Φ</span> <span class="main">⟹</span> <span class="free">M</span><span class="main">≤</span><span class="free">bind</span> <span class="main">(</span><span class="free">ASSERT</span> <span class="free">Φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M'</span><span class="main">)</span> <span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="free">M</span> <span class="main">≤</span> <span class="free">bind</span> <span class="main">(</span><span class="free">ASSERT</span> <span class="free">Φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ibind_strict imonad1<span class="main">)</span>

    <span class="keyword1"><span class="command">lemma</span></span> ASSERT_leI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Φ</span><span class="main">;</span> <span class="free">Φ</span> <span class="main">⟹</span> <span class="free">M</span><span class="main">≤</span><span class="free">M'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">bind</span> <span class="main">(</span><span class="free">ASSERT</span> <span class="free">Φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M</span><span class="main">)</span> <span class="main">≤</span> <span class="free">M'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ibind_strict imonad1<span class="main">)</span>


    <span class="keyword1"><span class="command">lemma</span></span> ASSUME_leI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Φ</span> <span class="main">⟹</span> <span class="free">M</span><span class="main">≤</span><span class="free">M'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">bind</span> <span class="main">(</span><span class="free">ASSUME</span> <span class="free">Φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M</span><span class="main">)</span> <span class="main">≤</span> <span class="free">M'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ibind_strict imonad1<span class="main">)</span>
    <span class="keyword1"><span class="command">lemma</span></span> ASSUME_leI_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Φ</span> <span class="main">⟹</span> <span class="free">bind</span> <span class="main">(</span><span class="free">ASSUME</span> <span class="free">Φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M</span><span class="main">)</span><span class="main">≤</span><span class="free">M'</span> <span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="free">bind</span> <span class="main">(</span><span class="free">ASSUME</span> <span class="free">Φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M</span><span class="main">)</span> <span class="main">≤</span> <span class="free">M'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ibind_strict imonad1<span class="main">)</span>
    <span class="keyword1"><span class="command">lemma</span></span> le_ASSUMEI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Φ</span><span class="main">;</span> <span class="free">Φ</span> <span class="main">⟹</span> <span class="free">M</span><span class="main">≤</span><span class="free">M'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">≤</span> <span class="free">bind</span> <span class="main">(</span><span class="free">ASSUME</span> <span class="free">Φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ibind_strict imonad1<span class="main">)</span>

    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The order of these declarations does matter!›</span></span>
    <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">?</span></span></span><span class="main">]</span> <span class="main">=</span> ASSERT_leI le_ASSUMEI
    <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">?</span></span></span><span class="main">]</span> <span class="main">=</span> le_ASSERTI ASSUME_leI

    <span class="keyword1"><span class="command">lemma</span></span> ASSERT_le_iff<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="free">bind</span> <span class="main">(</span><span class="free">ASSERT</span> <span class="free">Φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">S</span><span class="main">)</span> <span class="main">≤</span> <span class="free">S'</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">S'</span><span class="main">≠</span>top <span class="main">⟶</span> <span class="free">Φ</span><span class="main">)</span> <span class="main">∧</span> <span class="free">S</span><span class="main">≤</span><span class="free">S'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ibind_strict imonad1 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> top_unique<span class="main">)</span>

    <span class="keyword1"><span class="command">lemma</span></span> ASSUME_le_iff<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">bind</span> <span class="main">(</span><span class="free">ASSUME</span> <span class="free">Φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">S</span><span class="main">)</span> <span class="main">≤</span> <span class="free">S'</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">Φ</span> <span class="main">⟶</span> <span class="free">S</span><span class="main">≤</span><span class="free">S'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ibind_strict imonad1<span class="main">)</span>

    <span class="keyword1"><span class="command">lemma</span></span> le_ASSERT_iff<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≤</span> <span class="free">bind</span> <span class="main">(</span><span class="free">ASSERT</span> <span class="free">Φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">S'</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">Φ</span> <span class="main">⟶</span> <span class="free">S</span><span class="main">≤</span><span class="free">S'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ibind_strict imonad1<span class="main">)</span>

    <span class="keyword1"><span class="command">lemma</span></span> le_ASSUME_iff<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≤</span> <span class="free">bind</span> <span class="main">(</span><span class="free">ASSUME</span> <span class="free">Φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">S'</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">S</span><span class="main">≠</span>bot <span class="main">⟶</span> <span class="free">Φ</span><span class="main">)</span> <span class="main">∧</span> <span class="free">S</span><span class="main">≤</span><span class="free">S'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ibind_strict imonad1 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bot_unique<span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    This locale transfer's asserts and assumes. 
    To remove them, use the next locale.
›</span></span>
  <span class="keyword1"><span class="command">locale</span></span> transfer_generic_Assert <span class="main">=</span> 
    c<span class="main">:</span> generic_Assert <span class="quoted"><span class="free">cbind</span></span> <span class="quoted"><span class="free">creturn</span></span> <span class="quoted"><span class="free">cASSERT</span></span> <span class="quoted"><span class="free">cASSUME</span></span> <span class="main">+</span>
    a<span class="main">:</span> generic_Assert <span class="quoted"><span class="free">abind</span></span> <span class="quoted"><span class="free">areturn</span></span> <span class="quoted"><span class="free">aASSERT</span></span> <span class="quoted"><span class="free">aASSUME</span></span> <span class="main">+</span>
    ordered_transfer <span class="quoted"><span class="free">α</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">cbind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'muc</span><span class="main">::</span>complete_lattice<span class="main">)</span> 
      <span class="main">⇒</span> <span class="main">(</span>unit<span class="main">⇒</span><span class="tfree">'mac</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'mac</span><span class="main">::</span>complete_lattice<span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">creturn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit <span class="main">⇒</span> <span class="tfree">'muc</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">cASSERT</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">cASSUME</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">abind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'mua</span><span class="main">::</span>complete_lattice<span class="main">)</span> 
      <span class="main">⇒</span> <span class="main">(</span>unit<span class="main">⇒</span><span class="tfree">'maa</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'maa</span><span class="main">::</span>complete_lattice<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">areturn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit <span class="main">⇒</span> <span class="tfree">'mua</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">aASSERT</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">aASSUME</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'mac</span> <span class="main">⇒</span> <span class="tfree">'maa</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>
    <span class="keyword1"><span class="command">lemma</span></span> transfer_ASSERT<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Φ</span> <span class="main">⟹</span> <span class="free">α</span> <span class="free">M</span> <span class="main">≤</span> <span class="free">M'</span><span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="free">α</span> <span class="main">(</span><span class="free">cbind</span> <span class="main">(</span><span class="free">cASSERT</span> <span class="free">Φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">abind</span> <span class="main">(</span><span class="free">aASSERT</span> <span class="free">Φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> c.ibind_strict a.ibind_strict c.imonad1 a.imonad1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1"><span class="command">lemma</span></span> transfer_ASSUME<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Φ</span><span class="main">;</span> <span class="free">Φ</span> <span class="main">⟹</span> <span class="free">α</span> <span class="free">M</span> <span class="main">≤</span> <span class="free">M'</span><span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="free">α</span> <span class="main">(</span><span class="free">cbind</span> <span class="main">(</span><span class="free">cASSUME</span> <span class="free">Φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">abind</span> <span class="main">(</span><span class="free">aASSUME</span> <span class="free">Φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> c.ibind_strict a.ibind_strict c.imonad1 a.imonad1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword2"><span class="keyword">end</span></span>


  <span class="keyword1"><span class="command">locale</span></span> transfer_generic_Assert_remove <span class="main">=</span> 
    a<span class="main">:</span> generic_Assert <span class="quoted"><span class="free">abind</span></span> <span class="quoted"><span class="free">areturn</span></span> <span class="quoted"><span class="free">aASSERT</span></span> <span class="quoted"><span class="free">aASSUME</span></span> <span class="main">+</span>
    transfer <span class="quoted"><span class="free">α</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">abind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'mua</span><span class="main">::</span>complete_lattice<span class="main">)</span> 
      <span class="main">⇒</span> <span class="main">(</span>unit<span class="main">⇒</span><span class="tfree">'maa</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'maa</span><span class="main">::</span>complete_lattice<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">areturn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit <span class="main">⇒</span> <span class="tfree">'mua</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">aASSERT</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">aASSUME</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'mac</span> <span class="main">⇒</span> <span class="tfree">'maa</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>
    <span class="keyword1"><span class="command">lemma</span></span> transfer_ASSERT_remove<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Φ</span> <span class="main">⟹</span> <span class="free">α</span> <span class="free">M</span> <span class="main">≤</span> <span class="free">M'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">α</span> <span class="free">M</span> <span class="main">≤</span> <span class="free">abind</span> <span class="main">(</span><span class="free">aASSERT</span> <span class="free">Φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> a.le_ASSERTI<span class="main">)</span>

    <span class="keyword1"><span class="command">lemma</span></span> transfer_ASSUME_remove<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Φ</span><span class="main">;</span> <span class="free">Φ</span> <span class="main">⟹</span> <span class="free">α</span> <span class="free">M</span> <span class="main">≤</span> <span class="free">M'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">α</span> <span class="free">M</span> <span class="main">≤</span> <span class="free">abind</span> <span class="main">(</span><span class="free">aASSUME</span> <span class="free">Φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> a.le_ASSUMEI<span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Refine_Basic">
<div class="head">
<h1>Theory Refine_Basic</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Basic Concepts›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Refine_Basic
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> 
  <span class="quoted">"<a href="../../HOL/HOL-Library/Monad_Syntax.html">HOL-Library.Monad_Syntax</a>"</span> 
  <a href="Refine_Misc.html">Refine_Misc</a>
  <span class="quoted">"<a href="RefineG_Recursion.html">Generic/RefineG_Recursion</a>"</span>
  <span class="quoted">"<a href="RefineG_Assert.html">Generic/RefineG_Assert</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Nondeterministic Result Lattice and Monad›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section we introduce a complete lattice of result sets with an
  additional top element that represents failure. On this lattice, we define
  a monad: The return operator models a result that consists of a single value,
  and the bind operator models applying a function to all results.
  Binding a failure yields always a failure.
  
  In addition to the return operator, we also introduce the operator 
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>RES›</span></span></span></span>, that embeds a set of results into our lattice. Its synonym for
  a predicate is <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SPEC›</span></span></span></span>.

  Program correctness is expressed by refinement, i.e., the expression
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>M ≤ SPEC Φ›</span></span></span></span> means that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>M›</span></span></span></span> is correct w.r.t.\ 
  specification <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Φ›</span></span></span></span>. This suggests the following view on the program 
  lattice: The top-element is the result that is never correct. We call this
  result <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>FAIL›</span></span></span></span>. The bottom element is the program that is always correct.
  It is called <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SUCCEED›</span></span></span></span>. An assertion can be encoded by failing if the
  asserted predicate is not true. Symmetrically, an assumption is encoded by
  succeeding if the predicate is not true. 
›</span></span>


<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> nres <span class="main">=</span> FAILi <span class="main">|</span> RES <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>FAILi›</span></span></span></span> is only an internal notation, that should not be exposed to 
  the user.
  Instead, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>FAIL›</span></span></span></span> should be used, that is defined later as abbreviation 
  for the top element of the lattice.
›</span></span>
<span class="keyword1"><span class="command">instantiation</span></span> nres <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">complete_lattice</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">less_eq_nres</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">≤</span> FAILi <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>RES <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>RES <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">⊆</span><span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"FAILi <span class="main">≤</span> <span class="main">(</span>RES <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">⟷</span> False"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">less_nres</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"FAILi <span class="main">&lt;</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>RES <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">&lt;</span> FAILi <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>RES <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>RES <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">⊂</span><span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">sup_nres</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"sup <span class="main"><span class="bound"><span class="entity">_</span></span></span> FAILi <span class="main">=</span> FAILi"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"sup FAILi <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> FAILi"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"sup <span class="main">(</span>RES <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>RES <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> RES <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">∪</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">inf_nres</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"inf <span class="free"><span class="bound"><span class="entity">x</span></span></span> FAILi <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"inf FAILi <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"inf <span class="main">(</span>RES <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>RES <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> RES <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">∩</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"Sup <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> FAILi<span class="main">∈</span><span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1">then</span> FAILi <span class="keyword1">else</span> RES <span class="main">(</span><span class="main">⋃</span><span class="main">{</span><span class="bound">x</span> <span class="main">.</span> RES <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"Inf <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> RES <span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1">then</span> RES <span class="main">(</span><span class="main">⋂</span><span class="main">{</span><span class="bound">x</span> <span class="main">.</span> RES <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">}</span><span class="main">)</span> <span class="keyword1">else</span> FAILi"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"bot <span class="main">≡</span> RES <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"top <span class="main">≡</span> FAILi"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sup_nres_def Inf_nres_def bot_nres_def top_nres_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">y</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">y</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">z</span></span></span></span></span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">y</span></span></span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">y</span></span></span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">y</span></span></span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">y</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">z</span></span></span></span></span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">y</span></span></span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">y</span></span></span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">y</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">z</span></span></span></span></span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">FAIL</span> <span class="main">≡</span> top<span class="main">::</span><span class="tfree">'a</span> nres"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">SUCCEED</span> <span class="main">≡</span> bot<span class="main">::</span><span class="tfree">'a</span> nres"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">SPEC</span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="main">≡</span> RES <span class="main">(</span>Collect <span class="free"><span class="bound"><span class="entity">Φ</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">RETURN</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> RES <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We try to hide the original <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>FAILi›</span></span></span></span>-element as well as possible. 
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> nres_cases<span class="main">[</span><span class="operator">case_names</span> FAIL RES<span class="main">,</span> <span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">type</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">=</span>FAIL"</span></span> <span class="main">|</span> <span class="free">X</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">=</span>RES <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">M</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fold</span> top_nres_def<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nres_simp_internals<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"RES <span class="main">{}</span> <span class="main">=</span> SUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"FAILi <span class="main">=</span> FAIL"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> top_nres_def bot_nres_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> nres_inequalities<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"FAIL <span class="main">≠</span> RES <span class="free">X</span>"</span></span>
  <span class="quoted"><span class="quoted">"FAIL <span class="main">≠</span> SUCCEED"</span></span> 
  <span class="quoted"><span class="quoted">"FAIL <span class="main">≠</span> RETURN <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"SUCCEED <span class="main">≠</span> FAIL"</span></span>
  <span class="quoted"><span class="quoted">"SUCCEED <span class="main">≠</span> RETURN <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"RES <span class="free">X</span> <span class="main">≠</span> FAIL"</span></span>
  <span class="quoted"><span class="quoted">"RETURN <span class="free">x</span> <span class="main">≠</span> FAIL"</span></span>
  <span class="quoted"><span class="quoted">"RETURN <span class="free">x</span> <span class="main">≠</span> SUCCEED"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> top_nres_def bot_nres_def RETURN_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nres_more_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"SUCCEED <span class="main">=</span> RES <span class="free">X</span> <span class="main">⟷</span> <span class="free">X</span><span class="main">=</span><span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"RES <span class="free">X</span> <span class="main">=</span> SUCCEED <span class="main">⟷</span> <span class="free">X</span><span class="main">=</span><span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"RES <span class="free">X</span> <span class="main">=</span> RETURN <span class="free">x</span> <span class="main">⟷</span> <span class="free">X</span><span class="main">=</span><span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="quoted"><span class="quoted">"RES <span class="free">X</span> <span class="main">=</span> RES <span class="free">Y</span> <span class="main">⟷</span> <span class="free">X</span><span class="main">=</span><span class="free">Y</span>"</span></span>
  <span class="quoted"><span class="quoted">"RETURN <span class="free">x</span> <span class="main">=</span> RES <span class="free">X</span> <span class="main">⟷</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">=</span><span class="free">X</span>"</span></span>
  <span class="quoted"><span class="quoted">"RETURN <span class="free">x</span> <span class="main">=</span> RETURN <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span><span class="main">=</span><span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> top_nres_def bot_nres_def RETURN_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nres_order_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">M</span><span class="main">.</span> SUCCEED <span class="main">≤</span> <span class="bound">M</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">≤</span> SUCCEED <span class="main">⟷</span> <span class="bound">M</span><span class="main">=</span>SUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">≤</span> FAIL"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">M</span><span class="main">.</span> FAIL <span class="main">≤</span> <span class="bound">M</span> <span class="main">⟷</span> <span class="bound">M</span><span class="main">=</span>FAIL"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> RES <span class="bound">X</span> <span class="main">≤</span> RES <span class="bound">Y</span> <span class="main">⟷</span> <span class="bound">X</span><span class="main">≤</span><span class="bound">Y</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> Sup <span class="bound">X</span> <span class="main">=</span> FAIL <span class="main">⟷</span> FAIL<span class="main">∈</span><span class="bound">X</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span> <span class="bound">f</span><span class="main">.</span> Sup <span class="main">(</span><span class="bound">f</span> <span class="main">`</span> <span class="bound">X</span><span class="main">)</span> <span class="main">=</span> FAIL <span class="main">⟷</span> FAIL <span class="main">∈</span> <span class="bound">f</span> <span class="main">`</span> <span class="bound">X</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> FAIL <span class="main">=</span> Sup <span class="bound">X</span> <span class="main">⟷</span> FAIL<span class="main">∈</span><span class="bound">X</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span> <span class="bound">f</span><span class="main">.</span> FAIL <span class="main">=</span> Sup <span class="main">(</span><span class="bound">f</span> <span class="main">`</span> <span class="bound">X</span><span class="main">)</span> <span class="main">⟷</span> FAIL <span class="main">∈</span> <span class="bound">f</span> <span class="main">`</span> <span class="bound">X</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> FAIL<span class="main">∈</span><span class="bound">X</span> <span class="main">⟹</span> Sup <span class="bound">X</span> <span class="main">=</span> FAIL"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> FAIL<span class="main">∈</span><span class="free">f</span> <span class="main">`</span> <span class="bound">X</span> <span class="main">⟹</span> Sup <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="bound">X</span><span class="main">)</span> <span class="main">=</span> FAIL"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> Sup <span class="main">(</span>RES <span class="main">`</span> <span class="bound">A</span><span class="main">)</span> <span class="main">=</span> RES <span class="main">(</span>Sup <span class="bound">A</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> Sup <span class="main">(</span>RES <span class="main">`</span> <span class="bound">A</span><span class="main">)</span> <span class="main">=</span> RES <span class="main">(</span>Sup <span class="bound">A</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span><span class="main">≠</span><span class="main">{}</span> <span class="main">⟹</span> Inf <span class="main">(</span>RES<span class="main">`</span><span class="bound">A</span><span class="main">)</span> <span class="main">=</span> RES <span class="main">(</span>Inf <span class="bound">A</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span><span class="main">≠</span><span class="main">{}</span> <span class="main">⟹</span> Inf <span class="main">(</span>RES <span class="main">`</span> <span class="bound">A</span><span class="main">)</span> <span class="main">=</span> RES <span class="main">(</span>Inf <span class="bound">A</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"Inf <span class="main">{}</span> <span class="main">=</span> FAIL"</span></span>
  <span class="quoted"><span class="quoted">"Inf UNIV <span class="main">=</span> SUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"Sup <span class="main">{}</span> <span class="main">=</span> SUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"Sup UNIV <span class="main">=</span> FAIL"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> RETURN <span class="bound">x</span> <span class="main">≤</span> RETURN <span class="bound">y</span> <span class="main">⟷</span> <span class="bound">x</span><span class="main">=</span><span class="bound">y</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">Y</span><span class="main">.</span> RETURN <span class="bound">x</span> <span class="main">≤</span> RES <span class="bound">Y</span> <span class="main">⟷</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">Y</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span> <span class="bound">y</span><span class="main">.</span> RES <span class="bound">X</span> <span class="main">≤</span> RETURN <span class="bound">y</span> <span class="main">⟷</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sup_nres_def Inf_nres_def RETURN_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bot_unique top_unique nres_simp_internals<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Sup_eq_RESE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Sup <span class="free">A</span> <span class="main">=</span> RES <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">C</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">=</span>RES<span class="main">`</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">=</span>Sup <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Sup_nres_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">X</span><span class="main">.</span> RES <span class="bound">X</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> that<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nres_simp_internals<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nres_simp_internals<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> nres_simp_internals<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pointwise Reasoning›</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">refine_pw_simps</span> <span class="main">=</span> <span class="entity">Named_Thms</span>
    <span class="main">(</span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> refine_pw_simps<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Refinement Framework: "</span> ^
        <span class="inner_quoted">"Simplifier rules for pointwise reasoning"</span> <span class="main">)</span>
›</span>    
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">refine_pw_simps.setup</span>›</span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">nofail</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">≠</span>FAIL"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inres</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> RETURN <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nofail_simps<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nofail FAIL <span class="main">⟷</span> False"</span></span>
  <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>RES <span class="free">X</span><span class="main">)</span> <span class="main">⟷</span> True"</span></span>
  <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>RETURN <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> True"</span></span>
  <span class="quoted"><span class="quoted">"nofail SUCCEED <span class="main">⟷</span> True"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nofail_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RETURN_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inres_simps<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inres FAIL <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>RES <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>RETURN <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">x</span><span class="main">=</span><span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"inres SUCCEED <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inres_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RETURN_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_nofail_iff<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>nofail <span class="free">S</span> <span class="main">⟷</span> <span class="free">S</span><span class="main">=</span>FAIL"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> not_nofail_inres<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>nofail <span class="free">S</span> <span class="main">⟹</span> inres <span class="free">S</span> <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> intro_nofail<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">≠</span>FAIL <span class="main">⟷</span> nofail <span class="free">S</span>"</span></span>
  <span class="quoted"><span class="quoted">"FAIL<span class="main">≠</span><span class="free">S</span> <span class="main">⟷</span> nofail <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">S</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following two lemmas will introduce pointwise reasoning for
  orderings and equalities.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> pw_le_iff<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≤</span> <span class="free">S'</span> <span class="main">⟷</span> <span class="main">(</span>nofail <span class="free">S'</span><span class="main">⟶</span> <span class="main">(</span>nofail <span class="free">S</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> inres <span class="free">S</span> <span class="bound">x</span> <span class="main">⟶</span> inres <span class="free">S'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">S</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S'</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> pw_eq_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">=</span><span class="free">S'</span> <span class="main">⟷</span> <span class="main">(</span>nofail <span class="free">S</span> <span class="main">=</span> nofail <span class="free">S'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> inres <span class="free">S</span> <span class="bound">x</span> <span class="main">⟷</span> inres <span class="free">S'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> pw_flat_le_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"flat_le <span class="free">S</span> <span class="free">S'</span> <span class="main">⟷</span> 
  <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> inres <span class="free">S</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>nofail <span class="free">S</span> <span class="main">⟷</span> nofail <span class="free">S'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> inres <span class="free">S</span> <span class="bound">x</span> <span class="main">⟷</span> inres <span class="free">S'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="main"><span class="main">:</span></span> flat_ord_def pw_eq_iff<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> pw_flat_ge_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"flat_ge <span class="free">S</span> <span class="free">S'</span> <span class="main">⟷</span> 
  <span class="main">(</span>nofail <span class="free">S</span><span class="main">)</span> <span class="main">⟶</span> nofail <span class="free">S'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> inres <span class="free">S</span> <span class="bound">x</span> <span class="main">⟷</span> inres <span class="free">S'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flat_ord_def pw_eq_iff<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> pw_ords_iff <span class="main">=</span> pw_le_iff pw_flat_le_iff pw_flat_ge_iff

<span class="keyword1"><span class="command">lemma</span></span> pw_leI<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>nofail <span class="free">S'</span><span class="main">⟶</span> <span class="main">(</span>nofail <span class="free">S</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> inres <span class="free">S</span> <span class="bound">x</span> <span class="main">⟶</span> inres <span class="free">S'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">≤</span> <span class="free">S'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pw_leI'<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nofail <span class="free">S'</span> <span class="main">⟹</span> nofail <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span>nofail <span class="free">S'</span><span class="main">;</span> inres <span class="free">S</span> <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> inres <span class="free">S'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≤</span> <span class="free">S'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pw_eqI<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nofail <span class="free">S</span> <span class="main">=</span> nofail <span class="free">S'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> inres <span class="free">S</span> <span class="bound">x</span> <span class="main">⟷</span> inres <span class="free">S'</span> <span class="bound">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">=</span><span class="free">S'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pwD1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">≤</span><span class="free">S'</span>"</span></span> <span class="quoted"><span class="quoted">"nofail <span class="free">S'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nofail <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pwD2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">≤</span><span class="free">S'</span>"</span></span> <span class="quoted"><span class="quoted">"inres <span class="free">S</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inres <span class="free">S'</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> pwD <span class="main">=</span> pwD1 pwD2

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  When proving refinement, we may assume that the refined program does not 
  fail.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> le_nofailI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> nofail <span class="free">M'</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">≤</span> <span class="free">M'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">≤</span> <span class="free">M'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">M'</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemmas push pointwise reasoning over operators,
  thus converting an expression over lattice operators into a logical
  formula.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pw_sup_nofail<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>sup <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟷</span> nofail <span class="free">a</span> <span class="main">∧</span> nofail <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> pw_sup_inres<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>sup <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟷</span> inres <span class="free">a</span> <span class="free">x</span> <span class="main">∨</span> inres <span class="free">b</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> pw_Sup_inres<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inres <span class="main">(</span>Sup <span class="free">X</span><span class="main">)</span> <span class="free">r</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">M</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> inres <span class="bound">M</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Sup <span class="free">X</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Sup_eq_RESE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> pw_SUP_inres <span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inres <span class="main">(</span>Sup <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">M</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> inres <span class="main">(</span><span class="free">f</span> <span class="bound">M</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pw_Sup_inres <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">X</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> pw_Sup_nofail<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>Sup <span class="free">X</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> nofail <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Sup <span class="free">X</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Sup_eq_RESE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> pw_SUP_nofail <span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>Sup <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> nofail <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pw_Sup_nofail <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">X</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> pw_inf_nofail<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>inf <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟷</span> nofail <span class="free">a</span> <span class="main">∨</span> nofail <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> pw_inf_inres<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>inf <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟷</span> inres <span class="free">a</span> <span class="free">x</span> <span class="main">∧</span> inres <span class="free">b</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> pw_Inf_nofail<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>Inf <span class="free">C</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> nofail <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">=</span><span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Inf <span class="free">C</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">=</span><span class="main">{</span>FAIL<span class="main">}</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">≠</span><span class="main">{</span>FAIL<span class="main">}</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_nofail_iff<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> pw_INF_nofail <span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>Inf <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> nofail <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pw_Inf_nofail <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">C</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> pw_Inf_inres<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inres <span class="main">(</span>Inf <span class="free">C</span><span class="main">)</span> <span class="free">r</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">M</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> inres <span class="bound">M</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> Inf_nres_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">M</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">M</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> pw_INF_inres <span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inres <span class="main">(</span>Inf <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">M</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> inres <span class="main">(</span><span class="free">f</span> <span class="bound">M</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pw_Inf_inres <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">C</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> nofail_RES_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="free">m</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">M</span><span class="main">.</span> <span class="free">m</span><span class="main">=</span>RES <span class="bound">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">the_RES</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">the_RES</span> <span class="main">(</span>RES <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> the_RES_inv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="free">m</span> <span class="main">⟹</span> RES <span class="main">(</span>the_RES <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nf_inres</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> nofail <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∧</span> inres <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nf_inres_RES<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nf_inres <span class="main">(</span>RES <span class="free">X</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">x</span><span class="main">∈</span><span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> nf_inres_SPEC<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nf_inres <span class="main">(</span>SPEC <span class="free">Φ</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">Φ</span> <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nofail_antimono_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">⟹</span> <span class="main">(</span>nofail <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟶</span> nofail <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_funD<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Monad Operators›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bind</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">bind</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="keyword1">of</span> 
  FAILi <span class="main">⇒</span> FAIL <span class="main">|</span>
  RES <span class="bound">X</span> <span class="main">⇒</span> Sup <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">`</span><span class="bound">X</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bind_FAIL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bind FAIL <span class="free">f</span> <span class="main">=</span> FAIL"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bind_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nres.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bind_SUCCEED<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bind SUCCEED <span class="free">f</span> <span class="main">=</span> SUCCEED"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bind_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nres.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bind_RES<span class="main">:</span> <span class="quoted"><span class="quoted">"bind <span class="main">(</span>RES <span class="free">X</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> Sup <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bind_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">adhoc_overloading</span></span>
  Monad_Syntax.bind <span class="quoted">Refine_Basic.bind</span>

<span class="keyword1"><span class="command">lemma</span></span> pw_bind_nofail<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>bind <span class="free">M</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>nofail <span class="free">M</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> inres <span class="free">M</span> <span class="bound">x</span> <span class="main">⟶</span> nofail <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bind_RES <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> pw_bind_inres<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>bind <span class="free">M</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nofail <span class="free">M</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span>inres <span class="free">M</span> <span class="bound">y</span> <span class="main">∧</span> inres <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_RES <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> pw_bind_le_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bind <span class="free">M</span> <span class="free">f</span> <span class="main">≤</span> <span class="free">S</span> <span class="main">⟷</span> <span class="main">(</span>nofail <span class="free">S</span> <span class="main">⟶</span> nofail <span class="free">M</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> nofail <span class="free">M</span> <span class="main">∧</span> inres <span class="free">M</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pw_bind_leI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> 
  nofail <span class="free">S</span> <span class="main">⟹</span> nofail <span class="free">M</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span>nofail <span class="free">M</span><span class="main">;</span> inres <span class="free">M</span> <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">S</span><span class="main">⟧</span> 
  <span class="main">⟹</span> bind <span class="free">M</span> <span class="free">f</span> <span class="main">≤</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_bind_le_iff<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹\paragraph{Monad Laws}›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> nres_monad1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bind <span class="main">(</span>RETURN <span class="free">x</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pw_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> nres_monad2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bind <span class="free">M</span> RETURN <span class="main">=</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pw_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> nres_monad3<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bind <span class="main">(</span>bind <span class="free">M</span> <span class="free">f</span><span class="main">)</span> <span class="free">g</span> <span class="main">=</span> bind <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> bind <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pw_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">lemmas</span></span> nres_monad_laws <span class="main">=</span> nres_monad1 nres_monad2 nres_monad3

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹\paragraph{Congruence rule for bind}›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> bind_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">=</span><span class="free">m'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> RETURN <span class="bound">x</span> <span class="main">≤</span> <span class="free">m'</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bind <span class="free">m</span> <span class="free">f</span> <span class="main">=</span> bind <span class="free">m'</span> <span class="free">f'</span>"</span></span>  
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> pw_eq_iff pw_le_iff<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹\paragraph{Monotonicity and Related Properties}›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> bind_mono<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">M</span> <span class="main">≤</span> <span class="free">M'</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> RETURN <span class="bound">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">f'</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> bind <span class="free">M</span> <span class="free">f</span> <span class="main">≤</span> bind <span class="free">M'</span> <span class="free">f'</span>"</span></span>
  <span class="comment1">(*"⟦ flat_le M M'; ⋀x. flat_le (f x) (f' x) ⟧ ⟹ flat_le (bind M f) (bind M' f')"*)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> flat_ge <span class="free">M</span> <span class="free">M'</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> flat_ge <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> flat_ge <span class="main">(</span>bind <span class="free">M</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>bind <span class="free">M'</span> <span class="free">f'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> pw_ords_iff<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> pw_ords_iff<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> bind_mono1<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="main">λ</span><span class="bound">M</span><span class="main">.</span> bind <span class="bound">M</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monoI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bind_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> bind_mono1'<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono bind"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monoI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bind_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> bind_mono2'<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>bind <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monoI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bind_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_funD<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> bind_distrib_sup1<span class="main">:</span> <span class="quoted"><span class="quoted">"bind <span class="main">(</span>sup <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> sup <span class="main">(</span>bind <span class="free">M</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>bind <span class="free">N</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  bind_distrib_sup2<span class="main">:</span> <span class="quoted"><span class="quoted">"bind <span class="free">m</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sup <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sup <span class="main">(</span>bind <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>bind <span class="free">m</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bind_distrib_Sup1<span class="main">:</span> <span class="quoted"><span class="quoted">"bind <span class="main">(</span>Sup <span class="free">M</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">m</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> bind <span class="bound">m</span> <span class="free">f</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bind_distrib_Sup2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span><span class="main">≠</span><span class="main">{}</span> <span class="main">⟹</span> bind <span class="free">m</span> <span class="main">(</span>Sup <span class="free">F</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">f</span><span class="main">∈</span><span class="free">F</span><span class="main">.</span> bind <span class="free">m</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> RES_Sup_RETURN<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup <span class="main">(</span>RETURN<span class="main">`</span><span class="free">X</span><span class="main">)</span> <span class="main">=</span> RES <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pw_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹VCG Setup›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> SPEC_cons_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Ψ</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> SPEC <span class="free">Ψ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemmas</span></span> SPEC_trans <span class="main">=</span> order_trans<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> z<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"SPEC <span class="free">Postcond</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Postcond</span><span class="main">,</span> <span class="operator">zero_var_indexes</span><span class="main">]</span>
  
<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Refine</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">vcg</span> <span class="main">=</span> <span class="entity">Named_Thms</span>
    <span class="main">(</span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> refine_vcg<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Refinement Framework: "</span> ^ 
        <span class="inner_quoted">"Verification condition generation rules (intro)"</span> <span class="main">)</span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">vcg_cons</span> <span class="main">=</span> <span class="entity">Named_Thms</span>
    <span class="main">(</span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> refine_vcg_cons<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Refinement Framework: "</span> ^
        <span class="inner_quoted">"Consequence rules tried by VCG"</span> <span class="main">)</span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">refine0</span> <span class="main">=</span> <span class="entity">Named_Thms</span>
    <span class="main">(</span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> refine0<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Refinement Framework: "</span> ^
        <span class="inner_quoted">"Refinement rules applied first (intro)"</span> <span class="main">)</span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">refine</span> <span class="main">=</span> <span class="entity">Named_Thms</span>
    <span class="main">(</span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> refine<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Refinement Framework: Refinement rules (intro)"</span> <span class="main">)</span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">refine2</span> <span class="main">=</span> <span class="entity">Named_Thms</span>
    <span class="main">(</span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> refine2<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Refinement Framework: "</span> ^
        <span class="inner_quoted">"Refinement rules 2nd stage (intro)"</span> <span class="main">)</span>

  <span class="comment1">(* If set to true, the product splitter of refine_rcg is disabled. *)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">no_prod_split</span> <span class="main">=</span> 
    <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> refine_no_prod_split<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rcg_tac</span> <span class="entity">add_thms</span> <span class="entity">ctxt</span> <span class="main">=</span> 
    <span class="keyword2"><span class="keyword">let</span></span> 
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cons_thms</span> <span class="main">=</span> <span class="entity">vcg_cons.get</span> <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ref_thms</span> <span class="main">=</span> <span class="main">(</span><span class="entity">refine0.get</span> <span class="entity">ctxt</span> 
        @ <span class="entity">add_thms</span> @ <span class="entity">refine.get</span> <span class="entity">ctxt</span> @ <span class="entity">refine2.get</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prod_ss</span> <span class="main">=</span> <span class="main">(</span><span class="entity">Splitter.add_split</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> prod.split<span class="antiquote">}</span></span></span> 
        <span class="main">(</span>put_simpset <span class="entity">HOL_basic_ss</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prod_simp_tac</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">if</span></span> Config.get <span class="entity">ctxt</span> <span class="entity">no_prod_split</span> <span class="keyword2"><span class="keyword">then</span></span> 
          K no_tac
        <span class="keyword2"><span class="keyword">else</span></span>
          <span class="main">(</span><span class="entity">simp_tac</span> <span class="entity">prod_ss</span> THEN' 
            REPEAT_ALL_NEW <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> impI allI<span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">REPEAT_ALL_NEW_FWD</span> <span class="main">(</span>DETERM o FIRST' <span class="main">[</span>
        resolve_tac <span class="entity">ctxt</span> <span class="entity">ref_thms</span><span class="main">,</span>
        resolve_tac <span class="entity">ctxt</span> <span class="entity">cons_thms</span> THEN' resolve_tac <span class="entity">ctxt</span> <span class="entity">ref_thms</span><span class="main">,</span>
        <span class="entity">prod_simp_tac</span>
      <span class="main">]</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">post_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">REPEAT_ALL_NEW_FWD</span> <span class="main">(</span>FIRST' <span class="main">[</span>
    eq_assume_tac<span class="main">,</span>
    <span class="comment1">(*match_tac ctxt thms,*)</span>
    SOLVED' <span class="main">(</span><span class="entity">Tagged_Solver.solve_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> 
         

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">Refine.vcg.setup</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">Refine.vcg_cons.setup</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">Refine.refine0.setup</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">Refine.refine.setup</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">Refine.refine2.setup</span>›</span>
<span class="comment1">(*setup {* Refine.refine_post.setup *}*)</span>

<span class="keyword1"><span class="command">method_setup</span></span> refine_rcg <span class="main">=</span> 
  <span class="quoted">‹<span class="entity">Attrib.thms</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">add_thms</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span>
    <span class="entity">Refine.rcg_tac</span> <span class="entity">add_thms</span> <span class="entity">ctxt</span> <span class="entity">THEN_ALL_NEW_FWD</span> <span class="main">(</span>TRY o <span class="entity">Refine.post_tac</span> <span class="entity">ctxt</span><span class="main">)</span>
  <span class="main">)</span><span class="main">)</span>›</span> 
  <span class="quoted">"Refinement framework: Generate refinement conditions"</span>

<span class="keyword1"><span class="command">method_setup</span></span> refine_vcg <span class="main">=</span> 
  <span class="quoted">‹<span class="entity">Attrib.thms</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">add_thms</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span>
    <span class="entity">Refine.rcg_tac</span> <span class="main">(</span><span class="entity">add_thms</span> @ <span class="entity">Refine.vcg.get</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="entity">THEN_ALL_NEW_FWD</span> <span class="main">(</span>TRY o <span class="entity">Refine.post_tac</span> <span class="entity">ctxt</span><span class="main">)</span>
  <span class="main">)</span><span class="main">)</span>›</span> 
  <span class="quoted">"Refinement framework: Generate refinement and verification conditions"</span>


  <span class="comment1">(* Use tagged-solver instead!
  method_setup refine_post = 
    {* Scan.succeed (fn ctxt =&gt; SIMPLE_METHOD' (
      Refine.post_tac ctxt
    )) *} 
    "Refinement framework: Postprocessing of refinement goals"
    *)</span>

<span class="keyword1"><span class="command">declare</span></span> SPEC_cons_rule<span class="main">[</span><span class="operator">refine_vcg_cons</span><span class="main">]</span>    
    
    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Data Refinement›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section we establish a notion of pointwise data refinement, by
  lifting a relation <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>R›</span></span></span></span> between concrete and abstract values to 
  our result lattice.

  Given a relation <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>R›</span></span></span></span>, we define a {\em concretization function}
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⇓R›</span></span></span></span> that takes an abstract result, and returns a concrete result.
  The concrete result contains all values that are mapped by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>R›</span></span></span></span> to
  a value in the abstract result.

  Note that our concretization function forms no Galois connection, i.e.,
  in general there is no <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>α›</span></span></span></span> such that 
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m ≤⇓ R m'›</span></span></span></span> is equivalent to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>α m ≤ m'›</span></span></span></span>.
  However, we get a Galois connection for the special case of 
  single-valued relations.
 
  Regarding data refinement as Galois connections is inspired by \cite{mmo97},
  that also uses the adjuncts of
  a Galois connection to express data refinement by program refinement.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">conc_fun</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⇓</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">conc_fun</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">of</span> FAILi <span class="main">⇒</span> FAIL <span class="main">|</span> RES <span class="bound">X</span> <span class="main">⇒</span> RES <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">¯</span><span class="main">``</span><span class="bound">X</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">abs_fun</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⇑</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">abs_fun</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">of</span> FAILi <span class="main">⇒</span> FAIL 
    <span class="main">|</span> RES <span class="bound">X</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">X</span><span class="main">⊆</span>Domain <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="keyword1">then</span> RES <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">``</span><span class="bound">X</span><span class="main">)</span> <span class="keyword1">else</span> FAIL"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> 
  conc_fun_FAIL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⇓</span><span class="free">R</span> FAIL <span class="main">=</span> FAIL"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  conc_fun_RES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>RES <span class="free">X</span><span class="main">)</span> <span class="main">=</span> RES <span class="main">(</span><span class="free">R</span><span class="main">¯</span><span class="main">``</span><span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> conc_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nres.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_fun_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⇑</span><span class="free">R</span> FAIL <span class="main">=</span> FAIL"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">⊆</span>Domain <span class="free">R</span> <span class="main">⟹</span> <span class="main">⇑</span><span class="free">R</span> <span class="main">(</span>RES <span class="free">X</span><span class="main">)</span> <span class="main">=</span> RES <span class="main">(</span><span class="free">R</span><span class="main">``</span><span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">X</span><span class="main">⊆</span>Domain <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">⇑</span><span class="free">R</span> <span class="main">(</span>RES <span class="free">X</span><span class="main">)</span> <span class="main">=</span> FAIL"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> abs_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nres.split<span class="main">)</span>
  
<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="keyword2"><span class="keyword">assumes</span></span> SV<span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemma</span></span> conc_abs_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m'</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">m</span> <span class="main">⟷</span> <span class="main">⇑</span><span class="free">R</span> <span class="free">m'</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> conc_fun_def abs_fun_def <span class="keyword1"><span class="command">using</span></span> SV
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nres.split<span class="main">)</span>
    <span class="main">(</span><span class="operator">metis</span> ImageE converseD single_valuedD subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ac_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"galois_connection <span class="main">(</span><span class="main">⇑</span><span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">⇓</span><span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> conc_abs_swap<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pw_abs_nofail<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="main">⇑</span><span class="free">R</span> <span class="free">M</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>nofail <span class="free">M</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> inres <span class="free">M</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">x</span><span class="main">∈</span>Domain <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abs_fun_simps abs_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> pw_abs_inres<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span><span class="main">⇑</span><span class="free">R</span> <span class="free">M</span><span class="main">)</span> <span class="free">a</span> <span class="main">⟷</span> <span class="main">(</span>nofail <span class="main">(</span><span class="main">⇑</span><span class="free">R</span> <span class="free">M</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c</span><span class="main">.</span> inres <span class="free">M</span> <span class="bound">c</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abs_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> pw_conc_nofail<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="main">⇓</span><span class="free">R</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> nofail <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_fun_RES<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pw_conc_inres<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span><span class="main">⇓</span><span class="free">R</span> <span class="free">S'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> nofail <span class="free">S'</span> 
  <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">∧</span> inres <span class="free">S'</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">S'</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_fun_RES<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> abs_fun_strict<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⇑</span> <span class="free">R</span> SUCCEED <span class="main">=</span> SUCCEED"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> abs_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nres.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> conc_fun_strict<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⇓</span> <span class="free">R</span> SUCCEED <span class="main">=</span> SUCCEED"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> conc_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nres.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> conc_fun_mono<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="main">⇓</span><span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_fun_mono<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="main">⇑</span><span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> conc_fun_R_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊆</span> <span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⇓</span><span class="free">R</span> <span class="free">M</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R'</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> conc_fun_chain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="main">⇓</span><span class="free">S</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="main">⇓</span><span class="main">(</span><span class="free">R</span> <span class="keyword1">O</span> <span class="free">S</span><span class="main">)</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> conc_fun_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nres.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> conc_Id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⇓</span>Id <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> conc_fun_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nres.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_Id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⇑</span>Id <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> abs_fun_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nres.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> conc_fun_fail_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⇓</span><span class="free">R</span> <span class="free">S</span> <span class="main">=</span> FAIL <span class="main">⟷</span> <span class="free">S</span><span class="main">=</span>FAIL"</span></span>
  <span class="quoted"><span class="quoted">"FAIL <span class="main">=</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">S</span> <span class="main">⟷</span> <span class="free">S</span><span class="main">=</span>FAIL"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> conc_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R'</span> <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="main">⇓</span><span class="free">R'</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⇑</span><span class="free">R</span> <span class="free">C</span> <span class="main">≤</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⇑</span><span class="free">R'</span> <span class="free">B</span> <span class="main">≤</span> <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⇑</span><span class="free">R'</span> <span class="main">(</span><span class="main">⇑</span><span class="free">R</span> <span class="free">C</span><span class="main">)</span> <span class="main">≤</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Transitivity Reasoner Setup›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹WARNING: The order of the single statements is important here!›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> conc_trans_additional<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">.</span> <span class="bound">A</span><span class="main">≤</span><span class="main">⇓</span><span class="free">R</span>  <span class="bound">B</span> <span class="main">⟹</span> <span class="bound">B</span><span class="main">≤</span>    <span class="bound">C</span> <span class="main">⟹</span> <span class="bound">A</span><span class="main">≤</span><span class="main">⇓</span><span class="free">R</span>  <span class="bound">C</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">.</span> <span class="bound">A</span><span class="main">≤</span><span class="main">⇓</span>Id <span class="bound">B</span> <span class="main">⟹</span> <span class="bound">B</span><span class="main">≤</span><span class="main">⇓</span><span class="free">R</span>  <span class="bound">C</span> <span class="main">⟹</span> <span class="bound">A</span><span class="main">≤</span><span class="main">⇓</span><span class="free">R</span>  <span class="bound">C</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">.</span> <span class="bound">A</span><span class="main">≤</span><span class="main">⇓</span><span class="free">R</span>  <span class="bound">B</span> <span class="main">⟹</span> <span class="bound">B</span><span class="main">≤</span><span class="main">⇓</span>Id <span class="bound">C</span> <span class="main">⟹</span> <span class="bound">A</span><span class="main">≤</span><span class="main">⇓</span><span class="free">R</span>  <span class="bound">C</span>"</span></span>

  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">.</span> <span class="bound">A</span><span class="main">≤</span><span class="main">⇓</span>Id <span class="bound">B</span> <span class="main">⟹</span> <span class="bound">B</span><span class="main">≤</span><span class="main">⇓</span>Id <span class="bound">C</span> <span class="main">⟹</span> <span class="bound">A</span><span class="main">≤</span>    <span class="bound">C</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">.</span> <span class="bound">A</span><span class="main">≤</span><span class="main">⇓</span>Id <span class="bound">B</span> <span class="main">⟹</span> <span class="bound">B</span><span class="main">≤</span>    <span class="bound">C</span> <span class="main">⟹</span> <span class="bound">A</span><span class="main">≤</span>    <span class="bound">C</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">.</span> <span class="bound">A</span><span class="main">≤</span>    <span class="bound">B</span> <span class="main">⟹</span> <span class="bound">B</span><span class="main">≤</span><span class="main">⇓</span>Id <span class="bound">C</span> <span class="main">⟹</span> <span class="bound">A</span><span class="main">≤</span>    <span class="bound">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> conc_trans<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted">Id</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order_trans<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹WARNING: The order of the single statements is important here!›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> abs_trans_additional<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">A</span> <span class="main">≤</span> <span class="bound">B</span><span class="main">;</span> <span class="main">⇑</span> <span class="free">R</span> <span class="bound">B</span> <span class="main">≤</span> <span class="bound">C</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⇑</span> <span class="free">R</span> <span class="bound">A</span> <span class="main">≤</span> <span class="bound">C</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">.</span> <span class="main">⟦</span><span class="main">⇑</span> Id <span class="bound">A</span> <span class="main">≤</span> <span class="bound">B</span><span class="main">;</span> <span class="main">⇑</span> <span class="free">R</span> <span class="bound">B</span> <span class="main">≤</span> <span class="bound">C</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⇑</span> <span class="free">R</span> <span class="bound">A</span> <span class="main">≤</span> <span class="bound">C</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">.</span> <span class="main">⟦</span><span class="main">⇑</span> <span class="free">R</span> <span class="bound">A</span> <span class="main">≤</span> <span class="bound">B</span><span class="main">;</span> <span class="main">⇑</span> Id <span class="bound">B</span> <span class="main">≤</span> <span class="bound">C</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⇑</span> <span class="free">R</span> <span class="bound">A</span> <span class="main">≤</span> <span class="bound">C</span>"</span></span>

  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">.</span> <span class="main">⟦</span><span class="main">⇑</span> Id <span class="bound">A</span> <span class="main">≤</span> <span class="bound">B</span><span class="main">;</span> <span class="main">⇑</span> Id <span class="bound">B</span> <span class="main">≤</span> <span class="bound">C</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">A</span> <span class="main">≤</span> <span class="bound">C</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">.</span> <span class="main">⟦</span><span class="main">⇑</span> Id <span class="bound">A</span> <span class="main">≤</span> <span class="bound">B</span><span class="main">;</span> <span class="bound">B</span> <span class="main">≤</span> <span class="bound">C</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">A</span> <span class="main">≤</span> <span class="bound">C</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">A</span> <span class="main">≤</span> <span class="bound">B</span><span class="main">;</span> <span class="main">⇑</span> Id <span class="bound">B</span> <span class="main">≤</span> <span class="bound">C</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">A</span> <span class="main">≤</span> <span class="bound">C</span>"</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> pw_le_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derived Program Constructs›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section, we introduce some programming constructs that are derived 
  from the basic monad and ordering operations of our nondeterminism monad.
›</span></span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ASSUME and ASSERT›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ASSERT</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ASSERT</span> <span class="main">≡</span> iASSERT RETURN"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ASSUME</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ASSUME</span> <span class="main">≡</span> iASSUME RETURN"</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> assert<span class="main">?</span><span class="main">:</span> generic_Assert <span class="quoted">bind</span> <span class="quoted">RETURN</span> <span class="quoted">ASSERT</span> <span class="quoted">ASSUME</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ASSERT_def ASSUME_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Order matters! ›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span> <span class="main">=</span> ASSERT_leI 
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span> <span class="main">=</span> le_ASSUMEI 
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span> <span class="main">=</span> le_ASSERTI 
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span> <span class="main">=</span> ASSUME_leI
    
    
<span class="keyword1"><span class="command">lemma</span></span> pw_ASSERT<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>ASSERT <span class="free">Φ</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">Φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>ASSERT <span class="free">Φ</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pw_ASSUME<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>ASSUME <span class="free">Φ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>ASSUME <span class="free">Φ</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Recursion›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> pw_REC_nofail<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>REC <span class="free">B</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> trimono <span class="free">B</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">F</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> 
    nofail <span class="main">(</span><span class="bound">F</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> nofail <span class="main">(</span><span class="free">B</span> <span class="bound">F</span> <span class="bound">x</span><span class="main">)</span> 
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x'</span><span class="main">.</span> inres <span class="main">(</span><span class="free">B</span> <span class="bound">F</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">x'</span> <span class="main">⟶</span> inres <span class="main">(</span><span class="bound">F</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">x'</span><span class="main">)</span>
  <span class="main">)</span> <span class="main">∧</span> nofail <span class="main">(</span><span class="bound">F</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>REC <span class="free">B</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> trimono <span class="free">B</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">F</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">B</span> <span class="bound">F</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">F</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> nofail <span class="main">(</span><span class="bound">F</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> REC_def lfp_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_funI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_funD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pw_le_iff <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pw_REC_inres<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>REC <span class="free">B</span> <span class="free">x</span><span class="main">)</span> <span class="free">x'</span> <span class="main">=</span> <span class="main">(</span>trimono <span class="free">B</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">F</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x''</span><span class="main">.</span> 
    nofail <span class="main">(</span><span class="bound">F</span> <span class="bound">x''</span><span class="main">)</span> <span class="main">⟶</span> nofail <span class="main">(</span><span class="free">B</span> <span class="bound">F</span> <span class="bound">x''</span><span class="main">)</span> 
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> inres <span class="main">(</span><span class="free">B</span> <span class="bound">F</span> <span class="bound">x''</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟶</span> inres <span class="main">(</span><span class="bound">F</span> <span class="bound">x''</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">⟶</span> inres <span class="main">(</span><span class="bound">F</span> <span class="free">x</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inres <span class="main">(</span>REC <span class="free">B</span> <span class="free">x</span><span class="main">)</span> <span class="free">x'</span> 
    <span class="main">⟷</span> <span class="main">(</span>trimono <span class="free">B</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">F</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x''</span><span class="main">.</span> <span class="free">B</span> <span class="bound">F</span> <span class="bound">x''</span> <span class="main">≤</span> <span class="bound">F</span> <span class="bound">x''</span><span class="main">)</span> <span class="main">⟶</span> inres <span class="main">(</span><span class="bound">F</span> <span class="free">x</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> REC_def lfp_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_funI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_funD<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> pw_le_iff <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemmas</span></span> pw_REC <span class="main">=</span> pw_REC_inres pw_REC_nofail

<span class="keyword1"><span class="command">lemma</span></span> pw_RECT_nofail<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>RECT <span class="free">B</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> trimono <span class="free">B</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">F</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> nofail <span class="main">(</span><span class="free">B</span> <span class="bound">F</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟶</span>
             nofail <span class="main">(</span><span class="bound">F</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> inres <span class="main">(</span><span class="bound">F</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟶</span> inres <span class="main">(</span><span class="free">B</span> <span class="bound">F</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
        nofail <span class="main">(</span><span class="bound">F</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>RECT <span class="free">B</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>trimono <span class="free">B</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">F</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">F</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">B</span> <span class="bound">F</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟶</span> nofail <span class="main">(</span><span class="bound">F</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> RECT_gfp_def gfp_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_funI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_funD<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pw_le_iff <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pw_RECT_inres<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inres <span class="main">(</span>RECT <span class="free">B</span> <span class="free">x</span><span class="main">)</span> <span class="free">x'</span> <span class="main">=</span> <span class="main">(</span>trimono <span class="free">B</span> <span class="main">⟶</span>
   <span class="main">(</span><span class="main">∃</span><span class="bound">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> nofail <span class="main">(</span><span class="free">B</span> <span class="bound">M</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟶</span>
             nofail <span class="main">(</span><span class="bound">M</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> inres <span class="main">(</span><span class="bound">M</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟶</span> inres <span class="main">(</span><span class="free">B</span> <span class="bound">M</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
        inres <span class="main">(</span><span class="bound">M</span> <span class="free">x</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inres <span class="main">(</span>RECT <span class="free">B</span> <span class="free">x</span><span class="main">)</span> <span class="free">x'</span> <span class="main">⟷</span> trimono <span class="free">B</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">M</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">B</span> <span class="bound">M</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> inres <span class="main">(</span><span class="bound">M</span> <span class="free">x</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> RECT_gfp_def gfp_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_funI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_funD<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> pw_le_iff <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemmas</span></span> pw_RECT <span class="main">=</span> pw_RECT_inres pw_RECT_nofail

  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof Rules›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proving Correctness›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section, we establish Hoare-like rules to prove that a program
  meets its specification.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> le_SPEC_UNIV_rule <span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">≤</span> RES UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">lemma</span></span> RETURN_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="free">x</span> <span class="main">⟹</span> RETURN <span class="free">x</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> RETURN_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> RES_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> RES <span class="free">S</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> SUCCEED_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"SUCCEED <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> FAIL_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"False <span class="main">⟹</span> FAIL <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> SPEC_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Φ'</span> <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> SPEC <span class="free">Φ</span> <span class="main">≤</span> SPEC <span class="free">Φ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> RETURN_to_SPEC_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">≤</span>SPEC <span class="main">(</span><span class="main">(=)</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">m</span><span class="main">≤</span>RETURN <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Sup_img_rule_complete<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="free">Φ</span><span class="main">)</span> <span class="main">⟷</span> Sup <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> pw_leI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> pw_leI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> SUP_img_rule_complete<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="free">Φ</span><span class="main">)</span> <span class="main">⟷</span> Sup <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Sup_img_rule_complete <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> Sup_img_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="free">Φ</span> <span class="main">⟧</span> <span class="main">⟹</span> Sup<span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SUP_img_rule_complete<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This lemma is just to demonstrate that our rule is complete.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> bind_rule_complete<span class="main">:</span> <span class="quoted"><span class="quoted">"bind <span class="free">M</span> <span class="free">f</span> <span class="main">≤</span> SPEC <span class="free">Φ</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="free">Φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> bind_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">M</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="free">Φ</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> bind <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
  <span class="comment1">― ‹Note: <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"η"</span><span class="antiquote">}</span></span>-expanded version helps Isabelle's unification to keep meaningful 
      variable names from the program›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bind_rule_complete<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ASSUME_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Φ</span> <span class="main">⟹</span> <span class="free">Ψ</span> <span class="main">()</span><span class="main">⟧</span> <span class="main">⟹</span> ASSUME <span class="free">Φ</span> <span class="main">≤</span> SPEC <span class="free">Ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ASSERT_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Φ</span><span class="main">;</span> <span class="free">Φ</span> <span class="main">⟹</span> <span class="free">Ψ</span> <span class="main">()</span><span class="main">⟧</span> <span class="main">⟹</span> ASSERT <span class="free">Φ</span> <span class="main">≤</span> SPEC <span class="free">Ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> prod_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">p</span><span class="main">=</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">S</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">≤</span> SPEC <span class="free">Φ</span><span class="main">⟧</span> <span class="main">⟹</span> case_prod <span class="free">S</span> <span class="free">p</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="comment1">(* TODO: Add a simplifier setup that normalizes nested case-expressions to
  the vcg! *)</span>
<span class="keyword1"><span class="command">lemma</span></span> prod2_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">.</span> <span class="main">⟦</span><span class="free">ab</span><span class="main">=</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">;</span> <span class="free">cd</span><span class="main">=</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">)</span> <span class="free">ab</span> <span class="free">cd</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> if_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">S1</span> <span class="main">≤</span> SPEC <span class="free">Φ</span><span class="main">;</span> <span class="main">¬</span><span class="free">b</span> <span class="main">⟹</span> <span class="free">S2</span> <span class="main">≤</span> SPEC <span class="free">Φ</span><span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">S1</span> <span class="keyword1">else</span> <span class="free">S2</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> option_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v</span><span class="main">=</span>None <span class="main">⟹</span> <span class="free">S1</span> <span class="main">≤</span> SPEC <span class="free">Φ</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">v</span><span class="main">=</span>Some <span class="bound">x</span> <span class="main">⟹</span> <span class="free">f2</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="free">Φ</span><span class="main">⟧</span> 
  <span class="main">⟹</span> case_option <span class="free">S1</span> <span class="free">f2</span> <span class="free">v</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Let_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> SPEC <span class="free">Φ</span> <span class="main">⟹</span> Let <span class="free">x</span> <span class="free">f</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Let_rule'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="free">v</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Let <span class="free">v</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="comment1">(* Obsolete, use RECT_eq_REC_tproof instead
text {* The following lemma shows that greatest and least fixed point are equal,
  if we can provide a variant. *}
thm RECT_eq_REC
lemma RECT_eq_REC_old:
  assumes WF: "wf V"
  assumes I0: "I x"
  assumes IS: "⋀f x. I x ⟹ 
    body (λx'. do { ASSERT (I x' ∧ (x',x)∈V); f x'}) x ≤ body f x"
  shows "REC<span class="hidden">⇩</span><sub>T</sub> body x = REC body x"
  apply (rule RECT_eq_REC)
  apply (rule WF)
  apply (rule I0)
  apply (rule order_trans[OF _ IS])
  apply (subgoal_tac "(λx'. if I x' ∧ (x', x) ∈ V then f x' else FAIL) = 
    (λx'. ASSERT (I x' ∧ (x', x) ∈ V) ⤜ (λ_. f x'))")
  apply simp
  apply (rule ext)
  apply (rule pw_eqI)
  apply (auto simp add: refine_pw_simps)
  done
*)</span>

<span class="comment1">(* TODO: Also require RECT_le_rule. Derive RECT_invisible_refine from that. *)</span>
<span class="keyword1"><span class="command">lemma</span></span> REC_le_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">body</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">x'</span><span class="main">;</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">body</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"REC <span class="free">body</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="free">x'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> REC_rule_arb<span class="main"><span class="main">[</span></span><span class="operator">OF</span> M<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pre<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x'</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> I0 IS<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="comment1">(* TODO: Invariant annotations and vcg-rule
  Possibility 1: Semantically alter the program, such that it fails if the 
    invariant does not hold
  Possibility 2: Only syntactically annotate the invariant, as hint for the VCG.
*)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proving Monotonicity›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nr_mono_bind<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> MA<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> MB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> mono <span class="main">(</span><span class="free">B</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="main">λ</span><span class="bound">F</span> <span class="bound">s</span><span class="main">.</span> bind <span class="main">(</span><span class="free">A</span> <span class="bound">F</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">B</span> <span class="bound">s</span> <span class="bound">F</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monoI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bind_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> monoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MA<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> le_funD<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> monoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MB<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> le_funD<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> nr_mono_bind'<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="main">λ</span><span class="bound">F</span> <span class="bound">s</span><span class="main">.</span> bind <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bind_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_funD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> nr_mono <span class="main">=</span> nr_mono_bind nr_mono_bind' mono_const mono_if mono_id

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proving Refinement›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this subsection, we establish rules to prove refinement between 
  structurally similar programs. All rules are formulated including a possible
  data refinement via a refinement relation. If this is not required, the 
  refinement relation can be chosen to be the identity relation.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If we have two identical programs, this rule solves the refinement goal
  immediately, using the identity refinement relation.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> Id_refine<span class="main">[</span><span class="operator">refine0</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≤</span> <span class="main">⇓</span>Id <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> RES_refine<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s'</span><span class="main">∈</span><span class="free">S'</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> RES <span class="free">S</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>RES <span class="free">S'</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_fun_RES<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SPEC_refine<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">∧</span> <span class="free">Φ</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>SPEC <span class="free">Φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="comment1">(* TODO/FIXME: This is already part of a type-based heuristics! *)</span>
<span class="keyword1"><span class="command">lemma</span></span> Id_SPEC_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≤</span> SPEC <span class="free">Φ</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">≤</span> <span class="main">⇓</span>Id <span class="main">(</span>SPEC <span class="free">Φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> RETURN_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="free">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>RETURN <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> RETURN_def conc_fun_RES<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RETURN_SPEC_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">∧</span> <span class="free">Φ</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="free">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>SPEC <span class="free">Φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> FAIL_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> FAIL"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> SUCCEED_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"SUCCEED <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sup_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ai</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bi</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sup <span class="free">ai</span> <span class="free">bi</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>sup <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
    
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next two rules are incomplete, but a good approximation for refining
  structurally similar programs.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> bind_refine'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'b</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">R</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">×</span><span class="tfree">'d</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R'</span> <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> inres <span class="free">M</span> <span class="bound">x</span><span class="main">;</span> inres <span class="free">M'</span> <span class="bound">x'</span><span class="main">;</span>
    nofail <span class="free">M</span><span class="main">;</span> nofail <span class="free">M'</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bind <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R</span> <span class="main">(</span>bind <span class="free">M'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> bind_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'b</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">R</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">×</span><span class="tfree">'d</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R'</span> <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bind <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R</span> <span class="main">(</span>bind <span class="free">M'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bind_refine'<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> bind_refine_abs'<span class="main">:</span> <span class="comment1">(* Only keep nf_inres-information for abstract *)</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'b</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">R</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">×</span><span class="tfree">'d</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R'</span> <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> nf_inres <span class="free">M'</span> <span class="bound">x'</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bind <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R</span> <span class="main">(</span>bind <span class="free">M'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Special cases for refinement of binding to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>RES›</span></span></span></span>
  statements›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> bind_refine_RES<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>RES <span class="free">X</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R'</span> <span class="free">M'</span><span class="main">;</span>
  <span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">⟧</span>
  <span class="main">⟹</span> RES <span class="free">X</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R</span> <span class="main">(</span><span class="free">M'</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">M</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R'</span> <span class="main">(</span>RES <span class="free">X'</span><span class="main">)</span><span class="main">;</span>
  <span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">;</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">X'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R</span> <span class="main">(</span>RES <span class="free">X'</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>RES <span class="free">X</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R'</span> <span class="main">(</span>RES <span class="free">X'</span><span class="main">)</span><span class="main">;</span>
  <span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">;</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">X'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">⟧</span>
  <span class="main">⟹</span> RES <span class="free">X</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R</span> <span class="main">(</span>RES <span class="free">X'</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_refine'<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> bind_refine_RES<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">refine</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> bind_refine_RES<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">refine</span><span class="main">]</span>


<span class="keyword1"><span class="command">lemma</span></span> ASSERT_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Φ'</span><span class="main">⟹</span><span class="free">Φ</span> <span class="main">⟧</span> <span class="main">⟹</span> ASSERT <span class="free">Φ</span> <span class="main">≤</span> <span class="main">⇓</span>Id <span class="main">(</span>ASSERT <span class="free">Φ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ'</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ASSUME_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Φ</span> <span class="main">⟹</span> <span class="free">Φ'</span> <span class="main">⟧</span> <span class="main">⟹</span> ASSUME <span class="free">Φ</span> <span class="main">≤</span> <span class="main">⇓</span>Id <span class="main">(</span>ASSUME <span class="free">Φ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Assertions and assumptions are treated specially in bindings
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> ASSERT_refine_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="free">S'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="free">Φ</span><span class="main">;</span> <span class="free">S'</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> ASSERT_refine_right_pres<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="free">Φ</span><span class="main">;</span> <span class="free">S'</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="free">Φ</span><span class="main">;</span> <span class="free">S'</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ASSERT_refine_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">S'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span><span class="main">{</span>ASSERT <span class="free">Φ</span><span class="main">;</span> <span class="free">S</span><span class="main">}</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">S'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ASSUME_refine_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="free">S'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>ASSUME <span class="free">Φ</span><span class="main">;</span> <span class="free">S'</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ASSUME_refine_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">S'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>ASSUME <span class="free">Φ</span><span class="main">;</span> <span class="free">S</span><span class="main">}</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">S'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ASSUME_refine_left_pres<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">⟹</span> <span class="keyword1">do</span> <span class="main">{</span>ASSUME <span class="free">Φ</span><span class="main">;</span> <span class="free">S</span><span class="main">}</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">S'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>ASSUME <span class="free">Φ</span><span class="main">;</span> <span class="free">S</span><span class="main">}</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">S'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Warning: The order of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>[refine]›</span></span></span></span>-declarations is 
  important here, as preconditions should be generated before 
  additional proof obligations.›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine0</span><span class="main">]</span> <span class="main">=</span> ASSUME_refine_right
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine0</span><span class="main">]</span> <span class="main">=</span> ASSERT_refine_left
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine0</span><span class="main">]</span> <span class="main">=</span> ASSUME_refine_left
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine0</span><span class="main">]</span> <span class="main">=</span> ASSERT_refine_right

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For backward compatibility, as <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>intro refine›</span></span></span></span> still
  seems to be used instead of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>refine_rcg›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine</span><span class="main">]</span> <span class="main">=</span> ASSUME_refine_right
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine</span><span class="main">]</span> <span class="main">=</span> ASSERT_refine_left
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine</span><span class="main">]</span> <span class="main">=</span> ASSUME_refine_left
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine</span><span class="main">]</span> <span class="main">=</span> ASSERT_refine_right


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lift_assn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span>"</span></span>
  <span class="comment1">― ‹Lift assertion over refinement relation›</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lift_assn</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="bound">s'</span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> lift_assnI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">Φ</span> <span class="free">s'</span><span class="main">⟧</span> <span class="main">⟹</span> lift_assn <span class="free">R</span> <span class="free">Φ</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lift_assn_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>




<span class="keyword1"><span class="command">lemma</span></span> REC_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">body</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">f'</span> <span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">S</span> <span class="main">(</span><span class="bound">f'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> 
        REC <span class="free">body'</span> <span class="main">=</span> <span class="bound">f'</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">body</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">S</span> <span class="main">(</span><span class="free">body'</span> <span class="bound">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"REC <span class="main">(</span><span class="main">λ</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> <span class="free">body</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">x</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">S</span> <span class="main">(</span>REC <span class="main">(</span><span class="main">λ</span><span class="bound">f'</span> <span class="bound">x'</span><span class="main">.</span> <span class="free">body'</span> <span class="bound">f'</span> <span class="bound">x'</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> REC_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lfp_induct_pointwise<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pre<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x'</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">body</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> SUP_least<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trimonoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> M<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> R0<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lfp_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trimonoD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> RS<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> REC_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> RECT_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">body</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">f'</span> <span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">S</span> <span class="main">(</span><span class="bound">f'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">body</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">S</span> <span class="main">(</span><span class="free">body'</span> <span class="bound">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RECT <span class="main">(</span><span class="main">λ</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> <span class="free">body</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">x</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">S</span> <span class="main">(</span>RECT <span class="main">(</span><span class="main">λ</span><span class="bound">f'</span> <span class="bound">x'</span><span class="main">.</span> <span class="free">body'</span> <span class="bound">f'</span> <span class="bound">x'</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RECT_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> flatf_fixp_transfer<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
        fp'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"flatf_gfp <span class="free">body</span>"</span></span> 
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> B'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">body</span></span> 
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span><span class="main"><span class="main">,</span></span> 
    <span class="operator">OF</span> _ _ flatf_ord.fixp_unfold<span class="main"><span class="main">[</span></span><span class="operator">OF</span> M<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> trimonoD_flatf_ge<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> R0<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trimonoD<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> RS<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> if_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">⟷</span> <span class="free">b'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">b</span><span class="main">;</span><span class="free">b'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">S1</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">S1'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span><span class="free">b</span><span class="main">;</span><span class="main">¬</span><span class="free">b'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">S2</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">S2'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">S1</span> <span class="keyword1">else</span> <span class="free">S2</span><span class="main">)</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b'</span> <span class="keyword1">then</span> <span class="free">S1'</span> <span class="keyword1">else</span> <span class="free">S2'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Let_unfold_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Let <span class="free">x</span> <span class="free">f</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>Let <span class="free">x'</span> <span class="free">f'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next lemma is sometimes more convenient, as it prevents
  large let-expressions from exploding by being completely unfolded.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> Let_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span><span class="main">,</span><span class="free">m'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Let <span class="free">m</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>Let <span class="free">m'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Let_refine'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span><span class="main">,</span><span class="free">m'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span><span class="main">,</span><span class="free">m'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">m</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">S</span> <span class="main">(</span><span class="free">f'</span> <span class="free">m'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Let <span class="free">m</span> <span class="free">f</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">S</span> <span class="main">(</span>Let <span class="free">m'</span> <span class="free">f'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    
<span class="keyword1"><span class="command">lemma</span></span> case_option_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span>option_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">v</span><span class="main">=</span>None<span class="main">;</span> <span class="free">v'</span><span class="main">=</span>None<span class="main">⟧</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">Rb</span> <span class="free">n'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">v</span><span class="main">=</span>Some <span class="bound">x</span><span class="main">;</span> <span class="free">v'</span><span class="main">=</span>Some <span class="bound">x'</span><span class="main">;</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ra</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">Rb</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"case_option <span class="free">n</span> <span class="free">f</span> <span class="free">v</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">Rb</span> <span class="main">(</span>case_option <span class="free">n'</span> <span class="free">f'</span> <span class="free">v'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_case_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">li</span><span class="main">,</span><span class="free">l</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>list_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">fni</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="free">fn</span>"</span></span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xi</span> <span class="bound">x</span> <span class="bound">xsi</span> <span class="bound">xs</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">xi</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span><span class="main">;</span> <span class="main">(</span><span class="bound">xsi</span><span class="main">,</span><span class="bound">xs</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>list_rel<span class="main">;</span> <span class="free">li</span><span class="main">=</span><span class="bound">xi</span><span class="main">#</span><span class="bound">xsi</span><span class="main">;</span> <span class="free">l</span><span class="main">=</span><span class="bound">x</span><span class="main">#</span><span class="bound">xs</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">fci</span> <span class="bound">xi</span> <span class="bound">xsi</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">fc</span> <span class="bound">x</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="free">li</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="free">fni</span> <span class="main">|</span> <span class="bound">xi</span><span class="main">#</span><span class="bound">xsi</span> <span class="main">⇒</span> <span class="free">fci</span> <span class="bound">xi</span> <span class="bound">xsi</span><span class="main">)</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">l</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="free">fn</span> <span class="main">|</span> <span class="bound">x</span><span class="main">#</span><span class="bound">xs</span> <span class="main">⇒</span> <span class="free">fc</span> <span class="bound">x</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split<span class="main">)</span>  
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹It is safe to split conjunctions in refinement goals.›</span></span>
<span class="keyword1"><span class="command">declare</span></span> conjI<span class="main">[</span><span class="operator">refine</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following rules try to compensate for some structural changes,
  like inlining lets or converting binds to lets.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> remove_Let_refine<span class="main">[</span><span class="operator">refine2</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>Let <span class="free">x</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> intro_Let_refine<span class="main">[</span><span class="operator">refine2</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Let <span class="free">x</span> <span class="free">f</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">M'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">lemma</span></span> bind2let_refine<span class="main">[</span><span class="operator">refine2</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="free">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R'</span> <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Let <span class="free">x</span> <span class="free">f</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>bind <span class="free">M'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> bind_Let_refine2<span class="main">[</span><span class="operator">refine2</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> 
    <span class="free">m'</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R'</span> <span class="main">(</span>RETURN <span class="free">x</span><span class="main">)</span><span class="main">;</span>
    <span class="main">⋀</span><span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span>inres <span class="free">m'</span> <span class="bound">x'</span><span class="main">;</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f'</span> <span class="bound">x'</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m'</span><span class="main">⤜</span><span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>Let <span class="free">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> bind2letRETURN_refine<span class="main">[</span><span class="operator">refine2</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="free">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R'</span> <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span> <span class="main">⟹</span> RETURN <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="main">(</span>Let <span class="free">x</span> <span class="free">f</span><span class="main">)</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>bind <span class="free">M'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> RETURN_as_SPEC_refine<span class="main">[</span><span class="operator">refine2</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>RETURN <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RETURN_as_SPEC_refine_old<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">M</span> <span class="bound">R</span><span class="main">.</span> <span class="bound">M</span> <span class="main">≤</span> <span class="main">⇓</span><span class="bound">R</span> <span class="main">(</span>SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">M</span> <span class="main">≤</span><span class="main">⇓</span><span class="bound">R</span> <span class="main">(</span>RETURN <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RETURN_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> if_RETURN_refine <span class="main">[</span><span class="operator">refine2</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">⟷</span> <span class="free">b'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">b</span><span class="main">;</span><span class="free">b'</span><span class="main">⟧</span> <span class="main">⟹</span> RETURN <span class="free">S1</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">S1'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span><span class="free">b</span><span class="main">;</span><span class="main">¬</span><span class="free">b'</span><span class="main">⟧</span> <span class="main">⟹</span> RETURN <span class="free">S2</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">S2'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">S1</span> <span class="keyword1">else</span> <span class="free">S2</span><span class="main">)</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b'</span> <span class="keyword1">then</span> <span class="free">S1'</span> <span class="keyword1">else</span> <span class="free">S2'</span><span class="main">)</span>"</span></span>
  <span class="comment1">(* this is nice to have for small functions, hence keep it in refine2 *)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RES_sng_as_SPEC_refine<span class="main">[</span><span class="operator">refine2</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>RES <span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> intro_spec_refine_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>bind <span class="main">(</span>RES <span class="free">X</span><span class="main">)</span> <span class="free">f</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">M</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> intro_spec_refine<span class="main">[</span><span class="operator">refine2</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">X</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bind <span class="main">(</span>RES <span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> intro_spec_refine_iff<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following rules are intended for manual application, to reflect 
  some common structural changes, that, however, are not suited to be applied
  automatically.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Replacing a let by a deterministic computation›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> let2bind_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R'</span> <span class="main">(</span>RETURN <span class="free">m'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bind <span class="free">m</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>Let <span class="free">m'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Introduce a new binding, without a structural match in the abstract 
  program›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> intro_bind_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R'</span> <span class="main">(</span>RETURN <span class="free">m'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="free">m'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">m''</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bind <span class="free">m</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">m''</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> intro_bind_refine_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="main">(</span>SPEC <span class="main">(</span><span class="main">(=)</span> <span class="free">m'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">m'</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">m''</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bind <span class="free">m</span> <span class="free">f</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">m''</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following set of rules executes a step on the LHS or RHS of 
  a refinement proof obligation, without changing the other side.
  These kind of rules is useful for performing refinements with 
  invisible steps.›</span></span>  
<span class="keyword1"><span class="command">lemma</span></span> lhs_step_If<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≤</span> <span class="free">m</span><span class="main">;</span> <span class="main">¬</span><span class="free">b</span> <span class="main">⟹</span> <span class="free">e</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟧</span> <span class="main">⟹</span> If <span class="free">b</span> <span class="free">t</span> <span class="free">e</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> lhs_step_RES<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">X</span> <span class="main">⟹</span> RETURN <span class="bound">x</span> <span class="main">≤</span> <span class="free">m</span>  <span class="main">⟧</span> <span class="main">⟹</span> RES <span class="free">X</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lhs_step_SPEC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">x</span> <span class="main">⟹</span> RETURN <span class="bound">x</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟧</span> <span class="main">⟹</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lhs_step_bind<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nres"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> nres"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nofail <span class="free">m'</span> <span class="main">⟹</span> nofail <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> nf_inres <span class="free">m</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">m'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span><span class="bound">x</span><span class="main">←</span><span class="free">m</span><span class="main">;</span> <span class="free">f</span> <span class="bound">x</span><span class="main">}</span> <span class="main">≤</span> <span class="free">m'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> rhs_step_bind<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">m'</span>"</span></span> <span class="quoted"><span class="quoted">"inres <span class="free">m</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟹</span> <span class="free">lhs</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">S</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">lhs</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">S</span> <span class="main">(</span><span class="free">m'</span> <span class="main">⤜</span> <span class="free">f'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> rhs_step_bind_RES<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x'</span><span class="main">∈</span><span class="free">X'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>RES <span class="free">X'</span> <span class="main">⤜</span> <span class="free">f'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> rhs_step_bind_SPEC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="free">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>SPEC <span class="free">Φ</span> <span class="main">⤜</span> <span class="free">f'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> RES_bind_choose<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> RES <span class="free">X</span> <span class="main">⤜</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pw_RES_bind_choose<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>RES <span class="free">X</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> nofail <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>RES <span class="free">X</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> inres <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prod_case_refine<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p'</span><span class="main">,</span><span class="free">p</span><span class="main">)</span><span class="main">∈</span><span class="free">R1</span><span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span><span class="free">R2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x1'</span> <span class="bound">x2'</span> <span class="bound">x1</span> <span class="bound">x2</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">p'</span><span class="main">=</span><span class="main">(</span><span class="bound">x1'</span><span class="main">,</span><span class="bound">x2'</span><span class="main">)</span><span class="main">;</span> <span class="free">p</span><span class="main">=</span><span class="main">(</span><span class="bound">x1</span><span class="main">,</span><span class="bound">x2</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="bound">x1'</span><span class="main">,</span><span class="bound">x1</span><span class="main">)</span><span class="main">∈</span><span class="free">R1</span><span class="main">;</span> <span class="main">(</span><span class="bound">x2'</span><span class="main">,</span><span class="bound">x2</span><span class="main">)</span><span class="main">∈</span><span class="free">R2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f'</span> <span class="bound">x1'</span> <span class="bound">x2'</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x1</span> <span class="bound">x2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="free">p'</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x1'</span><span class="main">,</span><span class="bound">x2'</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">f'</span> <span class="bound">x1'</span> <span class="bound">x2'</span><span class="main">)</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">p</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x1</span><span class="main">,</span><span class="bound">x2</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">x1</span> <span class="bound">x2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Relators›</span></span>
<span class="keyword1"><span class="command">declare</span></span> fun_relI<span class="main">[</span><span class="operator">refine</span><span class="main">]</span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nres_rel</span> <span class="keyword2"><span class="keyword">where</span></span> 
  nres_rel_def_internal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nres_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="bound">c</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">a</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nres_rel_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="bound">c</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="bound">a</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nres_rel_def_internal relAPP_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nres_relD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel <span class="main">⟹</span> <span class="free">c</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nres_rel_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> nres_relI<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nres_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nres_rel_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>nres_rel <span class="keyword1">O</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span>nres_rel <span class="main">=</span> <span class="main">⟨</span><span class="free">A</span> <span class="keyword1">O</span> <span class="free">B</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nres_rel_def conc_fun_chain<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> conc_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pw_nres_rel_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>nres_rel <span class="main">⟷</span> nofail <span class="main">(</span><span class="main">⇓</span> <span class="free">A</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟶</span> nofail <span class="free">a</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> inres <span class="free">a</span> <span class="bound">x</span> <span class="main">⟶</span> inres <span class="main">(</span><span class="main">⇓</span> <span class="free">A</span> <span class="free">b</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff nres_rel_def<span class="main">)</span>
    
    
<span class="keyword1"><span class="command">lemma</span></span> param_SUCCEED<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>SUCCEED<span class="main">,</span>SUCCEED<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nres_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> param_FAIL<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>FAIL<span class="main">,</span>FAIL<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nres_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> param_RES<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>RES<span class="main">,</span>RES<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_rel_def nres_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> RES_refine<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> param_RETURN<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>RETURN<span class="main">,</span>RETURN<span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nres_rel_def RETURN_refine<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> param_bind<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>bind<span class="main">,</span>bind<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span>nres_rel <span class="main">→</span> <span class="main">(</span><span class="free">Ra</span><span class="main">→</span><span class="main">⟨</span><span class="free">Rb</span><span class="main">⟩</span>nres_rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rb</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nres_rel_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bind_refine <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> param_ASSERT_bind<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> 
    <span class="main">(</span><span class="free">Φ</span><span class="main">,</span><span class="free">Ψ</span><span class="main">)</span> <span class="main">∈</span> bool_rel<span class="main">;</span> 
    <span class="main">⟦</span> <span class="free">Φ</span><span class="main">;</span> <span class="free">Ψ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">g</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>ASSERT <span class="free">Φ</span> <span class="main">⪢</span> <span class="free">f</span><span class="main">,</span> ASSERT <span class="free">Ψ</span> <span class="main">⪢</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nres_relI<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Autoref Setup›</span></span>

<span class="keyword1"><span class="command">consts</span></span> i_nres <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> interface"</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">nres_rel</span> <span class="quoted">i_nres</span><span class="main">]</span>

<span class="comment1">(*lemma id_nres[autoref_id_self]: "ID_LIST 
  (l SUCCEED FAIL bind (REC::_ ⇒ _ ⇒ _ nres,1) (RECT::_ ⇒ _ ⇒ _ nres,1))"
  by simp_all
*)</span>
<span class="comment1">(*definition [simp]: "op_RETURN x ≡ RETURN x"
lemma [autoref_op_pat_def]: "RETURN x ≡ op_RETURN x" by simp
*)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">op_nres_ASSERT_bnd</span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="free"><span class="bound"><span class="entity">Φ</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> param_op_nres_ASSERT_bnd<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ'</span> <span class="main">⟹</span> <span class="free">Φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Φ'</span><span class="main">;</span> <span class="free">Φ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span><span class="free">m'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>op_nres_ASSERT_bnd <span class="free">Φ</span> <span class="free">m</span><span class="main">,</span> op_nres_ASSERT_bnd <span class="free">Φ'</span> <span class="free">m'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> nres_rel_def<span class="main">)</span>



<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lemma</span></span> id_ASSERT<span class="main">[</span><span class="operator">autoref_op_pat_def</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="free">Φ</span><span class="main">;</span> <span class="free">m</span><span class="main">}</span> <span class="main">≡</span> <span class="keyword1">OP</span> <span class="main">(</span>op_nres_ASSERT_bnd <span class="free">Φ</span><span class="main">)</span><span class="main">$</span><span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">op_nres_ASSUME_bnd</span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>ASSUME <span class="free"><span class="bound"><span class="entity">Φ</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> id_ASSUME<span class="main">[</span><span class="operator">autoref_op_pat_def</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>ASSUME <span class="free">Φ</span><span class="main">;</span> <span class="free">m</span><span class="main">}</span> <span class="main">≡</span> <span class="keyword1">OP</span> <span class="main">(</span>op_nres_ASSUME_bnd <span class="free">Φ</span><span class="main">)</span><span class="main">$</span><span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> autoref_SUCCEED<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>SUCCEED<span class="main">,</span>SUCCEED<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nres_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> autoref_FAIL<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>FAIL<span class="main">,</span>FAIL<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nres_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> autoref_RETURN<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>RETURN<span class="main">,</span>RETURN<span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nres_rel_def RETURN_refine<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> autoref_bind<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>bind<span class="main">,</span>bind<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R1</span><span class="main">⟩</span>nres_rel <span class="main">→</span> <span class="main">(</span><span class="free">R1</span><span class="main">→</span><span class="main">⟨</span><span class="free">R2</span><span class="main">⟩</span>nres_rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R2</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nres_relI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bind_refine<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> nres_relD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fun_relD<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> nres_relD<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lemma</span></span> autoref_ASSERT<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">m'</span><span class="main">,</span><span class="free">m</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>
    <span class="free">m'</span><span class="main">,</span>
    <span class="main">(</span><span class="keyword1">OP</span> <span class="main">(</span>op_nres_ASSERT_bnd <span class="free">Φ</span><span class="main">)</span> <span class="main">:::</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel<span class="main">)</span> <span class="main">$</span> <span class="free">m</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> nres_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ASSERT_refine_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> autoref_ASSUME<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="free">Φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">m'</span><span class="main">,</span><span class="free">m</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>
    <span class="free">m'</span><span class="main">,</span>
    <span class="main">(</span><span class="keyword1">OP</span> <span class="main">(</span>op_nres_ASSUME_bnd <span class="free">Φ</span><span class="main">)</span> <span class="main">:::</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel<span class="main">)</span> <span class="main">$</span> <span class="free">m</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> nres_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ASSUME_refine_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> autoref_REC<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span><span class="main">,</span><span class="free">B'</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">Ra</span><span class="main">→</span><span class="main">⟨</span><span class="free">Rr</span><span class="main">⟩</span>nres_rel<span class="main">)</span> <span class="main">→</span> <span class="free">Ra</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rr</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"DEFER trimono <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>REC <span class="free">B</span><span class="main">,</span>
    <span class="main">(</span><span class="keyword1">OP</span> REC 
      <span class="main">:::</span> <span class="main">(</span><span class="main">(</span><span class="free">Ra</span><span class="main">→</span><span class="main">⟨</span><span class="free">Rr</span><span class="main">⟩</span>nres_rel<span class="main">)</span> <span class="main">→</span> <span class="free">Ra</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rr</span><span class="main">⟩</span>nres_rel<span class="main">)</span> <span class="main">→</span> <span class="free">Ra</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rr</span><span class="main">⟩</span>nres_rel<span class="main">)</span><span class="main">$</span><span class="free">B'</span>
    <span class="main">)</span> <span class="main">∈</span> <span class="free">Ra</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rr</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nres_rel_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> REC_refine<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> param_RECT<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span><span class="main">,</span> <span class="free">B'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">Ra</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rr</span><span class="main">⟩</span>nres_rel<span class="main">)</span> <span class="main">→</span> <span class="free">Ra</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rr</span><span class="main">⟩</span>nres_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"trimono <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">REC<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">B</span><span class="main">,</span> <span class="keyword1">REC<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">B'</span><span class="main">)</span><span class="main">∈</span> <span class="free">Ra</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rr</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nres_rel_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> RECT_refine<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> autoref_RECT<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span><span class="main">,</span><span class="free">B'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">Ra</span><span class="main">→</span><span class="main">⟨</span><span class="free">Rr</span><span class="main">⟩</span>nres_rel<span class="main">)</span> <span class="main">→</span> <span class="free">Ra</span><span class="main">→</span><span class="main">⟨</span><span class="free">Rr</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"DEFER trimono <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RECT <span class="free">B</span><span class="main">,</span>
    <span class="main">(</span><span class="keyword1">OP</span> RECT 
      <span class="main">:::</span> <span class="main">(</span><span class="main">(</span><span class="free">Ra</span><span class="main">→</span><span class="main">⟨</span><span class="free">Rr</span><span class="main">⟩</span>nres_rel<span class="main">)</span> <span class="main">→</span> <span class="free">Ra</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rr</span><span class="main">⟩</span>nres_rel<span class="main">)</span> <span class="main">→</span> <span class="free">Ra</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rr</span><span class="main">⟩</span>nres_rel<span class="main">)</span><span class="main">$</span><span class="free">B'</span>
    <span class="main">)</span> <span class="main">∈</span> <span class="free">Ra</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rr</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> param_RECT<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Convenience Rules›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section, we define some lemmas that simplify common prover tasks.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ref_two_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">≤</span><span class="main">⇓</span><span class="free">R</span>  <span class="free">B</span> <span class="main">⟹</span> <span class="free">B</span><span class="main">≤</span><span class="free">C</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">≤</span><span class="main">⇓</span><span class="free">R</span>  <span class="free">C</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> conc_trans_additional<span class="main">)</span>

   
<span class="keyword1"><span class="command">lemma</span></span> pw_ref_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">S'</span> 
  <span class="main">⟷</span> <span class="main">(</span>nofail <span class="free">S'</span> 
    <span class="main">⟶</span> nofail <span class="free">S</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> inres <span class="free">S</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> inres <span class="free">S'</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pw_ref_I<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nofail <span class="free">S'</span> 
    <span class="main">⟶</span> nofail <span class="free">S</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> inres <span class="free">S</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> inres <span class="free">S'</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">S'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_ref_iff<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Introduce an abstraction relation. Usage: 
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rule introR[where R=absRel]›</span></span></span></span>
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> introR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">a'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">a'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> intro_prgR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> refine_IdI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">m'</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">≤</span> <span class="main">⇓</span>Id <span class="free">m'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    

<span class="keyword1"><span class="command">lemma</span></span> le_ASSERTI_pres<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">≤</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="free">Φ</span><span class="main">;</span> <span class="free">S'</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≤</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="free">Φ</span><span class="main">;</span> <span class="free">S'</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_ASSERTI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RETURN_ref_SPECD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="free">c</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>SPEC <span class="free">Φ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RETURN_ref_RETURND<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="free">c</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>RETURN <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> return_refine_prop_return<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nofail <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="free">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="free">x'</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> pw_le_iff<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> ignore_snd_refine_conv<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">≤</span> <span class="main">⇓</span><span class="main">(</span><span class="free">R</span><span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span>UNIV<span class="main">)</span> <span class="free">m'</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">m</span><span class="main">⤜</span><span class="main">(</span>RETURN <span class="keyword1">o</span> fst<span class="main">)</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">m'</span><span class="main">⤜</span><span class="main">(</span>RETURN <span class="keyword1">o</span> fst<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
    
    
<span class="keyword1"><span class="command">lemma</span></span> ret_le_down_conv<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"nofail <span class="free">m</span> <span class="main">⟹</span> RETURN <span class="free">c</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">m</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">∧</span> RETURN <span class="bound">a</span> <span class="main">≤</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> SPEC_eq_is_RETURN<span class="main">:</span>
  <span class="quoted"><span class="quoted">"SPEC <span class="main">(</span><span class="main">(=)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> RETURN <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="free">y</span><span class="main">)</span> <span class="main">=</span> RETURN <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> RETURN_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RETURN_SPEC_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"RETURN <span class="free">r</span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RETURN_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> refine2spec_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">b</span> <span class="main">⟷</span> <span class="main">(</span> <span class="main">(</span>nofail <span class="free">b</span> <span class="main">⟶</span> <span class="free">a</span> <span class="main">≤</span> SPEC <span class="main">(</span> <span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> inres <span class="free">b</span> <span class="bound">x</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span> <span class="main">)</span><span class="main">)</span> <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> refine2specI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nofail <span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> inres <span class="free">b</span> <span class="bound">x</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span> <span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">b</span>"</span></span>  
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refine2spec_aux<span class="main">)</span>  
    
<span class="keyword1"><span class="command">lemma</span></span> specify_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">M</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">←</span> <span class="free">m</span><span class="main">;</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">}</span> <span class="main">≤</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>  
    
<span class="keyword1"><span class="command">lemma</span></span> build_rel_SPEC<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≤</span> SPEC <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">Φ</span> <span class="main">(</span><span class="free">α</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">≤</span> <span class="main">⇓</span><span class="main">(</span>build_rel <span class="free">α</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>SPEC <span class="free">Φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> build_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> build_rel_SPEC_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⇓</span><span class="main">(</span>br <span class="free">α</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>SPEC <span class="free">Φ</span><span class="main">)</span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">I</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Φ</span> <span class="main">(</span><span class="free">α</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> br_def pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> refine_IdD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> <span class="main">⇓</span>Id <span class="free">a</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">≤</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> bind_sim_select_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">⤜</span><span class="free">f'</span> <span class="main">≤</span> SPEC <span class="free">Ψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span>nofail <span class="free">m</span><span class="main">;</span> inres <span class="free">m</span> <span class="bound">x</span><span class="main">;</span> <span class="free">f'</span> <span class="bound">x</span><span class="main">≤</span>SPEC <span class="free">Ψ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span><span class="main">≤</span>SPEC <span class="free">Φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">⤜</span><span class="free">f</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
  <span class="comment1">― ‹Simultaneously select a result from assumption and verification goal.
    Useful to work with assumptions that restrict the current program to 
    be verified.›</span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> assert_bind_spec_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"ASSERT <span class="free">Φ</span> <span class="main">⪢</span> <span class="free">m</span> <span class="main">≤</span> SPEC <span class="free">Ψ</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">Φ</span> <span class="main">∧</span> <span class="free">m</span> <span class="main">≤</span> SPEC <span class="free">Ψ</span><span class="main">)</span>"</span></span>  
  <span class="comment1">― ‹Simplify a bind-assert verification condition. 
    Useful if this occurs in the assumptions, and considerably faster than 
    using pointwise reasoning, which may causes a blowup for many chained 
    assertions.›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> summarize_ASSERT_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="free">Φ</span><span class="main">;</span> ASSERT <span class="free">Ψ</span><span class="main">;</span> <span class="free">m</span><span class="main">}</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="main">(</span><span class="free">Φ</span> <span class="main">∧</span> <span class="free">Ψ</span><span class="main">)</span><span class="main">;</span> <span class="free">m</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bind_ASSERT_eq_if<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span> ASSERT <span class="free">Φ</span><span class="main">;</span> <span class="free">m</span> <span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">Φ</span> <span class="keyword1">then</span> <span class="free">m</span> <span class="keyword1">else</span> FAIL<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    
<span class="keyword1"><span class="command">lemma</span></span> le_RES_nofailI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">≤</span>RES <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nofail <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nofail_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> pwD1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add_invar_refineI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> SPEC <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="main">{</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">c</span><span class="main">}</span> <span class="main">(</span><span class="free">f'</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> sv_add_invar<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> bind_RES_RETURN_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"bind <span class="main">(</span>RES <span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> RETURN <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
  RES <span class="main">{</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">X</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
    <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> bind_RES_RETURN2_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"bind <span class="main">(</span>RES <span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> RETURN <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
  RES <span class="main">{</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="free">X</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> le_SPEC_bindI<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> SPEC <span class="free">Φ</span> <span class="main">⤜</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bind_assert_refine<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">m2</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">m'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span><span class="bound">x</span><span class="main">←</span><span class="free">m1</span><span class="main">;</span> ASSERT <span class="main">(</span><span class="free">Φ</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> <span class="free">m2</span> <span class="bound">x</span><span class="main">}</span> <span class="main">≤</span> <span class="free">m'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">lemma</span></span> RETURN_refine_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"RETURN <span class="free">x</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>RETURN <span class="free">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RETURN_RES_refine_iff<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"RETURN <span class="free">x</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>RES <span class="free">Y</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">∈</span><span class="free">Y</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RETURN_RES_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">∧</span> <span class="bound">x'</span><span class="main">∈</span><span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="free">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>RES <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_nres_rel_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel <span class="main">⟷</span> <span class="free">a</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nres_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inf_RETURN_RES<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"inf <span class="main">(</span>RETURN <span class="free">x</span><span class="main">)</span> <span class="main">(</span>RES <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span><span class="main">∈</span><span class="free">X</span> <span class="keyword1">then</span> RETURN <span class="free">x</span> <span class="keyword1">else</span> SUCCEED<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"inf <span class="main">(</span>RES <span class="free">X</span><span class="main">)</span> <span class="main">(</span>RETURN <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span><span class="main">∈</span><span class="free">X</span> <span class="keyword1">then</span> RETURN <span class="free">x</span> <span class="keyword1">else</span> SUCCEED<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> inf_RETURN_SPEC<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inf <span class="main">(</span>RETURN <span class="free">x</span><span class="main">)</span> <span class="main">(</span>SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span><span class="main">=</span><span class="free">x</span> <span class="main">∧</span> <span class="free">Φ</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"inf <span class="main">(</span>SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>RETURN <span class="free">x</span><span class="main">)</span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span><span class="main">=</span><span class="free">x</span> <span class="main">∧</span> <span class="free">Φ</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RES_sng_eq_RETURN<span class="main">:</span> <span class="quoted"><span class="quoted">"RES <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> RETURN <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> nofail_inf_serialize<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>nofail <span class="free">a</span><span class="main">;</span> nofail <span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> inf <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">x</span><span class="main">←</span><span class="free">a</span><span class="main">;</span> ASSUME <span class="main">(</span>inres <span class="free">b</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> RETURN <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> conc_fun_SPEC<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">∧</span> <span class="free">Φ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> conc_fun_RETURN<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>RETURN <span class="free">x</span><span class="main">)</span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> use_spec_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> SPEC <span class="free">Ψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Ψ</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Φ</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> strengthen_SPEC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> SPEC <span class="free">Φ</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">≤</span> SPEC<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> inres <span class="free">m</span> <span class="bound">s</span> <span class="main">∧</span> nofail <span class="free">m</span> <span class="main">∧</span> <span class="free">Φ</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="comment1">― ‹Strengthen SPEC by adding trivial upper bound for result›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> weaken_SPEC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> SPEC <span class="free">Φ</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Ψ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">≤</span> SPEC <span class="free">Ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bind_le_nofailI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nofail <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> RETURN <span class="bound">x</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">m'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">⤜</span><span class="free">f</span> <span class="main">≤</span> <span class="free">m'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> pw_le_iff<span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> bind_le_shift<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bind <span class="free">m</span> <span class="free">f</span> <span class="main">≤</span> <span class="free">m'</span> 
  <span class="main">⟷</span> <span class="free">m</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">if</span> nofail <span class="free">m'</span> <span class="keyword1">then</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">m'</span><span class="main">)</span> <span class="keyword1">else</span> FAIL<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> If_bind_distrib<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nres"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>If <span class="free">b</span> <span class="free">t</span> <span class="free">e</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>If <span class="free">b</span> <span class="main">(</span><span class="free">t</span><span class="main">⤜</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">e</span><span class="main">⤜</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
<span class="comment1">(* TODO: Can we make this a simproc, using NO_MATCH? *)</span>  
<span class="keyword1"><span class="command">lemma</span></span> unused_bind_conv<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"NO_MATCH <span class="main">(</span>ASSERT <span class="free">Φ</span><span class="main">)</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"NO_MATCH <span class="main">(</span>ASSUME <span class="free">Φ</span><span class="main">)</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span><span class="main">⤜</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>  <span class="main">=</span> <span class="main">(</span>ASSERT <span class="main">(</span>nofail <span class="free">m</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> ASSUME <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> inres <span class="free">m</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following rules are useful for massaging programs before the 
  refinement takes place›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> let_to_bind_conv<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Let <span class="free">x</span> <span class="free">f</span> <span class="main">=</span> RETURN <span class="free">x</span><span class="main">⤜</span><span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> bind_to_let_conv <span class="main">=</span> let_to_bind_conv<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> pull_out_let_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"RETURN <span class="main">(</span>Let <span class="free">x</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> Let <span class="free">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> RETURN <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> push_in_let_conv<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Let <span class="free">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> RETURN <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> RETURN <span class="main">(</span>Let <span class="free">x</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"Let <span class="free">x</span> <span class="main">(</span>RETURN <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> RETURN <span class="main">(</span>Let <span class="free">x</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> pull_out_RETURN_case_option<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"case_option <span class="main">(</span>RETURN <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> RETURN <span class="main">(</span><span class="free">f</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> RETURN <span class="main">(</span>case_option <span class="free">a</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> if_bind_cond_refine<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ci</span> <span class="main">≤</span> RETURN <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">⟹</span> <span class="free">ti</span><span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">b</span> <span class="main">⟹</span> <span class="free">ei</span><span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span><span class="bound">b</span><span class="main">←</span><span class="free">ci</span><span class="main">;</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="free">ti</span> <span class="keyword1">else</span> <span class="free">ei</span><span class="main">}</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">t</span> <span class="keyword1">else</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> pw_le_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> intro_RETURN_Let_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="main">(</span>Let <span class="free">x</span> <span class="free">f</span><span class="main">)</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">M'</span>"</span></span> 
  <span class="comment1">(* this should be needed very rarely - so don't add it *)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ife_FAIL_to_ASSERT_cnv<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">Φ</span> <span class="keyword1">then</span> <span class="free">m</span> <span class="keyword1">else</span> FAIL<span class="main">)</span> <span class="main">=</span> op_nres_ASSERT_bnd <span class="free">Φ</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nres_bind_let_law<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">←</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="keyword1">let</span> <span class="bound">y</span><span class="main">=</span><span class="free">v</span><span class="main">;</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">}</span><span class="main">;</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">}</span> <span class="main">::</span> <span class="main">_</span> nres<span class="main">)</span>
  <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="keyword1">let</span> <span class="bound">y</span><span class="main">=</span><span class="free">v</span><span class="main">;</span> <span class="bound">x</span><span class="main">←</span> <span class="free">f</span> <span class="bound">y</span><span class="main">;</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> unused_bind_RES_ne<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">≠</span><span class="main">{}</span> <span class="main">⟹</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="main"><span class="bound">_</span></span> <span class="main">←</span> RES <span class="free">X</span><span class="main">;</span> <span class="free">m</span><span class="main">}</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> le_ASSERT_defI1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="free">Φ</span><span class="main">;</span> <span class="free">m</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">⟹</span> <span class="free">m'</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m'</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ASSERTI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> refine_ASSERT_defI1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="free">Φ</span><span class="main">;</span> <span class="free">m</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">⟹</span> <span class="free">m'</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m'</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_vcg</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> le_ASSERT_defI2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="free">Φ</span><span class="main">;</span> ASSERT <span class="free">Ψ</span><span class="main">;</span> <span class="free">m</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Φ</span><span class="main">;</span> <span class="free">Ψ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m'</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m'</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ASSERTI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> refine_ASSERT_defI2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="free">Φ</span><span class="main">;</span> ASSERT <span class="free">Ψ</span><span class="main">;</span> <span class="free">m</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Φ</span><span class="main">;</span> <span class="free">Ψ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m'</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m'</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_vcg</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ASSERT_le_defI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span> ASSERT <span class="free">Φ</span><span class="main">;</span> <span class="free">m'</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">⟹</span> <span class="free">m'</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ASSERT_same_eq_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ASSERT <span class="free">Φ</span> <span class="main">⪢</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ASSERT <span class="free">Φ</span> <span class="main">⪢</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">Φ</span> <span class="main">⟶</span> <span class="free">m</span><span class="main">=</span><span class="free">n</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> case_prod_bind_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="free">Φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">≤</span> SPEC <span class="free">Φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
<span class="keyword1"><span class="command">lemma</span></span> RECT_eq_REC'<span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>RECT <span class="free">B</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span> RECT <span class="free">B</span> <span class="free">x</span> <span class="main">=</span> REC <span class="free">B</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> RECT_eq_REC<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nofail_def<span class="main">)</span>
    
    
<span class="keyword1"><span class="command">lemma</span></span> rel2p_nres_RETURN<span class="main">[</span><span class="operator">rel2p</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel2p <span class="main">(</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>nres_rel<span class="main">)</span> <span class="main">(</span>RETURN <span class="free">x</span><span class="main">)</span> <span class="main">(</span>RETURN <span class="free">y</span><span class="main">)</span> <span class="main">=</span> rel2p <span class="free">A</span> <span class="free">x</span> <span class="free">y</span>"</span></span>   
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel2p_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nres_relD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nres_relI<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Boolean Operations on Specifications›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> SPEC_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">R</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">R</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">⟷</span> <span class="free">R</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">THEN</span> pw_le_iff<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">THEN</span></span> iffD1<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> pw_leI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SPEC_rule_conjI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≤</span> SPEC <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≤</span> SPEC <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="free">P</span> <span class="bound">v</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≤</span> inf <span class="main">(</span>SPEC <span class="free">P</span><span class="main">)</span> <span class="main">(</span>SPEC <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> inf_greatest<span class="main">)</span> <span class="operator">assumption</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Collect_conj_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> SPEC_rule_conjunct1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="free">P</span> <span class="bound">v</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≤</span> SPEC <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> assms
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> SPEC <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SPEC_rule<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> SPEC_rule_conjunct2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="free">P</span> <span class="bound">v</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≤</span> SPEC <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> assms
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> SPEC <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SPEC_rule<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pointwise Reasoning›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> inres_if<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inres <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="keyword1">then</span> <span class="free">Q</span> <span class="keyword1">else</span> <span class="free">R</span><span class="main">)</span> <span class="free">x</span><span class="main">;</span> <span class="main">⟦</span><span class="free">P</span><span class="main">;</span> inres <span class="free">Q</span> <span class="free">x</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">S</span><span class="main">;</span> <span class="main">⟦</span><span class="main">¬</span> <span class="free">P</span><span class="main">;</span> inres <span class="free">R</span> <span class="free">x</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inres_SPEC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inres <span class="free">M</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">≤</span> SPEC <span class="free">Φ</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pwD2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SPEC_nofail<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≤</span> SPEC <span class="free">Φ</span> <span class="main">⟹</span> nofail <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pwD1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nofail_SPEC<span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="free">m</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nofail_SPEC_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="free">m</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nofail_SPEC_triv_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> nofail <span class="free">m</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff<span class="main">)</span>




<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Refine_Leof">
<div class="head">
<h1>Theory Refine_Leof</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Less-Equal or Fail›</span></span>
<span class="comment1">(* TODO: Move to Refinement Framework *)</span>
<span class="keyword1"><span class="command">theory</span></span> Refine_Leof
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Refine_Basic.html">Refine_Basic</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A predicate that states refinement or that the LHS fails.›</span></span>


  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">le_or_fail</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nres <span class="main">⇒</span> <span class="tfree">'a</span> nres <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1"><span class="free">≤<span class="hidden">⇩</span><sub>n</sub></span></span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">≡</span> nofail <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> leofI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nofail <span class="free">m</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">m'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">m'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> le_or_fail_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> leofD<span class="main">:</span>  
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nofail <span class="free">m</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">m'</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">m'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> le_or_fail_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">lemma</span></span> pw_leof_iff<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">m'</span> <span class="main">⟷</span> <span class="main">(</span>nofail <span class="free">m</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> inres <span class="free">m</span> <span class="bound">x</span> <span class="main">⟶</span> inres <span class="free">m'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> le_or_fail_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
      
  <span class="keyword1"><span class="command">lemma</span></span> le_by_leofI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> nofail <span class="free">m'</span> <span class="main">⟹</span> nofail <span class="free">m</span><span class="main">;</span> <span class="free">m</span><span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span><span class="free">m'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">m'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff pw_leof_iff<span class="main">)</span>
      
  <span class="keyword1"><span class="command">lemma</span></span> inres_leof_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span><span class="free">m'</span> <span class="main">⟹</span> nofail <span class="free">m</span> <span class="main">⟹</span> inres <span class="free">m</span> <span class="free">x</span> <span class="main">⟹</span> inres <span class="free">m'</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_leof_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> leof_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> RES <span class="free">X</span><span class="main">;</span> RES <span class="free">X</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">c</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_leof_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> leof_trans_nofail<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span><span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span><span class="free">b</span><span class="main">;</span> nofail <span class="free">b</span><span class="main">;</span> <span class="free">b</span><span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span><span class="free">c</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">c</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_leof_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> leof_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">a</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_leof_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> leof_RES_UNIV<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> RES UNIV"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_leof_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> leof_FAIL<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> FAIL"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_leof_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">lemma</span></span> FAIL_leof<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"FAIL <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">m</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_or_fail_def<span class="main">)</span>
      
  <span class="keyword1"><span class="command">lemma</span></span> leof_lift<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">F</span> <span class="main">⟹</span> <span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">F</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_leof_iff pw_le_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> leof_RETURN_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="free">m</span> <span class="main">⟹</span> RETURN <span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_leof_iff<span class="main">)</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> leof_bind_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Φ</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span><span class="main">⤜</span><span class="free">f</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Φ</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_leof_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> RETURN_leof_RES_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"RETURN <span class="free">x</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> RES <span class="free">Y</span> <span class="main">⟷</span> <span class="free">x</span><span class="main">∈</span><span class="free">Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_leof_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> RES_leof_RES_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"RES <span class="free">X</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> RES <span class="free">Y</span> <span class="main">⟷</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_leof_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
   
  <span class="keyword1"><span class="command">lemma</span></span> leof_Let_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Φ</span> <span class="main">⟹</span> Let <span class="free">x</span> <span class="free">f</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Φ</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">lemma</span></span> leof_If_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Φ</span><span class="main">;</span> <span class="main">¬</span><span class="free">c</span> <span class="main">⟹</span> <span class="free">e</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Φ</span><span class="main">⟧</span> <span class="main">⟹</span> If <span class="free">c</span> <span class="free">t</span> <span class="free">e</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Φ</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">lemma</span></span> leof_RES_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">Ψ</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> SPEC <span class="free">Ψ</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Φ</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">X</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> RES <span class="free">X</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">lemma</span></span> leof_True_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_leof_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> sup_leof_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sup <span class="free">a</span> <span class="free">b</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">m</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>nofail <span class="free">a</span> <span class="main">∧</span> nofail <span class="free">b</span> <span class="main">⟶</span> <span class="free">a</span><span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span><span class="free">m</span> <span class="main">∧</span> <span class="free">b</span><span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span><span class="free">m</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_leof_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> sup_leof_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>nofail <span class="free">a</span><span class="main">;</span> nofail <span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span><span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span><span class="free">m</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>nofail <span class="free">a</span><span class="main">;</span> nofail <span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">b</span><span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span><span class="free">m</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sup <span class="free">a</span> <span class="free">b</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_leof_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
      
  <span class="keyword1"><span class="command">lemma</span></span> leof_option_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">v</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">S1</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Φ</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> Some <span class="bound">x</span> <span class="main">⟹</span> <span class="free">f2</span> <span class="bound">x</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Φ</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">v</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free">S1</span> <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> <span class="free">f2</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">lemma</span></span> ASSERT_leof_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">⟹</span> <span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">m'</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="free">Φ</span><span class="main">;</span> <span class="free">m</span><span class="main">}</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">m'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_leof_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> leof_ASSERT_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Φ</span> <span class="main">⟹</span> <span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">m'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> ASSERT <span class="free">Φ</span> <span class="main">⪢</span> <span class="free">m'</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_leof_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> leof_ASSERT_refine_rule<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Φ</span> <span class="main">⟹</span> <span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">⇓</span><span class="free">R</span> <span class="free">m'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>ASSERT <span class="free">Φ</span> <span class="main">⪢</span> <span class="free">m'</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_leof_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> ASSUME_leof_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ASSUME <span class="free">Φ</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Ψ</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">Φ</span> <span class="main">⟶</span> <span class="free">Ψ</span> <span class="main">()</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_leof_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> ASSUME_leof_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">⟹</span> <span class="free">Ψ</span> <span class="main">()</span>"</span></span> 
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ASSUME <span class="free">Φ</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Ψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ASSUME_leof_iff<span class="main">)</span>
      
      
  <span class="keyword1"><span class="command">lemma</span></span> SPEC_rule_conj_leofI1<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Ψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">Ψ</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff pw_leof_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> SPEC_rule_conj_leofI2<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> SPEC <span class="free">Ψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">Ψ</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff pw_leof_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> SPEC_rule_leof_conjI<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Ψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Ψ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_leof_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> leof_use_spec_rule<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Ψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Ψ</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Φ</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_leof_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> use_spec_leof_rule<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Ψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Ψ</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Φ</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_leof_iff pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> leof_strengthen_SPEC<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Φ</span> <span class="main">⟹</span> <span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> inres <span class="free">m</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Φ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_leof_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> build_rel_SPEC_leof<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">I</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Φ</span> <span class="main">(</span><span class="free">α</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>  
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">⇓</span><span class="main">(</span>br <span class="free">α</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>SPEC <span class="free">Φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> build_rel_SPEC_conv<span class="main">)</span>
      
  <span class="keyword1"><span class="command">lemma</span></span> RETURN_as_SPEC_refine_leof<span class="main">[</span><span class="operator">refine2</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>RETURN <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_leof_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> ASSERT_leof_defI<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span> ASSERT <span class="free">Φ</span><span class="main">;</span> <span class="free">m'</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">⟹</span> <span class="free">m'</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">m</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_leof_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> leof_fun_conv_le<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="free">x</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">M</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">if</span> nofail <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">M</span> <span class="free">x</span> <span class="keyword1">else</span> FAIL<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff pw_leof_iff<span class="main">)</span>
    
  <span class="keyword1"><span class="command">lemma</span></span> leof_add_nofailI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> nofail <span class="free">m</span> <span class="main">⟹</span> <span class="free">m</span><span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span><span class="free">m'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span><span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span><span class="free">m'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff pw_leof_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> leof_cons_rule<span class="main">[</span><span class="operator">refine_vcg_cons</span><span class="main">]</span><span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>  
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff pw_leof_iff<span class="main">)</span>
      
      
<span class="keyword1"><span class="command">lemma</span></span> RECT_rule_leof<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span><span class="free">V</span><span class="main">::</span><span class="main">(</span><span class="tfree">'x</span><span class="main">×</span><span class="tfree">'x</span><span class="main">)</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">pre</span> <span class="bound">x'</span><span class="main">;</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">V</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="bound">x'</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">M</span> <span class="bound">x'</span><span class="main">;</span> <span class="free">pre</span> <span class="bound">x</span><span class="main">;</span> 
                        RECT <span class="free">body</span> <span class="main">=</span> <span class="bound">f</span>
    <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">body</span> <span class="bound">f</span> <span class="bound">x</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">M</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RECT <span class="free">body</span> <span class="free">x</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">M</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>trimono <span class="free">body</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RECT_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> leof_fun_conv_le
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> RECT_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pre<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">pre</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> V<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">V</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp_all</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'x</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">pre</span> <span class="bound">x'</span><span class="main">;</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="skolem">xa</span><span class="main">)</span> <span class="main">∈</span> <span class="free">V</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="keyword1">REC<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">body</span> <span class="bound">x'</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">if</span> nofail <span class="main">(</span><span class="keyword1">REC<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">body</span> <span class="bound">x'</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">M</span> <span class="bound">x'</span> <span class="keyword1">else</span> FAIL<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">f</span><span class="main">.</span> <span class="main">⟦</span><span class="main">⋀</span><span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">pre</span> <span class="bound">x'</span><span class="main">;</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">V</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="bound">x'</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">if</span> nofail <span class="main">(</span><span class="bound">f</span> <span class="bound">x'</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">M</span> <span class="bound">x'</span> <span class="keyword1">else</span> FAIL<span class="main">)</span><span class="main">;</span> <span class="free">pre</span> <span class="bound">x</span><span class="main">;</span> <span class="keyword1">REC<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">body</span> <span class="main">=</span> <span class="bound">f</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">body</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">if</span> nofail <span class="main">(</span><span class="free">body</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">M</span> <span class="bound">x</span> <span class="keyword1">else</span> FAIL<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="skolem">xa</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a4<span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="keyword1">REC<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">body</span> <span class="skolem">xa</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a5<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">body</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> f6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="free">pre</span> <span class="bound">x</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">xa</span><span class="main">)</span> <span class="main">∉</span> <span class="free">V</span> <span class="main">∨</span> <span class="main">(</span><span class="keyword1">if</span> nofail <span class="main">(</span><span class="keyword1">REC<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">body</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">then</span> <span class="keyword1">REC<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">body</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="keyword1">REC<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">body</span> <span class="bound">x</span> <span class="main">≤</span> FAIL<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">have</span></span> f7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">f</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">xa</span><span class="main">.</span> <span class="main">(</span><span class="free">pre</span> <span class="bound">xa</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">xa</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">V</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">f</span> <span class="bound">xa</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">if</span> nofail <span class="main">(</span><span class="bound">f</span> <span class="bound">xa</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">M</span> <span class="bound">xa</span> <span class="keyword1">else</span> FAIL<span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span> <span class="free">pre</span> <span class="bound">x</span> <span class="main">∨</span> <span class="keyword1">REC<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">body</span> <span class="main">≠</span> <span class="bound">f</span><span class="main">)</span> <span class="main">∨</span> <span class="free">body</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">if</span> nofail <span class="main">(</span><span class="free">body</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">M</span> <span class="bound">x</span> <span class="keyword1">else</span> FAIL<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xx</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'x</span> <span class="main">⇒</span> <span class="tfree">'a</span> nres<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'x</span> <span class="main">⇒</span> <span class="tfree">'x</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    f8<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x0</span> <span class="bound">x1</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v2</span><span class="main">.</span> <span class="main">(</span><span class="free">pre</span> <span class="bound">v2</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">v2</span><span class="main">,</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">V</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">x0</span> <span class="bound">v2</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">if</span> nofail <span class="main">(</span><span class="bound">x0</span> <span class="bound">v2</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">M</span> <span class="bound">v2</span> <span class="keyword1">else</span> FAIL<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">pre</span> <span class="main">(</span><span class="skolem">xx</span> <span class="bound">x0</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">xx</span> <span class="bound">x0</span> <span class="bound">x1</span><span class="main">,</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">V</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">x0</span> <span class="main">(</span><span class="skolem">xx</span> <span class="bound">x0</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">if</span> nofail <span class="main">(</span><span class="bound">x0</span> <span class="main">(</span><span class="skolem">xx</span> <span class="bound">x0</span> <span class="bound">x1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">M</span> <span class="main">(</span><span class="skolem">xx</span> <span class="bound">x0</span> <span class="bound">x1</span><span class="main">)</span> <span class="keyword1">else</span> FAIL<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>
  <span class="keyword1"><span class="command">have</span></span> f9<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x0</span> <span class="bound">x1</span><span class="main">.</span> <span class="main">(</span><span class="bound">x0</span> <span class="main">(</span><span class="skolem">xx</span> <span class="bound">x0</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">if</span> nofail <span class="main">(</span><span class="bound">x0</span> <span class="main">(</span><span class="skolem">xx</span> <span class="bound">x0</span> <span class="bound">x1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">M</span> <span class="main">(</span><span class="skolem">xx</span> <span class="bound">x0</span> <span class="bound">x1</span><span class="main">)</span> <span class="keyword1">else</span> FAIL<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> nofail <span class="main">(</span><span class="bound">x0</span> <span class="main">(</span><span class="skolem">xx</span> <span class="bound">x0</span> <span class="bound">x1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="bound">x0</span> <span class="main">(</span><span class="skolem">xx</span> <span class="bound">x0</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">≤</span> <span class="free">M</span> <span class="main">(</span><span class="skolem">xx</span> <span class="bound">x0</span> <span class="bound">x1</span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">x0</span> <span class="main">(</span><span class="skolem">xx</span> <span class="bound">x0</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">≤</span> FAIL<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">body</span> <span class="main">(</span><span class="keyword1">REC<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">body</span><span class="main">)</span> <span class="skolem">xa</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a5 a4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> RECT_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">body</span> <span class="main">(</span><span class="keyword1">REC<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">body</span><span class="main">)</span> <span class="skolem">xa</span> <span class="main">≤</span> <span class="free">M</span> <span class="skolem">xa</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f9 f8 f7 f6 a3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="comment1">(* TODO: REC_rule_leof! (However, this may require some fix 
     to the domain theory model of Refine_Monadic!) *)</span>
      
      

<span class="keyword2"><span class="keyword">end</span></span>


</pre>
</div><div id="Refine_Heuristics">
<div class="head">
<h1>Theory Refine_Heuristics</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Data Refinement Heuristics›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Refine_Heuristics
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Refine_Basic.html">Refine_Basic</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This theory contains some heuristics to automatically prove
  data refinement goals that are left over by the refinement condition 
  generator.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The theorem collection <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>refine_hsimp›</span></span></span></span> contains additional simplifier
  rules that are useful to discharge typical data refinement goals.
›</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">refine_heuristics_simps</span> <span class="main">=</span> <span class="entity">Named_Thms</span>
    <span class="main">(</span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> refine_hsimp<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Refinement Framework: "</span> ^
        <span class="inner_quoted">"Data refinement heuristics simp rules"</span> <span class="main">)</span><span class="main">;</span>
›</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">refine_heuristics_simps.setup</span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Type Based Heuristics›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This heuristics instantiates schematic data refinement relations based
  on their type. Both, the left hand side and right hand side type are
  considered.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The heuristics works by proving goals of the form 
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>RELATES ?R›</span></span></span></span>, thereby instantiating <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>?R›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">RELATES</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">RELATES</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> True"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> RELATESI<span class="main">:</span> <span class="quoted"><span class="quoted">"RELATES <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RELATES_def<span class="main">)</span>


<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Refine_dref_type</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">pattern_rules</span> <span class="main">=</span> <span class="entity">Named_Thms</span>
    <span class="main">(</span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> refine_dref_pattern<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Refinement Framework: "</span> ^
        <span class="inner_quoted">"Pattern rules to recognize refinement goal"</span> <span class="main">)</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">RELATES_rules</span> <span class="main">=</span> <span class="entity">Named_Thms</span> <span class="main">(</span> 
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> refine_dref_RELATES<span class="antiquote">}</span></span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Refinement Framework: "</span> ^
        <span class="inner_quoted">"Type based heuristics introduction rules"</span> 
  <span class="main">)</span><span class="main">;</span>


  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tracing</span> <span class="main">=</span> 
    <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> refine_dref_tracing<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span><span class="main">;</span>

  <span class="comment1">(* Check whether term contains schematic variable *)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> 
    <span class="entity">has_schematic</span> <span class="main">(</span>Var <span class="main">_</span><span class="main">)</span> <span class="main">=</span> true <span class="main">|</span>
    <span class="entity">has_schematic</span> <span class="main">(</span>Abs <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">has_schematic</span> <span class="entity">t</span> <span class="main">|</span>
    <span class="entity">has_schematic</span> <span class="main">(</span><span class="entity">t1</span>$<span class="entity">t2</span><span class="main">)</span> <span class="main">=</span> <span class="entity">has_schematic</span> <span class="entity">t1</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">has_schematic</span> <span class="entity">t2</span> <span class="main">|</span>
    <span class="entity">has_schematic</span> <span class="main">_</span> <span class="main">=</span> false<span class="main">;</span>

  <span class="comment1">(* Match proof states where the conclusion of some goal has the specified
     shape *)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">match_goal_shape_tac</span> <span class="main">(</span><span class="entity">shape</span><span class="main">:</span>term<span class="main">-&gt;</span>bool<span class="main">)</span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">:</span><span class="entity">Proof.context</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">thm</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> Thm.nprems_of <span class="entity">thm</span> &gt;= <span class="entity">i</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">HOLogic.dest_Trueprop</span> <span class="main">(</span>Logic.concl_of_goal <span class="main">(</span>Thm.prop_of <span class="entity">thm</span><span class="main">)</span> <span class="entity">i</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">shape</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">then</span></span> all_tac <span class="entity">thm</span> <span class="keyword2"><span class="keyword">else</span></span> no_tac <span class="entity">thm</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">else</span></span>
      no_tac <span class="entity">thm</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">output_failed_msg</span> <span class="entity">ctxt</span> <span class="entity">failed_t</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">failed_t_str</span> <span class="main">=</span> Pretty.string_of 
      <span class="main">(</span>Syntax.pretty_term <span class="main">(</span>Config.put show_types true <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">failed_t</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">msg</span> <span class="main">=</span> <span class="inner_quoted">"Failed to resolve refinement goal \n  "</span> ^ <span class="entity">failed_t_str</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> Config.get <span class="entity">ctxt</span> <span class="entity">tracing</span> <span class="keyword2"><span class="keyword">then</span></span> Output.tracing <span class="entity">msg</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
    
  <span class="comment1">(* Try to apply patternI-rules, ensure that produced first subgoal
     contains a schematic variable, and then solve it using 
     refine_dref_RELATES-rules. *)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">type_tac</span> <span class="entity">ctxt</span> <span class="main">=</span>
    <span class="entity">ALL_GOALS_FWD</span> <span class="main">(</span>TRY o <span class="main">(</span>
      resolve_tac <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">pattern_rules.get</span> <span class="entity">ctxt</span><span class="main">)</span> THEN'
      <span class="entity">match_goal_shape_tac</span> <span class="entity">has_schematic</span> <span class="entity">ctxt</span> THEN'
      <span class="main">(</span>SOLVED' <span class="main">(</span>REPEAT_ALL_NEW <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">RELATES_rules.get</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        ORELSE' <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span> 
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">failed_t</span> <span class="main">=</span> 
            <span class="entity">HOLogic.dest_Trueprop</span> <span class="main">(</span>Logic.concl_of_goal <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> <span class="entity">i</span><span class="main">)</span><span class="main">;</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">output_failed_msg</span> <span class="entity">ctxt</span> <span class="entity">failed_t</span><span class="main">;</span>
          <span class="keyword2"><span class="keyword">in</span></span> no_tac <span class="entity">st</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
      <span class="main">)</span>
    <span class="main">)</span><span class="main">)</span><span class="main">;</span>


<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
›</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">Refine_dref_type.RELATES_rules.setup</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">Refine_dref_type.pattern_rules.setup</span>›</span>

<span class="keyword1"><span class="command">method_setup</span></span> refine_dref_type <span class="main">=</span> 
  <span class="quoted">‹Scan.lift <span class="main">(</span>Args.mode <span class="inner_quoted">"trace"</span> -- Args.mode <span class="inner_quoted">"nopost"</span><span class="main">)</span> 
  &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">tracing</span><span class="main">,</span><span class="entity">nopost</span><span class="main">)</span> <span class="main">=&gt;</span> 
    <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">tracing</span> <span class="keyword2"><span class="keyword">then</span></span> Config.put <span class="entity">Refine_dref_type.tracing</span> true <span class="entity">ctxt</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">ctxt</span><span class="main">;</span> 
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">SIMPLE_METHOD</span> <span class="main">(</span>CHANGED <span class="main">(</span>
        <span class="entity">Refine_dref_type.type_tac</span> <span class="entity">ctxt</span> 
        THEN <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">nopost</span> <span class="keyword2"><span class="keyword">then</span></span> all_tac <span class="keyword2"><span class="keyword">else</span></span> ALLGOALS <span class="main">(</span>TRY o <span class="entity">Refine.post_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">)</span>
›</span> 
  <span class="quoted">"Use type-based heuristics to instantiate data refinement relations"</span>

<span class="comment1">(*method_setup refine_dref_type_only = 
  {* Scan.succeed (fn ctxt =&gt; SIMPLE_METHOD (CHANGED (
    Refine_dref_type.type_tac ctxt))) *} 
  "Use type-based heuristics to instantiate data refinement relations. 
    No postprocessing."*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Patterns›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This section defines the patterns that are recognized as data refinement 
  goals.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> RELATESI_memb<span class="main">[</span><span class="operator">refine_dref_pattern</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"RELATES <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lemma</span></span> RELATESI_refspec<span class="main">[</span><span class="operator">refine_dref_pattern</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"RELATES <span class="free">R</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="free">S'</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="free">S'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Allows refine-rules to add <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>RELATES›</span></span></span></span> goals if they introduce hidden relations›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> RELATES_pattern<span class="main">[</span><span class="operator">refine_dref_pattern</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"RELATES <span class="free">R</span> <span class="main">⟹</span> RELATES <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_hsimp</span><span class="main">]</span> <span class="main">=</span> RELATES_def 
    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement Relations›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section, we define some general purpose refinement relations, e.g.,
  for product types and sets.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Id_RELATES <span class="main">[</span><span class="operator">refine_dref_RELATES</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"RELATES Id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RELATES_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prod_rel_RELATES<span class="main">[</span><span class="operator">refine_dref_RELATES</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"RELATES <span class="free">Ra</span> <span class="main">⟹</span> RELATES <span class="free">Rb</span> <span class="main">⟹</span> RELATES <span class="main">(</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>prod_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RELATES_def prod_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> prod_rel_sv<span class="main">[</span><span class="operator">refine_hsimp</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemma</span></span> prod_rel_iff<span class="main">[</span><span class="operator">refine_hsimp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">a'</span><span class="main">,</span><span class="free">b'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">⟩</span>prod_rel <span class="main">⟷</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">a'</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span> <span class="main">∧</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">b'</span><span class="main">)</span><span class="main">∈</span><span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_hsimp</span><span class="main">]</span> <span class="main">=</span> prod_rel_id_simp 

<span class="keyword1"><span class="command">lemma</span></span> option_rel_RELATES<span class="main">[</span><span class="operator">refine_dref_RELATES</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"RELATES <span class="free">Ra</span> <span class="main">⟹</span> RELATES <span class="main">(</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span>option_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RELATES_def option_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> option_rel_sv<span class="main">[</span><span class="operator">refine_hsimp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_hsimp</span><span class="main">]</span> <span class="main">=</span> option_rel_id_simp

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_hsimp</span><span class="main">]</span> <span class="main">=</span> set_rel_sv set_rel_csv

<span class="keyword1"><span class="command">lemma</span></span> set_rel_RELATES<span class="main">[</span><span class="operator">refine_dref_RELATES</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"RELATES <span class="free">R</span> <span class="main">⟹</span> RELATES <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RELATES_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_rel_empty_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S</span><span class="main">,</span><span class="free">S'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">X</span><span class="main">⟩</span>set_rel <span class="main">⟹</span> <span class="free">S</span><span class="main">=</span><span class="main">{}</span> <span class="main">⟷</span> <span class="free">S'</span><span class="main">=</span><span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_rel_sngD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="free">b</span><span class="main">}</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_rel_def<span class="main">)</span>

<span class="comment1">(*lemmas [refine_hsimp] = set_rel_empty set_rel_union set_rel_insert
  set_rel_diff*)</span>

<span class="comment1">(*lemmas [refine_hsimp] = prod_set_eq_is_Id*)</span>

<span class="keyword1"><span class="command">lemma</span></span> Image_insert<span class="main">[</span><span class="operator">refine_hsimp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟹</span> single_valued <span class="free">R</span> <span class="main">⟹</span> <span class="free">R</span><span class="main">``</span>insert <span class="free">a</span> <span class="free">A</span> <span class="main">=</span> insert <span class="free">b</span> <span class="main">(</span><span class="free">R</span><span class="main">``</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_hsimp</span><span class="main">]</span> <span class="main">=</span> Image_Un

<span class="keyword1"><span class="command">lemma</span></span> Image_Diff<span class="main">[</span><span class="operator">refine_hsimp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span>converse <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">R</span><span class="main">``</span><span class="main">(</span><span class="free">A</span><span class="main">-</span><span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">R</span><span class="main">``</span><span class="free">A</span> <span class="main">-</span> <span class="free">R</span><span class="main">``</span><span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Image_Inter<span class="main">[</span><span class="operator">refine_hsimp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span>converse <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">R</span><span class="main">``</span><span class="main">(</span><span class="free">A</span><span class="main">∩</span><span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">R</span><span class="main">``</span><span class="free">A</span> <span class="main">∩</span> <span class="free">R</span><span class="main">``</span><span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_rel_RELATES<span class="main">[</span><span class="operator">refine_dref_RELATES</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"RELATES <span class="free">R</span> <span class="main">⟹</span> RELATES <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RELATES_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_hsimp</span><span class="main">]</span> <span class="main">=</span> list_rel_sv_iff list_rel_simp

<span class="keyword1"><span class="command">lemma</span></span> RELATES_nres_rel<span class="main">[</span><span class="operator">refine_dref_RELATES</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"RELATES <span class="free">R</span> <span class="main">⟹</span> RELATES <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RELATES_def<span class="main">)</span>
  
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Refine_More_Comb">
<div class="head">
<h1>Theory Refine_More_Comb</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹More Combinators›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Refine_More_Comb
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Refine_Basic.html">Refine_Basic</a> <a href="Refine_Heuristics.html">Refine_Heuristics</a> <a href="Refine_Leof.html">Refine_Leof</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹OBTAIN Combinator›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Obtain value with given property, asserting that there exists one.›</span></span>  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">OBTAIN</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> nres"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">OBTAIN</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> ASSERT <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">⪢</span> SPEC <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> OBTAIN_nofail<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>OBTAIN <span class="free">P</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> OBTAIN_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> OBTAIN_inres<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inres <span class="main">(</span>OBTAIN <span class="free">P</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span><span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∨</span> <span class="free">P</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> OBTAIN_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> OBTAIN_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span>  <span class="main">⟧</span> <span class="main">⟹</span> OBTAIN <span class="free">P</span> <span class="main">≤</span> SPEC <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> OBTAIN_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> OBTAIN_refine_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"OBTAIN <span class="free">P</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>OBTAIN <span class="free">Q</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>Ex <span class="free">Q</span> <span class="main">⟶</span> Ex <span class="free">P</span> <span class="main">∧</span> Collect <span class="free">P</span> <span class="main">⊆</span> <span class="free">R</span><span class="main">¯</span><span class="main">``</span>Collect <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> OBTAIN_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> OBTAIN_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RELATES <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟹</span> Ex <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span><span class="free">Q</span> <span class="bound">x</span><span class="main">;</span> <span class="free">P</span> <span class="bound">y</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"OBTAIN <span class="free">P</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>OBTAIN <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> OBTAIN_refine_iff 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹SELECT Combinator›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Select some value with given property, or <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>None›</span></span></span></span> if there is none.›</span></span>  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SELECT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> option nres"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SELECT</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="keyword1">then</span> RES <span class="main">{</span>Some <span class="bound">x</span><span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span><span class="main">}</span> <span class="keyword1">else</span> RETURN None"</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> SELECT_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span>Some <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span><span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SELECT <span class="free">P</span> <span class="main">≤</span> SPEC <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SELECT_def
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> SELECT_refine_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>SELECT <span class="free">P</span> <span class="main">≤</span><span class="main">⇓</span><span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel<span class="main">)</span> <span class="main">(</span>SELECT <span class="free">P'</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">⟷</span> <span class="main">(</span>  
    <span class="main">(</span>Ex <span class="free">P'</span> <span class="main">⟶</span> Ex <span class="free">P</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">∧</span> <span class="free">P'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SELECT_def pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> SELECT_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RELATES <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x'</span><span class="main">.</span> <span class="free">P'</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">∧</span> <span class="free">P'</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SELECT <span class="free">P</span> <span class="main">≤</span><span class="main">⇓</span><span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel<span class="main">)</span> <span class="main">(</span>SELECT <span class="free">P'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SELECT_refine_iff <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> SELECT_as_SPEC<span class="main">:</span> <span class="quoted"><span class="quoted">"SELECT <span class="free">P</span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">λ</span>None <span class="main">⇒</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span><span class="free">P</span> <span class="bound">x</span> <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SELECT_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SELECT_pw<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>SELECT <span class="free">P</span><span class="main">)</span>"</span></span>  
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>SELECT <span class="free">P</span><span class="main">)</span> <span class="free">r</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">r</span><span class="main">=</span>None <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span><span class="free">P</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">r</span><span class="main">=</span>Some <span class="bound">x</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SELECT_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> SELECT_pw_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>SELECT <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>SELECT <span class="free">P</span><span class="main">)</span> None <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span><span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>SELECT <span class="free">P</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">P</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="RefineG_While">
<div class="head">
<h1>Theory RefineG_While</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Generic While-Combinator›</span></span>
<span class="keyword1"><span class="command">theory</span></span> RefineG_While
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="RefineG_Recursion.html">RefineG_Recursion</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/While_Combinator.html">HOL-Library.While_Combinator</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">WHILEI_body</span> <span class="free"><span class="bound"><span class="entity">bind</span></span></span> <span class="free"><span class="bound"><span class="entity">return</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> 
  <span class="main">(</span><span class="main">λ</span><span class="bound">W</span> <span class="bound">s</span><span class="main">.</span> 
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">s</span> <span class="keyword1">then</span> 
      <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">bind</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="bound">W</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">return</span></span></span> <span class="bound">s</span>
    <span class="keyword1">else</span> top<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">iWHILEI</span> <span class="free"><span class="bound"><span class="entity">bind</span></span></span> <span class="free"><span class="bound"><span class="entity">return</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s0</span></span></span> <span class="main">≡</span> REC <span class="main">(</span>WHILEI_body <span class="free"><span class="bound"><span class="entity">bind</span></span></span> <span class="free"><span class="bound"><span class="entity">return</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s0</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">iWHILEIT</span> <span class="free"><span class="bound"><span class="entity">bind</span></span></span> <span class="free"><span class="bound"><span class="entity">return</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s0</span></span></span> <span class="main">≡</span> RECT <span class="main">(</span>WHILEI_body <span class="free"><span class="bound"><span class="entity">bind</span></span></span> <span class="free"><span class="bound"><span class="entity">return</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s0</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">iWHILE</span> <span class="free"><span class="bound"><span class="entity">bind</span></span></span> <span class="free"><span class="bound"><span class="entity">return</span></span></span> <span class="main">≡</span> iWHILEI <span class="free"><span class="bound"><span class="entity">bind</span></span></span> <span class="free"><span class="bound"><span class="entity">return</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">iWHILET</span> <span class="free"><span class="bound"><span class="entity">bind</span></span></span> <span class="free"><span class="bound"><span class="entity">return</span></span></span> <span class="main">≡</span> iWHILEIT <span class="free"><span class="bound"><span class="entity">bind</span></span></span> <span class="free"><span class="bound"><span class="entity">return</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span>

<span class="comment1">(* TODO: Move to refine_mono_prover*)</span>
<span class="keyword1"><span class="command">lemma</span></span> mono_prover_monoI<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"monotone <span class="main">(</span>fun_ord <span class="main">(≤)</span><span class="main">)</span> <span class="main">(</span>fun_ord <span class="main">(≤)</span><span class="main">)</span> <span class="free">B</span> <span class="main">⟹</span> mono <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccpo_monoD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_fun_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> fun_ord_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">locale</span></span> generic_WHILE <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">bind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'m</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'m</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'m</span><span class="main">::</span>complete_lattice<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">return</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'m</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">WHILEIT</span> <span class="free">WHILEI</span> <span class="free">WHILET</span> <span class="free">WHILE</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> imonad1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bind</span> <span class="main">(</span><span class="free">return</span> <span class="free">x</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> imonad2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bind</span> <span class="free">M</span> <span class="free">return</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> imonad3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bind</span> <span class="main">(</span><span class="free">bind</span> <span class="free">M</span> <span class="free">f</span><span class="main">)</span> <span class="free">g</span> <span class="main">=</span> <span class="free">bind</span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">bind</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ibind_mono_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>flat_ge <span class="free">m</span> <span class="free">m'</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> flat_ge <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x</span><span class="main">)</span><span class="main">⟧</span> 
    <span class="main">⟹</span> flat_ge <span class="main">(</span><span class="free">bind</span> <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">bind</span> <span class="free">m'</span> <span class="free">f'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ibind_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(≤)</span> <span class="free">m</span> <span class="free">m'</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(≤)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x</span><span class="main">)</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(≤)</span> <span class="main">(</span><span class="free">bind</span> <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">bind</span> <span class="free">m'</span> <span class="free">f'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WHILEIT_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">WHILEIT</span> <span class="main">≡</span> iWHILEIT <span class="free">bind</span> <span class="free">return</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WHILEI_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">WHILEI</span> <span class="main">≡</span> iWHILEI <span class="free">bind</span> <span class="free">return</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WHILET_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">WHILET</span> <span class="main">≡</span> iWHILET <span class="free">bind</span> <span class="free">return</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WHILE_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">WHILE</span> <span class="main">≡</span> iWHILE <span class="free">bind</span> <span class="free">return</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> WHILEIT_def <span class="main">=</span> WHILEIT_eq<span class="main">[</span><span class="operator">unfolded</span> iWHILEIT_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> WHILEI_def <span class="main">=</span> WHILEI_eq<span class="main">[</span><span class="operator">unfolded</span> iWHILEI_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> WHILET_def <span class="main">=</span> WHILET_eq<span class="main">[</span><span class="operator">unfolded</span> iWHILET_def<span class="main">,</span> <span class="operator">folded</span> WHILEIT_eq<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> WHILE_def <span class="main">=</span> WHILE_eq<span class="main">[</span><span class="operator">unfolded</span> iWHILE_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">folded</span> WHILEI_eq<span class="main">]</span>

  <span class="keyword1"><span class="command">lemmas</span></span> imonad_laws <span class="main">=</span> imonad1 imonad2 imonad3
  
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span> <span class="main">=</span> ibind_mono_ge ibind_mono

<span class="comment1">(*  lemma ibind_mono: "m ≤ m' ⟹ f ≤ f' ⟹ bind m f ≤ bind m' f'"
    by (metis (no_types) ibind_mono1 ibind_mono2 le_funD monoD order_trans)
*)</span>

<span class="keyword1"><span class="command">lemma</span></span> WHILEI_body_trimono<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="main">(</span>WHILEI_body <span class="free">bind</span> <span class="free">return</span> <span class="free">I</span> <span class="free">b</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILEI_body_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">refine_mono</span>

<span class="keyword1"><span class="command">lemmas</span></span> WHILEI_mono <span class="main">=</span> trimonoD_mono<span class="main">[</span><span class="operator">OF</span> WHILEI_body_trimono<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> WHILEI_mono_ge <span class="main">=</span> trimonoD_flatf_ge<span class="main">[</span><span class="operator">OF</span> WHILEI_body_trimono<span class="main">]</span>


<span class="keyword1"><span class="command">lemma</span></span> WHILEI_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">WHILEI</span> <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="main">(</span><span class="free">I</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="free">bind</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">WHILEI</span> <span class="free">I</span> <span class="free">b</span> <span class="free">f</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">return</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">else</span> top<span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILEI_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> REC_unfold<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WHILEI_body_trimono<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILEI_body_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> REC_mono_ref<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>trimono <span class="free">B</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">D</span> <span class="bound">x</span><span class="main">.</span> <span class="free">B</span> <span class="bound">D</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">B'</span> <span class="bound">D</span> <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> REC <span class="free">B</span> <span class="free">x</span> <span class="main">≤</span> REC <span class="free">B'</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> REC_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lfp_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> le_funD<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> RECT_mono_ref<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>trimono <span class="free">B</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">D</span> <span class="bound">x</span><span class="main">.</span> <span class="free">B</span> <span class="bound">D</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">B'</span> <span class="bound">D</span> <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> RECT <span class="free">B</span> <span class="free">x</span> <span class="main">≤</span> RECT <span class="free">B'</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RECT_gfp_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> gfp_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> le_funD<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> WHILEI_weaken<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IW<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">I</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">I'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">WHILEI</span> <span class="free">I'</span> <span class="free">b</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">WHILEI</span> <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILEI_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> REC_mono_ref<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WHILEI_body_trimono<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> WHILEI_body_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> IW<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> WHILEIT_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">WHILEIT</span> <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="main">(</span><span class="free">I</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">then</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="free">bind</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">WHILEIT</span> <span class="free">I</span> <span class="free">b</span> <span class="free">f</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">return</span> <span class="free">x</span><span class="main">)</span> 
  <span class="keyword1">else</span> top<span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILEIT_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> RECT_unfold<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WHILEI_body_trimono<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILEI_body_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> WHILEIT_weaken<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IW<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">I</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">I'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">WHILEIT</span> <span class="free">I'</span> <span class="free">b</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">WHILEIT</span> <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILEIT_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> RECT_mono_ref<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WHILEI_body_trimono<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> WHILEI_body_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> IW<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> WHILEI_le_WHILEIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">WHILEI</span> <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s</span> <span class="main">≤</span> <span class="free">WHILEIT</span> <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILEI_def WHILEIT_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> REC_le_RECT<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹While without Annotated Invariant›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> WHILE_unfold<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">WHILE</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="free">s</span> <span class="keyword1">then</span> <span class="free">bind</span> <span class="main">(</span><span class="free">f</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">WHILE</span> <span class="free">b</span> <span class="free">f</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">return</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILE_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> WHILEI_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> WHILET_unfold<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">WHILET</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="free">s</span> <span class="keyword1">then</span> <span class="free">bind</span> <span class="main">(</span><span class="free">f</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">WHILET</span> <span class="free">b</span> <span class="free">f</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">return</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILET_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> WHILEIT_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> transfer_WHILEIT_esc<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">return</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">F</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">return</span> <span class="main">(</span>while <span class="free">b</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">WHILEIT</span> <span class="free">I</span> <span class="free">b</span> <span class="free">F</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> transfer <span class="quoted"><span class="free">return</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> WHILEIT_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> transfer_RECT'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> fr<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"while <span class="free">b</span> <span class="free">f</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> while_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> WHILEI_body_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">split</span> if_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ ibind_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> REF order_refl<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> imonad_laws<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> transfer_WHILET_esc<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">return</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">F</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">return</span> <span class="main">(</span>while <span class="free">b</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">WHILET</span> <span class="free">b</span> <span class="free">F</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILET_def
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> transfer_WHILEIT_esc<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> WHILE_mono_prover_rule<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">f'</span> <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">WHILE</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s0</span> <span class="main">≤</span> <span class="free">WHILE</span> <span class="free">b</span> <span class="free">f'</span> <span class="free">s0</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">f'</span> <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">WHILEI</span> <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s0</span> <span class="main">≤</span> <span class="free">WHILEI</span> <span class="free">I</span> <span class="free">b</span> <span class="free">f'</span> <span class="free">s0</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">f'</span> <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">WHILET</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s0</span> <span class="main">≤</span> <span class="free">WHILET</span> <span class="free">b</span> <span class="free">f'</span> <span class="free">s0</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">f'</span> <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">WHILEIT</span> <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s0</span> <span class="main">≤</span> <span class="free">WHILEIT</span> <span class="free">I</span> <span class="free">b</span> <span class="free">f'</span> <span class="free">s0</span>"</span></span>

  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> flat_ge <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> flat_ge <span class="main">(</span><span class="free">WHILET</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s0</span><span class="main">)</span> <span class="main">(</span><span class="free">WHILET</span> <span class="free">b</span> <span class="free">f'</span> <span class="free">s0</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> flat_ge <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> flat_ge <span class="main">(</span><span class="free">WHILEIT</span> <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s0</span><span class="main">)</span> <span class="main">(</span><span class="free">WHILEIT</span> <span class="free">I</span> <span class="free">b</span> <span class="free">f'</span> <span class="free">s0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILE_def WHILEI_def WHILEI_body_def
    WHILET_def WHILEIT_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">refine_mono</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> transfer_WHILE <span class="main">=</span> 
  c<span class="main">:</span> generic_WHILE <span class="quoted"><span class="free">cbind</span></span> <span class="quoted"><span class="free">creturn</span></span> <span class="quoted"><span class="free">cWHILEIT</span></span> <span class="quoted"><span class="free">cWHILEI</span></span> <span class="quoted"><span class="free">cWHILET</span></span> <span class="quoted"><span class="free">cWHILE</span></span> <span class="main">+</span> 
  a<span class="main">:</span> generic_WHILE <span class="quoted"><span class="free">abind</span></span> <span class="quoted"><span class="free">areturn</span></span> <span class="quoted"><span class="free">aWHILEIT</span></span> <span class="quoted"><span class="free">aWHILEI</span></span> <span class="quoted"><span class="free">aWHILET</span></span> <span class="quoted"><span class="free">aWHILE</span></span> <span class="main">+</span>
  dist_transfer <span class="quoted"><span class="free">α</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">cbind</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">creturn</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'mc</span><span class="main">::</span>complete_lattice"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">cWHILEIT</span> <span class="free">cWHILEI</span> <span class="free">cWHILET</span> <span class="free">cWHILE</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">abind</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">areturn</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'ma</span><span class="main">::</span>complete_lattice"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">aWHILEIT</span> <span class="free">aWHILEI</span> <span class="free">aWHILET</span> <span class="free">aWHILE</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'mc</span> <span class="main">⇒</span> <span class="tfree">'ma</span>"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> transfer_bind<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">α</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">M</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">α</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">F</span> <span class="bound">x</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">α</span> <span class="main">(</span><span class="free">cbind</span> <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="main">≤</span> <span class="free">abind</span> <span class="free">M</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> transfer_return<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">(</span><span class="free">creturn</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">areturn</span> <span class="free">x</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> transfer_WHILEIT<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">α</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">F</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">(</span><span class="free">cWHILEIT</span> <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">aWHILEIT</span> <span class="free">I</span> <span class="free">b</span> <span class="free">F</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> c.WHILEIT_def a.WHILEIT_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> transfer_RECT<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ c.WHILEI_body_trimono<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILEI_body_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> transfer_bind<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> REF<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> transfer_return<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> transfer_WHILEI<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">α</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">F</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">(</span><span class="free">cWHILEI</span> <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">aWHILEI</span> <span class="free">I</span> <span class="free">b</span> <span class="free">F</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> c.WHILEI_def a.WHILEI_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> transfer_REC<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ c.WHILEI_body_trimono<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILEI_body_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> transfer_bind<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> REF<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> transfer_return<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> transfer_WHILE<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">α</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">F</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">(</span><span class="free">cWHILE</span> <span class="free">b</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">aWHILE</span> <span class="free">b</span> <span class="free">F</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> c.WHILE_def a.WHILE_def
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> transfer_WHILEI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> transfer_WHILET<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">α</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">F</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">(</span><span class="free">cWHILET</span> <span class="free">b</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">aWHILET</span> <span class="free">b</span> <span class="free">F</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> c.WHILET_def a.WHILET_def
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> transfer_WHILEIT<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> generic_WHILE_rules <span class="main">=</span> 
  generic_WHILE <span class="quoted"><span class="free">bind</span></span> <span class="quoted"><span class="free">return</span></span> <span class="quoted"><span class="free">WHILEIT</span></span> <span class="quoted"><span class="free">WHILEI</span></span> <span class="quoted"><span class="free">WHILET</span></span> <span class="quoted"><span class="free">WHILE</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">bind</span> <span class="free">return</span> <span class="free">SPEC</span> <span class="free">WHILEIT</span> <span class="free">WHILEI</span> <span class="free">WHILET</span> <span class="free">WHILE</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> iSPEC_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">SPEC</span> <span class="free">Φ</span> <span class="main">=</span> Sup <span class="main">{</span><span class="free">return</span> <span class="bound">x</span>  <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ibind_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">M</span> <span class="main">≤</span> <span class="free">SPEC</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">SPEC</span> <span class="free">Φ</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">bind</span> <span class="free">M</span> <span class="free">f</span> <span class="main">≤</span> <span class="free">SPEC</span> <span class="free">Φ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> ireturn_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">return</span> <span class="free">x</span> <span class="main">=</span> <span class="free">SPEC</span> <span class="main">(</span><span class="main">(=)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> iSPEC_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">lemma</span></span> iSPEC_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Ψ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">SPEC</span> <span class="free">Φ</span> <span class="main">≤</span> <span class="free">SPEC</span> <span class="free">Ψ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> iSPEC_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sup_mono<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> ireturn_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">return</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">SPEC</span> <span class="free">Φ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ireturn_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> iSPEC_rule<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> WHILEI_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ISTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="free">b</span> <span class="bound">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">SPEC</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> CONS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="main">¬</span> <span class="free">b</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">WHILEI</span> <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s</span> <span class="main">≤</span> <span class="free">SPEC</span> <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">SPEC</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">b</span> <span class="bound">s</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> WHILEI_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> REC_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WHILEI_body_trimono<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> I0<span class="main">)</span>
    
      <span class="keyword1"><span class="command">unfolding</span></span> WHILEI_body_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">split</span> if_split<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> impI conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ibind_rule<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ISTEP<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iSPEC_rule<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
      
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ireturn_rule<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iSPEC_rule<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CONS<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> WHILEIT_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="free">b</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">SPEC</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> PHI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="main">¬</span> <span class="free">b</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">WHILEIT</span> <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s</span> <span class="main">≤</span> <span class="free">SPEC</span> <span class="free">Φ</span>"</span></span>

  <span class="keyword1"><span class="command">unfolding</span></span> WHILEIT_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> RECT_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WHILEI_body_trimono WF<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pre<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">I</span></span><span class="main"><span class="main">,</span></span><span class="operator">OF</span> I0<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILEI_body_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">split</span> if_split<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> impI conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ibind_rule<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IS<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iSPEC_rule<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ireturn_rule<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PHI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> WHILE_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ISTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="free">b</span> <span class="bound">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">SPEC</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> CONS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="main">¬</span> <span class="free">b</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">WHILE</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s</span> <span class="main">≤</span> <span class="free">SPEC</span> <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILE_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WHILEI_weaken WHILEI_rule<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> TrueI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> I0<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> WHILET_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="free">b</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">SPEC</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> PHI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="main">¬</span> <span class="free">b</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">WHILET</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s</span> <span class="main">≤</span> <span class="free">SPEC</span> <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILET_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WHILEIT_weaken WHILEIT_rule<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> TrueI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WF<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> I0<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Refine_While">
<div class="head">
<h1>Theory Refine_While</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹While-Loops›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Refine_While
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="Refine_Basic.html">Refine_Basic</a> <a href="Refine_Leof.html">Refine_Leof</a> <span class="quoted">"<a href="RefineG_While.html">Generic/RefineG_While</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">WHILEIT</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">WHILE<span class="hidden">⇩</span><sub>T</sub>⇗</span>_<span class="keyword1">⇖</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">WHILEIT</span> <span class="main">≡</span> iWHILEIT bind RETURN"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">WHILEI</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">WHILE⇗</span>_<span class="keyword1">⇖</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">WHILEI</span> <span class="main">≡</span> iWHILEI bind RETURN"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">WHILET</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">WHILE<span class="hidden">⇩</span><sub>T</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">WHILET</span> <span class="main">≡</span> iWHILET bind RETURN"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">WHILE</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">WHILE</span> <span class="main">≡</span> iWHILE bind RETURN"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> while<span class="main">?</span><span class="main">:</span> generic_WHILE_rules <span class="quoted">bind</span> <span class="quoted">RETURN</span> <span class="quoted">SPEC</span>
  <span class="quoted">WHILEIT</span> <span class="quoted">WHILEI</span> <span class="quoted">WHILET</span> <span class="quoted">WHILE</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> WHILEIT_def WHILEI_def WHILET_def WHILE_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_mono</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_mono</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> RES_Sup_RETURN<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> f<span class="main"><span class="main">=</span></span><span class="quoted">Sup</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> arg_cong<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> bind_rule<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span> <span class="main">=</span> WHILEI_rule
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span> <span class="main">=</span> WHILEIT_rule

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Data Refinement Rules›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ref_WHILEI_invarI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>WHILEI <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>WHILEI <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> WHILEI_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> WHILEI_unfold<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> ref_WHILEIT_invarI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>WHILEIT <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>WHILEIT <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> WHILEIT_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> WHILEIT_unfold<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> WHILEI_le_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">W</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span><span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟹</span> <span class="bound">W</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">s'</span><span class="main">;</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> 
    <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="main">(</span><span class="free">I</span> <span class="bound">s</span><span class="main">)</span><span class="main">;</span> <span class="keyword1">if</span> <span class="free">b</span> <span class="bound">s</span> <span class="keyword1">then</span> bind <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">W</span> <span class="keyword1">else</span> RETURN <span class="bound">s</span><span class="main">}</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WHILEI <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s</span> <span class="main">≤</span> <span class="free">M</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILEI_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> REC_le_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">M</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> WHILEI_body_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> R0<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span><span class="operator">OF</span> RS<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILEI_body_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹WHILE-refinement rule with invisible concrete steps.
  Intuitively, a concrete step may either refine an abstract step, or
  must not change the corresponding abstract state.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> WHILEI_invisible_refine_genR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I'</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">s'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">s'</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="free">b'</span> <span class="bound">s'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">b</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">s'</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="free">b</span> <span class="bound">s</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">≤</span> sup <span class="main">(</span><span class="main">⇓</span><span class="free">R'</span> <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>ASSUME <span class="main">(</span><span class="free">b'</span> <span class="bound">s'</span><span class="main">)</span><span class="main">;</span> <span class="free">f'</span> <span class="bound">s'</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">⇓</span><span class="free">R'</span> <span class="main">(</span>RETURN <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="main">¬</span><span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="main">¬</span><span class="free">b'</span> <span class="bound">x'</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WHILEI <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>WHILEI <span class="free">I'</span> <span class="free">b'</span> <span class="free">f'</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ref_WHILEI_invarI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEI_le_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">R'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> R0<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ref_WHILEI_invarI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> RI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="improper">s</span><span class="main">=</span>False"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> WHILEI_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> RB <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> RETURN_refine R_REF<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> monoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bind_mono1 RS<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> bind_distrib_sup1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sup_least<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> WHILEI_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RB<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> impI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bind_refine<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_refl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> WHILEI_refine_genR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I'</span> <span class="free">x'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IREF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> COND_REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b'</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STEP_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="free">b'</span> <span class="bound">x'</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R'</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="main">¬</span><span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="main">¬</span><span class="free">b'</span> <span class="bound">x'</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WHILEI <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>WHILEI <span class="free">I'</span> <span class="free">b'</span> <span class="free">f'</span> <span class="free">x'</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEI_invisible_refine_genR<span class="main"><span class="main">[</span></span><span class="operator">OF</span> R0<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> IREF<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> COND_REF<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_supI1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> COND_REF STEP_REF<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> R_REF<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> WHILE_invisible_refine_genR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="free">b'</span> <span class="bound">s'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">b</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="free">b</span> <span class="bound">s</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">≤</span> sup <span class="main">(</span><span class="main">⇓</span><span class="free">R'</span> <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>ASSUME <span class="main">(</span><span class="free">b'</span> <span class="bound">s'</span><span class="main">)</span><span class="main">;</span> <span class="free">f'</span> <span class="bound">s'</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">⇓</span><span class="free">R'</span> <span class="main">(</span>RETURN <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="main">¬</span><span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="main">¬</span><span class="free">b'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WHILE <span class="free">b</span> <span class="free">f</span> <span class="free">s</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>WHILE <span class="free">b'</span> <span class="free">f'</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILE_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEI_invisible_refine_genR<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> WHILE_refine_genR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> COND_REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b'</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STEP_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="free">b'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R'</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="main">¬</span><span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="main">¬</span><span class="free">b'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WHILE <span class="free">b</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>WHILE <span class="free">b'</span> <span class="free">f'</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILE_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEI_refine_genR<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> WHILE_refine_genR'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> COND_REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b'</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STEP_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="free">b'</span> <span class="bound">x'</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R'</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="main">¬</span><span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="main">¬</span><span class="free">b'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WHILE <span class="free">b</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>WHILEI <span class="free">I'</span> <span class="free">b'</span> <span class="free">f'</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILE_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEI_refine_genR<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms TrueI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹WHILE-refinement rule with invisible concrete steps.
  Intuitively, a concrete step may either refine an abstract step, or
  must not change the corresponding abstract state.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> WHILEI_invisible_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I'</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">s'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">s'</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="free">b'</span> <span class="bound">s'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">b</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">s'</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="free">b</span> <span class="bound">s</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">≤</span> sup <span class="main">(</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>ASSUME <span class="main">(</span><span class="free">b'</span> <span class="bound">s'</span><span class="main">)</span><span class="main">;</span> <span class="free">f'</span> <span class="bound">s'</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>RETURN <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WHILEI <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>WHILEI <span class="free">I'</span> <span class="free">b'</span> <span class="free">f'</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEI_invisible_refine_genR<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">R</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> WHILEI_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I'</span> <span class="free">x'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IREF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> COND_REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b'</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STEP_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="free">b'</span> <span class="bound">x'</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WHILEI <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>WHILEI <span class="free">I'</span> <span class="free">b'</span> <span class="free">f'</span> <span class="free">x'</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEI_invisible_refine<span class="main"><span class="main">[</span></span><span class="operator">OF</span> R0<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> IREF<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> COND_REF<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_supI1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> COND_REF STEP_REF<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> WHILE_invisible_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">b'</span> <span class="bound">s'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">b</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">b</span> <span class="bound">s</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">≤</span> sup <span class="main">(</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>ASSUME <span class="main">(</span><span class="free">b'</span> <span class="bound">s'</span><span class="main">)</span><span class="main">;</span> <span class="free">f'</span> <span class="bound">s'</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>RETURN <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WHILE <span class="free">b</span> <span class="free">f</span> <span class="free">s</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>WHILE <span class="free">b'</span> <span class="free">f'</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILE_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEI_invisible_refine<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> WHILE_le_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">W</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span><span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟹</span> <span class="bound">W</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">s'</span><span class="main">;</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> 
    <span class="keyword1">do</span> <span class="main">{</span><span class="keyword1">if</span> <span class="free">b</span> <span class="bound">s</span> <span class="keyword1">then</span> bind <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">W</span> <span class="keyword1">else</span> RETURN <span class="bound">s</span><span class="main">}</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WHILE <span class="free">b</span> <span class="free">f</span> <span class="free">s</span> <span class="main">≤</span> <span class="free">M</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILE_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEI_le_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> R0<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RS<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> WHILE_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> COND_REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b'</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STEP_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="free">b'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WHILE <span class="free">b</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>WHILE <span class="free">b'</span> <span class="free">f'</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILE_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEI_refine<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> WHILE_refine'<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I'</span> <span class="free">x'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> COND_REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b'</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STEP_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="free">b'</span> <span class="bound">x'</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WHILE <span class="free">b</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>WHILEI <span class="free">I'</span> <span class="free">b'</span> <span class="free">f'</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILE_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEI_refine<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> AIF_leI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Φ</span><span class="main">;</span> <span class="free">Φ</span> <span class="main">⟹</span> <span class="free">S</span><span class="main">≤</span><span class="free">S'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">Φ</span> <span class="keyword1">then</span> <span class="free">S</span> <span class="keyword1">else</span> FAIL<span class="main">)</span> <span class="main">≤</span> <span class="free">S'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> ref_AIFI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Φ</span> <span class="main">⟹</span> <span class="free">S</span><span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="free">S'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">Φ</span> <span class="keyword1">then</span> <span class="free">S'</span> <span class="keyword1">else</span> FAIL<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement with generalized refinement relation. Required to exploit
  the fact that the condition does not hold at the end of the loop.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> WHILEIT_refine_genR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I'</span> <span class="free">x'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IREF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> COND_REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b'</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STEP_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="free">b'</span> <span class="bound">x'</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R'</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="main">¬</span><span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="main">¬</span><span class="free">b'</span> <span class="bound">x'</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WHILEIT <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>WHILEIT <span class="free">I'</span> <span class="free">b'</span> <span class="free">f'</span> <span class="free">x'</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ref_WHILEIT_invarI<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILEIT_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> RECT_refine<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WHILEI_body_trimono R0<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILEI_body_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ref_AIFI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AIF_leI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> IREF<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> if_refine<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> COND_REF<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bind_refine<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> STEP_REF<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> RETURN_refine<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_REF<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> WHILET_refine_genR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> COND_REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span> <span class="main">⟹</span> <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b'</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STEP_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="free">b'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R'</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="main">¬</span><span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="main">¬</span><span class="free">b'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WHILET <span class="free">b</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>WHILET <span class="free">b'</span> <span class="free">f'</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILET_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEIT_refine_genR<span class="main"><span class="main">[</span></span><span class="operator">OF</span> R0<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> TrueI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> WHILET_refine_genR'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I'</span> <span class="free">x'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> COND_REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b'</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STEP_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="free">b'</span> <span class="bound">x'</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R'</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> <span class="main">¬</span><span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="main">¬</span><span class="free">b'</span> <span class="bound">x'</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WHILET <span class="free">b</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>WHILEIT <span class="free">I'</span> <span class="free">b'</span> <span class="free">f'</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILET_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEIT_refine_genR<span class="main"><span class="main">[</span></span><span class="operator">OF</span> R0<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> TrueI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> WHILEIT_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I'</span> <span class="free">x'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IREF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> COND_REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b'</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STEP_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="free">b'</span> <span class="bound">x'</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WHILEIT <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>WHILEIT <span class="free">I'</span> <span class="free">b'</span> <span class="free">f'</span> <span class="free">x'</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> WHILEIT_refine_genR<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> WHILET_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> COND_REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b'</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STEP_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="free">b'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WHILET <span class="free">b</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>WHILET <span class="free">b'</span> <span class="free">f'</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILET_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEIT_refine<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> WHILET_refine'<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I'</span> <span class="free">x'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> COND_REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b'</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STEP_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="free">b'</span> <span class="bound">x'</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WHILET <span class="free">b</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>WHILEIT <span class="free">I'</span> <span class="free">b'</span> <span class="free">f'</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILET_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEIT_refine<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> WHILEI_refine_new_invar<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I'</span> <span class="free">x'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INV0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">I'</span> <span class="free">x'</span><span class="main">;</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">I</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> COND_REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b'</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STEP_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="free">b'</span> <span class="bound">x'</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STEP_INV<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="free">b'</span> <span class="bound">x'</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span><span class="main">;</span> nofail <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WHILEI <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>WHILEI <span class="free">I'</span> <span class="free">b'</span> <span class="free">f'</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEI_refine_genR<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
    I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">I</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> I'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">I'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> x'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">x'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> b'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">b'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">f'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">f</span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> R'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">c</span> <span class="main">}</span>"</span></span>
    <span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_invar_refineI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> WHILEIT_refine_new_invar<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I'</span> <span class="free">x'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INV0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">I'</span> <span class="free">x'</span><span class="main">;</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">I</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> COND_REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b'</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STEP_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="free">b'</span> <span class="bound">x'</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STEP_INV<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> nofail <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="free">b'</span> <span class="bound">x'</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WHILEIT <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>WHILEIT <span class="free">I'</span> <span class="free">b'</span> <span class="free">f'</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEIT_refine_genR<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
    I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">I</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> I'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">I'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> x'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">x'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> b'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">b'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">f'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">f</span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> R'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">c</span> <span class="main">}</span>"</span></span>
    <span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_invar_refineI<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Autoref Setup›</span></span>

<span class="comment1">(*lemma id_WHILE[autoref_id_self]: "ID_LIST 
  (l (WHILET,3) (WHILEIT I,3) (WHILE,3) (WHILEI I,3))"
  by simp_all*)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_op_pat_def</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"WHILEIT <span class="free">I</span> <span class="main">≡</span> <span class="keyword1">OP</span> <span class="main">(</span>WHILEIT <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"WHILEI <span class="free">I</span> <span class="main">≡</span> <span class="keyword1">OP</span> <span class="main">(</span>WHILEI <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> autoref_WHILET<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span> <span class="bound">x</span><span class="main">,</span><span class="free">c'</span><span class="main">$</span><span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> Id"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> REMOVE_INTERNAL <span class="free">c'</span> <span class="bound">x'</span><span class="main">;</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span><span class="free">f'</span><span class="main">$</span><span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>WHILET <span class="free">c</span> <span class="free">f</span> <span class="free">s</span><span class="main">,</span>
    <span class="main">(</span><span class="keyword1">OP</span> WHILET<span class="main">:::</span><span class="main">(</span><span class="free">R</span><span class="main">→</span>Id<span class="main">)</span><span class="main">→</span><span class="main">(</span><span class="free">R</span><span class="main">→</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel<span class="main">)</span><span class="main">→</span><span class="free">R</span><span class="main">→</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel<span class="main">)</span><span class="main">$</span><span class="free">c'</span><span class="main">$</span><span class="free">f'</span><span class="main">$</span><span class="free">s'</span><span class="main">)</span>
   <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nres_rel_def fun_rel_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> WHILET_refine<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> autoref_WHILEIT<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="bound">x'</span><span class="main">;</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span> <span class="bound">x</span><span class="main">,</span><span class="free">c'</span><span class="main">$</span><span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> Id"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span>REMOVE_INTERNAL <span class="free">c'</span> <span class="bound">x'</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x'</span><span class="main">;</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span><span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span><span class="free">f'</span><span class="main">$</span><span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>WHILET <span class="free">c</span> <span class="free">f</span> <span class="free">s</span><span class="main">,</span>
      <span class="main">(</span><span class="keyword1">OP</span> <span class="main">(</span>WHILEIT <span class="free">I</span><span class="main">)</span> <span class="main">:::</span> <span class="main">(</span><span class="free">R</span><span class="main">→</span>Id<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">R</span><span class="main">→</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel<span class="main">)</span> <span class="main">→</span> <span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel<span class="main">)</span><span class="main">$</span><span class="free">c'</span><span class="main">$</span><span class="free">f'</span><span class="main">$</span><span class="free">s'</span>
    <span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nres_rel_def fun_rel_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> WHILET_refine'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> autoref_WHILEIT'<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span> <span class="bound">x</span><span class="main">,</span><span class="free">c'</span><span class="main">$</span><span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> Id"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> REMOVE_INTERNAL <span class="free">c'</span> <span class="bound">x'</span><span class="main">;</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x'</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span><span class="free">f'</span><span class="main">$</span><span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>WHILET <span class="free">c</span> <span class="free">f</span><span class="main">,</span>
      <span class="main">(</span><span class="keyword1">OP</span> <span class="main">(</span>WHILEIT <span class="free">I</span><span class="main">)</span> <span class="main">:::</span> <span class="main">(</span><span class="free">R</span><span class="main">→</span>Id<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">R</span><span class="main">→</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel<span class="main">)</span> <span class="main">→</span> <span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel<span class="main">)</span><span class="main">$</span><span class="free">c'</span><span class="main">$</span><span class="free">f'</span>
    <span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">parametricity</span> 
      <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> autoref_WHILEIT<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span><span class="main"><span class="main">]</span></span>
      assms<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> autoref_WHILE<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="comment1">(** TODO: obsolete ? **)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span> <span class="bound">x</span><span class="main">,</span><span class="free">c'</span><span class="main">$</span><span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> Id"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> REMOVE_INTERNAL <span class="free">c'</span> <span class="bound">x'</span><span class="main">;</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span><span class="free">f'</span><span class="main">$</span><span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>WHILE <span class="free">c</span> <span class="free">f</span> <span class="free">s</span><span class="main">,</span>
      <span class="main">(</span><span class="keyword1">OP</span> WHILE <span class="main">:::</span> <span class="main">(</span><span class="free">R</span><span class="main">→</span>Id<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">R</span><span class="main">→</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel<span class="main">)</span> <span class="main">→</span> <span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel<span class="main">)</span><span class="main">$</span><span class="free">c'</span><span class="main">$</span><span class="free">f'</span><span class="main">$</span><span class="free">s'</span>
    <span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nres_rel_def fun_rel_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> WHILE_refine<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> autoref_WHILE'<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span> <span class="bound">x</span><span class="main">,</span><span class="free">c'</span><span class="main">$</span><span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> Id"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> REMOVE_INTERNAL <span class="free">c'</span> <span class="bound">x'</span><span class="main">;</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span><span class="free">f'</span><span class="main">$</span><span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>WHILE <span class="free">c</span> <span class="free">f</span><span class="main">,</span>
      <span class="main">(</span><span class="keyword1">OP</span> WHILE <span class="main">:::</span> <span class="main">(</span><span class="free">R</span><span class="main">→</span>Id<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">R</span><span class="main">→</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel<span class="main">)</span> <span class="main">→</span> <span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel<span class="main">)</span><span class="main">$</span><span class="free">c'</span><span class="main">$</span><span class="free">f'</span>
    <span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nres_rel_def fun_rel_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> WHILE_refine<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> autoref_WHILEI<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="bound">x'</span><span class="main">;</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span> <span class="bound">x</span><span class="main">,</span><span class="free">c'</span><span class="main">$</span><span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> Id"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span>REMOVE_INTERNAL <span class="free">c'</span> <span class="bound">x'</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x'</span><span class="main">;</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span><span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span><span class="free">f'</span><span class="main">$</span><span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>WHILE <span class="free">c</span> <span class="free">f</span> <span class="free">s</span><span class="main">,</span>
      <span class="main">(</span><span class="keyword1">OP</span> <span class="main">(</span>WHILEI <span class="free">I</span><span class="main">)</span> <span class="main">:::</span> <span class="main">(</span><span class="free">R</span><span class="main">→</span>Id<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">R</span><span class="main">→</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel<span class="main">)</span> <span class="main">→</span> <span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel<span class="main">)</span><span class="main">$</span><span class="free">c'</span><span class="main">$</span><span class="free">f'</span><span class="main">$</span><span class="free">s'</span>
    <span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nres_rel_def fun_rel_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> WHILE_refine'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> autoref_WHILEI'<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span> <span class="bound">x</span><span class="main">,</span><span class="free">c'</span><span class="main">$</span><span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> Id"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> REMOVE_INTERNAL <span class="free">c'</span> <span class="bound">x'</span><span class="main">;</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x'</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span><span class="free">f'</span><span class="main">$</span><span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>WHILE <span class="free">c</span> <span class="free">f</span><span class="main">,</span>
      <span class="main">(</span><span class="keyword1">OP</span> <span class="main">(</span>WHILEI <span class="free">I</span><span class="main">)</span> <span class="main">:::</span> <span class="main">(</span><span class="free">R</span><span class="main">→</span>Id<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">R</span><span class="main">→</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel<span class="main">)</span> <span class="main">→</span> <span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel<span class="main">)</span><span class="main">$</span><span class="free">c'</span><span class="main">$</span><span class="free">f'</span>
    <span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">parametricity</span> 
      <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> autoref_WHILEI<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span><span class="main"><span class="main">]</span></span>
      assms<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>



<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Tail Recursion›</span></span>
<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> tailrec_transform_aux1<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="free">s</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"REC <span class="main">(</span><span class="main">λ</span><span class="bound">D</span> <span class="bound">s</span><span class="main">.</span> sup <span class="main">(</span><span class="free">a</span> <span class="bound">s</span> <span class="main">⤜</span> <span class="bound">D</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">≤</span> lfp <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sup <span class="free">m</span> <span class="main">(</span><span class="bound">x</span><span class="main">⤜</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span> <span class="free">b</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"REC <span class="var">?F</span> <span class="free">s</span> <span class="main">≤</span> lfp <span class="var">?f</span> <span class="main">⤜</span> <span class="free">b</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> REC_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pre <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> RETURN <span class="bound">s</span> <span class="main">≤</span> lfp <span class="var">?f</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="free">s</span> <span class="main">≤</span> lfp <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sup <span class="free">m</span> <span class="main">(</span><span class="bound">x</span> <span class="main">⤜</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lfp_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">tagged_solver</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_supI1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> RETURN <span class="bound">x</span> <span class="main">≤</span> lfp <span class="var">?f</span> <span class="main">⟹</span>
                  <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> lfp <span class="var">?f</span> <span class="main">⤜</span> <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> PRE<span class="main">:</span> <span class="quoted"><span class="quoted">"RETURN <span class="skolem">x</span> <span class="main">≤</span> lfp <span class="var">?f</span>"</span></span>
  
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" sup <span class="main">(</span><span class="free">a</span> <span class="skolem">x</span> <span class="main">⤜</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> lfp <span class="var">?f</span> <span class="main">⤜</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sup_least<span class="main">)</span>  
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="skolem">x</span> <span class="main">≤</span> lfp <span class="var">?f</span> <span class="main">⤜</span> <span class="free">b</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> PRE
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">from</span></span> PRE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="skolem">x</span> <span class="main">≤</span> lfp <span class="var">?f</span> <span class="main">⤜</span> <span class="free">a</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> lfp <span class="var">?f</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> lfp_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">tagged_solver</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_supI2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="skolem">x</span> <span class="main">⤜</span> <span class="skolem">f</span> <span class="main">≤</span> lfp <span class="var">?f</span> <span class="main">⤜</span> <span class="free">b</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> IH
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>  
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">corollary</span></span> tailrec_transform1<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nres"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">⤜</span>REC <span class="main">(</span><span class="main">λ</span><span class="bound">D</span> <span class="bound">s</span><span class="main">.</span> sup <span class="main">(</span><span class="free">a</span> <span class="bound">s</span> <span class="main">⤜</span> <span class="bound">D</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> lfp <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sup <span class="free">m</span> <span class="main">(</span><span class="bound">x</span><span class="main">⤜</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"nofail <span class="free">m</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> bind_le_nofailI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> tailrec_transform_aux1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_nofail_iff lfp_const<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
            
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> tailrec_transform_aux2<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nres"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lfp <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sup <span class="free">m</span> <span class="main">(</span><span class="bound">x</span><span class="main">⤜</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">≤</span> <span class="free">m</span> <span class="main">⤜</span> REC <span class="main">(</span><span class="main">λ</span><span class="bound">D</span> <span class="bound">s</span><span class="main">.</span> sup <span class="main">(</span><span class="free">a</span> <span class="bound">s</span> <span class="main">⤜</span> <span class="bound">D</span><span class="main">)</span> <span class="main">(</span>RETURN <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"lfp <span class="var">?f</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⤜</span> REC <span class="var">?F</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> gen_kleene_lfp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cont_def pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SUP_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⤜</span> <span class="free">a</span><span class="main">)</span> <span class="main">^^</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⤜</span> REC <span class="main">(</span><span class="main">λ</span><span class="bound">D</span> <span class="bound">s</span><span class="main">.</span> sup <span class="main">(</span><span class="free">a</span> <span class="bound">s</span> <span class="main">⤜</span> <span class="bound">D</span><span class="main">)</span> <span class="main">(</span>RETURN <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> REC_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> funpow_Suc_right<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rprems</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> REC_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_distrib_sup2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> tailrec_transform_aux3<span class="main">:</span> <span class="quoted"><span class="quoted">"REC <span class="main">(</span><span class="main">λ</span><span class="bound">D</span> <span class="bound">s</span><span class="main">.</span> sup <span class="main">(</span><span class="free">a</span> <span class="bound">s</span> <span class="main">⤜</span> <span class="bound">D</span><span class="main">)</span> <span class="main">(</span>RETURN <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">⤜</span> <span class="free">b</span> 
    <span class="main">≤</span> REC <span class="main">(</span><span class="main">λ</span><span class="bound">D</span> <span class="bound">s</span><span class="main">.</span> sup <span class="main">(</span><span class="free">a</span> <span class="bound">s</span> <span class="main">⤜</span> <span class="bound">D</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_le_shift<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> REC_rule<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> TrueI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> REC_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bind_mono<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> order_refl<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rprems</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> REC_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> pw_le_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> REC_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> tailrec_transform2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"lfp <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sup <span class="free">m</span> <span class="main">(</span>bind <span class="bound">x</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⤜</span> REC <span class="main">(</span><span class="main">λ</span><span class="bound">D</span> <span class="bound">s</span><span class="main">.</span> sup <span class="main">(</span><span class="free">a</span> <span class="bound">s</span> <span class="main">⤜</span> <span class="bound">D</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> bind_mono<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> tailrec_transform_aux2 order_refl<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lfp <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sup <span class="free">m</span> <span class="main">(</span>bind <span class="bound">x</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span> <span class="free">b</span> 
      <span class="main">≤</span> <span class="free">m</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> REC <span class="main">(</span><span class="main">λ</span><span class="bound">D</span> <span class="bound">s</span><span class="main">.</span> sup <span class="main">(</span><span class="free">a</span> <span class="bound">s</span> <span class="main">⤜</span> <span class="bound">D</span><span class="main">)</span> <span class="main">(</span>RETURN <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⤜</span> <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> bind_mono<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> order_refl tailrec_transform_aux3<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⤜</span> REC <span class="main">(</span><span class="main">λ</span><span class="bound">D</span> <span class="bound">s</span><span class="main">.</span> sup <span class="main">(</span><span class="free">a</span> <span class="bound">s</span> <span class="main">⤜</span> <span class="bound">D</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>  
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">tailrec_body</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">D</span> <span class="bound">s</span><span class="main">.</span> sup <span class="main">(</span>bind <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="bound">D</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
  <span class="keyword1"><span class="command">theorem</span></span> tailrec_transform<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">⤜</span> REC <span class="main">(</span><span class="main">λ</span><span class="bound">D</span> <span class="bound">s</span><span class="main">.</span> sup <span class="main">(</span><span class="free">a</span> <span class="bound">s</span> <span class="main">⤜</span> <span class="bound">D</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lfp <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sup <span class="free">m</span> <span class="main">(</span>bind <span class="bound">x</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> tailrec_transform1<span class="main">)</span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> tailrec_transform2<span class="main">)</span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1"><span class="command">theorem</span></span> tailrec_transform'<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">⤜</span> REC <span class="main">(</span>tailrec_body <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> lfp <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sup <span class="free">m</span> <span class="main">(</span>bind <span class="bound">x</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tailrec_body_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tailrec_transform<span class="main">)</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"WHILE <span class="free">c</span> <span class="free">f</span> <span class="main">=</span> 
    REC <span class="main">(</span>tailrec_body 
      <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>ASSUME <span class="main">(</span><span class="free">c</span> <span class="bound">s</span><span class="main">)</span><span class="main">;</span> <span class="free">f</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span> 
      <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>ASSUME <span class="main">(</span><span class="main">¬</span><span class="free">c</span> <span class="bound">s</span><span class="main">)</span><span class="main">;</span> RETURN <span class="bound">s</span><span class="main">}</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> WHILE_def WHILEI_def WHILEI_body_def tailrec_body_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fo_rule</span> fun_cong arg_cong<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1"><span class="command">lemma</span></span> WHILEI_tailrec_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"WHILEI <span class="free">I</span> <span class="free">c</span> <span class="free">f</span> <span class="main">=</span> 
    REC <span class="main">(</span>tailrec_body 
      <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="main">(</span><span class="free">I</span> <span class="bound">s</span><span class="main">)</span><span class="main">;</span> ASSUME <span class="main">(</span><span class="free">c</span> <span class="bound">s</span><span class="main">)</span><span class="main">;</span> <span class="free">f</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span> 
      <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="main">(</span><span class="free">I</span> <span class="bound">s</span><span class="main">)</span><span class="main">;</span> ASSUME <span class="main">(</span><span class="main">¬</span><span class="free">c</span> <span class="bound">s</span><span class="main">)</span><span class="main">;</span> RETURN <span class="bound">s</span><span class="main">}</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> WHILEI_def WHILEI_body_def tailrec_body_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fo_rule</span> fun_cong arg_cong<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1"><span class="command">lemma</span></span> WHILEIT_tailrec_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"WHILEIT <span class="free">I</span> <span class="free">c</span> <span class="free">f</span> <span class="main">=</span> 
    RECT <span class="main">(</span>tailrec_body 
      <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="main">(</span><span class="free">I</span> <span class="bound">s</span><span class="main">)</span><span class="main">;</span> ASSUME <span class="main">(</span><span class="free">c</span> <span class="bound">s</span><span class="main">)</span><span class="main">;</span> <span class="free">f</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span> 
      <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="main">(</span><span class="free">I</span> <span class="bound">s</span><span class="main">)</span><span class="main">;</span> ASSUME <span class="main">(</span><span class="main">¬</span><span class="free">c</span> <span class="bound">s</span><span class="main">)</span><span class="main">;</span> RETURN <span class="bound">s</span><span class="main">}</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> WHILEIT_def WHILEI_body_def tailrec_body_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fo_rule</span> fun_cong arg_cong<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">WHILEI_lfp_body</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> 
    <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sup <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">s</span> <span class="main">←</span> <span class="bound">x</span><span class="main">;</span>
       <span class="main"><span class="bound">_</span></span> <span class="main">←</span> ASSERT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">;</span>
       <span class="main"><span class="bound">_</span></span> <span class="main">←</span> ASSUME <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">;</span>
       <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span>
     <span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    
  <span class="keyword1"><span class="command">lemma</span></span> WHILEI_lfp_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">⤜</span> WHILEI <span class="free">I</span> <span class="free">c</span> <span class="free">f</span> <span class="main">=</span> 
    <span class="keyword1">do</span> <span class="main">{</span> 
      <span class="bound">s</span> <span class="main">←</span> lfp <span class="main">(</span>WHILEI_lfp_body <span class="free">I</span> <span class="free">m</span> <span class="free">c</span> <span class="free">f</span><span class="main">)</span><span class="main">;</span> 
      ASSERT <span class="main">(</span><span class="free">I</span> <span class="bound">s</span><span class="main">)</span><span class="main">;</span> 
      ASSUME <span class="main">(</span><span class="main">¬</span><span class="free">c</span> <span class="bound">s</span><span class="main">)</span><span class="main">;</span> 
      RETURN <span class="bound">s</span> 
    <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> WHILEI_lfp_body_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> WHILEI_tailrec_conv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> tailrec_transform'<span class="main">)</span>
    <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Most Specific Invariant›</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">msii</span> <span class="comment1">― ‹Most specific invariant for WHILE-loop›</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">msii</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> lfp <span class="main">(</span>WHILEI_lfp_body <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>WHILEI_lfp_body <span class="free">I</span> <span class="free">m</span> <span class="free">c</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILEI_lfp_body_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">tagged_solver</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">filter_ASSUME</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">x</span><span class="main">←</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">;</span> ASSUME <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> RETURN <span class="bound">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">filter_ASSERT</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">x</span><span class="main">←</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">;</span> ASSERT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> RETURN <span class="bound">x</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>filter_ASSUME <span class="free">c</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟷</span> nofail <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> filter_ASSUME_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inres <span class="main">(</span>filter_ASSUME <span class="free">c</span> <span class="free">m</span><span class="main">)</span> <span class="free">x</span> 
  <span class="main">⟷</span> <span class="main">(</span>nofail <span class="free">m</span> <span class="main">⟶</span> inres <span class="free">m</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">c</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> filter_ASSUME_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> msii_is_invar<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> msii <span class="free">I</span> <span class="free">m</span> <span class="free">c</span> <span class="free">f</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> msii <span class="free">I</span> <span class="free">m</span> <span class="free">c</span> <span class="free">f</span> <span class="main">⟹</span> bind <span class="main">(</span>filter_ASSUME <span class="free">c</span> <span class="main">(</span>filter_ASSERT <span class="free">I</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="main">≤</span> msii <span class="free">I</span> <span class="free">m</span> <span class="free">c</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span>  msii_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lfp_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> WHILEI_lfp_body_def<span class="main">)</span>

  <span class="keyword1"><span class="command">unfolding</span></span> filter_ASSUME_def filter_ASSERT_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lfp_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> WHILEI_lfp_body_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> pw_le_iff<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> WHILE_msii_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">⤜</span> WHILEI <span class="free">I</span> <span class="free">c</span> <span class="free">f</span> 
  <span class="main">=</span> filter_ASSUME <span class="main">(</span>Not <span class="keyword1">o</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span>filter_ASSERT <span class="free">I</span> <span class="main">(</span>msii <span class="free">I</span> <span class="free">m</span> <span class="free">c</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WHILEI_lfp_conv filter_ASSERT_def filter_ASSUME_def msii_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> msii_induct<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m0</span> <span class="main">≤</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">m</span> <span class="main">≤</span> msii <span class="free">I</span> <span class="free">m0</span> <span class="free">c</span> <span class="free">f</span><span class="main">;</span> <span class="bound">m</span> <span class="main">≤</span> <span class="free">P</span><span class="main">;</span>
    filter_ASSUME <span class="free">c</span> <span class="main">(</span>filter_ASSERT <span class="free">I</span> <span class="bound">m</span><span class="main">)</span> <span class="main">⤜</span> <span class="free">f</span> <span class="main">≤</span> msii <span class="free">I</span> <span class="free">m0</span> <span class="free">c</span> <span class="free">f</span>
      <span class="main">⟧</span> <span class="main">⟹</span> filter_ASSUME <span class="free">c</span> <span class="main">(</span>filter_ASSERT <span class="free">I</span> <span class="bound">m</span><span class="main">)</span> <span class="main">⤜</span> <span class="free">f</span> <span class="main">≤</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"msii <span class="free">I</span> <span class="free">m0</span> <span class="free">c</span> <span class="free">f</span> <span class="main">≤</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> msii_def WHILEI_lfp_body_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lfp_gen_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">tagged_solver</span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> msii_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> WHILEI_lfp_body_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> I0<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> IS<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> filter_ASSERT_def filter_ASSUME_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Reachable without fail›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Reachable states in a while loop, ignoring failing states›</span></span>

  <span class="comment1">(* (R)eachable states (w)ith(o)ut (f)ail. All non-fail states reachable
    in a while-loop. *)</span>
  <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">rwof</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nres <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> nres<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">m0</span> <span class="entity">cond</span> <span class="entity">step</span> 
    <span class="keyword2"><span class="keyword">where</span></span>
      init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m0</span><span class="main">=</span>RES <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">rwof</span> <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
    <span class="main">|</span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">rwof</span> <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span> <span class="free">cond</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span> <span class="free">step</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> RES <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="free">rwof</span> <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

  <span class="comment1">(* This lemma establishes consequences of rwof as invariants. *)</span>
  <span class="keyword1"><span class="command">lemma</span></span> establish_rwof_invar<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m0</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">I</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="bound">s</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="free">cond</span> <span class="bound">s</span> <span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="free">step</span> <span class="bound">s</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">I</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induct</span>
    <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="comment1">(* Predicate to express an rwof-invariant *)</span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_rwof_invar</span> <span class="free"><span class="bound"><span class="entity">m0</span></span></span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> 
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m0</span></span></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> rwof <span class="free"><span class="bound"><span class="entity">m0</span></span></span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="bound">s</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">s</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="bound">s</span> 
        <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="bound">s</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> is_rwof_invarI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m0</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">I</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="bound">s</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="free">cond</span> <span class="bound">s</span> <span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="free">step</span> <span class="bound">s</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">I</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_rwof_invar <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_rwof_invar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">lemma</span></span> rwof_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_rwof_invar <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">I</span><span class="main">;</span> rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">I</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_rwof_invar_def
    <span class="keyword1"><span class="command">using</span></span> establish_rwof_invar<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m0</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">cond</span></span> <span class="quoted"><span class="free">step</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    

  <span class="comment1">(* This lemma proves a specification for the while loop, based on rwof
    and a nofail-proof. *)</span>
  <span class="keyword1"><span class="command">lemma</span></span> rwof_WHILE_rule<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m0</span> <span class="main">≤</span> SPEC <span class="free">I</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="bound">s</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="free">cond</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">step</span> <span class="bound">s</span> <span class="main">≤</span> SPEC <span class="free">I</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m0</span> <span class="main">⤜</span> WHILE <span class="free">cond</span> <span class="free">step</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span><span class="free">cond</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> I0 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m0</span> <span class="main">=</span> RES <span class="skolem">M0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M0</span> <span class="main">⊆</span> Collect <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m0</span></span><span class="main">)</span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_vcg</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILE_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="bound">s</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span><span class="skolem">M0</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">s</span> <span class="main">∧</span> rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> I0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rwof.init<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
      <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">s</span> <span class="main">∧</span> rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cond</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="skolem">s</span> <span class="main">≤</span> SPEC <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> S<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="skolem">s</span> <span class="main">=</span> RES <span class="skolem">S'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="skolem">s</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> rwof.step<span class="main">[</span><span class="operator">OF</span> conjunct2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span> C this<span class="main">]</span> this 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="skolem">s</span> <span class="main">≤</span> SPEC <span class="main">(</span>rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="main">(</span>SPEC_rule_conjI<span class="main">)</span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="skolem">s</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Filtering out states that satisfy the loop condition›</span></span>
  <span class="comment1">(* A shortcut definition for filtering out all results that satisfy
    the loop condition. Intuitively, filtering out these results from the 
    best invariant gives the results of the while loop. *)</span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">filter_nb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> nres <span class="main">⇒</span> <span class="tfree">'a</span> nres"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">filter_nb</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">s</span><span class="main">←</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">;</span> ASSUME <span class="main">(</span><span class="main">¬</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">;</span> RETURN <span class="bound">s</span><span class="main">}</span>"</span></span>
  
  <span class="keyword1"><span class="command">lemma</span></span> pw_filter_nb<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>filter_nb <span class="free">b</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟷</span> nofail <span class="free">I</span>"</span></span>
    <span class="quoted"><span class="quoted">"inres <span class="main">(</span>filter_nb <span class="free">b</span> <span class="free">I</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟷</span> <span class="main">(</span>nofail <span class="free">I</span> <span class="main">⟶</span> inres <span class="free">I</span> <span class="free">x</span> <span class="main">∧</span> <span class="main">¬</span><span class="free">b</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> filter_nb_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> filter_nb_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">≤</span><span class="free">m'</span> <span class="main">⟹</span> filter_nb <span class="free">cond</span> <span class="free">m</span> <span class="main">≤</span> filter_nb <span class="free">cond</span> <span class="free">m'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> filter_nb_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">refine_mono</span>

  <span class="keyword1"><span class="command">lemma</span></span> filter_nb_cont<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"filter_nb <span class="free">cond</span> <span class="main">(</span>Sup <span class="free">M</span><span class="main">)</span> <span class="main">=</span> Sup <span class="main">{</span>filter_nb <span class="free">cond</span> <span class="bound">m</span> <span class="main">|</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">∈</span> <span class="free">M</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> not_nofail_inres <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> not_nofail_inres <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">lemma</span></span> filter_nb_FAIL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"filter_nb <span class="free">cond</span> FAIL <span class="main">=</span> FAIL"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_nb_def<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> filter_nb_RES<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"filter_nb <span class="free">cond</span> <span class="main">(</span>RES <span class="free">X</span><span class="main">)</span> <span class="main">=</span> RES <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="main">¬</span><span class="free">cond</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Bounded while-loop›</span></span>

  <span class="comment1">(* A while rule that establishes an inductive invariant,
    and then filters out the results satisfying the condition. *)</span>
  <span class="keyword1"><span class="command">lemma</span></span> WHILE_rule_gen_le<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m0</span> <span class="main">≤</span> <span class="free">I</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> ISTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span>RETURN <span class="bound">s</span> <span class="main">≤</span> <span class="free">I</span><span class="main">;</span> <span class="free">b</span> <span class="bound">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">I</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m0</span> <span class="main">⤜</span> WHILE <span class="free">b</span> <span class="free">f</span> <span class="main">≤</span> filter_nb <span class="free">b</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> WHILE_def WHILEI_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> I0<span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span> pw_bind_leI<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> I0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> REC_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WHILEI_body_trimono<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pre<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> RETURN <span class="bound">s</span> <span class="main">≤</span> <span class="free">I</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> I0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
      
        <span class="keyword1"><span class="command">unfolding</span></span> WHILEI_body_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">split</span> if_split<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> impI conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> ISTEP
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_use</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">bounded_WHILE'</span> 
    <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> nres<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> nres <span class="main">⇒</span> <span class="tfree">'a</span> nres"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">bounded_WHILE'</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bounded_WHILE'</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">x</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">;</span>
      <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="free">bounded_WHILE'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="bound">x</span><span class="main">)</span>
      <span class="keyword1">else</span> RETURN <span class="bound">x</span>
    <span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">bounded_WHILE</span>
    <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> nres<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> nres <span class="main">⇒</span> <span class="tfree">'a</span> nres"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">bounded_WHILE</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bounded_WHILE</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">x</span> <span class="main">←</span> <span class="free">bounded_WHILE</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">;</span>
      <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="bound">x</span>
      <span class="keyword1">else</span> RETURN <span class="bound">x</span>
    <span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> bounded_WHILE_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
             <span class="bound">x</span> <span class="main">←</span> <span class="free">m</span><span class="main">;</span>
             <span class="keyword1">if</span> <span class="free">cond</span> <span class="bound">x</span> <span class="keyword1">then</span> bounded_WHILE <span class="free">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="main">(</span><span class="free">step</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> RETURN <span class="bound">x</span>
           <span class="main">}</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
             <span class="bound">x</span> <span class="main">←</span> bounded_WHILE <span class="free">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m</span><span class="main">;</span>
             <span class="keyword1">if</span> <span class="free">cond</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="free">step</span> <span class="bound">x</span> <span class="keyword1">else</span> RETURN <span class="bound">x</span>
           <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> 

    <span class="keyword1"><span class="command">have</span></span> aux1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">x</span> <span class="main">←</span> <span class="skolem">m</span><span class="main">;</span>
      <span class="keyword1">if</span> <span class="free">cond</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                       <span class="bound">x</span> <span class="main">←</span> bounded_WHILE <span class="skolem">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="main">(</span><span class="free">step</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span>
                       <span class="keyword1">if</span> <span class="free">cond</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="free">step</span> <span class="bound">x</span> <span class="keyword1">else</span> RETURN <span class="bound">x</span>
                     <span class="main">}</span>
      <span class="keyword1">else</span> RETURN <span class="bound">x</span>
    <span class="main">}</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">x</span> <span class="main">←</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">x</span> <span class="main">←</span> <span class="skolem">m</span><span class="main">;</span> 
        <span class="keyword1">if</span> <span class="free">cond</span> <span class="bound">x</span> <span class="keyword1">then</span> bounded_WHILE <span class="skolem">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="main">(</span><span class="free">step</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> RETURN <span class="bound">x</span>
      <span class="main">}</span><span class="main">;</span>
      <span class="keyword1">if</span> <span class="free">cond</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="free">step</span> <span class="bound">x</span> <span class="keyword1">else</span> RETURN <span class="bound">x</span>
    <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> aux1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Suc.IH<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>


  <span class="keyword1"><span class="command">lemma</span></span> bounded_WHILE'_eq<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"bounded_WHILE' <span class="free">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m</span> <span class="main">=</span> bounded_WHILE <span class="free">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bounded_WHILE_shift<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">lemma</span></span> mWHILE_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">⤜</span> WHILE <span class="free">cond</span> <span class="free">step</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">x</span> <span class="main">←</span> <span class="free">m</span><span class="main">;</span>
      <span class="keyword1">if</span> <span class="free">cond</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="free">step</span> <span class="bound">x</span> <span class="main">⤜</span> WHILE <span class="free">cond</span> <span class="free">step</span>
      <span class="keyword1">else</span> RETURN <span class="bound">x</span>
    <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> WHILE_unfold<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> WHILE_bounded_aux1<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"filter_nb <span class="free">cond</span> <span class="main">(</span>bounded_WHILE <span class="free">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m</span><span class="main">)</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⤜</span> WHILE <span class="free">cond</span> <span class="free">step</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bounded_WHILE'_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> mWHILE_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> mWHILE_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">lemma</span></span> WHILE_bounded_aux2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">⤜</span> WHILE <span class="free">cond</span> <span class="free">step</span> 
      <span class="main">≤</span> filter_nb <span class="free">cond</span> <span class="main">(</span>Sup <span class="main">{</span>bounded_WHILE <span class="bound">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m</span> <span class="main">|</span> <span class="bound">n</span><span class="main">.</span> True<span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILE_rule_gen_le<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Sup_upper bounded_WHILE.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
      mem_Collect_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="skolem">s</span> <span class="main">≤</span> Sup <span class="main">{</span>bounded_WHILE <span class="bound">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m</span> <span class="main">|</span><span class="bound">n</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="skolem">s</span> <span class="main">≤</span> bounded_WHILE <span class="skolem">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> inres_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">cond</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="skolem">s</span> <span class="main">≤</span> bounded_WHILE <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="skolem">s</span> <span class="main">≤</span> Sup <span class="main">{</span>bounded_WHILE <span class="bound">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m</span> <span class="main">|</span><span class="bound">n</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Sup_upper2 mem_Collect_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

   
  <span class="keyword1"><span class="command">lemma</span></span> WHILE_bounded<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">⤜</span> WHILE <span class="free">cond</span> <span class="free">step</span> 
    <span class="main">=</span> filter_nb <span class="free">cond</span> <span class="main">(</span>Sup <span class="main">{</span>bounded_WHILE <span class="bound">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m</span> <span class="main">|</span> <span class="bound">n</span><span class="main">.</span> True<span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILE_bounded_aux2<span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_nb_cont<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> WHILE_bounded_aux1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Relation to rwof›</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> rwof_in_bounded_WHILE<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">s</span>"</span></span> 
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> RETURN <span class="free">s</span> <span class="main">≤</span> <span class="main">(</span>bounded_WHILE <span class="bound">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induction</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="improper">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">lemma</span></span> bounded_WHILE_FAIL_rwof<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bounded_WHILE <span class="free">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m0</span> <span class="main">=</span> FAIL"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> M0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m0</span> <span class="main">≠</span> FAIL"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n'</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="bound">X</span><span class="main">.</span> 
        bounded_WHILE <span class="bound">n'</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m0</span> <span class="main">=</span> RES <span class="bound">X</span> 
      <span class="main">∧</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">X</span> <span class="main">∧</span> <span class="free">cond</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">step</span> <span class="bound">x</span> <span class="main">=</span> FAIL"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"bounded_WHILE <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m0</span> <span class="main">=</span> FAIL"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bounded_WHILE <span class="skolem">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m0</span> <span class="main">=</span> FAIL 
      <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">X</span> <span class="bound">x</span><span class="main">.</span> bounded_WHILE <span class="skolem">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m0</span> <span class="main">=</span> RES <span class="bound">X</span> 
          <span class="main">∧</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">X</span> <span class="main">∧</span> <span class="free">cond</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">step</span> <span class="bound">x</span> <span class="main">=</span> FAIL<span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C1</span> <span class="main">∨</span> <span class="var">?C2</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"bounded_WHILE <span class="skolem">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m0</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> not_nofail_inres <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?C1</span></span></span>
      <span class="keyword1"><span class="command">from</span></span> Suc.IH<span class="main">[</span><span class="operator">OF</span> this M0<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        1<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_WHILE <span class="skolem">n'</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m0</span> <span class="main">=</span> RES <span class="skolem">X</span> <span class="main">∧</span> <span class="skolem">x</span><span class="main">∈</span><span class="skolem">X</span> <span class="main">∧</span> <span class="free">cond</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="free">step</span> <span class="skolem">x</span> <span class="main">=</span> FAIL"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?C2</span></span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> bounded_WHILE_RES_rwof<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bounded_WHILE <span class="free">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m0</span> <span class="main">=</span> RES <span class="free">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">X</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rwof.init<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Xh</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      BWN<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_WHILE <span class="skolem">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m0</span> <span class="main">=</span> RES <span class="skolem">Xh</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">Xh</span><span class="main">.</span> <span class="free">cond</span> <span class="bound">x</span> <span class="main">⟶</span> nofail <span class="main">(</span><span class="free">step</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">Xh</span><span class="main">.</span> <span class="free">cond</span> <span class="bound">x</span> <span class="main">∧</span> inres <span class="main">(</span><span class="free">step</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">x'</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="skolem">Xh</span> <span class="main">∧</span> <span class="main">¬</span><span class="free">cond</span> <span class="bound">x</span><span class="main">}</span> "</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"bounded_WHILE <span class="skolem">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m0</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> pw_eq_iff<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> pw_eq_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">with</span></span> Suc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xh</span></span> <span class="skolem"><span class="skolem">X'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">xh</span><span class="main">∈</span><span class="skolem">Xh</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cond</span> <span class="skolem">xh</span> <span class="main">⟶</span> <span class="free">step</span> <span class="skolem">xh</span> <span class="main">=</span> RES <span class="skolem">X'</span> <span class="main">∧</span> <span class="skolem">x</span><span class="main">∈</span><span class="skolem">X'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> NC<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">cond</span> <span class="skolem">xh</span> <span class="main">⟶</span> <span class="skolem">x</span><span class="main">=</span><span class="skolem">xh</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nofail_RES_conv<span class="main">)</span>
    
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cond</span> <span class="skolem">xh</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rwof.step<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">X'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Suc.IH<span class="main"><span class="main">[</span></span><span class="operator">OF</span> BWN <span class="quoted"><span class="quoted">‹<span class="skolem">xh</span><span class="main">∈</span><span class="skolem">Xh</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> C<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
        
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Suc.IH<span class="main"><span class="main">[</span></span><span class="operator">OF</span> BWN<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> NC <span class="quoted"><span class="quoted">‹<span class="skolem">xh</span><span class="main">∈</span><span class="skolem">Xh</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
      

  <span class="keyword1"><span class="command">lemma</span></span> rwof_FAIL_imp_WHILE_FAIL<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> RW<span class="main">:</span> <span class="quoted"><span class="quoted">"rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">s</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cond</span> <span class="free">s</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="free">s</span> <span class="main">=</span> FAIL"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m0</span> <span class="main">⤜</span> WHILE <span class="free">cond</span> <span class="free">step</span> <span class="main">=</span> FAIL"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> rwof_in_bounded_WHILE<span class="main">[</span><span class="operator">OF</span> RW<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"RETURN <span class="free">s</span> <span class="main">≤</span> bounded_WHILE <span class="skolem">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m0</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">with</span></span> C <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="free">s</span> <span class="main">≤</span> bounded_WHILE <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> S <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_WHILE <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m0</span> <span class="main">=</span> FAIL"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> WHILE_bounded_aux1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cond</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="free">step</span></span> <span class="quoted"><span class="free">m0</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bounded_WHILE.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> pw_bounded_WHILE_RES_rwof<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> nofail <span class="main">(</span>bounded_WHILE <span class="free">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m0</span><span class="main">)</span><span class="main">;</span> 
    inres <span class="main">(</span>bounded_WHILE <span class="free">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m0</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟧</span> <span class="main">⟹</span> rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bounded_WHILE_RES_rwof<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">cond</span></span> <span class="quoted"><span class="free">step</span></span> <span class="quoted"><span class="free">m0</span></span> <span class="main">_</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_eq_iff<span class="main">)</span>
    
  <span class="keyword1"><span class="command">corollary</span></span> WHILE_nofail_imp_rwof_nofail<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">m0</span> <span class="main">⤜</span> WHILE <span class="free">cond</span> <span class="free">step</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> RW<span class="main">:</span> <span class="quoted"><span class="quoted">"rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">s</span>"</span></span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cond</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">step</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nofail_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms rwof_FAIL_imp_WHILE_FAIL<span class="main">[</span><span class="operator">OF</span> RW C<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">(* TODO: Move *)</span>
  <span class="keyword1"><span class="command">lemma</span></span> WHILE_le_WHILEI<span class="main">:</span> <span class="quoted"><span class="quoted">"WHILE <span class="free">b</span> <span class="free">f</span> <span class="free">s</span> <span class="main">≤</span> WHILEI <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> WHILE_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> WHILEI_weaken<span class="main">)</span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">corollary</span></span> WHILEI_nofail_imp_rwof_nofail<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> NF<span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">m0</span> <span class="main">⤜</span> WHILEI <span class="free">I</span> <span class="free">cond</span> <span class="free">step</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> RW<span class="main">:</span> <span class="quoted"><span class="quoted">"rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">s</span>"</span></span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cond</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">step</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> NF <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">m0</span> <span class="main">⤜</span> WHILE <span class="free">cond</span> <span class="free">step</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> WHILE_le_WHILEI 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> WHILE_nofail_imp_rwof_nofail<span class="main">[</span><span class="operator">OF</span> this RW C<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">corollary</span></span> WHILET_nofail_imp_rwof_nofail<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> NF<span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">m0</span> <span class="main">⤜</span> WHILET <span class="free">cond</span> <span class="free">step</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> RW<span class="main">:</span> <span class="quoted"><span class="quoted">"rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">s</span>"</span></span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cond</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">step</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> NF <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">m0</span> <span class="main">⤜</span> WHILE <span class="free">cond</span> <span class="free">step</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> WHILEI_le_WHILEIT <span class="keyword1"><span class="command">unfolding</span></span> WHILE_def WHILET_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> WHILE_nofail_imp_rwof_nofail<span class="main">[</span><span class="operator">OF</span> this RW C<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">corollary</span></span> WHILEIT_nofail_imp_rwof_nofail<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> NF<span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">m0</span> <span class="main">⤜</span> WHILEIT <span class="free">I</span> <span class="free">cond</span> <span class="free">step</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> RW<span class="main">:</span> <span class="quoted"><span class="quoted">"rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">s</span>"</span></span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cond</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">step</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> NF <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">m0</span> <span class="main">⤜</span> WHILE <span class="free">cond</span> <span class="free">step</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> WHILE_le_WHILEI WHILEI_le_WHILEIT <span class="keyword1"><span class="command">unfolding</span></span> WHILE_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> WHILE_nofail_imp_rwof_nofail<span class="main">[</span><span class="operator">OF</span> this RW C<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> pw_rwof_in_bounded_WHILE<span class="main">:</span>
    <span class="quoted"><span class="quoted">"rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> inres <span class="main">(</span>bounded_WHILE <span class="bound">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m0</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rwof_in_bounded_WHILE<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m0</span></span> <span class="quoted"><span class="free">cond</span></span> <span class="quoted"><span class="free">step</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> not_nofail_inres<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹WHILE-loops in the nofail-case›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> nofail_WHILE_eq_rwof<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> NF<span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">m0</span> <span class="main">⤜</span> WHILE <span class="free">cond</span> <span class="free">step</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m0</span> <span class="main">⤜</span> WHILE <span class="free">cond</span> <span class="free">step</span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span><span class="free">cond</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> NF WHILE_bounded<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m0</span></span> <span class="quoted"><span class="free">cond</span></span> <span class="quoted"><span class="free">step</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> NF'<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>Sup <span class="main">{</span>filter_nb <span class="free">cond</span> <span class="bound">m</span> <span class="main">|</span><span class="bound">m</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="bound">m</span> <span class="main">=</span> bounded_WHILE <span class="bound">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m0</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filter_nb_cont<span class="main">)</span>

    <span class="comment1">(*from NF WHILE_bounded[of m0 cond step] obtain X 
      where FR:
        "Sup {filter_nb cond m |m. ∃n. m = bounded_WHILE n cond step m0} = RES X"
      by (auto simp: nofail_RES_conv filter_nb_cont)*)</span>
    
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> WHILE_bounded<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m0</span></span> <span class="quoted"><span class="free">cond</span></span> <span class="quoted"><span class="free">step</span></span><span class="main">]</span> filter_nb_cont
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Sup <span class="main">{</span>filter_nb <span class="free">cond</span> <span class="bound">m</span> <span class="main">|</span><span class="bound">m</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="bound">m</span> <span class="main">=</span> bounded_WHILE <span class="bound">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m0</span><span class="main">}</span>
        <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">cond</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> NF' pw_bounded_WHILE_RES_rwof<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">cond</span></span> <span class="quoted"><span class="free">step</span></span> <span class="quoted"><span class="free">m0</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">cond</span> <span class="bound">s</span><span class="main">)</span>
        <span class="main">≤</span> Sup <span class="main">{</span>filter_nb <span class="free">cond</span> <span class="bound">m</span> <span class="main">|</span><span class="bound">m</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="bound">m</span> <span class="main">=</span> bounded_WHILE <span class="bound">n</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">m0</span><span class="main">}</span>"</span></span>      
        <span class="keyword1"><span class="command">using</span></span> NF' pw_rwof_in_bounded_WHILE<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m0</span></span> <span class="quoted"><span class="free">cond</span></span> <span class="quoted"><span class="free">step</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> WHILE_refine_rwof<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">m</span> <span class="main">⤜</span> WHILE <span class="free">c</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">mi</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> rwof <span class="free">m</span> <span class="free">c</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span><span class="free">c</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">mi</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⤜</span> WHILE <span class="free">c</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">m</span> <span class="main">⤜</span> WHILE <span class="free">c</span> <span class="free">f</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nofail_WHILE_eq_rwof<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


  <span class="keyword1"><span class="command">lemma</span></span> pw_rwof_init<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> NF<span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">m0</span> <span class="main">⤜</span> WHILE <span class="free">cond</span> <span class="free">step</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inres <span class="free">m0</span> <span class="free">s</span> <span class="main">⟹</span> rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nofail <span class="free">m0</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">using</span></span> NF <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m0</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rwof.init<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    
    <span class="keyword1"><span class="command">using</span></span> NF <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">lemma</span></span> rwof_init<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> NF<span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">m0</span> <span class="main">⤜</span> WHILE <span class="free">cond</span> <span class="free">step</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m0</span> <span class="main">≤</span> SPEC <span class="main">(</span>rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pw_rwof_init<span class="main">[</span><span class="operator">OF</span> NF<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> pw_rwof_step'<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> NF<span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">step</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cond</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inres <span class="main">(</span><span class="free">step</span> <span class="free">s</span><span class="main">)</span> <span class="free">s'</span> <span class="main">⟹</span> rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> NF
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nofail_RES_conv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rwof.step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> R C<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">lemma</span></span> rwof_step'<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> nofail <span class="main">(</span><span class="free">step</span> <span class="free">s</span><span class="main">)</span><span class="main">;</span> rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">s</span><span class="main">;</span> <span class="free">cond</span> <span class="free">s</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">step</span> <span class="free">s</span> <span class="main">≤</span> SPEC <span class="main">(</span>rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pw_rwof_step'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">step</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">m0</span></span> <span class="quoted"><span class="free">cond</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> pw_rwof_step<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> NF<span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">m0</span> <span class="main">⤜</span> WHILE <span class="free">cond</span> <span class="free">step</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cond</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inres <span class="main">(</span><span class="free">step</span> <span class="free">s</span><span class="main">)</span> <span class="free">s'</span> <span class="main">⟹</span> rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">s'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">step</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> WHILE_nofail_imp_rwof_nofail<span class="main">[</span><span class="operator">OF</span> NF R C<span class="main">]</span> pw_rwof_step'<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>2-<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">lemma</span></span> rwof_step<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> nofail <span class="main">(</span><span class="free">m0</span> <span class="main">⤜</span> WHILE <span class="free">cond</span> <span class="free">step</span><span class="main">)</span><span class="main">;</span> rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">s</span><span class="main">;</span> <span class="free">cond</span> <span class="free">s</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">step</span> <span class="free">s</span> <span class="main">≤</span> SPEC <span class="main">(</span>rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pw_rwof_step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m0</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">cond</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">step</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> rwof_leof_init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="main">(</span>rwof <span class="free">m</span> <span class="free">c</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">using</span></span> rwof.init
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nofail_RES_conv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> rwof_leof_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>rwof <span class="free">m</span> <span class="free">c</span> <span class="free">f</span> <span class="free">s</span><span class="main">;</span> <span class="free">c</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">s</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="main">(</span>rwof <span class="free">m</span> <span class="free">c</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">using</span></span> rwof.step
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nofail_RES_conv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> rwof_step_refine<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> NF<span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">m0</span> <span class="main">⤜</span> WHILE <span class="free">cond</span> <span class="free">step</span><span class="main">)</span>"</span></span>  
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step'</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> FR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="bound">s</span><span class="main">;</span> <span class="free">cond</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">step'</span> <span class="bound">s</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">step</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rwof <span class="free">m0</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> establish_rwof_invar<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ A<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rwof_leof_init<span class="main">)</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> leof_trans_nofail<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FR<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILE_nofail_imp_rwof_nofail<span class="main"><span class="main">[</span></span><span class="operator">OF</span> NF<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rwof_leof_step<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Adding Invariants›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> WHILE_eq_I_rwof<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">⤜</span> WHILE <span class="free">c</span> <span class="free">f</span> <span class="main">=</span> <span class="free">m</span> <span class="main">⤜</span> WHILEI <span class="main">(</span>rwof <span class="free">m</span> <span class="free">c</span> <span class="free">f</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">⤜</span> WHILEI <span class="main">(</span>rwof <span class="free">m</span> <span class="free">c</span> <span class="free">f</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span>
      <span class="main">≤</span> <span class="main">⇓</span><span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span><span class="main">.</span> rwof <span class="free">m</span> <span class="free">c</span> <span class="free">f</span> <span class="bound">s</span><span class="main">}</span> 
        <span class="main">(</span><span class="free">m</span> <span class="main">⤜</span> WHILE <span class="free">c</span> <span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> WHILE_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bind_refine<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> intro_prgR<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span><span class="main">.</span> rwof <span class="free">m</span> <span class="free">c</span> <span class="free">f</span> <span class="bound">s</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> rwof.init<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEI_refine<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> pw_rwof_step'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">⤜</span> WHILEI <span class="main">(</span>rwof <span class="free">m</span> <span class="free">c</span> <span class="free">f</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⤜</span> WHILE <span class="free">c</span> <span class="free">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">⤜</span> WHILE <span class="free">c</span> <span class="free">f</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⤜</span> WHILEI <span class="main">(</span>rwof <span class="free">m</span> <span class="free">c</span> <span class="free">f</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> WHILE_def 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bind_mono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_refl<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEI_weaken<span class="main">)</span>
      <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> WHILET_eq_I_rwof<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">⤜</span> WHILET <span class="free">c</span> <span class="free">f</span> <span class="main">=</span> <span class="free">m</span> <span class="main">⤜</span> WHILEIT <span class="main">(</span>rwof <span class="free">m</span> <span class="free">c</span> <span class="free">f</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">⤜</span> WHILEIT <span class="main">(</span>rwof <span class="free">m</span> <span class="free">c</span> <span class="free">f</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span>
      <span class="main">≤</span> <span class="main">⇓</span><span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span><span class="main">.</span> rwof <span class="free">m</span> <span class="free">c</span> <span class="free">f</span> <span class="bound">s</span><span class="main">}</span> 
        <span class="main">(</span><span class="free">m</span> <span class="main">⤜</span> WHILET <span class="free">c</span> <span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> WHILET_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bind_refine<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> intro_prgR<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span><span class="main">.</span> rwof <span class="free">m</span> <span class="free">c</span> <span class="free">f</span> <span class="bound">s</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> rwof.init<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEIT_refine<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> pw_rwof_step'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">⤜</span> WHILEIT <span class="main">(</span>rwof <span class="free">m</span> <span class="free">c</span> <span class="free">f</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⤜</span> WHILET <span class="free">c</span> <span class="free">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">⤜</span> WHILET <span class="free">c</span> <span class="free">f</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⤜</span> WHILEIT <span class="main">(</span>rwof <span class="free">m</span> <span class="free">c</span> <span class="free">f</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> WHILET_def 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bind_mono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_refl<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEIT_weaken<span class="main">)</span>
      <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> rwof_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RW<span class="main">:</span> <span class="quoted"><span class="quoted">"rwof <span class="free">m</span> <span class="free">c</span> <span class="free">f</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> NF<span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">m'</span> <span class="main">⤜</span> WHILE <span class="free">c'</span> <span class="free">f'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">⇓</span><span class="free">R</span> <span class="free">m'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> rwof <span class="free">m</span> <span class="free">c</span> <span class="free">f</span> <span class="bound">s</span><span class="main">;</span> rwof <span class="free">m'</span> <span class="free">c'</span> <span class="free">f'</span> <span class="bound">s'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">c</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">c'</span> <span class="bound">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> rwof <span class="free">m</span> <span class="free">c</span> <span class="free">f</span> <span class="bound">s</span><span class="main">;</span> rwof <span class="free">m'</span> <span class="free">c'</span> <span class="free">f'</span> <span class="bound">s'</span><span class="main">;</span> <span class="free">c</span> <span class="bound">s</span><span class="main">;</span> <span class="free">c'</span> <span class="bound">s'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">s</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">∧</span> rwof <span class="free">m'</span> <span class="free">c'</span> <span class="free">f'</span> <span class="bound">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> RW
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> establish_rwof_invar<span class="main"><span class="main">[</span></span><span class="operator">rotated</span> -1<span class="main"><span class="main">,</span></span><span class="operator">consumes</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> M rwof_init<span class="main">[</span><span class="operator">OF</span> NF<span class="main">]</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> pw_leof_iff pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command">using</span></span> C S rwof_step<span class="main">[</span><span class="operator">OF</span> NF<span class="main">]</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> pw_leof_iff pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Total Correct Loops›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this theory, we show that every non-failing total-correct 
  while loop gives rise to a compatible well-founded relation›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rwof_rel</span> 
  <span class="comment1">― ‹Transitions in a while-loop as relation›</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rwof_rel</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> 
    <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> rwof <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="bound">s</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="bound">s</span> <span class="main">∧</span> inres <span class="main">(</span><span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s'</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rwof_rel_spec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>rwof <span class="free">init</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">s</span><span class="main">;</span> <span class="free">cond</span> <span class="free">s</span><span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="free">step</span> <span class="free">s</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈</span>rwof_rel <span class="free">init</span> <span class="free">cond</span> <span class="free">step</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rwof_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_leof_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>  


<span class="keyword1"><span class="command">lemma</span></span> rwof_reachable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rwof <span class="free">init</span> <span class="free">cond</span> <span class="free">step</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s0</span><span class="main">.</span> inres <span class="free">init</span> <span class="bound">s0</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s0</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span>rwof_rel <span class="free">init</span> <span class="free">cond</span> <span class="free">step</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> rwof_rel_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rwof.intros<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rwof.intros<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">theorem</span></span> nofail_WHILEIT_wf_rel<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> NF<span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="free">init</span> <span class="main">⤜</span> WHILEIT <span class="free">I</span> <span class="free">cond</span> <span class="free">step</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span><span class="main">(</span>rwof_rel <span class="free">init</span> <span class="free">cond</span> <span class="free">step</span><span class="main">)</span><span class="main">¯</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>wf <span class="main">(</span><span class="main">(</span>rwof_rel <span class="free">init</span> <span class="free">cond</span> <span class="free">step</span><span class="main">)</span><span class="main">¯</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> IP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> rwof_rel <span class="free">init</span> <span class="free">cond</span> <span class="free">step</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wf_iff_no_infinite_down_chain <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rwof <span class="free">init</span> <span class="free">cond</span> <span class="free">step</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rwof_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s0</span></span> <span class="skolem"><span class="skolem">sn</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s0</span><span class="main">,</span> <span class="skolem">sn</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>rwof_rel <span class="free">init</span> <span class="free">cond</span> <span class="free">step</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="quoted"><span class="quoted">"inres <span class="free">init</span> <span class="skolem">s0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sn</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rwof_reachable <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> rwof_rel <span class="free">init</span> <span class="free">cond</span> <span class="free">step</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"inres <span class="free">init</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> IP
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">sk</span> <span class="skolem">sn</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">sk</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sk</span> <span class="main">=</span> <span class="var">?f</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="var">?f</span> <span class="bound">i</span><span class="main">,</span> <span class="var">?f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> rwof_rel <span class="free">init</span> <span class="free">cond</span> <span class="free">step</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> P <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">cond</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rwof_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> P <span class="keyword1"><span class="command">have</span></span> SIR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> inres <span class="main">(</span><span class="free">step</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rwof_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> <span class="main">(</span>WHILEI_body <span class="main">(⤜)</span> RETURN <span class="free">I</span> <span class="free">cond</span> <span class="free">step</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="skolem">F</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span><span class="main">∈</span>range <span class="skolem">f</span> <span class="keyword1">then</span> FAIL <span class="keyword1">else</span> gfp <span class="skolem">F</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">≤</span> <span class="skolem">F</span> <span class="skolem">f'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> f'_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span><span class="main">∈</span>range <span class="skolem">f</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> gfp_unfold<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> M <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trimono_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> F_def WHILEI_body_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>      

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> F_def WHILEI_body_def not_nofail_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">using</span></span> SIR
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>      
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  
    <span class="keyword1"><span class="command">from</span></span> gfp_upperbound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f'</span></span> <span class="quoted"><span class="skolem">F</span></span><span class="main">,</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f'</span> <span class="bound">x</span> <span class="main">≤</span> gfp <span class="skolem">F</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_funD<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">0</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gfp <span class="skolem">F</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> FAIL"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> f'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> aux<span class="main">=</span>this

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FAIL <span class="main">≤</span> WHILEIT <span class="free">I</span> <span class="free">cond</span> <span class="free">step</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> WHILET_def WHILEIT_def RECT_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> gfp_eq_flatf_gfp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trimono_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> F_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> aux<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> NF I <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Convenience›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Iterate over range of list›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> range_set_WHILE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> CEQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> F0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">{}</span> <span class="free">s0</span> <span class="main">=</span> <span class="free">s0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">i</span> <span class="bound">X</span><span class="main">.</span> <span class="main">⟦</span><span class="free">l</span><span class="main">≤</span><span class="bound">i</span><span class="main">;</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">u</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="main">(</span><span class="free">F</span> <span class="bound">X</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i'</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="bound">i'</span><span class="main">=</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">r</span><span class="main">=</span><span class="free">F</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">list</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WHILET <span class="free">c</span> <span class="free">f</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">s0</span><span class="main">)</span> 
    <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="bound">r</span><span class="main">=</span><span class="free">F</span> <span class="main">{</span><span class="free">list</span><span class="main">!</span><span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="free">l</span><span class="main">≤</span><span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">u</span><span class="main">}</span> <span class="free">s0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">l</span><span class="main">&lt;</span><span class="free">u</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> WHILET_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> F0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CEQ<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="operator">fo_rule</span> cong refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILET_rule<span class="main"><span class="main">[</span></span>
    <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="free">u</span><span class="main">-</span><span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> I <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">l</span><span class="main">≤</span><span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span><span class="main">≤</span><span class="free">u</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">F</span> <span class="main">{</span><span class="free">list</span><span class="main">!</span><span class="bound">j</span> <span class="main">|</span> <span class="bound">j</span><span class="main">.</span> <span class="free">l</span><span class="main">≤</span><span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span><span class="main">&lt;</span><span class="bound">i</span><span class="main">}</span> <span class="free">s0</span>"</span></span>
    <span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> F0<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="operator">fo_rule</span> cong refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> CEQ<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Fs<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span>
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fun_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> arg_cong<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="free">F</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> CEQ<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Refine_Det">
<div class="head">
<h1>Theory Refine_Det</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deterministic Monad›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Refine_Det
<span class="keyword2"><span class="keyword">imports</span></span> 
  <span class="quoted">"<a href="../../HOL/HOL-Library/Monad_Syntax.html">HOL-Library.Monad_Syntax</a>"</span>
  <span class="quoted">"<a href="RefineG_Assert.html">Generic/RefineG_Assert</a>"</span>
  <span class="quoted">"<a href="RefineG_While.html">Generic/RefineG_While</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Deterministic Result Lattice›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We define the flat complete lattice of deterministic program results:
›</span></span>
<span class="comment1">(* TODO: Library/Quickcheck_Types.thy:flat_complete_lattice provides
  an isomorphic contruction. *)</span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> dres <span class="main">=</span> 
  dSUCCEEDi   <span class="comment1">― ‹No result›</span>
<span class="main">|</span> dFAILi      <span class="comment1">― ‹Failure›</span>
<span class="main">|</span> dRETURN <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>  <span class="comment1">― ‹Regular result›</span>

<span class="keyword1"><span class="command">instantiation</span></span> dres <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">complete_lattice</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">top_dres</span></span> <span class="main">≡</span> dFAILi"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">bot_dres</span></span> <span class="main">≡</span> dSUCCEEDi"</span></span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">sup_dres</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"sup dFAILi <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> dFAILi"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"sup <span class="main"><span class="bound"><span class="entity">_</span></span></span> dFAILi <span class="main">=</span> dFAILi"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"sup <span class="main">(</span>dRETURN <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>dRETURN <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> dRETURN <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">else</span> dFAILi<span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"sup dSUCCEEDi <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span> 
    <span class="quoted"><span class="quoted">"sup <span class="free"><span class="bound"><span class="entity">x</span></span></span> dSUCCEEDi <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> sup_dres_addsimps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"sup <span class="free">x</span> dFAILi <span class="main">=</span> dFAILi"</span></span>
    <span class="quoted"><span class="quoted">"sup <span class="free">x</span> dSUCCEEDi <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">inf_dres</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"inf dFAILi <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"inf <span class="free"><span class="bound"><span class="entity">x</span></span></span> dFAILi <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"inf <span class="main">(</span>dRETURN <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>dRETURN <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> dRETURN <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">else</span> dSUCCEEDi<span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"inf dSUCCEEDi <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> dSUCCEEDi"</span></span> <span class="main">|</span> 
    <span class="quoted"><span class="quoted">"inf <span class="main"><span class="bound"><span class="entity">_</span></span></span> dSUCCEEDi <span class="main">=</span> dSUCCEEDi"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> inf_dres_addsimps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"inf <span class="free">x</span> dSUCCEEDi <span class="main">=</span> dSUCCEEDi"</span></span>
    <span class="quoted"><span class="quoted">"inf dSUCCEEDi <span class="free">x</span> <span class="main">=</span> dSUCCEEDi"</span></span>
    <span class="quoted"><span class="quoted">"inf <span class="free">x</span> dFAILi <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"inf <span class="main">(</span>dRETURN <span class="free">v</span><span class="main">)</span> <span class="free">x</span> <span class="main">≠</span> dFAILi"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span></span></span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">Sup_dres</span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> 
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⊆</span><span class="main">{</span>dSUCCEEDi<span class="main">}</span> <span class="keyword1">then</span> dSUCCEEDi 
    <span class="keyword1">else</span> <span class="keyword1">if</span> dFAILi<span class="main">∈</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">then</span> dFAILi
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span><span class="main">≠</span><span class="bound">b</span> <span class="main">∧</span> dRETURN <span class="bound">a</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span> dRETURN <span class="bound">b</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">then</span> dFAILi
    <span class="keyword1">else</span> dRETURN <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">x</span><span class="main">.</span> dRETURN <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">Inf_dres</span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> 
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⊆</span><span class="main">{</span>dFAILi<span class="main">}</span> <span class="keyword1">then</span> dFAILi 
    <span class="keyword1">else</span> <span class="keyword1">if</span> dSUCCEEDi<span class="main">∈</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">then</span> dSUCCEEDi
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span><span class="main">≠</span><span class="bound">b</span> <span class="main">∧</span> dRETURN <span class="bound">a</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span> dRETURN <span class="bound">b</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">then</span> dSUCCEEDi
    <span class="keyword1">else</span> dRETURN <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">x</span><span class="main">.</span> dRETURN <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>
  
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">less_eq_dres</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">less_eq_dres</span> dSUCCEEDi <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">less_eq_dres</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> dFAILi <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">less_eq_dres</span> <span class="main">(</span>dRETURN <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dRETURN <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">less_eq_dres</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> False"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_dres</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">less_dres</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">::</span><span class="tfree">'a</span> dres<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">≤</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">≤</span><span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> less_eq_dres_split_conv<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">≤</span><span class="free">b</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="keyword1">of</span> 
        <span class="main">(</span>dSUCCEEDi<span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> True 
      <span class="main">|</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span>dFAILi<span class="main">)</span> <span class="main">⇒</span> True
      <span class="main">|</span> <span class="main">(</span>dRETURN <span class="main">(</span><span class="bound">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span><span class="main">,</span> dRETURN <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">a</span><span class="main">=</span><span class="bound">b</span>
      <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False
    <span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> dres.split<span class="main">)</span>
    
  <span class="keyword1"><span class="command">lemma</span></span> inf_dres_split_conv<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"inf <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="keyword1">of</span> 
      <span class="main">(</span>dFAILi<span class="main">,</span><span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">x</span>
    <span class="main">|</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span>dFAILi<span class="main">)</span> <span class="main">⇒</span> <span class="bound">x</span>
    <span class="main">|</span> <span class="main">(</span>dRETURN <span class="bound">a</span><span class="main">,</span> dRETURN <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a</span><span class="main">=</span><span class="bound">b</span> <span class="keyword1">then</span> dRETURN <span class="bound">b</span> <span class="keyword1">else</span> dSUCCEEDi<span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> dSUCCEEDi<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> dres.split<span class="main">)</span>
      
  <span class="keyword1"><span class="command">lemma</span></span> sup_dres_split_conv<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"sup <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="keyword1">of</span> 
      <span class="main">(</span>dSUCCEEDi<span class="main">,</span><span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">x</span>
    <span class="main">|</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span>dSUCCEEDi<span class="main">)</span> <span class="main">⇒</span> <span class="bound">x</span>
    <span class="main">|</span> <span class="main">(</span>dRETURN <span class="bound">a</span><span class="main">,</span> dRETURN <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a</span><span class="main">=</span><span class="bound">b</span> <span class="keyword1">then</span> dRETURN <span class="bound">b</span> <span class="keyword1">else</span> dFAILi<span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> dFAILi<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> dres.split<span class="main">)</span>
      
  <span class="keyword1"><span class="command">instance</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">intro_classes</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> less_eq_dres_split_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> less_dres_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> dres.splits<span class="main">[</span><span class="operator">split</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> inf_dres_split_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> sup_dres_split_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> if_splits<span class="main">[</span><span class="operator">split</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inf_dres_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> A z
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inf_dres_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems  
        <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems  
        <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> the_equality<span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>    
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sup_dres_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> the_equality<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sup_dres_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems  
        <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>2-<span class="main">)</span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems  
        <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> the_equality<span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inf_dres_def top_dres_def<span class="main">)</span>    
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sup_dres_def bot_dres_def<span class="main">)</span>    
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">dSUCCEED</span> <span class="main">≡</span> <span class="main">(</span>bot<span class="main">::</span><span class="tfree">'a</span> dres<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">dFAIL</span> <span class="main">≡</span> <span class="main">(</span>top<span class="main">::</span><span class="tfree">'a</span> dres<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dres_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">type</span></span></span><span class="main">,</span> <span class="operator">case_names</span> dSUCCEED dRETURN dFAIL<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">=</span>dSUCCEED"</span></span> <span class="main">|</span> <span class="free">r</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">=</span>dRETURN <span class="free">r</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">=</span>dFAIL"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> bot_dres_def top_dres_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> dres.case<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">folded</span> top_dres_def bot_dres_def<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> dres_order_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">≤</span>dSUCCEED <span class="main">⟷</span> <span class="free">x</span><span class="main">=</span>dSUCCEED"</span></span> 
  <span class="quoted"><span class="quoted">"dFAIL<span class="main">≤</span><span class="free">x</span> <span class="main">⟷</span> <span class="free">x</span><span class="main">=</span>dFAIL"</span></span>
  <span class="quoted"><span class="quoted">"dRETURN <span class="free">r</span> <span class="main">≠</span> dFAIL"</span></span>
  <span class="quoted"><span class="quoted">"dRETURN <span class="free">r</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"dFAIL <span class="main">≠</span> dRETURN <span class="free">r</span>"</span></span>
  <span class="quoted"><span class="quoted">"dSUCCEED <span class="main">≠</span> dRETURN <span class="free">r</span>"</span></span>
  <span class="quoted"><span class="quoted">"dFAIL<span class="main">≠</span>dSUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"dSUCCEED<span class="main">≠</span>dFAIL"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">=</span><span class="free">y</span> <span class="main">⟹</span> inf <span class="main">(</span>dRETURN <span class="free">x</span><span class="main">)</span> <span class="main">(</span>dRETURN <span class="free">y</span><span class="main">)</span> <span class="main">=</span> dRETURN <span class="free">y</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">≠</span><span class="free">y</span> <span class="main">⟹</span> inf <span class="main">(</span>dRETURN <span class="free">x</span><span class="main">)</span> <span class="main">(</span>dRETURN <span class="free">y</span><span class="main">)</span> <span class="main">=</span> dSUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">=</span><span class="free">y</span> <span class="main">⟹</span> sup <span class="main">(</span>dRETURN <span class="free">x</span><span class="main">)</span> <span class="main">(</span>dRETURN <span class="free">y</span><span class="main">)</span> <span class="main">=</span> dRETURN <span class="free">y</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">≠</span><span class="free">y</span> <span class="main">⟹</span> sup <span class="main">(</span>dRETURN <span class="free">x</span><span class="main">)</span> <span class="main">(</span>dRETURN <span class="free">y</span><span class="main">)</span> <span class="main">=</span> dFAIL"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bot_unique top_unique<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bot_dres_def top_dres_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> dres_Sup_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">⊆</span><span class="main">{</span>dSUCCEED<span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Sup <span class="free">S</span> <span class="main">=</span> dSUCCEED"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"dFAIL<span class="main">∈</span><span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Sup <span class="free">S</span> <span class="main">=</span> dFAIL"</span></span>
  <span class="main">|</span> <span class="free">a</span> <span class="free">b</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">≠</span><span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"dRETURN <span class="free">a</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"dRETURN <span class="free">b</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"dFAIL<span class="main">∉</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"Sup <span class="free">S</span> <span class="main">=</span> dFAIL"</span></span>
  <span class="main">|</span> <span class="free">a</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="main">{</span>dSUCCEED<span class="main">,</span> dRETURN <span class="free">a</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"dRETURN <span class="free">a</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"Sup <span class="free">S</span> <span class="main">=</span> dRETURN <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">⊆</span><span class="main">{</span>dSUCCEED<span class="main">}</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_dres_def bot_dres_def<span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"dFAIL<span class="main">∈</span><span class="free">S</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_dres_def bot_dres_def top_dres_def<span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span><span class="main">≠</span><span class="bound">b</span> <span class="main">∧</span> dRETURN <span class="bound">a</span><span class="main">∈</span><span class="free">S</span> <span class="main">∧</span> dRETURN <span class="bound">b</span><span class="main">∈</span><span class="free">S</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_dres_def bot_dres_def top_dres_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> dRETURN <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> that<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">xa</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_dres_def bot_dres_def top_dres_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dres_Inf_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">⊆</span><span class="main">{</span>dFAIL<span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Inf <span class="free">S</span> <span class="main">=</span> dFAIL"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"dSUCCEED<span class="main">∈</span><span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Inf <span class="free">S</span> <span class="main">=</span> dSUCCEED"</span></span>
  <span class="main">|</span> <span class="free">a</span> <span class="free">b</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">≠</span><span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"dRETURN <span class="free">a</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"dRETURN <span class="free">b</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"dSUCCEED<span class="main">∉</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"Inf <span class="free">S</span> <span class="main">=</span> dSUCCEED"</span></span>
  <span class="main">|</span> <span class="free">a</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="main">{</span>dFAIL<span class="main">,</span> dRETURN <span class="free">a</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"dRETURN <span class="free">a</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"Inf <span class="free">S</span> <span class="main">=</span> dRETURN <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">⊆</span><span class="main">{</span>dFAIL<span class="main">}</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inf_dres_def top_dres_def<span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"dSUCCEED<span class="main">∈</span><span class="free">S</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inf_dres_def bot_dres_def top_dres_def<span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span><span class="main">≠</span><span class="bound">b</span> <span class="main">∧</span> dRETURN <span class="bound">a</span><span class="main">∈</span><span class="free">S</span> <span class="main">∧</span> dRETURN <span class="bound">b</span><span class="main">∈</span><span class="free">S</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inf_dres_def bot_dres_def top_dres_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> dRETURN <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> that<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">xa</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inf_dres_def bot_dres_def top_dres_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dres_chain_eq_res<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_chain <span class="free">M</span> <span class="main">⟹</span> 
    dRETURN <span class="free">r</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">⟹</span> dRETURN <span class="free">s</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">r</span><span class="main">=</span><span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> chainD less_eq_dres.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dres_Sup_chain_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> CHAIN<span class="main">:</span> <span class="quoted"><span class="quoted">"is_chain <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⊆</span> <span class="main">{</span>dSUCCEED<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"Sup <span class="free">M</span> <span class="main">=</span> dSUCCEED"</span></span>
  <span class="main">|</span> <span class="free">r</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⊆</span> <span class="main">{</span>dSUCCEED<span class="main">,</span>dRETURN <span class="free">r</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"dRETURN <span class="free">r</span><span class="main">∈</span><span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"Sup <span class="free">M</span> <span class="main">=</span> dRETURN <span class="free">r</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"dFAIL<span class="main">∈</span><span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"Sup <span class="free">M</span> <span class="main">=</span> dFAIL"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dres_Sup_cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> dres_chain_eq_res<span class="main">[</span><span class="operator">OF</span> CHAIN<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> dres_Inf_chain_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> CHAIN<span class="main">:</span> <span class="quoted"><span class="quoted">"is_chain <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⊆</span> <span class="main">{</span>dFAIL<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"Inf <span class="free">M</span> <span class="main">=</span> dFAIL"</span></span>
  <span class="main">|</span> <span class="free">r</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⊆</span> <span class="main">{</span>dFAIL<span class="main">,</span>dRETURN <span class="free">r</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"dRETURN <span class="free">r</span><span class="main">∈</span><span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"Inf <span class="free">M</span> <span class="main">=</span> dRETURN <span class="free">r</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"dSUCCEED<span class="main">∈</span><span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"Inf <span class="free">M</span> <span class="main">=</span> dSUCCEED"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dres_Inf_cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> dres_chain_eq_res<span class="main">[</span><span class="operator">OF</span> CHAIN<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> dres_internal_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"dSUCCEEDi <span class="main">=</span> dSUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"dFAILi <span class="main">=</span> dFAIL"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> top_dres_def bot_dres_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Monad Operations›</span></span>
<span class="keyword1"><span class="command">function</span></span> <span class="entity">dbind</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">dbind</span> dFAIL <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> dFAIL"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dbind</span> dSUCCEED <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> dSUCCEED"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dbind</span> <span class="main">(</span>dRETURN <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bot_dres_def top_dres_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">adhoc_overloading</span></span>
  Monad_Syntax.bind <span class="quoted">dbind</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"dbind <span class="main">(</span>dRETURN <span class="free">x</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"dbind <span class="main">(</span>dSUCCEEDi<span class="main">)</span> <span class="free">f</span> <span class="main">=</span> dSUCCEEDi"</span></span>
  <span class="quoted"><span class="quoted">"dbind <span class="main">(</span>dFAILi<span class="main">)</span> <span class="free">f</span> <span class="main">=</span> dFAILi"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> dres_monad1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dbind <span class="main">(</span>dRETURN <span class="free">x</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> dres_monad2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dbind <span class="free">M</span> dRETURN <span class="main">=</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> dres_monad3<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dbind <span class="main">(</span>dbind <span class="free">M</span> <span class="free">f</span><span class="main">)</span> <span class="free">g</span> <span class="main">=</span> dbind <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> dbind <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> dres_monad_laws <span class="main">=</span> dres_monad1 dres_monad2 dres_monad3

<span class="keyword1"><span class="command">lemma</span></span> dbind_mono<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">M</span> <span class="main">≤</span> <span class="free">M'</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> dRETURN <span class="bound">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">f'</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> dbind <span class="free">M</span> <span class="free">f</span> <span class="main">≤</span> dbind <span class="free">M'</span> <span class="free">f'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> flat_ge <span class="free">M</span> <span class="free">M'</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> flat_ge <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> flat_ge <span class="main">(</span>dbind <span class="free">M</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>dbind <span class="free">M'</span> <span class="free">f'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">M</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">M'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">M</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flat_ord_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">M'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> dbind_mono1<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono dbind"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monoI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dbind_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> dbind_mono2<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>dbind <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monoI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dbind_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_funD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dr_mono_bind<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> MA<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> MB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> mono <span class="main">(</span><span class="free">B</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="main">λ</span><span class="bound">F</span> <span class="bound">s</span><span class="main">.</span> dbind <span class="main">(</span><span class="free">A</span> <span class="bound">F</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">B</span> <span class="bound">s</span> <span class="bound">F</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monoI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dbind_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> monoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MA<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> le_funD<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> monoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MB<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> le_funD<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> dr_mono_bind'<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="main">λ</span><span class="bound">F</span> <span class="bound">s</span><span class="main">.</span> dbind <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dbind_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_funD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* TODO: Replace by monotonicity prover! *)</span>
<span class="keyword1"><span class="command">lemmas</span></span> dr_mono <span class="main">=</span> mono_if dr_mono_bind dr_mono_bind' mono_const mono_id

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"dbind dSUCCEED <span class="free">f</span> <span class="main">=</span> dSUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"dbind dFAIL <span class="free">f</span> <span class="main">=</span> dFAIL"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">dASSERT</span> <span class="main">≡</span> iASSERT dRETURN"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">dASSUME</span> <span class="main">≡</span> iASSUME dRETURN"</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> dres_assert<span class="main">:</span> generic_Assert <span class="quoted">dbind</span> <span class="quoted">dRETURN</span> <span class="quoted">dASSERT</span> <span class="quoted">dASSUME</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dASSERT_def dASSUME_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">dWHILEIT</span> <span class="main">≡</span> iWHILEIT dbind dRETURN"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">dWHILEI</span> <span class="main">≡</span> iWHILEI dbind dRETURN"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">dWHILET</span> <span class="main">≡</span> iWHILET dbind dRETURN"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">dWHILE</span> <span class="main">≡</span> iWHILE dbind dRETURN"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> dres_while<span class="main">:</span> generic_WHILE <span class="quoted">dbind</span> <span class="quoted">dRETURN</span>
  <span class="quoted">dWHILEIT</span> <span class="quoted">dWHILEI</span> <span class="quoted">dWHILET</span> <span class="quoted">dWHILE</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dWHILEIT_def dWHILEI_def dWHILET_def dWHILE_def<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_mono</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span> 
  dres_while.WHILEIT_unfold
  dres_while.WHILEI_unfold
  dres_while.WHILET_unfold
  dres_while.WHILE_unfold


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Syntactic criteria to prove <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s ≠ dSUCCEED›</span></span></span></span>
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> dres_ne_bot_basic<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"dFAIL <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> dRETURN <span class="bound">x</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span> <span class="bound">f</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">m</span><span class="main">≠</span>dSUCCEED<span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≠</span> dSUCCEED <span class="main">⟧</span> <span class="main">⟹</span> dbind <span class="bound">m</span> <span class="bound">f</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Φ</span><span class="main">.</span> dASSERT <span class="bound">Φ</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span> <span class="bound">m1</span> <span class="bound">m2</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">m1</span><span class="main">≠</span>dSUCCEED<span class="main">;</span> <span class="bound">m2</span><span class="main">≠</span>dSUCCEED <span class="main">⟧</span> <span class="main">⟹</span> If <span class="bound">b</span> <span class="bound">m1</span> <span class="bound">m2</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">f</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">≠</span>dSUCCEED <span class="main">⟧</span> <span class="main">⟹</span> Let <span class="bound">x</span> <span class="bound">f</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">g</span> <span class="bound">p</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x1</span> <span class="bound">x2</span><span class="main">.</span> <span class="bound">g</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="main">≠</span> dSUCCEED <span class="main">⟧</span> <span class="main">⟹</span> case_prod <span class="bound">g</span> <span class="bound">p</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">fn</span> <span class="bound">fs</span> <span class="bound">x</span><span class="main">.</span> 
    <span class="main">⟦</span> <span class="bound">fn</span><span class="main">≠</span>dSUCCEED<span class="main">;</span> <span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">fs</span> <span class="bound">v</span> <span class="main">≠</span> dSUCCEED <span class="main">⟧</span> <span class="main">⟹</span> case_option <span class="bound">fn</span> <span class="bound">fs</span> <span class="bound">x</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">fn</span> <span class="bound">fc</span> <span class="bound">x</span><span class="main">.</span> 
    <span class="main">⟦</span> <span class="bound">fn</span><span class="main">≠</span>dSUCCEED<span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">fc</span> <span class="bound">x</span> <span class="bound">xs</span> <span class="main">≠</span> dSUCCEED <span class="main">⟧</span> <span class="main">⟹</span> case_list <span class="bound">fn</span> <span class="bound">fc</span> <span class="bound">x</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split option.split list.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">m</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">Φ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> dres_ne_bot_RECT<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≠</span> dSUCCEED <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">B</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RECT <span class="free">B</span> <span class="free">x</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RECT_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">split</span> if_split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> impI conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> flatf_fp_induct_pointwise<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pre<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">B</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">top</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> post<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="bound">m</span><span class="main">.</span> <span class="bound">m</span><span class="main">≠</span>dSUCCEED"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trimonoD A<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> dres_ne_bot_dWHILEIT<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≠</span> dSUCCEED"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dWHILEIT <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s</span> <span class="main">≠</span> dSUCCEED"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> dWHILEIT_def iWHILEIT_def WHILEI_body_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> dres_ne_bot_dWHILET<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≠</span> dSUCCEED"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dWHILET <span class="free">b</span> <span class="free">f</span> <span class="free">s</span> <span class="main">≠</span> dSUCCEED"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> dWHILET_def iWHILET_def iWHILEIT_def WHILEI_body_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Refine_Pfun">
<div class="head">
<h1>Theory Refine_Pfun</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Partial Function Package Setup›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Refine_Pfun
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Refine_Basic.html">Refine_Basic</a> <a href="Refine_Det.html">Refine_Det</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this theory, we set up the partial function package to be used 
  with our refinement framework.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Nondeterministic Result Monad›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> nrec<span class="main">:</span>
  partial_function_definitions <span class="quoted"><span class="quoted">"<span class="main">(≤)</span>"</span></span> <span class="quoted"><span class="quoted">"Sup<span class="main">::</span><span class="tfree">'a</span> nres set <span class="main">⇒</span> <span class="tfree">'a</span> nres"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_upper Sup_least<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nrec_admissible<span class="main">:</span> <span class="quoted"><span class="quoted">"nrec.admissible <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> nres<span class="main">)</span><span class="main">.</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">x0</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x0</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">P</span> <span class="bound">x0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccpo.admissibleI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> fun_lub_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*thm fixp_induct_option

lemma fixp_induct_nrec:
  fixes F :: "'c ⇒ 'c" and
    U :: "'c ⇒ 'b ⇒ 'a nres" and
    C :: "('b ⇒ 'a nres) ⇒ 'c" and
    P :: "'b ⇒ 'a ⇒ bool"
  assumes mono: "⋀x. nrec.mono_body (λf. U (F (C f)) x)"                       
  assumes eq: "f ≡ C (nrec.fixp_fun (λf. U (F (C f))))"
  assumes inverse2: "⋀f. U (C f) = f"
  assumes step: "⋀f x z. (⋀x. U f x = U f x; Q x z) ⟹ Q (U (F (C f))) z"
 (* assumes defined: "RETURN y ≤ U (C f) x"*)
  assumes Q: "⋀x z. Q x z ⟷ z = U f x ∧ U f x ≤ SPEC (P x)"
  shows "Q x z" oops
  (*using step defined
    nrec.fixp_induct_uc[of U F C, OF mono eq inverse2 nrec_admissible]
  unfolding Q oops (*
  by blast*)*)

lemma fixp_induct_nrec':
  fixes F :: "'c ⇒ 'c" and
    U :: "'c ⇒ 'b ⇒ 'a nres" and
    C :: "('b ⇒ 'a nres) ⇒ 'c" and
    P :: "'b ⇒ 'a ⇒ bool"
  assumes mono: "⋀x. nrec_mono (λf. U (F (C f)) x)"
  assumes eq: "f ≡ C (nrec_ffix (λf. U (F (C f))))"
  assumes inverse2: "⋀f. U (C f) = f"
  assumes step: "⋀f x0. (⋀x0. U f x0 ≤ SPEC (P x0)) 
    ⟹ U (F f) x0 ≤ SPEC (P x0)"
  assumes defined: "RETURN y ≤ U f x"
  shows "P x y"
proof -
  note defined
  also have "∀x0. U f x0 ≤ SPEC (P x0)"
    apply (rule nrec.fixp_induct_uc[of U F C, OF mono eq inverse2 
      nrec_admissible])
    using step by blast
  hence "U f x ≤ SPEC (P x)" by simp
  finally show "P x y" by auto
qed
*)</span>    
<span class="comment1">(* TODO/FIXME: Induction rule seems not to work here ! 
    Function package expects induction rule where conclusion is a binary 
    predicate as free variable.
*)</span>

<span class="keyword1"><span class="command">declaration</span></span> <span class="quoted">‹<span class="entity">Partial_Function.init</span> <span class="inner_quoted">"nrec"</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">nrec.fixp_fun</span><span class="antiquote">}</span></span>
  <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">nrec.mono_body</span><span class="antiquote">}</span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> nrec.fixp_rule_uc<span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> nrec.fixp_induct_uc<span class="antiquote">}</span></span></span>
  <span class="comment1">(*SOME @{thm fixp_induct_nrec}*)</span> <span class="main">(</span>NONE<span class="main">)</span>›</span>

<span class="keyword1"><span class="command">lemma</span></span> bind_mono_pfun<span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">C</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> nres<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> nres<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> monotone <span class="main">(</span>fun_ord <span class="main">(≤)</span><span class="main">)</span> <span class="main">(≤)</span> <span class="free">B</span><span class="main">;</span> 
    <span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> monotone <span class="main">(</span>fun_ord <span class="main">(≤)</span><span class="main">)</span> <span class="main">(≤)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="free">C</span> <span class="bound">y</span> <span class="bound">f</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> 
     monotone <span class="main">(</span>fun_ord <span class="main">(≤)</span><span class="main">)</span> <span class="main">(≤)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> bind <span class="main">(</span><span class="free">B</span> <span class="bound">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">C</span> <span class="bound">y</span> <span class="bound">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Refine_Basic.bind_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> monotoneD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Deterministic Result Monad›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> drec<span class="main">:</span>
  partial_function_definitions <span class="quoted"><span class="quoted">"<span class="main">(≤)</span>"</span></span> <span class="quoted"><span class="quoted">"Sup<span class="main">::</span><span class="tfree">'a</span> dres set <span class="main">⇒</span> <span class="tfree">'a</span> dres"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_upper Sup_least<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> drec_admissible<span class="main">:</span> <span class="quoted"><span class="quoted">"drec.admissible <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> dres<span class="main">)</span><span class="main">.</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟶</span> 
    <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span> <span class="main">≠</span> dFAIL <span class="main">∧</span> 
    <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">=</span> dRETURN <span class="bound">r</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fun_ord <span class="main">(</span><span class="main">(≤)</span> <span class="main">::</span><span class="tfree">'b</span> dres <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="main">(≤)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> fun_ord_def le_fun_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">f</span><span class="main">∈</span><span class="bound">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">`</span><span class="bound">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccpo.admissibleI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> fun_lub_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> point_chainI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> dres_Sup_chain_cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> SUP_bot_conv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> SUP_bot_conv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declaration</span></span> <span class="quoted">‹<span class="entity">Partial_Function.init</span> <span class="inner_quoted">"drec"</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">drec.fixp_fun</span><span class="antiquote">}</span></span>
  <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">drec.mono_body</span><span class="antiquote">}</span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> drec.fixp_rule_uc<span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> drec.fixp_induct_uc<span class="antiquote">}</span></span></span> 
  NONE›</span>

<span class="keyword1"><span class="command">lemma</span></span> drec_bind_mono_pfun<span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">C</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> dres<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> dres<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> monotone <span class="main">(</span>fun_ord <span class="main">(≤)</span><span class="main">)</span> <span class="main">(≤)</span> <span class="free">B</span><span class="main">;</span> 
    <span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> monotone <span class="main">(</span>fun_ord <span class="main">(≤)</span><span class="main">)</span> <span class="main">(≤)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="free">C</span> <span class="bound">y</span> <span class="bound">f</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> 
     monotone <span class="main">(</span>fun_ord <span class="main">(≤)</span><span class="main">)</span> <span class="main">(≤)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> dbind <span class="main">(</span><span class="free">B</span> <span class="bound">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">C</span> <span class="bound">y</span> <span class="bound">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dbind_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> monotoneD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Refine_Transfer">
<div class="head">
<h1>Theory Refine_Transfer</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Transfer Setup›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Refine_Transfer
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Refine_Basic.html">Refine_Basic</a>
  <a href="Refine_While.html">Refine_While</a>
  <a href="Refine_Det.html">Refine_Det</a> 
  <span class="quoted">"<a href="RefineG_Transfer.html">Generic/RefineG_Transfer</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transfer to Deterministic Result Lattice›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  TODO: Once lattice and ccpo are connected, also transfer to option monad, that
  is a ccpo, but no complete lattice!
›</span></span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Connecting Deterministic and Non-Deterministic Result Lattices›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">nres_of</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span>
  dSUCCEEDi <span class="main">⇒</span> SUCCEED
<span class="main">|</span> dFAILi <span class="main">⇒</span> FAIL
<span class="main">|</span> dRETURN <span class="bound">x</span> <span class="main">⇒</span> RETURN <span class="bound">x</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nres_of_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nres_of dSUCCEED <span class="main">=</span> SUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"nres_of dFAIL <span class="main">=</span> FAIL"</span></span>
  <span class="quoted"><span class="quoted">"nres_of <span class="main">(</span>dRETURN <span class="free">x</span><span class="main">)</span> <span class="main">=</span> RETURN <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">unfolding</span></span> nres_of_def bot_dres_def top_dres_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> dres_internal_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nres_of_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"mono nres_of"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> nres_transfer<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nres_of dSUCCEED <span class="main">=</span> SUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"nres_of dFAIL <span class="main">=</span> FAIL"</span></span>
  <span class="quoted"><span class="quoted">"nres_of <span class="free">a</span> <span class="main">≤</span> nres_of <span class="free">b</span> <span class="main">⟷</span> <span class="free">a</span><span class="main">≤</span><span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"nres_of <span class="free">a</span> <span class="main">&lt;</span> nres_of <span class="free">b</span> <span class="main">⟷</span> <span class="free">a</span><span class="main">&lt;</span><span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"is_chain <span class="free">A</span> <span class="main">⟹</span> nres_of <span class="main">(</span>Sup <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Sup <span class="main">(</span>nres_of<span class="main">`</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"is_chain <span class="free">A</span> <span class="main">⟹</span> nres_of <span class="main">(</span>Inf <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Inf <span class="main">(</span>nres_of<span class="main">`</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">b</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_le<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">b</span></span></span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> dres_Sup_chain_cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">=</span><span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">=</span><span class="main">{</span>dSUCCEED<span class="main">}</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">=</span><span class="main">{</span>dRETURN <span class="improper">r</span><span class="main">}</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">=</span><span class="main">{</span>dSUCCEED<span class="main">,</span>dRETURN <span class="improper">r</span><span class="main">}</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> imageI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">nres_of</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> dres_Inf_chain_cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">=</span><span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">=</span><span class="main">{</span>dFAIL<span class="main">}</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">=</span><span class="main">{</span>dRETURN <span class="improper">r</span><span class="main">}</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">=</span><span class="main">{</span>dFAIL<span class="main">,</span>dRETURN <span class="improper">r</span><span class="main">}</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> imageI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">nres_of</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bot_Inf <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> nres_correctD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nres_of <span class="free">S</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">=</span>dRETURN <span class="free">x</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">≠</span>dFAIL"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">S</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Transfer Theorems Setup›</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> dres<span class="main">:</span> dist_transfer <span class="quoted">nres_of</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nres_transfer<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> nres_of_transfer<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nres_of <span class="free">x</span> <span class="main">≤</span> nres_of <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> det_FAIL<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nres_of <span class="main">(</span>dFAIL<span class="main">)</span> <span class="main">≤</span> FAIL"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> det_SUCCEED<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nres_of <span class="main">(</span>dSUCCEED<span class="main">)</span> <span class="main">≤</span> SUCCEED"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> det_SPEC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="free">x</span> <span class="main">⟹</span> nres_of <span class="main">(</span>dRETURN <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> det_RETURN<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"nres_of <span class="main">(</span>dRETURN <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> RETURN <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> det_bind<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nres_of <span class="free">m</span> <span class="main">≤</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> nres_of <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">F</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nres_of <span class="main">(</span>dbind <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="main">≤</span> bind <span class="free">M</span> <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">interpretation</span></span> det_assert<span class="main">:</span> transfer_generic_Assert_remove 
  <span class="quoted">bind</span> <span class="quoted">RETURN</span> <span class="quoted">ASSERT</span> <span class="quoted">ASSUME</span>
  <span class="quoted">nres_of</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">interpretation</span></span> det_while<span class="main">:</span> transfer_WHILE
  <span class="quoted">dbind</span> <span class="quoted">dRETURN</span> <span class="quoted">dWHILEIT</span> <span class="quoted">dWHILEI</span> <span class="quoted">dWHILET</span> <span class="quoted">dWHILE</span> 
  <span class="quoted">bind</span> <span class="quoted">RETURN</span> <span class="quoted">WHILEIT</span> <span class="quoted">WHILEI</span> <span class="quoted">WHILET</span> <span class="quoted">WHILE</span> <span class="quoted">nres_of</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> det_bind<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*
interpretation det_foreach: 
  transfer_FOREACH nres_of dRETURN dbind "case_dres True True"
  apply unfold_locales
  apply (blast intro: det_bind)
  apply simp
  apply (case_tac m)
  apply simp_all
  done
*)</span>

<span class="comment1">(* Done generally in RefineG_Transfer
lemma det_rec_list[refine_transfer]:
  assumes FN: "⋀s. RETURN (fn s) ≤ (fn' s)"
  assumes FC: "⋀x l rec rec' s. ⟦ ⋀s. RETURN (rec s) ≤ (rec' s) ⟧ 
    ⟹ RETURN (fc x l rec s) ≤ fc' x l rec' s"
  shows "RETURN (rec_list fn fc l s) ≤ rec_list fn' fc' l s"
  apply (induct l arbitrary: s)
  apply (simp add: FN)
  apply (simp add: FC)
  done

lemma det_rec_nat[refine_transfer]:
  assumes FN: "⋀s. RETURN (fn s) ≤ (fn' s)"
  assumes FC: "⋀n rec rec' s. ⟦ ⋀s. RETURN (rec s) ≤ (rec' s) ⟧ 
    ⟹ RETURN (fc x l rec s) ≤ fc' x l rec' s"
  shows "RETURN (rec_list fn fc l s) ≤ rec_list fn' fc' l s"
  apply (induct l arbitrary: s)
  apply (simp add: FN)
  apply (simp add: FC)
  done
*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transfer to Plain Function›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> plain<span class="main">:</span> transfer <span class="quoted">RETURN</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> plain_RETURN<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"RETURN <span class="free">a</span> <span class="main">≤</span> RETURN <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> plain_bind<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>RETURN <span class="free">x</span> <span class="main">≤</span> <span class="free">M</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> RETURN <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">F</span> <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> RETURN <span class="main">(</span>Let <span class="free">x</span> <span class="free">f</span><span class="main">)</span> <span class="main">≤</span> bind <span class="free">M</span> <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span><span class="operator">OF</span> bind_mono<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">interpretation</span></span> plain_assert<span class="main">:</span> transfer_generic_Assert_remove 
  <span class="quoted">bind</span> <span class="quoted">RETURN</span> <span class="quoted">ASSERT</span> <span class="quoted">ASSUME</span>
  <span class="quoted">RETURN</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="comment1">(*
interpretation plain: transfer_FOREACH RETURN "(λx. x)" Let "(λx. x)"
  apply (unfold_locales)
  apply (erule plain_bind, assumption)
  apply simp
  apply simp
  done
*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Total correctness in deterministic monad›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Sometimes one cannot extract total correct programs to executable plain 
  Isabelle functions, for example, if the total correctness only holds for
  certain preconditions. In those cases, one can still show
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>RETURN (the_res S) ≤ S'›</span></span></span></span>. Here, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>the_res›</span></span></span></span> extracts
  the result from a deterministic monad. As <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>the_res›</span></span></span></span> is executable,
  the above shows that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(the_res S)›</span></span></span></span> is always a correct result.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">the_res</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">the_res</span> <span class="main">(</span>dRETURN <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemma converts a proof-obligation
  with result extraction to a transfer proof obligation,
  and a proof obligation that the program yields not bottom.

  Note that this rule has to be applied manually, as, otherwise,
  it would interfere with the default setup, that tries to generate a
  plain function.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> the_resI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nres_of <span class="free">S</span> <span class="main">≤</span> <span class="free">S'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="main">(</span>the_res <span class="free">S</span><span class="main">)</span> <span class="main">≤</span> <span class="free">S'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">S</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following rule sets up a refinement goal, a transfer goal, and a 
  final optimization goal.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">detTAG</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> detTAGI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> detTAG <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> detTAG_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> autoref_detI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="free">c</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> detTAG <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RETURN <span class="free">d</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> nres_rel_def detTAG_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Relator-Based Transfer›</span></span>

<span class="keyword1"><span class="command">definition</span></span> dres_nres_rel_internal_def<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">dres_nres_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">.</span> nres_of <span class="bound">c</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">a</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dres_nres_rel_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>dres_nres_rel <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">.</span> nres_of <span class="bound">c</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R</span> <span class="bound">a</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dres_nres_rel_internal_def relAPP_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dres_nres_relI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nres_of <span class="free">c</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>dres_nres_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dres_nres_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dres_nres_relD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>dres_nres_rel <span class="main">⟹</span> nres_of <span class="free">c</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dres_nres_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dres_nres_rel_as_br_conv<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>dres_nres_rel <span class="main">=</span> br nres_of <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="keyword1">O</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dres_nres_rel_def br_def nres_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">definition</span></span> plain_nres_rel_internal_def<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">plain_nres_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">.</span> RETURN <span class="bound">c</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">a</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> plain_nres_rel_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>plain_nres_rel <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">.</span> RETURN <span class="bound">c</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R</span> <span class="bound">a</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plain_nres_rel_internal_def relAPP_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> plain_nres_relI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"RETURN <span class="free">c</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>plain_nres_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plain_nres_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> plain_nres_relD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>plain_nres_rel <span class="main">⟹</span> RETURN <span class="free">c</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plain_nres_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> plain_nres_rel_as_br_conv<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>plain_nres_rel <span class="main">=</span> br RETURN <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="keyword1">O</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> plain_nres_rel_def br_def nres_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* TODO: Refine_Transfer could be expressed also just as a 
    parametricity based transfer, and based on the same infrastructure
    as autoref *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Post-Simplification Setup›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> dres_unit_simps<span class="main">[</span><span class="operator">refine_transfer_post_simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"dbind <span class="main">(</span>dRETURN <span class="main">(</span><span class="free">u</span><span class="main">::</span>unit<span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span> <span class="main">()</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Let_dRETURN_simp<span class="main">[</span><span class="operator">refine_transfer_post_simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Let <span class="free">m</span> dRETURN <span class="main">=</span> dRETURN <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_transfer_post_simp</span><span class="main">]</span> <span class="main">=</span> dres_monad_laws


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Refine_Foreach">
<div class="head">
<h1>Theory Refine_Foreach</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Foreach Loops›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Refine_Foreach
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="Refine_While.html">Refine_While</a> 
  <a href="Refine_Pfun.html">Refine_Pfun</a> 
  <a href="Refine_Transfer.html">Refine_Transfer</a> 
  <a href="Refine_Heuristics.html">Refine_Heuristics</a>
  <span class="comment1">(*"../Collections/Lib/SetIterator"
  "../Collections/Lib/Proper_Iterator"*)</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A common pattern for loop usage is iteration over the elements of a set.
  This theory provides the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>FOREACH›</span></span></span></span>-combinator, that iterates over 
  each element of a set.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Auxilliary Lemmas›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemma is commonly used when reasoning about iterator
  invariants.
  It helps converting the set of elements that remain to be iterated over to
  the set of elements already iterated over.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> it_step_insert_iff<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">it</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span><span class="free">it</span> <span class="main">⟹</span> <span class="free">S</span><span class="main">-</span><span class="main">(</span><span class="free">it</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="free">it</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Foreach-loops come in different versions, depending on whether they have an 
  annotated invariant (I), a termination condition (C), and an order (O).

  Note that asserting that the set is finite is not necessary to guarantee
  termination. However, we currently provide only iteration over finite sets,
  as this also matches the ICF concept of iterators.
›</span></span>
   
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">FOREACH_body</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">σ</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> hd <span class="bound">xs</span><span class="main">;</span> <span class="bound">σ'</span><span class="main">←</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">;</span> RETURN <span class="main">(</span>tl <span class="bound">xs</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">FOREACH_cond</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">FOREACH_cond</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">.</span> <span class="bound">xs</span><span class="main">≠</span><span class="main">[]</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">σ</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Foreach with continuation condition, order and annotated invariant:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">FOREACHoci</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">FOREACH<span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>C</sub>⇗</span>_<span class="keyword1">,</span>_<span class="keyword1">⇖</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">FOREACHoci</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ0</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  ASSERT <span class="main">(</span>finite <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">;</span>
  <span class="bound">xs</span> <span class="main">←</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> distinct <span class="bound">xs</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> set <span class="bound">xs</span> <span class="main">∧</span> sorted_wrt <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">xs</span><span class="main">)</span><span class="main">;</span>
  <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span> <span class="main">←</span> WHILEIT 
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">it</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">xs'</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">=</span> <span class="bound">xs'</span> <span class="main">@</span> <span class="bound">it</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="main">(</span>set <span class="bound">it</span><span class="main">)</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">(</span>FOREACH_cond <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>FOREACH_body <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">σ0</span></span></span><span class="main">)</span><span class="main">;</span> 
  RETURN <span class="bound">σ</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Foreach with continuation condition and annotated invariant:›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">FOREACHci</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">FOREACH<span class="hidden">⇩</span><sub>C</sub>⇗</span>_<span class="keyword1">⇖</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">FOREACHci</span> <span class="main">≡</span> FOREACHoci <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Foreach with continuation condition:›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">FOREACHc</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">FOREACH<span class="hidden">⇩</span><sub>C</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">FOREACHc</span> <span class="main">≡</span> FOREACHci <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Foreach with annotated invariant:›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">FOREACHi</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">FOREACH⇗</span>_<span class="keyword1">⇖</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">FOREACHi</span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> FOREACHci <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Foreach with annotated invariant and order:›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">FOREACHoi</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">FOREACH<span class="hidden">⇩</span><sub>O</sub>⇗</span>_<span class="keyword1">,</span>_<span class="keyword1">⇖</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">FOREACHoi</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> FOREACHoci <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Basic foreach›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">FOREACH</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> FOREACHc <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> FOREACH_to_oci_unfold
  <span class="main">=</span> FOREACHci_def FOREACHc_def FOREACHi_def FOREACHoi_def FOREACH_def

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof Rules›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHoci_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FIN<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">S</span> <span class="free">σ0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IP<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">c</span> <span class="bound">σ</span><span class="main">;</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="free">I</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="bound">it</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span>
                <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span> <span class="main">-</span> <span class="bound">it</span><span class="main">.</span> <span class="free">R</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">I</span> <span class="main">(</span><span class="bound">it</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> II1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="main">{}</span> <span class="bound">σ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> II2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">it</span><span class="main">≠</span><span class="main">{}</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="free">I</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">¬</span><span class="free">c</span> <span class="bound">σ</span><span class="main">;</span>
                         <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span> <span class="main">-</span> <span class="bound">it</span><span class="main">.</span> <span class="free">R</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHoci <span class="free">R</span> <span class="free">I</span> <span class="free">S</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> SPEC <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHoci_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FIN<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> length <span class="bound">xs</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> I0<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> I0<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACH_body_def FOREACH_cond_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> xs'' s xs' σ xs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x s xs' σ xs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs'</span> <span class="skolem">σ</span> <span class="skolem">xs</span>

  <span class="keyword3"><span class="command">assume</span></span> I_xs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">(</span>set <span class="skolem">xs'</span><span class="main">)</span> <span class="skolem">σ</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> sorted_xs_xs'<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">xs'</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs'</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">∩</span> set <span class="skolem">xs'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> S_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> set <span class="skolem">xs</span> <span class="main">∪</span> set <span class="skolem">xs'</span>"</span></span> 

  <span class="keyword1"><span class="command">from</span></span> S_eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs'</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> dist S_eq <span class="keyword1"><span class="command">have</span></span> S_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">-</span> set <span class="skolem">xs'</span> <span class="main">=</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs'</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">xs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> x_in_xs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">xs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x_nin_xs''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set <span class="skolem">xs''</span>"</span></span> 
       <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="skolem">xs'</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> xs'_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  
    <span class="keyword1"><span class="command">from</span></span> IP<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">σ</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs'</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="skolem">σ</span>›</span></span> x_in_xs' <span class="quoted"><span class="quoted">‹set <span class="skolem">xs'</span> <span class="main">⊆</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="main">(</span>set <span class="skolem">xs'</span><span class="main">)</span> <span class="skolem">σ</span>›</span></span><span class="main">]</span> x_nin_xs''
         sorted_xs_xs' S_diff
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>hd <span class="skolem">xs'</span><span class="main">)</span> <span class="skolem">σ</span> <span class="main">≤</span> SPEC
            <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">xs'a</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">xs'</span> <span class="main">=</span> <span class="bound">xs'a</span> <span class="main">@</span> tl <span class="skolem">xs'</span><span class="main">)</span> <span class="main">∧</span>
                 <span class="free">I</span> <span class="main">(</span>set <span class="main">(</span>tl <span class="skolem">xs'</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xs'_eq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_wrt_append<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span><span class="free">c</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">σ</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="main">(</span>set <span class="skolem">xs'</span><span class="main">)</span> <span class="skolem">σ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> II1<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> xs'_neq_nil <span class="main">=</span> this
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs'</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="main">¬</span> <span class="free">c</span> <span class="skolem">σ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">c</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 
      <span class="keyword1"><span class="command">from</span></span> II2 <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs'</span>"</span></span> <span class="quoted"><span class="skolem">σ</span></span><span class="main">]</span> S_diff sorted_xs_xs'
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">σ</span>"</span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xs'_neq_nil S_eq <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">c</span> <span class="skolem">σ</span>›</span></span> I_xs'<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_wrt_append<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHoi_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FIN<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">S</span> <span class="free">σ0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IP<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="free">I</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="bound">it</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span>
                <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span> <span class="main">-</span> <span class="bound">it</span><span class="main">.</span> <span class="free">R</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">I</span> <span class="main">(</span><span class="bound">it</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> II1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="main">{}</span> <span class="bound">σ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHoi <span class="free">R</span> <span class="free">I</span> <span class="free">S</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> SPEC <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHoi_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHoci_rule<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHci_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FIN<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">S</span> <span class="free">σ0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IP<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="free">I</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">I</span> <span class="main">(</span><span class="bound">it</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> II1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="main">{}</span> <span class="bound">σ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> II2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">it</span><span class="main">≠</span><span class="main">{}</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="free">I</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">¬</span><span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHci <span class="free">I</span> <span class="free">S</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> SPEC <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHci_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHoci_rule<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement:›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Refinement rule using a coupling invariant over sets of remaining
  items and the state.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHoci_refine_genR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> <span class="main">⇒</span> <span class="tfree">'Sa</span>"</span></span> <span class="comment1">― ‹Abstraction mapping of elements›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> set"</span></span> <span class="comment1">― ‹Concrete set›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Sa</span> set"</span></span> <span class="comment1">― ‹Abstract set›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ0'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'σa</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'S</span> set <span class="main">×</span> <span class="tfree">'σ</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'Sa</span> set <span class="main">×</span> <span class="tfree">'σa</span><span class="main">)</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">α</span> <span class="free">S</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> REFS<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">=</span> <span class="free">α</span><span class="main">`</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RR_OK<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">;</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">;</span> <span class="free">RR</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">RR'</span> <span class="main">(</span><span class="free">α</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">α</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">S</span><span class="main">,</span><span class="free">σ0</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">α</span><span class="main">`</span><span class="free">S</span><span class="main">,</span><span class="free">σ0'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> 
    <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">-</span><span class="bound">it</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="bound">it</span><span class="main">.</span> <span class="free">RR</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S'</span><span class="main">-</span><span class="bound">it'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="bound">it'</span><span class="main">.</span> <span class="free">RR'</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span>
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">it</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">it'</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟷</span> <span class="free">c'</span> <span class="bound">σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFPHI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span>
    <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">-</span><span class="bound">it</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="bound">it</span><span class="main">.</span> <span class="free">RR</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S'</span><span class="main">-</span><span class="bound">it'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="bound">it'</span><span class="main">.</span> <span class="free">RR'</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span>
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">it</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">it'</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFSTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">x'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span>
    <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span>
    <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">-</span><span class="bound">it</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="bound">it</span><span class="main">.</span> <span class="free">RR</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S'</span><span class="main">-</span><span class="bound">it'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="bound">it'</span><span class="main">.</span> <span class="free">RR'</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span>
    <span class="bound">x'</span><span class="main">=</span><span class="free">α</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">it</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">it'</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span>
    <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="bound">it</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">.</span> <span class="free">RR</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span>
    <span class="bound">x'</span><span class="main">∈</span><span class="bound">it'</span><span class="main">;</span> <span class="main">∀</span><span class="bound">y'</span><span class="main">∈</span><span class="bound">it'</span><span class="main">-</span><span class="main">{</span><span class="bound">x'</span><span class="main">}</span><span class="main">.</span> <span class="free">RR'</span> <span class="bound">x'</span> <span class="bound">y'</span><span class="main">;</span>
    <span class="free">c</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c'</span> <span class="bound">σ'</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> 
    <span class="main">≤</span> <span class="main">⇓</span><span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">it</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">it'</span><span class="main">-</span><span class="main">{</span><span class="bound">x'</span><span class="main">}</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF_R_DONE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">Φ</span> <span class="main">{}</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">Φ'</span> <span class="main">{}</span> <span class="bound">σ'</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF_R_BRK<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span>
    <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">-</span><span class="bound">it</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="bound">it</span><span class="main">.</span> <span class="free">RR</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S'</span><span class="main">-</span><span class="bound">it'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="bound">it'</span><span class="main">.</span> <span class="free">RR'</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span>
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">it</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">it'</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span>
    <span class="bound">it</span><span class="main">≠</span><span class="main">{}</span><span class="main">;</span> <span class="bound">it'</span><span class="main">≠</span><span class="main">{}</span><span class="main">;</span>
    <span class="main">¬</span><span class="free">c</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">¬</span><span class="free">c'</span> <span class="bound">σ'</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHoci <span class="free">RR</span> <span class="free">Φ</span> <span class="free">S</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R'</span> <span class="main">(</span>FOREACHoci <span class="free">RR'</span> <span class="free">Φ'</span> <span class="free">S'</span> <span class="free">c'</span> <span class="free">f'</span> <span class="free">σ0'</span><span class="main">)</span>"</span></span>
  <span class="comment1">(* TODO: Clean up this mess !!! *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHoci_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> WHILEIT_refine_genR<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
    R'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">xs'</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span> 
      <span class="bound">xs'</span><span class="main">=</span>map <span class="free">α</span> <span class="bound">xs</span> <span class="main">∧</span> 
      set <span class="bound">xs</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">∧</span> set <span class="bound">xs'</span> <span class="main">⊆</span> <span class="free">S'</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="main">-</span> set <span class="bound">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="bound">xs</span><span class="main">.</span> <span class="free">RR</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S'</span> <span class="main">-</span> set <span class="bound">xs'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="bound">xs'</span><span class="main">.</span> <span class="free">RR'</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">(</span>set <span class="bound">xs</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>set <span class="bound">xs'</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">}</span>"</span></span>
    <span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">using</span></span> REFS INJ <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_imageD<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> intro_prgR<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="bound">xs'</span><span class="main">)</span> <span class="main">.</span> <span class="bound">xs'</span><span class="main">=</span>map <span class="free">α</span> <span class="bound">xs</span> <span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SPEC_refine<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> INJ RR_OK 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 
    <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_map sorted_wrt_map 
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sorted_wrt_mono_rel<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">RR</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">using</span></span> REF0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> INJ <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> map_eq_appendE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">l</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> inj_on_map_eq_map<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">α</span></span><span class="main"><span class="main">,</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_inj_on<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split_asm<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> REFPHI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FOREACH_cond_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split prod.split_asm<span class="main"><span class="keyword3">,</span></span> 
    <span class="operator">intro</span> allI impI conj_cong<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> REFC<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command">unfolding</span></span> FOREACH_body_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_rcg</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> REFSTEP<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">[</span></span>13<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a b d e f g h i<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">h</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> FOREACH_cond_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> FOREACH_cond_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> FOREACH_cond_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a b d e f<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_wrt_append<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> FOREACH_cond_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a b d e<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> FOREACH_cond_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a b d e f<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_wrt_append<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> FOREACH_cond_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> FOREACH_cond_def<span class="main">)</span>
 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_tl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a b d e f g<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a b d e f g<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a b d e f g<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_wrt_append<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a b d e f g<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_wrt_append<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a b d e f g<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> introR<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">xs'</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
      <span class="bound">xs'</span><span class="main">=</span>map <span class="free">α</span> <span class="bound">xs</span> <span class="main">∧</span> <span class="free">Φ</span> <span class="main">(</span>set <span class="bound">xs</span><span class="main">)</span> <span class="bound">σ</span> <span class="main">∧</span> <span class="free">Φ'</span> <span class="main">(</span>set <span class="bound">xs'</span><span class="main">)</span> <span class="bound">σ'</span> <span class="main">∧</span>
      set <span class="bound">xs</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">∧</span> set <span class="bound">xs'</span> <span class="main">⊆</span> <span class="free">S'</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="main">-</span> set <span class="bound">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="bound">xs</span><span class="main">.</span> <span class="free">RR</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S'</span> <span class="main">-</span> set <span class="bound">xs'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="bound">xs'</span><span class="main">.</span> <span class="free">RR'</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">(</span>set <span class="bound">xs</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>set <span class="bound">xs'</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span>
      <span class="main">¬</span> FOREACH_cond <span class="free">c</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> FOREACH_cond <span class="free">c'</span> <span class="main">(</span><span class="bound">xs'</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span>
    <span class="main">}</span>
    "</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FOREACH_cond_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE1<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">using</span></span> REF_R_DONE <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">using</span></span> REF_R_BRK <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHoci_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> <span class="main">⇒</span> <span class="tfree">'Sa</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Sa</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">α</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">=</span> <span class="free">α</span><span class="main">`</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ0</span><span class="main">,</span><span class="free">σ0'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RR_OK<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">;</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">;</span> <span class="free">RR</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">RR'</span> <span class="main">(</span><span class="free">α</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">α</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFPHI0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Φ''</span> <span class="free">S</span> <span class="free">σ0</span> <span class="main">(</span><span class="free">α</span><span class="main">`</span><span class="free">S</span><span class="main">)</span> <span class="free">σ0'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span>  <span class="free">Φ''</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟷</span> <span class="free">c'</span> <span class="bound">σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFPHI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="free">Φ''</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFSTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">x'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="bound">it</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">.</span> <span class="free">RR</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span> 
    <span class="bound">x'</span><span class="main">=</span><span class="free">α</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">x'</span><span class="main">∈</span><span class="bound">it'</span><span class="main">;</span> <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span>
    <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span>  <span class="free">Φ''</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c'</span> <span class="bound">σ'</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> 
    <span class="main">≤</span> <span class="main">⇓</span><span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="free">Φ''</span> <span class="main">(</span><span class="bound">it</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="bound">σ</span> <span class="main">(</span><span class="bound">it'</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x'</span><span class="main">}</span><span class="main">)</span> <span class="bound">σ'</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHoci <span class="free">RR</span> <span class="free">Φ</span> <span class="free">S</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>FOREACHoci <span class="free">RR'</span> <span class="free">Φ'</span> <span class="free">S'</span> <span class="free">c'</span> <span class="free">f'</span> <span class="free">σ0'</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHoci_refine_genR<span class="main"><span class="main">[</span></span>
    <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">it</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">it'</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">∧</span> <span class="free">Φ''</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">}</span>"</span></span>
    <span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">using</span></span> REF0 REFPHI0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">using</span></span> REFC <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">using</span></span> REFPHI <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">using</span></span> REFSTEP <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
 
<span class="keyword1"><span class="command">lemma</span></span> FOREACHoci_refine_rcg<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> <span class="main">⇒</span> <span class="tfree">'Sa</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Sa</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">α</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">=</span> <span class="free">α</span><span class="main">`</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ0</span><span class="main">,</span><span class="free">σ0'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RR_OK<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">;</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">;</span> <span class="free">RR</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">RR'</span> <span class="main">(</span><span class="free">α</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">α</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟷</span> <span class="free">c'</span> <span class="bound">σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFPHI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFSTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">x'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="bound">it</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">.</span> <span class="free">RR</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span>
    <span class="bound">x'</span><span class="main">=</span><span class="free">α</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">x'</span><span class="main">∈</span><span class="bound">it'</span><span class="main">;</span> <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span>
    <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c'</span> <span class="bound">σ'</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHoci <span class="free">RR</span> <span class="free">Φ</span> <span class="free">S</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>FOREACHoci <span class="free">RR'</span> <span class="free">Φ'</span> <span class="free">S'</span> <span class="free">c'</span> <span class="free">f'</span> <span class="free">σ0'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHoci_refine<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Φ''<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHoci_weaken<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IREF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span><span class="main">.</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">I'</span> <span class="bound">it</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHoci <span class="free">RR</span> <span class="free">I'</span> <span class="free">S</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> FOREACHoci <span class="free">RR</span> <span class="free">I</span> <span class="free">S</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHoci_refine_rcg<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> α<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">id</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">Id</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> IREF<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHoci_weaken_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RRREF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">RR</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">RR'</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHoci <span class="free">RR</span> <span class="free">I</span> <span class="free">S</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> FOREACHoci <span class="free">RR'</span> <span class="free">I</span> <span class="free">S</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHoci_refine_rcg<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> α<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">id</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">Id</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> RRREF<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Rules for Derived Constructs›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHoi_refine_genR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> <span class="main">⇒</span> <span class="tfree">'Sa</span>"</span></span> <span class="comment1">― ‹Abstraction mapping of elements›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> set"</span></span> <span class="comment1">― ‹Concrete set›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Sa</span> set"</span></span> <span class="comment1">― ‹Abstract set›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ0'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'σa</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'S</span> set <span class="main">×</span> <span class="tfree">'σ</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'Sa</span> set <span class="main">×</span> <span class="tfree">'σa</span><span class="main">)</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">α</span> <span class="free">S</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> REFS<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">=</span> <span class="free">α</span><span class="main">`</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RR_OK<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">;</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">;</span> <span class="free">RR</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">RR'</span> <span class="main">(</span><span class="free">α</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">α</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">S</span><span class="main">,</span><span class="free">σ0</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">α</span><span class="main">`</span><span class="free">S</span><span class="main">,</span><span class="free">σ0'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFPHI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span>
    <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">-</span><span class="bound">it</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="bound">it</span><span class="main">.</span> <span class="free">RR</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S'</span><span class="main">-</span><span class="bound">it'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="bound">it'</span><span class="main">.</span> <span class="free">RR'</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span>
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">it</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">it'</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFSTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">x'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span>
    <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span>
    <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">-</span><span class="bound">it</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="bound">it</span><span class="main">.</span> <span class="free">RR</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S'</span><span class="main">-</span><span class="bound">it'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="bound">it'</span><span class="main">.</span> <span class="free">RR'</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span>
    <span class="bound">x'</span><span class="main">=</span><span class="free">α</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">it</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">it'</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span>
    <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="bound">it</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">.</span> <span class="free">RR</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span>
    <span class="bound">x'</span><span class="main">∈</span><span class="bound">it'</span><span class="main">;</span> <span class="main">∀</span><span class="bound">y'</span><span class="main">∈</span><span class="bound">it'</span><span class="main">-</span><span class="main">{</span><span class="bound">x'</span><span class="main">}</span><span class="main">.</span> <span class="free">RR'</span> <span class="bound">x'</span> <span class="bound">y'</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> 
    <span class="main">≤</span> <span class="main">⇓</span><span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">it</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">it'</span><span class="main">-</span><span class="main">{</span><span class="bound">x'</span><span class="main">}</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF_R_DONE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">Φ</span> <span class="main">{}</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">Φ'</span> <span class="main">{}</span> <span class="bound">σ'</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHoi <span class="free">RR</span> <span class="free">Φ</span> <span class="free">S</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R'</span> <span class="main">(</span>FOREACHoi <span class="free">RR'</span> <span class="free">Φ'</span> <span class="free">S'</span> <span class="free">f'</span> <span class="free">σ0'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHoi_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHoci_refine_genR<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fact</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">using</span></span> REFSTEP <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fact</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHoi_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> <span class="main">⇒</span> <span class="tfree">'Sa</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Sa</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">α</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">=</span> <span class="free">α</span><span class="main">`</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ0</span><span class="main">,</span><span class="free">σ0'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RR_OK<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">;</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">;</span> <span class="free">RR</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">RR'</span> <span class="main">(</span><span class="free">α</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">α</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFPHI0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Φ''</span> <span class="free">S</span> <span class="free">σ0</span> <span class="main">(</span><span class="free">α</span><span class="main">`</span><span class="free">S</span><span class="main">)</span> <span class="free">σ0'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFPHI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="free">Φ''</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFSTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">x'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="bound">it</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">.</span> <span class="free">RR</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span> 
    <span class="bound">x'</span><span class="main">=</span><span class="free">α</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">x'</span><span class="main">∈</span><span class="bound">it'</span><span class="main">;</span> <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span>
    <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span>  <span class="free">Φ''</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> 
    <span class="main">≤</span> <span class="main">⇓</span><span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="free">Φ''</span> <span class="main">(</span><span class="bound">it</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="bound">σ</span> <span class="main">(</span><span class="bound">it'</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x'</span><span class="main">}</span><span class="main">)</span> <span class="bound">σ'</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHoi <span class="free">RR</span> <span class="free">Φ</span> <span class="free">S</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>FOREACHoi <span class="free">RR'</span> <span class="free">Φ'</span> <span class="free">S'</span> <span class="free">f'</span> <span class="free">σ0'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHoi_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHoci_refine <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">α</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">Φ''</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHoi_refine_rcg<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> <span class="main">⇒</span> <span class="tfree">'Sa</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Sa</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">α</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">=</span> <span class="free">α</span><span class="main">`</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ0</span><span class="main">,</span><span class="free">σ0'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RR_OK<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">;</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">;</span> <span class="free">RR</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">RR'</span> <span class="main">(</span><span class="free">α</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">α</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFPHI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFSTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">x'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="bound">it</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">.</span> <span class="free">RR</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span>
    <span class="bound">x'</span><span class="main">=</span><span class="free">α</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">x'</span><span class="main">∈</span><span class="bound">it'</span><span class="main">;</span> <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span>
    <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHoi <span class="free">RR</span> <span class="free">Φ</span> <span class="free">S</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>FOREACHoi <span class="free">RR'</span> <span class="free">Φ'</span> <span class="free">S'</span> <span class="free">f'</span> <span class="free">σ0'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHoi_refine<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Φ''<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHci_refine_genR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> <span class="main">⇒</span> <span class="tfree">'Sa</span>"</span></span> <span class="comment1">― ‹Abstraction mapping of elements›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> set"</span></span> <span class="comment1">― ‹Concrete set›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Sa</span> set"</span></span> <span class="comment1">― ‹Abstract set›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ0'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'σa</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'S</span> set <span class="main">×</span> <span class="tfree">'σ</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'Sa</span> set <span class="main">×</span> <span class="tfree">'σa</span><span class="main">)</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">α</span> <span class="free">S</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> REFS<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">=</span> <span class="free">α</span><span class="main">`</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">S</span><span class="main">,</span><span class="free">σ0</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">α</span><span class="main">`</span><span class="free">S</span><span class="main">,</span><span class="free">σ0'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> 
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">it</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">it'</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟷</span> <span class="free">c'</span> <span class="bound">σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFPHI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span>
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">it</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">it'</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFSTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">x'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span>
    <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span>
    <span class="bound">x'</span><span class="main">=</span><span class="free">α</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">it</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">it'</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span>
    <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">x'</span><span class="main">∈</span><span class="bound">it'</span><span class="main">;</span>
    <span class="free">c</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c'</span> <span class="bound">σ'</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> 
    <span class="main">≤</span> <span class="main">⇓</span><span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">it</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">it'</span><span class="main">-</span><span class="main">{</span><span class="bound">x'</span><span class="main">}</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF_R_DONE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">Φ</span> <span class="main">{}</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">Φ'</span> <span class="main">{}</span> <span class="bound">σ'</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF_R_BRK<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span>
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">it</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">it'</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span>
    <span class="bound">it</span><span class="main">≠</span><span class="main">{}</span><span class="main">;</span> <span class="bound">it'</span><span class="main">≠</span><span class="main">{}</span><span class="main">;</span>
    <span class="main">¬</span><span class="free">c</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">¬</span><span class="free">c'</span> <span class="bound">σ'</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHci <span class="free">Φ</span> <span class="free">S</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R'</span> <span class="main">(</span>FOREACHci <span class="free">Φ'</span> <span class="free">S'</span> <span class="free">c'</span> <span class="free">f'</span> <span class="free">σ0'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHci_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHoci_refine_genR<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fact</span><span class="main"><span class="keyword3">|</span></span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">using</span></span> REFC <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">using</span></span> REFPHI <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">using</span></span> REFSTEP <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fact</span><span class="main"><span class="keyword3">|</span></span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">using</span></span> REF_R_BRK <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHci_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> <span class="main">⇒</span> <span class="tfree">'Sa</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Sa</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">α</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">=</span> <span class="free">α</span><span class="main">`</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ0</span><span class="main">,</span><span class="free">σ0'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFPHI0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Φ''</span> <span class="free">S</span> <span class="free">σ0</span> <span class="main">(</span><span class="free">α</span><span class="main">`</span><span class="free">S</span><span class="main">)</span> <span class="free">σ0'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span>  <span class="free">Φ''</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟷</span> <span class="free">c'</span> <span class="bound">σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFPHI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="free">Φ''</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFSTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">x'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">x'</span><span class="main">=</span><span class="free">α</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">x'</span><span class="main">∈</span><span class="bound">it'</span><span class="main">;</span> <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span>
    <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span>  <span class="free">Φ''</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c'</span> <span class="bound">σ'</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> 
    <span class="main">≤</span> <span class="main">⇓</span><span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="free">Φ''</span> <span class="main">(</span><span class="bound">it</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="bound">σ</span> <span class="main">(</span><span class="bound">it'</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x'</span><span class="main">}</span><span class="main">)</span> <span class="bound">σ'</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHci <span class="free">Φ</span> <span class="free">S</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>FOREACHci <span class="free">Φ'</span> <span class="free">S'</span> <span class="free">c'</span> <span class="free">f'</span> <span class="free">σ0'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHci_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHoci_refine <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">α</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">Φ''</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHci_refine_rcg<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> <span class="main">⇒</span> <span class="tfree">'Sa</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Sa</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">α</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">=</span> <span class="free">α</span><span class="main">`</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ0</span><span class="main">,</span><span class="free">σ0'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟷</span> <span class="free">c'</span> <span class="bound">σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFPHI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFSTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">x'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">x'</span><span class="main">=</span><span class="free">α</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">x'</span><span class="main">∈</span><span class="bound">it'</span><span class="main">;</span> <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span>
    <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c'</span> <span class="bound">σ'</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHci <span class="free">Φ</span> <span class="free">S</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>FOREACHci <span class="free">Φ'</span> <span class="free">S'</span> <span class="free">c'</span> <span class="free">f'</span> <span class="free">σ0'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHci_refine<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Φ''<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHci_weaken<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IREF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span><span class="main">.</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">I'</span> <span class="bound">it</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHci <span class="free">I'</span> <span class="free">S</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> FOREACHci <span class="free">I</span> <span class="free">S</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHci_refine_rcg<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> α<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">id</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">Id</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> IREF<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHi_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FIN<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">S</span> <span class="free">σ0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IP<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="free">I</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">I</span> <span class="main">(</span><span class="bound">it</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="main">{}</span> <span class="bound">σ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHi <span class="free">I</span> <span class="free">S</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> SPEC <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHi_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHci_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">I</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHc_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FIN<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">S</span> <span class="free">σ0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IP<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="free">I</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">I</span> <span class="main">(</span><span class="bound">it</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> II1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="main">{}</span> <span class="bound">σ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> II2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">it</span><span class="main">≠</span><span class="main">{}</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="free">I</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">¬</span><span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHc <span class="free">S</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> SPEC <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHc_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FOREACHci_weaken<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> TrueI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHci_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">I</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACH_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FIN<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">S</span> <span class="free">σ0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IP<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="free">I</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">I</span> <span class="main">(</span><span class="bound">it</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="main">{}</span> <span class="bound">σ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACH <span class="free">S</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> SPEC <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACH_def FOREACHc_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FOREACHci_weaken<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> TrueI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHci_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">I</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> FOREACHc_refine_genR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> <span class="main">⇒</span> <span class="tfree">'Sa</span>"</span></span> <span class="comment1">― ‹Abstraction mapping of elements›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> set"</span></span> <span class="comment1">― ‹Concrete set›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Sa</span> set"</span></span> <span class="comment1">― ‹Abstract set›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ0'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'σa</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'S</span> set <span class="main">×</span> <span class="tfree">'σ</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'Sa</span> set <span class="main">×</span> <span class="tfree">'σa</span><span class="main">)</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">α</span> <span class="free">S</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> REFS<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">=</span> <span class="free">α</span><span class="main">`</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">S</span><span class="main">,</span><span class="free">σ0</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">α</span><span class="main">`</span><span class="free">S</span><span class="main">,</span><span class="free">σ0'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> 
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">it</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">it'</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟷</span> <span class="free">c'</span> <span class="bound">σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFSTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">x'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span>
    <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> 
    <span class="bound">x'</span><span class="main">=</span><span class="free">α</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">it</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">it'</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span>
    <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">x'</span><span class="main">∈</span><span class="bound">it'</span><span class="main">;</span>
    <span class="free">c</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c'</span> <span class="bound">σ'</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> 
    <span class="main">≤</span> <span class="main">⇓</span><span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">it</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">it'</span><span class="main">-</span><span class="main">{</span><span class="bound">x'</span><span class="main">}</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF_R_DONE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF_R_BRK<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> 
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">it</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">it'</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span>
    <span class="bound">it</span><span class="main">≠</span><span class="main">{}</span><span class="main">;</span> <span class="bound">it'</span><span class="main">≠</span><span class="main">{}</span><span class="main">;</span>
    <span class="main">¬</span><span class="free">c</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">¬</span><span class="free">c'</span> <span class="bound">σ'</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHc <span class="free">S</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R'</span> <span class="main">(</span>FOREACHc <span class="free">S'</span> <span class="free">c'</span> <span class="free">f'</span> <span class="free">σ0'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHc_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHci_refine_genR<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fact</span><span class="main"><span class="keyword3">|</span></span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">using</span></span> REFC <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">using</span></span> REFSTEP <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">using</span></span> REF_R_DONE <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">using</span></span> REF_R_BRK <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHc_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> <span class="main">⇒</span> <span class="tfree">'Sa</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Sa</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">α</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">=</span> <span class="free">α</span><span class="main">`</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ0</span><span class="main">,</span><span class="free">σ0'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFPHI0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Φ''</span> <span class="free">S</span> <span class="free">σ0</span> <span class="main">(</span><span class="free">α</span><span class="main">`</span><span class="free">S</span><span class="main">)</span> <span class="free">σ0'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ''</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟷</span> <span class="free">c'</span> <span class="bound">σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFSTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">x'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">x'</span><span class="main">=</span><span class="free">α</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">x'</span><span class="main">∈</span><span class="bound">it'</span><span class="main">;</span> <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span>
    <span class="free">Φ''</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> 
    <span class="main">≤</span> <span class="main">⇓</span><span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="free">Φ''</span> <span class="main">(</span><span class="bound">it</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="bound">σ</span> <span class="main">(</span><span class="bound">it'</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x'</span><span class="main">}</span><span class="main">)</span> <span class="bound">σ'</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHc <span class="free">S</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>FOREACHc <span class="free">S'</span> <span class="free">c'</span> <span class="free">f'</span> <span class="free">σ0'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHc_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHci_refine<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Φ''<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">Φ''</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> INJ REFS REF0 REFPHI0<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> REFC<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> TrueI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> REFSTEP<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHc_refine_rcg<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> <span class="main">⇒</span> <span class="tfree">'Sa</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Sa</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">α</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">=</span> <span class="free">α</span><span class="main">`</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ0</span><span class="main">,</span><span class="free">σ0'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟷</span> <span class="free">c'</span> <span class="bound">σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFSTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">x'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">x'</span><span class="main">=</span><span class="free">α</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">x'</span><span class="main">∈</span><span class="bound">it'</span><span class="main">;</span> <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c'</span> <span class="bound">σ'</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHc <span class="free">S</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>FOREACHc <span class="free">S'</span> <span class="free">c'</span> <span class="free">f'</span> <span class="free">σ0'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHc_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHci_refine_rcg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHi_refine_genR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> <span class="main">⇒</span> <span class="tfree">'Sa</span>"</span></span> <span class="comment1">― ‹Abstraction mapping of elements›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> set"</span></span> <span class="comment1">― ‹Concrete set›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Sa</span> set"</span></span> <span class="comment1">― ‹Abstract set›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ0'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'σa</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'S</span> set <span class="main">×</span> <span class="tfree">'σ</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'Sa</span> set <span class="main">×</span> <span class="tfree">'σa</span><span class="main">)</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">α</span> <span class="free">S</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> REFS<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">=</span> <span class="free">α</span><span class="main">`</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">S</span><span class="main">,</span><span class="free">σ0</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">α</span><span class="main">`</span><span class="free">S</span><span class="main">,</span><span class="free">σ0'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFPHI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span>
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">it</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">it'</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFSTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">x'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span>
    <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span>
    <span class="bound">x'</span><span class="main">=</span><span class="free">α</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">it</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">it'</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span>
    <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">x'</span><span class="main">∈</span><span class="bound">it'</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> 
    <span class="main">≤</span> <span class="main">⇓</span><span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">it</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">it'</span><span class="main">-</span><span class="main">{</span><span class="bound">x'</span><span class="main">}</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF_R_DONE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">Φ</span> <span class="main">{}</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">Φ'</span> <span class="main">{}</span> <span class="bound">σ'</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHi <span class="free">Φ</span> <span class="free">S</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R'</span> <span class="main">(</span>FOREACHi <span class="free">Φ'</span> <span class="free">S'</span> <span class="free">f'</span> <span class="free">σ0'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHi_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHci_refine_genR<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fact</span><span class="main"><span class="keyword3">|</span></span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">using</span></span> REFSTEP <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fact</span><span class="main"><span class="keyword3">|</span></span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHi_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> <span class="main">⇒</span> <span class="tfree">'Sa</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Sa</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">α</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">=</span> <span class="free">α</span><span class="main">`</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ0</span><span class="main">,</span><span class="free">σ0'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFPHI0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Φ''</span> <span class="free">S</span> <span class="free">σ0</span> <span class="main">(</span><span class="free">α</span><span class="main">`</span><span class="free">S</span><span class="main">)</span> <span class="free">σ0'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFPHI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="free">Φ''</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFSTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">x'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">x'</span><span class="main">=</span><span class="free">α</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">x'</span><span class="main">∈</span><span class="bound">it'</span><span class="main">;</span> <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span>
    <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span>  <span class="free">Φ''</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> 
    <span class="main">≤</span> <span class="main">⇓</span><span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="free">Φ''</span> <span class="main">(</span><span class="bound">it</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="bound">σ</span> <span class="main">(</span><span class="bound">it'</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x'</span><span class="main">}</span><span class="main">)</span> <span class="bound">σ'</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHi <span class="free">Φ</span> <span class="free">S</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>FOREACHi <span class="free">Φ'</span> <span class="free">S'</span> <span class="free">f'</span> <span class="free">σ0'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHi_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHci_refine<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Φ''<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">Φ''</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> INJ REFS REF0 REFPHI0<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> REFPHI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> REFSTEP<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHi_refine_rcg<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> <span class="main">⇒</span> <span class="tfree">'Sa</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Sa</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">α</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">=</span> <span class="free">α</span><span class="main">`</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ0</span><span class="main">,</span><span class="free">σ0'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFPHI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFSTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">x'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">x'</span><span class="main">=</span><span class="free">α</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">x'</span><span class="main">∈</span><span class="bound">it'</span><span class="main">;</span> <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span>
    <span class="free">Φ</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHi <span class="free">Φ</span> <span class="free">S</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>FOREACHi <span class="free">Φ'</span> <span class="free">S'</span> <span class="free">f'</span> <span class="free">σ0'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHi_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHci_refine_rcg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACH_refine_genR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> <span class="main">⇒</span> <span class="tfree">'Sa</span>"</span></span> <span class="comment1">― ‹Abstraction mapping of elements›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> set"</span></span> <span class="comment1">― ‹Concrete set›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Sa</span> set"</span></span> <span class="comment1">― ‹Abstract set›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ0'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'σa</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'S</span> set <span class="main">×</span> <span class="tfree">'σ</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'Sa</span> set <span class="main">×</span> <span class="tfree">'σa</span><span class="main">)</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">α</span> <span class="free">S</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> REFS<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">=</span> <span class="free">α</span><span class="main">`</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">S</span><span class="main">,</span><span class="free">σ0</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">α</span><span class="main">`</span><span class="free">S</span><span class="main">,</span><span class="free">σ0'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFSTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">x'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span>
    <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span>
    <span class="bound">x'</span><span class="main">=</span><span class="free">α</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">it</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">it'</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span>
    <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">x'</span><span class="main">∈</span><span class="bound">it'</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> 
    <span class="main">≤</span> <span class="main">⇓</span><span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">it</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">it'</span><span class="main">-</span><span class="main">{</span><span class="bound">x'</span><span class="main">}</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF_R_DONE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACH <span class="free">S</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R'</span> <span class="main">(</span>FOREACH <span class="free">S'</span> <span class="free">f'</span> <span class="free">σ0'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACH_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHc_refine_genR<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fact</span><span class="main"><span class="keyword3">|</span></span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">using</span></span> REFSTEP <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fact</span><span class="main"><span class="keyword3">|</span></span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACH_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> <span class="main">⇒</span> <span class="tfree">'Sa</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Sa</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">α</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">=</span> <span class="free">α</span><span class="main">`</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ0</span><span class="main">,</span><span class="free">σ0'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFPHI0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Φ''</span> <span class="free">S</span> <span class="free">σ0</span> <span class="main">(</span><span class="free">α</span><span class="main">`</span><span class="free">S</span><span class="main">)</span> <span class="free">σ0'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFSTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">x'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">x'</span><span class="main">=</span><span class="free">α</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">x'</span><span class="main">∈</span><span class="bound">it'</span><span class="main">;</span> <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span>
    <span class="free">Φ''</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> 
    <span class="main">≤</span> <span class="main">⇓</span><span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="free">Φ''</span> <span class="main">(</span><span class="bound">it</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="bound">σ</span> <span class="main">(</span><span class="bound">it'</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x'</span><span class="main">}</span><span class="main">)</span> <span class="bound">σ'</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACH <span class="free">S</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>FOREACH <span class="free">S'</span> <span class="free">f'</span> <span class="free">σ0'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACH_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHc_refine<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Φ''<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">Φ''</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> INJ REFS REF0 REFPHI0<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> REFSTEP<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACH_refine_rcg<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> <span class="main">⇒</span> <span class="tfree">'Sa</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Sa</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">α</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">=</span> <span class="free">α</span><span class="main">`</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ0</span><span class="main">,</span><span class="free">σ0'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFSTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">x'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">x'</span><span class="main">=</span><span class="free">α</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">x'</span><span class="main">∈</span><span class="bound">it'</span><span class="main">;</span> <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACH <span class="free">S</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>FOREACH <span class="free">S'</span> <span class="free">f'</span> <span class="free">σ0'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACH_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHc_refine_rcg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHci_refine_rcg'<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> <span class="main">⇒</span> <span class="tfree">'Sa</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Sa</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">α</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">=</span> <span class="free">α</span><span class="main">`</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ0</span><span class="main">,</span><span class="free">σ0'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟷</span> <span class="free">c'</span> <span class="bound">σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFSTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">x'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">x'</span><span class="main">=</span><span class="free">α</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">x'</span><span class="main">∈</span><span class="bound">it'</span><span class="main">;</span> <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span>
    <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c'</span> <span class="bound">σ'</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHc <span class="free">S</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>FOREACHci <span class="free">Φ'</span> <span class="free">S'</span> <span class="free">c'</span> <span class="free">f'</span> <span class="free">σ0'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHc_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHci_refine_rcg<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> REFC<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> TrueI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> REFSTEP<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHi_refine_rcg'<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> <span class="main">⇒</span> <span class="tfree">'Sa</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'S</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Sa</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">α</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">=</span> <span class="free">α</span><span class="main">`</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REF0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ0</span><span class="main">,</span><span class="free">σ0'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REFSTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span> <span class="bound">x'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="bound">x'</span><span class="main">=</span><span class="free">α</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">x'</span><span class="main">∈</span><span class="bound">it'</span><span class="main">;</span> <span class="bound">it'</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="bound">it'</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span>
    <span class="free">Φ'</span> <span class="bound">it'</span> <span class="bound">σ'</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACH <span class="free">S</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>FOREACHi <span class="free">Φ'</span> <span class="free">S'</span> <span class="free">f'</span> <span class="free">σ0'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACH_def FOREACHi_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHci_refine_rcg'<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> REFSTEP<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Alternative set of FOREACHc-rules›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Here, we provide an alternative set of FOREACH rules with 
  interruption. In some cases, they are easier to use, as they avoid 
  redundancy between the final cases for interruption and non-interruption›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHoci_rule'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FIN<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">S</span> <span class="free">σ0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IP<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">c</span> <span class="bound">σ</span><span class="main">;</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="free">I</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="bound">it</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span>
                <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span> <span class="main">-</span> <span class="bound">it</span><span class="main">.</span> <span class="free">R</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">I</span> <span class="main">(</span><span class="bound">it</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> II1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="main">{}</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> II2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="free">I</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">¬</span><span class="free">c</span> <span class="bound">σ</span><span class="main">;</span>
                         <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span> <span class="main">-</span> <span class="bound">it</span><span class="main">.</span> <span class="free">R</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHoci <span class="free">R</span> <span class="free">I</span> <span class="free">S</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> SPEC <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHoci_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FIN<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">I</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> I0<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> IP<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="improper">σ</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> II1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> II2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> II2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> FOREACHci_rule'<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FIN<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">S</span> <span class="free">σ0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IP<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="free">I</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">I</span> <span class="main">(</span><span class="bound">it</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> II1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="main">{}</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> II2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="free">I</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">¬</span><span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHci <span class="free">I</span> <span class="free">S</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> SPEC <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHci_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHoci_rule'<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHc_rule'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FIN<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">S</span> <span class="free">σ0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IP<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">it</span><span class="main">;</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="free">I</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">I</span> <span class="main">(</span><span class="bound">it</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> II1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="main">{}</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> II2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">it</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">it</span><span class="main">⊆</span><span class="free">S</span><span class="main">;</span> <span class="free">I</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">¬</span><span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHc <span class="free">S</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> SPEC <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHc_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FOREACHci_weaken<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> TrueI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHci_rule'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">I</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹FOREACH with empty sets›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHoci_emp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"FOREACHoci <span class="free">R</span> <span class="free">Φ</span> <span class="main">{}</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="main">(</span><span class="free">Φ</span> <span class="main">{}</span> <span class="free">σ</span><span class="main">)</span><span class="main">;</span> RETURN <span class="free">σ</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FOREACHoci_def FOREACH_cond_def bind_RES<span class="main">)</span>
    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> WHILEIT_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHoi_emp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"FOREACHoi <span class="free">R</span> <span class="free">Φ</span> <span class="main">{}</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="main">(</span><span class="free">Φ</span> <span class="main">{}</span> <span class="free">σ</span><span class="main">)</span><span class="main">;</span> RETURN <span class="free">σ</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FOREACHoi_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHci_emp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"FOREACHci <span class="free">Φ</span> <span class="main">{}</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="main">(</span><span class="free">Φ</span> <span class="main">{}</span> <span class="free">σ</span><span class="main">)</span><span class="main">;</span> RETURN <span class="free">σ</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FOREACHci_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHc_emp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"FOREACHc <span class="main">{}</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">=</span> RETURN <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FOREACHc_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACH_emp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"FOREACH <span class="main">{}</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">=</span> RETURN <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FOREACH_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHi_emp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"FOREACHi <span class="free">Φ</span> <span class="main">{}</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="main">(</span><span class="free">Φ</span> <span class="main">{}</span> <span class="free">σ</span><span class="main">)</span><span class="main">;</span> RETURN <span class="free">σ</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FOREACHi_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Monotonicity"</span></span>

<span class="comment1">(* TODO: Move to RefineG_Domain *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lift_refl</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">==</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lift_mono</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">==</span> <span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lift_mono1</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">==</span> <span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="bound">x</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="bound">y</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lift_mono2</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">==</span> <span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="bound">x</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="bound">y</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">y</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">trimono_spec</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">==</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">L</span></span></span> id <span class="main">(≤)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">L</span></span></span> id flat_ge <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> trimono_atomize <span class="main">=</span> atomize_imp atomize_conj atomize_all
<span class="keyword1"><span class="command">lemmas</span></span> trimono_deatomize <span class="main">=</span> trimono_atomize<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> trimono_spec_defs <span class="main">=</span> trimono_spec_def lift_refl_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> comp_def id_def
    lift_mono_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> lift_mono1_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> lift_mono2_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    trimono_deatomize

<span class="keyword1"><span class="command">locale</span></span> trimono_spec <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≡</span> lift_refl"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≡</span> lift_mono"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">M1</span> <span class="main">≡</span> lift_mono1"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">M2</span> <span class="main">≡</span> lift_mono2"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> trimono_spec <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHoci_mono<span class="main">[</span><span class="operator">unfolded</span> trimono_spec_defs<span class="main">,</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"trimono_spec <span class="main">(</span>R <span class="keyword1">o</span> R <span class="keyword1">o</span> R <span class="keyword1">o</span> R <span class="keyword1">o</span> M2 <span class="keyword1">o</span> R<span class="main">)</span> FOREACHoci"</span></span>
  <span class="quoted"><span class="quoted">"trimono_spec <span class="main">(</span>R <span class="keyword1">o</span> R <span class="keyword1">o</span> R <span class="keyword1">o</span> M2 <span class="keyword1">o</span> R<span class="main">)</span> FOREACHoi"</span></span>
  <span class="quoted"><span class="quoted">"trimono_spec <span class="main">(</span>R <span class="keyword1">o</span> R <span class="keyword1">o</span> R <span class="keyword1">o</span> M2 <span class="keyword1">o</span> R<span class="main">)</span> FOREACHci"</span></span>
  <span class="quoted"><span class="quoted">"trimono_spec <span class="main">(</span>R <span class="keyword1">o</span> R <span class="keyword1">o</span> M2 <span class="keyword1">o</span> R<span class="main">)</span> FOREACHc"</span></span>
  <span class="quoted"><span class="quoted">"trimono_spec <span class="main">(</span>R <span class="keyword1">o</span> R <span class="keyword1">o</span> M2 <span class="keyword1">o</span> R<span class="main">)</span> FOREACHi"</span></span>
  <span class="quoted"><span class="quoted">"trimono_spec <span class="main">(</span>R <span class="keyword1">o</span> M2 <span class="keyword1">o</span> R<span class="main">)</span> FOREACH"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> trimono_spec_defs<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHoci_def FOREACH_to_oci_unfold FOREACH_body_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_mono</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Nres-Fold with Interruption (nfoldli)›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A foreach-loop can be conveniently expressed as an operation that converts
  the set to a list, followed by folding over the list.
  
  This representation is handy for automatic refinement, as the complex 
  foreach-operation is expressed by two relatively simple operations.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We first define a fold-function in the nres-monad›</span></span>
<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>nrec<span class="main">)</span> <span class="entity">nfoldli</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nfoldli</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> 
    <span class="main">[]</span> <span class="main">⇒</span> RETURN <span class="free"><span class="bound"><span class="entity">s</span></span></span> 
    <span class="main">|</span> <span class="bound">x</span><span class="main">#</span><span class="bound">ls</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">s</span><span class="main">←</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span> <span class="free">nfoldli</span> <span class="bound">ls</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span><span class="main">}</span> <span class="keyword1">else</span> RETURN <span class="free"><span class="bound"><span class="entity">s</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nfoldli_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nfoldli <span class="main">[]</span> <span class="free">c</span> <span class="free">f</span> <span class="free">s</span> <span class="main">=</span> RETURN <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"nfoldli <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">ls</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span> <span class="free">s</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">c</span> <span class="free">s</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">s</span><span class="main">←</span><span class="free">f</span> <span class="free">x</span> <span class="free">s</span><span class="main">;</span> nfoldli <span class="free">ls</span> <span class="free">c</span> <span class="free">f</span> <span class="bound">s</span><span class="main">}</span> <span class="keyword1">else</span> RETURN <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nfoldli.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> param_nfoldli<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nfoldli<span class="main">,</span>nfoldli<span class="main">)</span> <span class="main">∈</span> 
    <span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">(</span><span class="free">Rb</span><span class="main">→</span>Id<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">Ra</span><span class="main">→</span><span class="free">Rb</span><span class="main">→</span><span class="main">⟨</span><span class="free">Rb</span><span class="main">⟩</span>nres_rel<span class="main">)</span> <span class="main">→</span> <span class="free">Rb</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rb</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">goal_cases</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">l</span> <span class="skolem">l'</span> <span class="skolem">c</span> <span class="skolem">c'</span> <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> nfoldli_simps True_implies_equals<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">parametricity</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> nfoldli_simps True_implies_equals<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">parametricity</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nfoldli_no_ctd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">ctd</span> <span class="free">s</span> <span class="main">⟹</span> nfoldli <span class="free">l</span> <span class="free">ctd</span> <span class="free">f</span> <span class="free">s</span> <span class="main">=</span> RETURN <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nfoldli_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nfoldli <span class="main">(</span><span class="free">l1</span><span class="main">@</span><span class="free">l2</span><span class="main">)</span> <span class="free">ctd</span> <span class="free">f</span> <span class="free">s</span> <span class="main">=</span> nfoldli <span class="free">l1</span> <span class="free">ctd</span> <span class="free">f</span> <span class="free">s</span> <span class="main">⤜</span> nfoldli <span class="free">l2</span> <span class="free">ctd</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nfoldli_map<span class="main">:</span> <span class="quoted"><span class="quoted">"nfoldli <span class="main">(</span>map <span class="free">f</span> <span class="free">l</span><span class="main">)</span> <span class="free">ctd</span> <span class="free">g</span> <span class="free">s</span> <span class="main">=</span> nfoldli <span class="free">l</span> <span class="free">ctd</span> <span class="main">(</span><span class="free">g</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span> <span class="free">s</span>"</span></span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nfoldli_nfoldli_prod_conv<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"nfoldli <span class="free">l2</span> <span class="free">ctd</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> nfoldli <span class="free">l1</span> <span class="free">ctd</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> nfoldli <span class="main">(</span>List.product <span class="free">l2</span> <span class="free">l1</span><span class="main">)</span> <span class="free">ctd</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nfoldli <span class="main">(</span>map <span class="main">(</span>Pair <span class="skolem">a</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span> <span class="free">ctd</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> nfoldli <span class="skolem">l</span> <span class="free">ctd</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l2</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l1</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>  
  
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The fold-function over the nres-monad is transfered to a plain 
  foldli function›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> nfoldli_transfer_plain<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> RETURN <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f'</span> <span class="bound">x</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="main">(</span>foldli <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>nfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f'</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> plain_bind<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nfoldli_transfer_dres<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">l</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">c</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> nres_of <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f'</span> <span class="bound">x</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nres_of 
    <span class="main">(</span>foldli <span class="free">l</span> <span class="main">(</span>case_dres False False <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">⤜</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>dRETURN <span class="free">s</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">≤</span> <span class="main">(</span>nfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f'</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bind_mono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FR<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> FR<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nfoldli_mono<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">f'</span> <span class="bound">x</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> nfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">≤</span> nfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f'</span> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> flat_ge <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> flat_ge <span class="main">(</span>nfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span>nfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f'</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_mono</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_mono</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We relate our fold-function to the while-loop that we used in
  the original definition of the foreach-loop›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> nfoldli_while<span class="main">:</span> <span class="quoted"><span class="quoted">"nfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span>
          <span class="main">≤</span>
         <span class="main">(</span>WHILE<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇗</span><sup><span class="free">I</span></sup><span class="hidden">⇖</span>
           <span class="main">(</span>FOREACH_cond <span class="free">c</span><span class="main">)</span> <span class="main">(</span>FOREACH_body <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⤜</span>
          <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">σ</span><span class="main">)</span><span class="main">.</span> RETURN <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> WHILEIT_unfold<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> FOREACH_cond_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">ls</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="skolem">σ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> WHILEIT_unfold<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> FOREACH_cond_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> True
    <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> WHILEIT_unfold<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> FOREACH_cond_def FOREACH_body_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Refine_Basic.bind_mono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> while_nfoldli<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span> <span class="main">←</span> <span class="keyword1">WHILE<span class="hidden">⇩</span><sub>T</sub></span> <span class="main">(</span>FOREACH_cond <span class="free">c</span><span class="main">)</span> <span class="main">(</span>FOREACH_body <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">σ</span><span class="main">)</span><span class="main">;</span>
    RETURN <span class="bound">σ</span>
  <span class="main">}</span> <span class="main">≤</span> nfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> WHILET_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FOREACH_cond_def<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> WHILET_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span>
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> FOREACH_cond_def FOREACH_body_def
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bind_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> while_eq_nfoldli<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span> <span class="main">←</span> <span class="keyword1">WHILE<span class="hidden">⇩</span><sub>T</sub></span> <span class="main">(</span>FOREACH_cond <span class="free">c</span><span class="main">)</span> <span class="main">(</span>FOREACH_body <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">σ</span><span class="main">)</span><span class="main">;</span>
    RETURN <span class="bound">σ</span>
  <span class="main">}</span> <span class="main">=</span> nfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> while_nfoldli<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nfoldli_while<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> WHILET_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> nfoldli_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">[]</span> <span class="free">l0</span> <span class="free">σ0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">l1</span> <span class="bound">l2</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">l0</span><span class="main">=</span><span class="bound">l1</span><span class="main">@</span><span class="bound">x</span><span class="main">#</span><span class="bound">l2</span><span class="main">;</span> <span class="free">I</span> <span class="bound">l1</span> <span class="main">(</span><span class="bound">x</span><span class="main">#</span><span class="bound">l2</span><span class="main">)</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">I</span> <span class="main">(</span><span class="bound">l1</span><span class="main">@</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="bound">l2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FNC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l1</span> <span class="bound">l2</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">l0</span><span class="main">=</span><span class="bound">l1</span><span class="main">@</span><span class="bound">l2</span><span class="main">;</span> <span class="free">I</span> <span class="bound">l1</span> <span class="bound">l2</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">¬</span><span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">I</span> <span class="free">l0</span> <span class="main">[]</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nfoldli <span class="free">l0</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> SPEC <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nfoldli_while<span class="main"><span class="main"><span class="main">[</span></span></span>
    <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">l2</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">l1</span><span class="main">.</span> <span class="free">l0</span><span class="main">=</span><span class="bound">l1</span><span class="main">@</span><span class="bound">l2</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">l1</span> <span class="bound">l2</span> <span class="bound">σ</span>"</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACH_cond_def FOREACH_body_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> WHILEIT_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"measure <span class="main">(</span>length <span class="keyword1">o</span> fst<span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> I0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IS<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE disjE2<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> FC <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">using</span></span> FNC <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> nfoldli_leof_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">[]</span> <span class="free">l0</span> <span class="free">σ0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">l1</span> <span class="bound">l2</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">l0</span><span class="main">=</span><span class="bound">l1</span><span class="main">@</span><span class="bound">x</span><span class="main">#</span><span class="bound">l2</span><span class="main">;</span> <span class="free">I</span> <span class="bound">l1</span> <span class="main">(</span><span class="bound">x</span><span class="main">#</span><span class="bound">l2</span><span class="main">)</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="main">(</span><span class="free">I</span> <span class="main">(</span><span class="bound">l1</span><span class="main">@</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="bound">l2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FNC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l1</span> <span class="bound">l2</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">l0</span><span class="main">=</span><span class="bound">l1</span><span class="main">@</span><span class="bound">l2</span><span class="main">;</span> <span class="free">I</span> <span class="bound">l1</span> <span class="bound">l2</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">¬</span><span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">I</span> <span class="free">l0</span> <span class="main">[]</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nfoldli <span class="free">l0</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="skolem">σ</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">l0</span><span class="main">=</span><span class="skolem">l1</span><span class="main">@</span><span class="skolem">l2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nfoldli <span class="skolem">l2</span> <span class="free">c</span> <span class="free">f</span> <span class="skolem">σ</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">l2</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="skolem">σ</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="skolem">σ</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FC<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FNC<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">l2</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span> <span class="main">=</span> Cons.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">l1</span><span class="main">@</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span><span class="main">,</span><span class="operator">THEN</span> leof_trans<span class="main">]</span> IS<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">l2</span></span> <span class="quoted"><span class="skolem">σ</span></span><span class="main">,</span><span class="operator">THEN</span> leof_trans<span class="main">]</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> if_split<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_vcg</span>
        <span class="keyword1"><span class="command">using</span></span> Cons.prems FNC <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="free">l0</span></span> <span class="quoted"><span class="free">σ0</span></span><span class="main">]</span> I0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>  
    
    
<span class="keyword1"><span class="command">lemma</span></span> nfoldli_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">li</span><span class="main">,</span> <span class="free">l</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>list_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">si</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> CR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ci</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xi</span> <span class="bound">x</span> <span class="bound">si</span> <span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">xi</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span><span class="main">;</span> <span class="main">(</span><span class="bound">si</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">c</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">fi</span> <span class="bound">xi</span> <span class="bound">si</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nfoldli <span class="free">li</span> <span class="free">ci</span> <span class="free">fi</span> <span class="free">si</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R</span> <span class="main">(</span>nfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">si</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_rel_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">xi</span> <span class="skolem">x</span> <span class="skolem">li</span> <span class="skolem">l</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">refine</span><span class="main">]</span> <span class="main">=</span> Cons

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> if_split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_rcg</span>
    <span class="keyword1"><span class="command">using</span></span> CR Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="comment1">(* Refine, establishing additional invariant *)</span>
<span class="keyword1"><span class="command">lemma</span></span> nfoldli_invar_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">li</span><span class="main">,</span><span class="free">l</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>list_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">si</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">[]</span> <span class="free">li</span> <span class="free">si</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> COND<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l1i</span> <span class="bound">l2i</span> <span class="bound">l1</span> <span class="bound">l2</span> <span class="bound">si</span> <span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span>
    <span class="free">li</span><span class="main">=</span><span class="bound">l1i</span><span class="main">@</span><span class="bound">l2i</span><span class="main">;</span> <span class="free">l</span><span class="main">=</span><span class="bound">l1</span><span class="main">@</span><span class="bound">l2</span><span class="main">;</span> <span class="main">(</span><span class="bound">l1i</span><span class="main">,</span><span class="bound">l1</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>list_rel<span class="main">;</span> <span class="main">(</span><span class="bound">l2i</span><span class="main">,</span><span class="bound">l2</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>list_rel<span class="main">;</span> 
    <span class="free">I</span> <span class="bound">l1i</span> <span class="bound">l2i</span> <span class="bound">si</span><span class="main">;</span> <span class="main">(</span><span class="bound">si</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ci</span> <span class="bound">si</span><span class="main">,</span> <span class="free">c</span> <span class="bound">s</span><span class="main">)</span><span class="main">∈</span>bool_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l1i</span> <span class="bound">xi</span> <span class="bound">l2i</span> <span class="bound">si</span><span class="main">.</span> <span class="main">⟦</span><span class="free">li</span><span class="main">=</span><span class="bound">l1i</span><span class="main">@</span><span class="bound">xi</span><span class="main">#</span><span class="bound">l2i</span><span class="main">;</span> <span class="free">I</span> <span class="bound">l1i</span> <span class="main">(</span><span class="bound">xi</span><span class="main">#</span><span class="bound">l2i</span><span class="main">)</span> <span class="bound">si</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">fi</span> <span class="bound">xi</span> <span class="bound">si</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>n</sub></span> SPEC <span class="main">(</span><span class="free">I</span> <span class="main">(</span><span class="bound">l1i</span><span class="main">@</span><span class="main">[</span><span class="bound">xi</span><span class="main">]</span><span class="main">)</span> <span class="bound">l2i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l1i</span> <span class="bound">xi</span> <span class="bound">l2i</span> <span class="bound">l1</span> <span class="bound">x</span> <span class="bound">l2</span> <span class="bound">si</span> <span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span>
    <span class="free">li</span><span class="main">=</span><span class="bound">l1i</span><span class="main">@</span><span class="bound">xi</span><span class="main">#</span><span class="bound">l2i</span><span class="main">;</span> <span class="free">l</span><span class="main">=</span><span class="bound">l1</span><span class="main">@</span><span class="bound">x</span><span class="main">#</span><span class="bound">l2</span><span class="main">;</span> <span class="main">(</span><span class="bound">l1i</span><span class="main">,</span><span class="bound">l1</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>list_rel<span class="main">;</span> <span class="main">(</span><span class="bound">xi</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span><span class="main">;</span> <span class="main">(</span><span class="bound">l2i</span><span class="main">,</span><span class="bound">l2</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>list_rel<span class="main">;</span> 
    <span class="free">I</span> <span class="bound">l1i</span> <span class="main">(</span><span class="bound">xi</span><span class="main">#</span><span class="bound">l2i</span><span class="main">)</span> <span class="bound">si</span><span class="main">;</span> <span class="main">(</span><span class="bound">si</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">fi</span> <span class="bound">xi</span> <span class="bound">si</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nfoldli <span class="free">li</span> <span class="free">ci</span> <span class="free">fi</span> <span class="free">si</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>nfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">refine_dref_RELATES</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"RELATES <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"RELATES <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> RELATES_def<span class="main">)</span>

    <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">refine</span> <span class="quasi_keyword">del</span><span class="main">]</span> <span class="main">=</span> nfoldli_refine

    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l1i</span> <span class="skolem">l2i</span> <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="skolem">si</span> <span class="skolem">s</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l2i</span><span class="main">,</span><span class="skolem">l2</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>list_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l1i</span><span class="main">,</span><span class="skolem">l1</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>list_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">li</span><span class="main">=</span><span class="skolem">l1i</span><span class="main">@</span><span class="skolem">l2i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">=</span><span class="skolem">l1</span><span class="main">@</span><span class="skolem">l2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">si</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">l1i</span> <span class="skolem">l2i</span> <span class="skolem">si</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nfoldli <span class="skolem">l2i</span> <span class="free">ci</span> <span class="free">fi</span> <span class="skolem">si</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>nfoldli <span class="skolem">l2</span> <span class="free">c</span> <span class="free">f</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">si</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">l1i</span></span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_rel_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>  
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">xi</span> <span class="skolem">x</span> <span class="skolem">l2i</span> <span class="skolem">l2</span><span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> if_split<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> bind_refine'<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_dref_type</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> COND<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l1i</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xi</span><span class="main">#</span><span class="skolem">l2i</span>"</span></span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">#</span><span class="skolem">l2</span>"</span></span> <span class="quoted"><span class="skolem">si</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> Cons.prems Cons.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> STEP<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> Cons.prems Cons.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> si' s'
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">l1i</span><span class="main">@</span><span class="main">[</span><span class="skolem">xi</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l1</span><span class="main">@</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> Cons.prems Cons.hyps
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_append1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">using</span></span> INV<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l1i</span></span> <span class="quoted"><span class="skolem">xi</span></span> <span class="quoted"><span class="skolem">l2i</span></span> <span class="quoted"><span class="skolem">si</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_leof_iff<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">li</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="free">si</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
    
    
    
<span class="keyword1"><span class="command">lemma</span></span> foldli_mono_dres_aux1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>order_bot<span class="main">,</span> order_top<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> COND<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">σ'</span><span class="main">.</span> <span class="bound">σ</span><span class="main">≤</span><span class="bound">σ'</span> <span class="main">⟹</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">≠</span> <span class="free">c</span> <span class="bound">σ'</span> <span class="main">⟹</span> <span class="bound">σ</span><span class="main">=</span>bot <span class="main">∨</span> <span class="bound">σ'</span><span class="main">=</span>top "</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STRICT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> bot <span class="main">=</span> bot"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">x</span> top <span class="main">=</span> top"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span><span class="main">≤</span><span class="free">σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x</span><span class="main">≤</span><span class="bound">x'</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">f'</span> <span class="bound">a</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldli <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">≤</span> foldli <span class="free">l</span> <span class="free">c</span> <span class="free">f'</span> <span class="free">σ'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldli <span class="skolem">l</span> <span class="free">c</span> <span class="free">f</span> bot <span class="main">=</span> bot"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> STRICT<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldli <span class="skolem">l</span> <span class="free">c</span> <span class="free">f'</span> top <span class="main">=</span> top"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> STRICT<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> this

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> B
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">σ'</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A STRICT <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> COND<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> foldli_mono_dres_aux2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STRICT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> bot <span class="main">=</span> bot"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">x</span> top <span class="main">=</span> top"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x</span><span class="main">≤</span><span class="bound">x'</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">f'</span> <span class="bound">a</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldli <span class="free">l</span> <span class="main">(</span>case_dres False False <span class="free">c</span><span class="main">)</span> <span class="free">f</span> <span class="free">σ</span> 
    <span class="main">≤</span> foldli <span class="free">l</span> <span class="main">(</span>case_dres False False <span class="free">c</span><span class="main">)</span> <span class="free">f'</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> foldli_mono_dres_aux1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> dres.split_asm <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> STRICT A<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> foldli_mono_dres<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">f'</span> <span class="bound">a</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldli <span class="free">l</span> <span class="main">(</span>case_dres False False <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> dbind <span class="bound">s</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span> 
    <span class="main">≤</span> foldli <span class="free">l</span> <span class="main">(</span>case_dres False False <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> dbind <span class="bound">s</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> foldli_mono_dres_aux2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dbind_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>drec<span class="main">)</span> <span class="entity">dfoldli</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dfoldli</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> 
    <span class="main">[]</span> <span class="main">⇒</span> dRETURN <span class="free"><span class="bound"><span class="entity">s</span></span></span> 
    <span class="main">|</span> <span class="bound">x</span><span class="main">#</span><span class="bound">ls</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">s</span><span class="main">←</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span> <span class="free">dfoldli</span> <span class="bound">ls</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span><span class="main">}</span> <span class="keyword1">else</span> dRETURN <span class="free"><span class="bound"><span class="entity">s</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dfoldli_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"dfoldli <span class="main">[]</span> <span class="free">c</span> <span class="free">f</span> <span class="free">s</span> <span class="main">=</span> dRETURN <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"dfoldli <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">ls</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span> <span class="free">s</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">c</span> <span class="free">s</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">s</span><span class="main">←</span><span class="free">f</span> <span class="free">x</span> <span class="free">s</span><span class="main">;</span> dfoldli <span class="free">ls</span> <span class="free">c</span> <span class="free">f</span> <span class="bound">s</span><span class="main">}</span> <span class="keyword1">else</span> dRETURN <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> dfoldli.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> dfoldli_mono<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">f'</span> <span class="bound">x</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> dfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">≤</span> dfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f'</span> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> flat_ge <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> flat_ge <span class="main">(</span>dfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span>dfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f'</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_mono</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_mono</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> foldli_dres_pres_FAIL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"foldli <span class="free">l</span> <span class="main">(</span>case_dres False False <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> dbind <span class="bound">s</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> dFAIL <span class="main">=</span> dFAIL"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> foldli_dres_pres_SUCCEED<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldli <span class="free">l</span> <span class="main">(</span>case_dres False False <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> dbind <span class="bound">s</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> dSUCCEED <span class="main">=</span> dSUCCEED"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> dfoldli_by_foldli<span class="main">:</span> <span class="quoted"><span class="quoted">"dfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span>
  <span class="main">=</span> foldli <span class="free">l</span> <span class="main">(</span>case_dres False False <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> dbind <span class="bound">s</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dRETURN <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a l x<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="improper">a</span> <span class="improper">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> foldli_mono_dres_flat<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">x</span><span class="main">.</span> flat_ge <span class="main">(</span><span class="free">f</span> <span class="bound">a</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">a</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flat_ge <span class="main">(</span>foldli <span class="free">l</span> <span class="main">(</span>case_dres False False <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> dbind <span class="bound">s</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span><span class="main">)</span> 
          <span class="main">(</span>foldli <span class="free">l</span> <span class="main">(</span>case_dres False False <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> dbind <span class="bound">s</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfoldli_by_foldli<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_mono</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> dres_foldli_ne_bot<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">σ</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldli <span class="free">l</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">⤜</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">σ</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> dres.split<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rprems</span>
  <span class="keyword1"><span class="command">using</span></span> 2
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dres_ne_bot_basic<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹LIST FOREACH combinator›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Foreach-loops are mapped to the combinator <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>LIST_FOREACH›</span></span></span></span>, that
  takes as first argument an explicit <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>to_list›</span></span></span></span> operation. 
  This mapping is done during operation identification. 
  It is then the responsibility of the various implementations to further map
  the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>to_list›</span></span></span></span> operations to custom <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>to_list›</span></span></span></span> operations, like
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>set_to_list›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>map_to_list›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>nodes_to_list›</span></span></span></span>, etc.
›</span></span>

  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define a relation between distinct lists and sets.›</span></span>  
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">to_relAPP</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">list_set_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">⟩</span>list_rel <span class="keyword1">O</span> br set distinct"</span></span>
  
  
<span class="keyword1"><span class="command">lemma</span></span> autoref_nfoldli<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nfoldli<span class="main">,</span> nfoldli<span class="main">)</span>
  <span class="main">∈</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">(</span><span class="free">Rb</span> <span class="main">→</span> bool_rel<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">Ra</span> <span class="main">→</span> <span class="free">Rb</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rb</span><span class="main">⟩</span>nres_rel<span class="main">)</span> <span class="main">→</span> <span class="free">Rb</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rb</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> param_nfoldli<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This constant is a placeholder to be converted to
  custom operations by pattern rules›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">it_to_sorted_list</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> 
  <span class="main">≡</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> distinct <span class="bound">l</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> set <span class="bound">l</span> <span class="main">∧</span> sorted_wrt <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">l</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">LIST_FOREACH</span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="free"><span class="bound"><span class="entity">tsl</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ0</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">xs</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">tsl</span></span></span><span class="main">;</span>
  <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span> <span class="main">←</span> WHILE<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇗</span><sup><span class="main">λ</span><span class="main">(</span><span class="bound">it</span><span class="main">,</span> <span class="bound">σ</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">xs'</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">=</span> <span class="bound">xs'</span> <span class="main">@</span> <span class="bound">it</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="main">(</span>set <span class="bound">it</span><span class="main">)</span> <span class="bound">σ</span></sup><span class="hidden">⇖</span>
    <span class="main">(</span>FOREACH_cond <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>FOREACH_body <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">σ0</span></span></span><span class="main">)</span><span class="main">;</span>
    RETURN <span class="bound">σ</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHoci_by_LIST_FOREACH<span class="main">:</span>
  <span class="quoted"><span class="quoted">"FOREACHoci <span class="free">R</span> <span class="free">Φ</span> <span class="free">S</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    ASSERT <span class="main">(</span>finite <span class="free">S</span><span class="main">)</span><span class="main">;</span>
    LIST_FOREACH <span class="free">Φ</span> <span class="main">(</span>it_to_sorted_list <span class="free">R</span> <span class="free">S</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span>
  <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> OP_def FOREACHoci_def LIST_FOREACH_def it_to_sorted_list_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Patterns that convert FOREACH-constructs 
  to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>LIST_FOREACH›</span></span></span></span>
›</span></span>
<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACH_patterns<span class="main">[</span><span class="operator">autoref_op_pat_def</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"FOREACH<span class="hidden">⇗</span><sup><span class="free">I</span></sup><span class="hidden">⇖</span> <span class="free">s</span> <span class="free">f</span> <span class="main">≡</span> FOREACH<span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇗</span><sup><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">,</span><span class="free">I</span></sup><span class="hidden">⇖</span> <span class="free">s</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="quoted"><span class="quoted">"FOREACHci <span class="free">I</span> <span class="free">s</span> <span class="free">c</span> <span class="free">f</span> <span class="main">≡</span> FOREACHoci <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="free">I</span> <span class="free">s</span> <span class="free">c</span> <span class="free">f</span>"</span></span>
  <span class="quoted"><span class="quoted">"FOREACH<span class="hidden">⇩</span><sub>O</sub><span class="hidden">⇩</span><sub>C</sub><span class="hidden">⇗</span><sup><span class="free">R</span><span class="main">,</span><span class="free">Φ</span></sup><span class="hidden">⇖</span> <span class="free">s</span> <span class="free">c</span> <span class="free">f</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    ASSERT <span class="main">(</span>finite <span class="free">s</span><span class="main">)</span><span class="main">;</span>
    Autoref_Tagging.OP <span class="main">(</span>LIST_FOREACH <span class="free">Φ</span><span class="main">)</span> <span class="main">(</span>it_to_sorted_list <span class="free">R</span> <span class="free">s</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span> <span class="bound">σ</span>
  <span class="main">}</span>"</span></span>
  <span class="quoted"><span class="quoted">"FOREACH <span class="free">s</span> <span class="free">f</span> <span class="main">≡</span> FOREACHoci <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="free">s</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="quoted"><span class="quoted">"FOREACHoi <span class="free">R</span> <span class="free">I</span> <span class="free">s</span> <span class="free">f</span> <span class="main">≡</span> FOREACHoci <span class="free">R</span> <span class="free">I</span> <span class="free">s</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="quoted"><span class="quoted">"FOREACHc <span class="free">s</span> <span class="free">c</span> <span class="free">f</span> <span class="main">≡</span> FOREACHoci <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="free">s</span> <span class="free">c</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> 
    FOREACHoci_by_LIST_FOREACH<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    FOREACHc_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> 
    FOREACH_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> 
    FOREACHci_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> 
    FOREACHi_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> 
    FOREACHoi_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="comment1">(*lemma FOREACH_patterns[autoref_op_pat]: 
  "FOREACHoci R Φ s c f σ ≡ do {
    ASSERT (finite s);
    OP (LIST_FOREACH Φ) (it_to_sorted_list R s) c f σ
  }"
  "FOREACHc s c f σ ≡ FOREACHoci (λ_ _. True) (λ_ _. True) s c f σ"
  "FOREACH s f σ ≡ FOREACHoci (λ_ _. True) (λ_ _. True) s (λ_. True) f σ"
  "FOREACHci I s c f σ ≡ FOREACHoci (λ_ _. True) I s c f σ"
  "FOREACHi I s f σ ≡ FOREACHoci (λ_ _. True) I s (λ_. True) f σ"
  "FOREACHoi R I s f σ ≡ FOREACHoci R I s (λ_. True) f σ"
  unfolding 
    FOREACHoci_by_LIST_FOREACH[abs_def]
    FOREACHc_def[abs_def] 
    FOREACH_def[abs_def] 
    FOREACHci_def[abs_def] 
    FOREACHi_def[abs_def] 
    FOREACHoi_def[abs_def] 
  by simp_all*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">LIST_FOREACH'</span> <span class="free"><span class="bound"><span class="entity">tsl</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">xs</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">tsl</span></span></span><span class="main">;</span> nfoldli <span class="bound">xs</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LIST_FOREACH'_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>LIST_FOREACH'<span class="main">,</span>LIST_FOREACH'<span class="main">)</span> 
  <span class="main">∈</span> <span class="main">(</span><span class="main">⟨</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>list_rel<span class="main">⟩</span>nres_rel <span class="main">→</span> <span class="main">(</span><span class="free">Rσ</span><span class="main">→</span>bool_rel<span class="main">)</span> 
    <span class="main">→</span> <span class="main">(</span><span class="free">Rv</span> <span class="main">→</span> <span class="free">Rσ</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rσ</span><span class="main">⟩</span>nres_rel<span class="main">)</span> <span class="main">→</span> <span class="free">Rσ</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rσ</span><span class="main">⟩</span>nres_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> LIST_FOREACH'_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

<span class="keyword1"><span class="command">lemma</span></span> LIST_FOREACH_autoref<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>LIST_FOREACH'<span class="main">,</span> LIST_FOREACH <span class="free">Φ</span><span class="main">)</span> <span class="main">∈</span> 
    <span class="main">(</span><span class="main">⟨</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>list_rel<span class="main">⟩</span>nres_rel <span class="main">→</span> <span class="main">(</span><span class="free">Rσ</span><span class="main">→</span>bool_rel<span class="main">)</span> 
      <span class="main">→</span> <span class="main">(</span><span class="free">Rv</span> <span class="main">→</span> <span class="free">Rσ</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rσ</span><span class="main">⟩</span>nres_rel<span class="main">)</span> <span class="main">→</span> <span class="free">Rσ</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rσ</span><span class="main">⟩</span>nres_rel<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI nres_relI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tsl</span> <span class="skolem">tsl'</span> <span class="skolem">c</span> <span class="skolem">c'</span> <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">σ</span> <span class="skolem">σ'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">tsl</span><span class="main">,</span><span class="skolem">tsl'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>list_rel<span class="main">⟩</span>nres_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">c'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rσ</span><span class="main">→</span>bool_rel"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">f'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rv</span><span class="main">→</span><span class="free">Rσ</span><span class="main">→</span><span class="main">⟨</span><span class="free">Rσ</span><span class="main">⟩</span>nres_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ</span><span class="main">,</span><span class="skolem">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rσ</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LIST_FOREACH' <span class="skolem">tsl</span> <span class="skolem">c</span> <span class="skolem">f</span> <span class="skolem">σ</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">Rσ</span> <span class="main">(</span>LIST_FOREACH' <span class="skolem">tsl'</span> <span class="skolem">c'</span> <span class="skolem">f'</span> <span class="skolem">σ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nres_relD<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LIST_FOREACH' <span class="skolem">tsl'</span> <span class="skolem">c'</span> <span class="skolem">f'</span> <span class="skolem">σ'</span>
    <span class="main">≤</span> LIST_FOREACH <span class="free">Φ</span> <span class="skolem">tsl'</span> <span class="skolem">c'</span> <span class="skolem">f'</span> <span class="skolem">σ'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refine_IdD<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> LIST_FOREACH_def LIST_FOREACH'_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_rcg</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nfoldli_while<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"LIST_FOREACH' <span class="skolem">tsl</span> <span class="skolem">c</span> <span class="skolem">f</span> <span class="skolem">σ</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">Rσ</span> <span class="main">(</span>LIST_FOREACH <span class="free">Φ</span> <span class="skolem">tsl'</span> <span class="skolem">c'</span> <span class="skolem">f'</span> <span class="skolem">σ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> trimono_spec <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LIST_FOREACH'_mono<span class="main">[</span><span class="operator">unfolded</span> trimono_spec_defs<span class="main">,</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"trimono_spec <span class="main">(</span>R <span class="keyword1">o</span> R <span class="keyword1">o</span> M2 <span class="keyword1">o</span> R<span class="main">)</span> LIST_FOREACH'"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> trimono_spec_defs<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">unfolding</span></span> LIST_FOREACH'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">refine_mono</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LIST_FOREACH'_transfer_plain<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="free">tsl</span> <span class="main">≤</span> <span class="free">tsl'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">σ</span><span class="main">.</span> RETURN <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f'</span> <span class="bound">x</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="main">(</span>foldli <span class="free">tsl</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span><span class="main">)</span> <span class="main">≤</span> LIST_FOREACH' <span class="free">tsl'</span> <span class="free">c</span> <span class="free">f'</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> LIST_FOREACH'_def
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_transfer</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">thm</span></span> <span class="dynamic"><span class="dynamic">refine_transfer</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LIST_FOREACH'_transfer_nres<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nres_of <span class="free">tsl</span> <span class="main">≤</span> <span class="free">tsl'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">σ</span><span class="main">.</span> nres_of <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f'</span> <span class="bound">x</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nres_of <span class="main">(</span>
    <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">xs</span><span class="main">←</span><span class="free">tsl</span><span class="main">;</span> 
      foldli <span class="bound">xs</span> <span class="main">(</span>case_dres False False <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">⤜</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>dRETURN <span class="free">σ</span><span class="main">)</span>
    <span class="main">}</span><span class="main">)</span> <span class="main">≤</span> LIST_FOREACH' <span class="free">tsl'</span> <span class="free">c</span> <span class="free">f'</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> LIST_FOREACH'_def
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">refine_transfer</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simplification rules to summarize iterators›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">refine_transfer_post_simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">xs</span> <span class="main">←</span> dRETURN <span class="free">tsl</span><span class="main">;</span>
    foldli <span class="bound">xs</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span>
  <span class="main">}</span> <span class="main">=</span> foldli <span class="free">tsl</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">refine_transfer_post_simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">let</span> <span class="bound">xs</span> <span class="main">=</span> <span class="free">tsl</span> <span class="keyword1">in</span> foldli <span class="bound">xs</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> foldli <span class="free">tsl</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    
<span class="keyword1"><span class="command">lemma</span></span> LFO_pre_refine<span class="main">:</span> <span class="comment1">(* TODO: Generalize! *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">li</span><span class="main">,</span><span class="free">l</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_set_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ci</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">→</span> bool_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fi</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span><span class="main">→</span><span class="free">R</span><span class="main">→</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s0i</span><span class="main">,</span><span class="free">s0</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LIST_FOREACH' <span class="main">(</span>RETURN <span class="free">li</span><span class="main">)</span> <span class="free">ci</span> <span class="free">fi</span> <span class="free">s0i</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>FOREACHci <span class="free">I</span> <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">s0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_set_rel_def br_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> FOREACHc_def FOREACHci_def FOREACHoci_by_LIST_FOREACH
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> LIST_FOREACH_autoref<span class="main"><span class="main">[</span></span><span class="operator">param_fo</span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> nres_relD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> it_to_sorted_list_def nres_rel_def pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span>
      list_set_rel_def br_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>    
    

<span class="keyword1"><span class="command">lemma</span></span> LFOci_refine<span class="main">:</span> <span class="comment1">(* TODO: Generalize! *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">li</span><span class="main">,</span><span class="free">l</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_set_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">si</span><span class="main">.</span> <span class="main">(</span><span class="bound">si</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟹</span> <span class="free">ci</span> <span class="bound">si</span> <span class="main">⟷</span> <span class="free">c</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xi</span> <span class="bound">s</span> <span class="bound">si</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="bound">xi</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span><span class="main">;</span> <span class="main">(</span><span class="bound">si</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">fi</span> <span class="bound">xi</span> <span class="bound">si</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s0i</span><span class="main">,</span><span class="free">s0</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nfoldli <span class="free">li</span> <span class="free">ci</span> <span class="free">fi</span> <span class="free">s0i</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>FOREACHci <span class="free">I</span> <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">s0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms LFO_pre_refine<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">li</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">ci</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">fi</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">s0i</span></span> <span class="quoted"><span class="free">s0</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fun_rel_def nres_rel_def LIST_FOREACH'_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">lemma</span></span> LFOc_refine<span class="main">:</span> <span class="comment1">(* TODO: Generalize! *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">li</span><span class="main">,</span><span class="free">l</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_set_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">si</span><span class="main">.</span> <span class="main">(</span><span class="bound">si</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟹</span> <span class="free">ci</span> <span class="bound">si</span> <span class="main">⟷</span> <span class="free">c</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xi</span> <span class="bound">s</span> <span class="bound">si</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="bound">xi</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span><span class="main">;</span> <span class="main">(</span><span class="bound">si</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">fi</span> <span class="bound">xi</span> <span class="bound">si</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s0i</span><span class="main">,</span><span class="free">s0</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nfoldli <span class="free">li</span> <span class="free">ci</span> <span class="free">fi</span> <span class="free">s0i</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>FOREACHc <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">s0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHc_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LFOci_refine<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>

  
<span class="keyword1"><span class="command">lemma</span></span> LFO_refine<span class="main">:</span> <span class="comment1">(* TODO: Generalize! *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">li</span><span class="main">,</span><span class="free">l</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_set_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xi</span> <span class="bound">s</span> <span class="bound">si</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="bound">xi</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span><span class="main">;</span> <span class="main">(</span><span class="bound">si</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">fi</span> <span class="bound">xi</span> <span class="bound">si</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s0i</span><span class="main">,</span><span class="free">s0</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nfoldli <span class="free">li</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="free">fi</span> <span class="free">s0i</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>FOREACH <span class="free">l</span> <span class="free">f</span> <span class="free">s0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACH_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> LFOc_refine<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> LFOi_refine<span class="main">:</span> <span class="comment1">(* TODO: Generalize! *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">li</span><span class="main">,</span><span class="free">l</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_set_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xi</span> <span class="bound">s</span> <span class="bound">si</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="bound">xi</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span><span class="main">;</span> <span class="main">(</span><span class="bound">si</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">fi</span> <span class="bound">xi</span> <span class="bound">si</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s0i</span><span class="main">,</span><span class="free">s0</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nfoldli <span class="free">li</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="free">fi</span> <span class="free">s0i</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>FOREACHi <span class="free">I</span> <span class="free">l</span> <span class="free">f</span> <span class="free">s0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHi_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> LFOci_refine<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> LIST_FOREACH'_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"LIST_FOREACH' <span class="free">tsl'</span> <span class="free">c'</span> <span class="free">f'</span> <span class="free">σ'</span> <span class="main">≤</span> LIST_FOREACH <span class="free">Φ</span> <span class="free">tsl'</span> <span class="free">c'</span> <span class="free">f'</span> <span class="free">σ'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refine_IdD<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> LIST_FOREACH_def LIST_FOREACH'_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_rcg</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nfoldli_while<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> LIST_FOREACH'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"LIST_FOREACH <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="free">tsl'</span> <span class="free">c'</span> <span class="free">f'</span> <span class="free">σ'</span> <span class="main">=</span> <span class="main">(</span>LIST_FOREACH' <span class="free">tsl'</span> <span class="free">c'</span> <span class="free">f'</span> <span class="free">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refine_IdD<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> LIST_FOREACH_def LIST_FOREACH'_def while_eq_nfoldli<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> WHILEIT_refine_new_invar<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> WHILET_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEIT_refine_new_invar<span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_dref_type</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp_all</span>
    <span class="keyword1"><span class="command">unfolding</span></span> FOREACH_body_def FOREACH_cond_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_vcg</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> pw_le_iff neq_Nil_conv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LIST_FOREACH'_refine<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹FOREACH with duplicates›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">FOREACHcd</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  ASSERT <span class="main">(</span>finite <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">;</span>
  <span class="bound">l</span> <span class="main">←</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> set <span class="bound">l</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">;</span>
  nfoldli <span class="bound">l</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHcd_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">{}</span> <span class="free">S<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">σ<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S1</span> <span class="bound">S2</span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> insert <span class="bound">x</span> <span class="main">(</span><span class="bound">S1</span><span class="main">∪</span><span class="bound">S2</span><span class="main">)</span><span class="main">;</span> <span class="free">I</span> <span class="bound">S1</span> <span class="main">(</span>insert <span class="bound">x</span> <span class="bound">S2</span><span class="main">)</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">I</span> <span class="main">(</span>insert <span class="bound">x</span> <span class="bound">S1</span><span class="main">)</span> <span class="bound">S2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INTR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S1</span> <span class="bound">S2</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="bound">S1</span><span class="main">∪</span><span class="bound">S2</span><span class="main">;</span> <span class="free">I</span> <span class="bound">S1</span> <span class="bound">S2</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">¬</span><span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> COMPL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">I</span> <span class="free">S<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">{}</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHcd <span class="free">S<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHcd_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_vcg</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nfoldli_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l1</span> <span class="bound">l2</span> <span class="bound">σ</span><span class="main">.</span> <span class="free">I</span> <span class="main">(</span>set <span class="bound">l1</span><span class="main">)</span> <span class="main">(</span>set <span class="bound">l2</span><span class="main">)</span> <span class="bound">σ</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> I0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> STEP <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> INTR <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> COMPL <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">FOREACHcdi</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> 
    <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> nres<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> nres"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">FOREACHcdi</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> FOREACHcd"</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> FOREACHcdi_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">{}</span> <span class="free">S<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">σ<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S1</span> <span class="bound">S2</span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> insert <span class="bound">x</span> <span class="main">(</span><span class="bound">S1</span><span class="main">∪</span><span class="bound">S2</span><span class="main">)</span><span class="main">;</span> <span class="free">I</span> <span class="bound">S1</span> <span class="main">(</span>insert <span class="bound">x</span> <span class="bound">S2</span><span class="main">)</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">I</span> <span class="main">(</span>insert <span class="bound">x</span> <span class="bound">S1</span><span class="main">)</span> <span class="bound">S2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INTR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S1</span> <span class="bound">S2</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="bound">S1</span><span class="main">∪</span><span class="bound">S2</span><span class="main">;</span> <span class="free">I</span> <span class="bound">S1</span> <span class="bound">S2</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">¬</span><span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> COMPL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">I</span> <span class="free">S<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">{}</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHcdi <span class="free">I</span> <span class="free">S<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHcdi_def
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> FOREACHcd_rule<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> FOREACHcd_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>set_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> SV<span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">σ</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ'</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ'</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c'</span> <span class="bound">σ'</span><span class="main">,</span> <span class="free">c</span> <span class="bound">σ</span><span class="main">)</span><span class="main">∈</span>bool_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x'</span> <span class="bound">x</span> <span class="bound">σ'</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span><span class="main">;</span> <span class="main">(</span><span class="bound">σ'</span><span class="main">,</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">⟧</span>
     <span class="main">⟹</span> <span class="free">f'</span> <span class="bound">x'</span> <span class="bound">σ'</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHcd <span class="free">s'</span> <span class="free">c'</span> <span class="free">f'</span> <span class="free">σ'</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>FOREACHcdi <span class="free">I</span> <span class="free">s</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">refine_dref_RELATES</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"RELATES <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RELATES_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> SV <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">=</span>br <span class="skolem">α</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> single_valued_as_brE<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> S <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">=</span><span class="skolem">α</span><span class="main">`</span><span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">s'</span><span class="main">.</span> <span class="skolem">I</span> <span class="bound">x</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> br_set_rel_alt<span class="main">)</span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> FOREACHcd_def FOREACHcdi_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_rcg</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_dref_type</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> S
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"map <span class="skolem">α</span> <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_in_list_rel_conv<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> R0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>    
    

  
<span class="keyword1"><span class="command">lemma</span></span> FOREACHc_refines_FOREACHcd_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACHc <span class="free">s</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">≤</span> FOREACHcd <span class="free">s</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FOREACHc_def FOREACHci_def FOREACHoci_by_LIST_FOREACH LIST_FOREACH'_eq
    LIST_FOREACH'_def FOREACHcd_def it_to_sorted_list_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refine_IdD<span class="main">)</span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_dref_type</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
<span class="keyword1"><span class="command">lemmas</span></span> FOREACHc_refines_FOREACHcd<span class="main">[</span><span class="operator">refine</span><span class="main">]</span>
  <span class="main">=</span> order_trans<span class="main">[</span><span class="operator">OF</span> FOREACHc_refines_FOREACHcd_aux FOREACHcd_refine<span class="main">]</span>
    
    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Miscellanneous Utility Lemmas›</span></span>

<span class="comment1">(* TODO: Can we make this somewhat more general ? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> map_foreach<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACH <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">σ</span><span class="main">.</span> RETURN <span class="main">(</span>insert <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="free">R0</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">(=)</span> <span class="main">(</span><span class="free">R0</span> <span class="main">∪</span> <span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACH_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">it</span> <span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span><span class="main">=</span><span class="free">R0</span> <span class="main">∪</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="bound">it</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_sigma_foreach<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟹</span> finite <span class="main">(</span><span class="free">B</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACH <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">σ</span><span class="main">.</span> 
    FOREACH <span class="main">(</span><span class="free">B</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span> <span class="bound">σ</span><span class="main">.</span> RETURN <span class="main">(</span>insert <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="bound">σ</span>
  <span class="main">)</span> <span class="free">R0</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">(=)</span> <span class="main">(</span><span class="free">R0</span> <span class="main">∪</span> <span class="free">f</span><span class="main">`</span>Sigma <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACH_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">it</span> <span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span><span class="main">=</span><span class="free">R0</span> <span class="main">∪</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span>Sigma <span class="main">(</span><span class="free">A</span><span class="main">-</span><span class="bound">it</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">it'</span> <span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span><span class="main">=</span><span class="free">R0</span> <span class="main">∪</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span>Sigma <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="improper">it</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span> 
    <span class="main">∪</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="main">{</span><span class="improper">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="free">B</span> <span class="improper">x</span> <span class="main">-</span> <span class="bound">it'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> FOREACH_rule<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_sigma_sigma_foreach<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟹</span> finite <span class="main">(</span><span class="free">B</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">;</span> <span class="bound">b</span><span class="main">∈</span><span class="free">B</span> <span class="bound">a</span><span class="main">⟧</span> <span class="main">⟹</span> finite <span class="main">(</span><span class="free">C</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACH <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">σ</span><span class="main">.</span> 
    FOREACH <span class="main">(</span><span class="free">B</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span> <span class="bound">σ</span><span class="main">.</span> 
      FOREACH <span class="main">(</span><span class="free">C</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">c</span> <span class="bound">σ</span><span class="main">.</span>
        RETURN <span class="main">(</span>insert <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="bound">σ</span><span class="main">)</span> <span class="bound">σ</span>
  <span class="main">)</span> <span class="free">R0</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">(=)</span> <span class="main">(</span><span class="free">R0</span> <span class="main">∪</span> <span class="free">f</span><span class="main">`</span>Sigma <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> Sigma <span class="main">(</span><span class="free">B</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FOREACH_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
    I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">it</span> <span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span><span class="main">=</span><span class="free">R0</span> <span class="main">∪</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span>Sigma <span class="main">(</span><span class="free">A</span><span class="main">-</span><span class="bound">it</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> Sigma <span class="main">(</span><span class="free">B</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> 
    I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">it'</span> <span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span><span class="main">=</span><span class="free">R0</span> <span class="main">∪</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span>Sigma <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="improper">it</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> Sigma <span class="main">(</span><span class="free">B</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">∪</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="main">{</span><span class="improper">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span> Sigma <span class="main">(</span><span class="free">B</span> <span class="improper">x</span> <span class="main">-</span> <span class="bound">it'</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="improper">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> FOREACH_rule<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> 
    I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">it''</span> <span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span><span class="main">=</span><span class="free">R0</span> <span class="main">∪</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span>Sigma <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="improper">it</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> Sigma <span class="main">(</span><span class="free">B</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">∪</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="main">{</span><span class="improper">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span> Sigma <span class="main">(</span><span class="free">B</span> <span class="improper">x</span> <span class="main">-</span> <span class="improper">ita</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="improper">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">∪</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="main">{</span><span class="improper">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="main">{</span><span class="improper">xa</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="free">C</span> <span class="improper">x</span> <span class="improper">xa</span> <span class="main">-</span> <span class="bound">it''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    "</span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> FOREACH_rule<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> bij_set_rel_for_inj<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">≡</span> fun_of_rel <span class="free">R</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bijective <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">α</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> <span class="free">α</span><span class="main">`</span><span class="free">s</span>"</span></span>
  <span class="comment1">― ‹To be used when generating refinement conditions for foreach-loops›</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> bijective_def set_rel_def α_def fun_of_rel_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inj_onI ImageI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> Domain.simps contra_subsetD tfl_some<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> someI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> DomainE contra_subsetD tfl_some<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> nfoldli_by_idx_gen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nfoldli <span class="main">(</span>drop <span class="free">k</span> <span class="free">l</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span> <span class="free">s</span> <span class="main">=</span> nfoldli <span class="main">[</span><span class="free">k</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">s</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      ASSERT <span class="main">(</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="free">l</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">l</span><span class="main">!</span><span class="bound">i</span><span class="main">;</span>
      <span class="free">f</span> <span class="bound">x</span> <span class="bound">s</span>
    <span class="main">}</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">≤</span>length <span class="free">l</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inc_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>    
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">k</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> step.hyps <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">k</span> <span class="free">l</span> <span class="main">=</span> <span class="free">l</span><span class="main">!</span><span class="skolem">k</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">l</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons_nth_drop_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> step.hyps <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">k</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">#</span><span class="main">[</span>Suc <span class="skolem">k</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upt_conv_Cons<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> 1 2
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> step.IH<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> step.hyps<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  


<span class="keyword1"><span class="command">lemma</span></span> nfoldli_by_idx<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"nfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">s</span> <span class="main">=</span> nfoldli <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">s</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    ASSERT <span class="main">(</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="free">l</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">l</span><span class="main">!</span><span class="bound">i</span><span class="main">;</span>
    <span class="free">f</span> <span class="bound">x</span> <span class="bound">s</span>
  <span class="main">}</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nfoldli_by_idx_gen<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nfoldli_map_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="main">=</span> nfoldli <span class="main">(</span>map <span class="free">g</span> <span class="free">l</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>the_inv <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> the_inv_f_f<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> nfoldli_shift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ofs</span> <span class="main">::</span> <span class="quoted">nat</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="main">=</span> nfoldli <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">+</span><span class="free">ofs</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="main">(</span><span class="bound">x</span><span class="main">≥</span><span class="free">ofs</span><span class="main">)</span><span class="main">;</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">ofs</span><span class="main">)</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">lemma</span></span> nfoldli_foreach_shift<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nfoldli <span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span> <span class="free">c</span> <span class="free">f</span> <span class="main">=</span> nfoldli <span class="main">[</span><span class="free">a</span><span class="main">+</span><span class="free">ofs</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">+</span><span class="free">ofs</span><span class="main">]</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="keyword1">do</span><span class="main">{</span>ASSERT<span class="main">(</span><span class="bound">x</span><span class="main">≥</span><span class="free">ofs</span><span class="main">)</span><span class="main">;</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">ofs</span><span class="main">)</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nfoldli_shift<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">ofs</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_add_upt'<span class="main">)</span>


<span class="comment1">(* TODO: Move. Probably we have this already with FOREACH, or iterator! *)</span>
<span class="keyword1"><span class="command">lemma</span></span> member_by_nfoldli<span class="main">:</span> <span class="quoted"><span class="quoted">"nfoldli <span class="free">l</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="main">¬</span><span class="bound">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> RETURN <span class="main">(</span><span class="bound">y</span><span class="main">=</span><span class="free">x</span><span class="main">)</span><span class="main">)</span> False <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">⟷</span> <span class="free">x</span><span class="main">∈</span>set <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nfoldli <span class="free">l</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="main">¬</span><span class="bound">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> RETURN <span class="main">(</span><span class="bound">y</span><span class="main">=</span><span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">⟷</span> <span class="skolem">s</span> <span class="main">∨</span> <span class="free">x</span><span class="main">∈</span>set <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a l s
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rprems</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted">False</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>  

  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sum_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>comm_monoid_add nres<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> nres"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sum_impl</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> FOREACH <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">a</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">b</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">x</span><span class="main">;</span> RETURN <span class="main">(</span><span class="bound">a</span><span class="main">+</span><span class="bound">b</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_impl_correct<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="free">gi</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span><span class="main">=</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum_impl <span class="free">gi</span> <span class="free">S</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span><span class="main">=</span>sum <span class="free">g</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sum_impl_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> FOREACH_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">it</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">=</span> sum <span class="free">g</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="bound">it</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> it_step_insert_iff <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Refine_Automation">
<div class="head">
<h1>Theory Refine_Automation</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"More Automation"</span></span>
<span class="keyword1"><span class="command">theory</span></span> Refine_Automation
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Refine_Basic.html">Refine_Basic</a> <a href="Refine_Transfer.html">Refine_Transfer</a>
<span class="keyword2"><span class="keyword">keywords</span></span> <span class="quoted">"concrete_definition"</span> <span class="main">::</span> thy_decl
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"prepare_code_thms"</span> <span class="main">::</span> thy_decl
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"uses"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This theory provides a tool for extracting definitions from terms, and
  for generating code equations for recursion combinators.
›</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">REFINE_AUTOMATION</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">extraction</span> <span class="main">=</span> <span class="main">{</span>
    pattern<span class="main">:</span> term<span class="main">,</span>   <span class="comment1">(* Pattern to be defined as own constant *)</span>
    gen_thm<span class="main">:</span> thm<span class="main">,</span>    <span class="comment1">(* Code eq generator: [| c==rhs; ... |] ==&gt; c == ... *)</span>
    gen_tac<span class="main">:</span> local_theory <span class="main">-&gt;</span> <span class="entity">tactic'</span> <span class="comment1">(* Solves remaining premises of gen_thm *)</span>
  <span class="main">}</span>

  <span class="keyword1"><span class="keyword">val</span></span> extract_as_def<span class="main">:</span> <span class="main">(</span>string * typ<span class="main">)</span> list <span class="main">-&gt;</span> string <span class="main">-&gt;</span> term 
    <span class="main">-&gt;</span> local_theory <span class="main">-&gt;</span> <span class="main">(</span><span class="main">(</span>term * thm<span class="main">)</span> * local_theory<span class="main">)</span>

  <span class="keyword1"><span class="keyword">val</span></span> extract_recursion_eqs<span class="main">:</span> <span class="entity">extraction</span> list <span class="main">-&gt;</span> string <span class="main">-&gt;</span> thm 
    <span class="main">-&gt;</span> local_theory <span class="main">-&gt;</span> local_theory

  <span class="keyword1"><span class="keyword">val</span></span> add_extraction<span class="main">:</span> string <span class="main">-&gt;</span> <span class="entity">extraction</span> <span class="main">-&gt;</span> theory <span class="main">-&gt;</span> theory

  <span class="keyword1"><span class="keyword">val</span></span> prepare_code_thms_cmd<span class="main">:</span> string list <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> local_theory <span class="main">-&gt;</span> local_theory

  <span class="keyword1"><span class="keyword">val</span></span> define_concrete_fun<span class="main">:</span> <span class="entity">extraction</span> list option <span class="main">-&gt;</span> binding <span class="main">-&gt;</span> 
    Token.src list <span class="main">-&gt;</span> indexname list <span class="main">-&gt;</span> thm <span class="main">-&gt;</span>
    cterm list <span class="main">-&gt;</span> local_theory <span class="main">-&gt;</span> <span class="main">(</span>thm * thm<span class="main">)</span> * local_theory
  
  <span class="keyword1"><span class="keyword">val</span></span> mk_qualified<span class="main">:</span> string <span class="main">-&gt;</span> bstring <span class="main">-&gt;</span> binding

  <span class="keyword1"><span class="keyword">val</span></span> prepare_cd_pattern<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> cterm <span class="main">-&gt;</span> cterm
  <span class="keyword1"><span class="keyword">val</span></span> add_cd_pattern<span class="main">:</span> cterm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
  <span class="keyword1"><span class="keyword">val</span></span> del_cd_pattern<span class="main">:</span> cterm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
  <span class="keyword1"><span class="keyword">val</span></span> get_cd_patterns<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> cterm list

  <span class="keyword1"><span class="keyword">val</span></span> add_vc_rec_thm<span class="main">:</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
  <span class="keyword1"><span class="keyword">val</span></span> del_vc_rec_thm<span class="main">:</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
  <span class="keyword1"><span class="keyword">val</span></span> get_vc_rec_thms<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm list

  <span class="keyword1"><span class="keyword">val</span></span> add_vc_solve_thm<span class="main">:</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
  <span class="keyword1"><span class="keyword">val</span></span> del_vc_solve_thm<span class="main">:</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
  <span class="keyword1"><span class="keyword">val</span></span> get_vc_solve_thms<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm list

  <span class="keyword1"><span class="keyword">val</span></span> vc_solve_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> bool <span class="main">-&gt;</span> <span class="entity">tactic'</span>
  <span class="keyword1"><span class="keyword">val</span></span> vc_solve_modifiers<span class="main">:</span> <span class="entity">Method.modifier</span> parser list

  <span class="keyword1"><span class="keyword">val</span></span> setup<span class="main">:</span> theory <span class="main">-&gt;</span> theory
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Refine_Automation</span> <span class="main">:</span><span class="entity">REFINE_AUTOMATION</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>

  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">extraction</span> <span class="main">=</span> <span class="main">{</span>
    pattern<span class="main">:</span> term<span class="main">,</span>   <span class="comment1">(* Pattern to be defined as own constant *)</span>
    gen_thm<span class="main">:</span> thm<span class="main">,</span>    <span class="comment1">(* Code eq generator: [| c==rhs; ... |] ==&gt; c == ... *)</span>
    gen_tac<span class="main">:</span> local_theory <span class="main">-&gt;</span> <span class="entity">tactic'</span> <span class="comment1">(* Solves remaining premises of gen_thm *)</span>
  <span class="main">}</span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">extractions</span> <span class="main">=</span> Generic_Data <span class="main">(</span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="entity">extraction</span> list Symtab.table
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> Symtab.empty
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">merge</span> <span class="main">=</span> Symtab.merge_list <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> o apply2 <span class="main">#</span>pattern<span class="main">)</span>
  <span class="main">)</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_extraction</span> <span class="entity">name</span> <span class="entity">ex</span> <span class="main">=</span> 
    Context.theory_map <span class="main">(</span>extractions.map <span class="main">(</span>
      Symtab.update_list <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> o apply2 <span class="main">#</span>pattern<span class="main">)</span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">ex</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

  <span class="comment1">(*
    Define new constant name for subterm t in context bnd.
    Returns replacement for t using the new constant and definition 
    theorem.
  *)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">extract_as_def</span> <span class="entity">bnd</span> <span class="entity">name</span> <span class="entity">t</span> <span class="entity">lthy</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">loose</span> <span class="main">=</span> rev <span class="main">(</span>loose_bnos <span class="entity">t</span><span class="main">)</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rnames</span> <span class="main">=</span> <span class="main">#</span><span class="inner_numeral">1</span> <span class="main">(</span>Variable.names_of <span class="entity">lthy</span> |&gt; fold_map <span class="main">(</span>Name.variant o <span class="main">#</span><span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">bnd</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rfrees</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">typ</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> Free <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">typ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">rnames</span> ~~ <span class="entity">bnd</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t'</span> <span class="main">=</span> subst_bounds <span class="main">(</span><span class="entity">rfrees</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">params</span> <span class="main">=</span> map Bound <span class="main">(</span>rev <span class="entity">loose</span><span class="main">)</span><span class="main">;</span>
    
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">param_vars</span> 
      <span class="main">=</span> <span class="main">(</span>Library.foldl <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span> <span class="main">=&gt;</span> nth <span class="entity">rfrees</span> <span class="entity">i</span> :: <span class="entity">l</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="entity">loose</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">param_types</span> <span class="main">=</span> map fastype_of <span class="entity">param_vars</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">def_t</span> <span class="main">=</span> Logic.mk_equals 
      <span class="main">(</span>list_comb <span class="main">(</span>Free <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">param_types</span> ---&gt; fastype_of <span class="entity">t'</span><span class="main">)</span><span class="main">,</span><span class="entity">param_vars</span><span class="main">)</span><span class="main">,</span><span class="entity">t'</span><span class="main">)</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">lhs_t</span><span class="main">,</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">def_thm</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="entity">lthy</span><span class="main">)</span> 
      <span class="main">=</span> <span class="entity">Specification.definition</span> NONE <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="main">(</span>Binding.empty_atts<span class="main">,</span><span class="entity">def_t</span><span class="main">)</span> <span class="entity">lthy</span><span class="main">;</span>

    <span class="comment1">(*val _ = tracing "xxxx";*)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">app_t</span> <span class="main">=</span> list_comb <span class="main">(</span><span class="entity">lhs_t</span><span class="main">,</span> <span class="entity">params</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span> 
    <span class="main">(</span><span class="main">(</span><span class="entity">app_t</span><span class="main">,</span><span class="entity">def_thm</span><span class="main">)</span><span class="main">,</span><span class="entity">lthy</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_qualified</span> <span class="entity">basename</span> <span class="entity">q</span> <span class="main">=</span> Binding.qualify true <span class="entity">basename</span> <span class="main">(</span>Binding.name <span class="entity">q</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">extract_recursion_eqs</span> <span class="entity">exs</span> <span class="entity">basename</span> <span class="entity">orig_def_thm</span> <span class="entity">lthy</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thy</span> <span class="main">=</span> Proof_Context.theory_of <span class="entity">lthy</span>
 
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pat_net</span> <span class="main">:</span> <span class="entity">extraction</span> Item_Net.T <span class="main">=</span>
    Item_Net.init <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> o apply2 <span class="main">#</span>pattern<span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span><span class="entity">pattern</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">pattern</span><span class="main">]</span><span class="main">)</span>
    |&gt; fold Item_Net.update <span class="entity">exs</span>

  <span class="keyword2"><span class="keyword">local</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tr</span> <span class="entity">env</span> <span class="entity">t</span> <span class="entity">ctx</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="comment1">(* Recurse for subterms *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="entity">ctx</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="entity">t1</span>$<span class="entity">t2</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">t1</span><span class="main">,</span><span class="entity">ctx</span><span class="main">)</span> <span class="main">=</span> <span class="entity">tr</span> <span class="entity">env</span> <span class="entity">t1</span> <span class="entity">ctx</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">t2</span><span class="main">,</span><span class="entity">ctx</span><span class="main">)</span> <span class="main">=</span> <span class="entity">tr</span> <span class="entity">env</span> <span class="entity">t2</span> <span class="entity">ctx</span>
          <span class="keyword2"><span class="keyword">in</span></span> 
            <span class="main">(</span><span class="entity">t1</span>$<span class="entity">t2</span><span class="main">,</span><span class="entity">ctx</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span> 
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">t'</span><span class="main">,</span><span class="entity">ctx</span><span class="main">)</span> <span class="main">=</span> <span class="entity">tr</span> <span class="main">(</span><span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span>::<span class="entity">env</span><span class="main">)</span> <span class="entity">t</span> <span class="entity">ctx</span>
          <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span>Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span><span class="entity">t'</span><span class="main">)</span><span class="main">,</span><span class="entity">ctx</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="entity">ctx</span><span class="main">)</span>      

      <span class="comment1">(* Check if we match a pattern *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ex</span> <span class="main">=</span> 
        Item_Net.retrieve_matching <span class="entity">pat_net</span> <span class="entity">t</span>
        |&gt; get_first <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ex</span> <span class="main">=&gt;</span> 
             <span class="keyword2"><span class="keyword">case</span></span>
               try <span class="main">(</span>Pattern.first_order_match <span class="entity">thy</span> <span class="main">(</span><span class="main">#</span>pattern <span class="entity">ex</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> 
                 <span class="main">(</span>Vartab.empty<span class="main">,</span>Vartab.empty<span class="main">)</span>
             <span class="keyword2"><span class="keyword">of</span></span> NONE <span class="main">=&gt;</span> NONE <span class="main">|</span> SOME <span class="main">_</span> <span class="main">=&gt;</span> SOME <span class="entity">ex</span>
           <span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">ex</span> <span class="keyword2"><span class="keyword">of</span></span> 
        NONE <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="entity">ctx</span><span class="main">)</span>
      <span class="main">|</span> SOME <span class="entity">ex</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="comment1">(* Extract as new constant *)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">idx</span><span class="main">,</span><span class="entity">defs</span><span class="main">,</span><span class="entity">lthy</span><span class="main">)</span> <span class="main">=</span> <span class="entity">ctx</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="main">(</span><span class="entity">basename</span> ^ <span class="inner_quoted">"_"</span> ^ string_of_int <span class="entity">idx</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="entity">def_thm</span><span class="main">)</span><span class="main">,</span><span class="entity">lthy</span><span class="main">)</span> <span class="main">=</span> <span class="entity">extract_as_def</span> <span class="entity">env</span> <span class="entity">name</span> <span class="entity">t</span> <span class="entity">lthy</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctx</span> <span class="main">=</span> <span class="main">(</span><span class="entity">idx</span>+<span class="inner_numeral">1</span><span class="main">,</span><span class="main">(</span><span class="entity">def_thm</span><span class="main">,</span><span class="entity">ex</span><span class="main">)</span>::<span class="entity">defs</span><span class="main">,</span><span class="entity">lthy</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="entity">ctx</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">transform</span> <span class="entity">t</span> <span class="entity">lthy</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> 
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">defs</span><span class="main">,</span><span class="entity">lthy</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">tr</span> <span class="main">[</span><span class="main">]</span> <span class="entity">t</span> <span class="main">(</span><span class="inner_numeral">0</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="entity">lthy</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span> 
      <span class="main">(</span><span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="entity">defs</span><span class="main">)</span><span class="main">,</span><span class="entity">lthy</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="comment1">(* Import theorem and extract RHS *)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">orig_def_thm'</span><span class="main">)</span><span class="main">,</span><span class="entity">lthy</span><span class="main">)</span> <span class="main">=</span> <span class="entity">yield_singleton2</span> 
    <span class="main">(</span>Variable.import true<span class="main">)</span> <span class="entity">orig_def_thm</span> <span class="entity">lthy</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">lhs</span><span class="main">,</span><span class="entity">rhs</span><span class="main">)</span> <span class="main">=</span> <span class="entity">orig_def_thm'</span> |&gt; Thm.prop_of |&gt; Logic.dest_equals<span class="main">;</span>
  
  <span class="comment1">(* Transform RHS, generating new constants *)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">rhs'</span><span class="main">,</span><span class="entity">defs</span><span class="main">)</span><span class="main">,</span><span class="entity">lthy</span><span class="main">)</span> <span class="main">=</span> <span class="entity">transform</span> <span class="entity">rhs</span> <span class="entity">lthy</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">def_thms</span> <span class="main">=</span> map <span class="main">#</span><span class="inner_numeral">1</span> <span class="entity">defs</span>

  <span class="comment1">(* Register definitions of generated constants *)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">lthy</span><span class="main">)</span> 
    <span class="main">=</span> Local_Theory.note <span class="main">(</span><span class="main">(</span><span class="entity">mk_qualified</span> <span class="entity">basename</span> <span class="inner_quoted">"defs"</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span><span class="entity">def_thms</span><span class="main">)</span> <span class="entity">lthy</span><span class="main">;</span>
  
  <span class="comment1">(* Obtain new def_thm *)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">def_unfold_ss</span> <span class="main">=</span> 
    put_simpset <span class="entity">HOL_basic_ss</span> <span class="entity">lthy</span> addsimps <span class="main">(</span><span class="entity">orig_def_thm</span>::<span class="entity">def_thms</span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">new_def_thm</span> <span class="main">=</span> Goal.prove_internal <span class="entity">lthy</span>
    <span class="main">[</span><span class="main">]</span> <span class="main">(</span>Logic.mk_equals <span class="main">(</span><span class="entity">lhs</span><span class="main">,</span><span class="entity">rhs'</span><span class="main">)</span> |&gt; Thm.cterm_of <span class="entity">lthy</span><span class="main">)</span> <span class="main">(</span>K <span class="main">(</span><span class="entity">simp_tac</span> <span class="entity">def_unfold_ss</span> <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span>

  <span class="comment1">(* Obtain new theorem by folding with defs of generated constants *)</span>
  <span class="comment1">(* TODO: Maybe cleaner to generate eq-thm and prove by "unfold, refl" *)</span>
  <span class="comment1">(*val new_def_thm 
    = Library.foldr (fn (dt,t) =&gt; Local_Defs.fold lthy [dt] t) 
        (def_thms,orig_def_thm');*)</span>

  <span class="comment1">(* Prepare code equations *)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_code_thm</span> <span class="entity">lthy</span> <span class="main">(</span><span class="entity">def_thm</span><span class="main">,</span><span class="main">{</span><span class="entity">gen_thm</span><span class="main">,</span> <span class="entity">gen_tac</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">def_thm</span><span class="main">)</span><span class="main">,</span><span class="entity">lthy'</span><span class="main">)</span> <span class="main">=</span> <span class="entity">yield_singleton2</span> 
      <span class="main">(</span>Variable.import true<span class="main">)</span> <span class="entity">def_thm</span> <span class="entity">lthy</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">def_thm</span> RS <span class="entity">gen_thm</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tac</span> <span class="main">=</span> SOLVED' <span class="main">(</span><span class="entity">gen_tac</span> <span class="entity">lthy'</span><span class="main">)</span>
      ORELSE' <span class="main">(</span><span class="entity">simp_tac</span> <span class="entity">def_unfold_ss</span> THEN' <span class="entity">gen_tac</span> <span class="entity">lthy'</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> the <span class="main">(</span>SINGLE <span class="main">(</span>ALLGOALS <span class="entity">tac</span><span class="main">)</span> <span class="entity">thm</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> singleton <span class="main">(</span>Variable.export <span class="entity">lthy'</span> <span class="entity">lthy</span><span class="main">)</span> <span class="entity">thm</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">thm</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
  
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">code_thms</span> <span class="main">=</span> map <span class="main">(</span><span class="entity">mk_code_thm</span> <span class="entity">lthy</span><span class="main">)</span> <span class="entity">defs</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> forall Thm.no_prems <span class="entity">code_thms</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> 
    warning <span class="inner_quoted">"Unresolved premises in code theorems"</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">lthy</span><span class="main">)</span> <span class="main">=</span> Local_Theory.note 
    <span class="main">(</span><span class="main">(</span><span class="entity">mk_qualified</span> <span class="entity">basename</span> <span class="inner_quoted">"code"</span><span class="main">,</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">attributes</span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">,</span><span class="entity">new_def_thm</span>::<span class="entity">code_thms</span><span class="main">)</span>
     <span class="entity">lthy</span><span class="main">;</span>

<span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">lthy</span>
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prepare_code_thms_cmd</span> <span class="entity">names</span> <span class="entity">thm</span> <span class="entity">lthy</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">name_of</span> <span class="main">(</span>Const <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">n</span> 
    <span class="main">|</span> <span class="entity">name_of</span> <span class="main">(</span>Free <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">n</span>
    <span class="main">|</span> <span class="entity">name_of</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> <span class="main">(</span>THM <span class="main">(</span><span class="inner_quoted">"No definitional theorem"</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">,</span><span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">lhs</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">thm</span> |&gt; Thm.prop_of |&gt; Logic.dest_equals<span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">basename</span> <span class="main">=</span> <span class="entity">lhs</span> |&gt; strip_comb |&gt; <span class="main">#</span><span class="inner_numeral">1</span> 
    |&gt; <span class="entity">name_of</span> 
    |&gt; Long_Name.base_name<span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">exs_tab</span> <span class="main">=</span> extractions.get <span class="main">(</span>Context.Proof <span class="entity">lthy</span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_exs</span> <span class="entity">name</span> <span class="main">=</span> 
    <span class="keyword2"><span class="keyword">case</span></span> Symtab.lookup <span class="entity">exs_tab</span> <span class="entity">name</span> <span class="keyword2"><span class="keyword">of</span></span>
      NONE <span class="main">=&gt;</span> error <span class="main">(</span><span class="inner_quoted">"No such extraction mode: "</span> ^ <span class="entity">name</span><span class="main">)</span>
    <span class="main">|</span> SOME <span class="entity">exs</span> <span class="main">=&gt;</span> <span class="entity">exs</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">exs</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">names</span> <span class="keyword2"><span class="keyword">of</span></span> 
    <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> Symtab.dest_list <span class="entity">exs_tab</span> |&gt; map <span class="main">#</span><span class="inner_numeral">2</span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> map <span class="entity">get_exs</span> <span class="entity">names</span> |&gt; flat

  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">exs</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> error <span class="inner_quoted">"No extraction patterns selected"</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">)</span>
  
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lthy</span> <span class="main">=</span> <span class="entity">extract_recursion_eqs</span> <span class="entity">exs</span> <span class="entity">basename</span> <span class="entity">thm</span> <span class="entity">lthy</span>
<span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">lthy</span>
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">extract_concrete_fun</span> <span class="main">_</span> <span class="main">[</span><span class="main">]</span> <span class="entity">concl</span> <span class="main">=</span> 
  <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"Conclusion does not match any extraction pattern"</span><span class="main">,</span><span class="main">[</span><span class="entity">concl</span><span class="main">]</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">extract_concrete_fun</span> <span class="entity">thy</span> <span class="main">(</span><span class="entity">pat</span>::<span class="entity">pats</span><span class="main">)</span> <span class="entity">concl</span> <span class="main">=</span> <span class="main">(</span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">Refine_Util.fo_matchp</span> <span class="entity">thy</span> <span class="entity">pat</span> <span class="entity">concl</span> <span class="keyword2"><span class="keyword">of</span></span>
        NONE <span class="main">=&gt;</span> <span class="entity">extract_concrete_fun</span> <span class="entity">thy</span> <span class="entity">pats</span> <span class="entity">concl</span>
        <span class="main">|</span> SOME <span class="main">[</span><span class="entity">t</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">t</span>
        <span class="main">|</span> SOME <span class="main">(</span><span class="entity">t</span>::<span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>
          warning <span class="main">(</span><span class="inner_quoted">"concrete_definition: Pattern has multiple holes, taking "</span>
            ^ <span class="inner_quoted">"first one: "</span> ^ <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">make_string</span><span class="antiquote">}</span></span></span></span> <span class="entity">pat</span>
          <span class="main">)</span><span class="main">;</span> <span class="entity">t</span><span class="main">)</span>
        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">(</span>warning <span class="main">(</span><span class="inner_quoted">"concrete_definition: Ignoring invalid pattern "</span> 
             ^ <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">make_string</span><span class="antiquote">}</span></span></span></span> <span class="entity">pat</span><span class="main">)</span><span class="main">;</span>
             <span class="entity">extract_concrete_fun</span> <span class="entity">thy</span> <span class="entity">pats</span> <span class="entity">concl</span><span class="main">)</span>
    <span class="main">)</span>


<span class="comment1">(* Define concrete function from refinement lemma *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">define_concrete_fun</span> <span class="entity">gen_code</span> <span class="entity">fun_name</span> <span class="entity">attribs_raw</span> <span class="entity">param_names</span> <span class="entity">thm</span> <span class="entity">pats</span>
  <span class="main">(</span><span class="entity">orig_lthy</span><span class="main">:</span>local_theory<span class="main">)</span> <span class="main">=</span> 
<span class="keyword2"><span class="keyword">let</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lthy</span> <span class="main">=</span> <span class="entity">orig_lthy</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">inst</span><span class="main">,</span><span class="entity">thm'</span><span class="main">)</span><span class="main">,</span><span class="entity">lthy</span><span class="main">)</span> <span class="main">=</span> <span class="entity">yield_singleton2</span> <span class="main">(</span>Variable.import true<span class="main">)</span> <span class="entity">thm</span> <span class="entity">lthy</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">concl</span> <span class="main">=</span> <span class="entity">thm'</span> |&gt; Thm.concl_of

  <span class="comment1">(*val ((typ_subst,term_subst),lthy) 
    = Variable.import_inst true [concl] lthy;
  val concl = Term_Subst.instantiate (typ_subst,term_subst) concl;
  *)</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">term_subst</span> <span class="main">=</span> <span class="main">#</span><span class="inner_numeral">2</span> <span class="entity">inst</span> |&gt; map <span class="main">(</span>apsnd Thm.term_of<span class="main">)</span> 

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">param_terms</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">name</span> <span class="main">=&gt;</span>
    <span class="keyword2"><span class="keyword">case</span></span> AList.lookup <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="entity">v</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">n</span> <span class="main">=</span> <span class="main">#</span><span class="inner_numeral">1</span> <span class="entity">v</span><span class="main">)</span> <span class="entity">term_subst</span> <span class="entity">name</span> <span class="keyword2"><span class="keyword">of</span></span>
      NONE <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"No such variable: "</span>
                           ^Term.string_of_vname <span class="entity">name</span><span class="main">,</span><span class="main">[</span><span class="entity">concl</span><span class="main">]</span><span class="main">)</span>
    <span class="main">|</span> SOME <span class="entity">t</span> <span class="main">=&gt;</span> <span class="entity">t</span>
  <span class="main">)</span> <span class="entity">param_names</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">f_term</span> <span class="main">=</span> <span class="entity">extract_concrete_fun</span> <span class="main">(</span>Proof_Context.theory_of <span class="entity">lthy</span><span class="main">)</span> <span class="entity">pats</span> <span class="entity">concl</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lhs_type</span> <span class="main">=</span> map Term.fastype_of <span class="entity">param_terms</span> ---&gt; Term.fastype_of <span class="entity">f_term</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lhs_term</span> 
    <span class="main">=</span> list_comb <span class="main">(</span><span class="main">(</span>Free <span class="main">(</span>Binding.name_of <span class="entity">fun_name</span><span class="main">,</span><span class="entity">lhs_type</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="entity">param_terms</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">def_term</span> <span class="main">=</span> Logic.mk_equals <span class="main">(</span><span class="entity">lhs_term</span><span class="main">,</span><span class="entity">f_term</span><span class="main">)</span> 
    |&gt; fold Logic.all <span class="entity">param_terms</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">attribs</span> <span class="main">=</span> map <span class="main">(</span><span class="entity">Attrib.check_src</span> <span class="entity">lthy</span><span class="main">)</span> <span class="entity">attribs_raw</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">def_thm</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="entity">lthy</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Specification.definition</span> 
    <span class="main">(</span>SOME <span class="main">(</span><span class="entity">fun_name</span><span class="main">,</span>NONE<span class="main">,</span>Mixfix.NoSyn<span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="main">(</span><span class="main">(</span>Binding.empty<span class="main">,</span><span class="entity">attribs</span><span class="main">)</span><span class="main">,</span><span class="entity">def_term</span><span class="main">)</span> <span class="entity">lthy</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">folded_thm</span> <span class="main">=</span> Local_Defs.fold <span class="entity">lthy</span> <span class="main">[</span><span class="entity">def_thm</span><span class="main">]</span> <span class="entity">thm'</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">lthy</span><span class="main">)</span> 
    <span class="main">=</span> Local_Theory.note 
       <span class="main">(</span><span class="main">(</span><span class="entity">mk_qualified</span> <span class="main">(</span>Binding.name_of <span class="entity">fun_name</span><span class="main">)</span> <span class="inner_quoted">"refine"</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span><span class="main">[</span><span class="entity">folded_thm</span><span class="main">]</span><span class="main">)</span> 
       <span class="entity">lthy</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lthy</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">gen_code</span> <span class="keyword2"><span class="keyword">of</span></span>
    NONE <span class="main">=&gt;</span> <span class="entity">lthy</span>
  <span class="main">|</span> SOME <span class="entity">modes</span> <span class="main">=&gt;</span> 
      <span class="entity">extract_recursion_eqs</span> <span class="entity">modes</span> <span class="main">(</span>Binding.name_of <span class="entity">fun_name</span><span class="main">)</span> <span class="entity">def_thm</span> <span class="entity">lthy</span>

<span class="keyword2"><span class="keyword">in</span></span>
  <span class="main">(</span><span class="main">(</span><span class="entity">def_thm</span><span class="main">,</span><span class="entity">folded_thm</span><span class="main">)</span><span class="main">,</span><span class="entity">lthy</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>



  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cd_pat_eq</span> <span class="main">=</span> apply2 <span class="main">(</span>Thm.term_of #&gt; <span class="entity">Refine_Util.anorm_term</span><span class="main">)</span> #&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> aconv<span class="main">)</span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">cd_patterns</span> <span class="main">=</span> Generic_Data <span class="main">(</span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> cterm list
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">merge</span> <span class="main">=</span> merge <span class="entity">cd_pat_eq</span>
  <span class="main">)</span> 

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prepare_cd_pattern</span> <span class="entity">ctxt</span> <span class="entity">pat</span> <span class="main">=</span> 
    <span class="keyword2"><span class="keyword">case</span></span> Thm.term_of <span class="entity">pat</span> |&gt; fastype_of <span class="keyword2"><span class="keyword">of</span></span>
      <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">bool</span><span class="antiquote">}</span></span> <span class="main">=&gt;</span> 
        Thm.term_of <span class="entity">pat</span> 
        |&gt; <span class="entity">HOLogic.mk_Trueprop</span> 
        |&gt; Thm.cterm_of <span class="entity">ctxt</span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">pat</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_cd_pattern</span> <span class="entity">pat</span> <span class="entity">context</span> <span class="main">=</span> 
    cd_patterns.map <span class="main">(</span>insert <span class="entity">cd_pat_eq</span> <span class="main">(</span><span class="entity">prepare_cd_pattern</span> <span class="main">(</span>Context.proof_of <span class="entity">context</span><span class="main">)</span> <span class="entity">pat</span><span class="main">)</span><span class="main">)</span> <span class="entity">context</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">del_cd_pattern</span> <span class="entity">pat</span> <span class="entity">context</span> <span class="main">=</span> 
    cd_patterns.map <span class="main">(</span>remove <span class="entity">cd_pat_eq</span> <span class="main">(</span><span class="entity">prepare_cd_pattern</span> <span class="main">(</span>Context.proof_of <span class="entity">context</span><span class="main">)</span> <span class="entity">pat</span><span class="main">)</span><span class="main">)</span> <span class="entity">context</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">get_cd_patterns</span> <span class="main">=</span> cd_patterns.get o Context.Proof


    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">rec_thms</span> <span class="main">=</span> <span class="entity">Named_Thms</span> <span class="main">(</span> 
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> vcs_rec<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"VC-Solver: Recursive intro rules"</span>
    <span class="main">)</span>

    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">solve_thms</span> <span class="main">=</span> <span class="entity">Named_Thms</span> <span class="main">(</span> 
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> vcs_solve<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"VC-Solver: Solve rules"</span>
    <span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">add_vc_rec_thm</span> <span class="main">=</span> <span class="entity">rec_thms.add_thm</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">del_vc_rec_thm</span> <span class="main">=</span> <span class="entity">rec_thms.del_thm</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">get_vc_rec_thms</span> <span class="main">=</span> <span class="entity">rec_thms.get</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">add_vc_solve_thm</span> <span class="main">=</span> <span class="entity">solve_thms.add_thm</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">del_vc_solve_thm</span> <span class="main">=</span> <span class="entity">solve_thms.del_thm</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">get_vc_solve_thms</span> <span class="main">=</span> <span class="entity">solve_thms.get</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rec_modifiers</span> <span class="main">=</span> <span class="main">[</span>
      Args.$$$ <span class="inner_quoted">"rec"</span> -- Scan.option Args.add -- Args.colon 
        &gt;&gt; K <span class="main">(</span><span class="entity">Method.modifier</span> <span class="entity">rec_thms.add</span> <span class="antiquoted"><span class="operator"><span class="entity">⌂</span></span></span><span class="main">)</span><span class="main">,</span>
      Args.$$$ <span class="inner_quoted">"rec"</span> -- Scan.option Args.del -- Args.colon 
        &gt;&gt; K <span class="main">(</span><span class="entity">Method.modifier</span> <span class="entity">rec_thms.del</span> <span class="antiquoted"><span class="operator"><span class="entity">⌂</span></span></span><span class="main">)</span>
    <span class="main">]</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">solve_modifiers</span> <span class="main">=</span> <span class="main">[</span>
      Args.$$$ <span class="inner_quoted">"solve"</span> -- Scan.option Args.add -- Args.colon 
        &gt;&gt; K <span class="main">(</span><span class="entity">Method.modifier</span> <span class="entity">solve_thms.add</span> <span class="antiquoted"><span class="operator"><span class="entity">⌂</span></span></span><span class="main">)</span><span class="main">,</span>
      Args.$$$ <span class="inner_quoted">"solve"</span> -- Scan.option Args.del -- Args.colon 
        &gt;&gt; K <span class="main">(</span><span class="entity">Method.modifier</span> <span class="entity">solve_thms.del</span> <span class="antiquoted"><span class="operator"><span class="entity">⌂</span></span></span><span class="main">)</span>
    <span class="main">]</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vc_solve_modifiers</span> <span class="main">=</span> 
      <span class="entity">clasimp_modifiers</span> @ <span class="entity">rec_modifiers</span> @ <span class="entity">solve_modifiers</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">vc_solve_tac</span> <span class="entity">ctxt</span> <span class="entity">no_pre</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rthms</span> <span class="main">=</span> <span class="entity">rec_thms.get</span> <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sthms</span> <span class="main">=</span> <span class="entity">solve_thms.get</span> <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pre_tac</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">no_pre</span> <span class="keyword2"><span class="keyword">then</span></span> K all_tac <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">clarsimp_tac</span> <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tac</span> <span class="main">=</span> SELECT_GOAL <span class="main">(</span><span class="entity">auto_tac</span> <span class="entity">ctxt</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      TRY o <span class="entity">pre_tac</span>
      <span class="entity">THEN_ALL_NEW_FWD</span> <span class="main">(</span>TRY o <span class="entity">REPEAT_ALL_NEW_FWD</span> <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="entity">rthms</span><span class="main">)</span><span class="main">)</span>
      <span class="entity">THEN_ALL_NEW_FWD</span> <span class="main">(</span>TRY o SOLVED' <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="entity">sthms</span> <span class="entity">THEN_ALL_NEW_FWD</span> <span class="entity">tac</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">setup</span> <span class="main">=</span> I
      #&gt; <span class="entity">rec_thms.setup</span> 
      #&gt; <span class="entity">solve_thms.setup</span>


<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
›</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="entity">Refine_Automation.setup</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_cpat</span> <span class="entity">cxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> 
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span> <span class="main">(</span><span class="entity">context</span><span class="main">,</span> <span class="entity">tks</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Scan.lift Args.embedded_inner_syntax <span class="entity">cxt</span> 
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Context.proof_of <span class="entity">context</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> Proof_Context.read_term_pattern <span class="entity">ctxt</span> <span class="entity">t</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="main">(</span>Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">t</span><span class="main">,</span> <span class="main">(</span><span class="entity">context</span><span class="main">,</span> <span class="entity">tks</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">do_p</span> <span class="entity">f</span> <span class="main">=</span> Scan.repeat1 <span class="entity">parse_cpat</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">pats</span> <span class="main">=&gt;</span> 
        Thm.declaration_attribute <span class="main">(</span>K <span class="main">(</span>fold <span class="entity">f</span> <span class="entity">pats</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">Attrib.setup</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> "cd_patterns"<span class="antiquote">}</span></span></span> <span class="main">(</span>
       Scan.lift Args.add |-- <span class="entity">do_p</span> <span class="entity">Refine_Automation.add_cd_pattern</span>
    || Scan.lift Args.del |-- <span class="entity">do_p</span> <span class="entity">Refine_Automation.del_cd_pattern</span>
    || <span class="entity">do_p</span> <span class="entity">Refine_Automation.add_cd_pattern</span>
    <span class="main">)</span>
      <span class="inner_quoted">"Add/delete concrete_definition pattern"</span>
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>


<span class="comment1">(* Command setup *)</span>

<span class="comment1">(* TODO: Folding of .refine-lemma seems not to work, if the function has
  parameters on which it does not depend *)</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="entity">Outer_Syntax.local_theory</span> 
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">concrete_definition</span><span class="antiquote">}</span></span></span> 
  <span class="inner_quoted">"Define function from refinement theorem"</span> 
  <span class="main">(</span>Parse.binding 
    -- Parse.opt_attribs
    -- Scan.optional <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">for</span>"<span class="antiquote">}</span></span></span> |-- Scan.repeat1 Args.var<span class="main">)</span> <span class="main">[</span><span class="main">]</span>
    --| <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">uses</span>"<span class="antiquote">}</span></span></span> -- Parse.thm
    -- Scan.optional <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">is</span>"<span class="antiquote">}</span></span></span> |-- Scan.repeat1 Args.embedded_inner_syntax<span class="main">)</span> <span class="main">[</span><span class="main">]</span>
  &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">attribs</span><span class="main">)</span><span class="main">,</span><span class="entity">params</span><span class="main">)</span><span class="main">,</span><span class="entity">raw_thm</span><span class="main">)</span><span class="main">,</span><span class="entity">pats</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">lthy</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">Attrib.eval_thms</span> <span class="entity">lthy</span> <span class="main">[</span><span class="entity">raw_thm</span><span class="main">]</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="main">[</span><span class="entity">thm</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">thm</span>
        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> error <span class="inner_quoted">"Expecting exactly one theorem"</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pats</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">pats</span> <span class="keyword2"><span class="keyword">of</span></span> 
      <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">Refine_Automation.get_cd_patterns</span> <span class="entity">lthy</span>
    <span class="main">|</span> <span class="entity">l</span> <span class="main">=&gt;</span> map <span class="main">(</span>Proof_Context.read_term_pattern <span class="entity">lthy</span> #&gt; Thm.cterm_of <span class="entity">lthy</span> #&gt;
        <span class="entity">Refine_Automation.prepare_cd_pattern</span> <span class="entity">lthy</span><span class="main">)</span> <span class="entity">l</span>

  <span class="keyword2"><span class="keyword">in</span></span> 
    <span class="entity">Refine_Automation.define_concrete_fun</span> 
      NONE <span class="entity">name</span> <span class="entity">attribs</span> <span class="entity">params</span> <span class="entity">thm</span> <span class="entity">pats</span> <span class="entity">lthy</span> 
    |&gt; snd
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">)</span>
›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Command: 
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>concrete_definition name [attribs] for params uses thm is patterns›</span></span></span></span>
  where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>attribs›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>for›</span></span></span></span>, and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>is›</span></span></span></span>-parts are optional.

  Declares a new constant <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>name›</span></span></span></span> by matching the theorem <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>thm›</span></span></span></span> 
  against a pattern.
  
  If the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>for›</span></span></span></span> clause is given, it lists variables in the theorem, 
  and thus determines the order of parameters of the defined constant. Otherwise,
  parameters will be in order of occurrence.

  If the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>is›</span></span></span></span> clause is given, it lists patterns. The conclusion of the
  theorem will be matched against each of these patterns. For the first matching
  pattern, the constant will be declared to be the term that matches the first
  non-dummy variable of the pattern. If no <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>is›</span></span></span></span>-clause is specified,
  the default patterns will be tried.

  Attribute: <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>cd_patterns pats›</span></span></span></span>. Declaration attribute. Declares
    default patterns for the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>concrete_definition›</span></span></span></span> command.
  
›</span></span>


<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span> <span class="operator">cd_patterns</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="var"><span class="var"><span class="var"><span class="var">?f</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">∈</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span>"</span></span></span></span></span><span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span> <span class="operator">cd_patterns</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"RETURN <span class="var"><span class="var"><span class="var"><span class="var">?f</span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main">≤</span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span>"</span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"nres_of <span class="var"><span class="var"><span class="var"><span class="var">?f</span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main">≤</span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span>"</span></span></span></span></span><span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span> <span class="operator">cd_patterns</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>RETURN <span class="var"><span class="var"><span class="var"><span class="var">?f</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">∈</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span>"</span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>nres_of <span class="var"><span class="var"><span class="var"><span class="var">?f</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">∈</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span>"</span></span></span></span></span><span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span> <span class="operator">cd_patterns</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="var"><span class="var"><span class="var"><span class="var">?f</span></span></span></span>"</span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main">==</span></span></span></span> <span class="var"><span class="var"><span class="var"><span class="var">?f</span></span></span></span>"</span></span></span></span></span> <span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">modes</span> <span class="main">=</span> <span class="main">(</span>Scan.optional
     <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">(</span>"<span class="antiquote">}</span></span></span> |-- Parse.list1 Parse.name --| <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">)</span>"<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">Outer_Syntax.local_theory</span> 
    <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">prepare_code_thms</span><span class="antiquote">}</span></span></span> 
    <span class="inner_quoted">"Refinement framework: Prepare theorems for code generation"</span> 
    <span class="main">(</span><span class="entity">modes</span> -- Parse.thms1
      &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">modes</span><span class="main">,</span><span class="entity">raw_thms</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">lthy</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thms</span> <span class="main">=</span> <span class="entity">Attrib.eval_thms</span> <span class="entity">lthy</span> <span class="entity">raw_thms</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        fold <span class="main">(</span><span class="entity">Refine_Automation.prepare_code_thms_cmd</span> <span class="entity">modes</span><span class="main">)</span> <span class="entity">thms</span> <span class="entity">lthy</span>
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
    <span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Command: 
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>prepare_code_thms (modes) thm›</span></span></span></span>
  where the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(mode)›</span></span></span></span>-part is optional.

  Set up code-equations for recursions in constant defined by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>thm›</span></span></span></span>.
  The optional <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>modes›</span></span></span></span> is a comma-separated list of extraction modes.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_code_thm_RECT<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≡</span> RECT <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≡</span> <span class="free">B</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> D
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> RECT_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> M<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gen_code_thm_REC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≡</span> REC <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≡</span> <span class="free">B</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> D
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> REC_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> M<span class="main">)</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹
  <span class="entity">Refine_Automation.add_extraction</span> <span class="inner_quoted">"nres"</span> <span class="main">{</span>
    pattern <span class="main">=</span> Logic.varify_global <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"REC <span class="free">x</span>"</span><span class="antiquote">}</span></span><span class="main">,</span>
    gen_thm <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> gen_code_thm_REC<span class="antiquote">}</span></span></span><span class="main">,</span>
    gen_tac <span class="main">=</span> <span class="entity">Refine_Mono_Prover.mono_tac</span>
  <span class="main">}</span>
  #&gt; 
  <span class="entity">Refine_Automation.add_extraction</span> <span class="inner_quoted">"nres"</span> <span class="main">{</span>
    pattern <span class="main">=</span> Logic.varify_global <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"RECT <span class="free">x</span>"</span><span class="antiquote">}</span></span><span class="main">,</span>
    gen_thm <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> gen_code_thm_RECT<span class="antiquote">}</span></span></span><span class="main">,</span>
    gen_tac <span class="main">=</span> <span class="entity">Refine_Mono_Prover.mono_tac</span>
  <span class="main">}</span>
›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Method <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>vc_solve (no_pre) clasimp_modifiers
    rec (add/del): ... solve (add/del): ...›</span></span></span></span>
  Named theorems <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>vcs_rec›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>vcs_solve›</span></span></span></span>.

  This method is specialized to
  solve verification conditions. It first clarsimps all goals, then
  it tries to apply a set of safe introduction rules (<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>vcs_rec›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rec add›</span></span></span></span>).
  Finally, it applies introduction rules (<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>vcs_solve›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>solve add›</span></span></span></span>) and tries
  to discharge all emerging subgoals by auto. If this does not succeed, it
  backtracks over the application of the solve-rule.
›</span></span>

<span class="keyword1"><span class="command">method_setup</span></span> vc_solve <span class="main">=</span> 
  <span class="quoted">‹Scan.lift <span class="main">(</span>Args.mode <span class="inner_quoted">"nopre"</span><span class="main">)</span> 
      --| <span class="entity">Method.sections</span> <span class="entity">Refine_Automation.vc_solve_modifiers</span> &gt;&gt;
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">nopre</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD</span> <span class="main">(</span>
    CHANGED <span class="main">(</span>ALLGOALS <span class="main">(</span><span class="entity">Refine_Automation.vc_solve_tac</span> <span class="entity">ctxt</span> <span class="entity">nopre</span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span><span class="main">)</span>›</span> <span class="quoted">"Try to solve verification conditions"</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Autoref_Monadic">
<div class="head">
<h1>Theory Autoref_Monadic</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Autoref for the Refinement Monad"</span></span>
<span class="keyword1"><span class="command">theory</span></span> Autoref_Monadic
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Refine_Transfer.html">Refine_Transfer</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Default setup of the autoref-tool for the monadic framework.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> autoref_monadicI1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="free">c</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RETURN <span class="free">c</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="free">c</span> <span class="main">≤</span><span class="main">⇓</span><span class="free">R</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> nres_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> autoref_monadicI2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nres_of <span class="free">c</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nres_of <span class="free">c</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span> <span class="quoted"><span class="quoted">"nres_of <span class="free">c</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> nres_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemmas</span></span> autoref_monadicI <span class="main">=</span> autoref_monadicI1 autoref_monadicI2

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Autoref_Monadic</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cfg_plain</span> <span class="main">=</span> <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_plain<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">autoref_monadic_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword3"><span class="keyword">open</span></span> Autoref_Tacticals
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">Autoref_Phases.init_data</span> <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">plain</span> <span class="main">=</span> Config.get <span class="entity">ctxt</span> <span class="entity">cfg_plain</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">trans_thms</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">plain</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> the_resI<span class="antiquote">}</span></span></span>
  
    <span class="keyword2"><span class="keyword">in</span></span>
      resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> autoref_monadicI<span class="antiquote">}</span></span></span>
      THEN' 
      <span class="entity">IF_SOLVED</span> <span class="main">(</span><span class="entity">Autoref_Phases.all_phases_tac</span> <span class="entity">ctxt</span><span class="main">)</span>
        <span class="main">(</span><span class="entity">RefineG_Transfer.post_transfer_tac</span> <span class="entity">trans_thms</span> <span class="entity">ctxt</span><span class="main">)</span>
        <span class="main">(</span>K all_tac<span class="main">)</span> <span class="comment1">(* Autoref failed *)</span>

    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">method_setup</span></span> autoref_monadic <span class="main">=</span> <span class="quoted">‹<span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword3"><span class="keyword">open</span></span> Refine_Util Autoref_Monadic
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">autoref_flags</span> <span class="main">=</span> 
          <span class="entity">parse_bool_config</span> <span class="inner_quoted">"trace"</span> <span class="entity">Autoref_Phases.cfg_trace</span>
      ||  <span class="entity">parse_bool_config</span> <span class="inner_quoted">"debug"</span> <span class="entity">Autoref_Phases.cfg_debug</span>
      ||  <span class="entity">parse_bool_config</span> <span class="inner_quoted">"plain"</span> <span class="entity">Autoref_Monadic.cfg_plain</span>

  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">parse_paren_lists</span> <span class="entity">autoref_flags</span> 
    &gt;&gt;
    <span class="main">(</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span>
      <span class="keyword2"><span class="keyword">let</span></span> 
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Config.put <span class="entity">Autoref_Phases.cfg_keep_goal</span> true <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">autoref_monadic_tac</span> <span class="entity">ctxt</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">)</span><span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>

›</span> 
 <span class="quoted">"Automatic Refinement and Determinization for the Monadic Refinement Framework"</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Refine_Monadic">
<div class="head">
<h1>Theory Refine_Monadic</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Refinement Framework›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Refine_Monadic
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="Refine_Chapter.html">Refine_Chapter</a>
  <a href="Refine_Basic.html">Refine_Basic</a> 
  <a href="Refine_Leof.html">Refine_Leof</a>
  <a href="Refine_Heuristics.html">Refine_Heuristics</a> 
  <a href="Refine_More_Comb.html">Refine_More_Comb</a>
  <a href="Refine_While.html">Refine_While</a> 
  <a href="Refine_Foreach.html">Refine_Foreach</a> 
  <a href="Refine_Transfer.html">Refine_Transfer</a>
  <a href="Refine_Pfun.html">Refine_Pfun</a>
  <a href="Refine_Automation.html">Refine_Automation</a>
  <a href="Autoref_Monadic.html">Autoref_Monadic</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    This theory summarizes all default theories of the refinement framework.
›</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Convenience Constructs›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">REC_annot</span> <span class="free"><span class="bound"><span class="entity">pre</span></span></span> <span class="free"><span class="bound"><span class="entity">post</span></span></span> <span class="free"><span class="bound"><span class="entity">body</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> 
    REC <span class="main">(</span><span class="main">λ</span><span class="bound">D</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pre</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> <span class="bound">r</span><span class="main">←</span><span class="free"><span class="bound"><span class="entity">body</span></span></span> <span class="bound">D</span> <span class="bound">x</span><span class="main">;</span> ASSERT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">post</span></span></span> <span class="bound">x</span> <span class="bound">r</span><span class="main">)</span><span class="main">;</span> RETURN <span class="bound">r</span><span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
  
  <span class="keyword1"><span class="command">theorem</span></span> REC_annot_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">body</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">pre</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">post</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> <span class="free">pre</span> <span class="bound">x</span><span class="main">⟧</span> 
            <span class="main">⟹</span> <span class="free">body</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">post</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="free">post</span> <span class="free">x</span> <span class="bound">r</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"REC_annot <span class="free">pre</span> <span class="free">post</span> <span class="free">body</span> <span class="free">x</span> <span class="main">≤</span> SPEC <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹trimono <span class="free">body</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">g</span> <span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> flat_ge <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> flat_ge <span class="main">(</span><span class="free">body</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">body</span> <span class="bound">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">g</span> <span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">body</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">body</span> <span class="bound">g</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">unfolding</span></span> trimono_def monotone_def fun_ord_def mono_def le_fun_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> REC_annot_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"SPEC <span class="main">(</span><span class="free">post</span> <span class="free">x</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> 
        <span class="dynamic"><span class="dynamic">refine_vcg</span></span> 
        REC_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pre<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">pre</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> SPEC <span class="main">(</span><span class="free">post</span> <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
        order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> S<span class="main"><span class="main">]</span></span>
      <span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntax Sugar›</span></span>
  <span class="keyword1"><span class="command">locale</span></span> Refine_Monadic_Syntax <span class="keyword2"><span class="keyword">begin</span></span>
  
    <span class="keyword1"><span class="command">notation</span></span> SPEC <span class="main">(</span><span class="keyword2"><span class="keyword">binder</span></span> <span class="quoted">"<span class="keyword1">spec</span> "</span> 10<span class="main">)</span>
    <span class="keyword1"><span class="command">notation</span></span> ASSERT <span class="main">(</span><span class="quoted">"<span class="keyword1">assert</span>"</span><span class="main">)</span>
    <span class="keyword1"><span class="command">notation</span></span> RETURN <span class="main">(</span><span class="quoted">"<span class="keyword1">return</span>"</span><span class="main">)</span>
    <span class="keyword1"><span class="command">notation</span></span> FOREACH <span class="main">(</span><span class="quoted">"<span class="keyword1">foreach</span>"</span><span class="main">)</span>
    <span class="keyword1"><span class="command">notation</span></span> WHILE <span class="main">(</span><span class="quoted">"<span class="keyword1">while</span>"</span><span class="main">)</span>
    <span class="keyword1"><span class="command">notation</span></span> WHILET <span class="main">(</span><span class="quoted">"<span class="keyword1">while<span class="hidden">⇩</span><sub>T</sub></span>"</span><span class="main">)</span>
    <span class="keyword1"><span class="command">notation</span></span> WHILEI <span class="main">(</span><span class="quoted">"<span class="keyword1">while⇗</span>_<span class="keyword1">⇖</span>"</span><span class="main">)</span>
    <span class="keyword1"><span class="command">notation</span></span> WHILET <span class="main">(</span><span class="quoted">"<span class="keyword1">while<span class="hidden">⇩</span><sub>T</sub></span>"</span><span class="main">)</span>
    <span class="keyword1"><span class="command">notation</span></span> WHILEIT <span class="main">(</span><span class="quoted">"<span class="keyword1">while<span class="hidden">⇩</span><sub>T</sub>⇗</span>_<span class="keyword1">⇖</span>"</span><span class="main">)</span>

    <span class="keyword1"><span class="command">notation</span></span> RECT <span class="main">(</span><span class="keyword2"><span class="keyword">binder</span></span> <span class="quoted">"<span class="keyword1">rec<span class="hidden">⇩</span><sub>T</sub></span> "</span> 10<span class="main">)</span>
    <span class="keyword1"><span class="command">notation</span></span> REC <span class="main">(</span><span class="keyword2"><span class="keyword">binder</span></span> <span class="quoted">"<span class="keyword1">rec</span> "</span> 10<span class="main">)</span>

    <span class="keyword1"><span class="command">notation</span></span> SELECT <span class="main">(</span><span class="keyword2"><span class="keyword">binder</span></span> <span class="quoted">"<span class="keyword1">select</span> "</span> 10<span class="main">)</span>
      
  <span class="keyword2"><span class="keyword">end</span></span>
    
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Example_Chapter">
<div class="head">
<h1>Theory Example_Chapter</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Examples›</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Example_Chapter
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This chapter contains some examples of using the Refinement Framework.
  Examples of how to use data refinement to collection data structures can
  be found in the examples directory of the Isabelle Collection Framework.
›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Breadth_First_Search">
<div class="head">
<h1>Theory Breadth_First_Search</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Breadth First Search›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Breadth_First_Search
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Refine_Monadic.html">../Refine_Monadic</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This is a slightly modified version of Task~5 of our submission to
  the VSTTE 2011 verification competition 
  (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">url</span></span> "https://sites.google.com/site/vstte2012/compet"<span class="antiquote"><span class="antiquote">}</span></span></span></span>). The task was to
  formalize a breadth-first-search algorithm.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  With Isabelle's locale-construct, we put ourselves into a context where 
  the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>succ›</span></span></span></span>-function is fixed. 
  We assume finitely branching graphs here, as our
  foreach-construct is only defined for finite sets.
›</span></span>
<span class="keyword1"><span class="command">locale</span></span> Graph <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">succ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> <span class="main">⇒</span> <span class="tfree">'vertex</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">succ</span> <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>


  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Distances in a Graph›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    We start over by defining the basic notions of paths and shortest paths.
›</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A path is expressed by the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>dist›</span></span></span></span>-predicate. Intuitively,
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>dist v d v'›</span></span></span></span> means that there is a path of length <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d›</span></span></span></span>
    between <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v'›</span></span></span></span>.

    The definition of the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>dist›</span></span></span></span>-predicate is done inductively, i.e.,
    as the least solution of the following constraints:
›</span></span>
  <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">dist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'vertex</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    dist_z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dist</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>
    dist_suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">dist</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">vh</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">∈</span> <span class="free">succ</span> <span class="free"><span class="bound"><span class="entity">vh</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">dist</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    Next, we define a predicate that expresses that the shortest path between
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v'›</span></span></span></span> has length <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d›</span></span></span></span>.
    This is the case if there is a path of length <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d›</span></span></span></span>, but there
    is no shorter path.
›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">min_dist</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">d</span><span class="main">.</span> dist <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">conn</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">d</span><span class="main">.</span> dist <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Properties›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    In this subsection, we prove some properties of paths.
›</span></span>

  <span class="keyword1"><span class="command">lemma</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> connI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="free">v</span> <span class="free">d</span> <span class="free">v'</span> <span class="main">⟹</span> conn <span class="free">v</span> <span class="free">v'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> connI_id<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"conn <span class="free">v</span> <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> connI_succ<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"conn <span class="free">v</span> <span class="free">v'</span> <span class="main">⟹</span> <span class="free">v''</span> <span class="main">∈</span> <span class="free">succ</span> <span class="free">v'</span> <span class="main">⟹</span> conn <span class="free">v</span> <span class="free">v''</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conn_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> dist_suc dist_z<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> min_distI2<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> conn <span class="free">v</span> <span class="free">v'</span> <span class="main">;</span> <span class="main">⋀</span><span class="bound">d</span><span class="main">.</span> <span class="main">⟦</span> dist <span class="free">v</span> <span class="bound">d</span> <span class="free">v'</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">d'</span><span class="main">.</span> dist <span class="free">v</span> <span class="bound">d'</span> <span class="free">v'</span> <span class="main">⟹</span> <span class="bound">d</span> <span class="main">≤</span> <span class="bound">d'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">d</span> <span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span>min_dist <span class="free">v</span> <span class="free">v'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> min_dist_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LeastI2_wellorder<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">Q</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">d</span><span class="main">.</span> dist <span class="free">v</span> <span class="bound">d</span> <span class="free">v'</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conn_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> someI<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> min_distI_eq<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> dist <span class="free">v</span> <span class="free">d</span> <span class="free">v'</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">d'</span><span class="main">.</span> dist <span class="free">v</span> <span class="bound">d'</span> <span class="free">v'</span> <span class="main">⟹</span> <span class="free">d</span> <span class="main">≤</span> <span class="bound">d'</span> <span class="main">⟧</span> <span class="main">⟹</span> min_dist <span class="free">v</span> <span class="free">v'</span> <span class="main">=</span> <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> min_distI2 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conn_def<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Two nodes are connected by a path of length <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>0›</span></span></span></span>, 
    iff they are equal.›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> dist_z_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="free">v</span> <span class="main">0</span> <span class="free">v'</span> <span class="main">⟷</span> <span class="free">v'</span><span class="main">=</span><span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> dist.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> dist.intros<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The same holds for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>min_dist›</span></span></span></span>, i.e., 
    the shortest path between two nodes has length <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>0›</span></span></span></span>, 
    iff these nodes are equal.›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> min_dist_z<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"min_dist <span class="free">v</span> <span class="free">v</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> min_distI2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> dist_z<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> min_dist_z_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"conn <span class="free">v</span> <span class="free">v'</span> <span class="main">⟹</span> min_dist <span class="free">v</span> <span class="free">v'</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">v'</span><span class="main">=</span><span class="free">v</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> min_distI2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> dist_z<span class="main">)</span>
    
  <span class="keyword1"><span class="command">lemma</span></span> min_dist_is_dist<span class="main">:</span> <span class="quoted"><span class="quoted">"conn <span class="free">v</span> <span class="free">v'</span> <span class="main">⟹</span> dist <span class="free">v</span> <span class="main">(</span>min_dist <span class="free">v</span> <span class="free">v'</span><span class="main">)</span> <span class="free">v'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> min_distI2<span class="main">)</span>
  <span class="keyword1"><span class="command">lemma</span></span> min_dist_minD<span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="free">v</span> <span class="free">d</span> <span class="free">v'</span> <span class="main">⟹</span> min_dist <span class="free">v</span> <span class="free">v'</span> <span class="main">≤</span> <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> min_distI2<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We also provide introduction and destruction rules for the
    pattern <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>min_dist v v' = Suc d›</span></span></span></span>.
›</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> min_dist_succ<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> conn <span class="free">v</span> <span class="free">v'</span><span class="main">;</span> <span class="free">v''</span> <span class="main">∈</span> <span class="free">succ</span> <span class="free">v'</span> <span class="main">⟧</span> <span class="main">⟹</span> min_dist <span class="free">v</span> <span class="free">v''</span> <span class="main">≤</span> Suc <span class="main">(</span>min_dist <span class="free">v</span> <span class="free">v'</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> min_distI2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> v'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">v'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> dist.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> min_dist_minD dist_suc<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> min_dist_suc<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"conn <span class="free">v</span> <span class="free">v'</span>"</span></span> <span class="quoted"><span class="quoted">"min_dist <span class="free">v</span> <span class="free">v'</span> <span class="main">=</span> Suc <span class="free">d</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v''</span><span class="main">.</span> conn <span class="free">v</span> <span class="bound">v''</span> <span class="main">∧</span> <span class="free">v'</span> <span class="main">∈</span> <span class="free">succ</span> <span class="bound">v''</span> <span class="main">∧</span> min_dist <span class="free">v</span> <span class="bound">v''</span> <span class="main">=</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> min_dist_is_dist<span class="main">[</span><span class="operator">OF</span> c<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min_dist <span class="free">v</span> <span class="free">v'</span> <span class="main">=</span> Suc <span class="free">d</span> <span class="main">⟶</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>dist_suc <span class="skolem">d'</span> <span class="skolem">v''</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> min_dist_succ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="skolem">v''</span></span> <span class="quoted"><span class="free">v'</span></span><span class="main">]</span> min_dist_minD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="skolem">v''</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> connI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> c <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    If there is a node with a shortest path of length <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d›</span></span></span></span>, 
    then, for any <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d'&lt;d›</span></span></span></span>, there is also a node with a shortest path
    of length <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d'›</span></span></span></span>.
›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> min_dist_less<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"conn <span class="free">src</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"min_dist <span class="free">src</span> <span class="free">v</span> <span class="main">=</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">&lt;</span> <span class="free">d</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v'</span><span class="main">.</span> conn <span class="free">src</span> <span class="bound">v'</span> <span class="main">∧</span> min_dist <span class="free">src</span> <span class="bound">v'</span> <span class="main">=</span> <span class="free">d'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">d</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> min_dist_suc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">src</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">=</span> <span class="skolem">d</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    Lemma <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>min_dist_less›</span></span></span></span> can be weakened to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d'≤d›</span></span></span></span>.
›</span></span>

  <span class="keyword1"><span class="command">corollary</span></span> min_dist_le<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"conn <span class="free">src</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">≤</span> min_dist <span class="free">src</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v'</span><span class="main">.</span> conn <span class="free">src</span> <span class="bound">v'</span> <span class="main">∧</span> min_dist <span class="free">src</span> <span class="bound">v'</span> <span class="main">=</span> <span class="free">d'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_dist_less<span class="main">[</span><span class="operator">OF</span> c<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"min_dist <span class="free">src</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="free">d'</span></span><span class="main">]</span> d' c
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_less<span class="main">)</span>
  
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    In our framework, it is convenient to annotate the invariants and 
    auxiliary assertions into the program. Thus, we have to define the
    invariants first.
›</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    The invariant for the outer loop is split into two parts:
    The first part already holds before 
    the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>if C={}›</span></span></span></span> check, the second part only holds again 
    at the end of the loop body.
›</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    The first part of the invariant, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>bfs_invar'›</span></span></span></span>,
    intuitively states the following:
    If the loop is not {\em break}ed, then we have:
    \begin{itemize}
      \item The next-node set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>N›</span></span></span></span> is a subset of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>V›</span></span></span></span>, and
        the destination node is not contained into <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>V-(C∪N)›</span></span></span></span>,
      \item all nodes in the current-node set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>C›</span></span></span></span> have a shortest
        path of length <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d›</span></span></span></span>,
      \item all nodes in the next-node set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>N›</span></span></span></span> have a shortest path
        of length <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d+1›</span></span></span></span>,
      \item all nodes in the visited set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>V›</span></span></span></span> have a shortest path
        of length at most <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d+1›</span></span></span></span>,
      \item all nodes with a path shorter than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d›</span></span></span></span> are already in 
        <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>V›</span></span></span></span>, and
      \item all nodes with a shortest path of length <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d+1›</span></span></span></span> are either
        in the next-node set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>N›</span></span></span></span>, or they are undiscovered successors
        of a node in the current-node set.
    \end{itemize}
    
    If the loop has been {\em break}ed, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d›</span></span></span></span> is the distance of the
    shortest path between <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>src›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>dst›</span></span></span></span>.
›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bfs_invar'</span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">V</span><span class="main">,</span><span class="bound">C</span><span class="main">,</span><span class="bound">N</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="main">¬</span><span class="bound">f</span> <span class="main">⟶</span> <span class="main">(</span>
      <span class="bound">N</span> <span class="main">⊆</span> <span class="bound">V</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">∉</span> <span class="bound">V</span> <span class="main">-</span> <span class="main">(</span><span class="bound">C</span> <span class="main">∪</span> <span class="bound">N</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">∈</span><span class="bound">C</span><span class="main">.</span> conn <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="bound">v</span> <span class="main">∧</span> min_dist <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">d</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">∈</span><span class="bound">N</span><span class="main">.</span> conn <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="bound">v</span> <span class="main">∧</span> min_dist <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="bound">v</span> <span class="main">=</span> Suc <span class="bound">d</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">∈</span><span class="bound">V</span><span class="main">.</span> conn <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="bound">v</span> <span class="main">∧</span> min_dist <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="bound">v</span> <span class="main">≤</span> Suc <span class="bound">d</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">.</span> conn <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="bound">v</span> <span class="main">∧</span> min_dist <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="bound">v</span> <span class="main">≤</span> <span class="bound">d</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">∈</span> <span class="bound">V</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">.</span> conn <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="bound">v</span> <span class="main">∧</span> min_dist <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="bound">v</span> <span class="main">=</span> Suc <span class="bound">d</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">∈</span> <span class="bound">N</span> <span class="main">∪</span> <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">succ</span><span class="main">`</span><span class="bound">C</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="bound">V</span><span class="main">)</span><span class="main">)</span>
    <span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
    <span class="bound">f</span> <span class="main">⟶</span> conn <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">∧</span> min_dist <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">=</span> <span class="bound">d</span>
    <span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    The second part of the invariant, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>empty_assm›</span></span></span></span>, just states 
    that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>C›</span></span></span></span> can only be empty if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>N›</span></span></span></span> is also empty.
›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">empty_assm</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">V</span><span class="main">,</span><span class="bound">C</span><span class="main">,</span><span class="bound">N</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">in</span>
    <span class="bound">C</span><span class="main">=</span><span class="main">{}</span> <span class="main">⟶</span> <span class="bound">N</span><span class="main">=</span><span class="main">{}</span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    Finally, we define the invariant of the outer loop, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>bfs_invar›</span></span></span></span>, 
    as the conjunction of both parts:
›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bfs_invar</span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> bfs_invar' <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">∧</span> 
    empty_assm <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    The invariant of the inner foreach-loop states that
    the successors that have already been processed (<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>succ v - it›</span></span></span></span>),
    have been added to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>V›</span></span></span></span> and have also been added to 
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>N'›</span></span></span></span> if they are not in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>V›</span></span></span></span>.
›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">FE_invar</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">V'</span><span class="main">,</span><span class="bound">N'</span><span class="main">)</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">in</span> 
    <span class="bound">V'</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">∪</span> <span class="main">(</span><span class="free">succ</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">it</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="bound">N'</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">∪</span> <span class="main">(</span><span class="main">(</span><span class="free">succ</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">it</span></span></span><span class="main">)</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Algorithm›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    The following algorithm is a straightforward transcription of the 
    algorithm given in the assignment to the monadic style featured by our 
    framework.
    We briefly explain the (mainly syntactic) differences:
    \begin{itemize}
      \item The initialization of the variables occur after the loop in
          our formulation. This is just a syntactic difference, as our loop
          construct has the form <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>WHILEI I c f σ<span class="hidden">⇩</span><sub>0</sub>›</span></span></span></span>, where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ<span class="hidden">⇩</span><sub>0</sub>›</span></span></span></span>
          is the initial state, and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>I›</span></span></span></span> is the loop invariant;
      \item We translated the textual specification 
        {\em remove one vertex <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>C›</span></span></span></span>} as accurately as
        possible: The statement <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v ← SPEC (λv. v∈C)›</span></span></span></span> 
        nondeterministically assigns a node from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>C›</span></span></span></span> to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>, 
        that is then removed in the next statement;
      \item In our monad, we have no notion of loop-breaking (yet). Hence we
        added an additional boolean variable <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> that indicates that
        the loop shall terminate. The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>RETURN›</span></span></span></span>-statements used in our
        program are the return-operator of the monad, and must not be mixed up
        with the return-statement given in the original program, that is 
        modeled by breaking the loop. The if-statement after the loop takes
        care to return the right value;
      \item We added an else-branch to the if-statement that checks
        whether we reached the destination node;
      \item We added an assertion of the first part of the invariant to the
        program text, moreover, we annotated invariants at the loops.
        We also added an assertion <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>w∉N›</span></span></span></span> into the inner loop. This
        is merely an optimization, that will allow us to implement the
        insert operation more efficiently;
      \item Each conditional branch in the loop body ends with a 
        <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>RETURN›</span></span></span></span>-statement. This is required by the monadic style;
      \item Failure is modeled by an option-datatype. The result 
        <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Some d›</span></span></span></span> means that the integer <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d›</span></span></span></span> is returned,
        the result <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>None›</span></span></span></span> means that a failure is returned.
    \end{itemize}
›</span></span>

  <span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\clearpage›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">bfs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> <span class="main">⇒</span> <span class="tfree">'vertex</span> <span class="main">⇒</span> 
    <span class="main">(</span>nat option nres<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">bfs</span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">d</span><span class="main">)</span> <span class="main">←</span> WHILEI <span class="main">(</span>bfs_invar <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">V</span><span class="main">,</span><span class="bound">C</span><span class="main">,</span><span class="bound">N</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span><span class="main">=</span>False <span class="main">∧</span> <span class="bound">C</span><span class="main">≠</span><span class="main">{}</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">V</span><span class="main">,</span><span class="bound">C</span><span class="main">,</span><span class="bound">N</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">v</span> <span class="main">←</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span><span class="main">∈</span><span class="bound">C</span><span class="main">)</span><span class="main">;</span> <span class="keyword1">let</span> <span class="bound">C</span> <span class="main">=</span> <span class="bound">C</span><span class="main">-</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span><span class="main">;</span>
        <span class="keyword1">if</span> <span class="bound">v</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="keyword1">then</span> RETURN <span class="main">(</span>True<span class="main">,</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span>
        <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">N</span><span class="main">)</span> <span class="main">←</span> FOREACHi <span class="main">(</span>FE_invar <span class="bound">V</span> <span class="bound">N</span> <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">succ</span> <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span> <span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">N</span><span class="main">)</span><span class="main">.</span> 
            <span class="keyword1">if</span> <span class="main">(</span><span class="bound">w</span><span class="main">∉</span><span class="bound">V</span><span class="main">)</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span> 
              ASSERT <span class="main">(</span><span class="bound">w</span><span class="main">∉</span><span class="bound">N</span><span class="main">)</span><span class="main">;</span>
              RETURN <span class="main">(</span>insert <span class="bound">w</span> <span class="bound">V</span><span class="main">,</span> insert <span class="bound">w</span> <span class="bound">N</span><span class="main">)</span> 
            <span class="main">}</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">N</span><span class="main">)</span>
          <span class="main">)</span> <span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">N</span><span class="main">)</span><span class="main">;</span>
          ASSERT <span class="main">(</span>bfs_invar' <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">V</span><span class="main">,</span><span class="bound">C</span><span class="main">,</span><span class="bound">N</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
          <span class="keyword1">if</span> <span class="main">(</span><span class="bound">C</span><span class="main">=</span><span class="main">{}</span><span class="main">)</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
            <span class="keyword1">let</span> <span class="bound">C</span><span class="main">=</span><span class="bound">N</span><span class="main">;</span> 
            <span class="keyword1">let</span> <span class="bound">N</span><span class="main">=</span><span class="main">{}</span><span class="main">;</span> 
            <span class="keyword1">let</span> <span class="bound">d</span><span class="main">=</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">;</span>
            RETURN <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">V</span><span class="main">,</span><span class="bound">C</span><span class="main">,</span><span class="bound">N</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span>
          <span class="main">}</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">V</span><span class="main">,</span><span class="bound">C</span><span class="main">,</span><span class="bound">N</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span>
        <span class="main">}</span>
      <span class="main">}</span><span class="main">)</span>
      <span class="main">(</span>False<span class="main">,</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">src</span></span></span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">src</span></span></span><span class="main">}</span><span class="main">,</span><span class="main">{}</span><span class="main">,</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span><span class="main">;</span>
    <span class="keyword1">if</span> <span class="bound">f</span> <span class="keyword1">then</span> RETURN <span class="main">(</span>Some <span class="bound">d</span><span class="main">)</span> <span class="keyword1">else</span> RETURN None
    <span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Verification Tasks"</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    In order to make the proof more readable, we have extracted the
    difficult verification conditions and proved them in separate lemmas.
    The other verification conditions are proved automatically by Isabelle/HOL
    during the proof of the main theorem.

    Due to the timing constraints of the competition, the verification 
    conditions are mostly proved in Isabelle's apply-style, that is faster
    to write for the experienced user, but harder to read by a human.

    Exemplarily, we formulated the last proof in the proof language 
    {\em Isar}, that allows one to write human-readable proofs and verify
    them with Isabelle/HOL.
›</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    The first part of the invariant is preserved if we take a node from 
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>C›</span></span></span></span>, and add its successors that are not in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>V›</span></span></span></span> to 
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>N›</span></span></span></span>.
    This is the verification condition for the assertion after the 
    foreach-loop.
›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> invar_succ_step<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bfs_invar' <span class="free">src</span> <span class="free">dst</span> <span class="main">(</span>False<span class="main">,</span> <span class="free">V</span><span class="main">,</span> <span class="free">C</span><span class="main">,</span> <span class="free">N</span><span class="main">,</span> <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">≠</span><span class="free">dst</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bfs_invar' <span class="free">src</span> <span class="free">dst</span> 
            <span class="main">(</span>False<span class="main">,</span> <span class="free">V</span> <span class="main">∪</span> <span class="free">succ</span> <span class="free">v</span><span class="main">,</span> <span class="free">C</span> <span class="main">-</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span><span class="main">,</span> <span class="free">N</span> <span class="main">∪</span> <span class="main">(</span><span class="free">succ</span> <span class="free">v</span> <span class="main">-</span> <span class="free">V</span><span class="main">)</span><span class="main">,</span> <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_use</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bfs_invar'_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 6 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff Diff_iff connI_succ le_SucE min_dist_succ<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 7 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff connI_succ min_dist_succ<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    The first part of the invariant is preserved if the 
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>if C={}›</span></span></span></span>-statement is executed.
    This is the verification condition for the 
    loop-invariant. Note that preservation of the second part of the 
    invariant is proven easily inside the main proof.
›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> invar_empty_step<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bfs_invar' <span class="free">src</span> <span class="free">dst</span> <span class="main">(</span>False<span class="main">,</span> <span class="free">V</span><span class="main">,</span> <span class="main">{}</span><span class="main">,</span> <span class="free">N</span><span class="main">,</span> <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bfs_invar' <span class="free">src</span> <span class="free">dst</span> <span class="main">(</span>False<span class="main">,</span> <span class="free">V</span><span class="main">,</span> <span class="free">N</span><span class="main">,</span> <span class="main">{}</span><span class="main">,</span> Suc <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_use</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bfs_invar'_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI impI allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_SucI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_SucE subsetD<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">v</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> min_dist_suc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">src</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">d</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 6 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_n_not_le_n<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The invariant holds initially.›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> invar_init<span class="main">:</span> <span class="quoted"><span class="quoted">"bfs_invar <span class="free">src</span> <span class="free">dst</span> <span class="main">(</span>False<span class="main">,</span> <span class="main">{</span><span class="free">src</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="free">src</span><span class="main">}</span><span class="main">,</span> <span class="main">{}</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bfs_invar_def bfs_invar'_def empty_assm_def<span class="main">)</span>
       <span class="main">(</span><span class="operator">metis</span> min_dist_suc min_dist_z_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The invariant is preserved if we break the loop.›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> invar_break<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bfs_invar <span class="free">src</span> <span class="free">dst</span> <span class="main">(</span>False<span class="main">,</span> <span class="free">V</span><span class="main">,</span> <span class="free">C</span><span class="main">,</span> <span class="free">N</span><span class="main">,</span> <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">dst</span><span class="main">∈</span><span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bfs_invar <span class="free">src</span> <span class="free">dst</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">{}</span><span class="main">,</span> <span class="main">{}</span><span class="main">,</span> <span class="main">{}</span><span class="main">,</span> <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> bfs_invar_def bfs_invar'_def empty_assm_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If we have {\em break}ed the loop, the invariant implies
    that we, indeed, returned the shortest path.›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> invar_final_succeed<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bfs_invar' <span class="free">src</span> <span class="free">dst</span> <span class="main">(</span>True<span class="main">,</span> <span class="free">V</span><span class="main">,</span> <span class="free">C</span><span class="main">,</span> <span class="free">N</span><span class="main">,</span> <span class="free">d</span><span class="main">)</span>"</span></span>  
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"min_dist <span class="free">src</span> <span class="free">dst</span> <span class="main">=</span> <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> bfs_invar'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If the loop terminated normally, there is no path between 
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>src›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>dst›</span></span></span></span>. 

    The lemma is formulated as deriving a contradiction from the fact
    that there is a path and the loop terminated normally.

    Note the proof language {\em Isar} that was used here.
    It allows one to write human-readable proofs in a theorem prover.
›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> invar_final_fail<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"conn <span class="free">src</span> <span class="free">dst</span>"</span></span> <span class="comment1">― ‹There is a path between 
      <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"src"</span><span class="antiquote">}</span></span> and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"dst"</span><span class="antiquote">}</span></span>.›</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> INV<span class="main">:</span> <span class="quoted"><span class="quoted">"bfs_invar' <span class="free">src</span> <span class="free">dst</span> <span class="main">(</span>False<span class="main">,</span> <span class="free">V</span><span class="main">,</span> <span class="main">{}</span><span class="main">,</span> <span class="main">{}</span><span class="main">,</span> <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹We make a case-distinction whether <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d'≤d›</span></span></span></span>:›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min_dist <span class="free">src</span> <span class="free">dst</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">∨</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> min_dist <span class="free">src</span> <span class="free">dst</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Due to the invariant, any node with a path of 
        length at most <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d›</span></span></span></span> is contained in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>V›</span></span></span></span>
›</span></span>
      <span class="keyword1"><span class="command">from</span></span> INV <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> conn <span class="free">src</span> <span class="bound">v</span> <span class="main">∧</span> min_dist <span class="free">src</span> <span class="bound">v</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">⟶</span> <span class="bound">v</span><span class="main">∈</span><span class="free">V</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> bfs_invar'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹This applies in the first case, hence we obtain that 
        <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>dst∈V›</span></span></span></span>›</span></span>
      <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"min_dist <span class="free">src</span> <span class="free">dst</span> <span class="main">≤</span> <span class="free">d</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> C <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">src</span> <span class="main">(</span>min_dist <span class="free">src</span> <span class="free">dst</span><span class="main">)</span> <span class="free">dst</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> min_dist_is_dist<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">dst</span><span class="main">∈</span><span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹However, as <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>C›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>N›</span></span></span></span> are empty, the invariant
        also implies that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>dst›</span></span></span></span> is not in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>V›</span></span></span></span>:›</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> INV <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">dst</span><span class="main">∉</span><span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bfs_invar'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹This yields a contradiction:›</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹In the case <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d+1 ≤ d'›</span></span></span></span>, we also obtain a node
        that has a shortest path of length <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d+1›</span></span></span></span>:›</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> min_dist <span class="free">src</span> <span class="free">dst</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> min_dist_le<span class="main">[</span><span class="operator">OF</span> C<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        <span class="quoted"><span class="quoted">"conn <span class="free">src</span> <span class="skolem">v'</span>"</span></span> <span class="quoted"><span class="quoted">"min_dist <span class="free">src</span> <span class="skolem">v'</span> <span class="main">=</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹However, the invariant states that such nodes are either in
        <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>N›</span></span></span></span> or are successors of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>C›</span></span></span></span>. As <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>N›</span></span></span></span> 
        and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>C›</span></span></span></span> are both empty, we again get a contradiction.›</span></span>
      <span class="keyword1"><span class="command">with</span></span> INV <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> bfs_invar'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    Finally, we prove our algorithm correct:
    The following theorem solves both verification tasks.

    Note that a proposition of the form <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S ⊑ SPEC Φ›</span></span></span></span> states partial 
    correctness in our framework, i.e., <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S›</span></span></span></span> refines the 
    specification <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Φ›</span></span></span></span>.

    The actual specification that we prove here
    precisely reflects the two verification tasks: {\em If the algorithm fails,
    there is no path between <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>src›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>dst›</span></span></span></span>, otherwise
    it returns the length of the shortest path.}

    The proof of this theorem first applies the verification condition 
    generator (<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>apply (intro refine_vcg)›</span></span></span></span>), and then uses the
    lemmas proved beforehand to discharge the verification conditions.
    During the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>auto›</span></span></span></span>-methods, some trivial verification conditions,
    e.g., those concerning the invariant of the inner loop, are discharged
    automatically.
    During the proof, we gradually unfold the definition of the loop
    invariant.
›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bfs_spec</span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">≡</span> SPEC <span class="main">(</span>
    <span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">r</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">¬</span> conn <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span>
              <span class="main">|</span> Some <span class="bound">d</span> <span class="main">⇒</span> conn <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">∧</span> min_dist <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">=</span> <span class="bound">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">theorem</span></span> bfs_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"bfs <span class="free">src</span> <span class="free">dst</span> <span class="main">≤</span> bfs_spec <span class="free">src</span> <span class="free">dst</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bfs_def bfs_spec_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">unfolding</span></span> FE_invar_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> invar_init invar_break <span class="main">)</span>

    <span class="keyword1"><span class="command">unfolding</span></span> bfs_invar_def 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> invar_succ_step invar_empty_step invar_final_succeed<span class="main">)</span>

    <span class="keyword1"><span class="command">unfolding</span></span> empty_assm_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> invar_final_fail<span class="main">)</span>

    <span class="keyword1"><span class="command">unfolding</span></span> bfs_invar'_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="WordRefine">
<div class="head">
<h1>Theory WordRefine</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Machine Words›</span></span>
<span class="keyword1"><span class="command">theory</span></span> WordRefine
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Refine_Monadic.html">../Refine_Monadic</a>"</span> <span class="quoted">"<a href="../../HOL/HOL-Library/Word.html">HOL-Library.Word</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory provides a simple example to show refinement of natural
  numbers to machine words. The setup is not yet very elaborated, but shows 
  the direction to go.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Setup›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">word_nat_rel</span> <span class="main">≡</span> build_rel <span class="main">(</span>unat<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> word_nat_RELEATES<span class="main">[</span><span class="operator">refine_dref_RELATES</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"RELATES word_nat_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RELATES_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"single_valued word_nat_rel"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> word_nat_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"single_valuedp <span class="main">(</span><span class="main">λ</span><span class="bound">c</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">=</span> unat <span class="bound">c</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedpI<span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span>converse word_nat_rel<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> injI<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_hsimp</span><span class="main">]</span> <span class="main">=</span> 
  word_less_nat_alt word_le_nat_alt unat_sub iffD1<span class="main">[</span><span class="operator">OF</span> unat_add_lem<span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Example›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> word32 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="numeral">32</span> word"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">test</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat set nres"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">test</span> <span class="free"><span class="bound"><span class="entity">x0</span></span></span> <span class="free"><span class="bound"><span class="entity">y0</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="keyword1">let</span> <span class="bound">S</span><span class="main">=</span><span class="main">{}</span><span class="main">;</span>
  <span class="main">(</span><span class="bound">S</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> WHILE <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">&gt;</span><span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="bound">S</span><span class="main">=</span><span class="bound">S</span><span class="main">∪</span><span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">x</span><span class="main">=</span><span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">;</span>
    ASSERT <span class="main">(</span><span class="bound">y</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">x0</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">y0</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">y</span><span class="main">=</span><span class="bound">y</span> <span class="main">+</span> <span class="main">1</span><span class="main">;</span>
    RETURN <span class="main">(</span><span class="bound">S</span><span class="main">,</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span>
  <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x0</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">y0</span></span></span><span class="main">)</span><span class="main">;</span>
  RETURN <span class="bound">S</span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">y0</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">⟹</span> test <span class="free">x0</span> <span class="free">y0</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">S</span><span class="main">.</span> <span class="bound">S</span><span class="main">=</span><span class="main">{</span><span class="free">y0</span> <span class="main">..</span> <span class="free">y0</span> <span class="main">+</span> <span class="free">x0</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="comment1">― ‹Choosen pre-condition to get least trouble when proving›</span>
  <span class="keyword1"><span class="command">unfolding</span></span> test_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> WHILE_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> 
    <span class="bound">x</span><span class="main">+</span><span class="bound">y</span><span class="main">=</span><span class="free">x0</span><span class="main">+</span><span class="free">y0</span> <span class="main">∧</span> <span class="bound">x</span><span class="main">≤</span><span class="free">x0</span> <span class="main">∧</span>
    <span class="bound">S</span><span class="main">=</span><span class="main">{</span><span class="free">y0</span> <span class="main">..</span> <span class="free">y0</span> <span class="main">+</span> <span class="main">(</span><span class="free">x0</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span> 
    <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">test_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"word32 <span class="main">⇒</span> word32 <span class="main">⇒</span> word32 set nres"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">test_impl</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="bound">S</span><span class="main">=</span><span class="main">{}</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">S</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> WHILE <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">&gt;</span><span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="keyword1">let</span> <span class="bound">S</span><span class="main">=</span><span class="bound">S</span><span class="main">∪</span><span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">;</span> 
      <span class="keyword1">let</span> <span class="bound">x</span><span class="main">=</span><span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">y</span><span class="main">=</span><span class="bound">y</span> <span class="main">+</span> <span class="main">1</span><span class="main">;</span>
      RETURN <span class="main">(</span><span class="bound">S</span><span class="main">,</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span>
    <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">;</span>
    RETURN <span class="bound">S</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> test_impl_refine<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x'</span><span class="main">+</span><span class="free">y'</span><span class="main">&lt;</span><span class="numeral">2</span><span class="main">^</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="numeral">32</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span>word_nat_rel"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">y'</span><span class="main">)</span><span class="main">∈</span>word_nat_rel"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"test_impl <span class="free">x</span> <span class="free">y</span> <span class="main">≤</span> <span class="main">⇓</span><span class="main">(</span><span class="main">⟨</span>word_nat_rel<span class="main">⟩</span>set_rel<span class="main">)</span> <span class="main">(</span>test <span class="free">x'</span> <span class="free">y'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> test_impl_def test_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_dref_type</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_hsimp</span></span> <span class="dynamic"><span class="dynamic">refine_rel_defs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Examples">
<div class="head">
<h1>Theory Examples</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Examples
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="Example_Chapter.html">Example_Chapter</a>
  <a href="Breadth_First_Search.html">Breadth_First_Search</a>
  <a href="WordRefine.html">WordRefine</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div>