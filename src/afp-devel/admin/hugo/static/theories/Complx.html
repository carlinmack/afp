<div id="Language">
<div class="head">
<h1>Theory Language</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright 2016, Data61, CSIRO
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(DATA61_BSD)
 *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The COMPLX Syntax›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Language
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Core Language›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We use a shallow embedding of boolean expressions as well as assertions
as sets of states. 
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'s</span> bexp <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'s</span> assn <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> com <span class="main">=</span>
    Skip
  <span class="main">|</span> Basic <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
  <span class="main">|</span> Spec <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> set"</span></span>
  <span class="main">|</span> Seq <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">,</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> com"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> com"</span></span>    
  <span class="main">|</span> Cond <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> bexp"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span>
  <span class="main">|</span> While <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> bexp"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span>
  <span class="main">|</span> Call <span class="quoted"><span class="quoted">"<span class="tfree">'p</span>"</span></span>
  <span class="main">|</span> DynCom <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span> 
  <span class="main">|</span> Guard <span class="quoted"><span class="quoted">"<span class="tfree">'f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> bexp"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span> 
  <span class="main">|</span> Throw
  <span class="main">|</span> Catch <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span>
  <span class="main">|</span> Parallel <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> com list"</span></span>
  <span class="main">|</span> Await <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> bexp"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derived Language Constructs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We inherit the remainder of derived language constructs from SIMPL›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">raise</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">raise</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Seq <span class="main">(</span>Basic <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> Throw"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">condCatch</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com <span class="main">⇒</span> <span class="tfree">'s</span> bexp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">condCatch</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> Catch <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">(</span>Cond <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> Throw<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">bind</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'v</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bind</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> DynCom <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">bseq</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bseq</span> <span class="main">=</span> Seq"</span></span>
 
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">block</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'s</span><span class="main">⇒</span><span class="tfree">'s</span> <span class="main">,</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com<span class="main">,</span><span class="tfree">'s</span><span class="main">⇒</span><span class="tfree">'s</span><span class="main">⇒</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'s</span><span class="main">⇒</span><span class="tfree">'s</span><span class="main">⇒</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com<span class="main">]</span><span class="main">⇒</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">block</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="free"><span class="bound"><span class="entity">bdy</span></span></span> <span class="free"><span class="bound"><span class="entity">restore</span></span></span> <span class="free"><span class="bound"><span class="entity">return</span></span></span> <span class="main">=</span>
    DynCom <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span>Seq <span class="main">(</span>Catch <span class="main">(</span>Seq <span class="main">(</span>Basic <span class="free"><span class="bound"><span class="entity">init</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bdy</span></span></span><span class="main">)</span> <span class="main">(</span>Seq <span class="main">(</span>Basic <span class="main">(</span><span class="free"><span class="bound"><span class="entity">restore</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> Throw<span class="main">)</span><span class="main">)</span> 
                            <span class="main">(</span>DynCom <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> Seq <span class="main">(</span>Basic <span class="main">(</span><span class="free"><span class="bound"><span class="entity">restore</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">return</span></span></span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                        <span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">call</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">⇒</span><span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span><span class="main">⇒</span><span class="main">(</span><span class="tfree">'s</span><span class="main">⇒</span><span class="tfree">'s</span><span class="main">⇒</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com<span class="main">)</span><span class="main">⇒</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span>com"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">call</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">restore</span></span></span> <span class="free"><span class="bound"><span class="entity">return</span></span></span> <span class="main">=</span> block <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="main">(</span>Call <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">restore</span></span></span> <span class="free"><span class="bound"><span class="entity">return</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">dynCall</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">⇒</span><span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'p</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span>
             <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dynCall</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">restore</span></span></span> <span class="free"><span class="bound"><span class="entity">return</span></span></span> <span class="main">=</span> DynCom <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> call <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">restore</span></span></span> <span class="free"><span class="bound"><span class="entity">return</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">fcall</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">⇒</span><span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span><span class="main">⇒</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'v</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">⇒</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com<span class="main">)</span>
            <span class="main">⇒</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fcall</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">restore</span></span></span> <span class="free"><span class="bound"><span class="entity">result</span></span></span> <span class="free"><span class="bound"><span class="entity">return</span></span></span> <span class="main">=</span> call <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">restore</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">return</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">result</span></span></span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">lem</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span>com <span class="main">⇒</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span>com"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lem</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">switch</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'v</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> set <span class="main">×</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">switch</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">[]</span> <span class="main">=</span> Skip"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">switch</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Vc</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">=</span> Cond <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">s</span> <span class="main">∈</span> fst <span class="free"><span class="bound"><span class="entity">Vc</span></span></span><span class="main">}</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">Vc</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">switch</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">guaranteeStrip</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">⇒</span> <span class="tfree">'s</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">guaranteeStrip</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> Guard <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">guaranteeStripPair</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">⇒</span> <span class="tfree">'s</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span> <span class="main">×</span> <span class="tfree">'s</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">guaranteeStripPair</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">guards</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span> <span class="main">×</span> <span class="tfree">'s</span> set <span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">guards</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">guards</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> Guard <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">guards</span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">while</span><span class="main">::</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span> <span class="main">×</span> <span class="tfree">'s</span> set<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'s</span> bexp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> com"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">while</span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> guards <span class="free"><span class="bound"><span class="entity">gs</span></span></span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>guards <span class="free"><span class="bound"><span class="entity">gs</span></span></span> Skip<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">whileAnno</span><span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> bexp <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> assn <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">whileAnno</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> While <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">whileAnnoG</span><span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span> <span class="main">×</span> <span class="tfree">'s</span> set<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'s</span> bexp <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> assn <span class="main">⇒</span> 
     <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">whileAnnoG</span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> while <span class="free"><span class="bound"><span class="entity">gs</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
 
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">specAnno</span><span class="main">::</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> assn<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com<span class="main">)</span> <span class="main">⇒</span> 
                         <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> assn<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> assn<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">specAnno</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> undefined<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">whileAnnoFix</span><span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> bexp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> assn<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> assn<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com<span class="main">)</span> <span class="main">⇒</span> 
     <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">whileAnnoFix</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> While <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> undefined<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">whileAnnoGFix</span><span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span> <span class="main">×</span> <span class="tfree">'s</span> set<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'s</span> bexp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> assn<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> assn<span class="main">)</span> <span class="main">⇒</span> 
     <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">whileAnnoGFix</span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> while <span class="free"><span class="bound"><span class="entity">gs</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> undefined<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">if_rel</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> set"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">if_rel</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span> <span class="keyword1">then</span> <span class="bound">t</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="bound">t</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">s</span> <span class="main">∨</span> <span class="bound">t</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fst_guaranteeStripPair<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>guaranteeStripPair <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> guaranteeStripPair_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> snd_guaranteeStripPair<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>guaranteeStripPair <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> guaranteeStripPair_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SmallStep">
<div class="head">
<h1>Theory SmallStep</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright 2016, Data61, CSIRO
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(DATA61_BSD)
 *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹COMPLX small-step semantics›</span></span>
<span class="keyword1"><span class="command">theory</span></span> SmallStep
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Language.html">Language</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The procedure environment›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> body <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com option"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹State types›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> xstate <span class="main">=</span> Normal <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="main">|</span> Fault <span class="tfree"><span class="quoted"><span class="tfree">'f</span></span></span> <span class="main">|</span> Stuck

<span class="keyword1"><span class="command">lemma</span></span> rtrancl_mono_proof<span class="main">[</span><span class="operator">mono</span><span class="main">]</span><span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">x</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟶</span> <span class="free">y</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟹</span> rtranclp <span class="free">x</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟶</span> rtranclp <span class="free">y</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rotate_tac</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> rtranclp.intros<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">redex</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span>com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span>com"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">redex</span> Skip <span class="main">=</span> Skip"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">redex</span> <span class="main">(</span>Basic <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Basic <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">redex</span> <span class="main">(</span>Spec <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Spec <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">redex</span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">redex</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">redex</span> <span class="main">(</span>Cond <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Cond <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">redex</span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">redex</span> <span class="main">(</span>Call <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Call <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">redex</span> <span class="main">(</span>DynCom <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>DynCom <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">redex</span> <span class="main">(</span>Guard <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Guard <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">redex</span> <span class="main">(</span>Throw<span class="main">)</span> <span class="main">=</span> Throw"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">redex</span> <span class="main">(</span>Catch <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">redex</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">redex</span> <span class="main">(</span>Await <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> Await <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">redex</span> <span class="main">(</span>Parallel <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> Parallel <span class="free"><span class="bound"><span class="entity">cs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Small-Step Computation: <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Γ ⊢(c, s) → (c', s')›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The final configuration is either of the form <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(Skip,_)›</span></span></span></span> for normal
termination, or <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>Throw<span class="main"><span class="main">,</span></span>Normal <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in case the program was started in 
a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Normal"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> state and terminated abruptly. Explicit abrupt states are removed
from the language definition and thus do not need to be propogated.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> config <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span>com  <span class="main">×</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> xstate"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">final</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> config <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">final</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="main">=</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">cfg</span></span></span><span class="main">=</span>Skip <span class="main">∨</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">cfg</span></span></span><span class="main">=</span>Throw <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> snd <span class="free"><span class="bound"><span class="entity">cfg</span></span></span><span class="main">=</span>Normal <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">atom_com</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="comment1">⌦‹('s,'p,'f) body ⇒›</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> com <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">atom_com</span> Skip <span class="main">=</span> True"</span></span> <span class="main">|</span> 
  <span class="quoted"><span class="quoted">"<span class="free">atom_com</span> <span class="main">(</span>Basic <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span> 
  <span class="quoted"><span class="quoted">"<span class="free">atom_com</span> <span class="main">(</span>Spec <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span> 
  <span class="quoted"><span class="quoted">"<span class="free">atom_com</span> <span class="main">(</span>Seq  <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">atom_com</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∧</span> <span class="free">atom_com</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span> 
  <span class="quoted"><span class="quoted">"<span class="free">atom_com</span> <span class="main">(</span>Cond <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">atom_com</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∧</span> <span class="free">atom_com</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span> 
  <span class="quoted"><span class="quoted">"<span class="free">atom_com</span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">atom_com</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span> <span class="main">|</span> 
 <span class="comment1">(* Change to  atom_com (Call p) = atom_com (Θ p)
  Butow do we pass function body from step? *)</span>
  <span class="quoted"><span class="quoted">"<span class="free">atom_com</span> <span class="main">(</span>Call <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">atom_com</span> <span class="main">(</span>DynCom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">::</span><span class="tfree">'s</span><span class="main">.</span> <span class="free">atom_com</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span> 
  <span class="quoted"><span class="quoted">"<span class="free">atom_com</span> <span class="main">(</span>Guard <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">atom_com</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span> <span class="main">|</span> 
  <span class="quoted"><span class="quoted">"<span class="free">atom_com</span> Throw <span class="main">=</span> True"</span></span> <span class="main">|</span> 
  <span class="quoted"><span class="quoted">"<span class="free">atom_com</span> <span class="main">(</span>Catch <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">atom_com</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∧</span> <span class="free">atom_com</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span> 
  <span class="quoted"><span class="quoted">"<span class="free">atom_com</span> <span class="main">(</span>Parallel <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span> 
  <span class="quoted"><span class="quoted">"<span class="free">atom_com</span> <span class="main">(</span>Await <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>


<span class="keyword1"><span class="command">inductive</span></span>
      <span class="quoted">"<span class="entity">step</span>"</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> body<span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> config<span class="main">,</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> config<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
                                <span class="main">(</span><span class="quoted">"_<span class="keyword1">⊢</span> <span class="keyword3">(</span>_ <span class="keyword1">→</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>81<span class="main">,</span>81<span class="main">,</span>81<span class="main">]</span> 100<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"<span class="entity"><span class="free">step_rtrancl</span></span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> body<span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> config<span class="main">,</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> config<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
                                <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> <span class="keyword3">(</span>_ <span class="keyword1">→<span class="hidden">⇧</span><sup>*</sup></span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>81<span class="main">,</span>81<span class="main">,</span>81<span class="main">]</span> 100<span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">Γ</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> body"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free">→<span class="hidden">⇧</span><sup>*</sup></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free">step</span> <span class="free">Γ</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> Basic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span><span class="main">(</span>Basic <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span>Skip<span class="main">,</span>Normal <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span> Spec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span><span class="main">(</span>Spec <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span>Skip<span class="main">,</span>Normal <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> SpecStuck<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span><span class="main">(</span>Spec <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span>Skip<span class="main">,</span>Stuck<span class="main">)</span>"</span></span>

<span class="main">|</span> Guard<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span><span class="main">(</span>Guard <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
  
<span class="main">|</span> GuardFault<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">∉</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span><span class="main">(</span>Guard <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span>Skip<span class="main">,</span>Fault <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>


<span class="main">|</span> Seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub>'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>
        <span class="main">⟹</span> 
        <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span><span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> SeqSkip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span><span class="main">(</span>Seq Skip <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> SeqThrow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span><span class="main">(</span>Seq Throw <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span>Throw<span class="main">,</span> Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> CondTrue<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span><span class="main">(</span>Cond <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> CondFalse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">∉</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span><span class="main">(</span>Cond <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> WhileTrue<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">⟧</span> 
              <span class="main">⟹</span> 
              <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span><span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">,</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> WhileFalse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">∉</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">⟧</span> 
               <span class="main">⟹</span> 
               <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span><span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span>Skip<span class="main">,</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> Call<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">=</span>Some <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span>
         <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span><span class="main">(</span>Call <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> CallUndefined<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">=</span>None <span class="main">⟹</span>
         <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span><span class="main">(</span>Call <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span>Skip<span class="main">,</span>Stuck<span class="main">)</span>"</span></span>

<span class="main">|</span> DynCom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span><span class="main">(</span>DynCom <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> Catch<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub>'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span><span class="main">⟧</span>
          <span class="main">⟹</span>
          <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span><span class="main">(</span>Catch <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span>Catch <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> CatchSkip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span><span class="main">(</span>Catch Skip <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span>Skip<span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> CatchThrow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span><span class="main">(</span>Catch Throw <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> FaultProp<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">≠</span>Skip<span class="main">;</span> redex <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>Fault <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span>Skip<span class="main">,</span>Fault <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> StuckProp<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">≠</span>Skip<span class="main">;</span> redex <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>Stuck<span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span>Skip<span class="main">,</span>Stuck<span class="main">)</span>"</span></span>


<span class="main">|</span> Parallel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>  <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">;</span> <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">⟧</span> 
            <span class="main">⟹</span> <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span>Parallel <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span>Parallel <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> ParSkip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">∀</span><span class="bound">c</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">.</span> <span class="bound">c</span> <span class="main">=</span> Skip <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span>Parallel <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span>Skip<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="comment1">(* If exception is thrown, the parallel execution may either abort
   immediately (rule ParThrow) or keep executing (rule Parallel) *)</span>
<span class="main">|</span> ParThrow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Throw <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span>Parallel <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span>Throw<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>


<span class="main">|</span> Await<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">;</span> <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→<span class="hidden">⇧</span><sup>*</sup></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> Normal <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span><span class="main">;</span>
           atom_com <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">=</span> Skip <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">=</span> Throw <span class="main">⟧</span> 
          <span class="main">⟹</span> <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span>Await <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> Normal <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> AwaitStuck<span class="main">:</span> 
         <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">;</span> <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→<span class="hidden">⇧</span><sup>*</sup></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> Stuck<span class="main">)</span> <span class="main">;</span>
           atom_com <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">⟧</span>
          <span class="main">⟹</span> <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span>Await <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span>Skip<span class="main">,</span> Stuck<span class="main">)</span>"</span></span> 
<span class="main">|</span> AwaitFault<span class="main">:</span> 
         <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">;</span> <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→<span class="hidden">⇧</span><sup>*</sup></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> Fault <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">;</span>
           atom_com <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">⟧</span>
          <span class="main">⟹</span> <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span>Await <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span>Skip<span class="main">,</span> Fault <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span> 
<span class="main">|</span> AwaitNonAtom<span class="main">:</span> 
         <span class="quoted"><span class="quoted">" <span class="main">¬</span> atom_com <span class="free"><span class="bound"><span class="entity">c</span></span></span>
          <span class="main">⟹</span> <span class="free">Γ</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span>Await <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span>Skip<span class="main">,</span> Stuck<span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">lemmas</span></span> step_induct <span class="main">=</span> step.induct <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c'</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">split_format</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">complete</span><span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">case_names</span>
Basic Spec SpecStuck Guard GuardFault Seq SeqSkip SeqThrow CondTrue CondFalse
WhileTrue WhileFalse Call CallUndefined DynCom Catch CatchThrow CatchSkip
FaultProp StuckProp Parallel ParSkip Await<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The execution of a command is blocked if it cannot make progress, but is not in a final
state. It is the intention that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>∃cfg. Γ ⊢ (c, s) → cfg) ∨ final (c, s) ∨ blocked Γ c s›</span></span></span></span>, but
we do not prove this.›</span></span>

<span class="keyword1"><span class="command">function</span></span><span class="main">(</span>sequential<span class="main">)</span> <span class="entity">blocked</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> body <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span>xstate <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blocked</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>Seq <span class="main">(</span>Await <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">(</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">blocked</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>Catch <span class="main">(</span>Await <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">(</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">blocked</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>Await <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c'</span> <span class="bound">s'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="bound">c'</span><span class="main">,</span> Normal <span class="bound">s'</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">¬</span> final <span class="main">(</span><span class="bound">c'</span><span class="main">,</span> Normal <span class="bound">s'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">blocked</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>Parallel <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">(</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">.</span> <span class="free">blocked</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">t</span> <span class="main">(</span>Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∨</span> final <span class="main">(</span><span class="bound">t</span><span class="main">,</span> Normal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">blocked</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">pat_completeness</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> step_elim_cases <span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Skip<span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Guard <span class="free">f</span> <span class="free">g</span> <span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Basic <span class="free">f</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Spec <span class="free">r</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Seq <span class="free">c1</span> <span class="free">c2</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Cond <span class="free">b</span> <span class="free">c1</span> <span class="free">c2</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>While <span class="free">b</span> <span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Call <span class="free">p</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>DynCom <span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Throw<span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Catch <span class="free">c1</span> <span class="free">c2</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Parallel <span class="free">cs</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Await <span class="free">b</span> <span class="free">e</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>


<span class="keyword1"><span class="command">inductive_cases</span></span> step_Normal_elim_cases <span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Skip<span class="main">,</span>Normal <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Guard <span class="free">f</span> <span class="free">g</span> <span class="free">c</span><span class="main">,</span>Normal <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Basic <span class="free">f</span><span class="main">,</span>Normal <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Spec <span class="free">r</span><span class="main">,</span>Normal <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Seq <span class="free">c1</span> <span class="free">c2</span><span class="main">,</span>Normal <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Cond <span class="free">b</span> <span class="free">c1</span> <span class="free">c2</span><span class="main">,</span>Normal <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>While <span class="free">b</span> <span class="free">c</span><span class="main">,</span>Normal <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Call <span class="free">p</span><span class="main">,</span>Normal <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>DynCom <span class="free">c</span><span class="main">,</span>Normal <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Throw<span class="main">,</span>Normal <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Catch <span class="free">c1</span> <span class="free">c2</span><span class="main">,</span>Normal <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Parallel <span class="free">cs</span><span class="main">,</span>Normal <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Await <span class="free">b</span> <span class="free">e</span><span class="main">,</span>Normal <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="free">u</span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> 
 <span class="quoted">"<span class="entity">step_trancl</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> body<span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> config<span class="main">,</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> config<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
                                <span class="main">(</span><span class="quoted">"_<span class="keyword1">⊢</span> <span class="keyword3">(</span>_ <span class="keyword1">→<span class="hidden">⇧</span><sup>+</sup></span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>81<span class="main">,</span>81<span class="main">,</span>81<span class="main">]</span> 100<span class="main">)</span>
 <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span><span class="free"><span class="bound"><span class="entity">cf0</span></span></span> <span class="main"><span class="free">→<span class="hidden">⇧</span><sup>+</sup></span></span> <span class="free"><span class="bound"><span class="entity">cf1</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">CONST</span> step <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free"><span class="bound"><span class="entity">cf0</span></span></span> <span class="free"><span class="bound"><span class="entity">cf1</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
 <span class="quoted">"<span class="entity">step_n_trancl</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> body<span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> config<span class="main">,</span>nat<span class="main">,</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> config<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
                                <span class="main">(</span><span class="quoted">"_<span class="keyword1">⊢</span> <span class="keyword3">(</span>_ <span class="keyword1">→<span class="hidden">⇧</span><sup>n</sup></span>_<span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>81<span class="main">,</span>81<span class="main">,</span>81<span class="main">,</span>81<span class="main">]</span> 100<span class="main">)</span>
 <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span><span class="free"><span class="bound"><span class="entity">cf0</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇧</span><sup>n</sup></span></span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">cf1</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">CONST</span> step <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">^^</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cf0</span></span></span> <span class="free"><span class="bound"><span class="entity">cf1</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> no_step_final<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"final <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> step
<span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> no_step_final'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="free">cfg</span> <span class="main">→</span> <span class="free">cfg'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"final <span class="free">cfg</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> step
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">cfg</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">cfg'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> no_step_final<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> no_steps_final<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">v</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">w</span> <span class="main">⟹</span> final <span class="free">v</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span>  <span class="main">(</span><span class="operator">erule</span> converse_rtranclpE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> no_step_final'<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> step_Fault<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="free">s</span><span class="main">=</span>Fault <span class="bound">f</span> <span class="main">⟹</span> <span class="free">s'</span><span class="main">=</span>Fault <span class="bound">f</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> step

<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> step_Stuck<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="free">s</span><span class="main">=</span>Stuck <span class="main">⟹</span> <span class="free">s'</span><span class="main">=</span>Stuck"</span></span>
<span class="keyword1"><span class="command">using</span></span> step
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> SeqSteps<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> steps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="free">cfg<span class="hidden">⇩</span><sub>1</sub></span><span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">cfg<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">cfg<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">;</span><span class="free">cfg<span class="hidden">⇩</span><sub>2</sub></span><span class="main">=</span><span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">⟧</span>
          <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Seq <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Seq <span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> steps
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtranclp_induct <span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Refl Trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Refl
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">cfg<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">cfg''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">cfg<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="skolem">cfg''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> steps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">cfg''</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">cfg<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> cfg<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cfg<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cfg<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="keyword2"><span class="keyword">where</span></span> cfg''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg''</span><span class="main">=</span><span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span><span class="skolem">s''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">cfg''</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> step cfg<span class="hidden">⇩</span><sub>1</sub> cfg'' 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span><span class="skolem">s''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Seq <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span>Seq <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="skolem">s''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> step.Seq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> Trans.hyps <span class="main">(</span>3<span class="main">)</span> <span class="main">[</span><span class="operator">OF</span> cfg'' cfg<span class="hidden">⇩</span><sub>2</sub><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Seq <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">s''</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Seq <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> CatchSteps<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> steps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span><span class="free">cfg<span class="hidden">⇩</span><sub>1</sub></span><span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">cfg<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">cfg<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">;</span> <span class="free">cfg<span class="hidden">⇩</span><sub>2</sub></span><span class="main">=</span><span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">⟧</span>
          <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span><span class="main">(</span>Catch <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Catch <span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> steps
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtranclp_induct <span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Refl Trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Refl
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">cfg<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">cfg''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">cfg<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="skolem">cfg''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> steps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">cfg''</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">cfg<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> cfg<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cfg<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cfg<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="keyword2"><span class="keyword">where</span></span> cfg''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg''</span><span class="main">=</span><span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span><span class="skolem">s''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">cfg''</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> step cfg<span class="hidden">⇩</span><sub>1</sub> cfg'' 
  <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span><span class="skolem">s''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Catch <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span>Catch <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="skolem">s''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> step.Catch<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> Trans.hyps <span class="main">(</span>3<span class="main">)</span> <span class="main">[</span><span class="operator">OF</span> cfg'' cfg<span class="hidden">⇩</span><sub>2</sub><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Catch <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">s''</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Catch <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>      
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> steps_Fault<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> Fault <span class="free">f</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Skip<span class="main">,</span> Fault <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Seq <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> steps_c<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> Fault <span class="free">f</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Skip<span class="main">,</span> Fault <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> steps_c<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Fault <span class="free">f</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Skip<span class="main">,</span> Fault <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> SeqSteps <span class="main">[</span><span class="operator">OF</span> steps_c<span class="hidden">⇩</span><sub>1</sub> refl refl<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Seq <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Fault <span class="free">f</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Seq Skip <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Fault <span class="free">f</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Seq Skip <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Fault <span class="free">f</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Fault <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SeqSkip<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> steps_c<span class="hidden">⇩</span><sub>2</sub>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Catch <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> steps_c<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> Fault <span class="free">f</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Skip<span class="main">,</span> Fault <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> CatchSteps <span class="main">[</span><span class="operator">OF</span> steps_c<span class="hidden">⇩</span><sub>1</sub> refl refl<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Catch <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Fault <span class="free">f</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Catch Skip <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Fault <span class="free">f</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Catch Skip <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Fault <span class="free">f</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span>Skip<span class="main">,</span> Fault <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> CatchSkip<span class="main">)</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> step.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> steps_Stuck<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> Stuck<span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Skip<span class="main">,</span> Stuck<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Seq <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> steps_c<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> Stuck<span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Skip<span class="main">,</span> Stuck<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> steps_c<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Stuck<span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Skip<span class="main">,</span> Stuck<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> SeqSteps <span class="main">[</span><span class="operator">OF</span> steps_c<span class="hidden">⇩</span><sub>1</sub> refl refl<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Seq <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Stuck<span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Seq Skip <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Stuck<span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Seq Skip <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Stuck<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Stuck<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SeqSkip<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> steps_c<span class="hidden">⇩</span><sub>2</sub>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Catch <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> steps_c<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> Stuck<span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Skip<span class="main">,</span> Stuck<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> CatchSteps <span class="main">[</span><span class="operator">OF</span> steps_c<span class="hidden">⇩</span><sub>1</sub> refl refl<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Catch <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Stuck<span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Catch Skip <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Stuck<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Catch Skip <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Stuck<span class="main">)</span> <span class="main">→</span> <span class="main">(</span>Skip<span class="main">,</span> Stuck<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> CatchSkip<span class="main">)</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> step.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step_Fault_prop<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="free">s</span><span class="main">=</span>Fault <span class="bound">f</span> <span class="main">⟹</span> <span class="free">s'</span><span class="main">=</span>Fault <span class="bound">f</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> step
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> step_Stuck_prop<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">=</span>Stuck <span class="main">⟹</span> <span class="free">s'</span><span class="main">=</span>Stuck"</span></span>
<span class="keyword1"><span class="command">using</span></span> step
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> steps_Fault_prop<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">=</span>Fault <span class="free">f</span> <span class="main">⟹</span> <span class="free">s'</span><span class="main">=</span>Fault <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> step
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtranclp_induct2 <span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Refl Trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Refl <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">c''</span> <span class="skolem">s''</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> step_Fault_prop<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> steps_Stuck_prop<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">=</span>Stuck <span class="main">⟹</span> <span class="free">s'</span><span class="main">=</span>Stuck"</span></span>
<span class="keyword1"><span class="command">using</span></span> step
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtranclp_induct2 <span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Refl Trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Refl <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">c''</span> <span class="skolem">s''</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> step_Stuck_prop<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="OG_Annotations">
<div class="head">
<h1>Theory OG_Annotations</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright 2016, Data61, CSIRO
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(DATA61_BSD)
 *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Annotations, assertions and associated operations›</span></span>

<span class="keyword1"><span class="command">theory</span></span> OG_Annotations
<span class="keyword2"><span class="keyword">imports</span></span> <a href="SmallStep.html">SmallStep</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'s</span> assn <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> dead <span class="tfree">'p</span><span class="main">,</span> dead <span class="tfree">'f</span><span class="main">)</span> ann <span class="main">=</span>
    AnnExpr <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> assn"</span></span> 
  <span class="main">|</span> AnnRec <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> assn"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann"</span></span>
  <span class="main">|</span> AnnWhile <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> assn"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> assn"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann"</span></span>
  <span class="main">|</span> AnnComp <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann"</span></span>
  <span class="main">|</span> AnnBin <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> assn"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann"</span></span>
  <span class="main">|</span> AnnPar <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann <span class="main">×</span> <span class="tfree">'s</span> assn <span class="main">×</span> <span class="tfree">'s</span> assn<span class="main">)</span> list"</span></span>
  <span class="main">|</span> AnnCall <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> assn"</span></span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann_triple <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann <span class="main">×</span> <span class="tfree">'s</span> assn <span class="main">×</span> <span class="tfree">'s</span> assn"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
 The list of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ann_triple›</span></span></span></span> is useful if the code calls the same function multiple times
 and require different annotations for the function body each time.
›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> proc_assns <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann<span class="main">)</span> list option"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>  <span class="main">(</span>input<span class="main">)</span> <span class="entity">pres</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann_triple <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pres</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> fst <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">postcond</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann_triple <span class="main">⇒</span> <span class="tfree">'s</span> assn"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">postcond</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> fst <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">abrcond</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann_triple <span class="main">⇒</span> <span class="tfree">'s</span> assn"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">abrcond</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> snd <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pre</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann <span class="main">⇒</span> <span class="tfree">'s</span> assn"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>      <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>                                                                                               
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="main">(</span>AnnRec <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>     <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="main">(</span>AnnWhile <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="main">(</span>AnnComp <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>   <span class="main">=</span>  <span class="free">pre</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="main">(</span>AnnBin <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>  <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="main">(</span>AnnPar <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>      <span class="main">=</span> <span class="main">⋂</span> <span class="main">(</span><span class="free">pre</span> <span class="main">`</span> set <span class="main">(</span>map pres <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pre</span> <span class="main">(</span>AnnCall <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>    <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pre_par</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pre_par</span> <span class="main">(</span>AnnComp <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span>  <span class="free">pre_par</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pre_par</span> <span class="main">(</span>AnnPar <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>  <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pre_par</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span>    <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pre_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> assn<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pre_set</span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>      <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pre_set</span> <span class="main">(</span>AnnRec <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>     <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pre_set</span> <span class="main">(</span>AnnWhile <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pre_set</span> <span class="main">(</span>AnnComp <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>   <span class="main">=</span>  <span class="free">pre_set</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pre_set</span> <span class="main">(</span>AnnBin <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>  <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pre_set</span> <span class="main">(</span>AnnPar <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>       <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">pre_set</span> <span class="main">`</span> set <span class="main">(</span>map pres <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(*| "pre_set (AnnPar e<span class="hidden">⇩</span><sub>1</sub> e<span class="hidden">⇩</span><sub>2</sub>)    = pre_set (pres e<span class="hidden">⇩</span><sub>1</sub>) ∪ pre_set (pres e<span class="hidden">⇩</span><sub>2</sub>)" *)</span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pre_set</span> <span class="main">(</span>AnnCall <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>    <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fst_BNFs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> Basic_BNFs.fsts <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> fsts.intros <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>pre_par <span class="free">c</span>  <span class="main">⟹</span> pre <span class="free">c</span> <span class="main">∈</span> pre_set <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pre_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pre <span class="free">c</span> <span class="main">=</span> <span class="main">⋂</span> <span class="main">(</span>pre_set <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pre_imp_pre_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> pre <span class="free">c</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> pre_set <span class="free">c</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_set<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">precond</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann_triple <span class="main">⇒</span> <span class="tfree">'s</span> assn"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">precond</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> pre <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">strengthen_pre</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strengthen_pre</span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>      <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">=</span> AnnExpr <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span>"</span></span>                                                                                               
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">strengthen_pre</span> <span class="main">(</span>AnnRec <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>     <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">=</span> AnnRec <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">strengthen_pre</span> <span class="main">(</span>AnnWhile <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">=</span> AnnWhile <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">strengthen_pre</span> <span class="main">(</span>AnnComp <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>   <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">=</span> AnnComp <span class="main">(</span><span class="free">strengthen_pre</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">strengthen_pre</span> <span class="main">(</span>AnnBin <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">=</span> AnnBin <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">strengthen_pre</span> <span class="main">(</span>AnnPar <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>    <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">=</span> <span class="main">(</span>AnnPar <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">strengthen_pre</span> <span class="main">(</span>AnnCall <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>    <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">=</span> AnnCall <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">weaken_pre</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">weaken_pre</span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>      <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">=</span> AnnExpr <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span>"</span></span>                                                                                               
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">weaken_pre</span> <span class="main">(</span>AnnRec <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>     <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">=</span> AnnRec <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">weaken_pre</span> <span class="main">(</span>AnnWhile <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">=</span> AnnWhile <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">weaken_pre</span> <span class="main">(</span>AnnComp <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>   <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">=</span> AnnComp <span class="main">(</span><span class="free">weaken_pre</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">weaken_pre</span> <span class="main">(</span>AnnBin <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">=</span> AnnBin <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">weaken_pre</span> <span class="main">(</span>AnnPar <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>   <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">=</span> AnnPar <span class="free"><span class="bound"><span class="entity">as</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">weaken_pre</span> <span class="main">(</span>AnnCall <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>    <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">=</span> AnnCall <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> weaken_pre_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"weaken_pre <span class="free">r</span> <span class="main">{}</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Annotations for call definition (see Language.thy)›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
 <span class="entity">ann_call</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> nat <span class="main">⇒</span>  <span class="tfree">'s</span> assn <span class="main">⇒</span><span class="tfree">'s</span> assn <span class="main">⇒</span>  <span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">ann_call</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">restoreq</span></span></span> <span class="free"><span class="bound"><span class="entity">return</span></span></span> <span class="free"><span class="bound"><span class="entity">restorea</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> 
  AnnRec <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="main">(</span>AnnComp <span class="main">(</span>AnnComp <span class="main">(</span>AnnComp <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">init</span></span></span><span class="main">)</span> <span class="main">(</span>AnnCall <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>AnnComp <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">restorea</span></span></span><span class="main">)</span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>AnnRec <span class="free"><span class="bound"><span class="entity">restoreq</span></span></span> <span class="main">(</span>AnnComp <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">restoreq</span></span></span><span class="main">)</span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">return</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">ann_matches</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> body <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> proc_assns <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> com <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  ann_skip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> Skip"</span></span>
<span class="main">|</span> ann_basic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>Basic <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> ann_spec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>Spec <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> ann_throw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>Throw<span class="main">)</span>"</span></span>
<span class="main">|</span> ann_await<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⟹</span>
               <span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">(</span>AnnRec <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>Await <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> ann_seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">;</span> <span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span>
               <span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">(</span>AnnComp <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> ann_cond<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;</span> <span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span>
               <span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">(</span>AnnBin <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">(</span>Cond <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> ann_catch<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;</span> <span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span>
                <span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">(</span>AnnComp <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">(</span>Catch <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> ann_while<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⟹</span>
                <span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">(</span>AnnWhile <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> ann_guard<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> 
                <span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">(</span>AnnRec <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span> <span class="main">(</span>Guard <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> ann_call<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">;</span>
               <span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">⟧</span> <span class="main">⟹</span>
   <span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">(</span>AnnCall <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Call <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> ann_dyncom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span> <span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span>
               <span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">(</span>AnnRec <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>DynCom <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> ann_parallel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> length <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">;</span>
                   <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">.</span> <span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">(</span>pres <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
   <span class="free">ann_matches</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">(</span>AnnPar <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span>Parallel <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ann_guards</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span> <span class="main">×</span> <span class="tfree">'s</span> bexp <span class="main">)</span> list <span class="main">⇒</span>
                  <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ann_guards</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ann_guards</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> AnnRec <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free">ann_guards</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∩</span> snd <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="OG_Hoare">
<div class="head">
<h1>Theory OG_Hoare</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright 2016, Data61, CSIRO
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(DATA61_BSD)
 *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ Owicki-Gries for Partial Correctness ›</span></span>
<span class="keyword1"><span class="command">theory</span></span> OG_Hoare
<span class="keyword2"><span class="keyword">imports</span></span> <a href="OG_Annotations.html">OG_Annotations</a> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Validity of Hoare Tuples: <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Γ⊨<span class="hidden">⇘</span><sub>/F</sub><span class="hidden">⇙</span> P c Q,A›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">valid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> body<span class="main">,</span><span class="tfree">'f</span> set<span class="main">,</span><span class="tfree">'s</span> assn<span class="main">,</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com<span class="main">,</span><span class="tfree">'s</span> assn<span class="main">,</span><span class="tfree">'s</span> assn<span class="main">]</span> <span class="main">=&gt;</span> bool"</span></span>
                <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊨⇘'/</span>_<span class="keyword1">⇙</span><span class="keyword3">/ </span>_ _ _<span class="keyword1">,</span> _"</span>  <span class="main">[</span>61<span class="main">,</span>60<span class="main">,</span>1000<span class="main">,</span> 20<span class="main">,</span> 1000<span class="main">,</span>1000<span class="main">]</span> 60<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> ⊨<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">t</span> <span class="bound">c'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">⊢</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="bound">c'</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span> final <span class="main">(</span><span class="bound">c'</span><span class="main">,</span> <span class="bound">t</span> <span class="main">)</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">∈</span> Normal <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟶</span> <span class="bound">t</span> <span class="main">∉</span> Fault <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span>  
                      <span class="main">⟶</span>  <span class="bound">c'</span> <span class="main">=</span> Skip <span class="main">∧</span> <span class="bound">t</span> <span class="main">∈</span> Normal <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">∨</span> <span class="bound">c'</span> <span class="main">=</span> Throw <span class="main">∧</span> <span class="bound">t</span> <span class="main">∈</span> Normal <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Interference Freedom›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
 <span class="entity">atomicsR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> body <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> proc_assns <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> assn <span class="main">×</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> com<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">Γ</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> body"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">Θ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> proc_assns"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  AtBasic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>Basic <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> Basic <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> AtSpec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>Spec <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> Spec <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> AtAwait<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="main">(</span>AnnRec <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ae</span></span></span><span class="main">)</span> <span class="main">(</span>Await <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> Await <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> AtWhileExpr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span> <span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="main">(</span>AnnWhile <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> AtGuardExpr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span> <span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="main">(</span>AnnRec <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>Guard <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> 
<span class="main">|</span> AtDynCom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟹</span> <span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">ad</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span> <span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="main">(</span>AnnRec <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ad</span></span></span><span class="main">)</span> <span class="main">(</span>DynCom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> 
<span class="main">|</span> AtCallExpr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">⟹</span>
                <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">⟹</span>
                <span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span>  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span>
               <span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="main">(</span>AnnCall <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Call <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> AtSeqExpr1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span>  <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span>
               <span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="main">(</span>AnnComp <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> 
<span class="main">|</span> AtSeqExpr2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span>  <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span>
               <span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="main">(</span>AnnComp <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> 
<span class="main">|</span> AtCondExpr1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span>  <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span>
               <span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="main">(</span>AnnBin <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">(</span>Cond <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> 
<span class="main">|</span> AtCondExpr2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span>  <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span>
               <span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="main">(</span>AnnBin <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">(</span>Cond <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> 
<span class="main">|</span> AtCatchExpr1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span>  <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span>
               <span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="main">(</span>AnnComp <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">(</span>Catch <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> 
<span class="main">|</span> AtCatchExpr2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span>  <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span>
               <span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="main">(</span>AnnComp <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">(</span>Catch <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> 
<span class="main">|</span> AtParallelExprs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">⟹</span> <span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="main">(</span>fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span>
    <span class="free">atomicsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="main">(</span>AnnPar <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span>Parallel <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> atomicsR_Skip<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"atomicsR <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">a</span> Skip <span class="free">r</span> <span class="main">=</span> False"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> atomicsR.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> atomicsR_Throw<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"atomicsR <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">a</span> Throw <span class="free">r</span> <span class="main">=</span> False"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> atomicsR.cases<span class="main">)</span>

<span class="keyword1"><span class="command">inductive</span></span>
 <span class="entity">assertionsR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> body <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> proc_assns <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">Γ</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> body"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">Θ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> proc_assns"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  AsSkip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> Skip <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> AsThrow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> Throw <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> AsBasic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>Basic <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> AsBasicSkip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>Basic <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>
<span class="main">|</span> AsSpec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>Spec <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> AsSpecSkip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>Spec <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>
<span class="main">|</span> AsAwaitSkip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnRec <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ae</span></span></span><span class="main">)</span> <span class="main">(</span>Await <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>
<span class="main">|</span> AsAwaitThrow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnRec <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ae</span></span></span><span class="main">)</span> <span class="main">(</span>Await <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>
<span class="main">|</span> AsAwait<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnRec <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ae</span></span></span><span class="main">)</span> <span class="main">(</span>Await <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> AsWhileExpr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span> <span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnWhile <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> 
<span class="main">|</span> AsWhileAs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnWhile <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> AsWhileInv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnWhile <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="main">|</span> AsWhileSkip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnWhile <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>
<span class="main">|</span> AsGuardExpr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span> <span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnRec <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>Guard <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> 
<span class="main">|</span> AsGuardAs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnRec <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>Guard <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span> 
<span class="main">|</span> AsDynComExpr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟹</span> <span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">ad</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span> <span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnRec <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ad</span></span></span><span class="main">)</span> <span class="main">(</span>DynCom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> 
<span class="main">|</span> AsDynComAs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnRec <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>DynCom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span> 
<span class="main">|</span> AsCallAs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnCall <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Call <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span> 
<span class="main">|</span> AsCallExpr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">⟹</span>
                <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">⟹</span>
                <span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span>
               <span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnCall <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Call <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> 
<span class="main">|</span> AsSeqExpr1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="main">(</span>pre <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span>
               <span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnComp <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> 
<span class="main">|</span> AsSeqExpr2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span>
               <span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnComp <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> 
<span class="main">|</span> AsCondExpr1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span>
               <span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnBin <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">(</span>Cond <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> 
<span class="main">|</span> AsCondExpr2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span>
               <span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnBin <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">(</span>Cond <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> 
<span class="main">|</span> AsCondAs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnBin <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">(</span>Cond <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span> 
<span class="main">|</span> AsCatchExpr1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">(</span>pre <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span>
               <span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnComp <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">(</span>Catch <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> 
<span class="main">|</span> AsCatchExpr2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span>
               <span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnComp <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">(</span>Catch <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> 

<span class="main">|</span> AsParallelExprs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">⟹</span> <span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="main">(</span>postcond <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>abrcond <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pres <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span>
    <span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnPar <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span>Parallel <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> 
<span class="main">|</span> AsParallelSkips<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Qs</span></span></span> <span class="main">=</span> <span class="main">⋂</span> <span class="main">(</span>set <span class="main">(</span>map postcond <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">assertionsR</span> <span class="free">Γ</span> <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnPar <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span>Parallel <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Qs</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">interfree_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> body <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> proc_assns <span class="main">⇒</span> <span class="tfree">'f</span> set <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com <span class="main">×</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann_triple <span class="main">×</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com <span class="main">×</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">interfree_aux</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="main">(</span><span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">Q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span>
                              <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">c</span> <span class="main">.</span>atomicsR <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">⟶</span> 
                               <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>⊨<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="bound">Q<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∩</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">c</span> <span class="bound">Q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="bound">Q<span class="hidden">⇩</span><sub>1</sub></span>  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>⊨<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∩</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">c</span> <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span>  <span class="main">∧</span>
                                <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> assertionsR <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="bound">Q<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>⊨<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="bound">a</span> <span class="main">∩</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">c</span> <span class="bound">a</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">interfree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> body <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> proc_assns <span class="main">⇒</span> <span class="tfree">'f</span> set <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann_triple<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com list  <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">interfree</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">Ps</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟶</span> 
                         interfree_aux <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">!</span><span class="bound">j</span><span class="main">,</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Owicki-Gries Logic for COMPLX›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">oghoare</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> body <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> proc_assns <span class="main">⇒</span> <span class="tfree">'f</span> set
              <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> bool"</span></span>
    <span class="main">(</span><span class="quoted">"<span class="keyword3">(4</span>_<span class="keyword1">,</span> _<span class="keyword3">/ </span><span class="keyword1">⊢⇘'/</span>_<span class="keyword1">⇙</span> <span class="keyword3">(</span>_<span class="keyword3">/ </span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">/ </span>_<span class="keyword1">,</span> _<span class="keyword3">)</span><span class="keyword3">)</span>"</span> <span class="main">[</span>60<span class="main">,</span>60<span class="main">,</span>60<span class="main">,</span>1000<span class="main">,</span>1000<span class="main">,</span>1000<span class="main">,</span>1000<span class="main">]</span>60<span class="main">)</span>
<span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">oghoare_seq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> body <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> proc_assns <span class="main">⇒</span> <span class="tfree">'f</span> set
              <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> bool"</span></span>
    <span class="main">(</span><span class="quoted">"<span class="keyword3">(4</span>_<span class="keyword1">,</span> _<span class="keyword3">/ </span><span class="keyword1">⊩⇘'/</span>_<span class="keyword1">⇙</span> <span class="keyword3">(</span>_<span class="keyword3">/ </span>_<span class="keyword3">/ </span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">/ </span>_<span class="keyword1">,</span> _<span class="keyword3">)</span><span class="keyword3">)</span>"</span> <span class="main">[</span>60<span class="main">,</span>60<span class="main">,</span>60<span class="main">,</span>1000<span class="main">,</span>1000<span class="main">,</span>1000<span class="main">,</span>1000<span class="main">]</span>60<span class="main">)</span>

<span class="keyword2"><span class="keyword">where</span></span>
 Skip<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> Skip <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> Throw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> Throw <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> Basic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnExpr <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>Basic <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> Spec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnExpr <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="main">⟶</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>Spec <span class="free"><span class="bound"><span class="entity">rel</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> Seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">(</span>pre <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
         <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟧</span>
         <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnComp <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> Catch<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="main">(</span>pre <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">;</span>
           <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟧</span> 
      <span class="main">⟹</span>  <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnComp <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">(</span>Catch <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>
  
<span class="main">|</span> Cond<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
           <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
          <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⊆</span> pre <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">;</span>
          <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∩</span> <span class="main">-</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⊆</span> pre <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
         <span class="main">⟹</span> 
         <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnBin <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">(</span>Cond <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> While<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
            <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⊆</span> pre <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">;</span>
            <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∩</span> <span class="main">-</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">;</span>
            <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>  <span class="main">⟧</span>
          <span class="main">⟹</span>
          <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnWhile <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> Guard<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
            <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⊆</span> pre <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">;</span>
            <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∩</span> <span class="main">-</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">⟧</span> <span class="main">⟹</span>
          <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnRec <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">(</span>Guard <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> Call<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>  <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">;</span>
          <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">;</span>
          <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⊆</span> pre <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">;</span>
          <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">;</span>
          <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">;</span>
          <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>
          <span class="main">⟧</span> 
         <span class="main">⟹</span> 
         <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnCall <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Call <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> DynCom<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⊆</span> pre <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span> 
      <span class="main">⟹</span> 
      <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnRec <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>DynCom <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> Await<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span> atom_com <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnRec <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">(</span>Await <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> Parallel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> length <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">;</span>
               <span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">Θ</span></span></span>⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span><span class="main">(</span>pres <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span>postcond <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">,</span></span><span class="main">(</span>abrcond <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
               interfree <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">;</span>
               <span class="main">⋂</span> <span class="main">(</span>set <span class="main">(</span>map postcond <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">;</span>
               <span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>map abrcond <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>
              <span class="main">⟧</span>
        <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">Θ</span></span></span>⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnPar <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span>Parallel <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> Conseq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P'</span> <span class="bound">Q'</span> <span class="bound">A'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">Θ</span></span></span>⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span>weaken_pre <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">P'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">Q'</span><span class="main"><span class="free">,</span></span><span class="bound">A'</span> <span class="main">∧</span> <span class="bound">Q'</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">∧</span> <span class="bound">A'</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> 
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">Θ</span></span></span>⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> SeqSkip<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> Skip <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> SeqThrow<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> Throw <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> SeqBasic<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">}</span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Basic <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> SeqSpec<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟶</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">}</span> <span class="main">(</span>AnnExpr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Spec <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> SeqSeq<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⟧</span>
         <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>AnnComp <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> SeqCatch<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>AnnComp <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">(</span>Catch <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> SeqCond<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
           <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∩</span> <span class="main">-</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟧</span>
         <span class="main">⟹</span> 
         <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>AnnBin <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">(</span>Cond <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> SeqWhile<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">∩</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟧</span>
          <span class="main">⟹</span>
          <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>AnnWhile <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∩</span> <span class="main">-</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> SeqGuard<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">∩</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
            <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∩</span> <span class="main">-</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">⟧</span> <span class="main">⟹</span>
          <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>AnnRec <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>Guard <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> SeqCall<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>  <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">;</span>
          <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">P''</span></span></span><span class="main">;</span>
          <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">;</span>
          <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">;</span>
          <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">P''</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>
          <span class="main">⟧</span> 
         <span class="main">⟹</span> 
         <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>AnnCall <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Call <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> SeqDynCom<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⊆</span> pre <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span>
      <span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟹</span>
      <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">⊆</span><span class="free"><span class="bound"><span class="entity">r</span></span></span>
      <span class="main">⟹</span> 
      <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>AnnRec <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>DynCom <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> SeqConseq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">Θ</span></span></span>⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q'</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Q'</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">Θ</span></span></span>⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="main">|</span> SeqParallel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊆</span> pre <span class="main">(</span>AnnPar <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">Θ</span></span></span>⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnPar <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span>Parallel <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>
  <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">Θ</span></span></span>⊩<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>AnnPar <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span>Parallel <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> oghoare_intros <span class="main">=</span> <span class="quoted">"oghoare_oghoare_seq.intros"</span>

<span class="keyword1"><span class="command">lemmas</span></span> oghoare_inducts <span class="main">=</span> oghoare_oghoare_seq.inducts

<span class="keyword1"><span class="command">lemmas</span></span> oghoare_induct <span class="main">=</span> oghoare_oghoare_seq.inducts<span class="main">(</span>1<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> oghoare_seq_induct <span class="main">=</span> oghoare_oghoare_seq.inducts<span class="main">(</span>2<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SeqCatch_decomp">
<div class="head">
<h1>Theory SeqCatch_decomp</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright 2016, Data61, CSIRO
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(DATA61_BSD)
 *)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Helper lemmas for sequential reasoning about Seq and Catch›</span></span>
<span class="keyword1"><span class="command">theory</span></span> SeqCatch_decomp 
<span class="keyword2"><span class="keyword">imports</span></span> <a href="SmallStep.html">SmallStep</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> redex_size<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span> <span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> redex <span class="free">c</span> <span class="main">=</span> <span class="bound">r</span> <span class="main">⟶</span> size <span class="bound">r</span> <span class="main">≤</span> size <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Normal_pre<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span> <span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">p'</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">⟹</span> 
 <span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="free">s'</span> <span class="main">=</span> Normal <span class="bound">u</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free">s</span> <span class="main">=</span> Normal <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">erule</span> step_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> Normal_pre_star<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span> <span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">cfg<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">cfg<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">p'</span> <span class="bound">t</span><span class="main">.</span> <span class="free">cfg<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span><span class="bound">p'</span><span class="main">,</span> Normal <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span>
 <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">s</span><span class="main">.</span> <span class="free">cfg<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> Normal <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> converse_rtranclp_induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> Normal_pre<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>



<span class="keyword1"><span class="command">lemma</span></span> Seq_decomp_Skip<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span> <span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">p'</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">⟹</span> 
 <span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free">p</span> <span class="main">=</span> Seq Skip <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span> <span class="free">s'</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> <span class="free">p'</span> <span class="main">=</span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> step_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> step.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">+</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Seq_decomp_Throw<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span> <span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">p'</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">⟹</span> 
 <span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">z</span><span class="main">.</span> <span class="free">s</span> <span class="main">=</span> Normal <span class="bound">z</span> <span class="main">⟶</span> <span class="free">p</span> <span class="main">=</span> Seq Throw <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span> <span class="free">s'</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> <span class="free">p'</span> <span class="main">=</span> Throw"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> step_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> step.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Throw_star<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span> <span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">cfg<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">cfg<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">cfg<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span>Throw<span class="main">,</span> Normal <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
  <span class="free">cfg<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">cfg<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> converse_rtranclp_induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> step.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Seq_decomp<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span> <span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">p'</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">⟹</span> 
 <span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free">p</span> <span class="main">=</span> Seq <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> Skip <span class="main">⟶</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> Throw <span class="main">⟶</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">p'</span> <span class="main">=</span> Seq <span class="bound">p<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> step_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> redex_size<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> redex_size<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Seq_decomp_relpow<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Seq <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Normal <span class="free">s</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇧</span><sup>n</sup></span><span class="free">n</span> <span class="main">(</span><span class="free">p'</span><span class="main">,</span> Normal <span class="free">s'</span><span class="main">)</span> <span class="main">⟹</span>
 final <span class="main">(</span><span class="free">p'</span><span class="main">,</span> Normal <span class="free">s'</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n1</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> Normal <span class="free">s</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇧</span><sup>n</sup></span><span class="bound">n1</span> <span class="main">(</span>Throw<span class="main">,</span> Normal <span class="free">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">p'</span><span class="main">=</span>Throw <span class="main">∨</span>
 <span class="main">(</span><span class="main">∃</span><span class="bound">t</span> <span class="bound">n1</span> <span class="bound">n2</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> Normal <span class="free">s</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇧</span><sup>n</sup></span><span class="bound">n1</span> <span class="main">(</span>Skip<span class="main">,</span> Normal <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">n1</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">n2</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Normal <span class="bound">t</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇧</span><sup>n</sup></span><span class="bound">n2</span> <span class="main">(</span><span class="free">p'</span><span class="main">,</span> Normal <span class="free">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">p<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">p'</span></span> <span class="quoted"><span class="free">s'</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> relpowp.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> relpowp_commute<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> n p<span class="hidden">⇩</span><sub>1</sub> p<span class="hidden">⇩</span><sub>2</sub> s p' s' a b<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Skip"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> Seq_decomp_Skip<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> n p<span class="hidden">⇩</span><sub>1</sub> p<span class="hidden">⇩</span><sub>2</sub> s p' s' a b<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Throw"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> Seq_decomp_Throw<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> relpowp_imp_rtranclp<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> Throw_star<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> Seq_decomp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> n p<span class="hidden">⇩</span><sub>1</sub> p<span class="hidden">⇩</span><sub>2</sub> s p' s' a b<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> relpowp_imp_rtranclp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> Normal_pre_star<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> meta_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> meta_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> meta_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> meta_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> meta_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> meta_mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> meta_mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> n1<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="improper">n1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> relpowp_commute<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> relcomppI<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> t n1 n2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="improper">n1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> mp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> relpowp_commute<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> relcomppI<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Seq_decomp_star<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Seq <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Normal <span class="free">s</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="free">p'</span><span class="main">,</span> Normal <span class="free">s'</span><span class="main">)</span> <span class="main">⟹</span> final <span class="main">(</span><span class="free">p'</span><span class="main">,</span> Normal <span class="free">s'</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> Normal <span class="free">s</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Throw<span class="main">,</span> Normal <span class="free">s'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">p'</span><span class="main">=</span>Throw <span class="main">∨</span>
 <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> Normal <span class="free">s</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Skip<span class="main">,</span> Normal <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Normal <span class="bound">t</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="free">p'</span><span class="main">,</span> Normal <span class="free">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> rtranclp_imp_relpowp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Seq_decomp_relpow<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> relpowp_imp_rtranclp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span>  relpowp_imp_rtranclp<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Seq_decomp_relpowp_Fault<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Seq <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Normal <span class="free">s</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇧</span><sup>n</sup></span><span class="free">n</span> <span class="main">(</span>Skip<span class="main">,</span> Fault <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">∃</span><span class="bound">n1</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> Normal <span class="free">s</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇧</span><sup>n</sup></span><span class="bound">n1</span> <span class="main">(</span>Skip<span class="main">,</span> Fault <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
 <span class="main">(</span><span class="main">∃</span><span class="bound">t</span> <span class="bound">n1</span> <span class="bound">n2</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> Normal <span class="free">s</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇧</span><sup>n</sup></span><span class="bound">n1</span> <span class="main">(</span>Skip<span class="main">,</span> Normal <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">n1</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">n2</span> <span class="main">&lt;</span> <span class="free">n</span>  <span class="main">∧</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Normal <span class="bound">t</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇧</span><sup>n</sup></span><span class="bound">n2</span> <span class="main">(</span>Skip<span class="main">,</span> Fault <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">p<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> relpowp.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> relpowp_commute<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> n s p<span class="hidden">⇩</span><sub>1</sub> a b<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Skip"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Seq_decomp_Skip<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Throw"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Seq_decomp_Throw<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> Seq_decomp <span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s p1 t p1'<span class="main">)</span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> Normal <span class="bound">v</span> <span class="main">=</span> <span class="improper">t</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> v<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">v</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">p1'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> n1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">n1</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> relpowp_Suc_I2<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> t n1 n2<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">n1</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> relpowp_commute<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> mp<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> relcomppI<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">t</span> <span class="main">=</span> Stuck"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> relpowp_imp_rtranclp<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> steps_Stuck_prop<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> f'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> steps_Fault_prop<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"Fault <span class="free"><span class="free">f</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> relpowp_imp_rtranclp<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">p1'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> steps_Fault<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> rtranclp_imp_relpowp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> n'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">n'</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> relpowp_commute<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> relcomppI<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Seq_decomp_star_Fault<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span> <span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">cfg<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">cfg<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">p</span> <span class="bound">s</span> <span class="bound">p'</span> <span class="bound">f</span><span class="main">.</span> <span class="free">cfg<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> Normal <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">cfg<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span>Skip<span class="main">,</span> Fault <span class="bound">f</span><span class="main">)</span> <span class="main">⟶</span> 
 <span class="main">(</span><span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> Seq <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span> 
 <span class="main">(</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> Normal <span class="bound">s</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Skip<span class="main">,</span> Fault <span class="bound">f</span><span class="main">)</span><span class="main">)</span>
 <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span>  Normal <span class="bound">s</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Skip<span class="main">,</span> Normal <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Normal <span class="bound">s'</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Skip<span class="main">,</span> Fault <span class="bound">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> converse_rtranclp_induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> c s' s f p<span class="hidden">⇩</span><sub>1</sub> p<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Skip"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Seq_decomp_Skip<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Throw"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Seq_decomp_Throw<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Seq_decomp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">s'</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> converse_rtranclp_into_rtranclp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">s'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> converse_rtranclp_into_rtranclp<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> steps_Fault_prop<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">p<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">f</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> steps_Fault<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>  converse_rtranclp_into_rtranclp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> steps_Stuck_prop<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> Seq_decomp_relpowp_Stuck<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Seq <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Normal <span class="free">s</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇧</span><sup>n</sup></span><span class="free">n</span> <span class="main">(</span>Skip<span class="main">,</span> Stuck<span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">∃</span><span class="bound">n1</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> Normal <span class="free">s</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇧</span><sup>n</sup></span><span class="bound">n1</span> <span class="main">(</span>Skip<span class="main">,</span> Stuck<span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
 <span class="main">(</span><span class="main">∃</span><span class="bound">t</span> <span class="bound">n1</span> <span class="bound">n2</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> Normal <span class="free">s</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇧</span><sup>n</sup></span><span class="bound">n1</span> <span class="main">(</span>Skip<span class="main">,</span> Normal <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">n1</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">n2</span> <span class="main">&lt;</span> <span class="free">n</span>  <span class="main">∧</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Normal <span class="bound">t</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇧</span><sup>n</sup></span><span class="bound">n2</span> <span class="main">(</span>Skip<span class="main">,</span> Stuck<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">p<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> relpowp.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> relpowp_commute<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> n s p<span class="hidden">⇩</span><sub>1</sub> a b<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Skip"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Seq_decomp_Skip<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Throw"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Seq_decomp_Throw<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> Seq_decomp <span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s p1 t p1'<span class="main">)</span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> Normal <span class="bound">v</span> <span class="main">=</span> <span class="improper">t</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> v<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">v</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">p1'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> n1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">n1</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> relpowp_Suc_I2<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> t n1 n2<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">n1</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> relpowp_commute<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> mp<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> relcomppI<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="improper">t</span> <span class="main">=</span> Fault <span class="bound">v</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> relpowp_imp_rtranclp<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> steps_Fault_prop<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> p1'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">p1'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> steps_Stuck<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> rtranclp_imp_relpowp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> n'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">n'</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> relpowp_commute<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> relcomppI<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Seq_decomp_star_Stuck<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span> <span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">cfg<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Skip<span class="main">,</span> Stuck<span class="main">)</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">p</span> <span class="bound">s</span> <span class="bound">p'</span><span class="main">.</span> <span class="free">cfg<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> Normal <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> 
 <span class="main">(</span><span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> Seq <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span> 
 <span class="main">(</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> Normal <span class="bound">s</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Skip<span class="main">,</span> Stuck<span class="main">)</span><span class="main">)</span>
 <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span>  Normal <span class="bound">s</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Skip<span class="main">,</span> Normal <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Normal <span class="bound">s'</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Skip<span class="main">,</span> Stuck<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> converse_rtranclp_induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> c s' s p<span class="hidden">⇩</span><sub>1</sub> p<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Skip"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Seq_decomp_Skip<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Throw"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Seq_decomp_Throw<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Seq_decomp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s' s p<span class="hidden">⇩</span><sub>1</sub> p<span class="hidden">⇩</span><sub>2</sub> p<span class="hidden">⇩</span><sub>1</sub>'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">s'</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> converse_rtranclp_into_rtranclp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">s'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> converse_rtranclp_into_rtranclp<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> steps_Fault_prop<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">p<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> steps_Stuck<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> steps_Stuck_prop<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> Catch_decomp_star<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">,</span> <span class="operator">OF</span> _ _ refl<span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">" <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">cfg<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">cfg<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span>
    <span class="main">∀</span><span class="bound">p</span> <span class="bound">s</span> <span class="bound">p'</span> <span class="bound">s'</span><span class="main">.</span>
       <span class="free">cfg<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> Normal <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="free">cfg<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span><span class="bound">p'</span><span class="main">,</span> Normal <span class="bound">s'</span><span class="main">)</span> <span class="main">⟶</span>
       final <span class="main">(</span><span class="bound">p'</span><span class="main">,</span> Normal <span class="bound">s'</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span>
           <span class="bound">p</span> <span class="main">=</span> Catch <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span>
           <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> Normal <span class="bound">s</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Throw<span class="main">,</span> Normal <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Normal <span class="bound">t</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="bound">p'</span><span class="main">,</span> Normal <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
           <span class="main">(</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> Normal <span class="bound">s</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Skip<span class="main">,</span> Normal <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">p'</span> <span class="main">=</span> Skip<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> converse_rtranclp_induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a b s p' s' p<span class="hidden">⇩</span><sub>1</sub> p<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_Normal_elim_cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> t<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> no_steps_final <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s s' p<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> steps_Fault_prop<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> steps_Stuck_prop<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Catch_decomp_Skip<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span> <span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">p'</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">⟹</span> 
 <span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free">p</span> <span class="main">=</span> Catch Skip <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span> <span class="free">s'</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> <span class="free">p'</span> <span class="main">=</span> Skip"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> step_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> step.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Catch_decomp<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span> <span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">p'</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">⟹</span> 
 <span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free">p</span> <span class="main">=</span> Catch <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> Skip <span class="main">⟶</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> Throw <span class="main">⟶</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">p'</span> <span class="main">=</span> Catch <span class="bound">p<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> step_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> redex_size<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> redex_size<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Catch_decomp_star_Fault<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span> <span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">cfg<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">cfg<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">p</span> <span class="bound">s</span> <span class="bound">f</span><span class="main">.</span> <span class="free">cfg<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> Normal <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">cfg<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span>Skip<span class="main">,</span> Fault <span class="bound">f</span><span class="main">)</span> <span class="main">⟶</span> 
 <span class="main">(</span><span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> Catch <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span> 
 <span class="main">(</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> Normal <span class="bound">s</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Skip<span class="main">,</span> Fault <span class="bound">f</span><span class="main">)</span><span class="main">)</span> 
 <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span>  Normal <span class="bound">s</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Throw<span class="main">,</span> Normal <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Normal <span class="bound">s'</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Skip<span class="main">,</span> Fault <span class="bound">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> converse_rtranclp_induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> c s' s f p<span class="hidden">⇩</span><sub>1</sub> p<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Skip"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Catch_decomp_Skip<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Throw"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">s'</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_Normal_elim_cases<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> no_step_final <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>final_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_elim_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">c<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">f</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> steps_Fault<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> steps_Fault_prop<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> steps_Stuck_prop<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Catch_decomp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> p<span class="hidden">⇩</span><sub>1</sub>'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">s'</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> converse_rtranclp_into_rtranclp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">s'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> converse_rtranclp_into_rtranclp<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> steps_Fault_prop<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">p<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">f</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> steps_Fault<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>  converse_rtranclp_into_rtranclp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> steps_Stuck_prop<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Catch_decomp_star_Stuck<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span> <span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">cfg<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">cfg<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">p</span> <span class="bound">s</span><span class="main">.</span> <span class="free">cfg<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> Normal <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">cfg<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span>Skip<span class="main">,</span> Stuck<span class="main">)</span> <span class="main">⟶</span> 
 <span class="main">(</span><span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> Catch <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span> 
 <span class="main">(</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> Normal <span class="bound">s</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Skip<span class="main">,</span> Stuck<span class="main">)</span><span class="main">)</span> 
 <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span>  Normal <span class="bound">s</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Throw<span class="main">,</span> Normal <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Normal <span class="bound">s'</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Skip<span class="main">,</span> Stuck<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> converse_rtranclp_induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> c s' s p<span class="hidden">⇩</span><sub>1</sub> p<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Skip"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Catch_decomp_Skip<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Throw"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">s'</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_Normal_elim_cases<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> no_step_final <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>final_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_elim_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> c<span class="hidden">⇩</span><sub>1</sub>'<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">c<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> steps_Fault<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> steps_Fault_prop<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>

   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_elim_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">c<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> steps_Stuck<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Catch_decomp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> p<span class="hidden">⇩</span><sub>1</sub>'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">s'</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> converse_rtranclp_into_rtranclp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">s'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> converse_rtranclp_into_rtranclp<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> steps_Fault_prop<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">p<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> steps_Stuck<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="OG_Soundness">
<div class="head">
<h1>Theory OG_Soundness</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright 2016, Data61, CSIRO
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(DATA61_BSD)
 *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Soundness proof of Owicki-Gries w.r.t.
           COMPLX small-step semantics›</span></span>

<span class="keyword1"><span class="command">theory</span></span> OG_Soundness
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="OG_Hoare.html">OG_Hoare</a>
  <a href="SeqCatch_decomp.html">SeqCatch_decomp</a>  
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pre_weaken_pre<span class="main">:</span>
 <span class="quoted"><span class="quoted">" <span class="free">x</span> <span class="main">∈</span> pre <span class="free">P</span>  <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> pre <span class="main">(</span>weaken_pre <span class="free">P</span> <span class="free">P'</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">P</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_Skip<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span><span class="main">:</span> 
<span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> Skip <span class="main">⟶</span> 
 <span class="main">(</span><span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="free">P</span> <span class="main">=</span> AnnExpr <span class="bound">P'</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> oghoare_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Γ Θ F P Q A P' Q' A' P''<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">P</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_Throw<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span><span class="main">:</span> 
<span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> Throw <span class="main">⟶</span> 
 <span class="main">(</span><span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="free">P</span> <span class="main">=</span> AnnExpr <span class="bound">P'</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> oghoare_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Γ Θ F P Q A P' Q' A' P''<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">P</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_Basic<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span><span class="main">:</span> 
<span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> Basic <span class="free">f</span> <span class="main">⟶</span> 
 <span class="main">(</span><span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="free">P</span> <span class="main">=</span> AnnExpr <span class="bound">P'</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> oghoare_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Γ Θ F P Q A P' Q' A' P''<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">P</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_Spec<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span><span class="main">:</span> 
<span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> Spec <span class="free">r</span> <span class="main">⟶</span> 
 <span class="main">(</span><span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="free">P</span> <span class="main">=</span> AnnExpr <span class="bound">P'</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">⟶</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> oghoare_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Γ Θ F P Q A P' Q' A' P''<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">P</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_DynCom<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span><span class="main">:</span> 
<span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span>DynCom <span class="free">c'</span><span class="main">)</span> <span class="main">⟶</span> 
 <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">ad</span><span class="main">.</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span>AnnRec <span class="bound">r</span> <span class="bound">ad</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">⊆</span> pre <span class="bound">ad</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="bound">r</span><span class="main">.</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="bound">ad</span> <span class="main">(</span><span class="free">c'</span> <span class="bound">s</span><span class="main">)</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> oghoare_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Γ Θ F P Q A P' Q' A' P'' x<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">P</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> P s<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_Guard<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span><span class="main">:</span> 
<span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span><span class="free">Θ</span>⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> Guard <span class="free">f</span> <span class="free">g</span> <span class="free">d</span> <span class="main">⟶</span> 
 <span class="main">(</span><span class="main">∃</span><span class="bound">P'</span> <span class="bound">r</span> <span class="main">.</span> <span class="free">P</span> <span class="main">=</span> AnnRec <span class="bound">r</span> <span class="bound">P'</span> <span class="main">∧</span> 
   <span class="free">Γ</span><span class="main">,</span><span class="free">Θ</span>⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="bound">P'</span> <span class="free">d</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">∧</span>
   <span class="bound">r</span> <span class="main">∩</span> <span class="free">g</span> <span class="main">⊆</span> pre <span class="bound">P'</span> <span class="main">∧</span>
   <span class="main">(</span><span class="bound">r</span> <span class="main">∩</span> <span class="main">-</span><span class="free">g</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="free">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> oghoare_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Γ Θ F P Q A P' Q' A' P'' r<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">P</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> r<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Q'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">A'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">r</span> <span class="main">∪</span> <span class="improper">P'</span><span class="main">)</span> <span class="main">∩</span> <span class="free">g</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> equalityD1<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_Await<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span><span class="main">:</span> 
<span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span>⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">x</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> Await <span class="bound">b</span> <span class="bound">c</span> <span class="main">⟶</span>
 <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">P'</span> <span class="bound">Q'</span> <span class="bound">A'</span><span class="main">.</span> <span class="free">P</span> <span class="main">=</span> AnnRec <span class="bound">r</span> <span class="bound">P'</span> <span class="main">∧</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span>⊩<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span><span class="main">(</span><span class="bound">r</span> <span class="main">∩</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">P'</span> <span class="bound">c</span> <span class="bound">Q'</span><span class="main">,</span><span class="bound">A'</span> <span class="main">∧</span> atom_com <span class="bound">c</span> 
                 <span class="main">∧</span> <span class="bound">Q'</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">∧</span> <span class="bound">A'</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> oghoare_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Γ Θ F r P Q A<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Q</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">A</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Γ Θ F P c Q A<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">P</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> P'' Q'' A'' x y<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Q''</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">A''</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> SeqConseq<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_Seq<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span><span class="main">:</span> 
<span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">x</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">p1</span> <span class="bound">p2</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> Seq <span class="bound">p1</span> <span class="bound">p2</span> <span class="main">⟶</span>
 <span class="main">(</span><span class="main">∃</span> <span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">P'</span> <span class="bound">Q'</span> <span class="bound">A'</span><span class="main">.</span> <span class="free">P</span> <span class="main">=</span> AnnComp <span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">p1</span> <span class="bound">P'</span><span class="main">,</span> <span class="bound">A'</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊆</span> pre <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span>
         <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">p2</span> <span class="bound">Q'</span><span class="main">,</span><span class="bound">A'</span> <span class="main">∧</span>
          <span class="bound">Q'</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">∧</span> <span class="bound">A'</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> oghoare_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Γ Θ F P c Q A<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> P'' Q'' A''<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">P</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">P''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Q''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">A''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">P'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">P''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">A''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_Catch<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span><span class="main">:</span> 
<span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">x</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">p1</span> <span class="bound">p2</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> Catch <span class="bound">p1</span> <span class="bound">p2</span> <span class="main">⟶</span>
 <span class="main">(</span><span class="main">∃</span> <span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">P'</span> <span class="bound">Q'</span> <span class="bound">A'</span><span class="main">.</span> <span class="free">P</span> <span class="main">=</span> AnnComp <span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">p1</span> <span class="bound">Q'</span><span class="main">,</span> <span class="bound">P'</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="main">⊆</span> pre <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span>
         <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">p2</span> <span class="bound">Q'</span><span class="main">,</span><span class="bound">A'</span> <span class="main">∧</span>
          <span class="bound">Q'</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">∧</span> <span class="bound">A'</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> oghoare_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Γ Θ F P c Q A<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">P</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> P'' Q'' A'' x<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">P''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Q''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">P'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">A''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_Cond<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span><span class="main">:</span> 
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">x</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span>
<span class="main">∀</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">b</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span>Cond <span class="bound">b</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⟶</span>
<span class="main">(</span><span class="main">∃</span><span class="bound">P'</span> <span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">Q'</span> <span class="bound">A'</span><span class="main">.</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span>AnnBin <span class="bound">P'</span> <span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∧</span>
  <span class="bound">P'</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">∈</span><span class="bound">b</span> <span class="main">⟶</span> <span class="bound">s</span><span class="main">∈</span>pre <span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s</span><span class="main">∉</span><span class="bound">b</span> <span class="main">⟶</span> <span class="bound">s</span><span class="main">∈</span>pre <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">}</span> <span class="main">∧</span>
    <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">Q'</span><span class="main">,</span><span class="bound">A'</span> <span class="main">∧</span>
    <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">Q'</span><span class="main">,</span><span class="bound">A'</span> <span class="main">∧</span> <span class="bound">Q'</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">∧</span> <span class="bound">A'</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> oghoare_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span>  Q A P<span class="hidden">⇩</span><sub>2</sub> c<span class="hidden">⇩</span><sub>2</sub> r b<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Q</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">A</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Γ Θ F P c Q A<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">P</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_While<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">x</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span>
    <span class="main">∀</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> While <span class="bound">b</span> <span class="bound">c</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∃</span> <span class="bound">r</span> <span class="bound">i</span> <span class="bound">P'</span> <span class="bound">A'</span> <span class="bound">Q'</span><span class="main">.</span> <span class="free">P</span> <span class="main">=</span> AnnWhile <span class="bound">r</span> <span class="bound">i</span> <span class="bound">P'</span> <span class="main">∧</span>
     <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span>⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="bound">P'</span> <span class="bound">c</span> <span class="bound">i</span><span class="main">,</span><span class="bound">A'</span> <span class="main">∧</span>
     <span class="bound">r</span> <span class="main">⊆</span> <span class="bound">i</span> <span class="main">∧</span>
     <span class="bound">i</span> <span class="main">∩</span> <span class="bound">b</span> <span class="main">⊆</span> pre <span class="bound">P'</span> <span class="main">∧</span>
     <span class="bound">i</span> <span class="main">∩</span> <span class="main">-</span><span class="bound">b</span> <span class="main">⊆</span> <span class="bound">Q'</span> <span class="main">∧</span>
      <span class="bound">Q'</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">∧</span> <span class="bound">A'</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> oghoare_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Γ Θ F P c Q A<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> P' Q' A' b ca r i P'' A'' Q''<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">P</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">A''</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">Q'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>


<span class="keyword1"><span class="command">lemma</span></span> oghoare_Call<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span><span class="free">Θ</span>⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">x</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span>
  <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> Call <span class="bound">p</span> <span class="main">⟶</span>
 <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">n</span><span class="main">.</span>
 <span class="free">P</span> <span class="main">=</span> <span class="main">(</span>AnnCall <span class="bound">r</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span>
 <span class="main">(</span><span class="main">∃</span><span class="bound">as</span> <span class="bound">P'</span> <span class="bound">f</span> <span class="bound">b</span><span class="main">.</span>
 <span class="free">Θ</span> <span class="bound">p</span> <span class="main">=</span> Some <span class="bound">as</span> <span class="main">∧</span>
 <span class="main">(</span><span class="bound">as</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="bound">P'</span> <span class="main">∧</span>
 <span class="bound">r</span> <span class="main">⊆</span> pre <span class="bound">P'</span> <span class="main">∧</span>
 <span class="free">Γ</span> <span class="bound">p</span> <span class="main">=</span> Some <span class="bound">b</span> <span class="main">∧</span>
 <span class="bound">n</span> <span class="main">&lt;</span> length <span class="bound">as</span> <span class="main">∧</span>
 <span class="free">Γ</span><span class="main">,</span><span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="bound">P'</span> <span class="bound">b</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> oghoare_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Γ Θ F P c Q A<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">P</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_Parallel<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span><span class="main">:</span> 
<span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span>⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">x</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">cs</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> Parallel <span class="bound">cs</span> <span class="main">⟶</span>
 <span class="main">(</span><span class="main">∃</span><span class="bound">as</span><span class="main">.</span> <span class="free">P</span> <span class="main">=</span> AnnPar <span class="bound">as</span> <span class="main">∧</span> 
   length <span class="bound">as</span> <span class="main">=</span> length <span class="bound">cs</span> <span class="main">∧</span>
   <span class="main">⋂</span><span class="main">(</span>set <span class="main">(</span>map postcond <span class="bound">as</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">∧</span>
   <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map abrcond <span class="bound">as</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="bound">cs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">Q'</span> <span class="bound">A'</span><span class="main">.</span> <span class="free">Γ</span><span class="main">,</span><span class="free">Θ</span>⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span>pres <span class="main">(</span><span class="bound">as</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">cs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="bound">Q'</span><span class="main">,</span> <span class="bound">A'</span> <span class="main">∧</span>
            <span class="bound">Q'</span> <span class="main">⊆</span> postcond <span class="main">(</span><span class="bound">as</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">A'</span> <span class="main">⊆</span> abrcond <span class="main">(</span><span class="bound">as</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  interfree <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="bound">as</span> <span class="bound">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> oghoare_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">P</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span>  ann_matches_weaken<span class="main">[</span><span class="operator">OF</span> _ refl<span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">" ann_matches <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">X</span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">=</span> <span class="main">(</span>weaken_pre <span class="free">P</span> <span class="free">P'</span><span class="main">)</span> <span class="main">⟹</span> ann_matches <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">P</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ann_matches.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">P</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ann_matches.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> oghoare_seq_imp_ann_matches<span class="main">:</span>
 <span class="quoted"><span class="quoted">" <span class="free">Γ</span><span class="main">,</span><span class="free">Θ</span>⊩<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">a</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span> ann_matches <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">a</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> oghoare_seq_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ann_matches.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> ann_matches_weaken<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_imp_ann_matches<span class="main">:</span>
 <span class="quoted"><span class="quoted">" <span class="free">Γ</span><span class="main">,</span><span class="free">Θ</span>⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">a</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span> ann_matches <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">a</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> oghoare_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ann_matches.intros oghoare_seq_imp_ann_matches<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> ann_matches_weaken<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* intros *)</span>

<span class="keyword1"><span class="command">lemma</span></span> SkipRule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnExpr <span class="free">P</span><span class="main">)</span> Skip <span class="free">Q</span><span class="main">,</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Skip<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> ThrowRule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnExpr <span class="free">P</span><span class="main">)</span> Throw <span class="free">Q</span><span class="main">,</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Throw<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> BasicRule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnExpr <span class="free">P</span><span class="main">)</span> <span class="main">(</span>Basic <span class="free">f</span><span class="main">)</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">f</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">Q</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">}</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Basic<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> SpecRule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">⟶</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main">)</span><span class="main">}</span>
    <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnExpr <span class="free">P</span><span class="main">)</span> <span class="main">(</span>Spec <span class="free">r</span><span class="main">)</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">∀</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">⟶</span></span> <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">Q</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">∃</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">r</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">⟶</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">⟶</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> CondRule<span class="main">:</span> 
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">∈</span><span class="free">b</span> <span class="main">⟶</span> <span class="bound">s</span><span class="main">∈</span>pre <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s</span><span class="main">∉</span><span class="free">b</span> <span class="main">⟶</span> <span class="bound">s</span><span class="main">∈</span>pre <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">}</span><span class="main">;</span>
    <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span><span class="main">;</span> 
    <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span>  <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnBin <span class="free">P</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>Cond <span class="free">b</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Cond<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> WhileRule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">r</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">;</span> <span class="free">I</span> <span class="main">∩</span> <span class="free">b</span> <span class="main">⊆</span> pre <span class="free">P</span><span class="main">;</span> <span class="main">(</span><span class="free">I</span> <span class="main">∩</span> <span class="main">-</span><span class="free">b</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">;</span>
                    <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">c</span> <span class="free">I</span><span class="main">,</span><span class="free">A</span> <span class="main">⟧</span>  
        <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnWhile <span class="free">r</span> <span class="free">I</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span>While <span class="free">b</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> While<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> AwaitRule<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>atom_com <span class="free">c</span> <span class="main">;</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊩<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span><span class="free">P</span> <span class="free">a</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">;</span> <span class="main">(</span><span class="free">r</span> <span class="main">∩</span> <span class="free">b</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnRec <span class="free">r</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>Await <span class="free">b</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Await<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> SeqConseq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> rtranclp_1n_induct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">a</span> <span class="free">b</span><span class="main">;</span> <span class="free">P</span> <span class="free">a</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">⟦</span><span class="free">r</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">;</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">z</span> <span class="free">b</span><span class="main">;</span> <span class="free">P</span> <span class="bound">y</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">z</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">b</span>"</span></span> 
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main">)</span> 
    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rtranclp.rtrancl_into_rtrancl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> rtranclp_1n_induct2<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span> <span class="main">=</span> 
  rtranclp_1n_induct<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ax</span><span class="main">,</span><span class="free">ay</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">bx</span><span class="main">,</span><span class="free">by</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">split_rule</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_seq_valid<span class="main">:</span>
 <span class="quoted"><span class="quoted">" <span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">R</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span>
   <span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">R</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span>
   <span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> Seq <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> t c' s<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">t</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Seq_decomp_star<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s1 t'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">t'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Skip"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Seq_decomp_star_Fault<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Fault <span class="improper">s2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Skip"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s s2 s'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">s'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec2<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Skip"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">s'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Fault <span class="improper">s2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec2<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Skip"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Seq_decomp_star_Stuck<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_if_valid<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span>
  <span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span>
  <span class="free">r</span> <span class="main">∩</span> <span class="free">b</span> <span class="main">⊆</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∩</span> <span class="main">-</span> <span class="free">b</span> <span class="main">⊆</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span>
  <span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">r</span> Cond <span class="free">b</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> converse_rtranclpE<span class="main">)</span> 
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_Normal_elim_cases<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_def<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_def<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Skip_normal_steps_end<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Skip<span class="main">,</span> Normal <span class="free">s</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> Skip <span class="main">∧</span> <span class="free">s'</span> <span class="main">=</span> Normal <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span>  <span class="main">(</span><span class="operator">erule</span> converse_rtranclpE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_Normal_elim_cases<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Throw_normal_steps_end<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Throw<span class="main">,</span> Normal <span class="free">s</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> Throw <span class="main">∧</span> <span class="free">s'</span> <span class="main">=</span> Normal <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span>  <span class="main">(</span><span class="operator">erule</span> converse_rtranclpE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_Normal_elim_cases<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> while_relpower_induct<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">c'</span> <span class="bound">x</span> <span class="main">.</span>
       <span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">c</span> <span class="free">i</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span>
       <span class="free">i</span> <span class="main">∩</span> <span class="free">b</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">⟹</span>
       <span class="free">i</span> <span class="main">∩</span> <span class="main">-</span> <span class="free">b</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">⟹</span>
       final <span class="main">(</span><span class="bound">c'</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="bound">x</span> <span class="main">∈</span> <span class="free">i</span> <span class="main">⟹</span>
       <span class="bound">t</span> <span class="main">∉</span> Fault <span class="main">`</span> <span class="free">F</span> <span class="main">⟹</span>
       <span class="bound">c'</span> <span class="main">=</span> Throw <span class="main">⟶</span> <span class="bound">t</span> <span class="main">∉</span> Normal <span class="main">`</span> <span class="free">A</span> <span class="main">⟹</span>
       <span class="main">(</span>step <span class="free">Γ</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>While <span class="free">b</span> <span class="free">c</span><span class="main">,</span> Normal <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">c'</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">c'</span> <span class="main">=</span> Skip <span class="main">∧</span> <span class="bound">t</span> <span class="main">∈</span> Normal <span class="main">`</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>less_induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> n t c' x<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">n</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> relpowp.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> relpowp_commute<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_Normal_elim_cases<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> t c' x v<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">t</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> Seq_decomp_relpow<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> relpowp_imp_rtranclp<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x n t' n1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">t'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">Throw</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> c' x n t' t n1 n2<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">t'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec2<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">c'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec2<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meta_impE<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meta_impE<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meta_impE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> relpowp_imp_rtranclp<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">Skip</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> c' s n f<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">c'</span> <span class="main">=</span> Skip"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">c'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Seq_decomp_relpowp_Fault<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Fault <span class="improper">f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec2<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">Skip</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> relpowp_imp_rtranclp<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> t n1 n2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">t</span> <span class="main">∈</span> <span class="free">i</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>relpowp_imp_rtranclp <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def valid_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Fault <span class="improper">f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_spec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">Skip</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> c' s n<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">c'</span> <span class="main">=</span> Skip"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">c'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Seq_decomp_relpowp_Stuck<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>valid_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Stuck"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec2<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">Skip</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> relpowp_imp_rtranclp<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> t n1 n2<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">t</span> <span class="main">∈</span> <span class="free">i</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>relpowp_imp_rtranclp <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def valid_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_spec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">Stuck</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_spec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">Skip</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> relpowp_imp_rtranclp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Skip_normal_steps_end<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_weaken_pre<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span>
  <span class="free">P'</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P'</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_strengthen_post<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span>
  <span class="free">Q</span> <span class="main">⊆</span> <span class="free">Q'</span> <span class="main">⟹</span> <span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q'</span><span class="main">,</span><span class="free">A</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_strengthen_abr<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span>
  <span class="free">A</span> <span class="main">⊆</span> <span class="free">A'</span> <span class="main">⟹</span> <span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A'</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_while_valid<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">c</span> <span class="free">i</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span>
  <span class="free">i</span> <span class="main">∩</span> <span class="free">b</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">⟹</span>
  <span class="free">i</span> <span class="main">∩</span> <span class="main">-</span> <span class="free">b</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">⟹</span>
  <span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">i</span> While <span class="free">b</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> rtranclp_imp_relpowp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> while_relpower_induct<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_catch_valid<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">Q</span><span class="main">,</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span>
  <span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span>
    <span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> Catch <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"Catch <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> t c' s<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">t</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>            
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Catch_decomp_star<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s x t<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted">Throw</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def valid_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s t<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted">Skip</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> c' s t<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Catch_decomp_star_Fault<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_def<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">]</span></span> final_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_def final_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Catch_decomp_star_Stuck<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_def<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">]</span></span> final_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_def final_def<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> ann_matches_imp_assertionsR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ann_matches <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">a</span> <span class="free">c</span> <span class="main">⟹</span> <span class="main">¬</span> pre_par <span class="free">a</span> <span class="main">⟹</span>
    assertionsR <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">Q</span> <span class="free">A</span> <span class="free">a</span> <span class="free">c</span> <span class="main">(</span>pre <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="quoted"><span class="free">A</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ann_matches.induct <span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>  assertionsR.intros <span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ann_matches_imp_assertionsR'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ann_matches <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">a</span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">a'</span> <span class="main">∈</span> pre_set <span class="free">a</span> <span class="main">⟹</span>
    assertionsR <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">Q</span> <span class="free">A</span> <span class="free">a</span> <span class="free">c</span> <span class="free">a'</span>"</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="quoted"><span class="free">A</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ann_matches.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>  assertionsR.intros <span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>12<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> bexE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> AsParallelExprs<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> rtranclp_conjD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x1</span> <span class="bound">x2</span><span class="main">.</span> <span class="free">r1</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="main">∧</span> <span class="free">r2</span> <span class="bound">x1</span> <span class="bound">x2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">x1</span> <span class="free">x2</span> <span class="main">⟹</span>
  <span class="free">r1</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">x1</span> <span class="free">x2</span> <span class="main">∧</span> <span class="free">r2</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">x1</span> <span class="free">x2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> rtrancl_mono_proof<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rtranclp_mono' <span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">s</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">a</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rtrancl_mono_proof sup.orderE sup2CI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> state_upd_in_atomicsR<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl refl<span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">⊢</span> <span class="free">cf</span> <span class="main">→</span> <span class="free">cf'</span> <span class="main">⟹</span>
   <span class="free">cf</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> Normal <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">cf'</span> <span class="main">=</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> Normal <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="free">s</span> <span class="main">≠</span> <span class="free">t</span> <span class="main">⟹</span> 
       ann_matches <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">a</span> <span class="free">c</span> <span class="main">⟹</span>
       <span class="free">s</span> <span class="main">∈</span> pre <span class="free">a</span> <span class="main">⟹</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">cm</span> <span class="bound">x</span><span class="main">.</span> atomicsR <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">a</span> <span class="free">c</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">cm</span><span class="main">)</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">∈</span> <span class="bound">p</span> <span class="main">∧</span>
       <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="bound">cm</span><span class="main">,</span> Normal <span class="free">s</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> Normal <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> final <span class="main">(</span><span class="bound">x</span><span class="main">,</span> Normal <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> step.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span>  ann_matches.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> atomicsR.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Skip"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> step.Basic<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span>  ann_matches.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> atomicsR.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Skip"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step.Spec<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span>  ann_matches.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>        
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_spec<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meta_impE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> meta_impE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meta_impE<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> AtSeqExpr1<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span>  ann_matches.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>        
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_spec<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meta_impE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> meta_impE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meta_impE<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> AtCatchExpr1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span>  ann_matches.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_spec<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meta_impE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meta_impE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meta_impE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span><span class="main">=</span><span class="main">0</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> AtParallelExprs<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ann_matches.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AtAwait<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> c' sa t aa e r ba<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">c'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step.Await<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> rtranclp_mono'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_atom_com_sound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊩<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span><span class="free">P</span> <span class="free">a</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span> atom_com <span class="free">c</span> <span class="main">⟹</span> <span class="free">Γ</span> ⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span>"</span></span>
 <span class="keyword1"><span class="command">unfolding</span></span> valid_def 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> oghoare_seq_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> SeqSkip <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> 
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> converse_rtranclpE step_Normal_elim_cases<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> SeqThrow <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> 
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> converse_rtranclpE step_Normal_elim_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> SeqBasic <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> 
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> converse_rtranclpE step_Normal_elim_cases 
            <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SeqSpec <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">r</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> converse_rtranclpE<span class="main">)</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_Normal_elim_cases<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> converse_rtranclpE step_Normal_elim_cases<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SeqSeq <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Q</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> SeqSeq
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> valid_def<span class="main">)</span> 
        <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> oghoare_seq_valid <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_weaken_pre<span class="main">)</span>
   <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SeqCatch <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Q</span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> valid_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>  oghoare_catch_valid<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SeqCond <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">b</span> <span class="skolem">c1</span> <span class="skolem">Q</span> <span class="skolem">A</span> <span class="skolem">c2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> valid_def<span class="main">)</span>
        <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>oghoare_if_valid<span class="main">)</span>
   <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SeqWhile <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">c</span> <span class="skolem">A</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> valid_def<span class="main">)</span>
        <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> valid_weaken_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> oghoare_while_valid<span class="main">)</span>
   <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SeqGuard <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">c</span> <span class="skolem">Q</span> <span class="skolem">A</span> <span class="skolem">r</span> <span class="skolem">g</span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> valid_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> converse_rtranclpE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_Normal_elim_cases<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∩</span> <span class="main">-</span> <span class="skolem">g</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∩</span> <span class="main">-</span> <span class="skolem">g</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> no_steps_final <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>final_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> no_steps_final <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>final_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SeqCall <span class="skolem">Γ</span> <span class="skolem">p</span> <span class="skolem">f</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command">next</span></span>

    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SeqDynCom <span class="skolem">r</span> <span class="skolem">fa</span> <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">c</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> converse_rtranclpE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_Normal_elim_cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> t c' x<span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">c'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SeqConseq <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">c</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> t c' x<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">c'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_weaken_pre<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> ParallelRuleAnn<span class="main">:</span>
<span class="quoted"><span class="quoted">" length <span class="free">as</span> <span class="main">=</span> length <span class="free">cs</span> <span class="main">⟹</span>
  <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">cs</span><span class="main">.</span> <span class="free">Γ</span><span class="main">,</span><span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span> </sub><span class="hidden">⇙</span><span class="main">(</span>pres <span class="main">(</span><span class="free">as</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>postcond <span class="main">(</span><span class="free">as</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>abrcond <span class="main">(</span><span class="free">as</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  interfree <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="free">as</span> <span class="free">cs</span> <span class="main">⟹</span>
  <span class="main">⋂</span><span class="main">(</span>set <span class="main">(</span>map postcond <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">⟹</span>
  <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map abrcond <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span><span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span> </sub><span class="hidden">⇙</span><span class="main">(</span>AnnPar <span class="free">as</span><span class="main">)</span> <span class="main">(</span>Parallel <span class="free">cs</span><span class="main">)</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span>"</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Parallel<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_step<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl refl<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">cf</span> <span class="main">→</span> <span class="free">cf'</span> <span class="main">⟹</span> <span class="free">cf</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> Normal <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">cf'</span> <span class="main">=</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> Normal <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">Γ</span><span class="main">,</span><span class="free">Θ</span>⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span> </sub><span class="hidden">⇙</span><span class="free">a</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span>
 <span class="free">s</span> <span class="main">∈</span> pre <span class="free">a</span> <span class="main">⟹</span>
<span class="main">∃</span><span class="bound">a'</span><span class="main">.</span> <span class="free">Γ</span><span class="main">,</span><span class="free">Θ</span>⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span> </sub><span class="hidden">⇙</span><span class="bound">a'</span> <span class="free">c'</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">∈</span> pre <span class="bound">a'</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">as</span><span class="main">.</span> assertionsR <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">Q</span> <span class="free">A</span> <span class="bound">a'</span> <span class="free">c'</span> <span class="bound">as</span> <span class="main">⟶</span> assertionsR <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">Q</span> <span class="free">A</span> <span class="free">a</span> <span class="free">c</span> <span class="bound">as</span><span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">pm</span> <span class="bound">cm</span><span class="main">.</span> atomicsR <span class="free">Γ</span> <span class="free">Θ</span> <span class="bound">a'</span> <span class="free">c'</span> <span class="main">(</span><span class="bound">pm</span><span class="main">,</span> <span class="bound">cm</span><span class="main">)</span> <span class="main">⟶</span> atomicsR <span class="free">Γ</span> <span class="free">Θ</span>  <span class="free">a</span> <span class="free">c</span> <span class="main">(</span><span class="bound">pm</span><span class="main">,</span> <span class="bound">cm</span><span class="main">)</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> step.induct<span class="main">)</span>
   <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Parallel <span class="skolem">i</span> <span class="skolem">cs</span> <span class="skolem">s</span> <span class="skolem">c'</span> <span class="skolem">s'</span> <span class="skolem">ca</span> <span class="skolem">c'a</span> <span class="skolem">sa</span> <span class="skolem">a</span> <span class="skolem">t</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Parallel<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> as<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> impE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>


     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_spec<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meta_impE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meta_impE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>pres <span class="main">(</span><span class="improper">as</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> Conseq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Q'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">A'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meta_impE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"AnnPar <span class="main">(</span><span class="improper">as</span><span class="main">[</span><span class="skolem">i</span><span class="main">:=</span><span class="main">(</span><span class="improper">a'</span><span class="main">,</span>postcond<span class="main">(</span><span class="improper">as</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">,</span> abrcond<span class="main">(</span><span class="improper">as</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ParallelRuleAnn<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> j<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="improper">j</span>"</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> i' j'<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">j'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec2<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="improper">i'</span>"</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interfree_aux_def prod.case_eq_if <span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">j'</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interfree_aux_def prod.case_eq_if<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> subsetD<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a' x a b c i'<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i'</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">a'</span><span class="main">,</span> <span class="improper">b</span><span class="main">,</span> <span class="improper">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">a</span><span class="main">,</span> <span class="improper">b</span><span class="main">,</span> <span class="improper">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="improper">as</span><span class="main">.</span> abrcond <span class="bound">x</span><span class="main">)</span> "</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span>  subsetD<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a b c j<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">j</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">as</span><span class="main">!</span><span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">a</span><span class="main">,</span><span class="improper">b</span><span class="main">,</span><span class="improper">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> Normal <span class="skolem">t</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a b c j<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">j</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">as</span><span class="main">!</span><span class="improper">j</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> state_upd_in_atomicsR<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> oghoare_imp_ann_matches<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> j<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">j</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span><span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span> </sub><span class="hidden">⇙</span><span class="improper">a'</span> <span class="skolem">c'</span>  <span class="main">(</span>postcond <span class="main">(</span><span class="improper">as</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>abrcond <span class="main">(</span><span class="improper">as</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interfree_def interfree_aux_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">j</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.case_eq_if<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec2<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"pre_par <span class="improper">a</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> pre_set<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">as</span><span class="main">!</span><span class="improper">j</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pre_imp_pre_set<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> as Q' A' a' a b c p cm x j X<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">X</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"assertionsR <span class="free"><span class="free"><span class="free">Γ</span></span></span> <span class="free"><span class="free"><span class="free">Θ</span></span></span> <span class="improper"><span class="improper"><span class="improper">b</span></span></span> <span class="improper"><span class="improper"><span class="improper">c</span></span></span> <span class="improper"><span class="improper"><span class="improper">a</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">cs</span></span></span> <span class="main"><span class="main"><span class="main">!</span></span></span> <span class="improper"><span class="improper"><span class="improper">j</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="improper"><span class="improper"><span class="improper">X</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> impE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ann_matches_imp_assertionsR'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> oghoare_imp_ann_matches<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a b c p cm x j X <span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="improper">b</span> <span class="main">∩</span> <span class="improper">p</span><span class="main">)</span> <span class="improper">cm</span> <span class="improper">b</span><span class="main">,</span><span class="improper">b</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">" <span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="improper">c</span> <span class="main">∩</span> <span class="improper">p</span><span class="main">)</span> <span class="improper">cm</span> <span class="improper">c</span><span class="main">,</span><span class="improper">c</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="skolem">sa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>

   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a b c p cm x j Q'' A''<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"pre <span class="improper">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span><span class="operator">erule</span> impE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ann_matches_imp_assertionsR<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> oghoare_imp_ann_matches<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">" <span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="improper">b</span> <span class="main">∩</span> <span class="improper">p</span><span class="main">)</span> <span class="improper">cm</span> <span class="improper">b</span><span class="main">,</span><span class="improper">b</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">" <span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="improper">c</span> <span class="main">∩</span> <span class="improper">p</span><span class="main">)</span> <span class="improper">cm</span> <span class="improper">c</span><span class="main">,</span><span class="improper">c</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="skolem">sa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">as</span> <span class="main">!</span> <span class="improper">j</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> assertionsR.cases <span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> j a<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">j</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> impE<span class="main">)</span> 
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>  AsParallelExprs<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> nth_list_update_neq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span>  AsParallelExprs<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span>  AsParallelSkips<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a' x a b c j<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">j</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="improper">as</span><span class="main">.</span> <span class="skolem">sa</span> <span class="main">∈</span> precond <span class="bound">a</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">a'</span><span class="main">,</span> <span class="improper">b</span><span class="main">,</span> <span class="improper">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">as</span> <span class="main">!</span> <span class="improper">j</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">" <span class="improper">as</span> <span class="main">!</span> <span class="improper">j</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x a b c j<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="improper">as</span><span class="main">.</span> <span class="skolem">sa</span> <span class="main">∈</span> precond <span class="bound">a</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">j</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">as</span><span class="main">!</span><span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">as</span><span class="main">!</span><span class="improper">j</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> atomicsR.cases <span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> j atc atp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">j</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">atc</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">atp</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec2<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> impE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>  AtParallelExprs<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> nth_list_update_neq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span>  AtParallelExprs<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Basic <span class="skolem">f</span> <span class="skolem">s</span> <span class="skolem">c</span> <span class="skolem">c'</span> <span class="skolem">sa</span> <span class="skolem">a</span> <span class="skolem">t</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Basic<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"AnnExpr <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SkipRule<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assertionsR.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assertionsR.AsBasicSkip<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Spec <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">r</span> <span class="skolem">c</span> <span class="skolem">c'</span> <span class="skolem">sa</span> <span class="skolem">a</span> <span class="skolem">ta</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"AnnExpr <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SkipRule<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> assertionsR.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assertionsR.AsSpecSkip<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Guard <span class="skolem">s</span> <span class="skolem">g</span> <span class="skolem">f</span> <span class="skolem">c</span> <span class="skolem">ca</span> <span class="skolem">c'</span> <span class="skolem">sa</span> <span class="skolem">a</span> <span class="skolem">t</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Guard<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> oghoare_Guard
                 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>assertionsR.intros atomicsR.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>GuardFault <span class="skolem">s</span> <span class="skolem">g</span> <span class="skolem">f</span> <span class="skolem">c</span> <span class="skolem">ca</span> <span class="skolem">c'</span> <span class="skolem">sa</span> <span class="skolem">a</span> <span class="skolem">t</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> oghoare_Guard
                 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>assertionsR.intros atomicsR.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Seq <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">s</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">s'</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c</span> <span class="skolem">c'</span> <span class="skolem">sa</span> <span class="skolem">a</span> <span class="skolem">t</span> <span class="skolem">A</span> <span class="skolem">Q</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Seq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_spec<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meta_impE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meta_impE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"AnnComp <span class="improper">a'</span> <span class="improper">P<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> oghoare_oghoare_seq.Seq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> assertionsR.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> AsSeqExpr1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> AsSeqExpr2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> atomicsR.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec2<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> AtSeqExpr1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> AtSeqExpr2<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SeqSkip <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">s</span> <span class="skolem">c</span> <span class="skolem">c'</span> <span class="skolem">sa</span> <span class="skolem">a</span> <span class="skolem">t</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Seq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> P<span class="hidden">⇩</span><sub>1</sub> P<span class="hidden">⇩</span><sub>2</sub> P' Q' A'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">P<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Conseq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Skip<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> assertionsR.AsSeqExpr2<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> atomicsR.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SeqThrow <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">s</span> <span class="skolem">c</span> <span class="skolem">c'</span> <span class="skolem">sa</span> <span class="skolem">a</span> <span class="skolem">t</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Seq<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> P<span class="hidden">⇩</span><sub>1</sub> P<span class="hidden">⇩</span><sub>2</sub> P' Q' A'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">P<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Throw<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> P''<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Conseq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Q'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">P''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Throw<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> assertionsR.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AsSeqExpr1<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AsThrow<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CondTrue <span class="skolem">s</span> <span class="skolem">b</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c</span> <span class="skolem">sa</span> <span class="skolem">c'</span> <span class="skolem">s'</span> <span class="skolem">ann</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Cond<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> P' P<span class="hidden">⇩</span><sub>1</sub> P<span class="hidden">⇩</span><sub>2</sub> Q' A'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">P<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> assertionsR.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> AsCondExpr1<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> atomicsR.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> AtCondExpr1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CondFalse <span class="skolem">s</span> <span class="skolem">b</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c</span> <span class="skolem">sa</span> <span class="skolem">c'</span> <span class="skolem">s'</span> <span class="skolem">ann</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Cond<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> P' P<span class="hidden">⇩</span><sub>1</sub> P<span class="hidden">⇩</span><sub>2</sub> Q' A'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">P<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> assertionsR.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> AsCondExpr2<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> atomicsR.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> AtCondExpr2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>WhileTrue <span class="skolem">s</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">ca</span> <span class="skolem">sa</span> <span class="skolem">c'</span> <span class="skolem">s'</span> <span class="skolem">ann</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> oghoare_While<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> r i P' A' Q'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"AnnComp <span class="improper">P'</span> <span class="main">(</span>AnnWhile <span class="improper">i</span> <span class="improper">i</span> <span class="improper">P'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Seq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main">)</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">A'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> weaken_pre_empty<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> While<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main">)</span> 
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">A'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> weaken_pre_empty<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> assertionsR.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AsWhileExpr<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> assertionsR.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> AsWhileExpr<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AsWhileInv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AsWhileInv<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AsWhileSkip<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> atomicsR.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AtWhileExpr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> atomicsR.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> AtWhileExpr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>WhileFalse <span class="skolem">s</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">ca</span> <span class="skolem">sa</span> <span class="skolem">c'</span> <span class="skolem">ann</span> <span class="skolem">s'</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_While<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"AnnExpr <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SkipRule<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> assertionsR.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> AsWhileSkip<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Call <span class="skolem">p</span> <span class="skolem">bs</span> <span class="skolem">s</span> <span class="skolem">c</span> <span class="skolem">c'</span> <span class="skolem">sa</span> <span class="skolem">a</span> <span class="skolem">t</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Call<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> n as<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">as</span> <span class="main">!</span> <span class="improper">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> AsCallExpr<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> AtCallExpr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DynCom <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">ca</span> <span class="skolem">c'</span> <span class="skolem">sa</span> <span class="skolem">a</span> <span class="skolem">t</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_DynCom<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> AsDynComExpr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> AtDynCom<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Catch <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">s</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">s'</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c</span> <span class="skolem">c'</span> <span class="skolem">sa</span> <span class="skolem">a</span> <span class="skolem">t</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Catch<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_spec<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meta_impE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meta_impE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> P<span class="hidden">⇩</span><sub>1</sub> P<span class="hidden">⇩</span><sub>2</sub> P' Q' A' a'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"AnnComp <span class="improper">a'</span> <span class="improper">P<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> oghoare_oghoare_seq.Catch<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> assertionsR.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> AsCatchExpr1<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> AsCatchExpr2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> atomicsR.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a b a2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec2<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> AtCatchExpr1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> AtCatchExpr2<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CatchSkip <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">s</span> <span class="skolem">c</span> <span class="skolem">c'</span> <span class="skolem">sa</span> <span class="skolem">a</span> <span class="skolem">t</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Catch<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> P<span class="hidden">⇩</span><sub>1</sub> P<span class="hidden">⇩</span><sub>2</sub> P' Q' A'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">P<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Skip<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Q'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">A'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> SkipRule<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AsCatchExpr1<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> assertionsR.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assertionsR.AsSkip<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CatchThrow <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">s</span> <span class="skolem">c</span> <span class="skolem">c'</span> <span class="skolem">sa</span> <span class="skolem">a</span> <span class="skolem">t</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Catch<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> P<span class="hidden">⇩</span><sub>1</sub> P<span class="hidden">⇩</span><sub>2</sub> P' Q' A'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">P<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Throw<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> AsCatchExpr2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> AtCatchExpr2<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ParSkip <span class="skolem">cs</span> <span class="skolem">s</span> <span class="skolem">c</span> <span class="skolem">c'</span> <span class="skolem">sa</span> <span class="skolem">a</span> <span class="skolem">t</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Parallel<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> as<span class="main">)</span>
    
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"AnnExpr <span class="main">(</span><span class="main">⋂</span><span class="bound">x</span><span class="main">∈</span>set <span class="improper">as</span><span class="main">.</span> postcond <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SkipRule<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">cs</span><span class="main">!</span><span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Skip<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">as</span><span class="main">!</span><span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> assertionsR.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AsParallelSkips<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ParThrow <span class="skolem">cs</span> <span class="skolem">s</span> <span class="skolem">c</span> <span class="skolem">c'</span> <span class="skolem">sa</span> <span class="skolem">a</span> <span class="skolem">t</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Parallel<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Throw<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> i as Q' A' P'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"AnnExpr <span class="improper">P'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ThrowRule<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="improper">as</span><span class="main">.</span> abrcond <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> subsetD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">A</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">as</span><span class="main">!</span><span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> AsParallelExprs<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> assertionsR.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AsThrow<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Await <span class="skolem">x</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">c'</span> <span class="skolem">x'</span> <span class="skolem">c''</span> <span class="skolem">c'''</span> <span class="skolem">x''</span> <span class="skolem">a</span> <span class="skolem">x'''</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Await<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>

   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> rtranclp_conjD<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> P' Q' A'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"AnnExpr <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Skip<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> oghoare_atom_com_sound<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def valid_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> assertionsR.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AsAwaitSkip<span class="main">)</span>

   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"AnnExpr <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Throw<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> oghoare_atom_com_sound<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def valid_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> assertionsR.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AsAwaitThrow<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_steps<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl refl<span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">cf</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">cf'</span> <span class="main">⟹</span> <span class="free">cf</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> Normal <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">cf'</span> <span class="main">=</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> Normal <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">Γ</span><span class="main">,</span><span class="free">Θ</span>⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span> </sub><span class="hidden">⇙</span><span class="free">a</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span>
 <span class="free">s</span> <span class="main">∈</span> pre <span class="free">a</span> <span class="main">⟹</span>
<span class="main">∃</span><span class="bound">a'</span><span class="main">.</span> <span class="free">Γ</span><span class="main">,</span><span class="free">Θ</span>⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span> </sub><span class="hidden">⇙</span><span class="bound">a'</span> <span class="free">c'</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">∈</span> pre <span class="bound">a'</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">as</span><span class="main">.</span> assertionsR <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">Q</span> <span class="free">A</span> <span class="bound">a'</span> <span class="free">c'</span> <span class="bound">as</span> <span class="main">⟶</span> assertionsR <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">Q</span> <span class="free">A</span> <span class="free">a</span> <span class="free">c</span> <span class="bound">as</span><span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">pm</span> <span class="bound">cm</span><span class="main">.</span> atomicsR <span class="free">Γ</span> <span class="free">Θ</span> <span class="bound">a'</span> <span class="free">c'</span> <span class="main">(</span><span class="bound">pm</span><span class="main">,</span> <span class="bound">cm</span><span class="main">)</span> <span class="main">⟶</span> atomicsR <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">a</span> <span class="free">c</span> <span class="main">(</span><span class="bound">pm</span><span class="main">,</span> <span class="bound">cm</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtranclp_induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> Normal_pre_star<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> oghoare_step<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="operator">drule</span> meta_spec<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> meta_impE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> meta_impE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_sound_Parallel_Normal_case<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl refl<span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">cs</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> Parallel <span class="bound">cs</span>  <span class="main">⟶</span> <span class="free">s</span> <span class="main">=</span> Normal <span class="bound">x</span> <span class="main">⟶</span>
      <span class="free">t</span> <span class="main">=</span> Normal <span class="bound">y</span> <span class="main">⟶</span>
      <span class="free">Γ</span><span class="main">,</span><span class="free">Θ</span>⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span> </sub><span class="hidden">⇙</span><span class="bound">P</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟶</span> final <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="bound">x</span> <span class="main">∈</span> pre <span class="bound">P</span> <span class="main">⟶</span> <span class="free">t</span> <span class="main">∉</span> Fault <span class="main">`</span> <span class="free">F</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> Throw <span class="main">∧</span> <span class="free">t</span> <span class="main">∈</span> Normal <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> Skip <span class="main">∧</span> <span class="free">t</span> <span class="main">∈</span> Normal <span class="main">`</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> converse_rtranclp_induct2<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> step.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="comment1">― ‹Parallel›</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> Normal_pre_star<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Parallel<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> i cs c1' x y  s' as<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">⊢</span> <span class="main">(</span>Parallel <span class="improper">cs</span><span class="main">,</span> Normal <span class="improper">x</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span>Parallel <span class="main">(</span><span class="improper">cs</span><span class="main">[</span><span class="improper">i</span> <span class="main">:=</span> <span class="improper">c1'</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> Normal <span class="improper">s'</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Parallel <span class="improper">cs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span>
                      a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"AnnPar <span class="improper">as</span>"</span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span>
                      Q<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋂</span><span class="bound">x</span><span class="main">∈</span>set <span class="improper">as</span><span class="main">.</span> postcond <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A <span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="improper">as</span><span class="main">.</span> abrcond <span class="bound">x</span><span class="main">)</span>"</span></span>
                   <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> oghoare_step<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Θ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">Θ</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> F<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">F</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Parallel<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a'<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Conseq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋂</span><span class="bound">x</span><span class="main">∈</span>set <span class="improper">as</span><span class="main">.</span> postcond <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="improper">as</span><span class="main">.</span> abrcond <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> step.Parallel<span class="main">)</span>
<span class="comment1">― ‹ParSkip›</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> no_steps_final<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Parallel<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> imageI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> subsetD<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> i<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">cs</span><span class="main">!</span><span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">as</span> <span class="main">!</span> <span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Skip<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="comment1">― ‹ParThrow›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> no_steps_final<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Parallel<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Throw<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> i as Q' A' P'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">as</span> <span class="main">!</span> <span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> imageI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span>  A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="improper">as</span><span class="main">.</span> abrcond <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> subsetD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">as</span><span class="main">!</span><span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_step_Fault<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl refl<span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">⊢</span> <span class="free">cf</span> <span class="main">→</span> <span class="free">cf'</span> <span class="main">⟹</span>
   <span class="free">cf</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> Normal <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">cf'</span> <span class="main">=</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> Fault <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">x</span> <span class="main">∈</span> pre <span class="free">P</span> <span class="main">⟹</span>
   <span class="free">Γ</span><span class="main">,</span><span class="free">Θ</span>⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span> </sub><span class="hidden">⇙</span><span class="free">P</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> step.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Guard<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Seq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Catch<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> i cs c' x P Q A f<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Parallel<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> i cs c' x Q A f as<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_spec<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meta_impE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">as</span><span class="main">!</span><span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> meta_impE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> meta_impE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> rtranclp_conjD<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> conjunct1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Await<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> b c c' x Q A f r P' Q' A'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> oghoare_atom_com_sound<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Fault <span class="improper">f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted">Skip</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">f</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">c'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span>  steps_Fault<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def steps_Fault<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_step_Stuck<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl refl<span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">⊢</span> <span class="free">cf</span> <span class="main">→</span> <span class="free">cf'</span> <span class="main">⟹</span>
   <span class="free">cf</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> Normal <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">cf'</span> <span class="main">=</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> Stuck<span class="main">)</span> <span class="main">⟹</span>
   <span class="free">x</span> <span class="main">∈</span> pre <span class="free">P</span> <span class="main">⟹</span>
   <span class="free">Γ</span><span class="main">,</span><span class="free">Θ</span>⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span> </sub><span class="hidden">⇙</span><span class="free">P</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="quoted"><span class="free">A</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> step.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Spec<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Seq<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Call<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Catch<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Parallel<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> i cs c' x Q A as<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_spec<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">as</span><span class="main">!</span><span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span>  meta_impE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> meta_impE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> meta_impE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> rtranclp_conjD<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> conjunct1<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Await<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> b c c' x Q A  r P'' Q' A'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> oghoare_atom_com_sound<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted">Stuck</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted">Skip</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">c'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span>  steps_Stuck<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def steps_Fault<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Await<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_steps_Fault<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl refl<span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">⊢</span> <span class="free">cf</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">cf'</span> <span class="main">⟹</span>
   <span class="free">cf</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> Normal <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">cf'</span> <span class="main">=</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> Fault <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">x</span> <span class="main">∈</span> pre <span class="free">P</span> <span class="main">⟹</span>
   <span class="free">Γ</span><span class="main">,</span><span class="free">Θ</span>⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span> </sub><span class="hidden">⇙</span><span class="free">P</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> b x c c' f<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> oghoare_steps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> oghoare_step_Fault<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_spec<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meta_impE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> step_Fault_prop <span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> step_Stuck_prop <span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_steps_Stuck<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl refl<span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">⊢</span> <span class="free">cf</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">cf'</span> <span class="main">⟹</span>
   <span class="free">cf</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> Normal <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">cf'</span> <span class="main">=</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> Stuck<span class="main">)</span> <span class="main">⟹</span>
   <span class="free">x</span> <span class="main">∈</span> pre <span class="free">P</span> <span class="main">⟹</span>
   <span class="free">Γ</span><span class="main">,</span><span class="free">Θ</span>⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span> </sub><span class="hidden">⇙</span><span class="free">P</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> b x c c'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> oghoare_steps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> oghoare_step_Stuck<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> step_Fault_prop <span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_sound_Parallel_Fault_case<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ refl refl<span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">P</span> <span class="bound">x</span> <span class="bound">f</span> <span class="bound">cs</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> Parallel <span class="bound">cs</span>  <span class="main">⟶</span> <span class="free">s</span> <span class="main">=</span> Normal <span class="bound">x</span> <span class="main">⟶</span>
      <span class="bound">x</span> <span class="main">∈</span> pre <span class="bound">P</span> <span class="main">⟶</span> <span class="free">t</span> <span class="main">=</span> Fault <span class="bound">f</span> <span class="main">⟶</span>
      <span class="free">Γ</span><span class="main">,</span><span class="free">Θ</span>⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span> </sub><span class="hidden">⇙</span><span class="bound">P</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟶</span> final <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> converse_rtranclp_induct2<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> c s P x f cs<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">s</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> step.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Parallel<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x f s' i cs c1' as<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">⊢</span> <span class="main">(</span>Parallel <span class="improper">cs</span><span class="main">,</span> Normal <span class="improper">x</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span>Parallel <span class="main">(</span><span class="improper">cs</span><span class="main">[</span><span class="improper">i</span> <span class="main">:=</span> <span class="improper">c1'</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> Normal <span class="improper">s'</span><span class="main">)</span>"</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Parallel <span class="improper">cs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"AnnPar <span class="improper">as</span>"</span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span>
                      Q<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋂</span><span class="bound">x</span><span class="main">∈</span>set <span class="improper">as</span><span class="main">.</span> postcond <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="improper">as</span><span class="main">.</span> abrcond <span class="bound">x</span><span class="main">)</span>"</span></span> 
                      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> oghoare_step<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Θ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">Θ</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> F<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">F</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Parallel<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a'<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> notE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"oghoare <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋂</span><span class="bound">x</span><span class="main">∈</span>set <span class="improper">as</span><span class="main">.</span> postcond <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="improper">as</span><span class="main">.</span> abrcond <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI <span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> step.Parallel<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> no_steps_final <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_Parallel<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_Normal_elim_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> f cs f' i c1' as<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span>  impE<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">as</span><span class="main">!</span><span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"pres <span class="main">(</span><span class="improper">as</span> <span class="main">!</span> <span class="improper">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span>  oghoare_step_Fault<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Θ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">Θ</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> F<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">F</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> steps_Fault_prop <span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> steps_Stuck_prop <span class="main"><span class="keyword3">;</span></span><span class="operator">simp</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_soundness<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟶</span> <span class="free">Γ</span> ⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span>pre <span class="free">P</span><span class="main">)</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊩<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span><span class="free">P'</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟶</span> <span class="free">Γ</span> ⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P'</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> valid_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> oghoare_oghoare_seq.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> SeqSkip <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> 
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> converse_rtranclpE step_Normal_elim_cases<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> SeqThrow <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> 
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> converse_rtranclpE step_Normal_elim_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> SeqBasic <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> 
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> converse_rtranclpE step_Normal_elim_cases 
            <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SeqSpec <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">r</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> converse_rtranclpE<span class="main">)</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_Normal_elim_cases<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> converse_rtranclpE step_Normal_elim_cases<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SeqSeq <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Q</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> SeqSeq
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> valid_def<span class="main">)</span> 
        <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> oghoare_seq_valid <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_weaken_pre<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SeqCatch <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Q</span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> valid_def<span class="main">)</span>
       <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>  oghoare_catch_valid<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SeqCond <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">b</span> <span class="skolem">c1</span> <span class="skolem">Q</span> <span class="skolem">A</span> <span class="skolem">c2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> valid_def<span class="main">)</span>
        <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>oghoare_if_valid<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SeqWhile <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">c</span> <span class="skolem">A</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> valid_def<span class="main">)</span>
        <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> valid_weaken_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> oghoare_while_valid<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SeqGuard <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">c</span> <span class="skolem">Q</span> <span class="skolem">A</span> <span class="skolem">r</span> <span class="skolem">g</span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> valid_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> converse_rtranclpE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_Normal_elim_cases<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∩</span> <span class="main">-</span> <span class="skolem">g</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∩</span> <span class="main">-</span> <span class="skolem">g</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> no_steps_final <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>final_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> no_steps_final <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>final_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SeqCall <span class="skolem">Γ</span> <span class="skolem">p</span> <span class="skolem">f</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> converse_rtranclpE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_Normal_elim_cases<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SeqDynCom <span class="skolem">r</span> <span class="skolem">P</span> <span class="skolem">fa</span> <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">c</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> converse_rtranclpE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_Normal_elim_cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> t c' x<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">c'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SeqConseq <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">c</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> t c' x<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">c'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_weaken_pre<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SeqParallel <span class="skolem">as</span> <span class="skolem">P</span> <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">cs</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> valid_def<span class="main">)</span>
       <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> valid_weaken_pre<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Call <span class="skolem">Θ</span> <span class="skolem">p</span> <span class="skolem">as</span> <span class="skolem">n</span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">A</span> <span class="skolem">r</span> <span class="skolem">Γ</span> <span class="skolem">f</span> <span class="skolem">F</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> converse_rtranclpE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_Normal_elim_cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Await <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">c</span> <span class="skolem">Q</span> <span class="skolem">A</span> <span class="skolem">r</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> converse_rtranclpE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_Normal_elim_cases<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> converse_rtranclpE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> final_def <span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>no_step_final <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x c''<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Stuck"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Skip"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"rtranclp <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">c''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span>  steps_Stuck<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x c'' f<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Fault <span class="improper">f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Skip"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"rtranclp <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">c''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">f</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span>  steps_Fault<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> converse_rtranclpE<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_elim_cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Parallel <span class="skolem">as</span> <span class="skolem">cs</span> <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">Q</span> <span class="skolem">A</span> <span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> valid_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>pre.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> t c' x'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">t</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_sound_Parallel_Normal_case<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Θ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Θ</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Q</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">A</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> F<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">F</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"AnnPar <span class="skolem"><span class="skolem">as</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> oghoare_oghoare_seq.Parallel<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_sound_Parallel_Fault_case<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Θ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Θ</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Q</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">A</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> F<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">F</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"AnnPar <span class="skolem"><span class="skolem">as</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ <span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> oghoare_oghoare_seq.Parallel<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span>  oghoare_steps_Stuck<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Θ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Θ</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> F<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">F</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Q</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">A</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"AnnPar <span class="skolem"><span class="skolem">as</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span>  oghoare_oghoare_seq.Parallel<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Skip <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> 
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> converse_rtranclpE step_Normal_elim_cases<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> Basic <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> 
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> converse_rtranclpE step_Normal_elim_cases 
            <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Spec <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">r</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> converse_rtranclpE<span class="main">)</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_Normal_elim_cases<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> converse_rtranclpE step_Normal_elim_cases<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Seq <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Q</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> Seq
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> valid_def<span class="main">)</span> 
        <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> oghoare_seq_valid <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_weaken_pre<span class="main">)</span>
   <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cond <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Q</span> <span class="skolem">A</span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">r</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> valid_def<span class="main">)</span>
        <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>oghoare_if_valid<span class="main">)</span>
   <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>While <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">c</span> <span class="skolem">i</span> <span class="skolem">A</span> <span class="skolem">b</span> <span class="skolem">Q</span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> valid_def<span class="main">)</span>
        <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> valid_weaken_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> oghoare_while_valid<span class="main">)</span>
   <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> Throw <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> 
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> converse_rtranclpE step_Normal_elim_cases<span class="main">)</span>
   <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Catch <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Q</span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> valid_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> oghoare_catch_valid<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Guard <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">c</span> <span class="skolem">Q</span> <span class="skolem">A</span> <span class="skolem">r</span> <span class="skolem">g</span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> valid_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> valid_weaken_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> converse_rtranclpE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_Normal_elim_cases<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∩</span> <span class="main">-</span> <span class="skolem">g</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∩</span> <span class="main">-</span> <span class="skolem">g</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> no_steps_final <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>final_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ex_in_conv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DynCom <span class="skolem">r</span> <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">c</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
   
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> converse_rtranclpE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_Normal_elim_cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> t c' x<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ballE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">c'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conseq <span class="skolem">Γ</span> <span class="skolem">Θ</span> <span class="skolem">F</span> <span class="skolem">P</span> <span class="skolem">c</span> <span class="skolem">Q</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> P' Q' A' t c' x<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">c'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_weaken_pre<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>   
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> oghoare_sound <span class="main">=</span> oghoare_soundness<span class="main">[</span><span class="operator">THEN</span> conjunct1<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> oghoare_seq_sound <span class="main">=</span> oghoare_soundness<span class="main">[</span><span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Cache_Tactics">
<div class="head">
<h1>Theory Cache_Tactics</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright 2016, NICTA
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(NICTA_BSD)
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> Cache_Tactics
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">CACHE_TACTICS</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>

<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">cache_id</span> <span class="main">=</span> int

<span class="keyword1"><span class="keyword">val</span></span> new_subgoal_cache<span class="main">:</span> unit <span class="main">-&gt;</span> <span class="entity">cache_id</span>
<span class="keyword1"><span class="keyword">val</span></span> SUBGOAL_CACHE<span class="main">:</span> <span class="entity">cache_id</span> <span class="main">-&gt;</span> <span class="main">(</span>term * int <span class="main">-&gt;</span> tactic<span class="main">)</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
<span class="keyword1"><span class="keyword">val</span></span> clear_subgoal_cache<span class="main">:</span> <span class="entity">cache_id</span> <span class="main">-&gt;</span> unit
<span class="keyword1"><span class="keyword">val</span></span> cacheify_tactic<span class="main">:</span>
  int <span class="main">-&gt;</span> <span class="main">(</span><span class="entity">Proof.context</span> * <span class="main">(</span><span class="entity">cache_id</span> list<span class="main">)</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic<span class="main">)</span> <span class="main">-&gt;</span>
  <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic

<span class="keyword1"><span class="keyword">val</span></span> PARALLEL_GOALS_CACHE<span class="main">:</span> <span class="entity">cache_id</span> <span class="main">-&gt;</span> tactic <span class="main">-&gt;</span> tactic

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

›</span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Cache_Tactics</span><span class="main">:</span> <span class="entity">CACHE_TACTICS</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>
<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">cache_id</span> <span class="main">=</span> int
<span class="comment1">(* Stateful cache of intermediate tactic results.
   
   USE WITH CARE: Each "function" (pair of function and configuration parameters)
   needs a unique cache.

   Some more experiments with which sub-caches
   get the best speedup?
*)</span>             

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">caches</span> <span class="main">=</span> Synchronized.var <span class="inner_quoted">"caches"</span> <span class="main">(</span><span class="main">(</span><span class="inner_numeral">~1</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">:</span> int * <span class="main">(</span><span class="main">(</span>int * <span class="main">(</span>thm option Termtab.table<span class="main">)</span><span class="main">)</span> list<span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">new_subgoal_cache</span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> Synchronized.change_result <span class="entity">caches</span> 
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">maxidx</span><span class="main">,</span><span class="entity">cache_list</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span> 
      <span class="main">(</span><span class="entity">maxidx</span><span class="main">,</span><span class="main">(</span><span class="entity">maxidx</span> + <span class="inner_numeral">1</span><span class="main">,</span><span class="main">(</span><span class="entity">maxidx</span><span class="main">,</span>Termtab.empty<span class="main">)</span> :: <span class="entity">cache_list</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">SUBGOAL_CACHE</span> <span class="entity">id</span> <span class="main">(</span><span class="entity">tac</span> <span class="main">:</span> <span class="main">(</span>term * int<span class="main">)</span> <span class="main">-&gt;</span> tactic<span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> 
CSUBGOAL <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">prem</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span> <span class="main">=&gt;</span>
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st</span> <span class="main">=&gt;</span>
   <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tab</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span>AList.lookup <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="main">(</span>Synchronized.value <span class="entity">caches</span> |&gt; snd<span class="main">)</span> <span class="entity">id</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">x</span> <span class="main">|</span> NONE <span class="main">=&gt;</span> error <span class="inner_quoted">"Missing cache"</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pprem</span> <span class="main">=</span> Thm.term_of <span class="entity">prem</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">othm</span> <span class="main">=</span> 
        <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span>Termtab.lookup <span class="entity">tab</span> <span class="entity">pprem</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="main">(</span><span class="entity">othm</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">othm</span>
            <span class="main">|</span> NONE <span class="main">=&gt;</span> 
               <span class="keyword2"><span class="keyword">let</span></span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">othm</span> <span class="main">=</span> Option.map fst <span class="main">(</span>Seq.pull <span class="main">(</span><span class="entity">tac</span> <span class="main">(</span><span class="entity">pprem</span><span class="main">,</span><span class="inner_numeral">1</span><span class="main">)</span> <span class="main">(</span>Goal.init <span class="entity">prem</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> Synchronized.change <span class="entity">caches</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">maxidx</span><span class="main">,</span><span class="entity">nets</span><span class="main">)</span> <span class="main">=&gt;</span>
                        <span class="main">(</span><span class="entity">maxidx</span><span class="main">,</span>AList.map_entry <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">id</span>
                            <span class="main">(</span>Termtab.update <span class="main">(</span><span class="entity">pprem</span><span class="main">,</span><span class="entity">othm</span><span class="main">)</span><span class="main">)</span> <span class="entity">nets</span><span class="main">)</span><span class="main">)</span>
               <span class="keyword2"><span class="keyword">in</span></span>
                <span class="entity">othm</span>
               <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
      
   <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">othm</span> <span class="keyword2"><span class="keyword">of</span></span>
      SOME <span class="entity">thm</span> <span class="main">=&gt;</span> Thm.bicompose NONE <span class="main">{</span>flatten <span class="main">=</span> false<span class="main">,</span> match <span class="main">=</span> false<span class="main">,</span> incremented <span class="main">=</span> false<span class="main">}</span>
        <span class="main">(</span>false<span class="main">,</span> Goal.conclude <span class="entity">thm</span><span class="main">,</span> Thm.nprems_of <span class="entity">thm</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span>
     <span class="main">|</span> NONE <span class="main">=&gt;</span> Seq.empty
   <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>

      
  <span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">clear_subgoal_cache</span> <span class="entity">id</span> <span class="main">=</span> Synchronized.change <span class="entity">caches</span>
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">maxidx</span><span class="main">,</span><span class="entity">cache_list</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">maxidx</span><span class="main">,</span>AList.delete <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">id</span> <span class="entity">cache_list</span><span class="main">)</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">local</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pcaches</span> <span class="main">=</span> Synchronized.var <span class="inner_quoted">"pcaches"</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span> <span class="main">:</span> <span class="main">(</span><span class="main">(</span>int * <span class="main">(</span>term Termtab.table<span class="main">)</span><span class="main">)</span> list<span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">cache_oracle</span><span class="main">)</span> <span class="main">=</span> Context.&gt;&gt;&gt; <span class="main">(</span>Context.map_theory_result <span class="main">(</span>Thm.add_oracle <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> "cache"<span class="antiquote">}</span></span></span><span class="main">,</span>I<span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">exception</span></span> <span class="entity">FAILED</span> <span class="keyword2"><span class="keyword">of</span></span> unit<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">retrofit</span> <span class="entity">st'</span> <span class="main">=</span>
  rotate_prems <span class="inner_numeral">~1</span> #&gt;
  Thm.bicompose NONE <span class="main">{</span>flatten <span class="main">=</span> false<span class="main">,</span> match <span class="main">=</span> false<span class="main">,</span> incremented <span class="main">=</span> false<span class="main">}</span>
      <span class="main">(</span>false<span class="main">,</span> Goal.conclude <span class="entity">st'</span><span class="main">,</span> Thm.nprems_of <span class="entity">st'</span><span class="main">)</span> <span class="inner_numeral">1</span><span class="main">;</span>

<span class="keyword2"><span class="keyword">in</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">PARALLEL_GOALS_CACHE</span> <span class="entity">cache_id</span> <span class="entity">tac</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">cache_id</span> &lt; <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> 
  <span class="main">(</span>Synchronized.change <span class="entity">pcaches</span> <span class="main">(</span>AList.map_default <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="main">(</span>~<span class="entity">cache_id</span><span class="main">,</span>Termtab.empty<span class="main">)</span> <span class="main">(</span>K Termtab.empty<span class="main">)</span><span class="main">)</span><span class="main">;</span><span class="entity">PARALLEL_GOALS</span> <span class="entity">tac</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span>
  Thm.adjust_maxidx_thm <span class="inner_numeral">~1</span> #&gt;
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st</span> <span class="main">=&gt;</span>
    <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span>Future.enabled <span class="main">(</span><span class="main">)</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span> Thm.maxidx_of <span class="entity">st</span> &gt;= <span class="inner_numeral">0</span> <span class="keyword1"><span class="keyword">orelse</span></span> Thm.nprems_of <span class="entity">st</span> &lt;= <span class="inner_numeral">1</span>
    <span class="keyword2"><span class="keyword">then</span></span> DETERM <span class="entity">tac</span> <span class="entity">st</span>
    <span class="keyword2"><span class="keyword">else</span></span>
      <span class="keyword2"><span class="keyword">let</span></span>
         <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tab</span> <span class="main">=</span> Synchronized.change_result <span class="entity">pcaches</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">caches</span> <span class="main">=&gt;</span>
              <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span>AList.lookup <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">caches</span> <span class="entity">cache_id</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="entity">net</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">net</span><span class="main">,</span><span class="entity">caches</span><span class="main">)</span>
                <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="main">(</span>Termtab.empty<span class="main">,</span><span class="main">(</span>AList.update <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="main">(</span><span class="entity">cache_id</span><span class="main">,</span>Termtab.empty<span class="main">)</span> <span class="entity">caches</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">do_cache</span> <span class="entity">p</span> <span class="entity">result</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cresult</span> <span class="main">=</span> Thm.global_cterm_of <span class="main">(</span>Thm.theory_of_cterm <span class="entity">p</span><span class="main">)</span> <span class="entity">result</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          try <span class="entity">cache_oracle</span> <span class="entity">cresult</span>
        <span class="keyword2"><span class="keyword">end</span></span>

        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">try_cache</span> <span class="main">(</span><span class="entity">i</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="main">(</span><span class="entity">cached</span><span class="main">,</span><span class="entity">uncached</span><span class="main">)</span>  <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span>Termtab.lookup <span class="entity">tab</span> <span class="main">(</span>Thm.term_of <span class="entity">p</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="entity">result</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">do_cache</span> <span class="entity">p</span> <span class="entity">result</span> <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">(</span><span class="entity">i</span><span class="main">,</span><span class="entity">thm</span><span class="main">)</span> :: <span class="entity">cached</span><span class="main">,</span><span class="entity">uncached</span><span class="main">)</span>
                                                    <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">cached</span><span class="main">,</span> <span class="main">(</span><span class="entity">i</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> :: <span class="entity">uncached</span><span class="main">)</span><span class="main">)</span>
        <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">cached</span><span class="main">,</span><span class="main">(</span><span class="entity">i</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> :: <span class="entity">uncached</span><span class="main">)</span>

        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">try_tac</span> <span class="main">(</span><span class="entity">i</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="main">=</span> 
          <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> SINGLE <span class="entity">tac</span> <span class="main">(</span>Goal.init <span class="entity">p</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
            NONE <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> <span class="entity">FAILED</span> <span class="main">(</span><span class="main">)</span>
          <span class="main">|</span> SOME <span class="entity">g'</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">i</span><span class="main">,</span><span class="entity">g'</span><span class="main">)</span><span class="main">)</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">goals</span> <span class="main">=</span> Drule.strip_imp_prems <span class="main">(</span>Thm.cprop_of <span class="entity">st</span><span class="main">)</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">cached</span><span class="main">,</span><span class="entity">uncached</span><span class="main">)</span> <span class="main">=</span> fold <span class="entity">try_cache</span> <span class="main">(</span><span class="entity">goals</span> |&gt; tag_list <span class="inner_numeral">0</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">results</span> <span class="main">=</span> Par_List.map <span class="main">(</span>`<span class="entity">try_tac</span><span class="main">)</span> <span class="entity">uncached</span><span class="main">;</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> Synchronized.change <span class="entity">pcaches</span> <span class="main">(</span>
          AList.map_default <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="main">(</span><span class="entity">cache_id</span><span class="main">,</span>Termtab.empty<span class="main">)</span>
            <span class="main">(</span>fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">result</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">goal</span><span class="main">)</span><span class="main">)</span>  <span class="main">=&gt;</span>
               Termtab.update <span class="main">(</span>Thm.term_of <span class="entity">goal</span><span class="main">,</span>Thm.prop_of <span class="entity">result</span><span class="main">)</span>
             <span class="main">)</span> <span class="entity">results</span><span class="main">)</span><span class="main">)</span>
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> null <span class="entity">cached</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="main">)</span> 
          <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span>warning 
          <span class="main">(</span><span class="inner_quoted">"WARNING: Used cached result for PARALLEL_GOALS_CACHE.\n"</span> ^
          <span class="inner_quoted">"Give ~x to clear cache x and ensure correctness."</span><span class="main">)</span><span class="main">)</span>
         
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">full_results</span> <span class="main">=</span> <span class="main">(</span>map fst <span class="entity">results</span><span class="main">)</span> @ <span class="entity">cached</span> |&gt; order_list<span class="main">;</span>

      <span class="keyword2"><span class="keyword">in</span></span> EVERY <span class="main">(</span>map <span class="entity">retrofit</span> <span class="main">(</span>rev <span class="entity">full_results</span><span class="main">)</span><span class="main">)</span> <span class="entity">st</span> <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword3"><span class="keyword">handle</span></span> <span class="entity">FAILED</span> <span class="main">(</span><span class="main">)</span> <span class="main">=&gt;</span> Seq.empty<span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cacheify_tactic</span> <span class="entity">n</span> <span class="entity">tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">caches</span> <span class="main">=</span> List.tabulate <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">new_subgoal_cache</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">clear_caches</span> <span class="main">_</span> <span class="main">=</span> app <span class="entity">clear_subgoal_cache</span> <span class="entity">caches</span> <span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">st</span> |&gt;
      <span class="main">(</span><span class="entity">tac</span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="entity">caches</span><span class="main">)</span> <span class="entity">i</span>
      THEN <span class="main">(</span>PRIMITIVE Drule.implies_intr_hyps<span class="main">)</span>
      THEN <span class="main">(</span>PRIMITIVE <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">clear_caches</span> <span class="main">(</span><span class="main">)</span><span class="main">;</span><span class="entity">thm</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      
  <span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="OG_Tactics">
<div class="head">
<h1>Theory OG_Tactics</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright 2016, Data61, CSIRO
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(DATA61_BSD)
 *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Verfication Condition Generator for COMPLX OG›</span></span>
<span class="keyword1"><span class="command">theory</span></span> OG_Tactics
<span class="keyword2"><span class="keyword">imports</span></span>
 <a href="OG_Soundness.html">OG_Soundness</a>
 <span class="quoted">"<a href="Cache_Tactics.html">lib/Cache_Tactics</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Seq oghoare derivation›</span></span>


<span class="keyword1"><span class="command">lemmas</span></span> SeqSkipRule <span class="main">=</span> SeqSkip
<span class="keyword1"><span class="command">lemmas</span></span> SeqThrowRule <span class="main">=</span> SeqThrow
<span class="keyword1"><span class="command">lemmas</span></span> SeqBasicRule <span class="main">=</span> SeqBasic
<span class="keyword1"><span class="command">lemmas</span></span> SeqSpecRule <span class="main">=</span> SeqSpec
<span class="keyword1"><span class="command">lemmas</span></span> SeqSeqRule <span class="main">=</span> SeqSeq

<span class="keyword1"><span class="command">lemma</span></span> SeqCondRule<span class="main">:</span> 
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>  <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊩<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">C1</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span><span class="main">;</span>
    <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊩<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">C2</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊩<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">∈</span><span class="free">b</span> <span class="main">⟶</span> <span class="bound">s</span><span class="main">∈</span><span class="free">C1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s</span><span class="main">∉</span><span class="free">b</span> <span class="main">⟶</span> <span class="bound">s</span><span class="main">∈</span><span class="free">C2</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span>AnnBin <span class="free">r</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
                   <span class="main">(</span>Cond <span class="free">b</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SeqCond<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> SeqConseq<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> SeqConseq<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> SeqWhileRule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊩<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">i</span> <span class="main">∩</span> <span class="free">b</span><span class="main">)</span> <span class="free">a</span> <span class="free">c</span> <span class="free">i</span><span class="main">,</span><span class="free">A</span><span class="main">;</span> <span class="free">i</span> <span class="main">∩</span> <span class="main">-</span> <span class="free">b</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊩<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">i</span> <span class="main">(</span>AnnWhile <span class="free">r</span> <span class="free">i</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>While <span class="free">b</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SeqConseq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ SeqWhile<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> DynComRule<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">r</span> <span class="main">⊆</span> pre <span class="free">a</span><span class="main">;</span>  <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">∈</span><span class="free">r</span> <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">a</span> <span class="main">(</span><span class="free">c</span> <span class="bound">s</span><span class="main">)</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> 
      <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnRec <span class="free">r</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>DynCom <span class="free">c</span><span class="main">)</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> DynCom<span class="main">)</span> <span class="operator">clarsimp</span>

<span class="keyword1"><span class="command">lemma</span></span> SeqDynComRule<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">r</span> <span class="main">⊆</span> pre <span class="free">a</span><span class="main">;</span>
   <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">∈</span><span class="free">r</span> <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊩<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span><span class="free">P</span> <span class="free">a</span> <span class="main">(</span><span class="free">c</span> <span class="bound">s</span><span class="main">)</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span><span class="main">;</span>
      <span class="free">P</span><span class="main">⊆</span><span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span> 
  <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊩<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="main">(</span>AnnRec <span class="free">r</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>DynCom <span class="free">c</span><span class="main">)</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> SeqDynCom<span class="main">)</span> <span class="operator">clarsimp</span>

<span class="keyword1"><span class="command">lemma</span></span> SeqCallRule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P'</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊩<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">P''</span> <span class="free">f</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span><span class="main">;</span> 
     <span class="free">n</span> <span class="main">&lt;</span> length <span class="free">as</span><span class="main">;</span> <span class="free">Γ</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">f</span><span class="main">;</span>
     <span class="free">as</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> <span class="free">P''</span><span class="main">;</span> <span class="free">Θ</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">as</span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊩<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P'</span> <span class="main">(</span>AnnCall <span class="free">r</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>Call <span class="free">p</span><span class="main">)</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SeqCall SeqConseq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SeqGuardRule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">∩</span> <span class="free">g</span> <span class="main">⊆</span> <span class="free">P'</span><span class="main">;</span> <span class="free">P</span> <span class="main">∩</span> <span class="main">-</span><span class="free">g</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">;</span>
     <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊩<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P'</span> <span class="free">a</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span>
   <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊩<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="main">(</span>AnnRec <span class="free">r</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>Guard <span class="free">f</span> <span class="free">g</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SeqGuard SeqConseq<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Parallel-mode rules›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> GuardRule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">r</span> <span class="main">∩</span> <span class="free">g</span> <span class="main">⊆</span> pre <span class="free">P</span><span class="main">;</span> <span class="free">r</span> <span class="main">∩</span> <span class="main">-</span><span class="free">g</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="free">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">;</span>
     <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span>
   <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnRec <span class="free">r</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span>Guard <span class="free">f</span> <span class="free">g</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Guard<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> CallRule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">r</span> <span class="main">⊆</span> pre <span class="free">P</span><span class="main">;</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">f</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span><span class="main">;</span>
     <span class="free">n</span> <span class="main">&lt;</span> length <span class="free">as</span><span class="main">;</span> <span class="free">Γ</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">f</span><span class="main">;</span>
     <span class="free">as</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> <span class="free">P</span><span class="main">;</span> <span class="free">Θ</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">as</span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnCall <span class="free">r</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>Call <span class="free">p</span><span class="main">)</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Call<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map_ann_hoare</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> body <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> proc_assns <span class="main">⇒</span> <span class="tfree">'f</span> set
              <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann_triple list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com list <span class="main">⇒</span> bool"</span></span>
    <span class="main">(</span><span class="quoted">"<span class="keyword3">(4</span>_<span class="keyword1">,</span>_<span class="keyword3">/</span><span class="keyword1">[⊩]⇘'/</span>_ <span class="keyword1">⇙</span><span class="keyword3">(</span>_<span class="keyword3">/ </span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span><span class="keyword3">)</span>"</span> <span class="main">[</span>60<span class="main">,</span>60<span class="main">,</span>60<span class="main">,</span>1000<span class="main">,</span>20<span class="main">]</span>60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> [⊩]<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">Ps</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> ⊢<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span>pres <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span>postcond <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>abrcond <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> MapAnnEmpty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> [⊩]<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>map_ann_hoare_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> MapAnnList<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span><span class="main">;</span>
                     <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span>  [⊩]<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">Ps</span> <span class="free">Ts</span> <span class="main">⟧</span> 
                <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> [⊩]<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">#</span><span class="free">Ps</span><span class="main">)</span> <span class="main">(</span><span class="free">c</span><span class="main">#</span><span class="free">Ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>map_ann_hoare_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> i<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> MapAnnMap<span class="main">:</span> 
   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span><span class="main">≤</span><span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span><span class="main">&lt;</span><span class="free">j</span> <span class="main">⟶</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">P</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="free">c</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="free">Q</span> <span class="bound">k</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">A</span> <span class="bound">k</span><span class="main">)</span> 
<span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> [⊩]<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="bound">k</span><span class="main">,</span> <span class="free">Q</span> <span class="bound">k</span><span class="main">,</span> <span class="free">A</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>map <span class="free">c</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute le_add1 map_ann_hoare_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ParallelRule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> [⊩]<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">Ps</span> <span class="free">Cs</span><span class="main">;</span>
    interfree <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="free">Ps</span> <span class="free">Cs</span><span class="main">;</span>
    length <span class="free">Cs</span> <span class="main">=</span> length <span class="free">Ps</span>
 <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnPar <span class="free">Ps</span><span class="main">)</span> 
                    <span class="main">(</span>Parallel <span class="free">Cs</span><span class="main">)</span> 
                    <span class="main">(</span><span class="main">⋂</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">Ps</span><span class="main">}</span><span class="main">.</span> postcond <span class="main">(</span><span class="free">Ps</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">Ps</span><span class="main">}</span><span class="main">.</span> abrcond <span class="main">(</span><span class="free">Ps</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>neq_Nil_conv Parallel map_ann_hoare_def <span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Parallel<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> i<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> ParallelConseqRule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnPar <span class="free">Ps</span><span class="main">)</span> 
                    <span class="main">(</span>Parallel <span class="free">Ts</span><span class="main">)</span> 
                    <span class="main">(</span><span class="main">⋂</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">Ps</span><span class="main">}</span><span class="main">.</span> postcond <span class="main">(</span><span class="free">Ps</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">Ps</span><span class="main">}</span><span class="main">.</span> abrcond <span class="main">(</span><span class="free">Ps</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     <span class="main">(</span><span class="main">⋂</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">Ps</span><span class="main">}</span><span class="main">.</span> postcond <span class="main">(</span><span class="free">Ps</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">;</span>
     <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">Ps</span><span class="main">}</span><span class="main">.</span> abrcond <span class="main">(</span><span class="free">Ps</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>
 <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnPar <span class="free">Ps</span><span class="main">)</span> <span class="main">(</span>Parallel <span class="free">Ts</span><span class="main">)</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conseq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">⋂</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">∈</span></span><span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">&lt;</span></span>length <span class="free"><span class="free">Ps</span></span><span class="main"><span class="main">}</span></span><span class="main"><span class="main">.</span></span> precond <span class="main"><span class="main">(</span></span><span class="free"><span class="free">Ps</span></span><span class="main"><span class="main">!</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">⋂</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">∈</span></span><span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">&lt;</span></span>length <span class="free"><span class="free">Ps</span></span><span class="main"><span class="main">}</span></span><span class="main"><span class="main">.</span></span> postcond <span class="main"><span class="main">(</span></span><span class="free"><span class="free">Ps</span></span><span class="main"><span class="main">!</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">⋃</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">∈</span></span><span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">&lt;</span></span>length <span class="free"><span class="free">Ps</span></span><span class="main"><span class="main">}</span></span><span class="main"><span class="main">.</span></span> abrcond <span class="main"><span class="main">(</span></span><span class="free"><span class="free">Ps</span></span><span class="main"><span class="main">!</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹See Soundness.thy for the rest of Parallel-mode rules›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹VCG tactic helper definitions and lemmas›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">interfree_aux_right</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> body <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> proc_assns <span class="main">⇒</span> <span class="tfree">'f</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> assn <span class="main">×</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com <span class="main">×</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">interfree_aux_right</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">cmd</span><span class="main">,</span> <span class="bound">ann</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">aa</span> <span class="bound">ac</span><span class="main">.</span>  atomicsR <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="bound">ann</span> <span class="bound">cmd</span> <span class="main">(</span><span class="bound">aa</span><span class="main">,</span><span class="bound">ac</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> ⊨<span class="hidden">⇘</span><sub>/<span class="free"><span class="bound"><span class="entity">F</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="bound">q</span> <span class="main">∩</span> <span class="bound">aa</span><span class="main">)</span> <span class="bound">ac</span> <span class="bound">q</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pre_strengthen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>pre_par <span class="free">a</span> <span class="main">⟹</span> pre <span class="main">(</span>strengthen_pre <span class="free">a</span> <span class="free">a'</span><span class="main">)</span> <span class="main">=</span> pre <span class="free">a</span> <span class="main">∩</span> <span class="free">a'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Basic_inter_right<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnExpr <span class="main">(</span><span class="free">q</span> <span class="main">∩</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Basic <span class="free">f</span><span class="main">)</span> <span class="free">q</span><span class="main">,</span> <span class="free">q</span> <span class="main">⟹</span> interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> Basic <span class="free">f</span><span class="main">,</span> AnnExpr <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_right_def
           <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> atomicsR.cases
           <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> oghoare_sound<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Skip_inter_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnExpr <span class="main">(</span><span class="free">q</span> <span class="main">∩</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> Skip <span class="free">q</span><span class="main">,</span> <span class="free">q</span> <span class="main">⟹</span> interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> Skip<span class="main">,</span> AnnExpr <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_right_def
           <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> atomicsR.cases
           <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> oghoare_sound<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Throw_inter_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnExpr <span class="main">(</span><span class="free">q</span> <span class="main">∩</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> Throw <span class="free">q</span><span class="main">,</span> <span class="free">q</span> <span class="main">⟹</span> interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> Throw<span class="main">,</span> AnnExpr <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_right_def
           <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> atomicsR.cases
           <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> oghoare_sound<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Spec_inter_right<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span>AnnExpr <span class="main">(</span><span class="free">q</span> <span class="main">∩</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Spec <span class="free">rel</span><span class="main">)</span> <span class="free">q</span><span class="main">,</span> <span class="free">q</span> <span class="main">⟹</span> interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> Spec <span class="free">rel</span><span class="main">,</span> AnnExpr <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_right_def  
           <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> atomicsR.cases
           <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> oghoare_sound<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_Await<span class="main">:</span>
 <span class="quoted"><span class="quoted">"atom_com <span class="free">c</span> <span class="main">⟹</span> <span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">P</span> <span class="main">∩</span> <span class="free">b</span><span class="main">)</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span> <span class="main">⟹</span> <span class="free">Γ</span>⊨<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> Await <span class="free">b</span> <span class="free">c</span> <span class="free">Q</span><span class="main">,</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> converse_rtranclpE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step_Normal_elim_cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> no_steps_final <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> no_steps_final <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> no_steps_final<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x c''<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">Stuck</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">Skip</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">c''</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> steps_Stuck<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> no_steps_final<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> final_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Normal <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Fault <span class="improper">f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">Skip</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> c'' f<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">c''</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">f</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> steps_Fault<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> atomcom_imp_not_prepare<span class="main">:</span>
 <span class="quoted"><span class="quoted">"ann_matches <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">a</span> <span class="free">c</span> <span class="main">⟹</span> atom_com <span class="free">c</span> <span class="main">⟹</span> 
   <span class="main">¬</span> pre_par <span class="free">a</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>ann_matches.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Await_inter_right<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"atom_com <span class="free">c</span> <span class="main">⟹</span>
  <span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊩<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="free">a</span> <span class="free">c</span> <span class="free">q</span><span class="main">,</span><span class="free">q</span> <span class="main">⟹</span>
  <span class="free">q</span> <span class="main">∩</span> <span class="free">r</span> <span class="main">∩</span> <span class="free">b</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">⟹</span>
  interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> Await <span class="free">b</span> <span class="free">c</span><span class="main">,</span> AnnRec <span class="free">r</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interfree_aux_right_def  <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> atomicsR.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> valid_Await<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> oghoare_seq_sound<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> valid_weaken_pre<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Call_inter_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">f</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span><span class="main">;</span>
     <span class="free">n</span> <span class="main">&lt;</span> length <span class="free">as</span><span class="main">;</span> <span class="free">Γ</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">f</span><span class="main">;</span>
     <span class="free">as</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> <span class="free">P</span><span class="main">;</span> <span class="free">Θ</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">as</span><span class="main">⟧</span> <span class="main">⟹</span>
  interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> Call <span class="free">p</span><span class="main">,</span> AnnCall <span class="free">r</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_right_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> atomicsR.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> DynCom_inter_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">⟹</span> interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">f</span> <span class="bound">s</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
  interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> DynCom <span class="free">f</span><span class="main">,</span> AnnRec <span class="free">r</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_right_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> atomicsR.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Guard_inter_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>
     <span class="main">⟹</span> interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> Guard <span class="free">f</span> <span class="free">g</span> <span class="free">c</span><span class="main">,</span> AnnRec <span class="free">r</span> <span class="free">a</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_right_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> atomicsR.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Parallel_inter_right_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> Parallel <span class="main">[]</span><span class="main">,</span> AnnPar <span class="main">[]</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_right_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> atomicsR.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Parallel_inter_right_List<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">;</span>
    interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> Parallel <span class="free">cs</span><span class="main">,</span> AnnPar <span class="free">as</span><span class="main">)</span><span class="main">⟧</span>
     <span class="main">⟹</span> interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> Parallel <span class="main">(</span><span class="free">c</span><span class="main">#</span><span class="free">cs</span><span class="main">)</span><span class="main">,</span> AnnPar <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">#</span><span class="free">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_right_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> atomicsR.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> i aa b<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> AtParallelExprs<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Parallel_inter_right_Map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span><span class="main">≤</span><span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span><span class="main">&lt;</span><span class="free">j</span> <span class="main">⟶</span> interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">c</span> <span class="bound">k</span><span class="main">,</span> <span class="free">a</span> <span class="bound">k</span><span class="main">)</span>
     <span class="main">⟹</span> interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span>
                <span class="main">(</span><span class="free">q</span><span class="main">,</span> Parallel <span class="main">(</span>map <span class="free">c</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> AnnPar <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span> <span class="bound">i</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_right_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> atomicsR.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> ia aa b<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">+</span><span class="improper">ia</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> Seq_inter_right<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">a1</span><span class="main">)</span><span class="main">;</span> interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">⟧</span><span class="main">⟹</span> 
  interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> Seq <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> AnnComp <span class="free">a1</span> <span class="free">a2</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interfree_aux_right_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> atomicsR.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Catch_inter_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">a1</span><span class="main">)</span><span class="main">;</span> interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">⟧</span><span class="main">⟹</span>
  interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> Catch <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> AnnComp <span class="free">a1</span> <span class="free">a2</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interfree_aux_right_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> atomicsR.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> While_inter_aux_any<span class="main">:</span> <span class="quoted"><span class="quoted">"interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">Any</span><span class="main">,</span> <span class="main">(</span><span class="free">AnyAnn</span><span class="main">,</span> <span class="free">q</span><span class="main">,</span> <span class="free">abr</span><span class="main">)</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
  interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">Any</span><span class="main">,</span> <span class="main">(</span><span class="free">AnyAnn</span><span class="main">,</span> <span class="free">q</span><span class="main">,</span> <span class="free">abr</span><span class="main">)</span><span class="main">,</span> While <span class="free">b</span> <span class="free">c</span><span class="main">,</span> AnnWhile <span class="free">R</span> <span class="free">I</span> <span class="free">P</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  interfree_aux_def
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> atomicsR.cases<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?a1.0</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"AnnWhile <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> While_inter_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>
     <span class="main">⟹</span> interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> While <span class="free">b</span> <span class="free">c</span><span class="main">,</span> AnnWhile <span class="free">r</span> <span class="free">i</span> <span class="free">a</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_right_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> atomicsR.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Cond_inter_aux_any<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">Any</span><span class="main">,</span> <span class="main">(</span><span class="free">AnyAnn</span><span class="main">,</span> <span class="free">q</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">a1</span><span class="main">)</span><span class="main">;</span> interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">Any</span><span class="main">,</span> <span class="main">(</span><span class="free">AnyAnn</span><span class="main">,</span> <span class="free">q</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">⟧</span><span class="main">⟹</span> 
   interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">Any</span><span class="main">,</span> <span class="main">(</span><span class="free">AnyAnn</span><span class="main">,</span> <span class="free">q</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">,</span> Cond <span class="free">b</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> AnnBin <span class="free">r</span> <span class="free">a1</span> <span class="free">a2</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  interfree_aux_def 
               <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> atomicsR.cases<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?a1.0</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"AnnBin <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Cond_inter_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">a1</span><span class="main">)</span><span class="main">;</span> interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">⟧</span><span class="main">⟹</span> 
   interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> Cond <span class="free">b</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> AnnBin <span class="free">r</span> <span class="free">a1</span> <span class="free">a2</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_right_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> atomicsR.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Basic_inter_aux<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span> 
    interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span>
    interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> 
    interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span>Basic <span class="free">f</span><span class="main">,</span> <span class="main">(</span>AnnExpr <span class="free">r</span><span class="main">,</span> <span class="free">q</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> assertionsR.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_def interfree_aux_right_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Skip_inter_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span>
    interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span>
    interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
    interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span>Skip<span class="main">,</span> <span class="main">(</span>AnnExpr <span class="free">r</span><span class="main">,</span> <span class="free">q</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> assertionsR.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_def interfree_aux_right_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Throw_inter_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span>
    interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span>
    interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
    interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span>Throw<span class="main">,</span> <span class="main">(</span>AnnExpr <span class="free">r</span><span class="main">,</span> <span class="free">q</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> assertionsR.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_def interfree_aux_right_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Spec_inter_aux<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span> 
    interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span>
    interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> 
    interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span>Spec <span class="free">rel</span><span class="main">,</span> <span class="main">(</span>AnnExpr <span class="free">r</span><span class="main">,</span> <span class="free">q</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> assertionsR.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_def interfree_aux_right_def<span class="main">)</span>

<span class="comment1">(*lemma Seq_inter_aux_any: 
  "⟦ interfree_aux Γ Θ F (Any, (AnyAnn, q, a), c<span class="hidden">⇩</span><sub>1</sub>, a1);
    interfree_aux Γ Θ F (Any, (AnyAnn, q, a), c<span class="hidden">⇩</span><sub>2</sub>, a2) ⟧⟹ 
  interfree_aux Γ Θ F (Any, (AnyAnn, q, a), Seq c<span class="hidden">⇩</span><sub>1</sub> c<span class="hidden">⇩</span><sub>2</sub>, AnnComp a1 a2)"
 by (fastforce simp add:  interfree_aux_def interfree_aux_right_def
               elim: atomicsR.cases[where ?a1.0="AnnComp _ _"])*)</span>

<span class="keyword1"><span class="command">lemma</span></span> Seq_inter_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="main">(</span><span class="free">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> pre <span class="free">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span>
     interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="main">(</span><span class="free">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span> <span class="main">⟧</span>
   <span class="main">⟹</span> interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span>Seq <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="main">(</span>AnnComp <span class="free">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> assertionsR.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_def interfree_aux_right_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Catch_inter_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="main">(</span><span class="free">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> pre <span class="free">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span>
     interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="main">(</span><span class="free">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span> <span class="main">⟧</span>
   <span class="main">⟹</span> interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span>Catch <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="main">(</span>AnnComp <span class="free">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> assertionsR.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_def interfree_aux_right_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Cond_inter_aux<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span>
    interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="main">(</span><span class="free">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span> 
    interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="main">(</span><span class="free">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span> <span class="main">⟧</span>
 <span class="main">⟹</span>  interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span>Cond <span class="free">b</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="main">(</span>AnnBin <span class="free">r</span> <span class="free">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> assertionsR.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_def interfree_aux_right_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> While_inter_aux<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span> 
     interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">Q</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span>
     interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="main">(</span><span class="free">P</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
     interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span>While <span class="free">b</span> <span class="free">c</span><span class="main">,</span> <span class="main">(</span>AnnWhile <span class="free">r</span> <span class="free">i</span> <span class="free">P</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> assertionsR.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_def interfree_aux_right_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Await_inter_aux<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span> 
     interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">Q</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span> 
     interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span>Await <span class="free">b</span> <span class="free">e</span><span class="main">,</span> <span class="main">(</span>AnnRec <span class="free">r</span> <span class="free">ae</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_def interfree_aux_right_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> assertionsR.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Call_inter_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span>
     interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="main">(</span><span class="free">P</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span>
     <span class="free">n</span> <span class="main">&lt;</span> length <span class="free">as</span><span class="main">;</span> <span class="free">Γ</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">f</span><span class="main">;</span>
     <span class="free">as</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> <span class="free">P</span><span class="main">;</span> <span class="free">Θ</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">as</span> <span class="main">⟧</span> <span class="main">⟹</span>
     interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span>Call <span class="free">p</span><span class="main">,</span> <span class="main">(</span>AnnCall <span class="free">r</span> <span class="free">n</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> assertionsR.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_def interfree_aux_right_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> DynCom_inter_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span>
     interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">Q</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span> 
     interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">∈</span><span class="free">r</span> <span class="main">⟹</span> interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">,</span> <span class="main">(</span><span class="free">P</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
     interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span>DynCom <span class="free">f</span><span class="main">,</span> <span class="main">(</span>AnnRec <span class="free">r</span> <span class="free">P</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> assertionsR.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_def interfree_aux_right_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Guard_inter_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span>
     interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">Q</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span>
     interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="main">(</span><span class="free">P</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
     interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span>Guard <span class="free">f</span> <span class="free">g</span> <span class="free">c</span><span class="main">,</span> <span class="main">(</span>AnnRec <span class="free">r</span> <span class="free">P</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> assertionsR.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_def interfree_aux_right_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">inter_aux_Par</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> body <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> proc_assns <span class="main">⇒</span> <span class="tfree">'f</span> set <span class="main">⇒</span>
                    <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> com list <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann_triple<span class="main">)</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> com <span class="main">×</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inter_aux_Par</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">≡</span>
     <span class="main">λ</span><span class="main">(</span><span class="bound">cs</span><span class="main">,</span> <span class="bound">as</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="bound">cs</span><span class="main">.</span> interfree_aux <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span><span class="bound">cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">as</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inter_aux_Par_Empty<span class="main">:</span> <span class="quoted"><span class="quoted">"inter_aux_Par <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>inter_aux_Par_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inter_aux_Par_List<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">y</span><span class="main">,</span> <span class="free">a'</span><span class="main">)</span><span class="main">;</span>
  inter_aux_Par <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">as</span><span class="main">,</span> <span class="free">y</span><span class="main">,</span> <span class="free">a'</span><span class="main">)</span><span class="main">⟧</span> 
  <span class="main">⟹</span> inter_aux_Par <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">,</span> <span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">,</span> <span class="free">y</span><span class="main">,</span> <span class="free">a'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inter_aux_Par_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> v<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">v</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> inter_aux_Par_Map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span><span class="main">≤</span><span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span><span class="main">&lt;</span><span class="free">j</span> <span class="main">⟶</span> interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">c</span> <span class="bound">k</span><span class="main">,</span> <span class="free">Q</span> <span class="bound">k</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>
 <span class="main">⟹</span> inter_aux_Par <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span>map <span class="free">c</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span><span class="main">,</span> map <span class="free">Q</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inter_aux_Par_def less_diff_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Parallel_inter_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">Q</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span>
     interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span>
     interfree_aux_right <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="main">⋂</span> <span class="main">(</span>set <span class="main">(</span>map postcond <span class="free">as</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span><span class="main">;</span>
     inter_aux_Par <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">cs</span><span class="main">,</span> <span class="free">as</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
     interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span>Parallel <span class="free">cs</span><span class="main">,</span> <span class="main">(</span>AnnPar <span class="free">as</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="free">com</span><span class="main">,</span> <span class="free">ann</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interfree_aux_def interfree_aux_right_def inter_aux_Par_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> assertionsR.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">interfree_swap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> body <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> proc_assns <span class="main">⇒</span> <span class="tfree">'f</span> set <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> com <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann <span class="main">×</span> <span class="tfree">'s</span> assn <span class="main">×</span> <span class="tfree">'s</span> assn<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> com list <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann <span class="main">×</span> <span class="tfree">'s</span> assn <span class="main">×</span> <span class="tfree">'s</span> assn<span class="main">)</span> list<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">interfree_swap</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">xs</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">y</span></span> <span class="main">&lt;</span> length <span class="bound">xs</span><span class="main">.</span> interfree_aux <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">xs</span> <span class="main">!</span> <span class="bound">y</span><span class="main">,</span> pres <span class="main">(</span><span class="bound">as</span> <span class="main">!</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span> interfree_aux <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span><span class="bound">xs</span> <span class="main">!</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">as</span> <span class="main">!</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> fst <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interfree_swap_Empty<span class="main">:</span> <span class="quoted"><span class="quoted">"interfree_swap  <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>interfree_swap_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interfree_swap_List<span class="main">:</span>  
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">y</span><span class="main">,</span> fst <span class="main">(</span><span class="free">a'</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> 
  interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">a'</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> fst <span class="free">a</span><span class="main">)</span><span class="main">;</span>
  interfree_swap <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span><span class="main">⟧</span> 
  <span class="main">⟹</span> interfree_swap <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">y</span><span class="main">#</span><span class="free">xs</span><span class="main">,</span> <span class="free">a'</span><span class="main">#</span><span class="free">as</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interfree_swap_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> v<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">v</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> interfree_swap_Map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span><span class="main">≤</span><span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span><span class="main">&lt;</span><span class="free">j</span> <span class="main">⟶</span> interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">c</span> <span class="bound">k</span><span class="main">,</span> fst <span class="main">(</span><span class="free">Q</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> 
 <span class="main">∧</span> interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">c</span> <span class="bound">k</span><span class="main">,</span> <span class="main">(</span><span class="free">Q</span> <span class="bound">k</span><span class="main">)</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> fst <span class="free">a</span><span class="main">)</span>
 <span class="main">⟹</span> interfree_swap <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> map <span class="free">c</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span><span class="main">,</span> map <span class="free">Q</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interfree_swap_def less_diff_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interfree_Empty<span class="main">:</span> <span class="quoted"><span class="quoted">"interfree <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>interfree_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interfree_List<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> interfree_swap <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span><span class="main">;</span> interfree <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="free">as</span> <span class="free">xs</span> <span class="main">⟧</span> <span class="main">⟹</span> interfree <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interfree_swap_def interfree_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> i j<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">j</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">j</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> interfree_Map<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free">a</span><span class="main">≤</span><span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">b</span> <span class="main">∧</span> <span class="free">a</span><span class="main">≤</span><span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span><span class="main">&lt;</span><span class="free">b</span>  <span class="main">∧</span> <span class="bound">i</span><span class="main">≠</span><span class="bound">j</span> <span class="main">⟶</span> interfree_aux <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span><span class="free">c</span> <span class="bound">i</span><span class="main">,</span> <span class="free">A</span> <span class="bound">i</span><span class="main">,</span> <span class="free">c</span> <span class="bound">j</span><span class="main">,</span> pres <span class="main">(</span><span class="free">A</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>  
  <span class="main">⟹</span> interfree <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">A</span> <span class="bound">k</span><span class="main">)</span> <span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">c</span> <span class="bound">k</span><span class="main">)</span> <span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interfree_def less_diff_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_lemmas<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">[]</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> Suc<span class="main">(</span>length <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">!</span> Suc <span class="free">n</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> le_Suc_eq_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span>Suc <span class="free">n</span><span class="main">}</span> <span class="main">=</span> insert <span class="free">n</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> primrecdef_list <span class="main">=</span> <span class="quoted">"pre.simps"</span> strengthen_pre.simps
<span class="keyword1"><span class="command">lemmas</span></span> ParallelConseq_list <span class="main">=</span> INTER_eq Collect_conj_eq length_map length_upt length_append
<span class="keyword1"><span class="command">lemmas</span></span> my_simp_list <span class="main">=</span> list_lemmas fst_conv snd_conv
not_less0 refl le_Suc_eq_insert Suc_not_Zero Zero_not_Suc nat.inject
Collect_mem_eq ball_simps option.simps primrecdef_list

<span class="comment1">(* Push remaining subgoals into hyps to remove duplicates quickly *)</span>
<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">hyp_tac</span> <span class="main">=</span> CSUBGOAL <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">prem</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span> <span class="main">=&gt;</span> PRIMITIVE <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm'</span> <span class="main">=</span> Thm.permute_prems <span class="inner_numeral">0</span> <span class="main">(</span><span class="entity">i</span>-<span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">thm</span> |&gt; Goal.protect <span class="inner_numeral">1</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">asm</span> <span class="main">=</span> Thm.assume <span class="entity">prem</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span>try <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm'</span> <span class="main">=&gt;</span> <span class="main">(</span>Thm.implies_elim <span class="entity">thm'</span> <span class="entity">asm</span><span class="main">)</span><span class="main">)</span> <span class="entity">thm'</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
      SOME <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">thm</span> |&gt; Goal.conclude |&gt; Thm.permute_prems <span class="inner_numeral">0</span> <span class="main">(</span>~<span class="main">(</span><span class="entity">i</span>-<span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span>
     <span class="main">|</span> NONE <span class="main">=&gt;</span> error <span class="main">(</span><span class="inner_quoted">"hyp_tac failed:"</span> ^ <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">make_string</span><span class="antiquote">}</span></span></span></span> <span class="main">(</span><span class="entity">thm'</span><span class="main">,</span><span class="entity">asm</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">)</span><span class="main">)</span>
›</span>
<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹

<span class="comment1">(*Remove a premise of the form 's ∈ _' if s is not referred to anywhere*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">remove_single_Bound_mem</span> <span class="entity">ctxt</span> <span class="main">=</span> SUBGOAL <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prems</span> <span class="main">=</span> Logic.strip_assums_hyp <span class="entity">t</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">concl</span> <span class="main">=</span> Logic.strip_assums_concl <span class="entity">t</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">bd_member</span> <span class="entity">t</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">HOLogic.dest_Trueprop</span> <span class="entity">t</span>
        <span class="keyword2"><span class="keyword">of</span></span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "Set.member"<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ Bound <span class="entity">j</span> $ <span class="main">_</span> <span class="main">=&gt;</span> SOME <span class="entity">j</span>
        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> NONE<span class="main">)</span> <span class="keyword3"><span class="keyword">handle</span></span> TERM <span class="main">_</span> <span class="main">=&gt;</span> NONE
  <span class="keyword2"><span class="keyword">in</span></span> filter_prems_tac <span class="entity">ctxt</span>
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">prem</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">bd_member</span> <span class="entity">prem</span> <span class="keyword2"><span class="keyword">of</span></span> NONE <span class="main">=&gt;</span> true
      <span class="main">|</span> SOME <span class="entity">j</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">xs</span> <span class="main">=</span> <span class="main">(</span>filter <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> loose_bvar1 <span class="main">(</span><span class="entity">t</span><span class="main">,</span> <span class="entity">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">concl</span> :: <span class="entity">prems</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">in</span></span> length <span class="entity">xs</span> &lt;&gt; <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
    <span class="entity">i</span>
  <span class="keyword2"><span class="keyword">end</span></span> <span class="keyword3"><span class="keyword">handle</span></span> Subscript <span class="main">=&gt;</span> no_tac<span class="main">)</span>
›</span>

<span class="keyword1"><span class="command">named_theorems</span></span> proc_simp
<span class="keyword1"><span class="command">named_theorems</span></span> oghoare_simps

<span class="keyword1"><span class="command">lemmas</span></span> guards.simps<span class="main">[</span><span class="operator">oghoare_simps</span> <span class="quasi_keyword"><span class="quasi_keyword">add</span></span><span class="main">]</span>
       ann_guards.simps<span class="main">[</span><span class="operator">oghoare_simps</span> <span class="quasi_keyword"><span class="quasi_keyword">add</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rt</span> <span class="entity">ctxt</span> <span class="entity">t</span> <span class="entity">i</span> <span class="main">=</span>
  resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span> <span class="entity">i</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rts</span> <span class="entity">ctxt</span> <span class="entity">xs</span> <span class="entity">i</span> <span class="main">=</span>
  resolve_tac <span class="entity">ctxt</span> <span class="entity">xs</span> <span class="entity">i</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">conjI_Tac</span> <span class="entity">ctxt</span> <span class="entity">tac</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="entity">st</span> |&gt;
       <span class="main">(</span> <span class="main">(</span>EVERY <span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="entity">conjI</span> <span class="entity">i</span><span class="main">,</span>
          <span class="entity">conjI_Tac</span> <span class="entity">ctxt</span> <span class="entity">tac</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
          <span class="entity">tac</span> <span class="entity">i</span><span class="main">]</span><span class="main">)</span> ORELSE <span class="main">(</span><span class="entity">tac</span> <span class="entity">i</span><span class="main">)</span> <span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_oghoare_simps</span> <span class="entity">ctxt</span> <span class="main">=</span>
 Proof_Context.get_thms <span class="entity">ctxt</span> <span class="inner_quoted">"oghoare_simps"</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">simp</span> <span class="entity">ctxt</span> <span class="entity">extra</span> <span class="main">=</span>
  <span class="entity">simp_tac</span> <span class="main">(</span>put_simpset <span class="entity">HOL_basic_ss</span> <span class="entity">ctxt</span> addsimps <span class="entity">extra</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">simp_only</span> <span class="entity">ctxt</span> <span class="entity">simps</span> <span class="main">=</span>
  <span class="entity">simp_tac</span> <span class="main">(</span><span class="main">(</span>clear_simpset <span class="entity">ctxt</span><span class="main">)</span> addsimps <span class="entity">simps</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prod_sel_simp</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="entity">simp_only</span> <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> prod.sel<span class="antiquote">}</span></span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">oghoare_simp</span> <span class="entity">ctxt</span> <span class="main">=</span>
   <span class="entity">simp_only</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">get_oghoare_simps</span> <span class="entity">ctxt</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ParallelConseq</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="entity">clarsimp_tac</span> <span class="main">(</span>put_simpset <span class="entity">HOL_basic_ss</span> <span class="entity">ctxt</span> addsimps <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> ParallelConseq_list<span class="antiquote">}</span></span></span> @ <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> my_simp_list<span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">enable_trace</span> <span class="main">=</span> false<span class="main">;</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">trace</span> <span class="entity">str</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">enable_trace</span> <span class="keyword2"><span class="keyword">then</span></span> tracing <span class="entity">str</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">HoareRuleTac</span> <span class="main">(</span><span class="entity">ctxt'</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span>
  <span class="main">(</span><span class="entity">Cache_Tactics.SUBGOAL_CACHE</span> <span class="main">(</span>nth <span class="entity">args</span> <span class="inner_numeral">0</span><span class="main">)</span>
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>SUBGOAL <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span> <span class="main">=&gt;</span>
    <span class="main">(</span>EVERY<span class="main">[</span><span class="entity">rts</span> <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> Seq Catch SeqSeq SeqCatch<span class="antiquote">}</span></span></span> <span class="entity">i</span><span class="main">,</span>
        <span class="entity">HoareRuleTac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
        <span class="entity">HoareRuleTac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span>
    ORELSE
    <span class="main">(</span>FIRST<span class="main">[</span><span class="entity">rts</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> SkipRule SeqSkipRule<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
         <span class="entity">rts</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> BasicRule SeqBasicRule<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
         <span class="entity">rts</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> ThrowRule SeqThrowRule<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
         <span class="entity">rts</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> SpecRule SeqSpecRule<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
         EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> SeqParallel<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
               <span class="entity">HoareRuleTac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
         EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span>  <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> ParallelConseqRule<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
               <span class="entity">ParallelConseq</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">2</span><span class="main">)</span><span class="main">,</span>
               <span class="entity">ParallelConseq</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
               <span class="entity">ParallelTac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
         EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> CondRule<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
               <span class="entity">HoareRuleTac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">2</span><span class="main">)</span><span class="main">,</span>
               <span class="entity">HoareRuleTac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
         EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> SeqCondRule<span class="antiquote">}</span></span></span> <span class="entity">i</span><span class="main">,</span>
               <span class="entity">HoareRuleTac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
               <span class="entity">HoareRuleTac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
         EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span>  <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> WhileRule<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
               <span class="entity">HoareRuleTac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">3</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
         EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span>  <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> SeqWhileRule<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
               <span class="entity">HoareRuleTac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
         EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> AwaitRule<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
               <span class="entity">HoareRuleTac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
               <span class="entity">simp</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> atom_com.simps<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
         EVERY<span class="main">[</span><span class="entity">rts</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> CallRule SeqCallRule<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
               <span class="entity">Call_asm_inst</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">2</span><span class="main">)</span><span class="main">,</span>
               <span class="entity">HoareRuleTac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
         EVERY<span class="main">[</span><span class="entity">rts</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> DynComRule SeqDynComRule<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
               <span class="entity">HoareRuleTac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
         EVERY<span class="main">[</span><span class="entity">rts</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> GuardRule<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
               <span class="entity">HoareRuleTac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">2</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
         K all_tac <span class="entity">i</span> <span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
         THEN_ALL_NEW <span class="entity">hyp_tac</span><span class="main">)</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span>

<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">Call_asm_inst</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">proc_simps</span> <span class="main">=</span> Proof_Context.get_thms <span class="entity">ctxt</span> <span class="inner_quoted">"proc_simp"</span> @ <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> list_lemmas<span class="antiquote">}</span></span></span> <span class="keyword2"><span class="keyword">in</span></span>
    EVERY<span class="main">[</span><span class="entity">rts</span> <span class="entity">ctxt</span> <span class="entity">proc_simps</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">3</span><span class="main">)</span><span class="main">,</span>
         <span class="entity">rts</span> <span class="entity">ctxt</span> <span class="entity">proc_simps</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">2</span><span class="main">)</span><span class="main">,</span>
         <span class="entity">rts</span> <span class="entity">ctxt</span> <span class="entity">proc_simps</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
        <span class="entity">ParallelConseq</span> <span class="entity">ctxt</span> <span class="entity">i</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">ParallelTac</span> <span class="main">(</span><span class="entity">ctxt'</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="main">=</span>
          EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> ParallelRule<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                               <span class="entity">ParallelConseq</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">2</span><span class="main">)</span><span class="main">,</span>
                               <span class="entity">interfree_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
                               <span class="entity">ParallelConseq</span> <span class="entity">ctxt</span> <span class="entity">i</span><span class="main">,</span>
                               <span class="entity">MapAnn_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">MapAnn_Tac</span> <span class="main">(</span><span class="entity">ctxt'</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="entity">st</span> |&gt;
    <span class="main">(</span>FIRST<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> MapAnnEmpty<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
           EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> MapAnnList<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">MapAnn_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">HoareRuleTac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
            EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> MapAnnMap<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> allI<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span> <span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> impI<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">HoareRuleTac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">interfree_Tac</span> <span class="main">(</span><span class="entity">ctxt'</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="entity">st</span> |&gt;
   <span class="main">(</span>FIRST<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> interfree_Empty<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
          EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> interfree_List<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                <span class="entity">interfree_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
                <span class="entity">interfree_swap_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
          EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> interfree_Map<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                <span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> allI<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span> <span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> allI<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span> <span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> impI<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                <span class="entity">interfree_aux_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span> <span class="main">]</span><span class="main">]</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">interfree_swap_Tac</span> <span class="main">(</span><span class="entity">ctxt'</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="entity">st</span> |&gt;
    <span class="main">(</span>FIRST<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> interfree_swap_Empty<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
           EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> interfree_swap_List<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">interfree_swap_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">2</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">interfree_aux_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">interfree_aux_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span> <span class="main">]</span><span class="main">,</span>
           EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> interfree_swap_Map<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> allI<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span> <span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> impI<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">conjI_Tac</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">interfree_aux_Tac</span> <span class="entity">ctxt'</span><span class="main">)</span> <span class="entity">i</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">inter_aux_Par_Tac</span> <span class="main">(</span><span class="entity">ctxt'</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="entity">st</span> |&gt;
    <span class="main">(</span>FIRST<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> inter_aux_Par_Empty<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
           EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> inter_aux_Par_List<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">inter_aux_Par_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">interfree_aux_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span> <span class="main">]</span><span class="main">,</span>
           EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> inter_aux_Par_Map<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> allI<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span> <span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> impI<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">interfree_aux_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">interfree_aux_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">dest_inter_aux_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span>

<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">dest_inter_aux_Tac</span> <span class="main">(</span><span class="entity">ctxt'</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span>
  <span class="main">(</span><span class="entity">Cache_Tactics.SUBGOAL_CACHE</span> <span class="main">(</span>nth <span class="entity">args</span> <span class="inner_numeral">1</span><span class="main">)</span>
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>SUBGOAL <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span> <span class="main">=&gt;</span>
     <span class="main">(</span>TRY <span class="main">(</span>REPEAT <span class="main">(</span><span class="entity">EqSubst.eqsubst_tac</span> <span class="entity">ctxt</span> <span class="main">[</span><span class="inner_numeral">0</span><span class="main">]</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> prod.sel<span class="antiquote">}</span></span></span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span> THEN
     FIRST<span class="main">[</span>EVERY<span class="main">[</span><span class="entity">rts</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> Skip_inter_aux Throw_inter_aux Basic_inter_aux Spec_inter_aux<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">2</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
           EVERY<span class="main">[</span><span class="entity">rts</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> Seq_inter_aux Catch_inter_aux<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">dest_inter_aux_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">dest_inter_aux_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">0</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
           EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Cond_inter_aux<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">dest_inter_aux_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">2</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">dest_inter_aux_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
           EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> While_inter_aux<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">dest_inter_aux_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">2</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
           EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Await_inter_aux<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">2</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">0</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
           EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Call_inter_aux<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">Call_asm_inst</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">2</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">dest_inter_aux_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
           EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> DynCom_inter_aux<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">dest_inter_aux_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">3</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">2</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
           EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Guard_inter_aux<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">dest_inter_aux_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">2</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
           EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Parallel_inter_aux<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">inter_aux_Par_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">3</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">2</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
           <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
         THEN_ALL_NEW <span class="entity">hyp_tac</span><span class="main">)</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span>

<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">dest_inter_right_Tac</span> <span class="main">(</span><span class="entity">ctxt'</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span>
  <span class="main">(</span><span class="entity">Cache_Tactics.SUBGOAL_CACHE</span> <span class="main">(</span>nth <span class="entity">args</span> <span class="inner_numeral">2</span><span class="main">)</span>
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span> <span class="main">=&gt;</span>
     FIRST<span class="main">[</span>EVERY<span class="main">[</span><span class="entity">rts</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> Skip_inter_right Throw_inter_right
                                  Basic_inter_right Spec_inter_right<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">HoareRuleTac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
           EVERY<span class="main">[</span><span class="entity">rts</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> Seq_inter_right Catch_inter_right<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
           EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Cond_inter_right<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
           EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> While_inter_right<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
           EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Await_inter_right<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">HoareRuleTac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">simp</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> atom_com.simps<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
           EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Call_inter_right<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                   <span class="entity">Call_asm_inst</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
                   <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
           EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> DynCom_inter_right<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                   <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
           EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Guard_inter_right<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                   <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
           <span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Parallel_inter_right_empty<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
           EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Parallel_inter_right_List<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
           EVERY<span class="main">[</span><span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Parallel_inter_right_Map<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> allI<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span> <span class="entity">rt</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> impI<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
                 <span class="entity">dest_inter_right_Tac</span> <span class="entity">ctxt'</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
           K all_tac <span class="entity">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span>
›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">oghoare_tac</span> <span class="entity">ctxt</span> <span class="main">=</span>
   SUBGOAL <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span> <span class="main">=&gt;</span>
   TRY <span class="main">(</span><span class="entity">prod_sel_simp</span> <span class="entity">ctxt</span> <span class="entity">i</span><span class="main">)</span>
   THEN TRY <span class="main">(</span><span class="entity">oghoare_simp</span> <span class="entity">ctxt</span> <span class="entity">i</span><span class="main">)</span>
   THEN <span class="entity">Cache_Tactics.cacheify_tactic</span> <span class="inner_numeral">3</span> <span class="entity">HoareRuleTac</span> <span class="entity">ctxt</span> <span class="entity">i</span><span class="main">)</span>

<span class="comment1">(* oghoare_tac' fails if oghoare_tac does not do anything *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">oghoare_tac'</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">goal</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">results</span> <span class="main">=</span> <span class="entity">oghoare_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">goal</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span>Thm.eq_thm <span class="main">(</span><span class="entity">results</span> |&gt; Seq.hd<span class="main">,</span> <span class="entity">goal</span><span class="main">)</span> <span class="keyword3"><span class="keyword">handle</span></span> Option <span class="main">=&gt;</span> false<span class="main">)</span>
    <span class="keyword2"><span class="keyword">then</span></span> no_tac <span class="entity">goal</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">results</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">oghoare_parallel_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="main">=</span> 
  TRY <span class="main">(</span><span class="entity">oghoare_simp</span> <span class="entity">ctxt</span> <span class="entity">i</span><span class="main">)</span> THEN
  <span class="entity">Cache_Tactics.cacheify_tactic</span> <span class="inner_numeral">3</span> <span class="entity">ParallelTac</span> <span class="entity">ctxt</span> <span class="entity">i</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">oghoare_interfree_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="main">=</span>
  TRY <span class="main">(</span><span class="entity">oghoare_simp</span> <span class="entity">ctxt</span> <span class="entity">i</span><span class="main">)</span> THEN
  <span class="entity">Cache_Tactics.cacheify_tactic</span> <span class="inner_numeral">3</span> <span class="entity">interfree_Tac</span> <span class="entity">ctxt</span> <span class="entity">i</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">oghoare_interfree_aux_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="main">=</span>
  TRY <span class="main">(</span><span class="entity">oghoare_simp</span> <span class="entity">ctxt</span> <span class="entity">i</span><span class="main">)</span> THEN
  <span class="entity">Cache_Tactics.cacheify_tactic</span> <span class="inner_numeral">3</span> <span class="entity">interfree_aux_Tac</span> <span class="entity">ctxt</span> <span class="entity">i</span>
›</span>

<span class="keyword1"><span class="command">method_setup</span></span> oghoare <span class="main">=</span> <span class="quoted">‹
  Scan.succeed <span class="main">(</span><span class="entity">SIMPLE_METHOD'</span> o <span class="entity">oghoare_tac'</span><span class="main">)</span>›</span>
  <span class="quoted">"verification condition generator for the oghoare logic"</span>

<span class="keyword1"><span class="command">method_setup</span></span> oghoare_parallel <span class="main">=</span> <span class="quoted">‹
  Scan.succeed <span class="main">(</span><span class="entity">SIMPLE_METHOD'</span> o <span class="entity">oghoare_parallel_tac</span><span class="main">)</span>›</span>
  <span class="quoted">"verification condition generator for the oghoare logic"</span>

<span class="keyword1"><span class="command">method_setup</span></span> oghoare_interfree <span class="main">=</span> <span class="quoted">‹
  Scan.succeed <span class="main">(</span><span class="entity">SIMPLE_METHOD'</span> o <span class="entity">oghoare_interfree_tac</span><span class="main">)</span>›</span>
  <span class="quoted">"verification condition generator for the oghoare logic"</span>

<span class="keyword1"><span class="command">method_setup</span></span> oghoare_interfree_aux <span class="main">=</span> <span class="quoted">‹
  Scan.succeed <span class="main">(</span><span class="entity">SIMPLE_METHOD'</span> o <span class="entity">oghoare_interfree_aux_tac</span><span class="main">)</span>›</span>
  <span class="quoted">"verification condition generator for the oghoare logic"</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="OG_Syntax">
<div class="head">
<h1>Theory OG_Syntax</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright 2016, Data61, CSIRO
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(DATA61_BSD)
 *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Shallowly-embedded syntax for COMPLX programs›</span></span>
<span class="keyword1"><span class="command">theory</span></span> OG_Syntax
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="OG_Hoare.html">OG_Hoare</a>
  <a href="OG_Tactics.html">OG_Tactics</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">=</span>
  AnnCom <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ann</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ann</span> <span class="main">(</span>AnnCom <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">com</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">com</span> <span class="main">(</span>AnnCom <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> ann.simps<span class="main">[</span><span class="operator">oghoare_simps</span><span class="main">]</span> com.simps<span class="main">[</span><span class="operator">oghoare_simps</span><span class="main">]</span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_quote"</span>     <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>                <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">«</span>_<span class="keyword1">»</span><span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">]</span> 1000<span class="main">)</span>
  <span class="quoted">"_antiquote"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>                <span class="main">(</span><span class="quoted">"<span class="keyword1">´</span>_"</span> <span class="main">[</span>1000<span class="main">]</span> 1000<span class="main">)</span>
  <span class="quoted">"_Assert"</span>    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>                    <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">⦃</span>_<span class="keyword1">⦄</span><span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">]</span> 1000<span class="main">)</span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="main">⦃</span><span class="free">b</span><span class="main">⦄</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="keyword1">CONST</span> Collect <span class="main">«</span><span class="free">b</span><span class="main">»</span>"</span>

<span class="keyword1"><span class="command">parse_translation</span></span> <span class="quoted">‹
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">quote_tr</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span> <span class="main">=</span> Syntax_Trans.quote_tr <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_antiquote"<span class="antiquote">}</span></span> <span class="entity">t</span>
      <span class="main">|</span> <span class="entity">quote_tr</span> <span class="entity">ts</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"quote_tr"</span><span class="main">,</span> <span class="entity">ts</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">[</span><span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_quote"<span class="antiquote">}</span></span><span class="main">,</span> K <span class="entity">quote_tr</span><span class="main">)</span><span class="main">]</span> <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_fst"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1"><span class="hidden">⇩</span><sub>,</sub></span>"</span> <span class="main">[</span>60<span class="main">]</span> 61<span class="main">)</span>
  <span class="quoted">"_snd"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1"><span class="hidden">⇩</span><sub>.</sub></span>"</span> <span class="main">[</span>60<span class="main">]</span> 61<span class="main">)</span>

<span class="keyword1"><span class="command">parse_translation</span></span> <span class="quoted">‹
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fst_tr</span> <span class="main">(</span><span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Pair<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">p</span> $ <span class="entity">c</span><span class="main">)</span>
          :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span> <span class="entity">p</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">snd_tr</span> <span class="main">(</span><span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Pair<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">p</span> $ <span class="entity">c</span><span class="main">)</span>
          :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span> <span class="entity">c</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>
   <span class="main">[</span><span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_fst"<span class="antiquote">}</span></span><span class="main">,</span> K <span class="entity">fst_tr</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_snd"<span class="antiquote">}</span></span><span class="main">,</span> K <span class="entity">snd_tr</span><span class="main">)</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Syntax for commands and for assertions and boolean expressions in 
 commands <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>com›</span></span></span></span> and annotated commands <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ann_com›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_Annotation"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1"><span class="hidden">⇩</span><sub>?</sub></span>"</span> <span class="main">[</span>60<span class="main">]</span> 61<span class="main">)</span>
  <span class="quoted">"_Command"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1"><span class="hidden">⇩</span><sub>!</sub></span>"</span> <span class="main">[</span>60<span class="main">]</span> 61<span class="main">)</span>

<span class="keyword1"><span class="command">parse_translation</span></span> <span class="quoted">‹
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ann_tr</span> <span class="main">(</span><span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> AnnCom<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">p</span> $ <span class="entity">c</span><span class="main">)</span>
          :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span> <span class="entity">p</span>
      <span class="main">|</span> <span class="entity">ann_tr</span> <span class="main">(</span><span class="entity">p</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
          Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> ann<span class="antiquote">}</span></span><span class="main">,</span> dummyT<span class="main">)</span> $ <span class="entity">p</span>
      <span class="main">|</span> <span class="entity">ann_tr</span> <span class="entity">x</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"ann_tr"</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">com_tr</span> <span class="main">(</span><span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> AnnCom<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">p</span> $ <span class="entity">c</span><span class="main">)</span>
          :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span> <span class="entity">c</span>
      <span class="main">|</span> <span class="entity">com_tr</span> <span class="main">(</span><span class="entity">c</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
          Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> com<span class="antiquote">}</span></span><span class="main">,</span> dummyT<span class="main">)</span> $ <span class="entity">c</span>
      <span class="main">|</span> <span class="entity">com_tr</span> <span class="entity">x</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"com_tr"</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>
   <span class="main">[</span><span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_Annotation"<span class="antiquote">}</span></span><span class="main">,</span> K <span class="entity">ann_tr</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_Command"<span class="antiquote">}</span></span><span class="main">,</span> K <span class="entity">com_tr</span><span class="main">)</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_Seq"</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                   <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword1">,,</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>55<span class="main">,</span> 56<span class="main">]</span> 55<span class="main">)</span>
  <span class="quoted">"_AnnSeq"</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                   <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword1">;;</span><span class="keyword3">//</span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>55<span class="main">,</span> 56<span class="main">]</span> 55<span class="main">)</span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"_Seq <span class="free">c1</span> <span class="free">c2</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="keyword1">CONST</span> AnnCom <span class="main">(</span><span class="keyword1">CONST</span> AnnComp <span class="main">(</span><span class="free">c1</span><span class="main"><span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">c2</span><span class="main"><span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">CONST</span> Seq <span class="main">(</span><span class="free">c1</span><span class="main"><span class="hidden">⇩</span><sub>!</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">c2</span><span class="main"><span class="hidden">⇩</span><sub>!</sub></span><span class="main">)</span><span class="main">)</span>"</span>
  <span class="quoted">"_AnnSeq <span class="free">c1</span> <span class="free">c2</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="keyword1">CONST</span> AnnCom <span class="main">(</span><span class="keyword1">CONST</span> AnnComp <span class="main">(</span><span class="free">c1</span><span class="main"><span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">c2</span><span class="main"><span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">CONST</span> Seq <span class="main">(</span><span class="free">c1</span><span class="main"><span class="hidden">⇩</span><sub>!</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">c2</span><span class="main"><span class="hidden">⇩</span><sub>!</sub></span><span class="main">)</span><span class="main">)</span>"</span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_Assign"</span>    <span class="main">::</span> <span class="quoted"><span class="quoted">"idt <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                   <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">´</span>_ <span class="keyword1">:=</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>70<span class="main">,</span> 65<span class="main">]</span> 61<span class="main">)</span>
  <span class="quoted">"_AnnAssign"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> assn <span class="main">⇒</span> idt <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                   <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">//</span><span class="keyword1">´</span>_ <span class="keyword1">:=</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>90<span class="main">,</span>70<span class="main">,</span>65<span class="main">]</span> 61<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">FAKE_ANN</span> <span class="main">≡</span> UNIV"</span></span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="free">r</span> <span class="main">´</span><span class="free">x</span> <span class="main">:=</span> <span class="free">a</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="keyword1">CONST</span> AnnCom <span class="main">(</span><span class="keyword1">CONST</span> AnnExpr <span class="free">r</span><span class="main">)</span>
                               <span class="main">(</span><span class="keyword1">CONST</span> Basic <span class="main">«</span><span class="main">´</span><span class="main">(</span>_update_name <span class="free">x</span> <span class="main">(</span><span class="main">λ</span><span class="main">_</span><span class="main">.</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">»</span><span class="main">)</span>"</span>
  <span class="quoted">"<span class="main">´</span><span class="free">x</span> <span class="main">:=</span> <span class="free">a</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> FAKE_ANN <span class="main">´</span><span class="free">x</span> <span class="main">:=</span> <span class="free">a</span>"</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_var</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">v</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fun_to_rel</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span>  <span class="main">⋃</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="main">`</span> UNIV<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_Spec"</span>      <span class="main">::</span> <span class="quoted"><span class="quoted">"idt <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                   <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">´</span>_ <span class="keyword1">:∈</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>70<span class="main">,</span> 65<span class="main">]</span> 61<span class="main">)</span>
  <span class="quoted">"_AnnSpec"</span>   <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> assn <span class="main">⇒</span> idt <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                   <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">//</span><span class="keyword1">´</span>_ <span class="keyword1">:∈</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>90<span class="main">,</span>70<span class="main">,</span>65<span class="main">]</span> 61<span class="main">)</span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="free">r</span> <span class="main">´</span><span class="free">x</span> <span class="main">:∈</span> <span class="free">S</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="keyword1">CONST</span> AnnCom <span class="main">(</span><span class="keyword1">CONST</span> AnnExpr <span class="free">r</span><span class="main">)</span>
                               <span class="main">(</span><span class="keyword1">CONST</span> Spec <span class="main">(</span><span class="keyword1">CONST</span> fun_to_rel <span class="main">«</span><span class="main">´</span><span class="main">(</span><span class="keyword1">CONST</span> update_var <span class="main">(</span>_update_name <span class="free">x</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">»</span><span class="main">)</span><span class="main">)</span>"</span>
  <span class="quoted">"<span class="main">´</span><span class="free">x</span> <span class="main">:∈</span> <span class="free">S</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> FAKE_ANN <span class="main">´</span><span class="free">x</span> <span class="main">:∈</span> <span class="free">S</span>"</span>


<span class="keyword1"><span class="command">nonterminal</span></span> grds <span class="keyword2"><span class="keyword">and</span></span> grd

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_AnnCond1"</span>    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="tfree">'s</span> bexp  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                    <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">//</span><span class="keyword1">IF</span> _<span class="keyword3">//</span><span class="keyword3">(2</span><span class="keyword1">THEN</span><span class="keyword3">/ </span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span><span class="keyword3">//</span><span class="keyword3">(2</span><span class="keyword1">ELSE</span><span class="keyword3">/ </span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span><span class="keyword3">//</span><span class="keyword1">FI</span><span class="keyword3">)</span>"</span>  <span class="main">[</span>90<span class="main">,</span>0<span class="main">,</span>0<span class="main">,</span>0<span class="main">]</span> 61<span class="main">)</span>
  <span class="quoted">"_AnnCond2"</span>    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="tfree">'s</span> bexp  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                    <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">//</span><span class="keyword1">IF</span> _<span class="keyword3">//</span><span class="keyword3">(2</span><span class="keyword1">THEN</span><span class="keyword3">/ </span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span><span class="keyword3">//</span><span class="keyword1">FI</span><span class="keyword3">)</span>"</span>  <span class="main">[</span>90<span class="main">,</span>0<span class="main">,</span>0<span class="main">]</span> 61<span class="main">)</span>
  <span class="quoted">"_AnnWhile"</span>    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="tfree">'s</span> bexp  <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span> 
                    <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">//</span><span class="keyword1">WHILE</span> _<span class="keyword3">/ </span><span class="keyword1">INV</span> _<span class="keyword3">//</span><span class="keyword3">(2</span><span class="keyword1">DO</span><span class="keyword3">/ </span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span><span class="keyword3">//</span><span class="keyword1">OD</span><span class="keyword3">)</span>"</span>  <span class="main">[</span>90<span class="main">,</span>0<span class="main">,</span>0<span class="main">,</span>0<span class="main">]</span> 61<span class="main">)</span>
  <span class="quoted">"_AnnAwait"</span>    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="tfree">'s</span> bexp  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                    <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">//</span><span class="keyword1">AWAIT</span> _<span class="keyword3">/ </span><span class="keyword3">(2</span><span class="keyword1">THEN</span><span class="keyword3">/ </span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span><span class="keyword3">/ </span><span class="keyword1">END</span><span class="keyword3">)</span>"</span>  <span class="main">[</span>90<span class="main">,</span>0<span class="main">,</span>0<span class="main">]</span> 61<span class="main">)</span>
  <span class="quoted">"_AnnAtom"</span>     <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> assn  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                    <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">//</span><span class="keyword1">⟨</span>_<span class="keyword1">⟩</span><span class="keyword3">)</span>"</span> <span class="main">[</span>90<span class="main">,</span>0<span class="main">]</span> 61<span class="main">)</span>
  <span class="quoted">"_AnnWait"</span>     <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="tfree">'s</span> bexp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                    <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">//</span><span class="keyword1">WAIT</span> _<span class="keyword3">/ </span><span class="keyword1">END</span><span class="keyword3">)</span>"</span> <span class="main">[</span>90<span class="main">,</span>0<span class="main">]</span> 61<span class="main">)</span>

  <span class="quoted">"_Cond"</span>        <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> bexp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span> 
                    <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">IF</span> _<span class="keyword3">//</span><span class="keyword3">(2</span><span class="keyword1">THEN</span><span class="keyword3">/ </span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span><span class="keyword3">//</span><span class="keyword3">(2</span><span class="keyword1">ELSE</span><span class="keyword3">/ </span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span><span class="keyword3">//</span><span class="keyword1">FI</span><span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 61<span class="main">)</span>
  <span class="quoted">"_Cond2"</span>       <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> bexp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                    <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">IF</span> _<span class="keyword3">//</span><span class="keyword3">(2</span><span class="keyword1">THEN</span><span class="keyword3">/ </span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span><span class="keyword3">//</span><span class="keyword1">FI</span><span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span>0<span class="main">]</span> 56<span class="main">)</span>
  <span class="quoted">"_While_inv"</span>   <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> bexp <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                    <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">WHILE</span> _<span class="keyword3">/ </span><span class="keyword1">INV</span> _<span class="keyword3">//</span><span class="keyword3">(2</span><span class="keyword1">DO</span><span class="keyword3">/ </span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span><span class="keyword3">//</span><span class="keyword1">OD</span><span class="keyword3">)</span>"</span>  <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 61<span class="main">)</span>
  <span class="quoted">"_While"</span>       <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> bexp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                    <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">WHILE</span> _<span class="keyword3">//</span><span class="keyword3">(2</span><span class="keyword1">DO</span><span class="keyword3">/ </span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span><span class="keyword3">//</span><span class="keyword1">OD</span><span class="keyword3">)</span>"</span>  <span class="main">[</span>0<span class="main">,</span> 0<span class="main">]</span> 61<span class="main">)</span>
  <span class="quoted">"_Await"</span>       <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> bexp  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                    <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">AWAIT</span> _<span class="keyword3">/ </span><span class="keyword3">(2</span><span class="keyword1">THEN</span><span class="keyword3">/ </span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span><span class="keyword3">/ </span><span class="keyword1">END</span><span class="keyword3">)</span>"</span>  <span class="main">[</span>0<span class="main">,</span>0<span class="main">]</span> 61<span class="main">)</span>
  <span class="quoted">"_Atom"</span>        <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                    <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">⟨</span>_<span class="keyword1">⟩</span><span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">]</span> 61<span class="main">)</span>
  <span class="quoted">"_Wait"</span>        <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> bexp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                    <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">WAIT</span> _<span class="keyword3">/ </span><span class="keyword1">END</span><span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">]</span> 61<span class="main">)</span>
  <span class="quoted">"_grd"</span>         <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">⇒</span> <span class="tfree">'s</span> bexp <span class="main">⇒</span> grd"</span></span>
                    <span class="main">(</span><span class="quoted">"<span class="keyword1">'(</span>_<span class="keyword1">,</span> _<span class="keyword1">')</span>"</span> <span class="main">[</span>1000<span class="main">]</span> 1000<span class="main">)</span>
  <span class="quoted">"_last_grd"</span>    <span class="main">::</span> <span class="quoted"><span class="quoted">"grd <span class="main">⇒</span> grds"</span></span>   <span class="main">(</span><span class="quoted">"_"</span> 1000<span class="main">)</span>
  <span class="quoted">"_grds"</span>        <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>grd<span class="main">,</span> grds<span class="main">]</span> <span class="main">⇒</span> grds"</span></span>
                    <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword1">,</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>999<span class="main">,</span>1000<span class="main">]</span> 1000<span class="main">)</span>
  <span class="quoted">"_guards"</span>      <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> assn <span class="main">⇒</span> grds  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                    <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">//</span><span class="keyword3">(2</span>_ <span class="keyword1">⟼</span><span class="keyword3">/ </span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span><span class="keyword3">)</span>"</span> <span class="main">[</span>90<span class="main">,</span> 0<span class="main">,</span> 56<span class="main">]</span> 61<span class="main">)</span>
  <span class="quoted">"_Throw"</span>       <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                    <span class="main">(</span><span class="quoted">"<span class="keyword1">THROW</span>"</span> 61<span class="main">)</span>
  <span class="quoted">"_AnnThrow"</span>    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                    <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">/ </span><span class="keyword1">THROW</span><span class="keyword3">)</span>"</span> <span class="main">[</span>90<span class="main">]</span> 61<span class="main">)</span>
  <span class="quoted">"_Try_Catch"</span>   <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">⇒</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                    <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword3">(2</span><span class="keyword1">TRY</span><span class="keyword3">/ </span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span><span class="keyword3">//</span><span class="keyword3">(2</span><span class="keyword1">CATCH</span><span class="keyword3">/ </span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span><span class="keyword3">/ </span><span class="keyword1">END</span><span class="keyword3">)</span>"</span>  <span class="main">[</span>0<span class="main">,</span>0<span class="main">]</span> 71<span class="main">)</span>
  <span class="quoted">"_AnnCallX"</span>    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> assn  <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">⇒</span><span class="tfree">'s</span><span class="main">⇒</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> com<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                    <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">//</span><span class="keyword3">(2</span><span class="keyword1">CALLX</span><span class="keyword3">/ </span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">//</span>_<span class="keyword3">/ </span>_<span class="keyword3">/ </span>_<span class="keyword3">//</span>_<span class="keyword3">/ </span>_<span class="keyword3">//</span>_<span class="keyword3">/ </span>_<span class="keyword3">//</span>_<span class="keyword3">/ </span>_<span class="keyword3">)</span><span class="keyword3">)</span>"</span>
                      <span class="main">[</span>90<span class="main">,</span>1000<span class="main">,</span>0<span class="main">,</span>1000<span class="main">,</span>0<span class="main">,</span>1000<span class="main">,</span>1000<span class="main">,</span>0<span class="main">,</span>0<span class="main">,</span>0<span class="main">,</span>0<span class="main">]</span> 61<span class="main">)</span>
  <span class="quoted">"_AnnSCall"</span>    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                    <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">//</span><span class="keyword1">SCALL</span> _<span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>90<span class="main">,</span>0<span class="main">,</span>0<span class="main">]</span> 61<span class="main">)</span>
  <span class="quoted">"_Skip"</span>        <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                    <span class="main">(</span><span class="quoted">"<span class="keyword1">SKIP</span>"</span> 61<span class="main">)</span>
  <span class="quoted">"_AnnSkip"</span>     <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
                    <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">/ </span><span class="keyword1">SKIP</span><span class="keyword3">)</span>"</span> <span class="main">[</span>90<span class="main">]</span> 61<span class="main">)</span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="free">r</span> <span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c1</span> <span class="keyword1">ELSE</span> <span class="free">c2</span> <span class="keyword1">FI</span>"</span> <span class="main">⇀</span>
    <span class="quoted">"<span class="keyword1">CONST</span> AnnCom <span class="main">(</span><span class="keyword1">CONST</span> AnnBin <span class="free">r</span> <span class="main">(</span><span class="free">c1</span><span class="main"><span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">c2</span><span class="main"><span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">CONST</span> Cond <span class="main">⦃</span><span class="free">b</span><span class="main">⦄</span> <span class="main">(</span><span class="free">c1</span><span class="main"><span class="hidden">⇩</span><sub>!</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">c2</span><span class="main"><span class="hidden">⇩</span><sub>!</sub></span><span class="main">)</span><span class="main">)</span>"</span>
  <span class="quoted">"<span class="free">r</span> <span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c</span> <span class="keyword1">FI</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="free">r</span> <span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c</span> <span class="keyword1">ELSE</span> <span class="keyword1">SKIP</span> <span class="keyword1">FI</span>"</span>
  <span class="quoted">"<span class="free">r</span> <span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">INV</span> <span class="free">i</span> <span class="keyword1">DO</span> <span class="free">c</span> <span class="keyword1">OD</span>"</span> <span class="main">⇀</span>
    <span class="quoted">"<span class="keyword1">CONST</span> AnnCom <span class="main">(</span><span class="keyword1">CONST</span> AnnWhile <span class="free">r</span> <span class="free">i</span> <span class="main">(</span><span class="free">c</span><span class="main"><span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">CONST</span> While <span class="main">⦃</span><span class="free">b</span><span class="main">⦄</span> <span class="main">(</span><span class="free">c</span><span class="main"><span class="hidden">⇩</span><sub>!</sub></span><span class="main">)</span><span class="main">)</span>"</span>
  <span class="quoted">"<span class="free">r</span> <span class="keyword1">AWAIT</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c</span> <span class="keyword1">END</span>"</span> <span class="main">⇀</span>
    <span class="quoted">"<span class="keyword1">CONST</span> AnnCom <span class="main">(</span><span class="keyword1">CONST</span> AnnRec <span class="free">r</span> <span class="main">(</span><span class="free">c</span><span class="main"><span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">CONST</span> Await <span class="main">⦃</span><span class="free">b</span><span class="main">⦄</span> <span class="main">(</span><span class="free">c</span><span class="main"><span class="hidden">⇩</span><sub>!</sub></span><span class="main">)</span><span class="main">)</span>"</span>
  <span class="quoted">"<span class="free">r</span> <span class="main">⟨</span><span class="free">c</span><span class="main">⟩</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="free">r</span> <span class="keyword1">AWAIT</span> <span class="keyword1">CONST</span> True <span class="keyword1">THEN</span> <span class="free">c</span> <span class="keyword1">END</span>"</span>
  <span class="quoted">"<span class="free">r</span> <span class="keyword1">WAIT</span> <span class="free">b</span> <span class="keyword1">END</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="free">r</span> <span class="keyword1">AWAIT</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="keyword1">SKIP</span> <span class="keyword1">END</span>"</span>

  <span class="quoted">"<span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c1</span> <span class="keyword1">ELSE</span> <span class="free">c2</span> <span class="keyword1">FI</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> FAKE_ANN <span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c1</span> <span class="keyword1">ELSE</span> <span class="free">c2</span> <span class="keyword1">FI</span>"</span>
  <span class="quoted">"<span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c</span> <span class="keyword1">FI</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> FAKE_ANN <span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c</span> <span class="keyword1">ELSE</span> <span class="keyword1">SKIP</span> <span class="keyword1">FI</span>"</span>
  <span class="quoted">"<span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span> <span class="keyword1">OD</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> FAKE_ANN <span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">INV</span> <span class="keyword1">CONST</span> FAKE_ANN <span class="keyword1">DO</span> <span class="free">c</span> <span class="keyword1">OD</span>"</span>
  <span class="quoted">"<span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">INV</span> <span class="free">i</span> <span class="keyword1">DO</span> <span class="free">c</span> <span class="keyword1">OD</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> FAKE_ANN <span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">INV</span> <span class="free">i</span> <span class="keyword1">DO</span> <span class="free">c</span> <span class="keyword1">OD</span>"</span>
  <span class="quoted">"<span class="keyword1">AWAIT</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c</span> <span class="keyword1">END</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> FAKE_ANN <span class="keyword1">AWAIT</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c</span> <span class="keyword1">END</span>"</span>
  <span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">⟩</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> FAKE_ANN <span class="keyword1">AWAIT</span> <span class="keyword1">CONST</span> True <span class="keyword1">THEN</span> <span class="free">c</span> <span class="keyword1">END</span>"</span>
  <span class="quoted">"<span class="keyword1">WAIT</span> <span class="free">b</span> <span class="keyword1">END</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">AWAIT</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="keyword1">SKIP</span> <span class="keyword1">END</span>"</span>

  <span class="quoted">"_grd <span class="free">f</span> <span class="free">g</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span>"</span>
  <span class="quoted">"_grds <span class="free">g</span> <span class="free">gs</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="free">g</span><span class="main">#</span><span class="free">gs</span>"</span>
  <span class="quoted">"_last_grd <span class="free">g</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="main">[</span><span class="free">g</span><span class="main">]</span>"</span>
  <span class="quoted">"_guards <span class="free">r</span> <span class="free">gs</span> <span class="free">c</span>"</span> <span class="main">⇀</span>
    <span class="quoted">"<span class="keyword1">CONST</span> AnnCom <span class="main">(</span><span class="keyword1">CONST</span> ann_guards <span class="free">r</span> <span class="free">gs</span> <span class="main">(</span><span class="free">c</span><span class="main"><span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">CONST</span> guards <span class="free">gs</span> <span class="main">(</span><span class="free">c</span><span class="main"><span class="hidden">⇩</span><sub>!</sub></span><span class="main">)</span><span class="main">)</span>"</span>

  <span class="quoted">"<span class="free">ai</span> <span class="keyword1">CALLX</span> <span class="free">init</span> <span class="free">r</span> <span class="free">p</span> <span class="free">n</span> <span class="free">restore</span> <span class="free">return</span> <span class="free">arestoreq</span> <span class="free">areturn</span> <span class="free">arestorea</span> <span class="free">A</span>"</span> <span class="main">⇀</span>
    <span class="quoted">"<span class="keyword1">CONST</span> AnnCom <span class="main">(</span><span class="keyword1">CONST</span> ann_call <span class="free">ai</span> <span class="free">r</span> <span class="free">n</span> <span class="free">arestoreq</span> <span class="free">areturn</span> <span class="free">arestorea</span> <span class="free">A</span><span class="main">)</span>
                  <span class="main">(</span><span class="keyword1">CONST</span> call <span class="free">init</span> <span class="free">p</span> <span class="free">restore</span> <span class="free">return</span><span class="main">)</span>"</span>
  <span class="quoted">"<span class="free">r</span> <span class="keyword1">SCALL</span> <span class="free">p</span> <span class="free">n</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="keyword1">CONST</span> AnnCom <span class="main">(</span><span class="keyword1">CONST</span> AnnCall <span class="free">r</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">CONST</span> Call <span class="free">p</span><span class="main">)</span>"</span>

  <span class="quoted">"<span class="free">r</span> <span class="keyword1">THROW</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> AnnCom <span class="main">(</span><span class="keyword1">CONST</span> AnnExpr <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">CONST</span> Throw<span class="main">)</span>"</span>
  <span class="quoted">"<span class="keyword1">THROW</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> FAKE_ANN <span class="keyword1">THROW</span>"</span>
  <span class="quoted">"<span class="keyword1">TRY</span> <span class="free">c1</span> <span class="keyword1">CATCH</span> <span class="free">c2</span> <span class="keyword1">END</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="keyword1">CONST</span> AnnCom <span class="main">(</span><span class="keyword1">CONST</span> AnnComp <span class="main">(</span><span class="free">c1</span><span class="main"><span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">c2</span><span class="main"><span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span><span class="main">)</span>
                                         <span class="main">(</span><span class="keyword1">CONST</span> Catch <span class="main">(</span><span class="free">c1</span><span class="main"><span class="hidden">⇩</span><sub>!</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">c2</span><span class="main"><span class="hidden">⇩</span><sub>!</sub></span><span class="main">)</span><span class="main">)</span>"</span>

  <span class="quoted">"<span class="free">r</span> <span class="keyword1">SKIP</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> AnnCom <span class="main">(</span><span class="keyword1">CONST</span> AnnExpr <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">CONST</span> Skip<span class="main">)</span>"</span>
  <span class="quoted">"<span class="keyword1">SKIP</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> FAKE_ANN <span class="keyword1">SKIP</span>"</span>

<span class="keyword1"><span class="command">nonterminal</span></span> prgs

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_PAR"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"prgs <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>              <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">COBEGIN</span><span class="keyword3">//</span>_<span class="keyword3">//</span><span class="keyword1">COEND</span><span class="keyword3">)</span>"</span> <span class="main">[</span>57<span class="main">]</span> 56<span class="main">)</span>
  <span class="quoted">"_prg"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">⇒</span> prgs"</span></span>        <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span>  _<span class="keyword3">//</span>_<span class="keyword1">,</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>60<span class="main">,</span> 90<span class="main">,</span> 90<span class="main">]</span> 57<span class="main">)</span>
  <span class="quoted">"_prgs"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> prgs<span class="main">]</span> <span class="main">⇒</span> prgs"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span>  _<span class="keyword3">//</span>_<span class="keyword1">,</span><span class="keyword3">/ </span>_<span class="keyword3">)</span><span class="keyword3">//</span><span class="keyword1">∥</span><span class="keyword3">//</span>_"</span> <span class="main">[</span>60<span class="main">,</span>90<span class="main">,</span>90<span class="main">,</span>57<span class="main">]</span> 57<span class="main">)</span>

  <span class="quoted">"_prg_scheme"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">⇒</span> prgs"</span></span>  
                  <span class="main">(</span><span class="quoted">"  <span class="keyword3">(2</span><span class="keyword1">SCHEME</span> <span class="keyword1">[</span>_ <span class="keyword1">≤</span> _ <span class="keyword1">&lt;</span> _<span class="keyword1">]</span><span class="keyword3">//</span>_<span class="keyword3">//</span>_<span class="keyword1">,</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span>0<span class="main">,</span>0<span class="main">,</span>60<span class="main">,</span> 90<span class="main">,</span>90<span class="main">]</span> 57<span class="main">)</span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"_prg <span class="free">c</span> <span class="free">q</span> <span class="free">a</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main"><span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span><span class="main">,</span> <span class="free">q</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="free">c</span><span class="main"><span class="hidden">⇩</span><sub>!</sub></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span>
  <span class="quoted">"_prgs <span class="free">c</span> <span class="free">q</span> <span class="free">a</span> <span class="free">ps</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main"><span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span><span class="main">,</span> <span class="free">q</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">ps</span><span class="main"><span class="hidden">⇩</span><sub>,</sub></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">c</span><span class="main"><span class="hidden">⇩</span><sub>!</sub></span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">ps</span><span class="main"><span class="hidden">⇩</span><sub>.</sub></span><span class="main">)</span><span class="main">)</span>"</span>
  <span class="quoted">"_PAR <span class="free">ps</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="keyword1">CONST</span> AnnCom <span class="main">(</span><span class="keyword1">CONST</span> AnnPar <span class="main">(</span><span class="free">ps</span><span class="main"><span class="hidden">⇩</span><sub>,</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">CONST</span> Parallel <span class="main">(</span><span class="free">ps</span><span class="main"><span class="hidden">⇩</span><sub>.</sub></span><span class="main">)</span><span class="main">)</span>"</span>

  <span class="quoted">"_prg_scheme <span class="free">j</span> <span class="free">i</span> <span class="free">k</span> <span class="free">c</span> <span class="free">q</span> <span class="free">a</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="main">(</span><span class="keyword1">CONST</span> map <span class="main">(</span><span class="main">λ</span><span class="free">i</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main"><span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span><span class="main">,</span> <span class="free">q</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">,</span> <span class="keyword1">CONST</span> map <span class="main">(</span><span class="main">λ</span><span class="free">i</span><span class="main">.</span> <span class="main">(</span><span class="free">c</span><span class="main"><span class="hidden">⇩</span><sub>!</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">)</span>"</span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_oghoare"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> body <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> proc_assns <span class="main">⇒</span> <span class="tfree">'f</span> set
              <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> bool"</span></span>  
    <span class="main">(</span><span class="quoted">"<span class="keyword3">(4</span>_<span class="keyword3">)</span><span class="keyword1">,</span><span class="keyword3">/ </span><span class="keyword3">(4</span>_<span class="keyword3">)</span><span class="keyword3">/ </span><span class="keyword3">(</span><span class="keyword1">|⊢⇘'/</span>_<span class="keyword1">⇙</span> <span class="keyword3">(</span>_<span class="keyword3">//</span>_<span class="keyword1">,</span> _<span class="keyword3">)</span><span class="keyword3">)</span>"</span> <span class="main">[</span>60<span class="main">,</span>60<span class="main">,</span>60<span class="main">,</span>20<span class="main">,</span>1000<span class="main">,</span>1000<span class="main">]</span>60<span class="main">)</span>

  <span class="quoted">"_oghoare_seq"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> body <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> proc_assns <span class="main">⇒</span> <span class="tfree">'f</span> set
              <span class="main">⇒</span><span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> ann_com <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> <span class="tfree">'s</span> assn <span class="main">⇒</span> bool"</span></span>  
    <span class="main">(</span><span class="quoted">"<span class="keyword3">(4</span>_<span class="keyword3">)</span><span class="keyword1">,</span><span class="keyword3">/ </span><span class="keyword3">(4</span>_<span class="keyword3">)</span><span class="keyword3">/ </span><span class="keyword3">(</span><span class="keyword1">|⊩⇘'/</span>_<span class="keyword1">⇙</span> <span class="keyword3">(</span>_<span class="keyword3">//</span>_<span class="keyword3">//</span>_<span class="keyword1">,</span> _<span class="keyword3">)</span><span class="keyword3">)</span>"</span> <span class="main">[</span>60<span class="main">,</span>60<span class="main">,</span>60<span class="main">,</span>1000<span class="main">,</span>20<span class="main">,</span>1000<span class="main">,</span>1000<span class="main">]</span>60<span class="main">)</span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"_oghoare <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="free">c</span> <span class="free">Q</span> <span class="free">A</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">c</span><span class="main"><span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">c</span><span class="main"><span class="hidden">⇩</span><sub>!</sub></span><span class="main">)</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span>"</span>
  <span class="quoted">"_oghoare_seq <span class="free">Γ</span> <span class="free">Θ</span> <span class="free">F</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span> <span class="free">A</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> ⊩<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="free">P</span> <span class="main">(</span><span class="free">c</span><span class="main"><span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">c</span><span class="main"><span class="hidden">⇩</span><sub>!</sub></span><span class="main">)</span> <span class="free">Q</span><span class="main">,</span> <span class="free">A</span>"</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">syntax_debug</span> <span class="main">=</span> false›</span>
<span class="keyword1"><span class="command">print_translation</span></span> <span class="quoted">‹ <span class="keyword2"><span class="keyword">let</span></span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">quote_tr'</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">t</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
        Term.list_comb <span class="main">(</span><span class="entity">f</span> $ Syntax_Trans.quote_tr' <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_antiquote"<span class="antiquote">}</span></span> <span class="entity">t</span><span class="main">,</span> <span class="entity">ts</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">quote_tr'</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Match<span class="main">;</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">annquote_tr'</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">r</span> :: <span class="entity">t</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
        Term.list_comb <span class="main">(</span><span class="entity">f</span> $ <span class="entity">r</span> $ Syntax_Trans.quote_tr' <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_antiquote"<span class="antiquote">}</span></span> <span class="entity">t</span><span class="main">,</span> <span class="entity">ts</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">annquote_tr'</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Match<span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">assert_tr'</span> <span class="main">=</span> <span class="entity">quote_tr'</span> <span class="main">(</span>Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_Assert"<span class="antiquote">}</span></span><span class="main">)</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">annbexp_tr'</span> <span class="entity">name</span> <span class="main">(</span><span class="entity">r</span> :: <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Collect<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">t</span><span class="main">)</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
        <span class="entity">annquote_tr'</span> <span class="main">(</span>Syntax.const <span class="entity">name</span><span class="main">)</span> <span class="main">(</span><span class="entity">r</span> :: <span class="entity">t</span> :: <span class="entity">ts</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">annbexp_tr'</span> <span class="entity">name</span> <span class="main">(</span><span class="entity">r</span> :: Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> UNIV<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
        <span class="entity">annquote_tr'</span> <span class="main">(</span>Syntax.const <span class="entity">name</span><span class="main">)</span>
                     <span class="main">(</span><span class="entity">r</span> :: Abs <span class="main">(</span><span class="inner_quoted">"s"</span><span class="main">,</span> dummyT<span class="main">,</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> True<span class="antiquote">}</span></span><span class="main">,</span> dummyT<span class="main">)</span><span class="main">)</span> :: <span class="entity">ts</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">annbexp_tr'</span> <span class="entity">name</span> <span class="main">(</span><span class="entity">r</span> :: Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Set.empty<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
        <span class="entity">annquote_tr'</span> <span class="main">(</span>Syntax.const <span class="entity">name</span><span class="main">)</span>
                     <span class="main">(</span><span class="entity">r</span> :: Abs <span class="main">(</span><span class="inner_quoted">"s"</span><span class="main">,</span> dummyT<span class="main">,</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> False<span class="antiquote">}</span></span><span class="main">,</span> dummyT<span class="main">)</span><span class="main">)</span> :: <span class="entity">ts</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">annbexp_tr'</span> <span class="entity">name</span> <span class="entity">x</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">syntax_debug</span> <span class="keyword2"><span class="keyword">then</span></span> writeln <span class="main">(</span><span class="inner_quoted">"annbexp_tr'\n "</span> ^ <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">make_string</span><span class="antiquote">}</span></span></span></span> <span class="entity">x</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword3"><span class="keyword">raise</span></span> Match <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">annassign_tr'</span> <span class="main">(</span><span class="entity">r</span> :: Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">f</span> $ <span class="entity">k</span> $ Bound <span class="inner_numeral">0</span><span class="main">)</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
        <span class="entity">quote_tr'</span> <span class="main">(</span>Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_AnnAssign"<span class="antiquote">}</span></span> $ <span class="entity">r</span> $ Syntax_Trans.update_name_tr' <span class="entity">f</span><span class="main">)</span>
          <span class="main">(</span>Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span> dummyT<span class="main">,</span> Syntax_Trans.const_abs_tr' <span class="entity">k</span><span class="main">)</span> :: <span class="entity">ts</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">annassign_tr'</span> <span class="entity">r</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> writeln <span class="main">(</span><span class="inner_quoted">"annassign_tr'\n "</span> ^ <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">make_string</span><span class="antiquote">}</span></span></span></span> <span class="entity">r</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
     <span class="keyword3"><span class="keyword">raise</span></span> Match <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_list</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Nil<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
    <span class="main">|</span> <span class="entity">dest_list</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Cons<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">x</span> $ <span class="entity">xs</span><span class="main">)</span> <span class="main">=</span> <span class="entity">x</span> :: <span class="entity">dest_list</span> <span class="entity">xs</span>
    <span class="main">|</span> <span class="entity">dest_list</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Match<span class="main">;</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">guards_lst_tr'</span> <span class="main">[</span><span class="entity">fg</span><span class="main">]</span> <span class="main">=</span> <span class="entity">fg</span>
    <span class="main">|</span> <span class="entity">guards_lst_tr'</span> <span class="main">(</span><span class="entity">t</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
        Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_grds"<span class="antiquote">}</span></span> $ <span class="entity">t</span> $ <span class="entity">guards_lst_tr'</span> <span class="entity">ts</span>
    <span class="main">|</span> <span class="entity">guards_lst_tr'</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Match<span class="main">;</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">new_AnnCom</span> <span class="entity">r</span> <span class="entity">c</span> <span class="main">=</span>
    <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> AnnCom<span class="antiquote">}</span></span><span class="main">,</span> dummyT<span class="main">)</span> $ <span class="entity">r</span> $ <span class="entity">c</span><span class="main">)</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">new_Pair</span> <span class="entity">a</span> <span class="entity">b</span> <span class="main">=</span>
    <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Pair<span class="antiquote">}</span></span><span class="main">,</span> dummyT<span class="main">)</span> $ <span class="entity">a</span> $ <span class="entity">b</span><span class="main">)</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_prod</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Pair<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">a</span> $ <span class="entity">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">b</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">dest_prod</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Match<span class="main">;</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prgs_tr'</span> <span class="entity">f</span> <span class="entity">pqa</span> <span class="entity">c</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">qa</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_prod</span> <span class="entity">pqa</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">q</span><span class="main">,</span> <span class="entity">a</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_prod</span> <span class="entity">qa</span>
        <span class="keyword2"><span class="keyword">in</span></span> <span class="main">[</span><span class="entity">new_AnnCom</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">p</span><span class="main">)</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">c</span><span class="main">)</span><span class="main">,</span> <span class="entity">f</span> <span class="entity">q</span><span class="main">,</span> <span class="entity">f</span> <span class="entity">a</span><span class="main">]</span> <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prgs_lst_tr'</span> <span class="main">[</span><span class="entity">p</span><span class="main">]</span> <span class="main">[</span><span class="entity">c</span><span class="main">]</span> <span class="main">=</span>
        list_comb <span class="main">(</span>Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_prg"<span class="antiquote">}</span></span><span class="main">,</span>
                   <span class="entity">prgs_tr'</span> I <span class="entity">p</span> <span class="entity">c</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">prgs_lst_tr'</span> <span class="main">(</span><span class="entity">p</span> :: <span class="entity">ps</span><span class="main">)</span> <span class="main">(</span><span class="entity">c</span> :: <span class="entity">cs</span><span class="main">)</span> <span class="main">=</span>
        list_comb <span class="main">(</span>Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_prgs"<span class="antiquote">}</span></span><span class="main">,</span>
                   <span class="entity">prgs_tr'</span> I <span class="entity">p</span> <span class="entity">c</span><span class="main">)</span> $ <span class="entity">prgs_lst_tr'</span> <span class="entity">ps</span> <span class="entity">cs</span>
    <span class="main">|</span> <span class="entity">prgs_lst_tr'</span> <span class="main">_</span> <span class="main">_</span><span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Match<span class="main">;</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">AnnCom_tr</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> AnnPar<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $
                 <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> map<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $
                  Abs <span class="main">(</span><span class="entity">i</span><span class="main">,</span> <span class="entity">T</span><span class="main">,</span> <span class="entity">p</span><span class="main">)</span> $ <span class="main">(</span>Const <span class="main">_</span> $ <span class="entity">j</span> $ <span class="entity">k</span><span class="main">)</span><span class="main">)</span> ::
                 Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Parallel<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $
                 <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> map<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $
                  Abs <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">c</span><span class="main">)</span> $ <span class="main">_</span><span class="main">)</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">syntax_debug</span> <span class="keyword2"><span class="keyword">then</span></span> writeln <span class="inner_quoted">"prg_scheme"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_abs</span> <span class="entity">body</span> <span class="main">=</span> snd <span class="main">(</span>Term.dest_abs <span class="main">(</span><span class="entity">i</span><span class="main">,</span> <span class="entity">T</span><span class="main">,</span> <span class="entity">body</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
          Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_PAR"<span class="antiquote">}</span></span> $
            list_comb <span class="main">(</span>Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_prg_scheme"<span class="antiquote">}</span></span> $
              <span class="entity">j</span> $ Free <span class="main">(</span><span class="entity">i</span><span class="main">,</span> <span class="entity">T</span><span class="main">)</span> $ <span class="entity">k</span><span class="main">,</span> <span class="entity">prgs_tr'</span> <span class="entity">dest_abs</span> <span class="entity">p</span> <span class="entity">c</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">AnnCom_tr</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> AnnPar<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">ps</span> ::
               Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Parallel<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">cs</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">syntax_debug</span> <span class="keyword2"><span class="keyword">then</span></span> writeln <span class="inner_quoted">"Par"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">ps'</span><span class="main">,</span> <span class="entity">cs'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">dest_list</span> <span class="entity">ps</span><span class="main">,</span> <span class="entity">dest_list</span> <span class="entity">cs</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">in</span></span> Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_PAR"<span class="antiquote">}</span></span> $
             <span class="entity">prgs_lst_tr'</span> <span class="entity">ps'</span> <span class="entity">cs'</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">AnnCom_tr</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> AnnExpr<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">r</span> ::
               Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Basic<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">f</span> $ <span class="entity">k</span> $ Bound <span class="inner_numeral">0</span><span class="main">)</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">syntax_debug</span> <span class="keyword2"><span class="keyword">then</span></span> writeln <span class="inner_quoted">"Basic'"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">quote_tr'</span> <span class="main">(</span>Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_AnnAssign"<span class="antiquote">}</span></span> $ <span class="entity">r</span> $ Syntax_Trans.update_name_tr' <span class="entity">f</span><span class="main">)</span>
          <span class="main">(</span>Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span> dummyT<span class="main">,</span> Syntax_Trans.const_abs_tr' <span class="entity">k</span><span class="main">)</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">AnnCom_tr</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> AnnExpr<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">r</span> ::
               Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Basic<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">(</span><span class="entity">f</span> $ <span class="entity">k</span><span class="main">)</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">syntax_debug</span> <span class="keyword2"><span class="keyword">then</span></span> writeln <span class="inner_quoted">"Basic"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">quote_tr'</span> <span class="main">(</span>Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_AnnAssign"<span class="antiquote">}</span></span> $ <span class="entity">r</span> $ Syntax_Trans.update_name_tr' <span class="entity">f</span><span class="main">)</span>
          <span class="main">(</span><span class="entity">k</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">AnnCom_tr</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> AnnExpr<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">r</span> ::
               Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Spec<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">(</span><span class="main">_</span> $ <span class="main">_</span> $ Abs <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span> $ <span class="main">_</span> $ <span class="main">(</span><span class="main">(</span><span class="main">_</span> $ <span class="entity">f</span><span class="main">)</span> $ <span class="entity">S</span> $ <span class="main">_</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">syntax_debug</span> <span class="keyword2"><span class="keyword">then</span></span> writeln <span class="main">(</span><span class="inner_quoted">"Spec"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
        <span class="main">(</span>Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_AnnSpec"<span class="antiquote">}</span></span> $ <span class="entity">r</span> $
           Syntax_Trans.update_name_tr' <span class="entity">f</span> $
           Syntax_Trans.antiquote_tr' <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_antiquote"<span class="antiquote">}</span></span> <span class="entity">S</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">AnnCom_tr</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> AnnComp<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">r</span> $ <span class="entity">r'</span> ::
               Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Seq<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">c</span> $ <span class="entity">c'</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">syntax_debug</span> <span class="keyword2"><span class="keyword">then</span></span> writeln <span class="inner_quoted">"Seq"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span> Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_AnnSeq"<span class="antiquote">}</span></span> $
                <span class="entity">new_AnnCom</span> <span class="entity">r</span> <span class="entity">c</span> $ <span class="entity">new_AnnCom</span> <span class="entity">r'</span> <span class="entity">c'</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">AnnCom_tr</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> AnnRec<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">r</span> $ <span class="entity">p</span> ::
               Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Await<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">b</span> $ <span class="entity">c</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
       <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">syntax_debug</span> <span class="keyword2"><span class="keyword">then</span></span> writeln <span class="inner_quoted">"Await"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">annbexp_tr'</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_AnnAwait"<span class="antiquote">}</span></span>
                  <span class="main">(</span><span class="entity">r</span> :: <span class="entity">b</span> :: <span class="entity">new_AnnCom</span> <span class="entity">p</span> <span class="entity">c</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">AnnCom_tr</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> AnnWhile<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">r</span> $ <span class="entity">i</span> $ <span class="entity">p</span> ::
               Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> While<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">b</span> $ <span class="entity">c</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
       <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">syntax_debug</span> <span class="keyword2"><span class="keyword">then</span></span> writeln <span class="inner_quoted">"While"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">annbexp_tr'</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_AnnWhile"<span class="antiquote">}</span></span>
                  <span class="main">(</span><span class="entity">r</span> :: <span class="entity">b</span> :: <span class="entity">i</span> :: <span class="entity">new_AnnCom</span> <span class="entity">p</span> <span class="entity">c</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">AnnCom_tr</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> AnnBin<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">r</span> $ <span class="entity">p</span> $ <span class="entity">p'</span> ::
               Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Cond<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">b</span> $ <span class="entity">c</span> $ <span class="entity">c'</span>:: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
       <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">syntax_debug</span> <span class="keyword2"><span class="keyword">then</span></span> writeln <span class="inner_quoted">"Cond"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">annbexp_tr'</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_AnnCond1"<span class="antiquote">}</span></span>
                  <span class="main">(</span><span class="entity">r</span> :: <span class="entity">b</span> :: <span class="entity">new_AnnCom</span> <span class="entity">p</span> <span class="entity">c</span> :: <span class="entity">new_AnnCom</span> <span class="entity">p'</span> <span class="entity">c'</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">AnnCom_tr</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> ann_guards<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">r</span> $ <span class="entity">gs</span> $ <span class="entity">p</span> ::
               Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> guards<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> $ <span class="entity">c</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
       <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">syntax_debug</span> <span class="keyword2"><span class="keyword">then</span></span> writeln <span class="inner_quoted">"guards"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span> Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_guards"<span class="antiquote">}</span></span> $ <span class="entity">r</span> $
                <span class="entity">guards_lst_tr'</span> <span class="main">(</span><span class="entity">dest_list</span> <span class="entity">gs</span><span class="main">)</span> $ <span class="entity">new_AnnCom</span> <span class="entity">p</span> <span class="entity">c</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">AnnCom_tr</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> AnnRec<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">r</span> $ <span class="entity">p</span> ::
               Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Guard<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">f</span> $ <span class="entity">g</span> $ <span class="entity">c</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
       <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">syntax_debug</span> <span class="keyword2"><span class="keyword">then</span></span> writeln <span class="inner_quoted">"guards'"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span> Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_guards"<span class="antiquote">}</span></span> $ <span class="entity">r</span> $
                <span class="entity">new_Pair</span> <span class="entity">f</span> <span class="entity">g</span> $ <span class="entity">new_AnnCom</span> <span class="entity">p</span> <span class="entity">c</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">AnnCom_tr</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> AnnCall<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">r</span> $ <span class="entity">n</span> ::
               Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Call<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">p</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
       <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">syntax_debug</span> <span class="keyword2"><span class="keyword">then</span></span> writeln <span class="inner_quoted">"SCall"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span> Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_AnnSCall"<span class="antiquote">}</span></span> $ <span class="entity">r</span> $ <span class="entity">p</span> $ <span class="entity">n</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">AnnCom_tr</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> ann_call<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $
                   <span class="entity">ai</span> $ <span class="entity">r</span> $ <span class="entity">n</span> $ <span class="entity">arestoreq</span> $ <span class="entity">areturn</span> $ <span class="entity">arestorea</span> $ <span class="entity">A</span> ::
               Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> call<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $
                   <span class="entity">init</span> $ <span class="entity">p</span> $ <span class="entity">restore</span> $ <span class="entity">return</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
       <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">syntax_debug</span> <span class="keyword2"><span class="keyword">then</span></span> writeln <span class="inner_quoted">"CallX"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span> Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_AnnCallX"<span class="antiquote">}</span></span> $ <span class="entity">ai</span> $ <span class="entity">init</span> $
                  <span class="entity">r</span> $ <span class="entity">p</span> $ <span class="entity">n</span> $ <span class="entity">restore</span> $ <span class="entity">return</span> $ <span class="entity">arestoreq</span> $ <span class="entity">areturn</span> $
                  <span class="entity">arestorea</span> $ <span class="entity">A</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">AnnCom_tr</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> AnnComp<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">r</span> $ <span class="entity">r'</span> ::
               Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Catch<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">c</span> $ <span class="entity">c'</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">syntax_debug</span> <span class="keyword2"><span class="keyword">then</span></span> writeln <span class="inner_quoted">"Catch"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span> Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_Try_Catch"<span class="antiquote">}</span></span> $
                <span class="entity">new_AnnCom</span> <span class="entity">r</span> <span class="entity">c</span> $ <span class="entity">new_AnnCom</span> <span class="entity">r'</span> <span class="entity">c'</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">AnnCom_tr</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> ann<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">p</span> ::
               Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> com<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">p'</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
       <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">syntax_debug</span> <span class="keyword2"><span class="keyword">then</span></span> writeln <span class="inner_quoted">"ann_com"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p</span> <span class="main">=</span> <span class="entity">p'</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">p</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Match <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">AnnCom_tr</span> <span class="entity">x</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">syntax_debug</span> <span class="keyword2"><span class="keyword">then</span></span> writeln <span class="main">(</span><span class="inner_quoted">"AnnCom_tr\n "</span> ^ <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">make_string</span><span class="antiquote">}</span></span></span></span> <span class="entity">x</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Match <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">oghoare_tr</span> <span class="main">(</span><span class="entity">gamma</span> :: <span class="entity">sigma</span> :: <span class="entity">F</span> :: <span class="entity">r</span> :: <span class="entity">c</span> :: <span class="entity">Q</span> :: <span class="entity">A</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">syntax_debug</span> <span class="keyword2"><span class="keyword">then</span></span> writeln <span class="inner_quoted">"oghoare"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span> Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_oghoare"<span class="antiquote">}</span></span> $
               <span class="entity">gamma</span> $ <span class="entity">sigma</span> $ <span class="entity">F</span> $ <span class="entity">new_AnnCom</span> <span class="entity">r</span> <span class="entity">c</span> $ <span class="entity">Q</span> $ <span class="entity">A</span>
          <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> <span class="entity">oghoare_tr</span> <span class="entity">x</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> writeln <span class="main">(</span><span class="inner_quoted">"oghoare_tr\n "</span> ^ <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">make_string</span><span class="antiquote">}</span></span></span></span> <span class="entity">x</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Match <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">oghoare_seq_tr</span> <span class="main">(</span><span class="entity">gamma</span> :: <span class="entity">sigma</span> :: <span class="entity">F</span> :: <span class="entity">P</span> :: <span class="entity">r</span> :: <span class="entity">c</span> :: <span class="entity">Q</span> :: <span class="entity">A</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">syntax_debug</span> <span class="keyword2"><span class="keyword">then</span></span> writeln <span class="inner_quoted">"oghoare_seq"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span> Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_oghoare_seq"<span class="antiquote">}</span></span> $
               <span class="entity">gamma</span> $ <span class="entity">sigma</span> $ <span class="entity">F</span> $ <span class="entity">P</span> $ <span class="entity">new_AnnCom</span> <span class="entity">r</span> <span class="entity">c</span> $ <span class="entity">Q</span> $ <span class="entity">A</span>
          <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> <span class="entity">oghoare_seq_tr</span> <span class="entity">x</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> writeln <span class="main">(</span><span class="inner_quoted">"oghoare_seq_tr\n "</span> ^ <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">make_string</span><span class="antiquote">}</span></span></span></span> <span class="entity">x</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Match <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

  <span class="keyword2"><span class="keyword">in</span></span>
   <span class="main">[</span><span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Collect<span class="antiquote">}</span></span><span class="main">,</span> K <span class="entity">assert_tr'</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> AnnCom<span class="antiquote">}</span></span><span class="main">,</span> K <span class="entity">AnnCom_tr</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> oghoare<span class="antiquote">}</span></span><span class="main">,</span> K <span class="entity">oghoare_tr</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> oghoare_seq<span class="antiquote">}</span></span><span class="main">,</span> K <span class="entity">oghoare_seq_tr</span><span class="main">)</span><span class="main">]</span>

  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Examples">
<div class="head">
<h1>Theory Examples</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright 2016, Data61, CSIRO
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(DATA61_BSD)
 *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Examples›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Examples
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="OG_Syntax.html">../OG_Syntax</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">record</span></span> test <span class="main">=</span>
  x <span class="main">::</span> <span class="quoted">nat</span>
  y <span class="main">::</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is a sequence of two commands, the first being an assign
  protected by two guards. The guards use booleans as their faults.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">test_guard</span> <span class="main">≡</span> <span class="main">⦃</span>True<span class="main">⦄</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">⦃</span><span class="main">´</span>x<span class="main">=</span><span class="main">0</span><span class="main">⦄</span><span class="main">)</span><span class="main">,</span>
                       <span class="main">(</span>False<span class="main">,</span> <span class="main">⦃</span><span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span><span class="main">=</span><span class="main">0</span><span class="main">⦄</span><span class="main">)</span> <span class="main">⟼</span> <span class="main">⦃</span>True<span class="main">⦄</span> <span class="main">´</span>y <span class="main">:=</span> <span class="main">0</span><span class="main">;;</span>
                      <span class="main">⦃</span>True<span class="main">⦄</span> <span class="main">´</span>x <span class="main">:=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> |⊢<span class="hidden">⇘</span><sub>/<span class="main">{</span>True<span class="main">}</span></sub><span class="hidden">⇙</span>
    <span class="keyword1">COBEGIN</span> test_guard <span class="main">⦃</span>True<span class="main">⦄</span><span class="main">,</span><span class="main">⦃</span>True<span class="main">⦄</span>
         <span class="main">∥</span> <span class="main">⦃</span>True<span class="main">⦄</span> <span class="main">´</span>y<span class="main">:=</span><span class="main">0</span> <span class="main">⦃</span>True<span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>True<span class="main">⦄</span>
    <span class="keyword1">COEND</span> <span class="main">⦃</span>True<span class="main">⦄</span><span class="main">,</span><span class="main">⦃</span>True<span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> test_guard_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">oghoare</span> <span class="comment1">(*11 subgoals*)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">test_try_throw</span> <span class="main">≡</span> <span class="keyword1">TRY</span> <span class="main">⦃</span>True<span class="main">⦄</span> <span class="main">´</span>y <span class="main">:=</span> <span class="main">0</span><span class="main">;;</span>
                      <span class="main">⦃</span>True<span class="main">⦄</span> <span class="keyword1">THROW</span>
                     <span class="keyword1">CATCH</span> <span class="main">⦃</span>True<span class="main">⦄</span> <span class="main">´</span>x <span class="main">:=</span> <span class="main">0</span>
                     <span class="keyword1">END</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Parameterized Examples›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Set Elements of an Array to Zero›</span></span>

<span class="keyword1"><span class="command">record</span></span> Example1 <span class="main">=</span>
  ex1_a <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Example1<span class="main">:</span> 
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span>|⊩<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span><span class="main">⦃</span>True<span class="main">⦄</span>
   <span class="keyword1">COBEGIN</span> <span class="keyword1">SCHEME</span> <span class="main">[</span><span class="main">0</span><span class="main">≤</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free"><span class="free">n</span></span><span class="main">]</span> <span class="main">⦃</span>True<span class="main">⦄</span> <span class="main">´</span>ex1_a<span class="main">:=</span><span class="main">´</span>ex1_a <span class="main">(</span><span class="bound">i</span><span class="main">:=</span><span class="main">0</span><span class="main">)</span> <span class="main">⦃</span><span class="main">´</span>ex1_a <span class="bound">i</span><span class="main">=</span><span class="main">0</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>False<span class="main">⦄</span> <span class="keyword1">COEND</span> 
  <span class="main">⦃</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="main">´</span>ex1_a <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">⦄</span><span class="main">,</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">oghoare</span> <span class="comment1">(* 7 subgoals *)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Same example but with a Call.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">Example1'a</span> <span class="main">≡</span> <span class="main">⦃</span>True<span class="main">⦄</span> <span class="main">´</span>ex1_a<span class="main">:=</span><span class="main">´</span>ex1_a <span class="main">(</span><span class="main">0</span><span class="main">:=</span><span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">Example1'b</span> <span class="main">≡</span> <span class="main">⦃</span>True<span class="main">⦄</span> <span class="main">´</span>ex1_a<span class="main">:=</span><span class="main">´</span>ex1_a <span class="main">(</span><span class="main">1</span><span class="main">:=</span><span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Example1'</span> <span class="main">≡</span>
  <span class="keyword1">COBEGIN</span> Example1'a <span class="main">⦃</span><span class="main">´</span>ex1_a <span class="main">0</span><span class="main">=</span><span class="main">0</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>False<span class="main">⦄</span>
         <span class="main">∥</span> 
         <span class="main">⦃</span>True<span class="main">⦄</span> <span class="keyword1">SCALL</span> <span class="main">0</span> <span class="main">0</span>
         <span class="main">⦃</span><span class="main">´</span>ex1_a <span class="main">1</span><span class="main">=</span><span class="main">0</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>False<span class="main">⦄</span>
  <span class="keyword1">COEND</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ'</span> <span class="main">=</span> Map.empty<span class="main">(</span><span class="main">0</span> <span class="main">↦</span> com Example1'b<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ'</span> <span class="main">=</span> Map.empty<span class="main">(</span><span class="main">0</span> <span class="main">::</span> nat <span class="main">↦</span> <span class="main">[</span>ann Example1'b<span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Example1_proc_simp<span class="main">[</span><span class="operator">unfolded</span> Example1'b_def <span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic">oghoare_simps</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"Γ' <span class="main">0</span> <span class="main">=</span> Some <span class="main">(</span>com <span class="main">(</span>Example1'b<span class="main">)</span><span class="main">)</span>"</span></span>
 <span class="quoted"><span class="quoted">"Θ' <span class="main">0</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">[</span> ann<span class="main">(</span>Example1'b<span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="main">[</span> ann<span class="main">(</span>Example1'b<span class="main">)</span><span class="main">]</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> ann<span class="main">(</span>Example1'b<span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Γ'_def Θ'_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Example1'<span class="main">:</span>
<span class="keyword2"><span class="keyword">notes</span></span> Example1_proc_simp<span class="main">[</span><span class="operator">proc_simp</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">shows</span></span>
 <span class="quoted"><span class="quoted">"Γ'<span class="main">,</span> Θ' |⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> Example1' <span class="main">⦃</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">.</span> <span class="main">´</span>ex1_a <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>False<span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Example1'_def 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">unfolding</span></span> Example1'a_def Example1'b_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">oghoare</span> <span class="comment1">(*12 subgoals*)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command">using</span></span> less_2_cases <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE <span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> routine <span class="main">=</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Same example but with a Call.›</span></span>
<span class="keyword1"><span class="command">record</span></span> Example2 <span class="main">=</span>
  ex2_n <span class="main">::</span> <span class="quoted"><span class="quoted">"routine <span class="main">⇒</span> nat"</span></span>
  ex2_a <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> string"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">Example2'n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"routine <span class="main">⇒</span> <span class="main">(</span>Example2<span class="main">,</span> string <span class="main">×</span> nat<span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ann_com"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Example2'n</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">⦃</span><span class="main">´</span>ex2_n <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⦄</span> <span class="main">´</span>ex2_a<span class="main">:=</span><span class="main">´</span>ex2_a<span class="main">(</span><span class="main">(</span><span class="main">´</span>ex2_n <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">:=</span><span class="inner_quoted">''''</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Example2'n_map_of_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span>
    map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="free">g</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span>
       <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">g</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> map_of_is_SomeI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_map o_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> inj_onI prod.inject<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ''</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="inner_quoted">''f''</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> com <span class="main">(</span>Example2'n <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ''</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="inner_quoted">''f''</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span>ann <span class="main">(</span>Example2'n <span class="bound">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span>  Example2'n_proc_simp<span class="main">[</span><span class="operator">unfolded</span> Example2'n_def <span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic">oghoare_simps</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">⟹</span> Γ'' <span class="free">n</span> <span class="main">(</span><span class="inner_quoted">''f''</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span> com<span class="main">(</span>Example2'n <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">⟹</span> Θ'' <span class="free">n</span> <span class="main">(</span><span class="inner_quoted">''f''</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">[</span> ann<span class="main">(</span>Example2'n <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="main">[</span> ann<span class="main">(</span>Example2'n <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> ann<span class="main">(</span>Example2'n <span class="free">i</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Γ''_def Θ''_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> Example2'n_proc_simp<span class="main">[</span><span class="operator">proc_simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">add</span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> Example2<span class="main">:</span>
<span class="keyword2"><span class="keyword">notes</span></span> Example2'n_proc_simp<span class="main">[</span><span class="operator">proc_simp</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">shows</span></span>
 <span class="quoted"><span class="quoted">"Γ'' <span class="free">n</span><span class="main">,</span> Θ'' <span class="free">n</span>
 |⊩<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span><span class="main">⦃</span>True<span class="main">⦄</span>
   <span class="keyword1">COBEGIN</span> <span class="keyword1">SCHEME</span> <span class="main">[</span><span class="main">0</span><span class="main">≤</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free"><span class="free">n</span></span><span class="main">]</span>
     <span class="main">⦃</span>True<span class="main">⦄</span>
       <span class="keyword1">CALLX</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">⦇</span>ex2_n<span class="main">:=</span><span class="main">(</span>ex2_n <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="bound">i</span><span class="main">:=</span><span class="bound">i</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span> <span class="main">⦃</span><span class="main">´</span>ex2_n <span class="bound">i</span> <span class="main">=</span> <span class="bound">i</span><span class="main">⦄</span> <span class="main">(</span><span class="inner_quoted">''f''</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">0</span>
       <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span><span class="main">⦇</span>ex2_n<span class="main">:=</span> <span class="main">(</span>ex2_n <span class="bound">t</span><span class="main">)</span><span class="main">(</span><span class="bound">i</span><span class="main">:=</span><span class="main">(</span>ex2_n <span class="bound">s</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> Skip<span class="main">)</span>
       <span class="main">⦃</span><span class="main">´</span>ex2_a <span class="main">(</span><span class="main">´</span>ex2_n <span class="bound">i</span><span class="main">)</span><span class="main">=</span><span class="inner_quoted">''''</span> <span class="main">∧</span> <span class="main">´</span>ex2_n <span class="bound">i</span> <span class="main">=</span> <span class="bound">i</span><span class="main">⦄</span> <span class="main">⦃</span><span class="main">´</span>ex2_a <span class="bound">i</span><span class="main">=</span><span class="inner_quoted">''''</span><span class="main">⦄</span> <span class="main">⦃</span>False<span class="main">⦄</span>  <span class="main">⦃</span>False<span class="main">⦄</span>
     <span class="main">⦃</span><span class="main">´</span>ex2_a <span class="bound">i</span><span class="main">=</span><span class="inner_quoted">''''</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>False<span class="main">⦄</span>
   <span class="keyword1">COEND</span> 
  <span class="main">⦃</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="main">´</span>ex2_a <span class="bound">i</span> <span class="main">=</span> <span class="inner_quoted">''''</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>False<span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Example2'n_def ann_call_def call_def block_def 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">oghoare</span> <span class="comment1">(* 113 subgoals *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> Example2'n_proc_simp<span class="main">[</span><span class="operator">proc_simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Same example with lists as auxiliary variables.›</span></span>

<span class="keyword1"><span class="command">record</span></span> Example2_list <span class="main">=</span>
  ex2_A <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Example2_list<span class="main">:</span> 
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> |⊩<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span><span class="main">⦃</span><span class="free">n</span> <span class="main">&lt;</span> length <span class="main">´</span>ex2_A<span class="main">⦄</span> 
   <span class="keyword1">COBEGIN</span> 
     <span class="keyword1">SCHEME</span> <span class="main">[</span><span class="main">0</span><span class="main">≤</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free"><span class="free">n</span></span><span class="main">]</span> <span class="main">⦃</span><span class="free">n</span> <span class="main">&lt;</span> length <span class="main">´</span>ex2_A<span class="main">⦄</span> <span class="main">´</span>ex2_A<span class="main">:=</span><span class="main">´</span>ex2_A<span class="main">[</span><span class="bound">i</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span> <span class="main">⦃</span><span class="main">´</span>ex2_A<span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="main">0</span><span class="main">⦄</span><span class="main">,</span><span class="main">⦃</span>False<span class="main">⦄</span> 
   <span class="keyword1">COEND</span> 
    <span class="main">⦃</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="main">´</span>ex2_A<span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">⦄</span><span class="main">,</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">oghoare</span> <span class="comment1">(*7 subgoals*)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> exceptions_example<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> |⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> 
   <span class="keyword1">TRY</span> 
   <span class="main">⦃</span>True <span class="main">⦄</span> <span class="main">´</span>y <span class="main">:=</span> <span class="main">0</span><span class="main">;;</span>
   <span class="main">⦃</span> <span class="main">´</span>y <span class="main">=</span> <span class="main">0</span> <span class="main">⦄</span> <span class="keyword1">THROW</span>
   <span class="keyword1">CATCH</span> 
     <span class="main">⦃</span><span class="main">´</span>y <span class="main">=</span> <span class="main">0</span><span class="main">⦄</span> <span class="main">´</span>x <span class="main">:=</span> <span class="main">´</span>y <span class="main">+</span> <span class="main">1</span>
   <span class="keyword1">END</span>
   <span class="main">⦃</span> <span class="main">´</span>x <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">´</span>y <span class="main">=</span> <span class="main">0</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>False<span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">oghoare</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> guard_example<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> |⊢<span class="hidden">⇘</span><sub>/<span class="main">{</span><span class="numeral">42</span><span class="main">,</span><span class="numeral">66</span><span class="main">}</span></sub><span class="hidden">⇙</span> 
  <span class="main">⦃</span>True<span class="main">⦄</span> <span class="main">(</span><span class="numeral">42</span><span class="main">,</span> <span class="main">⦃</span><span class="main">´</span>x<span class="main">=</span><span class="main">0</span><span class="main">⦄</span><span class="main">)</span><span class="main">,</span>
   <span class="main">(</span><span class="numeral">66</span><span class="main">,</span> <span class="main">⦃</span><span class="main">´</span>y<span class="main">=</span><span class="main">0</span><span class="main">⦄</span><span class="main">)</span> <span class="main">⟼</span> <span class="main">⦃</span><span class="main">´</span>x <span class="main">=</span> <span class="main">0</span><span class="main">⦄</span> 
   <span class="main">´</span>y <span class="main">:=</span> <span class="main">0</span><span class="main">;;</span>
   <span class="main">⦃</span>True<span class="main">⦄</span> <span class="main">´</span>x <span class="main">:=</span> <span class="main">0</span>
  <span class="main">⦃</span> <span class="main">´</span>x <span class="main">=</span> <span class="main">0</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>False<span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">oghoare</span> <span class="comment1">(*6 subgoals*)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Peterson's mutex algorithm I (from Hoare-Parallel) ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Eike Best. "Semantics of Sequential and Parallel Programs", page 217.›</span></span>

<span class="keyword1"><span class="command">record</span></span> Petersons_mutex_1 <span class="main">=</span>
 pr1 <span class="main">::</span> <span class="quoted">nat</span>
 pr2 <span class="main">::</span> <span class="quoted">nat</span>
 in1 <span class="main">::</span> <span class="quoted">bool</span>
 in2 <span class="main">::</span> <span class="quoted">bool</span>
 hold <span class="main">::</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">lemma</span></span> peterson_thread_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> |⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">⦃</span><span class="main">´</span>pr1<span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">´</span>in1<span class="main">⦄</span>  <span class="keyword1">WHILE</span> True <span class="keyword1">INV</span> <span class="main">⦃</span><span class="main">´</span>pr1<span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">´</span>in1<span class="main">⦄</span>
  <span class="keyword1">DO</span>
  <span class="main">⦃</span><span class="main">´</span>pr1<span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">´</span>in1<span class="main">⦄</span> <span class="main">⟨</span><span class="main">´</span>in1<span class="main">:=</span>True<span class="main">,,</span> <span class="main">´</span>pr1<span class="main">:=</span><span class="main">1</span> <span class="main">⟩</span><span class="main">;;</span>
  <span class="main">⦃</span><span class="main">´</span>pr1<span class="main">=</span><span class="main">1</span> <span class="main">∧</span> <span class="main">´</span>in1<span class="main">⦄</span>  <span class="main">⟨</span><span class="main">´</span>hold<span class="main">:=</span><span class="main">1</span><span class="main">,,</span> <span class="main">´</span>pr1<span class="main">:=</span><span class="numeral">2</span> <span class="main">⟩</span><span class="main">;;</span>
  <span class="main">⦃</span><span class="main">´</span>pr1<span class="main">=</span><span class="numeral">2</span> <span class="main">∧</span> <span class="main">´</span>in1 <span class="main">∧</span> <span class="main">(</span><span class="main">´</span>hold<span class="main">=</span><span class="main">1</span> <span class="main">∨</span> <span class="main">´</span>hold<span class="main">=</span><span class="numeral">2</span> <span class="main">∧</span> <span class="main">´</span>pr2<span class="main">=</span><span class="numeral">2</span><span class="main">)</span><span class="main">⦄</span>
  <span class="keyword1">AWAIT</span> <span class="main">(</span><span class="main">¬</span><span class="main">´</span>in2 <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span><span class="main">´</span>hold<span class="main">=</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">THEN</span>
     <span class="main">´</span>pr1<span class="main">:=</span><span class="numeral">3</span>
  <span class="keyword1">END</span><span class="main">;;</span>
  <span class="main">⦃</span><span class="main">´</span>pr1<span class="main">=</span><span class="numeral">3</span> <span class="main">∧</span> <span class="main">´</span>in1 <span class="main">∧</span> <span class="main">(</span><span class="main">´</span>hold<span class="main">=</span><span class="main">1</span> <span class="main">∨</span> <span class="main">´</span>hold<span class="main">=</span><span class="numeral">2</span> <span class="main">∧</span> <span class="main">´</span>pr2<span class="main">=</span><span class="numeral">2</span><span class="main">)</span><span class="main">⦄</span>
   <span class="main">⟨</span><span class="main">´</span>in1<span class="main">:=</span>False<span class="main">,,</span><span class="main">´</span>pr1<span class="main">:=</span><span class="main">0</span><span class="main">⟩</span>
  <span class="keyword1">OD</span> <span class="main">⦃</span><span class="main">´</span>pr1<span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">´</span>in1<span class="main">⦄</span><span class="main">,</span><span class="main">⦃</span>False<span class="main">⦄</span>
"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">oghoare</span> <span class="comment1">(*7 subgoals*)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> peterson_thread_2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> |⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span>  <span class="main">⦃</span><span class="main">´</span>pr2<span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">´</span>in2<span class="main">⦄</span>
  <span class="keyword1">WHILE</span> True <span class="keyword1">INV</span> <span class="main">⦃</span><span class="main">´</span>pr2<span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">´</span>in2<span class="main">⦄</span>
  <span class="keyword1">DO</span>
  <span class="main">⦃</span><span class="main">´</span>pr2<span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">´</span>in2<span class="main">⦄</span> <span class="main">⟨</span><span class="main">´</span>in2<span class="main">:=</span>True<span class="main">,,</span> <span class="main">´</span>pr2<span class="main">:=</span><span class="main">1</span> <span class="main">⟩</span><span class="main">;;</span>
  <span class="main">⦃</span><span class="main">´</span>pr2<span class="main">=</span><span class="main">1</span> <span class="main">∧</span> <span class="main">´</span>in2<span class="main">⦄</span> <span class="main">⟨</span> <span class="main">´</span>hold<span class="main">:=</span><span class="numeral">2</span><span class="main">,,</span> <span class="main">´</span>pr2<span class="main">:=</span><span class="numeral">2</span> <span class="main">⟩</span> <span class="main">;;</span>
  <span class="main">⦃</span><span class="main">´</span>pr2<span class="main">=</span><span class="numeral">2</span> <span class="main">∧</span> <span class="main">´</span>in2 <span class="main">∧</span> <span class="main">(</span><span class="main">´</span>hold<span class="main">=</span><span class="numeral">2</span> <span class="main">∨</span> <span class="main">(</span><span class="main">´</span>hold<span class="main">=</span><span class="main">1</span> <span class="main">∧</span> <span class="main">´</span>pr1<span class="main">=</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">⦄</span>
  <span class="keyword1">AWAIT</span> <span class="main">(</span><span class="main">¬</span><span class="main">´</span>in1 <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span><span class="main">´</span>hold<span class="main">=</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">´</span>pr2<span class="main">:=</span><span class="numeral">3</span> <span class="keyword1">END</span><span class="main">;;</span>
  <span class="main">⦃</span><span class="main">´</span>pr2<span class="main">=</span><span class="numeral">3</span> <span class="main">∧</span> <span class="main">´</span>in2 <span class="main">∧</span> <span class="main">(</span><span class="main">´</span>hold<span class="main">=</span><span class="numeral">2</span> <span class="main">∨</span> <span class="main">(</span><span class="main">´</span>hold<span class="main">=</span><span class="main">1</span> <span class="main">∧</span> <span class="main">´</span>pr1<span class="main">=</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">⦄</span>
    <span class="main">⟨</span><span class="main">´</span>in2<span class="main">:=</span>False<span class="main">,,</span> <span class="main">´</span>pr2<span class="main">:=</span><span class="main">0</span><span class="main">⟩</span>
  <span class="keyword1">OD</span> <span class="main">⦃</span><span class="main">´</span>pr2<span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">´</span>in2<span class="main">⦄</span><span class="main">,</span><span class="main">⦃</span>False<span class="main">⦄</span>
 "</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">oghoare</span> <span class="comment1">(*7 subgoals*)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Petersons_mutex_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Θ</span> |⊩<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">⦃</span><span class="main">´</span>pr1<span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">´</span>in1 <span class="main">∧</span> <span class="main">´</span>pr2<span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">´</span>in2 <span class="main">⦄</span>
  <span class="keyword1">COBEGIN</span>
  <span class="main">⦃</span><span class="main">´</span>pr1<span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">´</span>in1 <span class="main">⦄</span>  <span class="keyword1">WHILE</span> True <span class="keyword1">INV</span> <span class="main">⦃</span><span class="main">´</span>pr1<span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">´</span>in1<span class="main">⦄</span>
  <span class="keyword1">DO</span>
  <span class="main">⦃</span><span class="main">´</span>pr1<span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">´</span>in1<span class="main">⦄</span> <span class="main">⟨</span> <span class="main">´</span>in1<span class="main">:=</span>True<span class="main">,,</span> <span class="main">´</span>pr1<span class="main">:=</span><span class="main">1</span> <span class="main">⟩</span><span class="main">;;</span>
  <span class="main">⦃</span><span class="main">´</span>pr1<span class="main">=</span><span class="main">1</span> <span class="main">∧</span> <span class="main">´</span>in1<span class="main">⦄</span>  <span class="main">⟨</span> <span class="main">´</span>hold<span class="main">:=</span><span class="main">1</span><span class="main">,,</span>  <span class="main">´</span>pr1<span class="main">:=</span><span class="numeral">2</span> <span class="main">⟩</span><span class="main">;;</span>
  <span class="main">⦃</span><span class="main">´</span>pr1<span class="main">=</span><span class="numeral">2</span> <span class="main">∧</span> <span class="main">´</span>in1 <span class="main">∧</span> <span class="main">(</span><span class="main">´</span>hold<span class="main">=</span><span class="main">1</span> <span class="main">∨</span> <span class="main">(</span><span class="main">´</span>hold<span class="main">=</span><span class="numeral">2</span> <span class="main">∧</span> <span class="main">´</span>pr2<span class="main">=</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">⦄</span>
  <span class="keyword1">AWAIT</span> <span class="main">(</span><span class="main">¬</span><span class="main">´</span>in2 <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span><span class="main">´</span>hold<span class="main">=</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">´</span>pr1<span class="main">:=</span><span class="numeral">3</span>  <span class="keyword1">END</span><span class="main">;;</span>
  <span class="main">⦃</span><span class="main">´</span>pr1<span class="main">=</span><span class="numeral">3</span> <span class="main">∧</span> <span class="main">´</span>in1 <span class="main">∧</span> <span class="main">(</span><span class="main">´</span>hold<span class="main">=</span><span class="main">1</span> <span class="main">∨</span> <span class="main">(</span><span class="main">´</span>hold<span class="main">=</span><span class="numeral">2</span> <span class="main">∧</span> <span class="main">´</span>pr2<span class="main">=</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">⦄</span>
   <span class="main">⟨</span> <span class="main">´</span>in1<span class="main">:=</span>False<span class="main">,,</span> <span class="main">´</span>pr1<span class="main">:=</span><span class="main">0</span><span class="main">⟩</span>
  <span class="keyword1">OD</span> <span class="main">⦃</span><span class="main">´</span>pr1<span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">´</span>in1<span class="main">⦄</span><span class="main">,</span><span class="main">⦃</span>False<span class="main">⦄</span>
  <span class="main">∥</span>
  <span class="main">⦃</span><span class="main">´</span>pr2<span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">´</span>in2<span class="main">⦄</span>
  <span class="keyword1">WHILE</span> True <span class="keyword1">INV</span> <span class="main">⦃</span><span class="main">´</span>pr2<span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">´</span>in2<span class="main">⦄</span>
  <span class="keyword1">DO</span>
  <span class="main">⦃</span><span class="main">´</span>pr2<span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">´</span>in2<span class="main">⦄</span> <span class="main">⟨</span> <span class="main">´</span>in2<span class="main">:=</span>True<span class="main">,,</span> <span class="main">´</span>pr2<span class="main">:=</span><span class="main">1</span> <span class="main">⟩</span><span class="main">;;</span>
  <span class="main">⦃</span><span class="main">´</span>pr2<span class="main">=</span><span class="main">1</span> <span class="main">∧</span> <span class="main">´</span>in2<span class="main">⦄</span> <span class="main">⟨</span> <span class="main">´</span>hold<span class="main">:=</span><span class="numeral">2</span><span class="main">,,</span> <span class="main">´</span>pr2<span class="main">:=</span><span class="numeral">2</span> <span class="main">⟩</span> <span class="main">;;</span>
  <span class="main">⦃</span><span class="main">´</span>pr2<span class="main">=</span><span class="numeral">2</span> <span class="main">∧</span> <span class="main">´</span>in2 <span class="main">∧</span> <span class="main">(</span><span class="main">´</span>hold<span class="main">=</span><span class="numeral">2</span> <span class="main">∨</span> <span class="main">(</span><span class="main">´</span>hold<span class="main">=</span><span class="main">1</span> <span class="main">∧</span> <span class="main">´</span>pr1<span class="main">=</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">⦄</span>
  <span class="keyword1">AWAIT</span> <span class="main">(</span><span class="main">¬</span><span class="main">´</span>in1 <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span><span class="main">´</span>hold<span class="main">=</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">´</span>pr2<span class="main">:=</span><span class="numeral">3</span> <span class="keyword1">END</span><span class="main">;;</span>
  <span class="main">⦃</span><span class="main">´</span>pr2<span class="main">=</span><span class="numeral">3</span> <span class="main">∧</span> <span class="main">´</span>in2 <span class="main">∧</span> <span class="main">(</span><span class="main">´</span>hold<span class="main">=</span><span class="numeral">2</span> <span class="main">∨</span> <span class="main">(</span><span class="main">´</span>hold<span class="main">=</span><span class="main">1</span> <span class="main">∧</span> <span class="main">´</span>pr1<span class="main">=</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">⦄</span>
    <span class="main">⟨</span> <span class="main">´</span>in2<span class="main">:=</span>False<span class="main">,,</span> <span class="main">´</span>pr2<span class="main">:=</span><span class="main">0</span><span class="main">⟩</span>
  <span class="keyword1">OD</span> <span class="main">⦃</span><span class="main">´</span>pr2<span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">´</span>in2<span class="main">⦄</span><span class="main">,</span><span class="main">⦃</span>False<span class="main">⦄</span>
  <span class="keyword1">COEND</span>
  <span class="main">⦃</span><span class="main">´</span>pr1<span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">´</span>in1 <span class="main">∧</span> <span class="main">´</span>pr2<span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">´</span>in2<span class="main">⦄</span><span class="main">,</span><span class="main">⦃</span>False<span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">oghoare</span>
<span class="comment1">― ‹81 verification conditions.›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="SumArr">
<div class="head">
<h1>Theory SumArr</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright 2016, Data61, CSIRO
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(DATA61_BSD)
 *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Case-study›</span></span>

<span class="keyword1"><span class="command">theory</span></span> SumArr
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="OG_Syntax.html">../OG_Syntax</a>"</span>
  <a href="../Word_Lib/Word_32.html">Word_Lib.Word_32</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> routine <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> word32 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="numeral">32</span> word"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> funcs <span class="main">=</span> <span class="quoted"><span class="quoted">"string <span class="main">×</span> nat"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> faults <span class="main">=</span> Overflow <span class="main">|</span> InvalidMem
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> array <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
 
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Sumarr computes the combined sum of all the elements of
multiple arrays. It does this by running a number of threads in
parallel, each computing the sum of elements of one of the arrays,
and then adding the result to a global variable gsum shared by all threads.
›</span></span>
<span class="keyword1"><span class="command">record</span></span> sumarr_state <span class="main">=</span>
 <span class="comment1">― ‹local variables of threads›</span>
  tarr <span class="main">::</span> <span class="quoted"><span class="quoted">"routine <span class="main">⇒</span> word32 array"</span></span>
  tid <span class="main">::</span> <span class="quoted"><span class="quoted">"routine <span class="main">⇒</span> word32"</span></span>
  ti <span class="main">::</span> <span class="quoted"><span class="quoted">"routine <span class="main">⇒</span> word32"</span></span>
  tsum <span class="main">::</span> <span class="quoted"><span class="quoted">"routine <span class="main">⇒</span> word32"</span></span>
 <span class="comment1">― ‹global variables›</span>
  glock <span class="main">::</span> <span class="quoted">nat</span>
  gsum <span class="main">::</span> <span class="quoted">word32</span>
  gdone <span class="main">::</span> <span class="quoted">word32</span>
  garr <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>word32 array<span class="main">)</span> array"</span></span>
 <span class="comment1">― ‹ghost variables›</span>
  ghost_lock <span class="main">::</span> <span class="quoted"><span class="quoted">"routine <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
 <span class="entity">NSUM</span> <span class="main">::</span> <span class="quoted">word32</span>
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">NSUM</span> <span class="main">=</span> <span class="numeral">10</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
 <span class="entity">MAXSUM</span> <span class="main">::</span> <span class="quoted">word32</span>
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">MAXSUM</span> <span class="main">=</span> <span class="numeral">1500</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
 <span class="entity">array_length</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> array <span class="main">⇒</span> word32"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">array_length</span> <span class="free"><span class="bound"><span class="entity">arr</span></span></span> <span class="main">≡</span> of_nat <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">arr</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
 <span class="entity">array_nth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> array <span class="main">⇒</span> word32 <span class="main">⇒</span><span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">array_nth</span> <span class="free"><span class="bound"><span class="entity">arr</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">arr</span></span></span> <span class="main">!</span> unat <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
 <span class="entity">array_in_bound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> array <span class="main">⇒</span> word32 <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">array_in_bound</span> <span class="free"><span class="bound"><span class="entity">arr</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">≡</span> unat <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">arr</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">array_nat_sum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> len<span class="main">)</span> word array <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">array_nat_sum</span> <span class="free"><span class="bound"><span class="entity">arr</span></span></span> <span class="main">≡</span> sum_list <span class="main">(</span>map unat <span class="free"><span class="bound"><span class="entity">arr</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">local_sum</span> <span class="free"><span class="bound"><span class="entity">arr</span></span></span> <span class="main">≡</span> of_nat <span class="main">(</span>min <span class="main">(</span>unat MAXSUM<span class="main">)</span> <span class="main">(</span>array_nat_sum <span class="free"><span class="bound"><span class="entity">arr</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">global_sum</span> <span class="free"><span class="bound"><span class="entity">arr</span></span></span> <span class="main">≡</span> sum_list <span class="main">(</span>map local_sum <span class="free"><span class="bound"><span class="entity">arr</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tarr_inv</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span>
    length <span class="main">(</span>tarr <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> unat NSUM <span class="main">∧</span> tarr <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> garr <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sumarr_inv_till_lock</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">¬</span>gdone <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="main">¬</span> <span class="main">(</span>ghost_lock <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span>gdone <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> gsum <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span>gdone <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!!</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">∧</span> gsum <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> local_sum <span class="main">(</span>garr <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lock_inv</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span>
    <span class="main">(</span>glock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> fromEnum <span class="main">(</span>ghost_lock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">0</span><span class="main">)</span> <span class="main">+</span> fromEnum <span class="main">(</span>ghost_lock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">¬</span><span class="main">(</span>ghost_lock <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span>ghost_lock <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">garr_inv</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> garr <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>
    length <span class="main">(</span>garr <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> unat NSUM"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sumarr_inv</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> lock_inv <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> tarr_inv <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> garr_inv <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span>
    tid <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span>of_nat <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">lock</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"routine <span class="main">⇒</span> <span class="main">(</span>sumarr_state<span class="main">,</span> funcs<span class="main">,</span> faults<span class="main">)</span> ann_com"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lock</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span>
    <span class="main">⦃</span> <span class="main">´</span>sumarr_inv <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> local_sum <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">´</span>sumarr_inv_till_lock <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⦄</span>
    <span class="keyword1">AWAIT</span> <span class="main">´</span>glock <span class="main">=</span> <span class="main">0</span>
    <span class="keyword1">THEN</span> <span class="main">´</span>glock<span class="main">:=</span><span class="main">1</span><span class="main">,,</span> <span class="main">´</span>ghost_lock<span class="main">:=</span><span class="main">´</span>ghost_lock <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">:=</span> True<span class="main">)</span>
    <span class="keyword1">END</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">sumarr_in_lock1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">¬</span>gdone <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span>gdone <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> gsum <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> local_sum <span class="main">(</span>tarr <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
   <span class="main">(</span>gdone <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!!</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> gdone <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> gsum <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> global_sum <span class="main">(</span>garr <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">sumarr_in_lock2</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">(</span>gdone <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">¬</span> gdone <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!!</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">∧</span> gsum <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> local_sum <span class="main">(</span>tarr <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
   <span class="main">(</span>gdone <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> gdone <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!!</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">∧</span> gsum <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> global_sum <span class="main">(</span>garr <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">unlock</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"routine <span class="main">⇒</span> <span class="main">(</span>sumarr_state<span class="main">,</span> funcs<span class="main">,</span> faults<span class="main">)</span> ann_com"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unlock</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span>
    <span class="main">⦃</span>  <span class="main">´</span>sumarr_inv <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> local_sum <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">´</span>glock <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span>
    <span class="main">´</span>ghost_lock <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>gdone <span class="main">!!</span> <span class="main">(</span>unat <span class="main">(</span><span class="main">´</span>tid <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">´</span>sumarr_in_lock2 <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">⦄</span>
    <span class="main">⟨</span><span class="main">´</span>glock <span class="main">:=</span> <span class="main">0</span><span class="main">,,</span> <span class="main">´</span>ghost_lock<span class="main">:=</span><span class="main">´</span>ghost_lock <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">:=</span> False<span class="main">)</span><span class="main">⟩</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">local_postcond</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span>ghost_lock <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">⟶</span> gsum <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> gdone <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!!</span> <span class="main">0</span> <span class="main">∧</span> gdone <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!!</span> <span class="main">1</span>
              <span class="keyword1">then</span> global_sum <span class="main">(</span>garr <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
              <span class="keyword1">else</span> local_sum <span class="main">(</span>garr <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> gdone <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">¬</span>ghost_lock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sumarr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"routine <span class="main">⇒</span> <span class="main">(</span>sumarr_state<span class="main">,</span> funcs<span class="main">,</span> faults<span class="main">)</span> ann_com"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sumarr</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> 
  <span class="main">⦃</span><span class="main">´</span>sumarr_inv <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>sumarr_inv_till_lock <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⦄</span>
  <span class="main">´</span>tsum<span class="main">:=</span><span class="main">´</span>tsum<span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">:=</span><span class="main">0</span><span class="main">)</span> <span class="main">;;</span>
  <span class="main">⦃</span> <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">´</span>sumarr_inv <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>sumarr_inv_till_lock <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⦄</span>
  <span class="main">´</span>ti<span class="main">:=</span><span class="main">´</span>ti<span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">:=</span><span class="main">0</span><span class="main">)</span> <span class="main">;;</span>
  <span class="keyword1">TRY</span>
    <span class="main">⦃</span> <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">´</span>sumarr_inv <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">´</span>sumarr_inv_till_lock <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⦄</span>
    <span class="keyword1">WHILE</span> <span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> NSUM
    <span class="keyword1">INV</span> <span class="main">⦃</span> <span class="main">´</span>sumarr_inv <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> NSUM <span class="main">∧</span> <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> MAXSUM <span class="main">∧</span>
          <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> local_sum <span class="main">(</span>take <span class="main">(</span>unat <span class="main">(</span><span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">´</span>sumarr_inv_till_lock <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⦄</span>
    <span class="keyword1">DO</span>
     <span class="main">⦃</span> <span class="main">´</span>sumarr_inv <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> NSUM <span class="main">∧</span> <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> MAXSUM <span class="main">∧</span>
       <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> local_sum <span class="main">(</span>take <span class="main">(</span>unat <span class="main">(</span><span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">´</span>sumarr_inv_till_lock <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⦄</span>
     <span class="main">(</span>InvalidMem<span class="main">,</span> <span class="main">⦃</span> array_in_bound <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="free"><span class="bound"><span class="bound"><span class="entity"><span class="entity">i</span></span></span></span></span></span><span class="main">)</span>  <span class="main">(</span><span class="main">´</span>ti <span class="free"><span class="free"><span class="bound"><span class="bound"><span class="entity"><span class="entity">i</span></span></span></span></span></span><span class="main">)</span> <span class="main">⦄</span><span class="main">)</span> <span class="main">⟼</span>
       <span class="main">⦃</span> <span class="main">´</span>sumarr_inv <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> NSUM <span class="main">∧</span> <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> MAXSUM <span class="main">∧</span>
         <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> local_sum <span class="main">(</span>take <span class="main">(</span>unat <span class="main">(</span><span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">´</span>sumarr_inv_till_lock <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⦄</span>
       <span class="main">´</span>tsum<span class="main">:=</span><span class="main">´</span>tsum<span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">:=</span><span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> array_nth <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;;</span>
     <span class="main">⦃</span> <span class="main">´</span>sumarr_inv <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> NSUM <span class="main">∧</span>
         local_sum <span class="main">(</span>take <span class="main">(</span>unat <span class="main">(</span><span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> MAXSUM <span class="main">∧</span>
         <span class="main">(</span><span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> MAXSUM <span class="main">∧</span> array_nth <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">&lt;</span> MAXSUM <span class="main">⟶</span>
       <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> local_sum <span class="main">(</span>take <span class="main">(</span>Suc <span class="main">(</span>unat <span class="main">(</span><span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
         <span class="main">(</span>array_nth <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">≥</span> MAXSUM <span class="main">∨</span> <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≥</span> MAXSUM<span class="main">⟶</span>
           local_sum <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> MAXSUM<span class="main">)</span>  <span class="main">∧</span>
       <span class="main">´</span>sumarr_inv_till_lock <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">⦄</span>
     <span class="main">(</span>InvalidMem<span class="main">,</span> <span class="main">⦃</span> array_in_bound <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="free"><span class="bound"><span class="bound"><span class="entity"><span class="entity">i</span></span></span></span></span></span><span class="main">)</span>  <span class="main">(</span><span class="main">´</span>ti <span class="free"><span class="free"><span class="bound"><span class="bound"><span class="entity"><span class="entity">i</span></span></span></span></span></span><span class="main">)</span> <span class="main">⦄</span><span class="main">)</span> <span class="main">⟼</span>
       <span class="main">⦃</span> <span class="main">´</span>sumarr_inv <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> NSUM <span class="main">∧</span>
         <span class="main">(</span><span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> MAXSUM <span class="main">∧</span> array_nth <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">&lt;</span> MAXSUM <span class="main">⟶</span>
           <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> local_sum <span class="main">(</span>take <span class="main">(</span>Suc <span class="main">(</span>unat <span class="main">(</span><span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
         <span class="main">(</span>array_nth <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">≥</span> MAXSUM <span class="main">∨</span> <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≥</span> MAXSUM <span class="main">⟶</span>
           local_sum <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> MAXSUM<span class="main">)</span> <span class="main">∧</span>
         <span class="main">´</span>sumarr_inv_till_lock <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⦄</span>
       <span class="keyword1">IF</span> array_nth <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">≥</span> MAXSUM <span class="main">∨</span> <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≥</span> MAXSUM 
       <span class="keyword1">THEN</span>
         <span class="main">⦃</span> <span class="main">´</span>sumarr_inv <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> NSUM <span class="main">∧</span> local_sum <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> MAXSUM <span class="main">∧</span> <span class="main">´</span>sumarr_inv_till_lock <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⦄</span>
         <span class="main">´</span>tsum<span class="main">:=</span><span class="main">´</span>tsum<span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">:=</span>MAXSUM<span class="main">)</span><span class="main">;;</span>
         <span class="main">⦃</span> <span class="main">´</span>sumarr_inv <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> NSUM <span class="main">∧</span> <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> MAXSUM <span class="main">∧</span>
           <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> local_sum <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">´</span>sumarr_inv_till_lock <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">⦄</span>
         <span class="keyword1">THROW</span>
       <span class="keyword1">ELSE</span>
         <span class="main">⦃</span> <span class="main">´</span>sumarr_inv <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> NSUM <span class="main">∧</span> <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> MAXSUM <span class="main">∧</span>
           <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> local_sum <span class="main">(</span>take <span class="main">(</span>Suc <span class="main">(</span>unat <span class="main">(</span><span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">´</span>sumarr_inv_till_lock <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⦄</span>
         <span class="keyword1">SKIP</span>
       <span class="keyword1">FI</span><span class="main">;;</span>
     <span class="main">⦃</span> <span class="main">´</span>sumarr_inv <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> NSUM <span class="main">∧</span> <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> MAXSUM <span class="main">∧</span>
       <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> local_sum <span class="main">(</span>take <span class="main">(</span>Suc <span class="main">(</span>unat <span class="main">(</span><span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">´</span>sumarr_inv_till_lock <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">⦄</span>
     <span class="main">´</span>ti<span class="main">:=</span><span class="main">´</span>ti<span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">:=</span><span class="main">´</span>ti <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>
    <span class="keyword1">OD</span>
  <span class="keyword1">CATCH</span>
    <span class="main">⦃</span> <span class="main">´</span>sumarr_inv <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> local_sum <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">´</span>sumarr_inv_till_lock <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⦄</span> <span class="keyword1">SKIP</span>
  <span class="keyword1">END</span><span class="main">;;</span>
  <span class="main">⦃</span> <span class="main">´</span>sumarr_inv <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> local_sum <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">´</span>sumarr_inv_till_lock <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⦄</span>
  <span class="keyword1">SCALL</span> <span class="main">(</span><span class="inner_quoted">''lock''</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">0</span><span class="main">;;</span>
  <span class="main">⦃</span> <span class="main">´</span>sumarr_inv <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> local_sum <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">´</span>glock <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span>
    <span class="main">´</span>ghost_lock <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>sumarr_inv_till_lock <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">⦄</span>
  <span class="main">´</span>gsum<span class="main">:=</span><span class="main">´</span>gsum <span class="main">+</span> <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">;;</span>
  <span class="main">⦃</span> <span class="main">´</span>sumarr_inv <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> local_sum <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">´</span>glock <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span>
    <span class="main">´</span>ghost_lock <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>sumarr_in_lock1 <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">⦄</span>
  <span class="main">´</span>gdone<span class="main">:=</span><span class="main">(</span><span class="main">´</span>gdone <span class="keyword1">OR</span> <span class="main">´</span>tid <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">;;</span>
  <span class="main">⦃</span> <span class="main">´</span>sumarr_inv <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>tsum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> local_sum <span class="main">(</span><span class="main">´</span>tarr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">´</span>glock <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span>
    <span class="main">´</span>ghost_lock <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>gdone <span class="main">!!</span> <span class="main">(</span>unat <span class="main">(</span><span class="main">´</span>tid <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">´</span>sumarr_in_lock2 <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">⦄</span>
  <span class="keyword1">SCALL</span> <span class="main">(</span><span class="inner_quoted">''unlock''</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
 <span class="entity">precond</span>
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">precond</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span>glock <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span>gsum <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">∧</span> <span class="main">(</span>gdone <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span>
               <span class="main">(</span><span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> garr <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>
               <span class="main">(</span><span class="main">∀</span><span class="bound">xs</span><span class="main">∈</span>set <span class="main">(</span>garr <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">=</span> unat NSUM<span class="main">)</span> <span class="main">∧</span>
               <span class="main">(</span>ghost_lock <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> False <span class="main">∧</span> <span class="main">(</span>ghost_lock <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">1</span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
 <span class="entity">postcond</span>
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">postcond</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span>gsum <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> global_sum <span class="main">(</span>garr <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∧</span>
               <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">.</span> <span class="main">(</span>gdone <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">call_sumarr</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span>
    <span class="main">⦃</span>length <span class="main">(</span><span class="main">´</span>garr <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> unat NSUM <span class="main">∧</span> <span class="main">´</span>lock_inv <span class="main">∧</span> <span class="main">´</span>garr_inv <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span>
     <span class="main">´</span>sumarr_inv_till_lock <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⦄</span>
    <span class="keyword1">CALLX</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">⦇</span>tarr<span class="main">:=</span><span class="main">(</span>tarr <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">:=</span>garr <span class="bound">s</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">,</span>
                 tid<span class="main">:=</span><span class="main">(</span>tid <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">:=</span>of_nat <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">,</span>
                 ti<span class="main">:=</span><span class="main">(</span>ti <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">:=</span>undefined<span class="main">)</span><span class="main">,</span>
                 tsum<span class="main">:=</span><span class="main">(</span>tsum <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">:=</span>undefined<span class="main">)</span><span class="main">⦈</span><span class="main">)</span>
          <span class="main">⦃</span><span class="main">´</span>sumarr_inv <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">´</span>sumarr_inv_till_lock <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⦄</span>
          <span class="main">(</span><span class="inner_quoted">''sumarr''</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">0</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span><span class="main">⦇</span>tarr<span class="main">:=</span> <span class="main">(</span>tarr <span class="bound">t</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">:=</span><span class="main">(</span>tarr <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">,</span>
                   tid<span class="main">:=</span><span class="main">(</span>tid <span class="bound">t</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">:=</span><span class="main">(</span>tid <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                   ti<span class="main">:=</span><span class="main">(</span>ti <span class="bound">t</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">:=</span><span class="main">(</span>ti <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                   tsum<span class="main">:=</span><span class="main">(</span>tsum <span class="bound">t</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">:=</span><span class="main">(</span>tsum <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> Skip<span class="main">)</span>
          <span class="main">⦃</span><span class="main">´</span>local_postcond <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⦄</span> <span class="main">⦃</span><span class="main">´</span>local_postcond <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⦄</span>
          <span class="main">⦃</span>False<span class="main">⦄</span> <span class="main">⦃</span>False<span class="main">⦄</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">≡</span> map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="inner_quoted">''sumarr''</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> com <span class="main">(</span>sumarr <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="numeral">2</span><span class="main">]</span><span class="main">)</span> <span class="main">++</span>
  map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="inner_quoted">''lock''</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> com <span class="main">(</span>lock <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="numeral">2</span><span class="main">]</span><span class="main">)</span> <span class="main">++</span>
  map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="inner_quoted">''unlock''</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> com <span class="main">(</span>unlock <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="numeral">2</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Θ</span> <span class="main">≡</span> map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="inner_quoted">''sumarr''</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span>ann <span class="main">(</span>sumarr <span class="bound">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="numeral">2</span><span class="main">]</span><span class="main">)</span> <span class="main">++</span>
  map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="inner_quoted">''lock''</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span>ann <span class="main">(</span>lock <span class="bound">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="numeral">2</span><span class="main">]</span><span class="main">)</span> <span class="main">++</span>
  map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="inner_quoted">''unlock''</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span>ann <span class="main">(</span>unlock <span class="bound">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="numeral">2</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span> <span class="main"><span class="main">=</span></span> 10<span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"local_sum <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local_sum_def array_nat_sum_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> MAXSUM_le_plus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> MAXSUM <span class="main">⟹</span> MAXSUM <span class="main">≤</span> MAXSUM <span class="main">+</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> MAXSUM_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> word_le_plus<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> local_sum_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">n</span> <span class="main">&lt;</span> length <span class="free">arr</span><span class="main">;</span> local_sum <span class="main">(</span>take <span class="free">n</span> <span class="free">arr</span><span class="main">)</span> <span class="main">+</span> <span class="free">arr</span> <span class="main">!</span> <span class="free">n</span> <span class="main">&lt;</span> MAXSUM<span class="main">;</span>
    <span class="free">arr</span> <span class="main">!</span> <span class="free">n</span> <span class="main">&lt;</span> MAXSUM<span class="main">⟧</span> <span class="main">⟹</span>
    local_sum <span class="main">(</span>take <span class="free">n</span> <span class="free">arr</span><span class="main">)</span> <span class="main">+</span> <span class="free">arr</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span>
      local_sum <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">arr</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> take_Suc_conv_app_nth<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> local_sum_def array_nat_sum_def <span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> min_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MAXSUM_le_plus word_not_le<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> min_absorb2<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> of_nat_mono_maybe_le<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="numeral">32</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MAXSUM_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MAXSUM_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unat_arith</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MAXSUM_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unat_arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> local_sum_MAXSUM<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">arr</span> <span class="main">⟹</span> MAXSUM <span class="main">≤</span> <span class="free">arr</span> <span class="main">!</span> <span class="free">k</span> <span class="main">⟹</span> local_sum <span class="free">arr</span> <span class="main">=</span> MAXSUM"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> local_sum_def array_nat_sum_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> word_unat.Rep_inverse'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> min_absorb1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> word_le_nat_alt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> elem_le_sum_list<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> local_sum_MAXSUM'<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹local_sum <span class="free">arr</span> <span class="main">=</span> MAXSUM›</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">arr</span>›</span></span>
    <span class="quoted"><span class="quoted">‹MAXSUM <span class="main">≤</span> local_sum <span class="main">(</span>take <span class="free">k</span> <span class="free">arr</span><span class="main">)</span> <span class="main">+</span> <span class="free">arr</span> <span class="main">!</span> <span class="free">k</span>›</span></span>
    <span class="quoted"><span class="quoted">‹local_sum <span class="main">(</span>take <span class="free">k</span> <span class="free">arr</span><span class="main">)</span> <span class="main">≤</span> MAXSUM›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">arr</span> <span class="main">!</span> <span class="free">k</span> <span class="main">≤</span> MAXSUM›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">vs</span> <span class="main">=</span> take <span class="free">k</span> <span class="free">arr</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">=</span> <span class="free">arr</span> <span class="main">!</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ws</span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">arr</span>›</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">arr</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">arr</span> <span class="main">=</span> <span class="skolem">vs</span> <span class="main">@</span> <span class="skolem">u</span> <span class="main">#</span> <span class="skolem">ws</span>›</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹take <span class="free">k</span> <span class="free">arr</span> <span class="main">=</span> <span class="skolem">vs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">arr</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> <span class="skolem">u</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_take_nth_drop<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> **<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local_sum_def array_nat_sum_def <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">find_theorems</span></span> <span class="quoted"><span class="quoted">‹min <span class="main">_</span> <span class="main">(</span><span class="main">_</span> <span class="main">+</span> <span class="main">_</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> word_unat.Rep_inverse'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> min_absorb1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> word_le_nat_alt<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> unat_plus_simple<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> word_add_le_mono2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MAXSUM_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unat_arith</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> add_mono<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> min.bounded_iff take_bit_nat_less_eq_self trans_le_add1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> word_min_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>len word<span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
 <span class="quoted"><span class="quoted">"min <span class="main">0</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>len word<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>min_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">TRY'</span> <span class="entity">tac</span> <span class="entity">i</span> <span class="main">=</span> TRY <span class="main">(</span><span class="entity">tac</span> <span class="entity">i</span><span class="main">)</span>›</span>


<span class="keyword1"><span class="command">lemma</span></span> imp_disjL_context'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main">⟶</span> <span class="free">R</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">Q</span> <span class="main">⟶</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main">⟶</span> <span class="free">R</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span><span class="free">P</span> <span class="main">∧</span> <span class="free">Q</span> <span class="main">⟶</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_of_prod_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span>
    map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="free">g</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span>
       <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">g</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> map_of_is_SomeI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_map o_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> inj_onI prod.inject<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_of_prod_2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">≠</span> <span class="free">q</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free">m</span> <span class="main">++</span>
    map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="free">g</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> map_add_dom_app_simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> dom_map_of_conv_image_fst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> sumarr_proc_simp<span class="main">[</span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic">oghoare_simps</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">⟹</span> Γ <span class="main">(</span><span class="inner_quoted">''sumarr''</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>com <span class="main">(</span>sumarr <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">⟹</span> Θ <span class="main">(</span><span class="inner_quoted">''sumarr''</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">[</span>ann <span class="main">(</span>sumarr <span class="free">n</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">⟹</span> Γ <span class="main">(</span><span class="inner_quoted">''lock''</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>com <span class="main">(</span>lock <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">⟹</span> Θ <span class="main">(</span><span class="inner_quoted">''lock''</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">[</span>ann <span class="main">(</span>lock <span class="free">n</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">⟹</span> Γ <span class="main">(</span><span class="inner_quoted">''unlock''</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>com <span class="main">(</span>unlock <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">⟹</span> Θ <span class="main">(</span><span class="inner_quoted">''unlock''</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">[</span>ann <span class="main">(</span>unlock <span class="free">n</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="main">[</span>ann <span class="main">(</span>sumarr <span class="free">n</span><span class="main">)</span><span class="main">]</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> ann <span class="main">(</span>sumarr <span class="free">n</span><span class="main">)</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="main">[</span>ann <span class="main">(</span>lock <span class="free">n</span><span class="main">)</span><span class="main">]</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> ann <span class="main">(</span>lock <span class="free">n</span><span class="main">)</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="main">[</span>ann <span class="main">(</span>unlock <span class="free">n</span><span class="main">)</span><span class="main">]</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> ann <span class="main">(</span>unlock <span class="free">n</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Γ_def Θ_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> sumarr_proc_simp_unfolded <span class="main">=</span> sumarr_proc_simp<span class="main">[</span><span class="operator">unfolded</span> sumarr_def unlock_def lock_def <span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic">oghoare_simps</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_sumarr<span class="main">:</span>
<span class="keyword2"><span class="keyword">notes</span></span> sumarr_proc_simp_unfolded<span class="main">[</span><span class="operator">proc_simp</span> <span class="quasi_keyword">add</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">shows</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">⟹</span>
  Γ<span class="main">,</span> Θ
    |⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> sumarr <span class="free"><span class="free">i</span></span> <span class="main">⦃</span><span class="main">´</span>local_postcond <span class="free">i</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>False<span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sumarr_def unlock_def lock_def
    ann_call_def call_def block_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">oghoare</span> <span class="comment1">(*23*)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> tarr_inv_def array_length_def array_nth_def array_in_bound_def
    sumarr_in_lock1_def sumarr_in_lock2_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">tactic</span> <span class="quoted">"<span class="entity">PARALLEL_ALLGOALS</span> <span class="main">(</span><span class="main">(</span><span class="entity">TRY'</span> o SOLVED'<span class="main">)</span>
          <span class="main">(</span><span class="entity">clarsimp_tac</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> addsimps
                <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> local_postcond_def global_sum_def ex_in_conv<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="antiquote">}</span></span></span><span class="main">)</span> 
          THEN_ALL_NEW <span class="entity">fast_force_tac</span>
             <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="entity">addSDs</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> less_2_cases<span class="antiquote">}</span></span></span>
                         <span class="entity">addIs</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> local_sum_Suc unat_mono<span class="antiquote">}</span></span></span>
                        <span class="main">)</span>
          <span class="main">)</span><span class="main">)</span>"</span><span class="main">)</span> <span class="comment1">(*2*)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> local_sum_Suc unat_mono<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> imp_disjL_context'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> local_sum_MAXSUM<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unat_arith</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> local_sum_MAXSUM'<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">;</span></span> <span class="operator">unat_arith</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unat_arith</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> less_than_two_2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">⟹</span> Suc <span class="main">0</span> <span class="main">-</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>

<span class="keyword1"><span class="command">lemma</span></span> oghoare_call_sumarr<span class="main">:</span>
<span class="keyword2"><span class="keyword">notes</span></span> sumarr_proc_simp<span class="main">[</span><span class="operator">proc_simp</span> <span class="quasi_keyword">add</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">⟹</span>
  Γ<span class="main">,</span> Θ |⊢<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> call_sumarr <span class="free"><span class="free">i</span></span> <span class="main">⦃</span><span class="main">´</span>local_postcond <span class="free">i</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>False<span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> call_sumarr_def ann_call_def call_def block_def
    tarr_inv_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">oghoare</span> <span class="comment1">(*10*)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span> <span class="main"><span class="keyword3">|</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> pre.simps<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span>  oghoare_sumarr<span class="main">)</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sumarr_def tarr_inv_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> local_postcond_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> less_than_two_inv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≠</span> <span class="free">j</span> <span class="main">⟹</span> Suc <span class="main">0</span> <span class="main">-</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 
<span class="keyword1"><span class="command">lemma</span></span> inter_aux_call_sumarr<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">notes</span></span>  sumarr_proc_simp_unfolded<span class="main">[</span><span class="operator">proc_simp</span> <span class="quasi_keyword">add</span><span class="main">]</span> com.simps<span class="main">[</span><span class="operator">oghoare_simps</span> <span class="quasi_keyword">add</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≠</span> <span class="free">j</span> <span class="main">⟹</span> interfree_aux Γ Θ
     <span class="free">F</span> <span class="main">(</span>com <span class="main">(</span>call_sumarr <span class="free">i</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>ann <span class="main">(</span>call_sumarr <span class="free">i</span><span class="main">)</span><span class="main">,</span> <span class="main">⦃</span><span class="main">´</span>local_postcond <span class="free">i</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>False<span class="main">⦄</span><span class="main">)</span><span class="main">,</span>
        com <span class="main">(</span>call_sumarr <span class="free">j</span><span class="main">)</span><span class="main">,</span> ann <span class="main">(</span>call_sumarr <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> call_sumarr_def ann_call_def call_def block_def
    tarr_inv_def sumarr_def lock_def unlock_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">oghoare_interfree_aux</span> <span class="comment1">(*650*)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> 
    tarr_inv_def local_postcond_def sumarr_in_lock1_def
    sumarr_in_lock2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">tactic</span> <span class="quoted">"<span class="entity">PARALLEL_ALLGOALS</span> <span class="main">(</span>
                  <span class="entity">TRY'</span> <span class="main">(</span><span class="entity">remove_single_Bound_mem</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span><span class="main">)</span> THEN'
                  <span class="main">(</span><span class="entity">TRY'</span> o SOLVED'<span class="main">)</span>
                  <span class="main">(</span><span class="entity">clarsimp_tac</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> THEN_ALL_NEW
                    <span class="entity">fast_force_tac</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="entity">addSDs</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> less_2_cases<span class="antiquote">}</span></span></span><span class="main">)</span>
                  <span class="main">)</span><span class="main">)</span>"</span><span class="main">)</span> <span class="comment1">(* 2 minutes *)</span>

<span class="keyword1"><span class="command">lemma</span></span> pre_call_sumarr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">⟹</span> precond <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> pre <span class="main">(</span>ann <span class="main">(</span>call_sumarr <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> precond_def call_sumarr_def ann_call_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> less_2_cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> array_length_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> post_call_sumarr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"local_postcond <span class="free">x</span> <span class="main">0</span> <span class="main">⟹</span> local_postcond <span class="free">x</span> <span class="main">1</span> <span class="main">⟹</span> postcond <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> postcond_def local_postcond_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> less_2_cases <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sumarr_correct<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Γ<span class="main">,</span> Θ |⊩<span class="hidden">⇘</span><sub>/<span class="free">F</span></sub><span class="hidden">⇙</span> <span class="main">⦃</span><span class="main">´</span>precond<span class="main">⦄</span>
    <span class="keyword1">COBEGIN</span>
      <span class="keyword1">SCHEME</span> <span class="main">[</span><span class="main">0</span> <span class="main">≤</span> <span class="bound"><span class="bound">m</span></span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">]</span>
      call_sumarr <span class="bound"><span class="bound">m</span></span>
      <span class="main">⦃</span><span class="main">´</span>local_postcond <span class="bound">m</span><span class="main">⦄</span><span class="main">,</span><span class="main">⦃</span>False<span class="main">⦄</span>
    <span class="keyword1">COEND</span>
   <span class="main">⦃</span><span class="main">´</span>postcond<span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>False<span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">oghoare</span> <span class="comment1">(* 5 subgoals *)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_call_sumarr<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> oghoare_call_sumarr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> post_call_sumarr<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inter_aux_call_sumarr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>