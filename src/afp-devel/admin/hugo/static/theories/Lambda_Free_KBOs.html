<div id="Lambda_Free_KBO_Util">
<div class="head">
<h1>Theory Lambda_Free_KBO_Util</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Utilities for Knuth-Bendix Orders for Lambda-Free Higher-Order Terms
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2016
    Maintainer:  Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Utilities for Knuth--Bendix Orders for Lambda-Free Higher-Order Terms›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lambda_Free_KBO_Util
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../Lambda_Free_RPOs/Lambda_Free_Term.html">Lambda_Free_RPOs.Lambda_Free_Term</a> <a href="../Lambda_Free_RPOs/Extension_Orders.html">Lambda_Free_RPOs.Extension_Orders</a> <a href="../Polynomials/Polynomials.html">Polynomials.Polynomials</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> kbo_basic_basis <span class="main">=</span> gt_sym <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>s</sub>)</span></span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">gt_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>s</sub></span>"</span> 50<span class="main">)</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">wt_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">ε</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">ground_heads_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'s</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">extf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm list <span class="main">⇒</span>
      bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    ε_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    wt_sym_ge_ε<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wt_sym</span> <span class="free">f</span> <span class="main">≥</span> <span class="free">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ground_heads_var_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ground_heads_var</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    extf_ext_irrefl_before_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_irrefl_before_trans <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    extf_ext_compat_list_strong<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_compat_list_strong <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    extf_ext_hd_or_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_hd_or_tl <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wt_sym_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wt_sym</span> <span class="free">f</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> less_le_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ε_gt_0 wt_sym_ge_ε<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> kbo_std_basis <span class="main">=</span> ground_heads <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>s</sub>)</span></span>"</span></span> <span class="quoted"><span class="free">arity_sym</span></span> <span class="quoted"><span class="free">arity_var</span></span>
    <span class="keyword2"><span class="keyword">for</span></span>
      <span class="free">gt_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>s</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="free">arity_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> enat"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="free">arity_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> enat"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">wt_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>ord<span class="main">,</span>semiring_1<span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">ε</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">δ</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">extf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm list <span class="main">⇒</span>
      bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    ε_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    δ_le_ε<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">≤</span> <span class="free">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    arity_hd_ne_infinity_if_δ_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> arity_hd <span class="free">ζ</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    wt_sym_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wt_sym</span> <span class="free">f</span> <span class="main">≥</span> of_nat <span class="main">(</span><span class="free">ε</span> <span class="main">-</span> the_enat <span class="main">(</span>of_nat <span class="free">δ</span> <span class="main">*</span> <span class="free">arity_sym</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    unary_wt_sym_0_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">arity_sym</span> <span class="free">f</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">wt_sym</span> <span class="free">f</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">f</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free">g</span> <span class="main">∨</span> <span class="free">g</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    unary_wt_sym_0_imp_δ_eq_ε<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">arity_sym</span> <span class="free">f</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">wt_sym</span> <span class="free">f</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">δ</span> <span class="main">=</span> <span class="free">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    extf_ext_irrefl_before_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_irrefl_before_trans <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    extf_ext_compat_list_strong<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_compat_list_strong <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    extf_ext_hd_or_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_hd_or_tl <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    extf_ext_snoc_if_δ_eq_ε<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> <span class="free">ε</span> <span class="main">⟹</span> ext_snoc <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> arity_sym_ne_infinity_if_δ_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">arity_sym</span> <span class="free">f</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arity_hd.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> arity_hd_ne_infinity_if_δ_gt_0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> arity_var_ne_infinity_if_δ_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">arity_var</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arity_hd.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> arity_hd_ne_infinity_if_δ_gt_0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> arity_ne_infinity_if_δ_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> arity <span class="free">s</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> arity_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tm_induct_apps<span class="main">)</span>
    <span class="main">(</span><span class="operator">metis</span> arity_hd_ne_infinity_if_δ_gt_0 enat.distinct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> enat.exhaust idiff_enat_enat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extf_ext_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_irrefl <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext_irrefl_before_trans.axioms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> extf_ext_irrefl_before_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extf_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"ext <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext_irrefl.axioms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> extf_ext_irrefl<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  extf_ext_compat_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_compat_cons <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  extf_ext_compat_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_compat_snoc <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  extf_ext_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_singleton <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext_compat_list_strong.axioms<span class="main"><span class="main">[</span></span><span class="operator">OF</span> extf_ext_compat_list_strong<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extf_ext_compat_list<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_compat_list <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> extf_ext_compat_list_strong
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ext_compat_list_axioms_def ext_compat_list_def ext_compat_list_strong.compat_list
    ext_compat_list_strong_def ext_singleton.axioms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extf_ext_wf_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_wf_bounded <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ext_wf_bounded_def <span class="keyword1"><span class="command">using</span></span> extf_ext_irrefl_before_trans extf_ext_hd_or_tl <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> extf_mono_strong <span class="main">=</span> ext.mono_strong<span class="main">[</span><span class="operator">OF</span> extf_ext<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_mono <span class="main">=</span> ext.mono<span class="main">[</span><span class="operator">OF</span> extf_ext<span class="main">,</span> <span class="operator">mono</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_map <span class="main">=</span> ext.map<span class="main">[</span><span class="operator">OF</span> extf_ext<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_irrefl <span class="main">=</span> ext_irrefl.irrefl<span class="main">[</span><span class="operator">OF</span> extf_ext_irrefl<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_trans_from_irrefl <span class="main">=</span>
  ext_irrefl_before_trans.trans_from_irrefl<span class="main">[</span><span class="operator">OF</span> extf_ext_irrefl_before_trans<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_compat_cons <span class="main">=</span> ext_compat_cons.compat_cons<span class="main">[</span><span class="operator">OF</span> extf_ext_compat_cons<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_compat_append_left <span class="main">=</span> ext_compat_cons.compat_append_left<span class="main">[</span><span class="operator">OF</span> extf_ext_compat_cons<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_compat_append_right <span class="main">=</span> ext_compat_snoc.compat_append_right<span class="main">[</span><span class="operator">OF</span> extf_ext_compat_snoc<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_compat_list <span class="main">=</span> ext_compat_list.compat_list<span class="main">[</span><span class="operator">OF</span> extf_ext_compat_list<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_singleton <span class="main">=</span> ext_singleton.singleton<span class="main">[</span><span class="operator">OF</span> extf_ext_singleton<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_wf_bounded <span class="main">=</span> ext_wf_bounded.wf_bounded<span class="main">[</span><span class="operator">OF</span> extf_ext_wf_bounded<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> extf_snoc_if_δ_eq_ε <span class="main">=</span> ext_snoc.snoc<span class="main">[</span><span class="operator">OF</span> extf_ext_snoc_if_δ_eq_ε<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> extf_singleton_nil_if_δ_eq_ε<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> <span class="free">ε</span> <span class="main">⟹</span> <span class="free">extf</span> <span class="free">f</span> <span class="free">gt</span> <span class="main">[</span><span class="free">s</span><span class="main">]</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> extf_snoc_if_δ_eq_ε<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> kbo_basic_basis <span class="main">&lt;</span> kbo_std_basis _ _ <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">∞</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">∞</span>"</span></span> _ _ <span class="quoted"><span class="main">0</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kbo_std_basis_def kbo_std_basis_axioms_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wt_sym_gt_0 ε_gt_0 wt_sym_ge_ε less_not_refl2 ground_heads_var_nonempty
    gt_sym_axioms ground_heads_def ground_heads_axioms_def extf_ext_irrefl_before_trans
    extf_ext_compat_list_strong extf_ext_hd_or_tl<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lambda_Free_KBO_App">
<div class="head">
<h1>Theory Lambda_Free_KBO_App</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       The Applicative Knuth-Bendix Order for Lambda-Free Higher-Order Terms
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2016
    Maintainer:  Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Applicative Knuth--Bendix Order for Lambda-Free Higher-Order Terms›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lambda_Free_KBO_App
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Lambda_Free_KBO_Util.html">Lambda_Free_KBO_Util</a>
<span class="keyword2"><span class="keyword">abbrevs</span></span> <span class="quoted">"&gt;t"</span> <span class="main">=</span> <span class="quoted">"&gt;<span class="hidden">⇩</span><sub>t</sub>"</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"≥t"</span> <span class="main">=</span> <span class="quoted">"≥<span class="hidden">⇩</span><sub>t</sub>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory defines the applicative Knuth--Bendix order, a variant of KBO for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>λ›</span></span></span></span>-free
higher-order terms. It corresponds to the order obtained by applying the standard first-order KBO on
the applicative encoding of higher-order terms and assigning the lowest precedence to the
application symbol.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> kbo_app <span class="main">=</span> gt_sym <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>s</sub>)</span></span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">gt_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>s</sub></span>"</span> 50<span class="main">)</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">wt_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">ε</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">ext</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    ε_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    wt_sym_ge_ε<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wt_sym</span> <span class="free">f</span> <span class="main">≥</span> <span class="free">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ext_ext_irrefl_before_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_irrefl_before_trans <span class="free">ext</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ext_ext_compat_list<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_compat_list <span class="free">ext</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ext_ext_hd_or_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_hd_or_tl <span class="free">ext</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ext_mono<span class="main">[</span><span class="operator">mono</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="main">≤</span> <span class="free">gt'</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="main">≤</span> <span class="free">ext</span> <span class="free">gt'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ext.mono ext_ext_compat_list<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ext_compat_list_def<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct1<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wt</span> <span class="main">(</span>Hd <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">ε</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wt</span> <span class="main">(</span>Hd <span class="main">(</span>Sym <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">wt_sym</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wt</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">wt</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">+</span> <span class="free">wt</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">gt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  gt_wt<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⊇#</span> vars_mset <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> wt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">&gt;</span> wt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> gt_sym_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wt_sym</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="free">wt_sym</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span> Hd <span class="main">(</span>Sym <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> Hd <span class="main">(</span>Sym <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> gt_sym_app<span class="main">:</span> <span class="quoted"><span class="quoted">"vars <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> wt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> wt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Hd <span class="main">(</span>Sym <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="main">⟹</span> is_App <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> gt_app_app<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⊇#</span> vars_mset <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> wt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> wt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> App <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> App <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">⟹</span>
    <span class="free">ext</span> <span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">]</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">]</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">≥<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lambda_Free_KBO_Std">
<div class="head">
<h1>Theory Lambda_Free_KBO_Std</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       The Graceful Standard Knuth-Bendix Order for Lambda-Free Higher-Order Terms
    Author:      Heiko Becker &lt;heikobecker92@gmail.com&gt;, 2016
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2016
    Author:      Uwe Waldmann &lt;waldmann at mpi-inf.mpg.de&gt;, 2016
    Author:      Daniel Wand &lt;dwand at mpi-inf.mpg.de&gt;, 2016
    Maintainer:  Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Graceful Standard Knuth--Bendix Order for Lambda-Free Higher-Order Terms›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lambda_Free_KBO_Std
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Lambda_Free_KBO_Util.html">Lambda_Free_KBO_Util</a> <a href="../Nested_Multisets_Ordinals/Multiset_More.html">Nested_Multisets_Ordinals.Multiset_More</a>
<span class="keyword2"><span class="keyword">abbrevs</span></span> <span class="quoted">"&gt;t"</span> <span class="main">=</span> <span class="quoted">"&gt;<span class="hidden">⇩</span><sub>t</sub>"</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"≥t"</span> <span class="main">=</span> <span class="quoted">"≥<span class="hidden">⇩</span><sub>t</sub>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory defines the standard version of the graceful Knuth--Bendix order for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>λ›</span></span></span></span>-free
higher-order terms. Standard means that one symbol is allowed to have a weight of 0.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Setup›</span></span>

<span class="keyword1"><span class="command">locale</span></span> kbo_std <span class="main">=</span> kbo_std_basis _ _ <span class="quoted"><span class="free">arity_sym</span></span> <span class="quoted"><span class="free">arity_var</span></span> <span class="quoted"><span class="free">wt_sym</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="free">arity_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> enat"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">arity_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> enat"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">wt_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Weights›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">wt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wt</span> <span class="main">(</span>Hd <span class="free"><span class="bound"><span class="entity">ζ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">w</span><span class="main">.</span> <span class="main">∃</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="free"><span class="bound"><span class="entity">ζ</span></span></span><span class="main">.</span> <span class="bound">w</span> <span class="main">=</span> <span class="free">wt_sym</span> <span class="bound">f</span> <span class="main">+</span> the_enat <span class="main">(</span><span class="free">δ</span> <span class="main">*</span> <span class="free">arity_sym</span> <span class="bound">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wt</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">wt</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">-</span> <span class="free">δ</span><span class="main">)</span> <span class="main">+</span> <span class="free">wt</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wt_Hd_Sym<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>Hd <span class="main">(</span>Sym <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">wt_sym</span> <span class="free">f</span> <span class="main">+</span> the_enat <span class="main">(</span><span class="free">δ</span> <span class="main">*</span> <span class="free">arity_sym</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> exists_wt_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="free">ζ</span><span class="main">.</span> wt <span class="main">(</span>Hd <span class="free">ζ</span><span class="main">)</span> <span class="main">=</span> <span class="free">wt_sym</span> <span class="bound">f</span> <span class="main">+</span> the_enat <span class="main">(</span><span class="free">δ</span> <span class="main">*</span> <span class="free">arity_sym</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Least_in_nonempty_set_imp_ex<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wt_le_wt_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> ground_heads <span class="free">ζ</span> <span class="main">⟹</span> wt <span class="main">(</span>Hd <span class="free">ζ</span><span class="main">)</span> <span class="main">≤</span> <span class="free">wt_sym</span> <span class="free">f</span> <span class="main">+</span> the_enat <span class="main">(</span><span class="free">δ</span> <span class="main">*</span> <span class="free">arity_sym</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> not_le_imp_less not_less_Least <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> enat_the_enat_δ_times_arity_sym<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>the_enat <span class="main">(</span><span class="free">δ</span> <span class="main">*</span> <span class="free">arity_sym</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">δ</span> <span class="main">*</span> <span class="free">arity_sym</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> arity_sym_ne_infinity_if_δ_gt_0 imult_is_infinity zero_enat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> wt_arg_le<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>arg <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> wt <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wt_ge_ε<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="free">s</span> <span class="main">≥</span> <span class="free">ε</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> exists_wt_sym of_nat_eq_enat le_diff_conv of_nat_id wt_sym_ge<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_increasing<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wt_ge_δ<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="free">s</span> <span class="main">≥</span> <span class="free">δ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> δ_le_ε order.trans enat_ord_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> wt_ge_ε<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wt_gt_δ_if_superunary<span class="main">:</span> <span class="quoted"><span class="quoted">"arity_hd <span class="main">(</span>head <span class="free">s</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟹</span> wt <span class="free">s</span> <span class="main">&gt;</span> <span class="free">δ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> ζ<span class="main">:</span> <span class="main">(</span>Hd <span class="skolem">ζ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    g_in_grs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> ground_heads <span class="skolem">ζ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    wt_ζ<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>Hd <span class="skolem">ζ</span><span class="main">)</span> <span class="main">=</span> <span class="free">wt_sym</span> <span class="skolem">g</span> <span class="main">+</span> the_enat <span class="main">(</span><span class="free">δ</span> <span class="main">*</span> <span class="free">arity_sym</span> <span class="skolem">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exists_wt_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arity_hd <span class="skolem">ζ</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ζ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> ary_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">arity_sym</span> <span class="skolem">g</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ground_heads_arity<span class="main">[</span><span class="operator">OF</span> g_in_grs<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ε_gt_0 gr0I leD wt_ge_ε<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> δ_ne_0<span class="main">:</span> False
    <span class="keyword1"><span class="command">hence</span></span> ary_g_ninf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">arity_sym</span> <span class="skolem">g</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> arity_sym_ne_infinity_if_δ_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">&lt;</span> the_enat <span class="main">(</span>enat <span class="free">δ</span> <span class="main">*</span> <span class="free">arity_sym</span> <span class="skolem">g</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> δ_ne_0 ary_g <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">arity_sym</span> <span class="skolem">g</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> one_enat_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> wt_ζ <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> wt_ge_δ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wt_App_δ<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> wt <span class="free">t</span> <span class="main">⟹</span> wt <span class="free">s</span> <span class="main">=</span> <span class="free">δ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order.antisym wt_ge_δ<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wt_App_ge_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">≥</span> wt <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_le_mono2 wt_ge_δ le_diff_conv wt.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wt_hd_le<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>Hd <span class="main">(</span>head <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> wt <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> head_App leD le_less_trans not_le_imp_less wt_App_ge_fun<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wt_δ_imp_δ_eq_ε<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="free">s</span> <span class="main">=</span> <span class="free">δ</span> <span class="main">⟹</span> <span class="free">δ</span> <span class="main">=</span> <span class="free">ε</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> δ_le_ε le_antisym wt_ge_ε<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wt_ge_arity_head_if_δ_gt_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> δ_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wt <span class="free">s</span> <span class="main">≥</span> arity_hd <span class="main">(</span>head <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hd <span class="skolem">ζ</span><span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    f_in_ζ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> ground_heads <span class="skolem">ζ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    wt_ζ<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>Hd <span class="skolem">ζ</span><span class="main">)</span> <span class="main">=</span> <span class="free">wt_sym</span> <span class="skolem">f</span> <span class="main">+</span> the_enat <span class="main">(</span><span class="free">δ</span> <span class="main">*</span> <span class="free">arity_sym</span> <span class="skolem">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exists_wt_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">arity_sym</span> <span class="skolem">f</span> <span class="main">≥</span> arity_hd <span class="skolem">ζ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ground_heads_arity<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f_in_ζ<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"the_enat <span class="main">(</span><span class="free">δ</span> <span class="main">*</span> <span class="free">arity_sym</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">≥</span> arity_hd <span class="skolem">ζ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> δ_gt_0
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_ile_eq dual_order.trans enat_ord_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
      enat_the_enat_δ_times_arity_sym i0_lb mult.commute mult.right_neutral mult_left_mono
      one_enat_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wt_ζ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.left_neutral add_mono le_iff_add plus_enat_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tm.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> App
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.trans enat_ord_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> head_App wt_App_ge_fun<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wt_ge_num_args_if_δ_eq_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> δ_eq_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wt <span class="free">s</span> <span class="main">≥</span> num_args <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> δ_eq_0 ε_gt_0 wt_δ_imp_δ_eq_ε add_le_same_cancel1 le_0_eq le_trans
      minus_nat.diff_0 not_gr_zero not_less_eq_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wt_ge_num_args<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">s</span> <span class="main">⟹</span> wt <span class="free">s</span> <span class="main">≥</span> num_args <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wt_ge_arity_head_if_δ_gt_0 wt_ge_num_args_if_δ_eq_0
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> order.trans enat_ord_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> neq0_conv wary_num_args_le_arity_head<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inductive Definitions›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">gt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  gt_wt<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⊇#</span> vars_mset <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> wt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">&gt;</span> wt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> gt_unary<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> wt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="main">¬</span> head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">≤≥<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> num_args <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free">arity_sym</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">wt_sym</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> arg <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> arg <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> gt_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⊇#</span> vars_mset <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> wt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> wt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> gt_same<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⊇#</span> vars_mset <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> wt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> wt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span></span> <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">≥<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">gt_wt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  gt_wtI<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⊇#</span> vars_mset <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> wt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">&gt;</span> wt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">gt_wt</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">gt_diff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  gt_diffI<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⊇#</span> vars_mset <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> wt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> wt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">gt_diff</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">gt_unary</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  gt_unaryI<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> wt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="main">¬</span> head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">≤≥<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> num_args <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free">arity_sym</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">wt_sym</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> arg <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">gt_unary</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">gt_same</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  gt_sameI<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⊇#</span> vars_mset <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> wt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> wt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">gt_same</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_iff_wt_unary_diff_same<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟷</span> gt_wt <span class="free">t</span> <span class="free">s</span> <span class="main">∨</span> gt_unary <span class="free">t</span> <span class="free">s</span> <span class="main">∨</span> gt_diff <span class="free">t</span> <span class="free">s</span> <span class="main">∨</span> gt_same <span class="free">t</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gt.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gt_wt.simps gt_unary.simps gt_diff.simps gt_same.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gt_imp_vars_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> vars_mset <span class="free">t</span> <span class="main">⊇#</span> vars_mset <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gt.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_mset.order.trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gt_imp_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> vars <span class="free">t</span> <span class="main">⊇</span> vars <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> set_mset_mono<span class="main">[</span><span class="operator">OF</span> gt_imp_vars_mset<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Irreflexivity›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">s</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"size <span class="free">s</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> wary_s <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> s_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> s_gt_s
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gt.cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> gt_same
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> wary_s ih <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wary_args extf_irrefl size_in_args<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_hd_def gt_hd_irrefl<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transitivity›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_imp_wt_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> wt <span class="free">t</span> <span class="main">≥</span> wt <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gt.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> not_extf_gt_nil_singleton_if_δ_eq_ε<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wary_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> δ_eq_ε<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> <span class="free">ε</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">extf</span> <span class="free">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">[]</span> <span class="main">[</span><span class="free">s</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> nil_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="free">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">[]</span> <span class="main">[</span><span class="free">s</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> s_gt_nil <span class="main">=</span> extf_singleton_nil_if_δ_eq_ε<span class="main">[</span><span class="operator">OF</span> δ_eq_ε<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted">gt</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">extf</span> <span class="free">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> extf_irrefl<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="free">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> extf_trans_from_irrefl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ _ _ _ _ nil_gt_s s_gt_nil<span class="main">]</span> gt_irrefl<span class="main">[</span><span class="operator">OF</span> wary_s<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_sub_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> App <span class="free">s</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">size</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> wary_st <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> wt_st<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>App <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> wt <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> δ_eq_ε<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> <span class="free">ε</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wt_App_δ wt_δ_imp_δ_eq_ε <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> δ_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ε_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> wt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="skolem">s</span> <span class="main">=</span> <span class="free">δ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wt_App_δ<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_st<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span>
      wary_t<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      nargs_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"num_args <span class="skolem">s</span> <span class="main">&lt;</span> arity_hd <span class="main">(</span>head <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wary_st wary.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> ary_hd_s<span class="main">:</span> <span class="quoted"><span class="quoted">"arity_hd <span class="main">(</span>head <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def arity.wary_AppE dual_order.order_iff_strict eSuc_enat enat_defs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
        enat_defs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ileI1 linorder_not_le not_iless0 wary_st wt_gt_δ_if_superunary wt_s<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> nargs_s<span class="main">:</span> <span class="quoted"><span class="quoted">"num_args <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> enat_ord_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_one nargs_lt one_enat_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> Hd <span class="main">(</span>head <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Hd_head_id nargs_s<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      f_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      wt_f_etc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wt_sym</span> <span class="skolem">f</span> <span class="main">+</span> the_enat <span class="main">(</span><span class="free">δ</span> <span class="main">*</span> <span class="free">arity_sym</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">δ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> exists_wt_sym wt_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="keyword1"><span class="command">have</span></span> ary_f_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">arity_sym</span> <span class="skolem">f</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> ary_f_ge_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">arity_sym</span> <span class="skolem">f</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ary_hd_s f_in ground_heads_arity <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">δ</span> <span class="main">*</span> <span class="free">arity_sym</span> <span class="skolem">f</span> <span class="main">=</span> <span class="free">δ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wt_f_etc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> enat_ord_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> enat_the_enat_δ_times_arity_sym le_add2
          le_antisym mult.right_neutral mult_left_mono zero_le<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> δ_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">arity_sym</span> <span class="skolem">f</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> one_enat_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> wt_f_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wt_sym</span> <span class="skolem">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wt_f_etc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> hd_s_ncmp_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> head <span class="skolem">s</span> <span class="keyword1">≤≥<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_unary<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_st<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hd_s_ncmp_t nargs_s <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> f_in ary_f_1 wt_f_0<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> hd_s_gt_t<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hd_s_gt_t wt_s<span class="main"><span class="main">[</span></span><span class="operator">folded</span> δ_eq_ε<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> ary_f_1 exists_wt_sym f_in gt_hd_def gt_sym_antisym unary_wt_sym_0_gt wt_f_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> hd_t_eq_s<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">t</span> <span class="main">=</span> head <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> nargs_t_le<span class="main">:</span> <span class="quoted"><span class="quoted">"num_args <span class="skolem">t</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ary_hd_s wary_num_args_le_arity_head<span class="main">[</span><span class="operator">OF</span> wary_t<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_enat_def<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> extf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">[</span><span class="skolem">t</span><span class="main">]</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"args <span class="skolem">t</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extf_singleton_nil_if_δ_eq_ε<span class="main"><span class="main">[</span></span><span class="operator">OF</span> δ_eq_ε<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> args_t<span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">ta</span> <span class="skolem">ts</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ary_hd_s<span class="main">[</span><span class="operator">folded</span> hd_t_eq_s<span class="main">]</span> wary_num_args_le_arity_head<span class="main">[</span><span class="operator">OF</span> wary_t<span class="main">]</span>
            nargs_t_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> ta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ta</span> <span class="main">=</span> arg <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> apps.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> apps.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> args_t tm.sel<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> tm_collapse_apps ts<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> App <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span> <span class="skolem">ta</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> args.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> args_t not_Cons_self2 tm.exhaust_sel ts<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">ta</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ta</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"fun <span class="skolem"><span class="skolem"><span class="skolem">t</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">folded</span> t<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ wary_t<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> ta size_arg_lt t tm.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> args_t ts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> extf_singleton gt_irrefl wary_t<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hd_t_eq_s wt_s<span class="main"><span class="main">[</span></span><span class="operator">folded</span> δ_eq_ε<span class="main"><span class="main">]</span></span> length_0_conv<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> nargs_s<span class="main"><span class="main">]</span></span> extf<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> comp_hd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> gt_wt <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">s</span> <span class="main">⟹</span> is_App <span class="free">s</span> <span class="main">⟹</span> <span class="free">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> arg <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gt_sub_arg<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> gt_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">u</span> <span class="main">⟹</span> wary <span class="free">t</span> <span class="main">⟹</span> wary <span class="free">s</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> atomize_imp<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">{#</span></span>size <span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">,</span></span> size <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> size <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">#}</span></span>"</span></span></span>
        <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> wary <span class="bound"><span class="bound">u</span></span> <span class="main"><span class="main">⟶</span></span> wary <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">⟶</span></span> wary <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟶</span></span> <span class="bound"><span class="bound">u</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">⟶</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟶</span></span> <span class="bound"><span class="bound">u</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">u</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">t</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span>
      <span class="operator">simplified</span> prod.case<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all prod.case atomize_imp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">t</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span>
    ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ua</span> <span class="bound">ta</span> <span class="bound">sa</span><span class="main">.</span> <span class="main">{#</span>size <span class="bound">ua</span><span class="main">,</span> size <span class="bound">ta</span><span class="main">,</span> size <span class="bound">sa</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span>size <span class="skolem">u</span><span class="main">,</span> size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span> <span class="main">⟹</span>
      wary <span class="bound">ua</span> <span class="main">⟹</span> wary <span class="bound">ta</span> <span class="main">⟹</span> wary <span class="bound">sa</span> <span class="main">⟹</span> <span class="bound">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">ta</span> <span class="main">⟹</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span> <span class="main">⟹</span> <span class="bound">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    wary_u<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wary_t<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wary_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    u_gt_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars_mset <span class="skolem">u</span> <span class="main">⊇#</span> vars_mset <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"vars_mset <span class="skolem">t</span> <span class="main">⊇#</span> vars_mset <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> u_gt_t t_gt_s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gt_imp_vars_mset<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> vars_u_s<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="skolem">u</span> <span class="main">⊇#</span> vars_mset <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> wt_u_ge_t<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="skolem">u</span> <span class="main">≥</span> wt <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wt_t_ge_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="skolem">t</span> <span class="main">≥</span> wt <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gt_imp_wt_ge u_gt_t t_gt_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> wt_t_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="skolem">t</span> <span class="main">=</span> wt <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wt_u_t<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="skolem">u</span> <span class="main">=</span> wt <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> wt_u_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="skolem">u</span> <span class="main">=</span> wt <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> wary_arg_u<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="main">(</span>arg <span class="skolem">u</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wary_arg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_u<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> wary_arg_t<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="main">(</span>arg <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wary_arg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_t<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> wary_arg_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="main">(</span>arg <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wary_arg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_s<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t_gt_s
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> gt_unary_t_s<span class="main">:</span> gt_unary

      <span class="keyword1"><span class="command">have</span></span> t_app<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> args_Nil_iff_is_Hd gt_unary_t_s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> length_greater_0_conv less_numeral_extra<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> δ_eq_ε<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> <span class="free">ε</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_unary_t_s<span class="main">(</span>4<span class="main">)</span> unary_wt_sym_0_imp_δ_eq_ε <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> u_gt_t
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> gt_unary_u_t<span class="main">:</span> gt_unary
        <span class="keyword1"><span class="command">have</span></span> u_app<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> args_Nil_iff_is_Hd gt_unary_u_t<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> length_greater_0_conv less_numeral_extra<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> arg_u_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> gt_unary_u_t<span class="main">(</span>5<span class="main">)</span> t_gt_s size_arg_lt wary_arg_u wary_s wary_t
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">hence</span></span> arg_u_ge_s<span class="main">:</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>

        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>arg <span class="skolem">u</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> arg_u_gt_s gt_arg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> u_app wary_arg_u wary_s wary_u<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>arg <span class="skolem">t</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> arg <span class="skolem">t</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">t</span>"</span></span><span class="main">]</span> args_Nil_iff_is_Hd gt_arg gt_unary_t_s<span class="main">(</span>3<span class="main">)</span> u_gt_t wary_t wary_u
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> args_Nil_iff_is_Hd gt_unary_t_s<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> size_arg_lt wary_arg_t
              wary_s wary_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> sz_u_gt_t<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="skolem">u</span> <span class="main">&gt;</span> size <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sz_t_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="skolem">t</span> <span class="main">&gt;</span> size <span class="skolem">s</span>"</span></span>

          <span class="keyword1"><span class="command">have</span></span> wt_fun_u<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>fun <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> <span class="free">δ</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> antisym gt_imp_wt_ge gt_unary_u_t<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> u_app wt_App_δ wt_arg_le
              wt_t_s wt_u_s<span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span> nargs_fun_u<span class="main">:</span> <span class="quoted"><span class="quoted">"num_args <span class="main">(</span>fun <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> args.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> gt_unary_u_t<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> one_arg_imp_Hd tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
              u_app<span class="main">)</span>

          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> hd_u_eq_s<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="main">=</span> head <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> ary_hd_s<span class="main">:</span> <span class="quoted"><span class="quoted">"arity_hd <span class="main">(</span>head <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> ground_heads_arity gt_unary_u_t<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> hd_u_eq_s one_enat_def
                wary_num_args_le_arity_head wary_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

            <span class="keyword1"><span class="command">have</span></span> extf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"args <span class="skolem">s</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> Nil
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Hd_head_id δ_eq_ε append_Nil args.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> extf_singleton_nil_if_δ_eq_ε
                  gt_unary_u_t<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> head_fun length_greater_0_conv less_irrefl_nat nargs_fun_u
                  tm.exhaust_sel zero_neq_one<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> args_s<span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">sa</span> <span class="skolem">ss</span><span class="main">)</span>
              <span class="keyword1"><span class="command">hence</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> One_nat_def antisym_conv ary_hd_s diff_Suc_1
                  enat_ord_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> le_add2 length_0_conv length_Cons list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> one_enat_def
                  wary_num_args_le_arity_head wary_s<span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> sa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">=</span> arg <span class="skolem">s</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> apps.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> apps.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> args_s tm.sel<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> tm_collapse_apps ss<span class="main">)</span>

              <span class="keyword1"><span class="command">have</span></span> s_app<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="skolem">s</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> args_Nil_iff_is_Hd args_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
              <span class="keyword1"><span class="command">have</span></span> args_u<span class="main">:</span> <span class="quoted"><span class="quoted">"args <span class="skolem">u</span> <span class="main">=</span> <span class="main">[</span>arg <span class="skolem">u</span><span class="main">]</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil args.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> args_Nil_iff_is_Hd gt_unary_u_t<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> length_0_conv
                  nargs_fun_u tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> zero_neq_one<span class="main">)</span>

              <span class="keyword1"><span class="command">have</span></span> max_sz_u_t_s<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="main">{</span>size <span class="skolem">s</span><span class="main">,</span> size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">u</span><span class="main">}</span> <span class="main">=</span> size <span class="skolem">u</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> sz_t_gt_s sz_u_gt_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

              <span class="keyword1"><span class="command">have</span></span> max_sz_arg_u_t_arg_t<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="main">{</span>size <span class="main">(</span>arg <span class="skolem">t</span><span class="main">)</span><span class="main">,</span> size <span class="skolem">t</span><span class="main">,</span> size <span class="main">(</span>arg <span class="skolem">u</span><span class="main">)</span><span class="main">}</span> <span class="main">&lt;</span> size <span class="skolem">u</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> size_arg_lt sz_u_gt_t t_app u_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span>size <span class="main">(</span>arg <span class="skolem">u</span><span class="main">)</span><span class="main">,</span> size <span class="skolem">t</span><span class="main">,</span> size <span class="main">(</span>arg <span class="skolem">t</span><span class="main">)</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span>size <span class="skolem">u</span><span class="main">,</span> size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> max_sz_arg_u_t_arg_t
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Max_lt_imp_lt_mset insert_commute max_sz_u_t_s<span class="main">)</span>
              <span class="keyword1"><span class="command">hence</span></span> arg_u_gt_arg_t<span class="main">:</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> arg <span class="skolem">t</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">OF</span> _ wary_arg_u wary_t wary_arg_t<span class="main">]</span> args_Nil_iff_is_Hd gt_arg
                  gt_unary_t_s<span class="main">(</span>3<span class="main">)</span> gt_unary_u_t<span class="main">(</span>5<span class="main">)</span> wary_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

              <span class="keyword1"><span class="command">have</span></span> max_sz_arg_s_s_arg_t<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="main">{</span>size <span class="main">(</span>arg <span class="skolem">s</span><span class="main">)</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">,</span> size <span class="main">(</span>arg <span class="skolem">t</span><span class="main">)</span><span class="main">}</span> <span class="main">&lt;</span> size <span class="skolem">u</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> s_app t_app size_arg_lt sz_t_gt_s sz_u_gt_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span>size <span class="main">(</span>arg <span class="skolem">t</span><span class="main">)</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">,</span> size <span class="main">(</span>arg <span class="skolem">s</span><span class="main">)</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span>size <span class="skolem">u</span><span class="main">,</span> size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> add_mset_lt_lt_lt less_trans mset_lt_single_iff s_app size_arg_lt
                  sz_t_gt_s sz_u_gt_t t_app<span class="main">)</span>
              <span class="keyword1"><span class="command">hence</span></span> arg_t_gt_arg_s<span class="main">:</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> arg <span class="skolem">s</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">OF</span> _ wary_arg_t wary_s wary_arg_s<span class="main">]</span>
                  gt_unary_t_s<span class="main">(</span>5<span class="main">)</span> gt_arg args_Nil_iff_is_Hd args_s wary_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> arg <span class="skolem">s</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">s</span>"</span></span><span class="main">]</span> arg_u_gt_arg_t arg_t_gt_arg_s
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_mset_lt_le_lt less_imp_le_nat s_app size_arg_lt t_app u_app
                  wary_arg_s wary_arg_t wary_arg_u<span class="main">)</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> args_u args_s ss sa <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> extf_singleton gt_irrefl wary_arg_u<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>

            <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_u_s wt_u_s hd_u_eq_s<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extf<span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_u_s wt_u_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">u</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
              <span class="keyword1"><span class="command">using</span></span> gt_hd_def gt_hd_irrefl gt_sym_antisym gt_unary_u_t<span class="main">(</span>4<span class="main">)</span> unary_wt_sym_0_gt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> head <span class="skolem">u</span> <span class="keyword1">≤≥<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_unary<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_u_s _ gt_unary_u_t<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span> arg_u_ge_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> comp_hd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> args_Nil_iff_is_Hd dual_order.strict_trans2 gt_unary_t_s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> gt_unary_u_t<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
            length_0_conv not_le_imp_less size_arg_lt zero_neq_one<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> gt_diff_u_t<span class="main">:</span> gt_diff
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> gt_diff_u_t<span class="main">(</span>3<span class="main">)</span> gt_hd_def gt_hd_irrefl gt_sym_antisym gt_unary_t_s<span class="main">(</span>4<span class="main">)</span>
            unary_wt_sym_0_gt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> gt_same_u_t<span class="main">:</span> gt_same

        <span class="keyword1"><span class="command">have</span></span> hd_u_ncomp_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> head <span class="skolem">u</span> <span class="keyword1">≤≥<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_unary_t_s<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">folded</span> gt_same_u_t<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"num_args <span class="skolem">u</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> enat_ord_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ground_heads_arity gt_same_u_t<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> gt_unary_t_s<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> one_enat_def
            order_trans wary_num_args_le_arity_head wary_u<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> nargs_u<span class="main">:</span> <span class="quoted"><span class="quoted">"num_args <span class="skolem">u</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"args <span class="skolem">u</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
            <span class="operator">metis</span> Hd_head_id δ_eq_ε append_Nil args.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> gt_same_u_t<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> gt_unary_t_s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span>
              head_fun list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_extf_gt_nil_singleton_if_δ_eq_ε one_arg_imp_Hd
              tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> t_app<span class="main"><span class="main">]</span></span> wary_arg_t<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">simp</span><span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> arg <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> extf_singleton<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span> append_Nil args.simps args_Nil_iff_is_Hd
            comp_hd_def gt_hd_def gt_irrefl gt_same_u_t<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> gt_unary_t_s<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> head_fun
            length_0_conv nargs_u one_arg_imp_Hd t_app tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> u_gt_t wary_u<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">OF</span> _ wary_arg_u wary_arg_t wary_s<span class="main">]</span> gt_unary_t_s<span class="main">(</span>5<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mset_lt_left_lt add_mset_lt_lt_lt args_Nil_iff_is_Hd list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nargs_u
            size_arg_lt t_app zero_neq_one<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> arg_u_ge_s<span class="main">:</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_unary<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_u_s hd_u_ncomp_s nargs_u _ arg_u_ge_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gt_same_u_t<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> gt_unary_t_s<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_u_t<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt_diff_t_s<span class="main">:</span> gt_diff
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> u_gt_t
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> gt_unary_u_t<span class="main">:</span> gt_unary
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_App <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> args_Nil_iff_is_Hd gt_unary_u_t<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> length_greater_0_conv less_numeral_extra<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> gt_unary_u_t<span class="main">(</span>5<span class="main">)</span> t_gt_s size_arg_lt wary_arg_u wary_s wary_t
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">hence</span></span> arg_u_ge_s<span class="main">:</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>

        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="main">=</span> head <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">using</span></span> gt_diff_t_s<span class="main">(</span>3<span class="main">)</span> gt_unary_u_t<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> comp_hd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">using</span></span> gt_hd_def gt_hd_irrefl gt_sym_antisym gt_unary_u_t<span class="main">(</span>4<span class="main">)</span> unary_wt_sym_0_gt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_u_s wt_u_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> head <span class="skolem">u</span> <span class="keyword1">≤≥<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_unary<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_u_s _ gt_unary_u_t<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span> arg_u_ge_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> comp_hd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> gt_diff_u_t<span class="main">:</span> gt_diff
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> gt_diff_u_t<span class="main">(</span>3<span class="main">)</span> gt_diff_t_s<span class="main">(</span>3<span class="main">)</span> gt_hd_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_u_s wt_u_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> gt_same_u_t<span class="main">:</span> gt_same
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> gt_diff_t_s<span class="main">(</span>3<span class="main">)</span> gt_same_u_t<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_u_s wt_u_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_u_t<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt_same_t_s<span class="main">:</span> gt_same
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> u_gt_t
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> gt_unary_u_t<span class="main">:</span> gt_unary
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_App <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> args_Nil_iff_is_Hd gt_unary_u_t<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> length_greater_0_conv less_numeral_extra<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> gt_unary_u_t<span class="main">(</span>5<span class="main">)</span> t_gt_s size_arg_lt wary_arg_u wary_s wary_t
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">hence</span></span> arg_u_ge_s<span class="main">:</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> head <span class="skolem">u</span> <span class="keyword1">≤≥<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> gt_same_t_s<span class="main">(</span>3<span class="main">)</span> gt_unary_u_t<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_unary<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_u_s _ gt_unary_u_t<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span> arg_u_ge_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> gt_diff_u_t<span class="main">:</span> gt_diff
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> gt_diff_u_t<span class="main">(</span>3<span class="main">)</span> gt_same_t_s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_u_s wt_u_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> gt_same_u_t<span class="main">:</span> gt_same
        <span class="keyword1"><span class="command">have</span></span> hd_u_s<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="main">=</span> head <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> gt_same_t_s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> gt_same_u_t<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>args <span class="skolem">u</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>

        <span class="keyword1"><span class="command">have</span></span> gt_trans_args<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ua</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ta</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">sa</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="bound">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">ta</span> <span class="main">⟶</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span> <span class="main">⟶</span> <span class="bound">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="skolem">ta</span> <span class="skolem">ua</span>
          <span class="keyword3"><span class="command">assume</span></span>
            ua_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ua</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ta_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ta</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sa_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            ua_gt_ta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">ta</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ta_gt_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">sa</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> wary_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="skolem">sa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wary_ta<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="skolem">ta</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wary_ua<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="skolem">ua</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> wary_args ua_in ta_in sa_in wary_u wary_t wary_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">sa</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ih<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Max_lt_imp_lt_mset wary_ua wary_ta wary_sa ua_gt_ta ta_gt_sa<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="main">(</span><span class="operator">meson</span> ua_in ta_in sa_in Un_iff max.strict_coboundedI1 max.strict_coboundedI2
                 size_in_args<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="skolem">u</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> extf_trans_from_irrefl<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?S</span></span></span></span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"args <span class="skolem"><span class="skolem"><span class="skolem">t</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _ _ _ _ gt_trans_args<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gt_same_u_t<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> gt_same_t_s<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> wary_args wary_u wary_t wary_s gt_irrefl<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_u_s wt_u_s hd_u_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_u_t<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_t_s<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vars_u_s wt_t_ge_s wt_u_ge_t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gt_wt<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_antisym<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">s</span> <span class="main">⟹</span> wary <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gt_irrefl gt_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Subterm Property›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_sub_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"App <span class="free">s</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">&gt;</span> wt <span class="free">s</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> gt_wt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> wt_st<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> wt <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> order.antisym not_le_imp_less wt_App_ge_fun<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> δ_eq_ε<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> <span class="free">ε</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_left' diff_diff_cancel wt_δ_imp_δ_eq_ε wt_ge_δ wt.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> vars_st<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊇#</span> vars_mset <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> hd_st<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> head <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> extf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> δ_eq_ε extf_snoc_if_δ_eq_ε<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_st wt_st hd_st extf<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_proper_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">t</span> <span class="main">⟹</span> proper_sub <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gt_sub_fun gt_sub_arg gt_trans sub.intros wary_sub<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Compatibility with Functions›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_compat_fun<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    wary_t<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    t'_gt_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"App <span class="free">s</span> <span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> App <span class="free">s</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> vars_st'<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="main">(</span>App <span class="free">s</span> <span class="free">t'</span><span class="main">)</span> <span class="main">⊇#</span> vars_mset <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t'_gt_t gt_imp_vars_mset<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"wt <span class="free">t'</span> <span class="main">&gt;</span> wt <span class="free">t</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> wt_st'<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t'</span><span class="main">)</span> <span class="main">&gt;</span> wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> wt.simps<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_wt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_st' wt_st'<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wt <span class="free">t'</span> <span class="main">=</span> wt <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t'_gt_t gt_imp_wt_ge order.not_eq_order_implies_strict <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> wt_st'<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> wt.simps<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> head_st'<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="main">(</span>App <span class="free">s</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> head <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> extf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="free">s</span> <span class="main">@</span> <span class="main">[</span><span class="free">t'</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>args <span class="free">s</span> <span class="main">@</span> <span class="main">[</span><span class="free">t</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t'_gt_t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> extf_compat_list gt_irrefl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_t<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_st' wt_st' head_st'<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extf<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Compatibility with Arguments›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_compat_arg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wary_s't<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="main">(</span>App <span class="free">s'</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s'_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"App <span class="free">s'</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> App <span class="free">s</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> vars_s't<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="main">(</span>App <span class="free">s'</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊇#</span> vars_mset <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s'_gt_s gt_imp_vars_mset<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> s'_gt_s
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> gt_wt_s'_s<span class="main">:</span> gt_wt
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>App <span class="free">s'</span> <span class="free">t</span><span class="main">)</span> <span class="main">&gt;</span> wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_ge_δ<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> add_diff_assoc add_less_cancel_right gt_wt_s'_s<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> wt_ge_δ<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_wt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_s't<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_unary_s'_s<span class="main">:</span> gt_unary
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ground_heads_arity gt_unary_s'_s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> gt_unary_s'_s<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> leD one_enat_def wary_AppE
        wary_s't<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> _<span class="main">:</span> gt_diff
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gt_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_same_s'_s<span class="main">:</span> gt_same
    <span class="keyword1"><span class="command">have</span></span> wt_s't<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>App <span class="free">s'</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gt_same_s'_s<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> hd_s't<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="main">(</span>App <span class="free">s'</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> head <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gt_same_s'_s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="main">(</span>App <span class="free">s'</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="main">(</span>App <span class="free">s'</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gt_same_s'_s<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> extf_compat_append_right<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_s't wt_s't hd_s't<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Stability under Substitution›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">extra_wt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">extra_wt</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈#</span> vars_mset <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">.</span> wt <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> wt <span class="main">(</span>Hd <span class="main">(</span>Var <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  extra_wt_Var<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"extra_wt <span class="free">ρ</span> <span class="main">(</span>Hd <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> wt <span class="main">(</span><span class="free">ρ</span> <span class="free">x</span><span class="main">)</span> <span class="main">-</span> wt <span class="main">(</span>Hd <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  extra_wt_Sym<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"extra_wt <span class="free">ρ</span> <span class="main">(</span>Hd <span class="main">(</span>Sym <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  extra_wt_App<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"extra_wt <span class="free">ρ</span> <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> extra_wt <span class="free">ρ</span> <span class="free">s</span> <span class="main">+</span> extra_wt <span class="free">ρ</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> extra_wt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extra_wt_subseteq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> vars_s<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="free">t</span> <span class="main">⊇#</span> vars_mset <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extra_wt <span class="free">ρ</span> <span class="free">t</span> <span class="main">≥</span> extra_wt <span class="free">ρ</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> extra_wt_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?diff</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span><span class="main">.</span> wt <span class="main">(</span><span class="free">ρ</span> <span class="bound">v</span><span class="main">)</span> <span class="main">-</span> wt <span class="main">(</span>Hd <span class="main">(</span>Var <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars_mset <span class="free">s</span> <span class="main">+</span> <span class="main">(</span>vars_mset <span class="free">t</span> <span class="main">-</span> vars_mset <span class="free">s</span><span class="main">)</span> <span class="main">=</span> vars_mset <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vars_s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> subset_mset.add_diff_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="var">?diff</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈#</span> vars_mset <span class="free">t</span><span class="main">#}</span> <span class="main">=</span>
    <span class="main">{#</span><span class="var">?diff</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈#</span> vars_mset <span class="free">s</span><span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span><span class="var">?diff</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈#</span> vars_mset <span class="free">t</span> <span class="main">-</span> vars_mset <span class="free">s</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_mset_union<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">v</span> <span class="main">∈#</span> vars_mset <span class="free">t</span><span class="main">.</span> <span class="var">?diff</span> <span class="bound">v</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span><span class="main">∑</span><span class="bound">v</span> <span class="main">∈#</span> vars_mset <span class="free">s</span><span class="main">.</span> <span class="var">?diff</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wt_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wary_ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"wary_subst <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wary_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> wt <span class="free">s</span> <span class="main">+</span> extra_wt <span class="free">ρ</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wary_s
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tm.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> ζ<span class="main">:</span> <span class="main">(</span>Hd <span class="skolem">ζ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ζ</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> x<span class="main">:</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ξ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"head <span class="main">(</span><span class="free">ρ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      g_in_grs_ξ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> ground_heads <span class="var">?ξ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      wt_ξ<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>Hd <span class="var">?ξ</span><span class="main">)</span> <span class="main">=</span> <span class="free">wt_sym</span> <span class="skolem">g</span> <span class="main">+</span> the_enat <span class="main">(</span><span class="free">δ</span> <span class="main">*</span> <span class="free">arity_sym</span> <span class="skolem">g</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> exists_wt_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> ground_heads <span class="skolem">ζ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x g_in_grs_ξ wary_ρ wary_subst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> wt_ρx_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span><span class="free">ρ</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≥</span> wt <span class="main">(</span>Hd <span class="skolem">ζ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> dual_order.trans wt_le_wt_sym wt_ξ wt_hd_le<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extra_wt_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih_s <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> ih_t <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> wary_st <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wary <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wary_st <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> wary_AppE<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> extra_wt <span class="free">ρ</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span>wt <span class="skolem">s</span> <span class="main">-</span> <span class="free">δ</span> <span class="main">+</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> wt <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">-</span> <span class="free">δ</span> <span class="main">+</span> <span class="bound">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ih_s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> add_diff_assoc2 ab_semigroup_add_class.add_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
      add.left_commute wt_ge_δ<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"extra_wt <span class="free">ρ</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span>wt <span class="skolem">s</span> <span class="main">+</span> wt <span class="skolem">t</span> <span class="main">-</span> <span class="free">δ</span> <span class="main">+</span> extra_wt <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> wt <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span> wt <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">-</span> <span class="free">δ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ih_t wary_st
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> add_diff_assoc2 ab_semigroup_add_class.add_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> wary_AppE wt_ge_δ<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_ge_δ<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wary_ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"wary_subst <span class="free">ρ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wary <span class="free">t</span> <span class="main">⟹</span> wary <span class="free">s</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> subst <span class="free">ρ</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> atomize_imp<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">{#</span></span>size <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> size <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">#}</span></span>"</span></span></span>
        <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> wary <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">⟶</span></span> wary <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟶</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟶</span></span> subst <span class="free"><span class="free">ρ</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> subst <span class="free"><span class="free">ρ</span></span> <span class="bound"><span class="bound">s</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">t</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span>
      <span class="operator">simplified</span> prod.case<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all prod.case atomize_imp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span>
    ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ta</span> <span class="bound">sa</span><span class="main">.</span> <span class="main">{#</span>size <span class="bound">ta</span><span class="main">,</span> size <span class="bound">sa</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span>size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span> <span class="main">⟹</span> wary <span class="bound">ta</span> <span class="main">⟹</span> wary <span class="bound">sa</span> <span class="main">⟹</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span> <span class="main">⟹</span>
      subst <span class="free">ρ</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="bound">sa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    wary_t<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wary_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">ρ</span> <span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> wt <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> wt_ρt_ne_ρs<span class="main">:</span> False

    <span class="keyword1"><span class="command">have</span></span> vars_s<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="skolem">t</span> <span class="main">⊇#</span> vars_mset <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_gt_s gt_imp_vars_mset<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> vars_ρs<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">⊇#</span> vars_mset <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vars_mset_subst_subseteq<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> wt_t_ge_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="skolem">t</span> <span class="main">≥</span> wt <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gt_imp_wt_ge t_gt_s<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">&gt;</span> wt <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wt_ρt_ne_ρs <span class="keyword1"><span class="command">unfolding</span></span> wt_subst<span class="main">[</span><span class="operator">OF</span> wary_ρ wary_s<span class="main">]</span> wt_subst<span class="main">[</span><span class="operator">OF</span> wary_ρ wary_t<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_le_cancel_left add_less_le_mono extra_wt_subseteq
        order.not_eq_order_implies_strict vars_s wt_t_ge_s<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_wt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_ρs<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> wt_ρt_eq_ρs<span class="main">:</span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> t_gt_s
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> gt_wt
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> wt_ρt_eq_ρs wary_s wary_t
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_right' diff_le_mono2 extra_wt_subseteq wt_subst leD wary_ρ<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt_unary

      <span class="keyword1"><span class="command">have</span></span> wary_ρt<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wary_subst_wary wary_t wary_ρ<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Hd
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> gt_unary<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> t<span class="main">:</span> <span class="main">(</span>App <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">=</span> arg <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> wary_t2<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="skolem">t2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> wary_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">ρ</span> <span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="skolem">t2</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> gt_sub_arg wary_ρt <span class="keyword1"><span class="command">unfolding</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> t2_ne_s<span class="main">:</span> False
          <span class="keyword1"><span class="command">hence</span></span> t2_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> gt_unary<span class="main">(</span>5<span class="main">)</span> t2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">ρ</span> <span class="skolem">t2</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ wary_t2 wary_s t2_gt_s<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gt_sub_arg gt_trans subst.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> t wary_ρ wary_ρt wary_s wary_subst_wary
              wary_t2<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> _<span class="main">:</span> gt_diff
      <span class="keyword1"><span class="command">note</span></span> vars_s <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> hd_t_gt_hd_s <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> vars_ρs<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">⊇#</span> vars_mset <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vars_mset_subst_subseteq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_s<span class="main"><span class="main">]</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> hd_t_gt_hd_s wary_subst_ground_heads gt_hd_def rev_subsetD wary_ρ<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_ρs wt_ρt_eq_ρs<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> _<span class="main">:</span> gt_same
      <span class="keyword1"><span class="command">note</span></span> vars_s <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> hd_s_eq_hd_t <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> extf <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> vars_ρs<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">⊇#</span> vars_mset <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vars_mset_subst_subseteq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> hd_ρt<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_s_eq_hd_t<span class="main">)</span>

      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
        <span class="keyword3"><span class="command">assume</span></span> f_in_grs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>

        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>

        <span class="keyword1"><span class="command">have</span></span> extf_args_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> extf f_in_grs wary_subst_ground_heads wary_ρ <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>map <span class="main">(</span>subst <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>subst <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> extf_map<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?S</span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _ _ _ _ _ extf_args_s_t<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">¬</span> subst <span class="free">ρ</span> <span class="bound">x</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="bound">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> gt_irrefl wary_t wary_s wary_args wary_ρ wary_subst_wary <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> subst <span class="free">ρ</span> <span class="bound">z</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="bound">y</span> <span class="main">⟶</span> subst <span class="free">ρ</span> <span class="bound">y</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="bound">x</span> <span class="main">⟶</span>
            subst <span class="free">ρ</span> <span class="bound">z</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="bound">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> gt_trans wary_t wary_s wary_args wary_ρ wary_subst_wary <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">have</span></span> sz_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ta</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">sa</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">{#</span>size <span class="bound">ta</span><span class="main">,</span> size <span class="bound">sa</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span>size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Max_lt_imp_lt_mset <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> size_in_args<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="bound">y</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">x</span> <span class="main">⟶</span> subst <span class="free">ρ</span> <span class="bound">y</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="bound">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ih sz_a size_in_args wary_t wary_s wary_args wary_ρ wary_subst_wary <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hd_s_eq_hd_t <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> extf_compat_append_left<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
        <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_ρs wt_ρt_eq_ρs hd_ρt<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Totality on Ground Terms›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_total_ground<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> extf_total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> ext_total <span class="main">(</span><span class="free">extf</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ground <span class="free">t</span> <span class="main">⟹</span> ground <span class="free">s</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">∨</span> <span class="free">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">∨</span> <span class="free">t</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> atomize_imp<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">{#</span></span> size <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> size <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">#}</span></span>"</span></span></span>
      <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> ground <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">⟶</span></span> ground <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟶</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">∨</span></span> <span class="bound"><span class="bound">s</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">∨</span></span> <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">=</span></span> <span class="bound"><span class="bound">s</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">t</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> prod.case<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all prod.case atomize_imp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ta</span> <span class="bound">sa</span><span class="main">.</span> <span class="main">{#</span> size <span class="bound">ta</span><span class="main">,</span> size <span class="bound">sa</span> <span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span> size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span> <span class="main">#}</span> <span class="main">⟹</span> ground <span class="bound">ta</span> <span class="main">⟹</span> ground <span class="bound">sa</span> <span class="main">⟹</span>
      <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span> <span class="main">∨</span> <span class="bound">sa</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">ta</span> <span class="main">∨</span> <span class="bound">ta</span> <span class="main">=</span> <span class="bound">sa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    gr_t<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gr_s<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="skolem">s</span>"</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span> <span class="main">∨</span> <span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span> <span class="main">∨</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span>
    vars_t<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="skolem">t</span> <span class="main">⊇#</span> vars_mset <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    vars_s<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="skolem">s</span> <span class="main">⊇#</span> vars_mset <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> vars_mset_empty_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> gr_s<span class="main"><span class="main">]</span></span>
      vars_mset_empty_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> gr_t<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"wt <span class="skolem">t</span> <span class="main">=</span> wt <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wt <span class="skolem">t</span> <span class="main">&gt;</span> wt <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_wt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_t<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wt <span class="skolem">s</span> <span class="main">&gt;</span> wt <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_wt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> wt_t<span class="main">:</span> True
    <span class="keyword1"><span class="command">note</span></span> wt_s <span class="main">=</span> wt_t<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> ξ<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">t</span> <span class="main">=</span> Sym <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ground_head<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gr_t<span class="main"><span class="main">]</span></span> hd.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> ζ<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">s</span> <span class="main">=</span> Sym <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ground_head<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gr_s<span class="main"><span class="main">]</span></span> hd.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> g_gt_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_t wt_t<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ξ ζ g_gt_f gt_hd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> f_gt_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_s wt_s<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ξ ζ f_gt_g gt_hd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> g_eq_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> hd_t<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">t</span> <span class="main">=</span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ξ ζ <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">note</span></span> hd_s <span class="main">=</span> hd_t<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

      <span class="keyword1"><span class="command">have</span></span> gr_ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gr_t ground_args <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> gr_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gr_s ground_args <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"args <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"args <span class="skolem">s</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?ts</span> <span class="main">=</span> <span class="var">?ss</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> ts_eq_ss<span class="main">:</span> True
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> ξ ζ g_eq_f ts_eq_ss <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tm_expand_apps<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">g</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="var">?ss</span> <span class="main">∨</span> <span class="free">extf</span> <span class="skolem">g</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="var">?ss</span> <span class="var">?ts</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ih gr_ss gr_ts
            ext_total.total<span class="main">[</span><span class="operator">OF</span> extf_total<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="var">?ts</span> <span class="main">∪</span> set <span class="var">?ss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="quoted"><span class="skolem">g</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_commute Un_iff in_lists_iff_set less_multiset_doubletons size_in_args sup_ge2<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> extf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">g</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="var">?ts</span> <span class="var">?ss</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_t wt_t hd_t<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extf ξ<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> extf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">g</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="var">?ss</span> <span class="var">?ts</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_s wt_s hd_s<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> g_eq_f<span class="main"><span class="main">]</span></span> ζ<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> gt_sym_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Well-foundedness›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">gtw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub>)</span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> wary <span class="bound">t</span> <span class="main">∧</span> wary <span class="bound">s</span> <span class="main">∧</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">gtwg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub>)</span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ground_gt_unary<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> gr_t<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> gt_unary <span class="free">t</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> gt_unary_t_s<span class="main">:</span> <span class="quoted"><span class="quoted">"gt_unary <span class="free">t</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gt_iff_wt_unary_diff_same <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> gr_s<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gr_t gt_imp_vars <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> ngr_t_or_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ground <span class="free">t</span> <span class="main">∨</span> <span class="main">¬</span> ground <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gt_unary_t_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ground_head not_comp_hd_imp_Var<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> gr_t gr_s ngr_t_or_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub></span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ground_wfP<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub></span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wfP_iff_no_inf_chain
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> inf_chain <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="bound">f</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_bad<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def bad_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ff</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"worst_chain <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> size <span class="bound">t</span> <span class="main">&gt;</span> size <span class="bound">s</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">note</span></span> wf_sz <span class="main">=</span> wf_app<span class="main">[</span><span class="operator">OF</span> wellorder_class.wf<span class="main">,</span> <span class="operator">of</span> <span class="quoted">size</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

    <span class="keyword1"><span class="command">have</span></span> ffi_ground<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> ground <span class="main">(</span><span class="var">?ff</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ffi_wary<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> wary <span class="main">(</span><span class="var">?ff</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> worst_chain_bad<span class="main">[</span><span class="operator">OF</span> wf_sz t_bad<span class="main">,</span> <span class="operator">unfolded</span> inf_chain_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inf_chain <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="var">?ff</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> worst_chain_bad<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_sz t_bad<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> bad_wt_diff_same<span class="main">:</span>
      <span class="quoted"><span class="quoted">"inf_chain <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span>gt_wt <span class="bound">t</span> <span class="bound">s</span> <span class="main">∨</span> gt_diff <span class="bound">t</span> <span class="bound">s</span> <span class="main">∨</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="var">?ff</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def <span class="keyword1"><span class="command">using</span></span> gt_iff_wt_unary_diff_same ground_gt_unary <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> wf_wt<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_wt <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_app<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">wt</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> wf_less<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gt_wt.simps<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> wt_O_diff_same<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_wt <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>
      <span class="keyword1">O</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span>gt_diff <span class="bound">t</span> <span class="bound">s</span> <span class="main">∨</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_wt <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gt_wt.simps gt_diff.simps gt_same.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> wt_diff_same_as_union<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span>gt_wt <span class="bound">t</span> <span class="bound">s</span> <span class="main">∨</span> gt_diff <span class="bound">t</span> <span class="bound">s</span> <span class="main">∨</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
      <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_wt <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span>gt_diff <span class="bound">t</span> <span class="bound">s</span> <span class="main">∨</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k1</span></span> <span class="keyword2"><span class="keyword">where</span></span> bad_diff_same<span class="main">:</span>
      <span class="quoted"><span class="quoted">"inf_chain <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span>gt_diff <span class="bound">t</span> <span class="bound">s</span> <span class="main">∨</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf_infinite_down_chain_compatible<span class="main">[</span><span class="operator">OF</span> wf_wt _ wt_O_diff_same<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?ff</span></span></span><span class="main">]</span> bad_wt_diff_same
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def wt_diff_same_as_union<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">s</span> <span class="main">∧</span> ground <span class="bound">t</span> <span class="main">∧</span> sym <span class="main">(</span>head <span class="bound">t</span><span class="main">)</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> sym <span class="main">(</span>head <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gt_sym_wf <span class="keyword1"><span class="command">unfolding</span></span> wfP_def wf_iff_no_infinite_down_chain <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_diff <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>
      <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">s</span> <span class="main">∧</span> ground <span class="bound">t</span> <span class="main">∧</span> sym <span class="main">(</span>head <span class="bound">t</span><span class="main">)</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> sym <span class="main">(</span>head <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span>
      <span class="keyword3"><span class="command">assume</span></span> gr_t<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gt_diff_t_s<span class="main">:</span> <span class="quoted"><span class="quoted">"gt_diff <span class="skolem">t</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> gr_s<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_iff_wt_unary_diff_same gt_imp_vars <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> sym <span class="main">(</span>head <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_diff_t_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gt_hd_def gr_s gr_t ground_hd_in_ground_heads<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> wf_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_diff <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_subset<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> diff_O_same<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_diff <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span> <span class="keyword1">O</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>
      <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_diff <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gt_diff.simps gt_same.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> diff_same_as_union<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span>gt_diff <span class="bound">t</span> <span class="bound">s</span> <span class="main">∨</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
      <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_diff <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k2</span></span> <span class="keyword2"><span class="keyword">where</span></span> bad_same<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_chain <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf_infinite_down_chain_compatible<span class="main">[</span><span class="operator">OF</span> wf_diff _ diff_O_same<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k1</span><span class="main">)</span>"</span></span><span class="main">]</span>
        bad_diff_same
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def diff_same_as_union<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> hd_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> is_Sym <span class="main">(</span>head <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ground_head<span class="main">)</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> sym <span class="main">(</span>head <span class="main">(</span><span class="var">?ff</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> hd_eq_f<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Sym <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">unfolding</span></span> f_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hd.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> hd_sym<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">ia</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> bad_same <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def gt_same.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">max_args</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">max_args</span> <span class="main">=</span> wt <span class="main">(</span><span class="var">?ff</span> <span class="skolem">k2</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> wt_eq_max_args<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">max_args</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">unfolding</span></span> max_args_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">ia</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> bad_same <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def gt_same.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> nargs_le_max_args<span class="main">:</span> <span class="quoted"><span class="quoted">"num_args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">max_args</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">unfolding</span></span> wt_eq_max_args<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wt_ge_num_args<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ffi_wary<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U_of</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> set <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?U_of</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> gr_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">⟹</span> ground <span class="bound">u</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> U_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ground_args<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ ffi_ground<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> wary_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">⟹</span> wary <span class="bound">u</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> U_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wary_args<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ ffi_wary<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bad <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> u_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="var">?U_of</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> u_bad<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> sz_u<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="skolem">u</span> <span class="main">&lt;</span> size <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> size_in_args<span class="main"><span class="main">[</span></span><span class="operator">OF</span> u_in<span class="main"><span class="main">]</span></span><span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k2</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> sz_u min_worst_chain_0<span class="main">[</span><span class="operator">OF</span> wf_sz u_bad<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> Suc
        <span class="keyword1"><span class="command">hence</span></span> gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ff</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub></span> <span class="var">?ff</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> worst_chain_pred<span class="main">[</span><span class="operator">OF</span> wf_sz t_bad<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ff</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub></span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> gt gt_proper_sub sub_args sz_u u_in wary_args <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ff</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub></span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> gt_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> Suc sz_u min_worst_chain_Suc<span class="main">[</span><span class="operator">OF</span> wf_sz u_bad<span class="main">]</span> ffi_ground <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> u_good<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">⟹</span> <span class="main">¬</span> bad <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="bound">u</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> U_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gtwu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">∧</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub></span> <span class="bound">s</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> gtwu_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="var">?gtwu</span> <span class="bound">x</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gt_irrefl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">s</span> <span class="main">⟶</span>
      <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">∧</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub></span> <span class="bound">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wary_u <span class="keyword1"><span class="command">unfolding</span></span> U_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span>Suc <span class="bound">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bad_same hd_eq_f <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def gt_same.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">extf</span> <span class="skolem">f</span> <span class="var">?gtwu</span> <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span>Suc <span class="bound">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> extf_mono_strong<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"inf_chain <span class="main">(</span><span class="free">extf</span> <span class="skolem">f</span> <span class="var">?gtwu</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> nwf_ext<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">¬</span> wfP <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">≤</span> <span class="skolem">max_args</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">≤</span> <span class="skolem">max_args</span> <span class="main">∧</span> <span class="free">extf</span> <span class="skolem">f</span> <span class="var">?gtwu</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def wfP_def wf_iff_no_infinite_down_chain <span class="keyword1"><span class="command">using</span></span> nargs_le_max_args <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

    <span class="keyword1"><span class="command">have</span></span> gtwu_le_gtwg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?gtwu</span> <span class="main">≤</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub>)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gr_u<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="var">?gtwu</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> wfP_iff_no_inf_chain
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> exE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
      <span class="keyword3"><span class="command">assume</span></span> bad_f<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_chain <span class="var">?gtwu</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> bad_f0<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="var">?gtwu</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inf_chain_bad<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">0</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bad_f <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bad <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> u_good <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bad <span class="var">?gtwu</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bad_f inf_chain_bad inf_chain_subset<span class="main">[</span><span class="operator">OF</span> _ gtwu_le_gtwg<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> bad_f0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> wf_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">≤</span> <span class="skolem">max_args</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">≤</span> <span class="skolem">max_args</span> <span class="main">∧</span> <span class="free">extf</span> <span class="skolem">f</span> <span class="var">?gtwu</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> extf_wf_bounded<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?gtwu</span></span></span><span class="main">]</span> gtwu_irrefl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> nwf_ext wf_ext <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?subst</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"subst grounding_ρ"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="var">?subst</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub></span> <span class="var">?subst</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wfP_app<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ground_wfP<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="var">?subst</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub></span> <span class="var">?subst</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ground_grounding_ρ<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wfP_subset wary_subst_wary<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_grounding_ρ<span class="main"><span class="main">]</span></span> gt_subst<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_grounding_ρ<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lambda_Free_KBO_Basic">
<div class="head">
<h1>Theory Lambda_Free_KBO_Basic</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       The Graceful Basic Knuth-Bendix Order for Lambda-Free Higher-Order Terms
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2016
    Maintainer:  Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Graceful Basic Knuth--Bendix Order for Lambda-Free Higher-Order Terms›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lambda_Free_KBO_Basic
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Lambda_Free_KBO_Std.html">Lambda_Free_KBO_Std</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory defines the basic version of the graceful Knuth--Bendix order (KBO) for
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>λ›</span></span></span></span>-free higher-order terms. Basic means that all symbols must have a
positive weight. The results are lifted from the standard KBO.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> kbo_basic <span class="main">=</span> kbo_basic_basis _ _ _ <span class="quoted"><span class="free">ground_heads_var</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ground_heads_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'s</span> set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> kbo_std<span class="main">:</span> kbo_std _ _ _ <span class="quoted"><span class="main">0</span></span> _ <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">∞</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">∞</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ε_gt_0 kbo_std_def kbo_std_basis_axioms<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wt</span> <span class="main">(</span>Hd <span class="free"><span class="bound"><span class="entity">ζ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">w</span><span class="main">.</span> <span class="main">∃</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="free"><span class="bound"><span class="entity">ζ</span></span></span><span class="main">.</span> <span class="bound">w</span> <span class="main">=</span> <span class="free">wt_sym</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wt</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">wt</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">+</span> <span class="free">wt</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">gt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  gt_wt<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⊇#</span> vars_mset <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> wt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">&gt;</span> wt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> gt_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⊇#</span> vars_mset <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> wt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> wt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> gt_same<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⊇#</span> vars_mset <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> wt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> wt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span></span> <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> arity_hd_eq_inf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"arity_hd <span class="free">ζ</span> <span class="main">=</span> <span class="main">∞</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ζ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> waryI<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wary_inf_ary<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> basic_wt_eq_wt<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="free">s</span> <span class="main">=</span> kbo_std.wt <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span>
  basic_gt_and_gt_le_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">s</span> <span class="main">∧</span> local.kbo_std.gt <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span> <span class="main">≤</span> kbo_std.gt"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  gt_and_basic_gt_le_basic_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> local.kbo_std.gt <span class="bound">t</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">s</span><span class="main">)</span> <span class="main">≤</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> basic_gt_iff_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟷</span> kbo_std.gt <span class="free">t</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"kbo_std.gt <span class="free">t</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
    <span class="keyword3"><span class="command">case</span></span> gt_wt
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> kbo_std.gt_wt <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> basic_wt_eq_wt<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_diff
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> kbo_std.gt_diff <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> basic_wt_eq_wt<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_same
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> extf_mono<span class="main">[</span><span class="operator">OF</span> basic_gt_and_gt_le_gt<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> basic_wt_eq_wt<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> kbo_std.gt_same<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"kbo_std.gt <span class="free">t</span> <span class="free">s</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
    <span class="keyword3"><span class="command">case</span></span> gt_wt_t_s<span class="main">:</span> gt_wt
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gt_wt <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> basic_wt_eq_wt<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_unary_t_s<span class="main">:</span> <span class="main">(</span>gt_unary <span class="skolem">t</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> gt_unary_t_s<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_nat_zero_code wt_sym_gt_0<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">satx</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_diff_t_s<span class="main">:</span> gt_diff
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gt_diff <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> basic_wt_eq_wt<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_same_t_s<span class="main">:</span> gt_same
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> extf_mono<span class="main">[</span><span class="operator">OF</span> gt_and_basic_gt_le_basic_gt<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gt_same <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> basic_wt_eq_wt<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> basic_gt_iff_gt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> kbo_std.gt_irrefl<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> gt_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> basic_gt_iff_gt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> kbo_std.gt_trans<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> gt_proper_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"proper_sub <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> basic_gt_iff_gt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> kbo_std.gt_proper_sub<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> gt_compat_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">⟹</span> App <span class="free">s</span> <span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> App <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> basic_gt_iff_gt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> kbo_std.gt_compat_fun<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> gt_compat_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> App <span class="free">s'</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> App <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> basic_gt_iff_gt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> kbo_std.gt_compat_arg<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wt_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"wary_subst <span class="free">ρ</span> <span class="main">⟹</span> wt <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> wt <span class="free">s</span> <span class="main">+</span> kbo_std.extra_wt <span class="free">ρ</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> basic_gt_iff_gt basic_wt_eq_wt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> kbo_std.wt_subst<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> gt_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"wary_subst <span class="free">ρ</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> subst <span class="free">ρ</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> basic_gt_iff_gt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> kbo_std.gt_subst<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> gt_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> basic_gt_iff_gt<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> kbo_std.gt_wf<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lambda_Free_TKBO_Coefs">
<div class="head">
<h1>Theory Lambda_Free_TKBO_Coefs</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       The Graceful Transfinite Knuth-Bendix Order with Subterm Coefficients for Lambda-Free Higher-Order Terms
    Author:      Heiko Becker &lt;heikobecker92@gmail.com&gt;, 2016
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2016
    Author:      Uwe Waldmann &lt;waldmann at mpi-inf.mpg.de&gt;, 2016
    Author:      Daniel Wand &lt;dwand at mpi-inf.mpg.de&gt;, 2016
    Maintainer:  Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Graceful Transfinite Knuth--Bendix Order with Subterm Coefficients for
  Lambda-Free Higher-Order Terms›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lambda_Free_TKBO_Coefs
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Lambda_Free_KBO_Util.html">Lambda_Free_KBO_Util</a> <a href="../Nested_Multisets_Ordinals/Signed_Syntactic_Ordinal.html">Nested_Multisets_Ordinals.Signed_Syntactic_Ordinal</a>
<span class="keyword2"><span class="keyword">abbrevs</span></span> <span class="quoted">"=p"</span> <span class="main">=</span> <span class="quoted">"=<span class="hidden">⇩</span><sub>p</sub>"</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"&gt;p"</span> <span class="main">=</span> <span class="quoted">"&gt;<span class="hidden">⇩</span><sub>p</sub>"</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"≥p"</span> <span class="main">=</span> <span class="quoted">"≥<span class="hidden">⇩</span><sub>p</sub>"</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"&gt;t"</span> <span class="main">=</span> <span class="quoted">"&gt;<span class="hidden">⇩</span><sub>t</sub>"</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"≥t"</span> <span class="main">=</span> <span class="quoted">"≥<span class="hidden">⇩</span><sub>t</sub>"</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"!h"</span> <span class="main">=</span> <span class="quoted">"<span class="hidden">⇩</span><sub>h</sub>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory defines the graceful transfinite Knuth--Bendix order (KBO) with
subterm coefficients for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>λ›</span></span></span></span>-free higher-order terms. The proof was
developed by copying that of the standard KBO and generalizing it along two
axes:\ subterm coefficients and ordinals. Both features complicate the
definitions and proofs substantially.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Setup›</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Complex.arg

<span class="keyword1"><span class="command">locale</span></span> tkbo_coefs <span class="main">=</span> kbo_std_basis _ _ <span class="quoted"><span class="free">arity_sym</span></span> <span class="quoted"><span class="free">arity_var</span></span> <span class="quoted"><span class="free">wt_sym</span></span>
    <span class="keyword2"><span class="keyword">for</span></span>
      <span class="free">arity_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> enat"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="free">arity_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> enat"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="free">wt_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> hmultiset"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">coef_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> nat <span class="main">⇒</span> hmultiset"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> coef_sym_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">coef_sym</span> <span class="free">f</span> <span class="free">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">δ<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">::</span> <span class="quoted">hmultiset</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">δ<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">≡</span> of_nat <span class="free">δ</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ε<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">::</span> <span class="quoted">hmultiset</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ε<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">≡</span> of_nat <span class="free">ε</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">arity_sym<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> hmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">arity_sym<span class="hidden">⇩</span><sub>h</sub></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> hmset_of_enat <span class="main">(</span><span class="free">arity_sym</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">arity_var<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> hmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">arity_var<span class="hidden">⇩</span><sub>h</sub></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> hmset_of_enat <span class="main">(</span><span class="free">arity_var</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">arity_hd<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hd <span class="main">⇒</span> hmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">arity_hd<span class="hidden">⇩</span><sub>h</sub></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> hmset_of_enat <span class="main">(</span>arity_hd <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">arity<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> hmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">arity<span class="hidden">⇩</span><sub>h</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> hmset_of_enat <span class="main">(</span>arity <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> arity<span class="hidden">⇩</span><sub>h</sub>_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"arity<span class="hidden">⇩</span><sub>h</sub> <span class="free">s</span> <span class="main">=</span> arity_hd<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>head <span class="free">s</span><span class="main">)</span> <span class="main">-</span> of_nat <span class="main">(</span>num_args <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> arity_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> arity<span class="hidden">⇩</span><sub>h</sub>_App<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"arity<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> arity<span class="hidden">⇩</span><sub>h</sub> <span class="free">s</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_enat_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> wary_App<span class="hidden">⇩</span><sub>h</sub><span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> wary_App<span class="main">[</span><span class="operator">folded</span> of_nat_lt_hmset_of_enat_iff<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> wary_AppE<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> wary_AppE<span class="main">[</span><span class="operator">folded</span> of_nat_lt_hmset_of_enat_iff<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> wary_num_args_le_arity_head<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span>
  wary_num_args_le_arity_head<span class="main">[</span><span class="operator">folded</span> of_nat_le_hmset_of_enat_iff<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> wary_apps<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> wary_apps<span class="main">[</span><span class="operator">folded</span> of_nat_le_hmset_of_enat_iff<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> wary_cases_apps<span class="hidden">⇩</span><sub>h</sub><span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> apps<span class="main">]</span> <span class="main">=</span>
  wary_cases_apps<span class="main">[</span><span class="operator">folded</span> of_nat_le_hmset_of_enat_iff<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> ground_heads_arity<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> ground_heads_arity<span class="main">[</span><span class="operator">folded</span> hmset_of_enat_le<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> some_ground_head_arity<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> some_ground_head_arity<span class="main">[</span><span class="operator">folded</span> hmset_of_enat_le<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> ε<span class="hidden">⇩</span><sub>h</sub>_gt_0 <span class="main">=</span> ε_gt_0<span class="main">[</span><span class="operator">folded</span> of_nat_less_hmset<span class="main">,</span> <span class="operator">unfolded</span> of_nat_0<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> δ<span class="hidden">⇩</span><sub>h</sub>_le_ε<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> δ_le_ε<span class="main">[</span><span class="operator">folded</span> of_nat_le_hmset<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> arity_hd<span class="hidden">⇩</span><sub>h</sub>_lt_ω_if_δ<span class="hidden">⇩</span><sub>h</sub>_gt_0 <span class="main">=</span> arity_hd_ne_infinity_if_δ_gt_0
  <span class="main">[</span><span class="operator">folded</span> of_nat_less_hmset<span class="main">,</span> <span class="operator">unfolded</span> of_nat_0<span class="main">,</span> <span class="operator">folded</span> hmset_of_enat_lt_iff_ne_infinity<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> wt_sym_ge<span class="hidden">⇩</span><sub>h</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wt_sym</span> <span class="free">f</span> <span class="main">≥</span> ε<span class="hidden">⇩</span><sub>h</sub> <span class="main">-</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_nat <span class="main">(</span>the_enat <span class="main">(</span>of_nat <span class="free">δ</span> <span class="main">*</span> <span class="free">arity_sym</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">arity_sym</span> <span class="free">f</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_eq_enat<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">metis</span> arity_sym_ne_infinity_if_δ_gt_0 gr_zeroI mult_eq_0_iff of_nat_0 the_enat_0<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> wt_sym_ge<span class="main">[</span><span class="operator">unfolded</span> of_nat_minus_hmset<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> unary_wt_sym_0_gt<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> unary_wt_sym_0_gt<span class="main">[</span><span class="operator">folded</span> hmset_of_enat_inject<span class="main">,</span> <span class="operator">unfolded</span> hmset_of_enat_1<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> unary_wt_sym_0_imp_δ<span class="hidden">⇩</span><sub>h</sub>_eq_ε<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> unary_wt_sym_0_imp_δ_eq_ε
  <span class="main">[</span><span class="operator">folded</span> of_nat_inject_hmset<span class="main">,</span> <span class="operator">unfolded</span> of_nat_0<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_ext_snoc_if_δ<span class="hidden">⇩</span><sub>h</sub>_eq_ε<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> extf_ext_snoc_if_δ_eq_ε<span class="main">[</span><span class="operator">folded</span> of_nat_inject_hmset<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_snoc_if_δ<span class="hidden">⇩</span><sub>h</sub>_eq_ε<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> ext_snoc.snoc<span class="main">[</span><span class="operator">OF</span> extf_ext_snoc_if_δ<span class="hidden">⇩</span><sub>h</sub>_eq_ε<span class="hidden">⇩</span><sub>h</sub><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> arity_sym<span class="hidden">⇩</span><sub>h</sub>_lt_ω_if_δ<span class="hidden">⇩</span><sub>h</sub>_gt_0 <span class="main">=</span> arity_sym_ne_infinity_if_δ_gt_0
  <span class="main">[</span><span class="operator">folded</span> of_nat_less_hmset hmset_of_enat_lt_iff_ne_infinity<span class="main">,</span> <span class="operator">unfolded</span> of_nat_0<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> arity_var<span class="hidden">⇩</span><sub>h</sub>_lt_ω_if_δ<span class="hidden">⇩</span><sub>h</sub>_gt_0 <span class="main">=</span> arity_var_ne_infinity_if_δ_gt_0
  <span class="main">[</span><span class="operator">folded</span> of_nat_less_hmset hmset_of_enat_lt_iff_ne_infinity<span class="main">,</span> <span class="operator">unfolded</span> of_nat_0<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> arity<span class="hidden">⇩</span><sub>h</sub>_lt_ω_if_δ<span class="hidden">⇩</span><sub>h</sub>_gt_0 <span class="main">=</span> arity_ne_infinity_if_δ_gt_0
  <span class="main">[</span><span class="operator">folded</span> of_nat_less_hmset hmset_of_enat_lt_iff_ne_infinity<span class="main">,</span> <span class="operator">unfolded</span> of_nat_0<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> warywary_subst_subst<span class="hidden">⇩</span><sub>h</sub>_conv <span class="main">=</span> wary_subst_def<span class="main">[</span><span class="operator">folded</span> hmset_of_enat_le<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_singleton_nil_if_δ<span class="hidden">⇩</span><sub>h</sub>_eq_ε<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> extf_singleton_nil_if_δ_eq_ε<span class="main">[</span><span class="operator">folded</span> of_nat_inject_hmset<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> arity_sym<span class="hidden">⇩</span><sub>h</sub>_if_δ<span class="hidden">⇩</span><sub>h</sub>_gt_0_E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> δ_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">n</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="free">f</span> <span class="main">=</span> of_nat <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> arity_sym<span class="hidden">⇩</span><sub>h</sub>_lt_ω_if_δ<span class="hidden">⇩</span><sub>h</sub>_gt_0 assms lt_ω_imp_ex_of_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> arity_var<span class="hidden">⇩</span><sub>h</sub>_if_δ<span class="hidden">⇩</span><sub>h</sub>_gt_0_E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> δ_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">n</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"arity_var<span class="hidden">⇩</span><sub>h</sub> <span class="free">f</span> <span class="main">=</span> of_nat <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> arity_var<span class="hidden">⇩</span><sub>h</sub>_lt_ω_if_δ<span class="hidden">⇩</span><sub>h</sub>_gt_0 assms lt_ω_imp_ex_of_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Weights and Subterm Coefficients›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">zhmset_of_tpoly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> hmultiset<span class="main">)</span> tpoly <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> zhmultiset<span class="main">)</span> tpoly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zhmset_of_tpoly</span> <span class="main">≡</span> map_tpoly <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> zhmset_of"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">eval_ztpoly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> zhmultiset<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> hmultiset<span class="main">)</span> tpoly <span class="main">⇒</span> zhmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_ztpoly</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> eval_tpoly <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>zhmset_of_tpoly <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_tpoly_eq_eval_ztpoly<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"zhmset_of <span class="main">(</span>eval_tpoly <span class="free">A</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> eval_ztpoly <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> zhmset_of <span class="main">(</span><span class="free">A</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zhmset_of_sum_list zhmset_of_prod_list o_def<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp_all</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> map_cong<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">min_ground_head</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hd <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">min_ground_head</span> <span class="free"><span class="bound"><span class="entity">ζ</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="free"><span class="bound"><span class="entity">ζ</span></span></span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> ground_heads <span class="free"><span class="bound"><span class="entity">ζ</span></span></span><span class="main">.</span> <span class="free">wt_sym</span> <span class="bound">g</span> <span class="main">+</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="bound">g</span> <span class="main">≥</span> <span class="free">wt_sym</span> <span class="bound">f</span> <span class="main">+</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="bound">f</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'va</span> pvar <span class="main">=</span>
  PWt <span class="tfree"><span class="quoted"><span class="tfree">'va</span></span></span>
<span class="main">|</span> PCoef <span class="tfree"><span class="quoted"><span class="tfree">'va</span></span></span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">min_passign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> pvar <span class="main">⇒</span> hmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">min_passign</span> <span class="main">(</span>PWt <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">wt_sym</span> <span class="main">(</span>min_ground_head <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">min_passign</span> <span class="main">(</span>PCoef <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">min_zpassign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> pvar <span class="main">⇒</span> zhmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">min_zpassign</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> zhmset_of <span class="main">(</span>min_passign <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> min_zpassign_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"min_zpassign <span class="main">(</span>PWt <span class="free">x</span><span class="main">)</span> <span class="main">=</span> zhmset_of <span class="main">(</span><span class="free">wt_sym</span> <span class="main">(</span>min_ground_head <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"min_zpassign <span class="main">(</span>PCoef <span class="free">x</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zhmset_of_1<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">legal_passign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> pvar <span class="main">⇒</span> hmultiset<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">legal_passign</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">x</span> <span class="main">≥</span> min_passign <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">legal_zpassign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> pvar <span class="main">⇒</span> zhmultiset<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">legal_zpassign</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">x</span> <span class="main">≥</span> min_zpassign <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> legal_min_passign<span class="main">:</span> <span class="quoted"><span class="quoted">"legal_passign min_passign"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> legal_passign_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> legal_min_zpassign<span class="main">:</span> <span class="quoted"><span class="quoted">"legal_zpassign min_zpassign"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> legal_zpassign_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> assign_ge_0<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"legal_zpassign <span class="free">A</span> <span class="main">⟹</span> <span class="free">A</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> legal_zpassign_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> dual_order.trans<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">eq_tpoly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> pvar<span class="main">,</span> hmultiset<span class="main">)</span> tpoly <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> pvar<span class="main">,</span> hmultiset<span class="main">)</span> tpoly <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1"><span class="free">=<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">.</span> legal_zpassign <span class="bound">A</span> <span class="main">⟶</span> eval_ztpoly <span class="bound">A</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> eval_ztpoly <span class="bound">A</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">ge_tpoly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> pvar<span class="main">,</span> hmultiset<span class="main">)</span> tpoly <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> pvar<span class="main">,</span> hmultiset<span class="main">)</span> tpoly <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1"><span class="free">≥<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">.</span> legal_zpassign <span class="bound">A</span> <span class="main">⟶</span> eval_ztpoly <span class="bound">A</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≥</span> eval_ztpoly <span class="bound">A</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">gt_tpoly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> pvar<span class="main">,</span> hmultiset<span class="main">)</span> tpoly <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> pvar<span class="main">,</span> hmultiset<span class="main">)</span> tpoly <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">.</span> legal_zpassign <span class="bound">A</span> <span class="main">⟶</span> eval_ztpoly <span class="bound">A</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">&gt;</span> eval_ztpoly <span class="bound">A</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_tpoly_imp_ge<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">q</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ge_tpoly_def gt_tpoly_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_less<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_tpoly_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> eq_tpoly_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> ge_tpoly_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ge_tpoly_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> gt_tpoly_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gt_tpoly_def legal_zpassign_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span>
  eq_eq_tpoly_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">q</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">r</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  eq_ge_tpoly_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">q</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">r</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  eq_gt_tpoly_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">q</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">r</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  ge_eq_tpoly_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">q</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">r</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  ge_ge_tpoly_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">q</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">r</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  ge_gt_tpoly_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">q</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">r</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  gt_eq_tpoly_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">q</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">r</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  gt_ge_tpoly_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">q</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">r</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  gt_gt_tpoly_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">q</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">r</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> eq_tpoly_def ge_tpoly_def gt_tpoly_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.trans less_trans less_le_trans le_less_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">coef_hd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hd <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> pvar<span class="main">,</span> hmultiset<span class="main">)</span> tpoly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">coef_hd</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> PVar <span class="main">(</span>PCoef <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">coef_hd</span> <span class="main">(</span>Sym <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> PNum <span class="main">(</span><span class="free">coef_sym</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> coef_hd_gt_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> legal<span class="main">:</span> <span class="quoted"><span class="quoted">"legal_zpassign <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="free">A</span> <span class="main">(</span>coef_hd <span class="free">ζ</span> <span class="free">i</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> legal_zpassign_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ζ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x1</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> legal<span class="main">[</span><span class="operator">unfolded</span> legal_zpassign_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"PCoef <span class="skolem">x</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">x</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coef_sym_gt_0 zhmset_of_1 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> dual_order.strict_trans1 zero_less_one<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Sym <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> legal<span class="main">[</span><span class="operator">unfolded</span> legal_zpassign_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"PWt <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">x</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> coef_sym_gt_0 zhmset_of_0 zhmset_of_less<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">coef</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> pvar<span class="main">,</span> hmultiset<span class="main">)</span> tpoly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">coef</span> <span class="main">(</span>Hd <span class="free"><span class="bound"><span class="entity">ζ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> coef_hd <span class="free"><span class="bound"><span class="entity">ζ</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">coef</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free">coef</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> coef_apps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"coef <span class="main">(</span>apps <span class="free">s</span> <span class="free">ss</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> coef <span class="free">s</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> coef_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"legal_zpassign <span class="free">A</span> <span class="main">⟹</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>coef <span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> coef_hd_gt_0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> exists_min_ground_head<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="free">ζ</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> ground_heads <span class="free">ζ</span><span class="main">.</span> <span class="free">wt_sym</span> <span class="bound">g</span> <span class="main">+</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="bound">g</span> <span class="main">≥</span> <span class="free">wt_sym</span> <span class="bound">f</span> <span class="main">+</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="bound">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="free">ζ</span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">∈</span> ground_heads <span class="free">ζ</span> <span class="main">∧</span>
    <span class="free">wt_sym</span> <span class="bound">g</span> <span class="main">+</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="bound">g</span> <span class="main">&gt;</span> <span class="free">wt_sym</span> <span class="bound">f</span> <span class="main">+</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="bound">f</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> wf_R<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_app<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">M</span><span class="main">,</span> <span class="bound">N</span><span class="main">)</span><span class="main">.</span> <span class="bound">M</span> <span class="main">&lt;</span> <span class="bound">N</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="free">wt_sym</span> <span class="bound">f</span> <span class="main">+</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="bound">f</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> wf<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="free">ζ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> ground_heads_nonempty subsetI subset_empty<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_eq_minimal<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">,</span> <span class="operator">OF</span> wf_R<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> min_ground_head_Sym<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"min_ground_head <span class="main">(</span>Sym <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> min_ground_head_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> min_ground_head_in_ground_heads<span class="main">:</span> <span class="quoted"><span class="quoted">"min_ground_head <span class="free">ζ</span> <span class="main">∈</span> ground_heads <span class="free">ζ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> min_ground_head_def <span class="keyword1"><span class="command">using</span></span> someI_ex<span class="main">[</span><span class="operator">OF</span> exists_min_ground_head<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> min_ground_head_min<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> ground_heads <span class="free">ζ</span> <span class="main">⟹</span>
   <span class="free">wt_sym</span> <span class="free">f</span> <span class="main">+</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="free">f</span> <span class="main">≥</span> <span class="free">wt_sym</span> <span class="main">(</span>min_ground_head <span class="free">ζ</span><span class="main">)</span> <span class="main">+</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="free">ζ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> min_ground_head_def <span class="keyword1"><span class="command">using</span></span> someI_ex<span class="main">[</span><span class="operator">OF</span> exists_min_ground_head<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> min_ground_head_antimono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ground_heads <span class="free">ζ</span> <span class="main">⊆</span> ground_heads <span class="free">ξ</span> <span class="main">⟹</span>
   <span class="free">wt_sym</span> <span class="main">(</span>min_ground_head <span class="free">ζ</span><span class="main">)</span> <span class="main">+</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="free">ζ</span><span class="main">)</span>
   <span class="main">≥</span> <span class="free">wt_sym</span> <span class="main">(</span>min_ground_head <span class="free">ξ</span><span class="main">)</span> <span class="main">+</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="free">ξ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> min_ground_head_in_ground_heads min_ground_head_min <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">wt0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hd <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> pvar<span class="main">,</span> hmultiset<span class="main">)</span> tpoly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wt0</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> PVar <span class="main">(</span>PWt <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wt0</span> <span class="main">(</span>Sym <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> PNum <span class="main">(</span><span class="free">wt_sym</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wt0_ge_min_ground_head<span class="main">:</span>
  <span class="quoted"><span class="quoted">"legal_zpassign <span class="free">A</span> <span class="main">⟹</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt0 <span class="free">ζ</span><span class="main">)</span> <span class="main">≥</span> zhmset_of <span class="main">(</span><span class="free">wt_sym</span> <span class="main">(</span>min_ground_head <span class="free">ζ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ζ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> legal_zpassign_def min_zpassign_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_ztpoly_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"legal_zpassign <span class="free">A</span> <span class="main">⟹</span> eval_ztpoly <span class="free">A</span> <span class="free">p</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> map_cong <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_list_nonneg prod_list_nonneg<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_zip_imp_size_lt_apps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">ss</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> size <span class="free">s</span> <span class="main">&lt;</span> size <span class="main">(</span>apps <span class="main">(</span>Hd <span class="free">ζ</span><span class="main">)</span> <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_zip_leftD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size_in_args<span class="main">)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">wt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> pvar<span class="main">,</span> hmultiset<span class="main">)</span> tpoly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wt</span> <span class="main">(</span>apps <span class="main">(</span>Hd <span class="free"><span class="bound"><span class="entity">ζ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="main">=</span>
   PSum <span class="main">(</span><span class="main">[</span>wt0 <span class="free"><span class="bound"><span class="entity">ζ</span></span></span><span class="main">,</span> PNum <span class="main">(</span>δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> <span class="main">(</span>arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="free"><span class="bound"><span class="entity">ζ</span></span></span><span class="main">)</span> <span class="main">-</span> of_nat <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span>
     map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> PMult <span class="main">[</span>coef_hd <span class="free"><span class="bound"><span class="entity">ζ</span></span></span> <span class="bound">i</span><span class="main">,</span> <span class="free">wt</span> <span class="bound">s</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> tm_exhaust_apps<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">lexicographic_order</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_zip_imp_size_lt_apps<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">wt_args</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> pvar <span class="main">⇒</span> zhmultiset<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hd <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm list <span class="main">⇒</span> zhmultiset"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wt_args</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">ζ</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">=</span> sum_list
     <span class="main">(</span>map <span class="main">(</span>eval_ztpoly <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> PMult <span class="main">[</span>coef_hd <span class="free"><span class="bound"><span class="entity">ζ</span></span></span> <span class="bound">i</span><span class="main">,</span> wt <span class="bound">s</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> length <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wt_Hd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>Hd <span class="free">ζ</span><span class="main">)</span> <span class="main">=</span> PSum <span class="main">[</span>wt0 <span class="free">ζ</span><span class="main">,</span> PNum <span class="main">(</span>δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="free">ζ</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wt.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coef_hd_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> vars_hd <span class="free">ζ</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">(</span>PCoef <span class="bound">x</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span> <span class="main">(</span>PCoef <span class="bound">x</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   eval_ztpoly <span class="free">A</span> <span class="main">(</span>coef_hd <span class="free">ζ</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> eval_ztpoly <span class="free">B</span> <span class="main">(</span>coef_hd <span class="free">ζ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ζ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wt0_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pwt_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> vars_hd <span class="free">ζ</span><span class="main">.</span> <span class="free">A</span> <span class="main">(</span>PWt <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span> <span class="main">(</span>PWt <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt0 <span class="free">ζ</span><span class="main">)</span> <span class="main">=</span> eval_ztpoly <span class="free">B</span> <span class="main">(</span>wt0 <span class="free">ζ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pwt_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ζ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wt_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> vars <span class="free">s</span><span class="main">.</span> <span class="free">A</span> <span class="main">(</span>PWt <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span> <span class="main">(</span>PWt <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> vars <span class="free">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">(</span>PCoef <span class="bound">x</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span> <span class="main">(</span>PCoef <span class="bound">x</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">s</span><span class="main">)</span> <span class="main">=</span> eval_ztpoly <span class="free">B</span> <span class="main">(</span>wt <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tm_induct_apps<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>apps <span class="skolem">ζ</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> pwt_eq <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> pcoef_eq <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> ih'<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> eval_ztpoly <span class="free">B</span> <span class="main">(</span>wt <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> s_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> set <span class="skolem">ss</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s_in<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> vars <span class="skolem">s</span><span class="main">.</span> <span class="free">A</span> <span class="main">(</span>PWt <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span> <span class="main">(</span>PWt <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pwt_eq s_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> vars <span class="skolem">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">(</span>PCoef <span class="bound">x</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span> <span class="main">(</span>PCoef <span class="bound">x</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pcoef_eq s_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> wt0_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt0 <span class="skolem">ζ</span><span class="main">)</span> <span class="main">=</span> eval_ztpoly <span class="free">B</span> <span class="main">(</span>wt0 <span class="skolem">ζ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wt0_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pwt_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> coef_ζ_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="free">A</span> <span class="main">(</span>coef_hd <span class="skolem">ζ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> eval_ztpoly <span class="free">B</span> <span class="main">(</span>coef_hd <span class="skolem">ζ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> coef_hd_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pcoef_eq<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ih' wt0_eq coef_ζ_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_zip_leftD <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">sum_list</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ground_eval_ztpoly_wt_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="free">s</span> <span class="main">⟹</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">s</span><span class="main">)</span> <span class="main">=</span> eval_ztpoly <span class="free">B</span> <span class="main">(</span>wt <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wt_cong<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> exists_wt_sym<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> legal<span class="main">:</span> <span class="quoted"><span class="quoted">"legal_zpassign <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="free">ζ</span><span class="main">.</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="main">(</span>Hd <span class="free">ζ</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> zhmset_of <span class="main">(</span><span class="free">wt_sym</span> <span class="bound">f</span> <span class="main">+</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="bound">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> eq_tpoly_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ζ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Var
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> legal<span class="main">[</span><span class="operator">unfolded</span> legal_zpassign_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> add_le_cancel_right ground_heads.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> min_ground_head_in_ground_heads
      min_zpassign_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> zhmset_of_plus<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Sym
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zhmset_of_plus<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wt_ge_ε<span class="hidden">⇩</span><sub>h</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> legal<span class="main">:</span> <span class="quoted"><span class="quoted">"legal_zpassign <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">s</span><span class="main">)</span> <span class="main">≥</span> zhmset_of ε<span class="hidden">⇩</span><sub>h</sub>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tm_induct_apps<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>apps <span class="skolem">ζ</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> ss_eq_nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ε<span class="hidden">⇩</span><sub>h</sub> <span class="main">≤</span> <span class="free">wt_sym</span> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span> <span class="main">+</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wt_sym_ge<span class="hidden">⇩</span><sub>h</sub><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"min_ground_head <span class="skolem">ζ</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_left' leD leI le_imp_minus_plus_hmset le_minus_plus_same_hmset
        less_le_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"zhmset_of ε<span class="hidden">⇩</span><sub>h</sub>
      <span class="main">≤</span> zhmset_of <span class="main">(</span><span class="free">wt_sym</span> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> zhmset_of <span class="main">(</span>δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> zhmset_of_le zhmset_of_plus<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span>
      <span class="main">≤</span> eval_tpoly <span class="free">A</span> <span class="main">(</span>map_tpoly <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> zhmset_of <span class="main">(</span>wt0 <span class="skolem">ζ</span><span class="main">)</span><span class="main">)</span>
        <span class="main">+</span> zhmset_of <span class="main">(</span>δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wt0_ge_min_ground_head<span class="main">[</span><span class="operator">OF</span> legal<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ss_eq_nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?arg_wt</span></span></span> <span class="main">=</span>
      <span class="quoted"><span class="quoted">"eval_tpoly <span class="free">A</span> <span class="main">∘</span> <span class="main">(</span>map_tpoly <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> zhmset_of <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> PMult <span class="main">[</span>coef_hd <span class="skolem">ζ</span> <span class="bound">i</span><span class="main">,</span> wt <span class="bound">s</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword3"><span class="command">assume</span></span> ss_ne_nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"zhmset_of ε<span class="hidden">⇩</span><sub>h</sub>
      <span class="main">≤</span> eval_tpoly <span class="free">A</span> <span class="main">(</span>map_tpoly <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> zhmset_of <span class="main">(</span>PMult <span class="main">[</span>coef_hd <span class="skolem">ζ</span> <span class="main">0</span><span class="main">,</span> wt <span class="main">(</span>hd <span class="skolem">ss</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ih coef_hd_gt_0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> legal<span class="main"><span class="main">]</span></span> nonneg_le_mult_right_mono_zhmset<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> hd <span class="main">(</span>map <span class="var">?arg_wt</span> <span class="main">(</span>zip <span class="skolem">ss</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">ss</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ss_ne_nil <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_map zip_nth_conv hd_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> sum_list <span class="main">(</span>map <span class="var">?arg_wt</span> <span class="main">(</span>zip <span class="skolem">ss</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">ss</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hd_le_sum_list<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> length_greater_0_conv list.collapse list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span>
          ss_ne_nil upt_conv_Cons zip_Cons_Cons<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_ztpoly_nonneg legal<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span>
      <span class="main">≤</span> eval_tpoly <span class="free">A</span> <span class="main">(</span>map_tpoly <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> zhmset_of <span class="main">(</span>wt0 <span class="skolem">ζ</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
        <span class="main">(</span>zhmset_of <span class="main">(</span>δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> <span class="main">(</span>arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span> <span class="main">-</span> of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
         sum_list <span class="main">(</span>map <span class="var">?arg_wt</span> <span class="main">(</span>zip <span class="skolem">ss</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">ss</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> eval_tpoly <span class="free">A</span> <span class="main">(</span>map_tpoly <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">)</span> zhmset_of <span class="main">(</span>wt0 <span class="skolem">ζ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> legal eval_ztpoly_nonneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> leD leI le_add_same_cancel2 less_le_trans zhmset_of_nonneg<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wt_args_ge_length_times_ε<span class="hidden">⇩</span><sub>h</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> legal<span class="main">:</span> <span class="quoted"><span class="quoted">"legal_zpassign <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wt_args <span class="free">i</span> <span class="free">A</span> <span class="free">ζ</span> <span class="free">ss</span> <span class="main">≥</span> of_nat <span class="main">(</span>length <span class="free">ss</span><span class="main">)</span> <span class="main">*</span> zhmset_of ε<span class="hidden">⇩</span><sub>h</sub>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wt_args_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_list_ge_length_times<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wt_args_def<span class="main"><span class="main">,</span></span>
      <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"map <span class="main"><span class="main"><span class="main">(</span></span></span>eval_ztpoly <span class="free"><span class="free"><span class="free">A</span></span></span> <span class="main"><span class="main"><span class="main">∘</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">λ</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="bound"><span class="bound"><span class="bound">s</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> PMult <span class="main"><span class="main"><span class="main">[</span></span></span>coef_hd <span class="free"><span class="free"><span class="free">ζ</span></span></span> <span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> wt <span class="bound"><span class="bound"><span class="bound">s</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>zip <span class="free"><span class="free"><span class="free">ss</span></span></span> <span class="main"><span class="main"><span class="main">[</span></span></span><span class="free"><span class="free"><span class="free">i</span></span></span><span class="main"><span class="main"><span class="main">..&lt;</span></span></span><span class="free"><span class="free"><span class="free">i</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> length <span class="free"><span class="free"><span class="free">ss</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span>
      <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_le_mono_hmset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span> nonneg_le_mult_right_mono_zhmset coef_hd_gt_0
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> legal zero_less_iff_1_le_hmset<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> coef_hd_gt_0 wt_ge_ε<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wt_ge_δ<span class="hidden">⇩</span><sub>h</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"legal_zpassign <span class="free">A</span> <span class="main">⟹</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">s</span><span class="main">)</span> <span class="main">≥</span> zhmset_of δ<span class="hidden">⇩</span><sub>h</sub>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> δ<span class="hidden">⇩</span><sub>h</sub>_le_ε<span class="hidden">⇩</span><sub>h</sub><span class="main">[</span><span class="operator">folded</span> zhmset_of_le<span class="main">]</span> order.trans wt_ge_ε<span class="hidden">⇩</span><sub>h</sub> zhmset_of_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> wt_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"legal_zpassign <span class="free">A</span> <span class="main">⟹</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">s</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ε<span class="hidden">⇩</span><sub>h</sub>_gt_0<span class="main">[</span><span class="operator">folded</span> zhmset_of_less<span class="main">,</span> <span class="operator">unfolded</span> zhmset_of_0<span class="main">]</span> wt_ge_ε<span class="hidden">⇩</span><sub>h</sub> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> less_le_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wt_gt_δ<span class="hidden">⇩</span><sub>h</sub>_if_superunary<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    legal<span class="main">:</span> <span class="quoted"><span class="quoted">"legal_zpassign <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    superunary<span class="main">:</span> <span class="quoted"><span class="quoted">"arity_hd<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>head <span class="free">s</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">s</span><span class="main">)</span> <span class="main">&gt;</span> zhmset_of δ<span class="hidden">⇩</span><sub>h</sub>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> ε<span class="hidden">⇩</span><sub>h</sub>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> δ_ne_ε<span class="main">:</span> False
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> order.not_eq_order_implies_strict<span class="main">[</span><span class="operator">OF</span> δ_ne_ε δ<span class="hidden">⇩</span><sub>h</sub>_le_ε<span class="hidden">⇩</span><sub>h</sub><span class="main">,</span> <span class="operator">folded</span> zhmset_of_less<span class="main">]</span>
      wt_ge_ε<span class="hidden">⇩</span><sub>h</sub><span class="main">[</span><span class="operator">OF</span> legal<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> less_le_trans<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> δ_eq_ε<span class="main">:</span> True
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> superunary
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tm_induct_apps<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>apps <span class="skolem">ζ</span> <span class="skolem">ss</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arity_hd<span class="hidden">⇩</span><sub>h</sub> <span class="skolem">ζ</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> apps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> min_gr_ary<span class="main">:</span> <span class="quoted"><span class="quoted">"arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ground_heads_arity<span class="hidden">⇩</span><sub>h</sub> less_le_trans min_ground_head_in_ground_heads <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zhmset_of δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">&lt;</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt0 <span class="skolem">ζ</span><span class="main">)</span> <span class="main">+</span> zhmset_of <span class="main">(</span>δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> δ_eq_ε
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> add_strict_increasing2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eval_ztpoly_nonneg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> legal<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> zhmset_of_less<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule</span> gt_0_lt_mult_gt_1_hmset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ε<span class="hidden">⇩</span><sub>h</sub>_gt_0 min_gr_ary<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt0 <span class="skolem">ζ</span><span class="main">)</span>
      <span class="main">+</span> zhmset_of <span class="main">(</span>δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> <span class="main">(</span>arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span> <span class="main">-</span> of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">+</span> zhmset_of <span class="main">(</span>of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span> <span class="main">*</span> ε<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ε<span class="hidden">⇩</span><sub>h</sub>_gt_0 δ_eq_ε zmset_of_le zhmset_of_plus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span>
            <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ring_distribs <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">metis</span> add.commute le_minus_plus_same_hmset<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt0 <span class="skolem">ζ</span><span class="main">)</span>
      <span class="main">+</span> zhmset_of <span class="main">(</span>δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> <span class="main">(</span>arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span> <span class="main">-</span> of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> wt_args <span class="main">0</span> <span class="free">A</span> <span class="skolem">ζ</span> <span class="skolem">ss</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wt_args_ge_length_times_ε<span class="hidden">⇩</span><sub>h</sub><span class="main">[</span><span class="operator">OF</span> legal<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zhmset_of_times of_nat_zhmset<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_args_def add_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> comp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wt_App_plus_δ<span class="hidden">⇩</span><sub>h</sub>_ge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> zhmset_of δ<span class="hidden">⇩</span><sub>h</sub>
   <span class="main">≥</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">s</span><span class="main">)</span> <span class="main">+</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>coef <span class="free">s</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tm_exhaust_apps<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> s<span class="main">:</span> <span class="main">(</span>apps <span class="skolem">ζ</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span> <span class="main">=</span> ω"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> ary_eq_ω<span class="main">:</span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ary_eq_ω s App_apps wt.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_diff_add_hmset<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> add.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> s App_apps wt.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> zhmset_of_plus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> zmset_of_le<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> diff_diff_add_hmset <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span> le_minus_plus_same_hmset
          distrib_left<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">::</span> hmultiset"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> mult.right_neutral<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
          diff_diff_add_hmset<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wt_App_fun_δ<span class="hidden">⇩</span><sub>h</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    legal<span class="main">:</span> <span class="quoted"><span class="quoted">"legal_zpassign <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    wt_st<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">s</span><span class="main">)</span> <span class="main">=</span> zhmset_of δ<span class="hidden">⇩</span><sub>h</sub>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wt_st <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> wt_s_t_le_δ_t<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">s</span><span class="main">)</span> <span class="main">+</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>coef <span class="free">s</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">t</span><span class="main">)</span>
     <span class="main">≤</span> zhmset_of δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">+</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wt_App_plus_δ<span class="hidden">⇩</span><sub>h</sub>_ge <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">s</span><span class="main">)</span> <span class="main">+</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wt_ge_δ<span class="hidden">⇩</span><sub>h</sub><span class="main">[</span><span class="operator">OF</span> legal<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="free">A</span> <span class="main">(</span>coef <span class="free">s</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="free">A</span> <span class="main">(</span>coef <span class="free">s</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval_ztpoly_nonneg<span class="main">[</span><span class="operator">OF</span> legal<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> coef_gt_0 dual_order.order_iff_strict leD legal mult_cancel_right1
      nonneg_le_mult_right_mono_zhmset wt_gt_0<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> wt_s_t_le_δ_t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute antisym wt_ge_δ<span class="hidden">⇩</span><sub>h</sub><span class="main"><span class="main">[</span></span><span class="operator">OF</span> legal<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wt_App_arg_δ<span class="hidden">⇩</span><sub>h</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    legal<span class="main">:</span> <span class="quoted"><span class="quoted">"legal_zpassign <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    wt_st<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">t</span><span class="main">)</span> <span class="main">=</span> zhmset_of δ<span class="hidden">⇩</span><sub>h</sub>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> zhmset_of δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">s</span><span class="main">)</span> <span class="main">+</span> zhmset_of δ<span class="hidden">⇩</span><sub>h</sub>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wt_st <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="free">A</span> <span class="main">(</span>coef <span class="free">s</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> zhmset_of δ<span class="hidden">⇩</span><sub>h</sub>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">*</span> <span class="var">?w</span> <span class="main">≤</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_le_cancel_left wt_App_plus_δ<span class="hidden">⇩</span><sub>h</sub>_ge<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">*</span> <span class="var">?w</span> <span class="main">=</span> zhmset_of δ<span class="hidden">⇩</span><sub>h</sub>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wt_ge_δ<span class="hidden">⇩</span><sub>h</sub><span class="main">[</span><span class="operator">OF</span> legal<span class="main">]</span> coef_gt_0<span class="main">[</span><span class="operator">OF</span> legal<span class="main">,</span> <span class="operator">unfolded</span> zero_less_iff_1_le_hmset<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> antisym nonneg_le_mult_right_mono_zhmset<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?w</span> <span class="main">≤</span> zhmset_of δ<span class="hidden">⇩</span><sub>h</sub>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> coef_gt_0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> legal<span class="main"><span class="main">]</span></span> dual_order.order_iff_strict eval_ztpoly_nonneg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> legal<span class="main"><span class="main">]</span></span>
      nonneg_le_mult_right_mono_zhmset<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> antisym wt_ge_δ<span class="hidden">⇩</span><sub>h</sub><span class="main"><span class="main">[</span></span><span class="operator">OF</span> legal<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wt_App_ge_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ge_tpoly_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span>
  <span class="keyword3"><span class="command">assume</span></span> legal<span class="main">:</span> <span class="quoted"><span class="quoted">"legal_zpassign <span class="skolem">A</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zhmset_of δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">≤</span> eval_ztpoly <span class="skolem">A</span> <span class="main">(</span>coef <span class="free">s</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> eval_ztpoly <span class="skolem">A</span> <span class="main">(</span>wt <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coef_gt_0 legal nonneg_le_mult_right_mono_zhmset wt_ge_δ<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="skolem">A</span> <span class="main">(</span>wt <span class="free">s</span><span class="main">)</span> <span class="main">+</span> zhmset_of δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">≤</span> eval_ztpoly <span class="skolem">A</span> <span class="main">(</span>wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> zhmset_of δ<span class="hidden">⇩</span><sub>h</sub>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_le_cancel_right add_less_le_mono not_le wt_App_plus_δ<span class="hidden">⇩</span><sub>h</sub>_ge<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="skolem">A</span> <span class="main">(</span>wt <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> eval_ztpoly <span class="skolem">A</span> <span class="main">(</span>wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wt_App_ge_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ge_tpoly_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tm_exhaust_apps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> App_apps wt.simps<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def coef_hd_gt_0 eval_ztpoly_nonneg nonneg_le_mult_right_mono_zhmset
       <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_list_nonneg eval_ztpoly_nonneg add_increasing<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wt_δ<span class="hidden">⇩</span><sub>h</sub>_imp_δ<span class="hidden">⇩</span><sub>h</sub>_eq_ε<span class="hidden">⇩</span><sub>h</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    legal<span class="main">:</span> <span class="quoted"><span class="quoted">"legal_zpassign <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    wt_s_eq_δ<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">s</span><span class="main">)</span> <span class="main">=</span> zhmset_of δ<span class="hidden">⇩</span><sub>h</sub>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> ε<span class="hidden">⇩</span><sub>h</sub>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> δ<span class="hidden">⇩</span><sub>h</sub>_le_ε<span class="hidden">⇩</span><sub>h</sub> wt_ge_ε<span class="hidden">⇩</span><sub>h</sub><span class="main">[</span><span class="operator">OF</span> legal<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">,</span> <span class="operator">unfolded</span> wt_s_eq_δ zhmset_of_le<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wt_ge_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="free">t</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="free">s</span> <span class="main">⟹</span> vars <span class="free">t</span> <span class="main">⊇</span> vars <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> t<span class="main">:</span> <span class="main">(</span>Hd <span class="skolem">ζ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> wt_ge_ζ <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ζ</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> ζ<span class="main">:</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> z_ni_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> vars <span class="free">t</span>"</span></span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted">min_zpassign</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> PWt <span class="skolem">x</span> <span class="keyword1">then</span> eval_ztpoly <span class="var">?A</span> <span class="main">(</span>wt <span class="free">t</span><span class="main">)</span> <span class="main">+</span> <span class="var">?A</span> <span class="bound">v</span> <span class="main">+</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="var">?A</span> <span class="bound">v</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> legal_B<span class="main">:</span> <span class="quoted"><span class="quoted">"legal_zpassign <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> legal_zpassign_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> legal_min_zpassign <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_increasing eval_ztpoly_nonneg<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> eval_B_eq_A<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="var">?B</span> <span class="main">(</span>wt <span class="free">t</span><span class="main">)</span> <span class="main">=</span> eval_ztpoly <span class="var">?A</span> <span class="main">(</span>wt <span class="free">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wt_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> z_ni_t<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="var">?B</span> <span class="main">(</span>wt <span class="main">(</span>Hd <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> eval_ztpoly <span class="var">?B</span> <span class="main">(</span>wt <span class="free">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_B_eq_A zero_less_iff_1_le_zhmset zhmset_of_plus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
          <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> wt_ge_ζ ζ <span class="keyword1"><span class="command">unfolding</span></span> ge_tpoly_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> leD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> legal_B legal_min_zpassign<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ζ<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih1 <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> ih2 <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> wt_t_ge_wt_s1s2 <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars <span class="skolem">s1</span> <span class="main">⊆</span> vars <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ih1 wt_t_ge_wt_s1s2 wt_App_ge_fun order_trans <span class="keyword1"><span class="command">unfolding</span></span> ge_tpoly_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars <span class="skolem">s2</span> <span class="main">⊆</span> vars <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ih2 wt_t_ge_wt_s1s2 wt_App_ge_arg order_trans <span class="keyword1"><span class="command">unfolding</span></span> ge_tpoly_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_coefs_ge_num_args_if_δ<span class="hidden">⇩</span><sub>h</sub>_eq_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    legal<span class="main">:</span> <span class="quoted"><span class="quoted">"legal_passign <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    δ_eq_0<span class="main">:</span> <span class="quoted"><span class="quoted">"δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    wary_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum_coefs <span class="main">(</span>eval_tpoly <span class="free">A</span> <span class="main">(</span>wt <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> num_args <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tm_exhaust_apps<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> s<span class="main">:</span> <span class="main">(</span>apps <span class="skolem">ζ</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> s
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">sa</span> <span class="skolem">ss</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Az</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span><span class="main">.</span> zhmset_of <span class="main">(</span><span class="free">A</span> <span class="bound">v</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> legalz<span class="main">:</span> <span class="quoted"><span class="quoted">"legal_zpassign <span class="var">?Az</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> legal <span class="keyword1"><span class="command">unfolding</span></span> legal_passign_def legal_zpassign_def zhmset_of_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="var">?Az</span> <span class="main">(</span>coef_hd <span class="skolem">ζ</span> <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> legal coef_hd_gt_0 eval_tpoly_eq_eval_ztpoly
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coef_hd_gt_0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> legalz<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_tpoly <span class="free">A</span> <span class="main">(</span>coef_hd <span class="skolem">ζ</span> <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">&gt;</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> eval_tpoly_eq_eval_ztpoly<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> zhmset_of_less<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> zhmset_of_0
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="var">?Az</span> <span class="main">(</span>wt <span class="skolem">sa</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?w</span> <span class="main">&gt;</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_gt_0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> legalz<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_tpoly <span class="free">A</span> <span class="main">(</span>wt <span class="skolem">sa</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?w</span> <span class="main">&gt;</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> eval_tpoly_eq_eval_ztpoly<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> zhmset_of_less<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> zhmset_of_0
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">*</span> <span class="var">?w</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> k w <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sum_coefs <span class="main">(</span><span class="var">?k</span> <span class="main">*</span> <span class="var">?w</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_coefs_gt_0<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> apps_append <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s δ_eq_0<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inductive Definitions›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">gt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  gt_wt<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> gt_unary<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="main">¬</span> head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">≤≥<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> num_args <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free">arity_sym</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">wt_sym</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> arg <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> arg <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> gt_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> gt_same<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span></span> <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">≥<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">gt_wt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  gt_wtI<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">gt_wt</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">gt_unary</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  gt_unaryI<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="main">¬</span> head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">≤≥<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> num_args <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free">arity_sym</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">wt_sym</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> arg <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">gt_unary</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">gt_diff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  gt_diffI<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">gt_diff</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">gt_same</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  gt_sameI<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">gt_same</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_iff_wt_unary_diff_same<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟷</span> gt_wt <span class="free">t</span> <span class="free">s</span> <span class="main">∨</span> gt_unary <span class="free">t</span> <span class="free">s</span> <span class="main">∨</span> gt_diff <span class="free">t</span> <span class="free">s</span> <span class="main">∨</span> gt_same <span class="free">t</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gt.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gt_wt.simps gt_unary.simps gt_diff.simps gt_same.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gt_imp_wt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> wt <span class="free">t</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> gt.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gt_imp_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> vars <span class="free">t</span> <span class="main">⊇</span> vars <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> wt_ge_vars<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gt_imp_wt<span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Irreflexivity›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">s</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"size <span class="free">s</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> wary_s <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> s_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> s_gt_s
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gt.cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> gt_same
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> wary_s ih <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wary_args extf_irrefl size_in_args<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_hd_def gt_tpoly_irrefl gt_hd_irrefl<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transitivity›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_extf_gt_nil_singleton_if_δ<span class="hidden">⇩</span><sub>h</sub>_eq_ε<span class="hidden">⇩</span><sub>h</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wary_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> δ_eq_ε<span class="main">:</span> <span class="quoted"><span class="quoted">"δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> ε<span class="hidden">⇩</span><sub>h</sub>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">extf</span> <span class="free">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">[]</span> <span class="main">[</span><span class="free">s</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> nil_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="free">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">[]</span> <span class="main">[</span><span class="free">s</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> s_gt_nil <span class="main">=</span> extf_singleton_nil_if_δ<span class="hidden">⇩</span><sub>h</sub>_eq_ε<span class="hidden">⇩</span><sub>h</sub><span class="main">[</span><span class="operator">OF</span> δ_eq_ε<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted">gt</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">extf</span> <span class="free">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> extf_irrefl<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="free">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> extf_trans_from_irrefl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ _ _ _ _ nil_gt_s s_gt_nil<span class="main">]</span> gt_irrefl<span class="main">[</span><span class="operator">OF</span> wary_s<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_sub_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> App <span class="free">s</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">size</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> wary_st <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span>
    <span class="keyword3"><span class="command">assume</span></span>
      legal<span class="main">:</span> <span class="quoted"><span class="quoted">"legal_zpassign <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      wt_st<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="skolem">A</span> <span class="main">(</span>wt <span class="main">(</span>App <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> eval_ztpoly <span class="skolem">A</span> <span class="main">(</span>wt <span class="skolem">t</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> δ_eq_ε<span class="main">:</span> <span class="quoted"><span class="quoted">"δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> ε<span class="hidden">⇩</span><sub>h</sub>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wt_App_fun_δ<span class="hidden">⇩</span><sub>h</sub><span class="main">[</span><span class="operator">OF</span> legal<span class="main">]</span> wt_δ<span class="hidden">⇩</span><sub>h</sub>_imp_δ<span class="hidden">⇩</span><sub>h</sub>_eq_ε<span class="hidden">⇩</span><sub>h</sub><span class="main">[</span><span class="operator">OF</span> legal<span class="main">]</span> wt_st <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> δ_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ε<span class="hidden">⇩</span><sub>h</sub>_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> wt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_ztpoly <span class="skolem">A</span> <span class="main">(</span>wt <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> zhmset_of δ<span class="hidden">⇩</span><sub>h</sub>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wt_App_fun_δ<span class="hidden">⇩</span><sub>h</sub><span class="main"><span class="main">[</span></span><span class="operator">OF</span> legal wt_st<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> wary_t<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wary_AppE<span class="hidden">⇩</span><sub>h</sub><span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_st<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> nargs_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="main">(</span>num_args <span class="skolem">s</span><span class="main">)</span> <span class="main">&lt;</span> arity_hd<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>head <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wary_AppE<span class="hidden">⇩</span><sub>h</sub><span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_st<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> ary_hd_s<span class="main">:</span> <span class="quoted"><span class="quoted">"arity_hd<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>head <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gr_implies_not_zero_hmset legal lt_1_iff_eq_0_hmset nargs_lt neq_iff
        wt_gt_δ<span class="hidden">⇩</span><sub>h</sub>_if_superunary wt_s<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> nargs_s<span class="main">:</span> <span class="quoted"><span class="quoted">"num_args <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_one nargs_lt of_nat_1 of_nat_less_hmset<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> s_eq_hd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> Hd <span class="main">(</span>head <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Hd_head_id<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      f_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      wt_f_etc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wt_sym</span> <span class="skolem">f</span> <span class="main">+</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="skolem">f</span> <span class="main">=</span> δ<span class="hidden">⇩</span><sub>h</sub>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">f</span> <span class="main">∈</span> local.ground_heads <span class="main">(</span>head <span class="skolem">s</span><span class="main">)</span><span class="main">;</span> <span class="free">wt_sym</span> <span class="bound">f</span> <span class="main">+</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="bound">f</span> <span class="main">=</span> δ<span class="hidden">⇩</span><sub>h</sub><span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">thesis</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">-</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="bound">f</span> <span class="main">≤</span> <span class="free">wt_sym</span> <span class="bound">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wt_s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> legal wt_δ<span class="hidden">⇩</span><sub>h</sub>_imp_δ<span class="hidden">⇩</span><sub>h</sub>_eq_ε<span class="hidden">⇩</span><sub>h</sub> wt_sym_ge<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="bound">s</span> <span class="main">+</span> <span class="free">wt_sym</span> <span class="bound">s</span> <span class="main">&lt;</span> δ<span class="hidden">⇩</span><sub>h</sub>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_left' le_imp_minus_plus_hmset leD le_minus_plus_same_hmset
            less_le_trans<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="skolem">thesis</span></span>
        <span class="keyword1"><span class="command">using</span></span> a wt_s s_eq_hd
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exists_wt_sym legal add.commute order.not_eq_order_implies_strict zhmset_of_le<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> ary_f_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">arity_sym</span> <span class="skolem">f</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> δ_gt_0 add_diff_cancel_left' ary_hd_s diff_le_self_hmset dual_order.order_iff_strict
        f_in ground_heads_arity<span class="hidden">⇩</span><sub>h</sub> gt_0_lt_mult_gt_1_hmset hmset_of_enat_1 hmset_of_enat_inject leD
        wt_f_etc<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> wt_f_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wt_sym</span> <span class="skolem">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wt_f_etc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> hd_s_ncmp_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> head <span class="skolem">s</span> <span class="keyword1">≤≥<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_unary<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_App_ge_arg<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hd_s_ncmp_t nargs_s <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> f_in ary_f_1 wt_f_0<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> hd_s_gt_t<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_App_ge_arg<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_s_gt_t<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> ary_f_1 wt_f_0 f_in gt_hd_irrefl gt_sym_antisym unary_wt_sym_0_gt<span class="hidden">⇩</span><sub>h</sub> hmset_of_enat_1
        <span class="keyword1"><span class="command">unfolding</span></span> gt_hd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> hd_t_eq_s<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">t</span> <span class="main">=</span> head <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> nargs_t_le<span class="main">:</span> <span class="quoted"><span class="quoted">"num_args <span class="skolem">t</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ary_hd_s wary_num_args_le_arity_head<span class="hidden">⇩</span><sub>h</sub><span class="main">[</span><span class="operator">OF</span> wary_t<span class="main">]</span> of_nat_le_hmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

      <span class="keyword1"><span class="command">have</span></span> extf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">[</span><span class="skolem">t</span><span class="main">]</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"args <span class="skolem">t</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extf_singleton_nil_if_δ<span class="hidden">⇩</span><sub>h</sub>_eq_ε<span class="hidden">⇩</span><sub>h</sub><span class="main"><span class="main">[</span></span><span class="operator">OF</span> δ_eq_ε<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> args_t<span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">ta</span> <span class="skolem">ts</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ary_hd_s<span class="main">[</span><span class="operator">folded</span> hd_t_eq_s<span class="main">]</span> wary_num_args_le_arity_head<span class="hidden">⇩</span><sub>h</sub><span class="main">[</span><span class="operator">OF</span> wary_t<span class="main">]</span> of_nat_le_hmset
            nargs_t_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> ta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ta</span> <span class="main">=</span> arg <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> apps.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> apps.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> args_t tm.sel<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> tm_collapse_apps ts<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> App <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span> <span class="skolem">ta</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> args.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> args_t not_Cons_self2 tm.exhaust_sel ts<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">ta</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ta</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"fun <span class="skolem"><span class="skolem"><span class="skolem">t</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">folded</span> t<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ wary_t<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> ta size_arg_lt t tm.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> args_t ts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> extf_singleton gt_irrefl wary_t<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_App_ge_arg<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_t_eq_s length_0_conv<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> nargs_s<span class="main"><span class="main">]</span></span> extf<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> comp_hd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> gt_wt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ge_tpoly_def gt_tpoly_def wt_App_ge_arg order.not_eq_order_implies_strict<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">s</span> <span class="main">⟹</span> is_App <span class="free">s</span> <span class="main">⟹</span> <span class="free">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> arg <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gt_sub_arg<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> gt_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">u</span> <span class="main">⟹</span> wary <span class="free">t</span> <span class="main">⟹</span> wary <span class="free">s</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> atomize_imp<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">{#</span></span>size <span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">,</span></span> size <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> size <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">#}</span></span>"</span></span></span>
        <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> wary <span class="bound"><span class="bound">u</span></span> <span class="main"><span class="main">⟶</span></span> wary <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">⟶</span></span> wary <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟶</span></span> <span class="bound"><span class="bound">u</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">⟶</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟶</span></span> <span class="bound"><span class="bound">u</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">u</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">t</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span>
      <span class="operator">simplified</span> prod.case<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all prod.case atomize_imp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">t</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span>
    ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ua</span> <span class="bound">ta</span> <span class="bound">sa</span><span class="main">.</span> <span class="main">{#</span>size <span class="bound">ua</span><span class="main">,</span> size <span class="bound">ta</span><span class="main">,</span> size <span class="bound">sa</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span>size <span class="skolem">u</span><span class="main">,</span> size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span> <span class="main">⟹</span>
      wary <span class="bound">ua</span> <span class="main">⟹</span> wary <span class="bound">ta</span> <span class="main">⟹</span> wary <span class="bound">sa</span> <span class="main">⟹</span> <span class="bound">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">ta</span> <span class="main">⟹</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span> <span class="main">⟹</span> <span class="bound">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    wary_u<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wary_t<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wary_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    u_gt_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> wt_u_ge_t<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="skolem">u</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wt_t_ge_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="skolem">t</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gt_imp_wt u_gt_t t_gt_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> wt_u_ge_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="skolem">u</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ge_ge_tpoly_trans<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> wary_arg_u<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="main">(</span>arg <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wary_arg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_u<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> wary_arg_t<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="main">(</span>arg <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wary_arg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_t<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> wary_arg_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="main">(</span>arg <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wary_arg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_s<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t_gt_s
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> gt_wt_t_s<span class="main">:</span> gt_wt
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wt <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wt_u_ge_t ge_gt_tpoly_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_wt<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_unary_t_s<span class="main">:</span> gt_unary

    <span class="keyword1"><span class="command">have</span></span> t_app<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> args_Nil_iff_is_Hd gt_unary_t_s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> length_greater_0_conv less_numeral_extra<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> nargs_fun_t<span class="main">:</span> <span class="quoted"><span class="quoted">"num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span> <span class="main">&lt;</span> arity_hd <span class="main">(</span>head <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> wary_AppE wary_t<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> δ_eq_ε<span class="main">:</span> <span class="quoted"><span class="quoted">"δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> ε<span class="hidden">⇩</span><sub>h</sub>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gt_unary_t_s<span class="main">(</span>4<span class="main">)</span> unary_wt_sym_0_imp_δ<span class="hidden">⇩</span><sub>h</sub>_eq_ε<span class="hidden">⇩</span><sub>h</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> u_gt_t
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> gt_wt_u_t<span class="main">:</span> gt_wt
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wt <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wt_t_ge_s gt_ge_tpoly_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_wt<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt_unary_u_t<span class="main">:</span> gt_unary
      <span class="keyword1"><span class="command">have</span></span> u_app<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> args_Nil_iff_is_Hd gt_unary_u_t<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> length_greater_0_conv less_numeral_extra<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> nargs_fun_u<span class="main">:</span> <span class="quoted"><span class="quoted">"num_args <span class="main">(</span>fun <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> args.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> gt_unary_u_t<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> one_arg_imp_Hd tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> arg_u_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> u_app gt_unary_u_t<span class="main">(</span>5<span class="main">)</span> t_gt_s size_arg_lt wary_arg_u wary_s wary_t
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">hence</span></span> arg_u_ge_s<span class="main">:</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>

      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>arg <span class="skolem">u</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span>size <span class="skolem">u</span><span class="main">,</span> size <span class="main">(</span>arg <span class="skolem">u</span><span class="main">)</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span>size <span class="skolem">u</span><span class="main">,</span> size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> arg_u_gt_s gt_arg u_app wary_s wary_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>arg <span class="skolem">t</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> arg <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">t</span>"</span></span><span class="main">]</span> args_Nil_iff_is_Hd gt_arg gt_unary_t_s<span class="main">(</span>3<span class="main">)</span> u_gt_t wary_t wary_u
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> args_Nil_iff_is_Hd gt_unary_t_s<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> size_arg_lt wary_arg_t
            wary_s wary_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> sz_u_gt_t<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="skolem">u</span> <span class="main">&gt;</span> size <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sz_t_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="skolem">t</span> <span class="main">&gt;</span> size <span class="skolem">s</span>"</span></span>

        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> hd_u_eq_s<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="main">=</span> head <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> ary_hd_s<span class="main">:</span> <span class="quoted"><span class="quoted">"arity_hd <span class="main">(</span>head <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ground_heads_arity gt_unary_u_t<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> hd_u_eq_s one_enat_def
              wary_num_args_le_arity_head wary_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

          <span class="keyword1"><span class="command">have</span></span> extf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"args <span class="skolem">s</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> Nil
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> δ_eq_ε args.elims args_Nil_iff_is_Hd extf_snoc_if_δ<span class="hidden">⇩</span><sub>h</sub>_eq_ε<span class="hidden">⇩</span><sub>h</sub> length_0_conv
                nargs_fun_u tm.sel<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> u_app<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> args_s<span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">sa</span> <span class="skolem">ss</span><span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> One_nat_def antisym_conv ary_hd_s diff_Suc_1
                enat_ord_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> le_add2 length_0_conv length_Cons list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> one_enat_def
                wary_num_args_le_arity_head wary_s<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> sa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">=</span> arg <span class="skolem">s</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> apps.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> apps.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> args_s tm.sel<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> tm_collapse_apps ss<span class="main">)</span>

            <span class="keyword1"><span class="command">have</span></span> s_app<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="skolem">s</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> args_Nil_iff_is_Hd args_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
            <span class="keyword1"><span class="command">have</span></span> args_u<span class="main">:</span> <span class="quoted"><span class="quoted">"args <span class="skolem">u</span> <span class="main">=</span> <span class="main">[</span>arg <span class="skolem">u</span><span class="main">]</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil args.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> args_Nil_iff_is_Hd gt_unary_u_t<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> length_0_conv
                nargs_fun_u tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> zero_neq_one<span class="main">)</span>

            <span class="keyword1"><span class="command">have</span></span> max_sz_arg_u_t_arg_t<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="main">{</span>size <span class="main">(</span>arg <span class="skolem">t</span><span class="main">)</span><span class="main">,</span> size <span class="skolem">t</span><span class="main">,</span> size <span class="main">(</span>arg <span class="skolem">u</span><span class="main">)</span><span class="main">}</span> <span class="main">&lt;</span> size <span class="skolem">u</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> size_arg_lt sz_u_gt_t t_app u_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span>size <span class="main">(</span>arg <span class="skolem">u</span><span class="main">)</span><span class="main">,</span> size <span class="skolem">t</span><span class="main">,</span> size <span class="main">(</span>arg <span class="skolem">t</span><span class="main">)</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span>size <span class="skolem">u</span><span class="main">,</span> size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> max_sz_arg_u_t_arg_t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Max_lt_imp_lt_mset<span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> arg_u_gt_arg_t<span class="main">:</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> arg <span class="skolem">t</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">OF</span> _ wary_arg_u wary_t wary_arg_t<span class="main">]</span> args_Nil_iff_is_Hd gt_arg
                gt_unary_t_s<span class="main">(</span>3<span class="main">)</span> gt_unary_u_t<span class="main">(</span>5<span class="main">)</span> wary_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

            <span class="keyword1"><span class="command">have</span></span> max_sz_arg_s_s_arg_t<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="main">{</span>size <span class="main">(</span>arg <span class="skolem">s</span><span class="main">)</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">,</span> size <span class="main">(</span>arg <span class="skolem">t</span><span class="main">)</span><span class="main">}</span> <span class="main">&lt;</span> size <span class="skolem">u</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> s_app t_app size_arg_lt sz_t_gt_s sz_u_gt_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span>size <span class="main">(</span>arg <span class="skolem">t</span><span class="main">)</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">,</span> size <span class="main">(</span>arg <span class="skolem">s</span><span class="main">)</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span>size <span class="skolem">u</span><span class="main">,</span> size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> max_sz_arg_s_s_arg_t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Max_lt_imp_lt_mset<span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> arg_t_gt_arg_s<span class="main">:</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> arg <span class="skolem">s</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">OF</span> _ wary_arg_t wary_s wary_arg_s<span class="main">]</span>
                gt_unary_t_s<span class="main">(</span>5<span class="main">)</span> gt_arg args_Nil_iff_is_Hd args_s wary_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span>size <span class="main">(</span>arg <span class="skolem">u</span><span class="main">)</span><span class="main">,</span> size <span class="main">(</span>arg <span class="skolem">t</span><span class="main">)</span><span class="main">,</span> size <span class="main">(</span>arg <span class="skolem">s</span><span class="main">)</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span>size <span class="skolem">u</span><span class="main">,</span> size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_mset_lt_lt_lt <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size_arg_lt u_app t_app s_app<span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> arg <span class="skolem">s</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">s</span>"</span></span><span class="main">]</span> arg_u_gt_arg_t arg_t_gt_arg_s wary_arg_s
                wary_arg_t wary_arg_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> args_u args_s ss sa <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> extf_singleton gt_irrefl wary_arg_u<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>

          <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_u_ge_s hd_u_eq_s<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extf<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_u_ge_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">using</span></span> gt_hd_def gt_hd_irrefl gt_sym_antisym gt_unary_u_t<span class="main">(</span>4<span class="main">)</span> unary_wt_sym_0_gt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> head <span class="skolem">u</span> <span class="keyword1">≤≥<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_unary<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_u_ge_s _ gt_unary_u_t<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span> arg_u_ge_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> comp_hd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> less_le_trans linorder_not_le size_arg_lt t_app u_app<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt_diff_u_t<span class="main">:</span> gt_diff
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> gt_diff_u_t<span class="main">(</span>2<span class="main">)</span> gt_hd_def gt_hd_irrefl gt_sym_antisym gt_unary_t_s<span class="main">(</span>4<span class="main">)</span> unary_wt_sym_0_gt
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt_same_u_t<span class="main">:</span> gt_same

      <span class="keyword1"><span class="command">have</span></span> hd_u_ncomp_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> head <span class="skolem">u</span> <span class="keyword1">≤≥<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_unary_t_s<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">folded</span> gt_same_u_t<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="skolem">u</span><span class="main">)</span><span class="main">.</span> <span class="free">arity_sym</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">wt_sym</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_unary_t_s<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">folded</span> gt_same_u_t<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"arity_hd <span class="main">(</span>head <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.order_iff_strict gr_implies_not_zero_hmset ground_heads_arity
          gt_same_u_t<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> head_fun hmset_of_enat_1 hmset_of_enat_less lt_1_iff_eq_0_hmset
          nargs_fun_t<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"num_args <span class="skolem">u</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> of_nat_le_hmset wary_num_args_le_arity_head<span class="hidden">⇩</span><sub>h</sub> wary_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">hence</span></span> nargs_u<span class="main">:</span> <span class="quoted"><span class="quoted">"num_args <span class="skolem">u</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"args <span class="skolem">u</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
          <span class="operator">metis</span> Hd_head_id δ_eq_ε append_Nil args.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
            ex_in_conv<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> ground_heads_nonempty<span class="main"><span class="main">]</span></span> gt_same_u_t<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> gt_unary_t_s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
            head_fun list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_extf_gt_nil_singleton_if_δ<span class="hidden">⇩</span><sub>h</sub>_eq_ε<span class="hidden">⇩</span><sub>h</sub> one_arg_imp_Hd
            tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> t_app<span class="main"><span class="main">]</span></span> wary_arg_t<span class="main"><span class="keyword3">,</span></span>
          <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> u_app<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> arg <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> extf_singleton<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span> append_Nil args.simps args_Nil_iff_is_Hd comp_hd_def
          gt_hd_def gt_irrefl gt_same_u_t<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> gt_unary_t_s<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> head_fun length_0_conv nargs_u
          one_arg_imp_Hd t_app tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> u_gt_t wary_u<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span>size <span class="main">(</span>arg <span class="skolem">u</span><span class="main">)</span><span class="main">,</span> size <span class="main">(</span>arg <span class="skolem">t</span><span class="main">)</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span>size <span class="skolem">u</span><span class="main">,</span> size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_mset_lt_lt_lt <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size_arg_lt u_app t_app<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">OF</span> _ wary_arg_u wary_arg_t wary_s<span class="main">]</span> gt_unary_t_s<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> arg_u_ge_s<span class="main">:</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_unary<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_u_ge_s hd_u_ncomp_s nargs_u _ arg_u_ge_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gt_same_u_t<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> gt_unary_t_s<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_diff_t_s<span class="main">:</span> gt_diff
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> u_gt_t
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> gt_wt_u_t<span class="main">:</span> gt_wt
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wt <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wt_t_ge_s gt_ge_tpoly_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_wt<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt_unary_u_t<span class="main">:</span> gt_unary
      <span class="keyword1"><span class="command">have</span></span> u_app<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> args_Nil_iff_is_Hd gt_unary_u_t<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> length_greater_0_conv less_numeral_extra<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> gt_unary_u_t<span class="main">(</span>5<span class="main">)</span> t_gt_s size_arg_lt wary_arg_u wary_s wary_t
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">hence</span></span> arg_u_ge_s<span class="main">:</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>

      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="main">=</span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> gt_diff_t_s<span class="main">(</span>2<span class="main">)</span> gt_unary_u_t<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> comp_hd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> gt_hd_def gt_hd_irrefl gt_sym_antisym gt_unary_u_t<span class="main">(</span>4<span class="main">)</span> unary_wt_sym_0_gt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_u_ge_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> head <span class="skolem">u</span> <span class="keyword1">≤≥<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_unary<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_u_ge_s _ gt_unary_u_t<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span> arg_u_ge_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> comp_hd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt_diff_u_t<span class="main">:</span> gt_diff
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_diff_u_t<span class="main">(</span>2<span class="main">)</span> gt_diff_t_s<span class="main">(</span>2<span class="main">)</span> gt_hd_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_u_ge_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt_same_u_t<span class="main">:</span> gt_same
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_diff_t_s<span class="main">(</span>2<span class="main">)</span> gt_same_u_t<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_u_ge_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_same_t_s<span class="main">:</span> gt_same
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> u_gt_t
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> gt_wt_u_t<span class="main">:</span> gt_wt
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wt <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wt_t_ge_s gt_ge_tpoly_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_wt<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt_unary_u_t<span class="main">:</span> gt_unary
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_App <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> args_Nil_iff_is_Hd gt_unary_u_t<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> length_greater_0_conv less_numeral_extra<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> gt_unary_u_t<span class="main">(</span>5<span class="main">)</span> t_gt_s size_arg_lt wary_arg_u wary_s wary_t
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">hence</span></span> arg_u_ge_s<span class="main">:</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> head <span class="skolem">u</span> <span class="keyword1">≤≥<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_same_t_s<span class="main">(</span>2<span class="main">)</span> gt_unary_u_t<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_unary<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_u_ge_s _ gt_unary_u_t<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span> arg_u_ge_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt_diff_u_t<span class="main">:</span> gt_diff
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_diff_u_t<span class="main">(</span>2<span class="main">)</span> gt_same_t_s<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_u_ge_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt_same_u_t<span class="main">:</span> gt_same
      <span class="keyword1"><span class="command">have</span></span> hd_u_s<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="main">=</span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> gt_same_t_s<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> gt_same_u_t<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>args <span class="skolem">u</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> gt_trans_args<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ua</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ta</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">sa</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="bound">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">ta</span> <span class="main">⟶</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span> <span class="main">⟶</span> <span class="bound">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="skolem">ta</span> <span class="skolem">ua</span>
        <span class="keyword3"><span class="command">assume</span></span>
          ua_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ua</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ta_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ta</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sa_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          ua_gt_ta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">ta</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ta_gt_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">sa</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> wary_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="skolem">sa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wary_ta<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="skolem">ta</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wary_ua<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="skolem">ua</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> wary_args ua_in ta_in sa_in wary_u wary_t wary_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">sa</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ih<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Max_lt_imp_lt_mset wary_ua wary_ta wary_sa ua_gt_ta ta_gt_sa<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="main">(</span><span class="operator">meson</span> ua_in ta_in sa_in Un_iff max.strict_coboundedI1 max.strict_coboundedI2
               size_in_args<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="skolem">u</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> extf_trans_from_irrefl<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?S</span></span></span></span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"args <span class="skolem"><span class="skolem"><span class="skolem">t</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _ _ _ _ gt_trans_args<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gt_same_u_t<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> gt_same_t_s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> wary_args wary_u wary_t wary_s gt_irrefl<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_u_ge_s hd_u_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_antisym<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">s</span> <span class="main">⟹</span> wary <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gt_irrefl gt_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Subterm Property›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_sub_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"App <span class="free">s</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="free">s</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> gt_wt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> δ_eq_ε<span class="main">:</span> <span class="quoted"><span class="quoted">"δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> ε<span class="hidden">⇩</span><sub>h</sub>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wt_App_ge_fun dual_order.order_iff_strict wt_App_arg_δ<span class="hidden">⇩</span><sub>h</sub> wt_δ<span class="hidden">⇩</span><sub>h</sub>_imp_δ<span class="hidden">⇩</span><sub>h</sub>_eq_ε<span class="hidden">⇩</span><sub>h</sub>
    <span class="keyword1"><span class="command">unfolding</span></span> gt_tpoly_def ge_tpoly_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

  <span class="keyword1"><span class="command">have</span></span> hd_st<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> head <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> extf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> δ_eq_ε extf_snoc_if_δ<span class="hidden">⇩</span><sub>h</sub>_eq_ε<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_App_ge_fun hd_st extf<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_proper_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">t</span> <span class="main">⟹</span> proper_sub <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gt_sub_fun gt_sub_arg gt_trans sub.intros wary_sub<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Compatibility with Functions›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_compat_fun<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    wary_t<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    t'_gt_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"App <span class="free">s</span> <span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> App <span class="free">s</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t'</span><span class="main">)</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gt_imp_wt<span class="main">[</span><span class="operator">OF</span> t'_gt_t<span class="main">,</span> <span class="operator">unfolded</span> ge_tpoly_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tm_exhaust_apps<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> apps_append <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ge_tpoly_def App_apps eval_ztpoly_nonneg
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ordered_comm_semiring_class.comm_mult_left_mono<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="free">s</span> <span class="main">@</span> <span class="main">[</span><span class="free">t'</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>args <span class="free">s</span> <span class="main">@</span> <span class="main">[</span><span class="free">t</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t'_gt_t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> extf_compat_list gt_irrefl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_t<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="main">(</span>App <span class="free">s</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">theorem</span></span> gt_compat_fun_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    wary_t<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    t'_gt_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"apps <span class="free">s</span> <span class="main">(</span><span class="free">t'</span> <span class="main">#</span> <span class="free">us</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> apps <span class="free">s</span> <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">us</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">us</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> t'_gt_t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gt_compat_fun<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_t<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">u</span> <span class="skolem">us</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> snoc

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"apps <span class="free">s</span> <span class="main">(</span><span class="free">t'</span> <span class="main">#</span> <span class="skolem">us</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"apps <span class="free">s</span> <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="skolem">us</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wt <span class="var">?v'</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="var">?v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gt_imp_wt<span class="main">[</span><span class="operator">OF</span> ih<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tm_exhaust_apps<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> apps_append <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> App_apps apps_append<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ge_tpoly_def<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> zip_eq_butlast_last<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="var">?v'</span> <span class="main">=</span> head <span class="var">?v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="var">?v'</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="var">?v'</span><span class="main">)</span> <span class="main">(</span>args <span class="var">?v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> args_apps extf_compat_list gt_irrefl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_t<span class="main"><span class="main">]</span></span> t'_gt_t<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Compatibility with Arguments›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_compat_arg_weak<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    wary_st<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    wary_s't<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="main">(</span>App <span class="free">s'</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    coef_s'_0_ge_s<span class="main">:</span> <span class="quoted"><span class="quoted">"coef <span class="free">s'</span> <span class="main">0</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> coef <span class="free">s</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s'_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"App <span class="free">s'</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> App <span class="free">s</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ζ</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> apps <span class="main">(</span>Hd <span class="skolem">ζ</span><span class="main">)</span> <span class="skolem">ss</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tm_exhaust_apps<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ζ'</span></span> <span class="skolem"><span class="skolem">ss'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> apps <span class="main">(</span>Hd <span class="skolem">ζ'</span><span class="main">)</span> <span class="skolem">ss'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tm_exhaust_apps<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> len_ss_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span> <span class="main">&lt;</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wary_st<span class="main">[</span><span class="operator">unfolded</span> s<span class="main">]</span> ground_heads_arity<span class="hidden">⇩</span><sub>h</sub> less_le_trans min_ground_head_in_ground_heads
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> tm_collapse_apps tm_inject_apps wary_AppE<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> δ_etc<span class="main">:</span>
    <span class="quoted"><span class="quoted">"δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">+</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> <span class="main">(</span>arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span> <span class="main">-</span> of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span>
     δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> <span class="main">(</span>arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span> <span class="main">-</span> of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> wary<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="main">(</span>App <span class="main">(</span>apps <span class="main">(</span>Hd <span class="skolem">ζ</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ζ</span> <span class="skolem">ss</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="skolem">n</span> <span class="main">=</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arity_sym<span class="hidden">⇩</span><sub>h</sub>_if_δ<span class="hidden">⇩</span><sub>h</sub>_gt_0_E<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span> <span class="main">&lt;</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wary
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> wary_AppE<span class="hidden">⇩</span><sub>h</sub> ground_heads_arity<span class="hidden">⇩</span><sub>h</sub> le_less_trans
        min_ground_head_in_ground_heads not_le tm_collapse_apps tm_inject_apps<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> n<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> of_nat_1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fold</span> of_nat_minus_hmset<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">metis</span> Suc_diff_Suc mult_Suc_right of_nat_add of_nat_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> coef_ζ'_ge_ζ<span class="main">:</span> <span class="quoted"><span class="quoted">"coef_hd <span class="skolem">ζ'</span> <span class="main">(</span>length <span class="skolem">ss'</span><span class="main">)</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> coef_hd <span class="skolem">ζ</span> <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> coef_s'_0_ge_s<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> s s'<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> wt_s'_ge_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="free">s'</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_imp_wt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s'_gt_s<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> ζ_tms_len_ss_tms_wt_t_le<span class="main">:</span>
    <span class="quoted"><span class="quoted">"eval_ztpoly <span class="skolem">A</span> <span class="main">(</span>coef_hd <span class="skolem">ζ</span> <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> eval_ztpoly <span class="skolem">A</span> <span class="main">(</span>wt <span class="free">t</span><span class="main">)</span>
     <span class="main">≤</span> eval_ztpoly <span class="skolem">A</span> <span class="main">(</span>coef_hd <span class="skolem">ζ'</span> <span class="main">(</span>length <span class="skolem">ss'</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> eval_ztpoly <span class="skolem">A</span> <span class="main">(</span>wt <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> legal<span class="main">:</span> <span class="quoted"><span class="quoted">"legal_zpassign <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span>
    <span class="keyword1"><span class="command">using</span></span> legal coef_ζ'_ge_ζ<span class="main">[</span><span class="operator">unfolded</span> ge_tpoly_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_ztpoly_nonneg mult_right_mono<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> wt_s't_ge_st<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>App <span class="free">s'</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> s s'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> apps_append <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> App_apps ge_tpoly_def add_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ ζ_tms_len_ss_tms_wt_t_le<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">rule</span> add_le_imp_le_left<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"zhmset_of δ<span class="hidden">⇩</span><sub>h</sub>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">unfold</span> add_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> add.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> diff_diff_add<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 3<span class="main"><span class="main">)</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> add_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 3<span class="main"><span class="main">)</span></span> add_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> zhmset_of_plus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> δ_etc<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_st<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">unfolded</span> s<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
        δ_etc<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_s't<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">unfolded</span> s'<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> add_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
        wt_s'_ge_s<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> s s'<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> ge_tpoly_def add_ac<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> s'_gt_s
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> gt_wt_s'_s<span class="main">:</span> gt_wt

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>App <span class="free">s'</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> s s'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> apps_append <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> App_apps gt_tpoly_def add_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_less_le_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ ζ_tms_len_ss_tms_wt_t_le<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule</span> add_less_imp_less_left<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"zhmset_of δ<span class="hidden">⇩</span><sub>h</sub>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">unfold</span> add_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> add.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> diff_diff_add<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 3<span class="main"><span class="main">)</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> add_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 3<span class="main"><span class="main">)</span></span> add_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> zhmset_of_plus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> δ_etc<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_st<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">unfolded</span> s<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
          δ_etc<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_s't<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">unfolded</span> s'<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> add_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
          gt_wt_s'_s<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> s s'<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> gt_tpoly_def add_ac<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_wt<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_unary_s'_s<span class="main">:</span> gt_unary
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ground_heads_arity<span class="hidden">⇩</span><sub>h</sub> gt_unary_s'_s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> gt_unary_s'_s<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> hmset_of_enat_1 leD of_nat_1
        wary_AppE<span class="hidden">⇩</span><sub>h</sub> wary_s't<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_diff_s'_s<span class="main">:</span> gt_diff
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_s't_ge_st<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gt_diff_s'_s<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_same_s'_s<span class="main">:</span> gt_same
    <span class="keyword1"><span class="command">have</span></span> hd_s't<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="main">(</span>App <span class="free">s'</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> head <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gt_same_s'_s<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="main">(</span>App <span class="free">s'</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="main">(</span>App <span class="free">s'</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gt_same_s'_s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> extf_compat_append_right<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_s't_ge_st hd_s't<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Stability under Substitution›</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">subst_zpassign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> pvar <span class="main">⇒</span> zhmultiset<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'v</span> pvar <span class="main">⇒</span> zhmultiset"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst_zpassign</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>PWt <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span>
   eval_ztpoly <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>wt <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> zhmset_of <span class="main">(</span>δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_zpassign</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>PCoef <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> eval_ztpoly <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>coef <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> legal_subst_zpassign<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    legal<span class="main">:</span> <span class="quoted"><span class="quoted">"legal_zpassign <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    wary_ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"wary_subst <span class="free">ρ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"legal_zpassign <span class="main">(</span>subst_zpassign <span class="free">ρ</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> legal_zpassign_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subst_zpassign <span class="free">ρ</span> <span class="free">A</span> <span class="skolem">v</span> <span class="main">≥</span> min_zpassign <span class="skolem">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> v<span class="main">:</span> <span class="main">(</span>PWt <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ζ</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> ρx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="skolem">x</span> <span class="main">=</span> apps <span class="main">(</span>Hd <span class="skolem">ζ</span><span class="main">)</span> <span class="skolem">ss</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tm_exhaust_apps<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> ghd_ζ<span class="main">:</span> <span class="quoted"><span class="quoted">"ground_heads <span class="skolem">ζ</span> <span class="main">⊆</span> <span class="free">ground_heads_var</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wary_ρ<span class="main">[</span><span class="operator">unfolded</span> wary_subst_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">,</span> <span class="operator">unfolded</span> ρx<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zhmset_of <span class="main">(</span><span class="free">wt_sym</span> <span class="main">(</span>min_ground_head <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">≤</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt0 <span class="skolem">ζ</span><span class="main">)</span> <span class="main">+</span> zhmset_of <span class="main">(</span>δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> mgh_x_min<span class="main">:</span>
        <span class="quoted"><span class="quoted">"zhmset_of <span class="main">(</span><span class="free">wt_sym</span> <span class="main">(</span>min_ground_head <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
         <span class="main">≤</span> zhmset_of <span class="main">(</span><span class="free">wt_sym</span> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span> <span class="main">+</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmset_of_le zhmset_of_le ghd_ζ min_ground_head_antimono<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> wt_mgh_le_wt0<span class="main">:</span> <span class="quoted"><span class="quoted">"zhmset_of <span class="main">(</span><span class="free">wt_sym</span> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt0 <span class="skolem">ζ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wt0_ge_min_ground_head<span class="main">[</span><span class="operator">OF</span> legal<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mgh_x_min<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zhmset_of_plus wt_mgh_le_wt0<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt0 <span class="skolem">ζ</span><span class="main">)</span>
      <span class="main">+</span> zhmset_of <span class="main">(</span><span class="main">(</span>δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> <span class="main">(</span>arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span> <span class="main">-</span> of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">+</span> of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span> <span class="main">*</span> δ<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zhmset_of <span class="main">(</span>δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span><span class="main">)</span>
        <span class="main">≤</span> zhmset_of <span class="main">(</span>δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> <span class="main">(</span>of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span>
          <span class="main">+</span> <span class="main">(</span>arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span> <span class="main">-</span> of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute le_minus_plus_same_hmset mult_le_mono2_hmset zhmset_of_le<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute add.left_commute distrib_left mult.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt0 <span class="skolem">ζ</span><span class="main">)</span>
      <span class="main">+</span> zhmset_of <span class="main">(</span><span class="main">(</span>δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> <span class="main">(</span>arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span> <span class="main">-</span> of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">+</span> of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span> <span class="main">*</span> ε<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> δ<span class="hidden">⇩</span><sub>h</sub>_le_ε<span class="hidden">⇩</span><sub>h</sub> zhmset_of_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt0 <span class="skolem">ζ</span><span class="main">)</span>
      <span class="main">+</span> zhmset_of <span class="main">(</span>δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> <span class="main">(</span>arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span> <span class="main">-</span> of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> wt_args <span class="main">0</span> <span class="free">A</span> <span class="skolem">ζ</span> <span class="skolem">ss</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wt_args_ge_length_times_ε<span class="hidden">⇩</span><sub>h</sub><span class="main">[</span><span class="operator">OF</span> legal<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> zhmset_of_plus zhmset_of_times of_nat_zhmset<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> wt_x_le_ζssts<span class="main">:</span>
      <span class="quoted"><span class="quoted">"zhmset_of <span class="main">(</span><span class="free">wt_sym</span> <span class="main">(</span>min_ground_head <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">≤</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt0 <span class="skolem">ζ</span><span class="main">)</span>
         <span class="main">+</span> zhmset_of <span class="main">(</span>δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> <span class="main">(</span>arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ζ</span><span class="main">)</span> <span class="main">-</span> of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
         <span class="main">+</span> wt_args <span class="main">0</span> <span class="free">A</span> <span class="skolem">ζ</span> <span class="skolem">ss</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> wt_x_le_ζssts<span class="main">[</span><span class="operator">unfolded</span> wt_args_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> v ρx comp_def le_diff_eq add.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ZHMSet_plus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        zmset_of_plus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> hmsetmset_plus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> zmset_of_le<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PCoef <span class="skolem">x</span> <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> coef_gt_0<span class="main">[</span><span class="operator">OF</span> legal<span class="main">,</span> <span class="operator">unfolded</span> zero_less_iff_1_le_hmset<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zhmset_of_1 zero_less_iff_1_le_zhmset<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wt_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    legal<span class="main">:</span> <span class="quoted"><span class="quoted">"legal_zpassign <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    wary_ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"wary_subst <span class="free">ρ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wary <span class="free">s</span> <span class="main">⟹</span> eval_ztpoly <span class="free">A</span> <span class="main">(</span>wt <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> eval_ztpoly <span class="main">(</span>subst_zpassign <span class="free">ρ</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>wt <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tm_induct_apps<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>apps <span class="skolem">ζ</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> wary_ζss <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> wary_nth_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">ss</span> <span class="main">⟹</span> wary <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wary_args<span class="main">[</span><span class="operator">OF</span> _ wary_ζss<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ζ</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> ζ<span class="main">:</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="skolem">x</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tm_exhaust_apps<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> ρx<span class="main">:</span> <span class="main">(</span>apps <span class="skolem">ξ</span> <span class="skolem">ts</span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> wary_ρx<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="main">(</span><span class="free">ρ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wary_ρ wary_subst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">have</span></span> coef_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> eval_tpoly <span class="free">A</span> <span class="main">(</span>zhmset_of_tpoly <span class="main">(</span>coef_hd <span class="skolem">ξ</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> length <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        eval_tpoly <span class="main">(</span>subst_zpassign <span class="free">ρ</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>zhmset_of_tpoly <span class="main">(</span>coef_hd <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ρx<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> tedious_ary_arith<span class="main">:</span>
        <span class="quoted"><span class="quoted">"arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>
         <span class="main">+</span> <span class="main">(</span>arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ξ</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span> <span class="main">+</span> of_nat <span class="main">(</span>length <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ξ</span><span class="main">)</span> <span class="main">-</span> of_nat <span class="main">(</span>length <span class="skolem">ts</span><span class="main">)</span>
         <span class="main">+</span> <span class="main">(</span>arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> δ_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="skolem">m</span> <span class="main">=</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arity_sym<span class="hidden">⇩</span><sub>h</sub>_if_δ<span class="hidden">⇩</span><sub>h</sub>_gt_0_E<span class="main"><span class="main">[</span></span><span class="operator">OF</span> δ_gt_0<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="skolem">n</span> <span class="main">=</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ξ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arity_sym<span class="hidden">⇩</span><sub>h</sub>_if_δ<span class="hidden">⇩</span><sub>h</sub>_gt_0_E<span class="main"><span class="main">[</span></span><span class="operator">OF</span> δ_gt_0<span class="main"><span class="main">]</span></span><span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≥</span> length <span class="skolem">ss</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> of_nat_le_hmset<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> m <span class="keyword1"><span class="command">using</span></span> wary_ζss<span class="main">[</span><span class="operator">unfolded</span> ζ<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wary_cases_apps<span class="hidden">⇩</span><sub>h</sub><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span>
            <span class="operator">metis</span> arity_hd.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> enat_ile enat_ord_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ground_heads_arity
              hmset_of_enat_inject hmset_of_enat_of_nat le_trans m min_ground_head_in_ground_heads
              of_nat_eq_enat of_nat_le_hmset_of_enat_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> n_ge_len_ss_ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> length <span class="skolem">ss</span> <span class="main">+</span> length <span class="skolem">ts</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span> <span class="main">+</span> of_nat <span class="main">(</span>length <span class="skolem">ts</span><span class="main">)</span> <span class="main">≤</span> arity_hd<span class="hidden">⇩</span><sub>h</sub> <span class="skolem">ζ</span> <span class="main">+</span> of_nat <span class="main">(</span>length <span class="skolem">ts</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> wary_ζss wary_cases_apps<span class="hidden">⇩</span><sub>h</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> arity_var<span class="hidden">⇩</span><sub>h</sub> <span class="skolem">x</span> <span class="main">+</span> of_nat <span class="main">(</span>length <span class="skolem">ts</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ζ<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> arity<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span><span class="free">ρ</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> of_nat <span class="main">(</span>length <span class="skolem">ts</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> wary_ρ wary_subst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> arity<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>apps <span class="main">(</span>Hd <span class="skolem">ξ</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">+</span> of_nat <span class="main">(</span>length <span class="skolem">ts</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ρx<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> arity_hd<span class="hidden">⇩</span><sub>h</sub> <span class="skolem">ξ</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> wary_ρx<span class="main">[</span><span class="operator">unfolded</span> ρx<span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wary_cases_apps<span class="hidden">⇩</span><sub>h</sub><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"arity_hd <span class="skolem">ξ</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
              <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_add<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> of_nat_minus_hmset<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
              <span class="operator">metis</span> δ_gt_0 arity_hd_ne_infinity_if_δ_gt_0 of_nat_0 of_nat_less_hmset<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ξ</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ground_heads_arity<span class="hidden">⇩</span><sub>h</sub> min_ground_head_in_ground_heads <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> of_nat_le_hmset<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> length <span class="skolem">ts</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> n_ge_len_ss_ts <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> m n of_nat_add of_nat_minus_hmset<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> of_nat_inject_hmset<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_tpoly <span class="free">A</span> <span class="main">(</span>zhmset_of_tpoly <span class="main">(</span>wt <span class="main">(</span>subst <span class="free">ρ</span> <span class="main">(</span>apps <span class="main">(</span>Hd <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        eval_tpoly <span class="free">A</span> <span class="main">(</span>zhmset_of_tpoly <span class="main">(</span>wt0 <span class="skolem">ξ</span><span class="main">)</span><span class="main">)</span>
        <span class="main">+</span> zhmset_of <span class="main">(</span>δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> <span class="main">(</span>arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ξ</span><span class="main">)</span>
          <span class="main">-</span> <span class="main">(</span>of_nat <span class="main">(</span>length <span class="skolem">ts</span><span class="main">)</span> <span class="main">+</span> of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">+</span> wt_args <span class="main">0</span> <span class="free">A</span> <span class="skolem">ξ</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">@</span> map <span class="main">(</span>subst <span class="free">ρ</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> apps_append <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apps_append<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ρx wt_args_def comp_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> eval_tpoly <span class="free">A</span> <span class="main">(</span>zhmset_of_tpoly <span class="main">(</span>wt0 <span class="skolem">ξ</span><span class="main">)</span><span class="main">)</span>
        <span class="main">+</span> zhmset_of <span class="main">(</span>δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> <span class="main">(</span>arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ξ</span><span class="main">)</span>
          <span class="main">-</span> <span class="main">(</span>of_nat <span class="main">(</span>length <span class="skolem">ts</span><span class="main">)</span> <span class="main">+</span> of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">+</span> wt_args <span class="main">0</span> <span class="free">A</span> <span class="skolem">ξ</span> <span class="skolem">ts</span> <span class="main">+</span> wt_args <span class="main">(</span>length <span class="skolem">ts</span><span class="main">)</span> <span class="free">A</span> <span class="skolem">ξ</span> <span class="main">(</span>map <span class="main">(</span>subst <span class="free">ρ</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_args_def zip_append_0_upt<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>subst <span class="free">ρ</span><span class="main">)</span> <span class="skolem">ss</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> eval_tpoly <span class="free">A</span> <span class="main">(</span>zhmset_of_tpoly <span class="main">(</span>wt0 <span class="skolem">ξ</span><span class="main">)</span><span class="main">)</span>
        <span class="main">+</span> zhmset_of <span class="main">(</span>δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> <span class="main">(</span>arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="skolem">ξ</span><span class="main">)</span>
          <span class="main">-</span> <span class="main">(</span>of_nat <span class="main">(</span>length <span class="skolem">ts</span><span class="main">)</span> <span class="main">+</span> of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">+</span> wt_args <span class="main">0</span> <span class="free">A</span> <span class="skolem">ξ</span> <span class="skolem">ts</span> <span class="main">+</span> wt_args <span class="main">0</span> <span class="main">(</span>subst_zpassign <span class="free">ρ</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span> <span class="skolem">ss</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">sum_list</span><span class="main"><span class="main">]</span></span> nth_map_conv
          <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wt_args_def coef_subst add.commute zhmset_of_times ih<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nth_mem wary_nth_ss<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> eval_tpoly <span class="main">(</span>subst_zpassign <span class="free">ρ</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>zhmset_of_tpoly <span class="main">(</span>wt0 <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">+</span> zhmset_of <span class="main">(</span>δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> <span class="main">(</span>arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>min_ground_head <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">+</span> wt_args <span class="main">0</span> <span class="main">(</span>subst_zpassign <span class="free">ρ</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span> <span class="skolem">ss</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ρx wt_args_def comp_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> ring_distribs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
              zhmset_of_times zhmset_of_plus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> zhmset_of_0<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">use</span> tedious_ary_arith <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">fastforce</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> eval_tpoly <span class="main">(</span>subst_zpassign <span class="free">ρ</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>zhmset_of_tpoly <span class="main">(</span>wt <span class="main">(</span>apps <span class="main">(</span>Hd <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_args_def comp_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ζ <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> ζ<span class="main">:</span> <span class="main">(</span>Sym <span class="skolem">f</span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_tpoly <span class="free">A</span> <span class="main">(</span>zhmset_of_tpoly <span class="main">(</span>wt <span class="main">(</span>subst <span class="free">ρ</span> <span class="main">(</span>apps <span class="main">(</span>Hd <span class="main">(</span>Sym <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      zhmset_of <span class="main">(</span><span class="free">wt_sym</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">+</span> zhmset_of <span class="main">(</span>δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> <span class="main">(</span>arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="skolem">f</span> <span class="main">-</span> of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">+</span> wt_args <span class="main">0</span> <span class="free">A</span> <span class="main">(</span>Sym <span class="skolem">f</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>subst <span class="free">ρ</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_args_def comp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> zhmset_of <span class="main">(</span><span class="free">wt_sym</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">+</span> zhmset_of <span class="main">(</span>δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">*</span> <span class="main">(</span>arity_sym<span class="hidden">⇩</span><sub>h</sub> <span class="skolem">f</span> <span class="main">-</span> of_nat <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">+</span> wt_args <span class="main">0</span> <span class="main">(</span>subst_zpassign <span class="free">ρ</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>Sym <span class="skolem">f</span><span class="main">)</span> <span class="skolem">ss</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wt_args_def ih<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ wary_nth_ss<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">sum_list</span><span class="main"><span class="main">]</span></span>
        nth_map_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> eval_tpoly <span class="main">(</span>subst_zpassign <span class="free">ρ</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>zhmset_of_tpoly <span class="main">(</span>wt <span class="main">(</span>apps <span class="main">(</span>Hd <span class="main">(</span>Sym <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_args_def comp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ζ <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wary_ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"wary_subst <span class="free">ρ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wary <span class="free">t</span> <span class="main">⟹</span> wary <span class="free">s</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> subst <span class="free">ρ</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> atomize_imp<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">{#</span></span>size <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> size <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">#}</span></span>"</span></span></span>
        <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> wary <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">⟶</span></span> wary <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟶</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟶</span></span> subst <span class="free"><span class="free">ρ</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> subst <span class="free"><span class="free">ρ</span></span> <span class="bound"><span class="bound">s</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">t</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span>
      <span class="operator">simplified</span> prod.case<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all prod.case atomize_imp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span>
    ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ta</span> <span class="bound">sa</span><span class="main">.</span> <span class="main">{#</span>size <span class="bound">ta</span><span class="main">,</span> size <span class="bound">sa</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span>size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span> <span class="main">⟹</span> wary <span class="bound">ta</span> <span class="main">⟹</span> wary <span class="bound">sa</span> <span class="main">⟹</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span> <span class="main">⟹</span>
      subst <span class="free">ρ</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="bound">sa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    wary_t<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wary_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">ρ</span> <span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t_gt_s
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> gt_wt_t_s<span class="main">:</span> gt_wt

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gt_tpoly_def wary_s wary_t wt_subst<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ wary_ρ<span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gt_wt_t_s<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> gt_tpoly_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> legal_subst_zpassign<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ wary_ρ<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_wt<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> wt_t_ge_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="skolem">t</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="skolem">s</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> wt_ρt_ge_ρs<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ge_tpoly_def wary_s wary_t wt_subst<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ wary_ρ<span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wt_t_ge_s<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ge_tpoly_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> legal_subst_zpassign<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ wary_ρ<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt_unary

      <span class="keyword1"><span class="command">have</span></span> wary_ρt<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wary_subst_wary wary_t wary_ρ<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Hd
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> gt_unary<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> t<span class="main">:</span> <span class="main">(</span>App <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">=</span> arg <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> wary_t2<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="skolem">t2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> wary_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">ρ</span> <span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="skolem">t2</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> gt_sub_arg wary_ρt <span class="keyword1"><span class="command">unfolding</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> t2_ne_s<span class="main">:</span> False
          <span class="keyword1"><span class="command">hence</span></span> t2_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> gt_unary<span class="main">(</span>5<span class="main">)</span> t2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">ρ</span> <span class="skolem">t2</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ wary_t2 wary_s t2_gt_s<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gt_sub_arg gt_trans subst.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> t wary_ρ wary_ρt wary_s wary_subst_wary
              wary_t2<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">case</span></span> _<span class="main">:</span> gt_diff
      <span class="keyword1"><span class="command">note</span></span> hd_t_gt_hd_s <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> hd_t_gt_hd_s wary_subst_ground_heads gt_hd_def rev_subsetD wary_ρ<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_ρt_ge_ρs<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">case</span></span> _<span class="main">:</span> gt_same
      <span class="keyword1"><span class="command">note</span></span> hd_s_eq_hd_t <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> extf <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> hd_ρt<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_s_eq_hd_t<span class="main">)</span>

      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
        <span class="keyword3"><span class="command">assume</span></span> f_in_grs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>

        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>

        <span class="keyword1"><span class="command">have</span></span> extf_args_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> extf f_in_grs wary_subst_ground_heads wary_ρ <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>map <span class="main">(</span>subst <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>subst <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> extf_map<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?S</span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _ _ _ _ _ extf_args_s_t<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">¬</span> subst <span class="free">ρ</span> <span class="bound">x</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="bound">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> gt_irrefl wary_t wary_s wary_args wary_ρ wary_subst_wary <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> subst <span class="free">ρ</span> <span class="bound">z</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="bound">y</span> <span class="main">⟶</span> subst <span class="free">ρ</span> <span class="bound">y</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="bound">x</span> <span class="main">⟶</span>
            subst <span class="free">ρ</span> <span class="bound">z</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="bound">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> gt_trans wary_t wary_s wary_args wary_ρ wary_subst_wary <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">have</span></span> sz_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ta</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">sa</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">{#</span>size <span class="bound">ta</span><span class="main">,</span> size <span class="bound">sa</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span>size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Max_lt_imp_lt_mset <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> size_in_args<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="bound">y</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">x</span> <span class="main">⟶</span> subst <span class="free">ρ</span> <span class="bound">y</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="bound">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ih sz_a size_in_args wary_t wary_s wary_args wary_ρ wary_subst_wary <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hd_s_eq_hd_t <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> extf_compat_append_left<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
        <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_ρt_ge_ρs hd_ρt<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Totality on Ground Terms›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wt_total_ground<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    gr_t<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    gr_s<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wt <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="free">s</span> <span class="main">∨</span> wt <span class="free">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="free">t</span> <span class="main">∨</span> wt <span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gt_tpoly_def eq_tpoly_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> ground_eval_ztpoly_wt_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gr_t<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">undefined</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> ground_eval_ztpoly_wt_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gr_s<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">undefined</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">theorem</span></span> gt_total_ground<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> extf_total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> ext_total <span class="main">(</span><span class="free">extf</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ground <span class="free">t</span> <span class="main">⟹</span> ground <span class="free">s</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">∨</span> <span class="free">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">∨</span> <span class="free">t</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> atomize_imp<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">{#</span></span> size <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> size <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">#}</span></span>"</span></span></span>
      <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> ground <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">⟶</span></span> ground <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟶</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">∨</span></span> <span class="bound"><span class="bound">s</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">∨</span></span> <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">=</span></span> <span class="bound"><span class="bound">s</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">t</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> prod.case<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all prod.case atomize_imp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ta</span> <span class="bound">sa</span><span class="main">.</span> <span class="main">{#</span> size <span class="bound">ta</span><span class="main">,</span> size <span class="bound">sa</span> <span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span> size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span> <span class="main">#}</span> <span class="main">⟹</span> ground <span class="bound">ta</span> <span class="main">⟹</span> ground <span class="bound">sa</span> <span class="main">⟹</span>
      <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span> <span class="main">∨</span> <span class="bound">sa</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">ta</span> <span class="main">∨</span> <span class="bound">ta</span> <span class="main">=</span> <span class="bound">sa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    gr_t<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gr_s<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="skolem">s</span>"</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span> <span class="main">∨</span> <span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span> <span class="main">∨</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wt <span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_wt<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wt <span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_wt<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wt <span class="skolem">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> wt_t_ge_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="skolem">t</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wt_s_ge_t<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="skolem">s</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_tpoly_def ge_tpoly_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> ξ<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">t</span> <span class="main">=</span> Sym <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ground_head<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gr_t<span class="main"><span class="main">]</span></span> hd.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> ζ<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">s</span> <span class="main">=</span> Sym <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ground_head<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gr_s<span class="main"><span class="main">]</span></span> hd.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> g_gt_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_t_ge_s<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ξ ζ g_gt_f gt_hd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> f_gt_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_s_ge_t<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ξ ζ f_gt_g gt_hd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> g_eq_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> hd_t<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">t</span> <span class="main">=</span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ξ ζ <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">note</span></span> hd_s <span class="main">=</span> hd_t<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"args <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"args <span class="skolem">s</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> gr_ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set <span class="var">?ts</span><span class="main">.</span> ground <span class="bound">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gr_t ground_args <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> gr_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="var">?ss</span><span class="main">.</span> ground <span class="bound">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gr_s ground_args <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?ts</span> <span class="main">=</span> <span class="var">?ss</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> ts_eq_ss<span class="main">:</span> True
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> ξ ζ g_eq_f ts_eq_ss <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tm_expand_apps<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">g</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="var">?ts</span> <span class="var">?ss</span> <span class="main">∨</span> <span class="free">extf</span> <span class="skolem">g</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="var">?ss</span> <span class="var">?ts</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ih gr_ss gr_ts less_multiset_doubletons
            ext_total.total<span class="main">[</span><span class="operator">OF</span> extf_total<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="var">?ts</span> <span class="main">∪</span> set <span class="var">?ss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="quoted"><span class="skolem">g</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_commute Un_iff in_lists_iff_set size_in_args sup_ge2<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> extf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">g</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="var">?ts</span> <span class="var">?ss</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_t_ge_s hd_t<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extf ξ<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> extf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">g</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="var">?ss</span> <span class="var">?ts</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wt_s_ge_t hd_s<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> g_eq_f<span class="main"><span class="main">]</span></span> ζ<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> gt_sym_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> wt_total_ground<span class="main">[</span><span class="operator">OF</span> gr_t gr_s<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Well-foundedness›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">gtw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub>)</span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> wary <span class="bound">t</span> <span class="main">∧</span> wary <span class="bound">s</span> <span class="main">∧</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">gtwg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub>)</span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ground_gt_unary<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> gr_t<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> gt_unary <span class="free">t</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> gt_unary_t_s<span class="main">:</span> <span class="quoted"><span class="quoted">"gt_unary <span class="free">t</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gt_iff_wt_unary_diff_same <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> gr_s<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gr_t gt_imp_vars <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> ngr_t_or_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ground <span class="free">t</span> <span class="main">∨</span> <span class="main">¬</span> ground <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gt_unary_t_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ground_head not_comp_hd_imp_Var<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> gr_t gr_s ngr_t_or_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub></span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ground_wfP<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub></span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wfP_iff_no_inf_chain
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> inf_chain <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="bound">f</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_bad<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def bad_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ff</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"worst_chain <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> size <span class="bound">t</span> <span class="main">&gt;</span> size <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted">min_passign</span>

    <span class="keyword1"><span class="command">note</span></span> wf_sz <span class="main">=</span> wf_app<span class="main">[</span><span class="operator">OF</span> wellorder_class.wf<span class="main">,</span> <span class="operator">of</span> <span class="quoted">size</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

    <span class="keyword1"><span class="command">have</span></span> ffi_ground<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> ground <span class="main">(</span><span class="var">?ff</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ffi_wary<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> wary <span class="main">(</span><span class="var">?ff</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> worst_chain_bad<span class="main">[</span><span class="operator">OF</span> wf_sz t_bad<span class="main">,</span> <span class="operator">unfolded</span> inf_chain_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inf_chain <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="var">?ff</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> worst_chain_bad<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_sz t_bad<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> bad_wt_diff_same<span class="main">:</span>
      <span class="quoted"><span class="quoted">"inf_chain <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span>gt_wt <span class="bound">t</span> <span class="bound">s</span> <span class="main">∨</span> gt_diff <span class="bound">t</span> <span class="bound">s</span> <span class="main">∨</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="var">?ff</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def <span class="keyword1"><span class="command">using</span></span> gt_iff_wt_unary_diff_same ground_gt_unary <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> wf_wt<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_wt <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_app<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"eval_tpoly <span class="var"><span class="var"><span class="var">?A</span></span></span> <span class="main"><span class="main"><span class="main">∘</span></span></span> wt"</span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> wf_less_hmultiset<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gt_wt.simps gt_tpoly_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fold</span> zhmset_of_less<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> legal_min_zpassign gt_wt.simps gt_tpoly_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> wt_O_diff_same<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_wt <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>
        <span class="keyword1">O</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> wt <span class="bound">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="bound">s</span> <span class="main">∧</span>  <span class="main">(</span>gt_diff <span class="bound">t</span> <span class="bound">s</span> <span class="main">∨</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span>
      <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_wt <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gt_wt.simps gt_diff.simps gt_same.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ge_gt_tpoly_trans<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> wt_diff_same_as_union<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span>gt_wt <span class="bound">t</span> <span class="bound">s</span> <span class="main">∨</span> gt_diff <span class="bound">t</span> <span class="bound">s</span> <span class="main">∨</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
       <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_wt <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>
       <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> wt <span class="bound">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="bound">s</span> <span class="main">∧</span> <span class="main">(</span>gt_diff <span class="bound">t</span> <span class="bound">s</span> <span class="main">∨</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gt_ge_tpoly_trans gt_tpoly_irrefl wt_ge_vars wt_total_ground
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gt_wt.simps gt_diff.simps gt_same.simps<span class="main">)</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k1</span></span> <span class="keyword2"><span class="keyword">where</span></span> bad_diff_same<span class="main">:</span>
      <span class="quoted"><span class="quoted">"inf_chain <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> wt <span class="bound">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="bound">s</span> <span class="main">∧</span> <span class="main">(</span>gt_diff <span class="bound">t</span> <span class="bound">s</span> <span class="main">∨</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf_infinite_down_chain_compatible<span class="main">[</span><span class="operator">OF</span> wf_wt _ wt_O_diff_same<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?ff</span></span></span><span class="main">]</span> bad_wt_diff_same
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def wt_diff_same_as_union<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">s</span> <span class="main">∧</span> ground <span class="bound">t</span> <span class="main">∧</span> wt <span class="bound">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="bound">s</span> <span class="main">∧</span> sym <span class="main">(</span>head <span class="bound">t</span><span class="main">)</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> sym <span class="main">(</span>head <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gt_sym_wf <span class="keyword1"><span class="command">unfolding</span></span> wfP_def wf_iff_no_infinite_down_chain <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> wt <span class="bound">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="bound">s</span> <span class="main">∧</span> gt_diff <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>
      <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">s</span> <span class="main">∧</span> ground <span class="bound">t</span> <span class="main">∧</span> wt <span class="bound">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="bound">s</span> <span class="main">∧</span> sym <span class="main">(</span>head <span class="bound">t</span><span class="main">)</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> sym <span class="main">(</span>head <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span>
      <span class="keyword3"><span class="command">assume</span></span> gr_t<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gt_diff_t_s<span class="main">:</span> <span class="quoted"><span class="quoted">"gt_diff <span class="skolem">t</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> gr_s<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_iff_wt_unary_diff_same gt_imp_vars <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> sym <span class="main">(</span>head <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_diff_t_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gt_hd_def gr_s gr_t ground_hd_in_ground_heads<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> wf_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> wt <span class="bound">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="bound">s</span> <span class="main">∧</span> gt_diff <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_subset<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> diff_O_same<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> wt <span class="bound">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="bound">s</span> <span class="main">∧</span> gt_diff <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>
         <span class="keyword1">O</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> wt <span class="bound">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="bound">s</span> <span class="main">∧</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>
       <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> wt <span class="bound">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="bound">s</span> <span class="main">∧</span> gt_diff <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gt_diff.simps gt_same.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ge_ge_tpoly_trans <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_tpoly_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> diff_same_as_union<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> wt <span class="bound">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="bound">s</span> <span class="main">∧</span> <span class="main">(</span>gt_diff <span class="bound">t</span> <span class="bound">s</span> <span class="main">∨</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
       <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> wt <span class="bound">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="bound">s</span> <span class="main">∧</span> gt_diff <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>
       <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> wt <span class="bound">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="bound">s</span> <span class="main">∧</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k2</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      bad_same<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_chain <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> wt <span class="bound">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>p</sub></span> wt <span class="bound">s</span> <span class="main">∧</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf_infinite_down_chain_compatible<span class="main">[</span><span class="operator">OF</span> wf_diff _ diff_O_same<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k1</span><span class="main">)</span>"</span></span><span class="main">]</span>
        bad_diff_same
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def diff_same_as_union<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> hd_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> is_Sym <span class="main">(</span>head <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ground_head<span class="main">)</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> sym <span class="main">(</span>head <span class="main">(</span><span class="var">?ff</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> eval_tpoly <span class="var">?A</span> <span class="main">(</span>wt <span class="main">(</span><span class="var">?ff</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Sym <span class="skolem">f</span> <span class="main">∧</span> eval_tpoly <span class="var">?A</span> <span class="main">(</span>wt <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def w_def hd.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> hd_sym<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">ia</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> bad_same <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def gt_same.simps zhmset_of_inject<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_tpoly_def legal_min_zpassign<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">note</span></span> hd_eq_f <span class="main">=</span> this<span class="main">[</span><span class="operator">THEN</span> conjunct1<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> wt_eq_w <span class="main">=</span> this<span class="main">[</span><span class="operator">THEN</span> conjunct2<span class="main">]</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">max_args</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">max_args</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> sum_coefs <span class="skolem">w</span> <span class="keyword1">else</span> the_enat <span class="main">(</span><span class="free">arity_sym</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> nargs_le_max_args<span class="main">:</span> <span class="quoted"><span class="quoted">"num_args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">max_args</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"δ<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> δ_ne_0<span class="main">:</span> False
      <span class="keyword1"><span class="command">hence</span></span> ary_f_ne_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">arity_sym</span> <span class="skolem">f</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> arity_sym_ne_infinity_if_δ_gt_0 of_nat_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>num_args <span class="main">(</span>worst_chain <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub></span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> size <span class="bound">s</span> <span class="main">&lt;</span> size <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">arity_sym</span> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wary_num_args_le_arity_head<span class="main">[</span><span class="operator">OF</span> ffi_wary<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_eq_f<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> δ_ne_0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enat_ord_simps <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_args_def  enat_ord_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> enat_the_enat_iden<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ary_f_ne_inf<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> δ_eq_0<span class="main">:</span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> sum_coefs_ge_num_args_if_δ<span class="hidden">⇩</span><sub>h</sub>_eq_0<span class="main">[</span><span class="operator">OF</span> legal_min_passign δ_eq_0 ffi_wary<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_args_def δ_eq_0 wt_eq_w<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U_of</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> set <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?U_of</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> gr_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">⟹</span> ground <span class="bound">u</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> U_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ground_args<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ ffi_ground<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> wary_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">⟹</span> wary <span class="bound">u</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> U_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wary_args<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ ffi_wary<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bad <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> u_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="var">?U_of</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> u_bad<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> sz_u<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="skolem">u</span> <span class="main">&lt;</span> size <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> size_in_args<span class="main"><span class="main">[</span></span><span class="operator">OF</span> u_in<span class="main"><span class="main">]</span></span><span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k2</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> sz_u min_worst_chain_0<span class="main">[</span><span class="operator">OF</span> wf_sz u_bad<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> Suc
        <span class="keyword1"><span class="command">hence</span></span> gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ff</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub></span> <span class="var">?ff</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> worst_chain_pred<span class="main">[</span><span class="operator">OF</span> wf_sz t_bad<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ff</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub></span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> gt gt_proper_sub sub_args sz_u u_in wary_args <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ff</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub></span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> gt_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> Suc sz_u min_worst_chain_Suc<span class="main">[</span><span class="operator">OF</span> wf_sz u_bad<span class="main">]</span> ffi_ground <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> u_good<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">⟹</span> <span class="main">¬</span> bad <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="bound">u</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> U_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gtwu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">∧</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub></span> <span class="bound">s</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> gtwu_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="var">?gtwu</span> <span class="bound">x</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gt_irrefl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">s</span> <span class="main">⟶</span>
      <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">∧</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub></span> <span class="bound">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wary_u <span class="keyword1"><span class="command">unfolding</span></span> U_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span>Suc <span class="bound">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bad_same hd_eq_f <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def gt_same.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">extf</span> <span class="skolem">f</span> <span class="var">?gtwu</span> <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span>Suc <span class="bound">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> extf_mono_strong<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"inf_chain <span class="main">(</span><span class="free">extf</span> <span class="skolem">f</span> <span class="var">?gtwu</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> nwf_ext<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">¬</span> wfP <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">≤</span> <span class="skolem">max_args</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">≤</span> <span class="skolem">max_args</span> <span class="main">∧</span> <span class="free">extf</span> <span class="skolem">f</span> <span class="var">?gtwu</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def wfP_def wf_iff_no_infinite_down_chain <span class="keyword1"><span class="command">using</span></span> nargs_le_max_args <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

    <span class="keyword1"><span class="command">have</span></span> gtwu_le_gtwg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?gtwu</span> <span class="main">≤</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub>)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gr_u<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="var">?gtwu</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> wfP_iff_no_inf_chain
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> exE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
      <span class="keyword3"><span class="command">assume</span></span> bad_f<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_chain <span class="var">?gtwu</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> bad_f0<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="var">?gtwu</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inf_chain_bad<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">0</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bad_f <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bad <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> u_good <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bad <span class="var">?gtwu</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bad_f inf_chain_bad inf_chain_subset<span class="main">[</span><span class="operator">OF</span> _ gtwu_le_gtwg<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> bad_f0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> wf_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">≤</span> <span class="skolem">max_args</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">≤</span> <span class="skolem">max_args</span> <span class="main">∧</span> <span class="free">extf</span> <span class="skolem">f</span> <span class="var">?gtwu</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> extf_wf_bounded<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?gtwu</span></span></span><span class="main">]</span> gtwu_irrefl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> nwf_ext wf_ext <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?subst</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"subst grounding_ρ"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="var">?subst</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>g</sub></span> <span class="var">?subst</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wfP_app<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ground_wfP<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="var">?subst</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>w</sub></span> <span class="var">?subst</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ground_grounding_ρ<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wfP_subset wary_subst_wary<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_grounding_ρ<span class="main"><span class="main">]</span></span> gt_subst<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_grounding_ρ<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lambda_Encoding_KBO">
<div class="head">
<h1>Theory Lambda_Encoding_KBO</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Properties of Lambda-Free KBO on the Lambda Encoding
    Author:      Jasmin Blanchette &lt;j.c.blanchette at vu.nl&gt;, 2019
    Maintainer:  Jasmin Blanchette &lt;j.c.blanchette at vu.nl&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Properties of Lambda-Free KBO on the Lambda Encoding›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lambda_Encoding_KBO
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../Lambda_Free_RPOs/Lambda_Encoding.html">Lambda_Free_RPOs.Lambda_Encoding</a> <a href="Lambda_Free_KBO_Basic.html">Lambda_Free_KBO_Basic</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory explores the properties of the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>λ›</span></span></span></span>-free KBO on the proposed encoding of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>λ›</span></span></span></span>-expressions.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> kbo_lambda_encoding <span class="main">=</span> kbo_basic _ _ _ _ <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main">::</span> <span class="tfree">'v</span><span class="main">.</span> UNIV <span class="main">::</span> <span class="tfree">'s</span> set"</span></span> <span class="main">+</span> lambda_encoding <span class="quoted"><span class="free">lam</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">lam</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    gt_db_db<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&gt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">db</span> <span class="free">j</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free">db</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    wt_db_db<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wt_sym</span> <span class="main">(</span><span class="free">db</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">wt_sym</span> <span class="main">(</span><span class="free">db</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">notation</span></span> gt <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span> 50<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> gt_hd <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span>"</span> 50<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">≥<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wary_raw_db_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"wary_subst <span class="main">(</span>raw_db_subst <span class="free">i</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wary_subst_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> arity_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wt_subst_db<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>subst_db <span class="free">i</span> <span class="free">x</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> wt <span class="main">(</span>subst <span class="main">(</span>raw_db_subst <span class="free">j</span> <span class="free">x</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> raw_db_subst_def wt_db_db <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> hd.splits<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">metis</span> lambda_encoding.subst_db.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subst.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> wt.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_db_Suc_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_db <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="free">s</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> subst_db <span class="free">i</span> <span class="free">x</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hd <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gt_diff <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wt_db_db gt_db_db gt_sym_imp_hd<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
      <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> App.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> App.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> gt_compat_arg gt_compat_fun gt_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_subst_db<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> subst_db <span class="free">i</span> <span class="free">x</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst_db <span class="free">i</span> <span class="free">x</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> atomize_imp<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">{#</span></span>size <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> size <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">#}</span></span>"</span></span></span>
        <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟶</span></span> subst_db <span class="bound"><span class="bound">i</span></span> <span class="free"><span class="free">x</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> subst_db <span class="bound"><span class="bound">i</span></span> <span class="free"><span class="free">x</span></span> <span class="bound"><span class="bound">s</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">t</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">i</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span>
      <span class="operator">simplified</span> prod.case<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all prod.case atomize_imp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> atomize_all<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword3"><span class="command">assume</span></span>
    ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ta</span> <span class="bound">sa</span> <span class="bound">i</span><span class="main">.</span> <span class="main">{#</span>size <span class="bound">ta</span><span class="main">,</span> size <span class="bound">sa</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span>size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span> <span class="main">⟹</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span> <span class="main">⟹</span>
      subst_db <span class="bound">i</span> <span class="free">x</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst_db <span class="bound">i</span> <span class="free">x</span> <span class="bound">sa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    t_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ρ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"subst_db <span class="skolem">i</span> <span class="free">x</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ρ</span> <span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="var">?ρ</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span><span class="var">?ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> wt <span class="main">(</span><span class="var">?ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> wt_ρt_ne_ρs<span class="main">:</span> False

    <span class="keyword1"><span class="command">have</span></span> vars_s<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="skolem">t</span> <span class="main">⊇#</span> vars_mset <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gt.cases t_gt_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> vars_ρs<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="main">(</span><span class="var">?ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">⊇#</span> vars_mset <span class="main">(</span><span class="var">?ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> var_mset_subst_db_subseteq<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> wt_t_ge_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="skolem">t</span> <span class="main">≥</span> wt <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.strict_implies_order eq_imp_le gt.cases t_gt_s<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span><span class="var">?ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">&gt;</span> wt <span class="main">(</span><span class="var">?ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wt_ρt_ne_ρs <span class="keyword1"><span class="command">unfolding</span></span> wt_subst_db
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> gt.simps gt_subst t_gt_s wary_raw_db_subst wt_subst_db<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_wt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_ρs<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> wt_ρt_eq_ρs<span class="main">:</span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> t_gt_s
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> gt_wt
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> wt_ρt_eq_ρs
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_less_le_mono kbo_std.extra_wt_subseteq nat_less_le wary_raw_db_subst wt_subst
            wt_subst_db<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> _<span class="main">:</span> gt_diff
      <span class="keyword1"><span class="command">note</span></span> vars_s <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> hd_t_gt_hd_s <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> vars_ρs<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="main">(</span><span class="var">?ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">⊇#</span> vars_mset <span class="main">(</span><span class="var">?ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> var_mset_subst_db_subseteq vars_s<span class="main">)</span>
      <span class="keyword1"><span class="command">term</span></span> <span class="quoted">gt_hd</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="main">(</span><span class="var">?ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="main">(</span><span class="var">?ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Set.set_insert gt_hd_def hd_t_gt_hd_s head_subst_db insert_subset wary_raw_db_subst
            wary_subst_ground_heads<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_ρs wt_ρt_eq_ρs<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> _<span class="main">:</span> gt_same
      <span class="keyword1"><span class="command">note</span></span> vars_s <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> hd_s_eq_hd_t <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> extf <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> vars_ρs<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="main">(</span><span class="var">?ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">⊇#</span> vars_mset <span class="main">(</span><span class="var">?ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> var_mset_subst_db_subseteq vars_s<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> hd_ρt<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="main">(</span><span class="var">?ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> head <span class="main">(</span><span class="var">?ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_s_eq_hd_t head_subst_db<span class="main">)</span>

      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
        <span class="keyword3"><span class="command">assume</span></span> f_in_grs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="main">(</span><span class="var">?ρ</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>

        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ρa</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"subst_db <span class="main">(</span><span class="keyword1">if</span> head <span class="skolem">s</span> <span class="main">=</span> Sym <span class="free">lam</span> <span class="keyword1">then</span> <span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>

        <span class="keyword1"><span class="command">have</span></span> extf_args_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> extf f_in_grs hd_s_eq_hd_t head_subst_db wary_raw_db_subst wary_subst_ground_heads
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> insert_subset mk_disjoint_insert<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>map <span class="var">?ρa</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="var">?ρa</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> extf_map<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?S</span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _ _ _ _ _ extf_args_s_t<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">¬</span> <span class="var">?ρa</span> <span class="bound">x</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="var">?ρa</span> <span class="bound">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> gt_irrefl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="var">?ρa</span> <span class="bound">z</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="var">?ρa</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="var">?ρa</span> <span class="bound">y</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="var">?ρa</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="var">?ρa</span> <span class="bound">z</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="var">?ρa</span> <span class="bound">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> gt_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">have</span></span> sz_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ta</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">sa</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">{#</span>size <span class="bound">ta</span><span class="main">,</span> size <span class="bound">sa</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span>size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Max_lt_imp_lt_mset <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> size_in_args<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="bound">y</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">x</span> <span class="main">⟶</span> <span class="var">?ρa</span> <span class="bound">y</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="var">?ρa</span> <span class="bound">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ih sz_a <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="main">(</span><span class="var">?ρ</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span><span class="var">?ρ</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> args_subst_db hd_s_eq_hd_t<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="main">(</span><span class="var">?ρ</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="main">(</span><span class="var">?ρ</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span><span class="var">?ρ</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_ρs wt_ρt_eq_ρs hd_ρt<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lambda_Free_KBOs">
<div class="head">
<h1>Theory Lambda_Free_KBOs</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Knuth-Bendix Orders for Lambda-Free Higher-Order Terms
    Author:      Heiko Becker &lt;heikobecker92@gmail.com&gt;, 2016
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2016
    Author:      Uwe Waldmann &lt;waldmann at mpi-inf.mpg.de&gt;, 2016
    Author:      Daniel Wand &lt;dwand at mpi-inf.mpg.de&gt;, 2016
    Maintainer:  Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Knuth--Bendix Orders for Lambda-Free Higher-Order Terms›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lambda_Free_KBOs
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Lambda_Free_KBO_App.html">Lambda_Free_KBO_App</a> <a href="Lambda_Free_KBO_Basic.html">Lambda_Free_KBO_Basic</a> <a href="Lambda_Free_TKBO_Coefs.html">Lambda_Free_TKBO_Coefs</a> <a href="Lambda_Encoding_KBO.html">Lambda_Encoding_KBO</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> simple_kbo_instances
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">arity_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> enat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">arity_sym</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">∞</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">arity_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> enat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">arity_var</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">∞</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ground_head_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ground_head_var</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> UNIV"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gt_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gt_sym</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ε</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">δ</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wt_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wt_sym</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wt_sym<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> hmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wt_sym<span class="hidden">⇩</span><sub>h</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">coef_sym<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> hmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">coef_sym<span class="hidden">⇩</span><sub>h</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> kbo_app<span class="main">:</span> kbo_app <span class="quoted">gt_sym</span> <span class="quoted">wt_sym</span> <span class="quoted">ε</span> <span class="quoted">len_lexext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gt_sym_def ε_def wt_sym_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_less<span class="main"><span class="main">[</span></span><span class="operator">folded</span> wfP_def<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> kbo_basic<span class="main">:</span> kbo_basic <span class="quoted">gt_sym</span> <span class="quoted">wt_sym</span> <span class="quoted">ε</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> len_lexext"</span></span> <span class="quoted">ground_head_var</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ground_head_var_def gt_sym_def ε_def wt_sym_def<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> kbo_std<span class="main">:</span> kbo_std <span class="quoted">ground_head_var</span> <span class="quoted">gt_sym</span> <span class="quoted">ε</span> <span class="quoted">δ</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> len_lexext"</span></span> <span class="quoted">arity_sym</span> <span class="quoted">arity_var</span> <span class="quoted">wt_sym</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arity_sym_def arity_var_def ground_head_var_def ε_def δ_def wt_sym_def<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> tkbo_coefs<span class="main">:</span> tkbo_coefs <span class="quoted">ground_head_var</span> <span class="quoted">gt_sym</span> <span class="quoted">ε</span> <span class="quoted">δ</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> len_lexext"</span></span> <span class="quoted">arity_sym</span> <span class="quoted">arity_var</span>
    <span class="quoted">wt_sym<span class="hidden">⇩</span><sub>h</sub></span> <span class="quoted">coef_sym<span class="hidden">⇩</span><sub>h</sub></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ε_def δ_def wt_sym<span class="hidden">⇩</span><sub>h</sub>_def coef_sym<span class="hidden">⇩</span><sub>h</sub>_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>