<div id="ICAInstance">
<div class="head">
<h1>Theory ICAInstance</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Instances of Schneider's generalized protocol of clock synchronization
    Author:      Damián Barsotti &lt;damian at hal.famaf.unc.edu.ar&gt;, 2006
    Maintainer:  Damián Barsotti &lt;damian at hal.famaf.unc.edu.ar&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Interactive Convergence Algorithms (ICA)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> ICAInstance <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This algorithm is presented in \cite{lamport_cs}.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A proof of the three properties can be found in
\cite{shankar92mechanical}.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model of the system›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The main ideas for the formalization of the system were
obtained from \cite{shankar92mechanical}.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Types in the formalization›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The election of the basics types was based on
\cite{shankar92mechanical}. There, the process are natural numbers and
the real time and the clock readings are reals.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> process <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> time <span class="main">=</span> <span class="quoted">real</span>       <span class="comment1">― ‹real time›</span>
<span class="keyword1"><span class="command">type_synonym</span></span> Clocktime <span class="main">=</span> <span class="quoted">real</span>  <span class="comment1">― ‹time of the clock readings (clock time)›</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Some constants›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Here we define some parameters of the algorithm that we use:
the number of process and the fix value that is used to discard the
processes whose clocks differ more than this amount from the own one
(see \cite{shankar92mechanical}). The defined constants must satisfy
this axiom (if $np = 0$ we have a division by cero in the definition
of the convergence function).›</span></span>

<span class="keyword1"><span class="command">axiomatization</span></span>
  <span class="free">np</span> <span class="main">::</span> <span class="quoted">nat</span>      <span class="comment1">― ‹Number of processes›</span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">Δ</span> <span class="main">::</span> <span class="quoted">Clocktime</span> <span class="comment1">― ‹Fix value to discard processes›</span> <span class="keyword2"><span class="keyword">where</span></span>
  constants_ax<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;=</span> <span class="free">Δ</span> <span class="main">∧</span> <span class="free">np</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define also the set of process that the algorithm
manage. This definition exist only for readability matters.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
<span class="entity">PR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"process set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">PR</span> <span class="main">=</span> <span class="main">{..&lt;</span>np<span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Convergence function›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This functions is called ``Egocentric Average''
(\cite{schneider87understanding})›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this algorithm each process has an array where it store the
clocks readings from the others processes (including itself). We
formalise that as a function from processes to clock time as
\cite{shankar92mechanical}.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First we define an auxiliary function. It takes a function of
clock readings and two processes, and return de reading of the second
process if the difference of the readings is grater than <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Δ</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
otherwise it returns the reading of the first one.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">fiX</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span>process <span class="main">⇒</span> Clocktime<span class="main">)</span><span class="main">,</span> process<span class="main">,</span> process<span class="main">]</span> <span class="main">⇒</span> Clocktime"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fiX</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">¦</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">¦</span> <span class="main">&lt;=</span> Δ <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹And finally the convergence function. This is defined with the
builtin generalized summation over a set constructor of Isabelle.
Also we had to use the overloaded <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">real</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> function to typecast de
number <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">np</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="comment1">(* The averaging function to calculate clock adjustment *)</span>
  <span class="entity">cfni</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>process<span class="main">,</span> <span class="main">(</span>process <span class="main">⇒</span> Clocktime<span class="main">)</span><span class="main">]</span> <span class="main">⇒</span> Clocktime"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cfni</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">l</span><span class="main">∈</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">.</span> fiX <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">l</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>real np<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Translation Invariance property.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We first need to prove this auxiliary lemma.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trans_inv'<span class="main">:</span> 
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">l</span><span class="main">∈</span><span class="main">{..&lt;</span><span class="free">np'</span><span class="main">}</span><span class="main">.</span> fiX <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="free">p</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="main">∑</span> <span class="bound">l</span><span class="main">∈</span><span class="main">{..&lt;</span><span class="free">np'</span><span class="main">}</span><span class="main">.</span> fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">l</span><span class="main">)</span> <span class="main">+</span> real <span class="free">np'</span> <span class="main">*</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">np'</span></span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfni_def  fiX_def of_nat_Suc 
       distrib_right lessThan_Suc<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> trans_inv<span class="main">:</span> 
<span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">.</span> cfni <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">y</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> cfni <span class="bound">p</span> <span class="bound">f</span> <span class="main">+</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfni_def trans_inv' distrib_right 
       divide_inverse  constants_ax<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Precision Enhancement property›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An informal proof of this theorem can be found in
\cite{shankar92mechanical}›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finitC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> PR <span class="main">⟹</span> finite <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> PR"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finitnpC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>PR <span class="main">-</span> <span class="free">C</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">using</span></span> finite_Diff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next lemmas are about arithmetic properties of the
generalized summation over a set constructor.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_abs_triangle_ineq<span class="main">:</span>
<span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span>
  <span class="main">¦</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>linordered_idom<span class="main">)</span> <span class="bound">l</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">l</span><span class="main">¦</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟹</span> <span class="var">?P</span> <span class="free">S</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_abs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>finite <span class="free">S</span> <span class="main">;</span> <span class="main">∀</span> <span class="bound">r</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">r</span> <span class="main">&lt;=</span> <span class="free">b</span> <span class="main">⟧</span>
  <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">l</span><span class="main">)</span> <span class="main">&lt;=</span> real <span class="main">(</span>card <span class="free">S</span><span class="main">)</span> <span class="main">*</span> <span class="free">b</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free">S</span> <span class="main">;</span> <span class="main">∀</span> <span class="bound">r</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">r</span> <span class="main">&lt;=</span> <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="var">?P</span> <span class="free">S</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">F</span> <span class="skolem">x</span> 
  <span class="keyword3"><span class="command">assume</span></span>  finit<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xnotinF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          HI1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">∈</span><span class="skolem">F</span><span class="main">.</span> <span class="free">f</span> <span class="bound">r</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> sum <span class="free">f</span> <span class="skolem">F</span> <span class="main">≤</span> real <span class="main">(</span>card <span class="skolem">F</span><span class="main">)</span> <span class="main">*</span> <span class="free">b</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> HI2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">∈</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">.</span> <span class="free">f</span> <span class="bound">r</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> HI1 HI2 <span class="keyword2"><span class="keyword">and</span></span> finit <span class="keyword2"><span class="keyword">and</span></span> xnotinF
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">&lt;=</span> <span class="free">b</span> <span class="main">+</span> real <span class="main">(</span>card <span class="skolem">F</span><span class="main">)</span> <span class="main">*</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> real <span class="main">(</span>Suc <span class="main">(</span>card  <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_right  of_nat_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">from</span></span>   finit xnotinF <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span><span class="main">=</span> real <span class="main">(</span>card <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_np_eq<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> 
  hC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> PR"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="free">f</span> <span class="bound">l</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">(</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">-</span><span class="free">C</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> finitC<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">C</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> finitnpC<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">C</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∩</span> <span class="main">(</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">-</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> hC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">-</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="main">{..&lt;</span>np<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sum.union_disjoint<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">C</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span>np<span class="main">}</span> <span class="main">-</span> <span class="free">C</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1"><span class="command">lemma</span></span> abs_sum_np_ineq<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> 
  hC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> PR"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">::</span>nat <span class="main">⇒</span> real<span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">¦</span> <span class="main">&lt;=</span>  
     <span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">l</span><span class="main">¦</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">(</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">-</span><span class="free">C</span><span class="main">)</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">l</span><span class="main">¦</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?abs_sum</span> <span class="main">&lt;=</span> <span class="var">?sumC</span> <span class="main">+</span> <span class="var">?sumnpC</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> hC <span class="keyword2"><span class="keyword">and</span></span> sum_np_eq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">f</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?abs_sum</span> <span class="main">=</span> <span class="main">¦</span><span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="free">f</span> <span class="bound">l</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">(</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">-</span><span class="free">C</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">¦</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?abs_sum</span> <span class="main">=</span> <span class="main">¦</span><span class="var">?sumC'</span> <span class="main">+</span> <span class="var">?sumnpC'</span><span class="main">¦</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">from</span></span> abs_triangle_ineq
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span><span class="main">&lt;=</span> <span class="main">¦</span><span class="var">?sumC'</span><span class="main">¦</span> <span class="main">+</span> <span class="main">¦</span><span class="var">?sumnpC'</span><span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span>  <span class="var">?sumC</span> <span class="main">+</span> <span class="var">?sumnpC</span> "</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> hC finitC sum_abs_triangle_ineq 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="var">?sumC'</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="var">?sumC</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> finitnpC <span class="keyword2"><span class="keyword">and</span></span>
           sum_abs_triangle_ineq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">f</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"PR<span class="main">-</span><span class="free">C</span>"</span></span><span class="main">]</span>  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="var">?sumnpC'</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="var">?sumnpC</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next lemmas are about the existence of bounds that are
necesary in order to prove the Precicion Enhancement theorem.›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> fiX_ubound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fiX <span class="free">f</span> <span class="free">p</span> <span class="free">l</span> <span class="main">&lt;=</span> <span class="free">f</span> <span class="free">p</span> <span class="main">+</span> Δ"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">l</span><span class="main">¦</span> <span class="main">≤</span> Δ"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">l</span><span class="main">¦</span> <span class="main">≤</span> Δ"</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fiX <span class="free">f</span> <span class="free">p</span> <span class="free">l</span> <span class="main">=</span> <span class="free">f</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fiX_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">from</span></span> asm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">l</span> <span class="main">&lt;=</span> <span class="free">f</span> <span class="free">p</span> <span class="main">+</span> Δ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¦</span><span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">l</span><span class="main">¦</span> <span class="main">≤</span> Δ"</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fiX <span class="free">f</span> <span class="free">p</span> <span class="free">l</span> <span class="main">=</span> <span class="free">f</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fiX_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">from</span></span> asm <span class="keyword2"><span class="keyword">and</span></span>  constants_ax <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">p</span> <span class="main">&lt;=</span> <span class="free">f</span> <span class="free">p</span> <span class="main">+</span> Δ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fiX_lbound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">p</span> <span class="main">-</span> Δ <span class="main">&lt;=</span> fiX <span class="free">f</span> <span class="free">p</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">l</span><span class="main">¦</span> <span class="main">≤</span> Δ"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">l</span><span class="main">¦</span> <span class="main">≤</span> Δ"</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fiX <span class="free">f</span> <span class="free">p</span> <span class="free">l</span> <span class="main">=</span> <span class="free">f</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fiX_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">from</span></span> asm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">p</span> <span class="main">-</span> Δ <span class="main">&lt;=</span> <span class="free">f</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¦</span><span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">l</span><span class="main">¦</span> <span class="main">≤</span> Δ"</span></span> 
  <span class="keyword1"><span class="command">with</span></span>  constants_ax <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">p</span> <span class="main">-</span> Δ <span class="main">&lt;=</span> <span class="free">f</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">from</span></span> asm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">p</span> <span class="main">=</span> fiX <span class="free">f</span> <span class="free">p</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fiX_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> abs_fiX_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="free">l</span> <span class="main">-</span> <span class="free">f</span> <span class="free">p</span> <span class="main">¦</span> <span class="main">&lt;=</span> Δ"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="comment1">(*
from constants_ax and fiX_lbound and fiX_ubound show ?thesis by arith
*)</span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">p</span> <span class="main">-</span> Δ <span class="main">&lt;=</span> fiX <span class="free">f</span> <span class="free">p</span> <span class="free">l</span> <span class="main">∧</span> fiX <span class="free">f</span> <span class="free">p</span> <span class="free">l</span> <span class="main">&lt;=</span> <span class="free">f</span> <span class="free">p</span> <span class="main">+</span> Δ <span class="main">⟶</span> <span class="var">?thesis</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
<span class="keyword1"><span class="command">with</span></span> fiX_lbound  fiX_ubound <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> abs_dif_fiX_bound<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span>
  hbx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">l</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hby<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">m</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">m</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hpC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hqC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">∈</span><span class="free">C</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="free">r</span> <span class="main">-</span> fiX <span class="free">g</span> <span class="free">q</span> <span class="free">r</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="numeral">2</span> <span class="main">*</span> Δ <span class="main">+</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="free">r</span> <span class="main">-</span> fiX <span class="free">g</span> <span class="free">q</span> <span class="free">r</span><span class="main">¦</span> <span class="main">=</span> 
    <span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="free">r</span> <span class="main">-</span> <span class="free">f</span> <span class="free">p</span> <span class="main">+</span> <span class="free">f</span> <span class="free">p</span> <span class="main">-</span> fiX <span class="free">g</span> <span class="free">q</span> <span class="free">r</span><span class="main">¦</span> "</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> <span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="free">r</span> <span class="main">-</span> <span class="free">f</span> <span class="free">p</span> <span class="main">¦</span> <span class="main">+</span> <span class="main">¦</span><span class="free">f</span> <span class="free">p</span> <span class="main">-</span> fiX <span class="free">g</span> <span class="free">q</span> <span class="free">r</span><span class="main">¦</span> "</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">from</span></span> abs_fiX_bound 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> Δ <span class="main">+</span> <span class="main">¦</span><span class="free">f</span> <span class="free">p</span> <span class="main">-</span> fiX <span class="free">g</span> <span class="free">q</span> <span class="free">r</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Δ <span class="main">+</span> <span class="main">¦</span><span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">g</span> <span class="free">q</span> <span class="main">+</span> <span class="main">(</span><span class="free">g</span> <span class="free">q</span> <span class="main">-</span> fiX <span class="free">g</span> <span class="free">q</span> <span class="free">r</span><span class="main">)</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">from</span></span> abs_triangle_ineq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">g</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> 
                               b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">q</span> <span class="main">-</span> fiX <span class="free">g</span> <span class="free">q</span> <span class="free">r</span>"</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> Δ <span class="main">+</span> <span class="main">¦</span><span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">g</span> <span class="free">q</span> <span class="main">¦</span> <span class="main">+</span> <span class="main">¦</span> <span class="free">g</span> <span class="free">q</span> <span class="main">-</span> fiX <span class="free">g</span> <span class="free">q</span> <span class="free">r</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Δ <span class="main">+</span> <span class="main">¦</span><span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">g</span> <span class="free">q</span> <span class="main">¦</span> <span class="main">+</span> <span class="main">¦</span> fiX <span class="free">g</span> <span class="free">q</span> <span class="free">r</span> <span class="main">-</span> <span class="free">g</span> <span class="free">q</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">from</span></span> abs_fiX_bound
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> <span class="numeral">2</span> <span class="main">*</span> Δ <span class="main">+</span> <span class="main">¦</span><span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">g</span> <span class="free">q</span> <span class="main">¦</span> "</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> Δ <span class="main">+</span> <span class="main">¦</span><span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">+</span> <span class="main">(</span><span class="free">f</span> <span class="free">q</span> <span class="main">-</span> <span class="free">g</span> <span class="free">q</span><span class="main">)</span> <span class="main">¦</span> "</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">from</span></span> abs_triangle_ineq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> 
                               b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">q</span> <span class="main">-</span> <span class="free">g</span> <span class="free">q</span>"</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> <span class="numeral">2</span> <span class="main">*</span> Δ <span class="main">+</span> <span class="main">¦</span><span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">¦</span> <span class="main">+</span> <span class="main">¦</span> <span class="free">f</span> <span class="free">q</span> <span class="main">-</span> <span class="free">g</span> <span class="free">q</span> <span class="main">¦</span> "</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hbx hby hpC hqC
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>
        

<span class="keyword1"><span class="command">lemma</span></span> abs_dif_fiX_bound_C_aux1<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> 
  hbx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">l</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hby1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">m</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">m</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hby2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">m</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span><span class="free">g</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">m</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hpC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hqC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hrC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">∈</span><span class="free">C</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="free">r</span> <span class="main">-</span> fiX <span class="free">g</span> <span class="free">q</span> <span class="free">r</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">r</span><span class="main">¦</span> <span class="main">≤</span> Δ"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True 
  <span class="keyword1"><span class="command">note</span></span> outer_IH <span class="main">=</span> True 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">g</span> <span class="free">q</span> <span class="main">-</span> <span class="free">g</span> <span class="free">r</span><span class="main">¦</span> <span class="main">≤</span> Δ"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> hpC <span class="keyword2"><span class="keyword">and</span></span> hby1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">&lt;=</span><span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">with</span></span> hrC <span class="keyword2"><span class="keyword">and</span></span> hbx <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span> <span class="free">f</span> <span class="free">r</span> <span class="main">-</span> <span class="free">g</span> <span class="free">r</span> <span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> outer_IH <span class="keyword2"><span class="keyword">and</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fiX_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> outer_IH <span class="keyword2"><span class="keyword">and</span></span> False 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="free">r</span> <span class="main">-</span> fiX <span class="free">g</span> <span class="free">q</span> <span class="free">r</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="free">f</span> <span class="free">r</span> <span class="main">-</span> <span class="free">g</span> <span class="free">q</span><span class="main">¦</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fiX_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">¦</span> <span class="free">f</span> <span class="free">r</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">+</span> <span class="free">f</span> <span class="free">q</span> <span class="main">-</span> <span class="free">g</span> <span class="free">q</span> <span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> <span class="main">¦</span> <span class="free">f</span> <span class="free">r</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">¦</span> <span class="main">+</span> <span class="main">¦</span> <span class="free">f</span> <span class="free">q</span> <span class="main">-</span> <span class="free">g</span> <span class="free">q</span> <span class="main">¦</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword1"><span class="command">from</span></span> hbx hby1 hpC hqC hrC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">finally</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False 
  <span class="keyword1"><span class="command">note</span></span> outer_IH <span class="main">=</span> False
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">g</span> <span class="free">q</span> <span class="main">-</span> <span class="free">g</span> <span class="free">r</span><span class="main">¦</span> <span class="main">≤</span> Δ"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> outer_IH <span class="keyword2"><span class="keyword">and</span></span> True 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="free">r</span> <span class="main">-</span> fiX <span class="free">g</span> <span class="free">q</span> <span class="free">r</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">g</span> <span class="free">r</span><span class="main">¦</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fiX_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">¦</span> <span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">r</span> <span class="main">+</span> <span class="free">f</span> <span class="free">r</span> <span class="main">-</span> <span class="free">g</span> <span class="free">r</span> <span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword1"><span class="command">from</span></span> abs_triangle_ineq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> 
                                   b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">r</span> <span class="main">-</span> <span class="free">g</span> <span class="free">r</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> <span class="main">¦</span> <span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">r</span> <span class="main">¦</span> <span class="main">+</span> <span class="main">¦</span> <span class="free">f</span> <span class="free">r</span> <span class="main">-</span> <span class="free">g</span> <span class="free">r</span> <span class="main">¦</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword1"><span class="command">from</span></span> hbx hby1 hpC hrC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">finally</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> outer_IH <span class="keyword2"><span class="keyword">and</span></span> False 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="free">r</span> <span class="main">-</span> fiX <span class="free">g</span> <span class="free">q</span> <span class="free">r</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">g</span> <span class="free">q</span><span class="main">¦</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fiX_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">¦</span> <span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">+</span> <span class="free">f</span> <span class="free">q</span> <span class="main">-</span> <span class="free">g</span> <span class="free">q</span> <span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword1"><span class="command">from</span></span> abs_triangle_ineq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> 
                                   b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">q</span> <span class="main">-</span> <span class="free">g</span> <span class="free">q</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> <span class="main">¦</span> <span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">¦</span> <span class="main">+</span> <span class="main">¦</span> <span class="free">f</span> <span class="free">q</span> <span class="main">-</span> <span class="free">g</span> <span class="free">q</span> <span class="main">¦</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword1"><span class="command">from</span></span> hbx hby1 hpC hqC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">finally</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> abs_dif_fiX_bound_C_aux2<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> 
  hbx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">l</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hby1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">m</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">m</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hby2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">m</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span><span class="free">g</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">m</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hpC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hqC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hrC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">∈</span><span class="free">C</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;=</span> Δ <span class="main">⟶</span> <span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="free">r</span> <span class="main">-</span> fiX <span class="free">g</span> <span class="free">q</span> <span class="free">r</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> hyd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">&lt;=</span>Δ"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="free">r</span> <span class="main">-</span> fiX <span class="free">g</span> <span class="free">q</span> <span class="free">r</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> hpC <span class="keyword2"><span class="keyword">and</span></span> hrC <span class="keyword2"><span class="keyword">and</span></span> hby1 <span class="keyword2"><span class="keyword">and</span></span> hyd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">r</span><span class="main">¦</span> <span class="main">≤</span> Δ"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> hqC <span class="keyword2"><span class="keyword">and</span></span> hrC <span class="keyword2"><span class="keyword">and</span></span> hby2 <span class="keyword2"><span class="keyword">and</span></span> hyd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">g</span> <span class="free">q</span> <span class="main">-</span> <span class="free">g</span> <span class="free">r</span><span class="main">¦</span> <span class="main">≤</span> Δ"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> hrC <span class="keyword2"><span class="keyword">and</span></span> hbx <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span> <span class="free">f</span> <span class="free">r</span> <span class="main">-</span> <span class="free">g</span> <span class="free">r</span> <span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">x</span> "</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fiX_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> abs_dif_fiX_bound_C<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> 
  hbx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">l</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hby1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">m</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">m</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hby2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">m</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span><span class="free">g</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">m</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hpC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hqC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hrC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">∈</span><span class="free">C</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="free">r</span> <span class="main">-</span> fiX <span class="free">g</span> <span class="free">q</span> <span class="free">r</span><span class="main">¦</span> <span class="main">&lt;=</span> 
                     <span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free">y</span> <span class="main">&lt;=</span> Δ<span class="main">)</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;=</span> Δ"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True 
  <span class="keyword1"><span class="command">with</span></span> abs_dif_fiX_bound_C_aux2 <span class="keyword2"><span class="keyword">and</span></span>
    hbx <span class="keyword2"><span class="keyword">and</span></span> hby1 <span class="keyword2"><span class="keyword">and</span></span> hby2 <span class="keyword2"><span class="keyword">and</span></span> hpC <span class="keyword2"><span class="keyword">and</span></span> hqC <span class="keyword2"><span class="keyword">and</span></span> hrC 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="free">r</span> <span class="main">-</span> fiX <span class="free">g</span> <span class="free">q</span> <span class="free">r</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">x</span> "</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> abs_dif_fiX_bound_C_aux1 <span class="keyword2"><span class="keyword">and</span></span>
    hbx <span class="keyword2"><span class="keyword">and</span></span> hby1 <span class="keyword2"><span class="keyword">and</span></span> hby2 <span class="keyword2"><span class="keyword">and</span></span> hpC <span class="keyword2"><span class="keyword">and</span></span> hqC <span class="keyword2"><span class="keyword">and</span></span> hrC 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="free">r</span> <span class="main">-</span> fiX <span class="free">g</span> <span class="free">q</span> <span class="free">r</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Main theorem›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> prec_enh<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> 
  hC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> PR"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hbx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">l</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hby1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">m</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">m</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hby2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">m</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span><span class="free">g</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">m</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hpC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hqC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">∈</span><span class="free">C</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span> cfni <span class="free">p</span> <span class="free">f</span> <span class="main">-</span> cfni <span class="free">q</span> <span class="free">g</span> <span class="main">¦</span> <span class="main">&lt;=</span> 
  <span class="main">(</span>real <span class="main">(</span>card <span class="free">C</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free">y</span> <span class="main">&lt;=</span> Δ<span class="main">)</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
    real <span class="main">(</span>card <span class="main">(</span><span class="main">{..&lt;</span>np<span class="main">}</span> <span class="main">-</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> Δ <span class="main">+</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real np"</span></span>
       <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span> <span class="var">?dif_div_np</span> <span class="main">¦</span> <span class="main">&lt;=</span> <span class="var">?B</span>"</span></span><span class="main">)</span>  
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">.</span> fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">l</span> <span class="main">)</span> <span class="main">-</span> 
                    <span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">.</span> fiX <span class="free">g</span> <span class="free">q</span> <span class="bound">l</span><span class="main">)</span><span class="main">¦</span> <span class="main">=</span> 
    <span class="main">¦</span><span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">.</span> fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">l</span> <span class="main">-</span>fiX <span class="free">g</span> <span class="free">q</span> <span class="bound">l</span><span class="main">)</span><span class="main">¦</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="var">?dif</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="var">?dif'</span><span class="main">¦</span>"</span></span> <span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_subtractf<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">from</span></span> abs_sum_np_ineq hC
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">...</span> <span class="main">&lt;=</span>
      <span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">l</span> <span class="main">-</span> fiX <span class="free">g</span> <span class="free">q</span> <span class="bound">l</span><span class="main">¦</span><span class="main">)</span> <span class="main">+</span> 
      <span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">(</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">-</span><span class="free">C</span><span class="main">)</span><span class="main">.</span> <span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">l</span> <span class="main">-</span> fiX <span class="free">g</span> <span class="free">q</span> <span class="bound">l</span><span class="main">¦</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">" <span class="main">¦</span><span class="var">?dif'</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="var">?boundC'</span> <span class="main">+</span> <span class="var">?boundnpC'</span>"</span></span> <span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> 
    real <span class="main">(</span>card <span class="free">C</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free">y</span> <span class="main">&lt;=</span> Δ<span class="main">)</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">+</span>
    real <span class="main">(</span>card <span class="main">(</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">-</span><span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> Δ <span class="main">+</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">" <span class="main">...</span> <span class="main">&lt;=</span> <span class="var">?boundC</span> <span class="main">+</span> <span class="var">?boundnpC</span>"</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="var">?boundC'</span> <span class="main">&lt;=</span> <span class="var">?boundC</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> abs_dif_fiX_bound_C <span class="keyword2"><span class="keyword">and</span></span> 
        hbx <span class="keyword2"><span class="keyword">and</span></span> hby1 <span class="keyword2"><span class="keyword">and</span></span> hby2 <span class="keyword2"><span class="keyword">and</span></span>  hpC <span class="keyword2"><span class="keyword">and</span></span> hqC  
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> 
        <span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">r</span> <span class="main">-</span> fiX <span class="free">g</span> <span class="free">q</span> <span class="bound">r</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">x</span> <span class="main">+</span> 
                         <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free">y</span> <span class="main">&lt;=</span> Δ<span class="main">)</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="free">y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>     
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sum_le<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">C</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> finitC<span class="main">[</span><span class="operator">OF</span> hC<span class="main">]</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?boundnpC'</span> <span class="main">&lt;=</span> <span class="var">?boundnpC</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> abs_dif_fiX_bound <span class="keyword2"><span class="keyword">and</span></span> 
        hbx <span class="keyword2"><span class="keyword">and</span></span> hby1 <span class="keyword2"><span class="keyword">and</span></span>  hpC <span class="keyword2"><span class="keyword">and</span></span> hqC  
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">∈</span><span class="main">(</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">-</span><span class="free">C</span><span class="main">)</span><span class="main">.</span> <span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">r</span> <span class="main">-</span> fiX <span class="free">g</span> <span class="free">q</span> <span class="bound">r</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="numeral">2</span> <span class="main">*</span> Δ <span class="main">+</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> finitnpC
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum_le<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> 
  <span class="keyword1"><span class="command">have</span></span> bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="var">?dif</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="var">?boundC</span> <span class="main">+</span> <span class="var">?boundnpC</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?dif_div_np</span> <span class="main">=</span> <span class="var">?dif</span> <span class="main">/</span> real np"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfni_def divide_inverse <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span> cfni <span class="free">p</span> <span class="free">f</span> <span class="main">-</span> cfni <span class="free">q</span> <span class="free">g</span> <span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="var">?dif</span><span class="main">¦</span> <span class="main">/</span> real np"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> bound <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfni_def divide_inverse constants_ax<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Accuracy Preservation property›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First, a simple lemma about an arithmetic propertie of the
generalized summation over a set constructor.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_div_card<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">{..&lt;</span><span class="free">n</span><span class="main">::</span>nat<span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">l</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">*</span> real <span class="free">n</span><span class="main">=</span> 
  <span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">l</span> <span class="main">+</span> <span class="free">q</span> <span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Sl</span> <span class="free">n</span> <span class="main">=</span> <span class="var">?Sr</span> <span class="free">n</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> of_nat_Suc distrib_left lessThan_Suc<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next, some lemmas about bounds that are used in the proof of Accuracy Preservation›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bound_aux_C<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span>
  hby<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">m</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">m</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hpC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hqC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hrC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">∈</span><span class="free">C</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="free">r</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span> <span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">r</span> <span class="main">¦</span> <span class="main">&lt;=</span> Δ"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="free">r</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span> <span class="free">f</span> <span class="free">r</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">¦</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fiX_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">from</span></span> hby hqC hrC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="free">r</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span> <span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">¦</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fiX_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">from</span></span> hby hpC hqC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bound_aux<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span>
  hby<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">m</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">m</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hpC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hqC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">∈</span><span class="free">C</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="free">r</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">x</span> <span class="main">+</span> Δ"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span> <span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">r</span> <span class="main">¦</span> <span class="main">&lt;=</span> Δ"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="free">r</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span> <span class="free">f</span> <span class="free">r</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">¦</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fiX_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">¦</span> <span class="main">(</span><span class="free">f</span> <span class="free">r</span> <span class="main">-</span> <span class="free">f</span> <span class="free">p</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span><span class="main">)</span> <span class="main">¦</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> <span class="main">¦</span> <span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">r</span> <span class="main">¦</span> <span class="main">+</span> <span class="main">¦</span> <span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">¦</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> Δ <span class="main">+</span> <span class="main">¦</span> <span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">from</span></span> hby hpC hqC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> Δ <span class="main">+</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="free">r</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span> <span class="free">f</span> <span class="free">p</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">¦</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fiX_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">from</span></span> hby hpC hqC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> constants_ax <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Main theorem›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> accur_pres<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> 
  hC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> PR"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hby<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">m</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">m</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hpC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hqC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">∈</span><span class="free">C</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span> cfni <span class="free">p</span> <span class="free">f</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">¦</span> <span class="main">&lt;=</span> 
  <span class="main">(</span>real <span class="main">(</span>card <span class="free">C</span><span class="main">)</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> real <span class="main">(</span>card <span class="main">(</span><span class="main">{..&lt;</span>np<span class="main">}</span> <span class="main">-</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> Δ<span class="main">)</span><span class="main">)</span><span class="main">/</span>
                  real np"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?abs1</span> <span class="main">&lt;=</span> <span class="main">(</span><span class="var">?bC</span> <span class="main">+</span> <span class="var">?bnpC</span><span class="main">)</span><span class="main">/</span>real np"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> abs_sum_np_ineq <span class="keyword2"><span class="keyword">and</span></span> hC <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">.</span> fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">l</span>  <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">¦</span> <span class="main">&lt;=</span> 
    <span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span> fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">l</span>  <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">¦</span><span class="main">)</span> <span class="main">+</span> 
            <span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">(</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">-</span><span class="free">C</span><span class="main">)</span><span class="main">.</span> <span class="main">¦</span> fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">l</span>  <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">¦</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">also</span></span> 
<span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> real <span class="main">(</span>card <span class="free">C</span><span class="main">)</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> 
            real <span class="main">(</span>card <span class="main">(</span><span class="main">{..&lt;</span>np<span class="main">}</span> <span class="main">-</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> Δ<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span> fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">l</span>  <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">¦</span><span class="main">)</span> <span class="main">&lt;=</span> 
                    real <span class="main">(</span>card <span class="free">C</span><span class="main">)</span> <span class="main">*</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> bound_aux_C <span class="keyword2"><span class="keyword">and</span></span> 
        hby <span class="keyword2"><span class="keyword">and</span></span>  hpC <span class="keyword2"><span class="keyword">and</span></span> hqC  
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> 
        <span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">r</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>     
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sum_le<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">C</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> finitC<span class="main">[</span><span class="operator">OF</span> hC<span class="main">]</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">(</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">-</span><span class="free">C</span><span class="main">)</span><span class="main">.</span> <span class="main">¦</span> fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">l</span>  <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">¦</span><span class="main">)</span> <span class="main">&lt;=</span> 
                real <span class="main">(</span>card <span class="main">(</span><span class="main">{..&lt;</span>np<span class="main">}</span> <span class="main">-</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> Δ<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> bound_aux <span class="keyword2"><span class="keyword">and</span></span> 
        hby <span class="keyword2"><span class="keyword">and</span></span>  hpC <span class="keyword2"><span class="keyword">and</span></span> hqC  
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">∈</span><span class="main">(</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">-</span><span class="free">C</span><span class="main">)</span><span class="main">.</span> 
        <span class="main">¦</span>fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">r</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">x</span> <span class="main">+</span> Δ"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sum_le<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">-</span><span class="free">C</span>"</span></span><span class="main">]</span> 
        <span class="keyword2"><span class="keyword">and</span></span> finitnpC 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> 
  <span class="keyword1"><span class="command">have</span></span> bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">.</span> fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span><span class="main">¦</span>
  <span class="main">≤</span> real <span class="main">(</span>card <span class="free">C</span><span class="main">)</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> real <span class="main">(</span>card <span class="main">(</span><span class="main">{..&lt;</span>np<span class="main">}</span> <span class="main">-</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> Δ<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> 
    <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> constants_ax <span class="keyword1"><span class="command">have</span></span>
      res<span class="main">:</span> <span class="quoted"><span class="quoted">"inverse <span class="main">(</span>real np<span class="main">)</span> <span class="main">*</span> real np <span class="main">=</span> <span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>cfni <span class="free">p</span> <span class="free">f</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span><span class="main">)</span> <span class="main">*</span> real np <span class="main">=</span> 
      <span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">.</span> fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">l</span><span class="main">)</span> <span class="main">*</span> real np <span class="main">/</span> real np <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">*</span> real np"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfni_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> 
      <span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">.</span> fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">l</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">*</span> real np"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">from</span></span> sum_div_card<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fiX <span class="free">f</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted">np</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> q<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">f</span> <span class="free">q</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">.</span> fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">(</span>cfni <span class="free">p</span> <span class="free">f</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span><span class="main">)</span> <span class="main">*</span> real np <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">.</span> fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">.</span></span>
<span class="comment1">― ‹cambia›</span>
    <span class="keyword1"><span class="command">hence</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>cfni <span class="free">p</span> <span class="free">f</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span><span class="main">)</span> <span class="main">*</span> real np <span class="main">/</span> real np <span class="main">=</span> 
      <span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">.</span> fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span><span class="main">)</span><span class="main">/</span> real np"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> constants_ax <span class="keyword1"><span class="command">have</span></span>  
      <span class="quoted"><span class="quoted">"<span class="main">(</span>cfni <span class="free">p</span> <span class="free">f</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">.</span> fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span><span class="main">)</span> <span class="main">/</span> real np"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span> cfni <span class="free">p</span> <span class="free">f</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">¦</span> <span class="main">=</span> 
      <span class="main">¦</span><span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">.</span> fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span><span class="main">)</span> <span class="main">/</span> real np <span class="main">¦</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">¦</span><span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">.</span> fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span><span class="main">)</span><span class="main">¦</span> <span class="main">/</span> real np "</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span> cfni <span class="free">p</span> <span class="free">f</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">¦</span> <span class="main">=</span> 
      <span class="main">¦</span><span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">∈</span><span class="main">{..&lt;</span>np<span class="main">}</span><span class="main">.</span> fiX <span class="free">f</span> <span class="free">p</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span><span class="main">)</span><span class="main">¦</span> <span class="main">/</span> real np "</span></span>
      <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">with</span></span> bound <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfni_def divide_inverse constants_ax<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LynchInstance">
<div class="head">
<h1>Theory LynchInstance</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Instances of Schneider's generalized protocol of clock synchronization
    Author:      Damián Barsotti &lt;damian at hal.famaf.unc.edu.ar&gt;, 2006
    Maintainer:  Damián Barsotti &lt;damian at hal.famaf.unc.edu.ar&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Fault-tolerant Midpoint algorithm›</span></span>

<span class="keyword1"><span class="command">theory</span></span> LynchInstance <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This algorithm is presented in \cite{lynch_cs}.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model of the system›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The main ideas for the formalization of the system were
obtained from \cite{shankar92mechanical}.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Types in the formalization›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The election of the basics types was based on
\cite{shankar92mechanical}. There, the process are natural numbers and
the real time and the clock readings are reals.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> process <span class="main">=</span> <span class="quoted">nat</span>  
<span class="keyword1"><span class="command">type_synonym</span></span> time <span class="main">=</span> <span class="quoted">real</span>      <span class="comment1">― ‹real time›</span>
<span class="keyword1"><span class="command">type_synonym</span></span> Clocktime <span class="main">=</span> <span class="quoted">real</span> <span class="comment1">― ‹time of the clock readings (clock time)›</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Some constants›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Here we define some parameters of the algorithm that we use:
the number of process and the number of lowest and highest readed
values that the algorithm discards. The defined constants must satisfy
this axiom. If not, the algorithm cannot obtain the maximum and
minimum value, because it will have discarded all the values.›</span></span>

<span class="keyword1"><span class="command">axiomatization</span></span>
  <span class="free">np</span>  <span class="main">::</span> <span class="quoted">nat</span>  <span class="comment1">― ‹Number of processes›</span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">khl</span> <span class="main">::</span> <span class="quoted">nat</span>  <span class="comment1">― ‹Number of lowest and highest values›</span> <span class="keyword2"><span class="keyword">where</span></span>
  constants_ax<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">khl</span> <span class="main">&lt;</span> <span class="free">np</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define also the set of process that the algorithm
manage. This definition exist only for readability matters.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
<span class="entity">PR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"process set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">PR</span> <span class="main">=</span> <span class="main">{..&lt;</span>np<span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Convergence function›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This functions is called ``Fault-tolerant Midpoint''
(\cite{schneider87understanding})›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this algorithm each process has an array where it store the
clocks readings from the others processes (including itself). We
formalise that as a function from processes to clock time as
\cite{shankar92mechanical}.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First we define two functions. They take a function of clock
readings and a set of processes and they return a set of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">khl</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
processes which has the greater (smaller) clock readings. They were
defined with the Hilbert's $\varepsilon$-operator (the indefinite
description operator <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SOME›</span></span></span></span> in Isabelle) because in this way the
formalization is not fixed to a particular eleccion of the processes's
readings to discards and then the modelization is more general.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
<span class="entity">kmax</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process <span class="main">⇒</span> Clocktime<span class="main">)</span> <span class="main">⇒</span> process set <span class="main">⇒</span> process set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">kmax</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">S</span><span class="main">.</span> <span class="bound">S</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> card <span class="bound">S</span> <span class="main">=</span> khl <span class="main">∧</span> 
                <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">∈</span><span class="bound">S</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">j</span><span class="main">∈</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">-</span><span class="bound">S</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">j</span> <span class="main">&lt;=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
<span class="entity">kmin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process <span class="main">⇒</span> Clocktime<span class="main">)</span> <span class="main">⇒</span> process set <span class="main">⇒</span> process set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">kmin</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">S</span><span class="main">.</span> <span class="bound">S</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> card <span class="bound">S</span> <span class="main">=</span> khl <span class="main">∧</span> 
                <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">∈</span><span class="bound">S</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">j</span><span class="main">∈</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">-</span><span class="bound">S</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">i</span> <span class="main">&lt;=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹With the previus functions we define a new one <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="free"><span class="quoted"><span class="free">reduce</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\footnote{The name of this function was taken from
\cite{lynch_cs}.}. This take a function of clock readings and a set of
processes and return de set of readings of the not dicarded
processes. In order to define this function we use the image operator
(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(`)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) of Isabelle.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
<span class="entity">reduce</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process <span class="main">⇒</span> Clocktime<span class="main">)</span> <span class="main">⇒</span> process set <span class="main">⇒</span> Clocktime set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">reduce</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">`</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">-</span> <span class="main">(</span>kmax <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∪</span> kmin <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹And finally the convergence function. This is defined with the
builtin <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Max</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Min</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> functions of Isabelle.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
<span class="entity">cfnl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"process  <span class="main">⇒</span> <span class="main">(</span>process <span class="main">⇒</span> Clocktime<span class="main">)</span> <span class="main">⇒</span> Clocktime"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cfnl</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span>Max <span class="main">(</span>reduce <span class="free"><span class="bound"><span class="entity">f</span></span></span> PR<span class="main">)</span> <span class="main">+</span> Min <span class="main">(</span>reduce <span class="free"><span class="bound"><span class="entity">f</span></span></span> PR<span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Translation Invariance property.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary lemmas›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹These lemmas proves the existence of the maximum and minimum
of the image of a set, if the set is finite and not empty.›</span></span>

<span class="comment1">(* The proofs are almost the same one that those of the lemmas @{thm *)</span>
<span class="comment1">(* [source] ex_Max} and @{thm [source] ex_Min} in the Isabelle's standard *)</span>
<span class="comment1">(* theories. *)</span>

<span class="keyword1"><span class="command">lemma</span></span> ex_Maxf<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">==&gt;</span> <span class="main">∃</span><span class="bound">m</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">m</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> fin
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">∈</span><span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">f</span> <span class="skolem">m</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="skolem">m</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="skolem">m</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> m
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>linorder_not_le order_less_le<span class="main">)</span>
          <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ex_Minf<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">==&gt;</span> <span class="main">∃</span><span class="bound">m</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">m</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">s</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> fin
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">∈</span><span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="free">f</span> <span class="skolem">m</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">s</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">m</span> <span class="main">≤</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">f</span> <span class="skolem">m</span> <span class="main">≤</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> m
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>linorder_not_le order_less_le<span class="main">)</span>
          <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This trivial lemma is needed by the next two.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> khl_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"khl <span class="main">&lt;</span> np"</span></span>
  <span class="keyword1"><span class="command">using</span></span> constants_ax <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next two lemmas prove that de functions kmin and kmax
return some values that satisfy their definition. This is not trivial
because we need to prove the existence of these values, according to
the rule of the Hilbert's operator. We will need this lemma many
times because is the only thing that we know about these functions.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> kmax_prop<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> Clocktime"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"<span class="main">(</span>kmax <span class="free">f</span> PR<span class="main">)</span> <span class="main">⊆</span> PR <span class="main">∧</span> card <span class="main">(</span>kmax <span class="free">f</span> PR<span class="main">)</span> <span class="main">=</span> khl <span class="main">∧</span> 
                <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">(</span>kmax <span class="free">f</span> PR<span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">∈</span>PR <span class="main">-</span> <span class="main">(</span>kmax <span class="free">f</span> PR<span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"khl <span class="main">&lt;=</span> np <span class="main">⟶</span> 
    <span class="main">(</span><span class="main">∃</span> <span class="bound">S</span><span class="main">.</span> <span class="bound">S</span> <span class="main">⊆</span> PR <span class="main">∧</span> card <span class="bound">S</span> <span class="main">=</span> khl <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="bound">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">∈</span>PR <span class="main">-</span> <span class="bound">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"khl <span class="main">&lt;=</span> np <span class="main">⟶</span> <span class="var">?P</span> khl"</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="main"><span class="main">(</span></span><span class="quoted">khl</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;=</span> np <span class="main">⟶</span> <span class="var">?P</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> 
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;=</span> np <span class="main">⟶</span> <span class="var">?P</span> <span class="skolem">n</span>"</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">&lt;=</span> np <span class="main">⟶</span> <span class="var">?P</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> asm2<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">&lt;=</span> np"</span></span>
      <span class="keyword1"><span class="command">with</span></span> asm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        SinPR <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span><span class="main">⊆</span>PR"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
        cardS<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">S</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
        HI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">∈</span>PR <span class="main">-</span> <span class="skolem">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span>PR<span class="main">-</span><span class="skolem">S</span> <span class="main">∧</span> 
        <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">∈</span>PR<span class="main">-</span><span class="skolem">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"insert  <span class="var">?e</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span>PR<span class="main">-</span><span class="skolem">S</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">∈</span>PR<span class="main">-</span><span class="skolem">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> SinPR <span class="keyword2"><span class="keyword">and</span></span> finite_subset 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>PR<span class="main">-</span><span class="skolem">S</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> cardS <span class="keyword2"><span class="keyword">and</span></span> asm2 SinPR
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span><span class="main">⊂</span>PR"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"PR<span class="main">-</span><span class="skolem">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ex_Maxf <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> 
        ePRS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?e</span> <span class="main">∈</span> PR<span class="main">-</span><span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> maxH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">j</span> <span class="main">∈</span> PR<span class="main">-</span><span class="skolem">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">f</span> <span class="var">?e</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> someI_ex<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> maxH <span class="keyword2"><span class="keyword">and</span></span> HI
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">∈</span>PR <span class="main">-</span> <span class="var">?S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> SinPR <span class="keyword2"><span class="keyword">and</span></span> finite_subset 
      cardS <span class="keyword2"><span class="keyword">and</span></span> ePRS 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?S</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span>  
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> card_insert_disjoint<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⊆</span> PR"</span></span> <span class="keyword1"><span class="command">using</span></span> SinPR <span class="keyword2"><span class="keyword">and</span></span> ePRS <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> khl"</span></span> <span class="keyword1"><span class="command">using</span></span> khl_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">S</span><span class="main">≤</span>PR <span class="main">∧</span> card <span class="skolem">S</span> <span class="main">=</span> khl <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">∈</span>PR <span class="main">-</span> <span class="skolem">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> kmax_def<span class="main">)</span>
      <span class="main">(</span><span class="operator">rule</span> someI <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">S</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">S</span></span></span> <span class="main"><span class="main"><span class="main">⊆</span></span></span> PR <span class="main"><span class="main"><span class="main">∧</span></span></span> card <span class="bound"><span class="bound"><span class="bound">S</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> khl <span class="main"><span class="main"><span class="main">∧</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">∀</span></span></span><span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">∈</span></span></span><span class="bound"><span class="bound"><span class="bound">S</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">∀</span></span></span><span class="bound"><span class="bound"><span class="bound">j</span></span></span><span class="main"><span class="main"><span class="main">∈</span></span></span>PR <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="bound"><span class="bound"><span class="bound">S</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">f</span></span></span> <span class="bound"><span class="bound"><span class="bound">j</span></span></span> <span class="main"><span class="main"><span class="main">≤</span></span></span> <span class="free"><span class="free"><span class="free">f</span></span></span> <span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> kmin_prop<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> Clocktime"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"<span class="main">(</span>kmin <span class="free">f</span> PR<span class="main">)</span> <span class="main">⊆</span> PR <span class="main">∧</span> card <span class="main">(</span>kmin <span class="free">f</span> PR<span class="main">)</span> <span class="main">=</span> khl <span class="main">∧</span> 
                <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">(</span>kmin <span class="free">f</span> PR<span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">∈</span>PR <span class="main">-</span> <span class="main">(</span>kmin <span class="free">f</span> PR<span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"khl <span class="main">&lt;=</span> np <span class="main">⟶</span> 
    <span class="main">(</span><span class="main">∃</span> <span class="bound">S</span><span class="main">.</span> <span class="bound">S</span> <span class="main">⊆</span> PR <span class="main">∧</span> card <span class="bound">S</span> <span class="main">=</span> khl <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="bound">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">∈</span>PR <span class="main">-</span> <span class="bound">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"khl <span class="main">&lt;=</span> np <span class="main">⟶</span> <span class="var">?P</span> khl"</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="main"><span class="main">(</span></span><span class="quoted">khl</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;=</span> np <span class="main">⟶</span> <span class="var">?P</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> 
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;=</span> np <span class="main">⟶</span> <span class="var">?P</span> <span class="skolem">n</span>"</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">&lt;=</span> np <span class="main">⟶</span> <span class="var">?P</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> asm2<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">&lt;=</span> np"</span></span>
      <span class="keyword1"><span class="command">with</span></span> asm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        SinPR <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span><span class="main">⊆</span>PR"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
        cardS<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">S</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
        HI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">∈</span>PR <span class="main">-</span> <span class="skolem">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">j</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span>PR<span class="main">-</span><span class="skolem">S</span> <span class="main">∧</span> 
        <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">∈</span>PR<span class="main">-</span><span class="skolem">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"insert  <span class="var">?e</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span>PR<span class="main">-</span><span class="skolem">S</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">∈</span>PR<span class="main">-</span><span class="skolem">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> SinPR <span class="keyword2"><span class="keyword">and</span></span> finite_subset 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>PR<span class="main">-</span><span class="skolem">S</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> cardS <span class="keyword2"><span class="keyword">and</span></span> asm2 SinPR
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span><span class="main">⊂</span>PR"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"PR<span class="main">-</span><span class="skolem">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ex_Minf <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> 
        ePRS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?e</span> <span class="main">∈</span> PR<span class="main">-</span><span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> minH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">j</span> <span class="main">∈</span> PR<span class="main">-</span><span class="skolem">S</span><span class="main">.</span> <span class="free">f</span> <span class="var">?e</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> someI_ex<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> minH <span class="keyword2"><span class="keyword">and</span></span>  HI 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">∈</span>PR <span class="main">-</span> <span class="var">?S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> SinPR <span class="keyword2"><span class="keyword">and</span></span> finite_subset <span class="keyword2"><span class="keyword">and</span></span>
        cardS <span class="keyword2"><span class="keyword">and</span></span> ePRS
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?S</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> card_insert_disjoint<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⊆</span> PR"</span></span> <span class="keyword1"><span class="command">using</span></span> SinPR <span class="keyword2"><span class="keyword">and</span></span> ePRS <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> khl"</span></span> <span class="keyword1"><span class="command">using</span></span> khl_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">S</span><span class="main">≤</span>PR <span class="main">∧</span> card <span class="skolem">S</span> <span class="main">=</span> khl <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">∈</span>PR <span class="main">-</span> <span class="skolem">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> kmin_def<span class="main">)</span>
      <span class="main">(</span><span class="operator">rule</span> someI <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">S</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">S</span></span></span> <span class="main"><span class="main"><span class="main">⊆</span></span></span> PR <span class="main"><span class="main"><span class="main">∧</span></span></span> card <span class="bound"><span class="bound"><span class="bound">S</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> khl <span class="main"><span class="main"><span class="main">∧</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">∀</span></span></span><span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">∈</span></span></span><span class="bound"><span class="bound"><span class="bound">S</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">∀</span></span></span><span class="bound"><span class="bound"><span class="bound">j</span></span></span><span class="main"><span class="main"><span class="main">∈</span></span></span>PR <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="bound"><span class="bound"><span class="bound">S</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">f</span></span></span> <span class="bound"><span class="bound"><span class="bound">i</span></span></span> <span class="main"><span class="main"><span class="main">≤</span></span></span> <span class="free"><span class="free"><span class="free">f</span></span></span> <span class="bound"><span class="bound"><span class="bound">j</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next two lemmas are trivial from the previous ones›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_kmax<span class="main">:</span>
<span class="quoted"><span class="quoted">"finite <span class="main">(</span>kmax <span class="free">f</span> PR<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite PR"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span>  kmax_prop <span class="keyword2"><span class="keyword">and</span></span> finite_subset <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_kmin<span class="main">:</span>
<span class="quoted"><span class="quoted">"finite <span class="main">(</span>kmin <span class="free">f</span> PR<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite PR"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span>  kmin_prop <span class="keyword2"><span class="keyword">and</span></span> finite_subset <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This lemma is necesary because the definition of the
convergence function use the builtin Max and Min.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reduce_not_empty<span class="main">:</span>
<span class="quoted"><span class="quoted">"reduce <span class="free">f</span> PR <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> constants_ax <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span>np <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> khl<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> kmax_prop kmin_prop 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>kmax <span class="free">f</span> PR<span class="main">)</span> <span class="main">=</span> khl <span class="main">∧</span> card <span class="main">(</span>kmin <span class="free">f</span> PR<span class="main">)</span> <span class="main">=</span> khl"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>kmax <span class="free">f</span> PR <span class="main">∪</span> kmin <span class="free">f</span> PR<span class="main">)</span> <span class="main">&lt;=</span> <span class="numeral">2</span> <span class="main">*</span> khl"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_Un_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"kmax <span class="free">f</span> PR"</span></span> <span class="quoted"><span class="quoted">"kmin <span class="free">f</span> PR"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> card PR <span class="main">-</span> card <span class="main">(</span>kmax <span class="free">f</span> PR <span class="main">∪</span> kmin <span class="free">f</span> PR<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> kmax_prop <span class="keyword2"><span class="keyword">and</span></span> kmin_prop <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>kmax <span class="free">f</span> PR <span class="main">∪</span> kmin <span class="free">f</span> PR<span class="main">)</span> <span class="main">⊆</span> PR"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="main">(</span>PR<span class="main">-</span><span class="main">(</span>kmax <span class="free">f</span> PR <span class="main">∪</span> kmin <span class="free">f</span> PR<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> card_Diff_subset<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="comment1">(* by (intro card_Diff_subset,auto) *)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> card <span class="main">(</span>PR<span class="main">-</span><span class="main">(</span>kmax <span class="free">f</span> PR <span class="main">∪</span> kmin <span class="free">f</span> PR<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>PR<span class="main">-</span><span class="main">(</span>kmax <span class="free">f</span> PR <span class="main">∪</span> kmin <span class="free">f</span> PR<span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> card_0_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reduce_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next three are the main lemmas necessary for prove the
Translation Invariance property.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reduce_shift<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> Clocktime"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="main">(</span>PR <span class="main">-</span> <span class="main">(</span>kmax <span class="free">f</span> PR <span class="main">∪</span> kmin <span class="free">f</span> PR<span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
            <span class="free">f</span> <span class="main">`</span> <span class="main">(</span>PR <span class="main">-</span> <span class="main">(</span>kmax <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> PR <span class="main">∪</span> kmin <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> PR<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> kmin_def kmax_def<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> max_shift<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> Clocktime"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span>
<span class="keyword2"><span class="keyword">assumes</span></span> notEmpFin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span> <span class="main">=</span> Max <span class="main">(</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span> "</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>  
  <span class="keyword1"><span class="command">from</span></span> notEmpFin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> notEmpFin <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">)</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">S</span> "</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span><span class="main">`</span><span class="free">S</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> "</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">fs</span> <span class="main">∈</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">)</span><span class="main">.</span> <span class="bound">fs</span> <span class="main">≤</span> Max <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">fs</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span><span class="main">`</span><span class="free">S</span><span class="main">)</span><span class="main">.</span> <span class="bound">fs</span> <span class="main">≤</span> Max <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span><span class="main">`</span><span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> min_shift<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> Clocktime"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span>
<span class="keyword2"><span class="keyword">assumes</span></span> notEmpFin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"Min <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span> <span class="main">=</span> Min <span class="main">(</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span> "</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> notEmpFin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> notEmpFin <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"Min <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">)</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">S</span> "</span></span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span><span class="main">`</span><span class="free">S</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> "</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">fs</span> <span class="main">∈</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">)</span><span class="main">.</span> Min <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">)</span> <span class="main">&lt;=</span> <span class="bound">fs</span><span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">fs</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span><span class="main">`</span><span class="free">S</span><span class="main">)</span><span class="main">.</span> Min <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span><span class="main">`</span><span class="free">S</span><span class="main">)</span> <span class="main">&lt;=</span> <span class="bound">fs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Main theorem›</span></span>
  
<span class="keyword1"><span class="command">theorem</span></span> trans_inv<span class="main">:</span> 
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> Clocktime"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"cfnl <span class="free">p</span> <span class="free">f</span> <span class="main">+</span> <span class="free">x</span> <span class="main">=</span> cfnl <span class="free">p</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cfnl <span class="free">p</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span>Max <span class="main">(</span>reduce <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> PR<span class="main">)</span> <span class="main">+</span> Min <span class="main">(</span>reduce <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> PR<span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> cfnl_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> 
    <span class="main">(</span>Max <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">`</span> 
             <span class="main">(</span>PR <span class="main">-</span> <span class="main">(</span>kmax <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> PR <span class="main">∪</span> kmin <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> PR<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> 
     Min <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">`</span> 
             <span class="main">(</span>PR <span class="main">-</span> <span class="main">(</span>kmax <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> PR <span class="main">∪</span> kmin <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> PR<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> reduce_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> 
    <span class="main">(</span>Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> 
             <span class="main">(</span>PR <span class="main">-</span> <span class="main">(</span>kmax <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> PR <span class="main">∪</span> kmin <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> PR<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span> <span class="main">+</span> 
     Min <span class="main">(</span><span class="free">f</span> <span class="main">`</span> 
             <span class="main">(</span>PR <span class="main">-</span> <span class="main">(</span>kmax <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> PR <span class="main">∪</span> kmin <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> PR<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span> <span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>PR <span class="main">-</span> <span class="main">(</span>kmax <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> PR <span class="main">∪</span> kmin <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> PR<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> reduce_not_empty <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"PR <span class="main">-</span> <span class="main">(</span>kmax <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> PR <span class="main">∪</span> kmin <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> PR<span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reduce_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">`</span> 
       <span class="main">(</span>PR <span class="main">-</span> <span class="main">(</span>kmax <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> PR <span class="main">∪</span> kmin <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> PR<span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">=</span> 
       Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> 
             <span class="main">(</span>PR <span class="main">-</span> <span class="main">(</span>kmax <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> PR <span class="main">∪</span> kmin <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> PR<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> 
      <span class="quoted"><span class="quoted">"Min <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">`</span> 
       <span class="main">(</span>PR <span class="main">-</span> <span class="main">(</span>kmax <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> PR <span class="main">∪</span> kmin <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> PR<span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">=</span> 
       Min <span class="main">(</span><span class="free">f</span> <span class="main">`</span> 
             <span class="main">(</span>PR <span class="main">-</span> <span class="main">(</span>kmax <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> PR <span class="main">∪</span> kmin <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> PR<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> max_shift <span class="keyword2"><span class="keyword">and</span></span> min_shift
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">from</span></span> reduce_shift
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> 
    <span class="main">(</span>Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> 
             <span class="main">(</span>PR <span class="main">-</span> <span class="main">(</span>kmax <span class="free">f</span>  PR <span class="main">∪</span> kmin <span class="free">f</span> PR<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span> <span class="main">+</span> 
     Min <span class="main">(</span><span class="free">f</span> <span class="main">`</span> 
             <span class="main">(</span>PR <span class="main">-</span> <span class="main">(</span>kmax <span class="free">f</span> PR <span class="main">∪</span> kmin <span class="free">f</span> PR<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span> <span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Max <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span><span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>Min <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reduce_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>Max <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span> <span class="main">+</span> Min <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">x</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfnl_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Precision Enhancement property›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An informal proof of this theorem can be found in \cite{miner93}›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary lemmas›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This first lemma is most important for prove the
property. This is a consecuence of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] card_Un_Int<span class="antiquote"><span class="antiquote">}</span></span></span></span>
lemma›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pigeonhole<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span>
  finitA<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  Bss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Css<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  cardH<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">A</span> <span class="main">+</span> <span class="free">k</span> <span class="main">&lt;=</span> card <span class="free">B</span> <span class="main">+</span> card <span class="free">C</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;=</span> card <span class="main">(</span><span class="free">B</span> <span class="main">∩</span> <span class="free">C</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> Bss Css <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∪</span> <span class="free">C</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> finitA <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">B</span> <span class="main">∪</span> <span class="free">C</span><span class="main">)</span> <span class="main">&lt;=</span> card <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> cardH <span class="keyword1"><span class="command">have</span></span>
      h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;=</span> card <span class="free">B</span> <span class="main">+</span> card <span class="free">C</span> <span class="main">-</span> card <span class="main">(</span><span class="free">B</span> <span class="main">∪</span> <span class="free">C</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">from</span></span> finitA Bss Css <span class="keyword2"><span class="keyword">and</span></span> finite_subset 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span> <span class="main">∧</span> finite <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> card_Un_Int <span class="keyword2"><span class="keyword">and</span></span> h <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This lemma is a trivial consecuence of the previous one. With
only this lemma we can prove the Precision Enhancement property with
the bound $\pi(x,y) = x + y$. But this bound not satisfy the property
\[ \pi(2\Lambda + 2 \beta\rho, \delta_S + 2\rho(r_{max}+\beta) +
2\Lambda) \leq \delta_S 
\] that is used in \cite{shankar92mechanical} for prove the
Schneider's schema.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subsets_int<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span>
  finitA<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  Bss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Css<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  cardH<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">A</span> <span class="main">&lt;</span> card <span class="free">B</span> <span class="main">+</span> card <span class="free">C</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> finitA Bss Css cardH
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;=</span> card <span class="main">(</span><span class="free">B</span> <span class="main">∩</span> <span class="free">C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  pigeonhole<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This lemma is true because <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"reduce <span class="free"><span class="free">f</span></span> PR"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the image
of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"PR<span class="main"><span class="main">-</span></span><span class="main"><span class="main">(</span></span>kmax <span class="free"><span class="free">f</span></span> PR <span class="main"><span class="main">∪</span></span> kmin <span class="free"><span class="free">f</span></span> PR<span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by the function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exist_reduce<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> reduce <span class="free">f</span> PR<span class="main">.</span> <span class="main">∃</span> <span class="bound">i</span><span class="main">∈</span> PR<span class="main">-</span><span class="main">(</span>kmax <span class="free">f</span> PR <span class="main">∪</span> kmin <span class="free">f</span> PR<span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
<span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> reduce <span class="free">f</span> PR"</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">∈</span> PR<span class="main">-</span><span class="main">(</span>kmax <span class="free">f</span> PR <span class="main">∪</span> kmin <span class="free">f</span> PR<span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reduce_def kmax_def kmin_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next three lemmas are consequence of the definition of
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">reduce</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">kmax</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">kmin</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
 
<span class="keyword1"><span class="command">lemma</span></span> finite_reduce<span class="main">:</span>
<span class="quoted"><span class="quoted">"finite <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> reduce_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="main">(</span>PR <span class="main">-</span> <span class="main">(</span>kmax <span class="free">f</span> PR <span class="main">∪</span> kmin <span class="free">f</span> PR<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> kmax_ge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">∈</span> <span class="main">(</span>kmax <span class="free">f</span> PR<span class="main">)</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span><span class="main">.</span> <span class="bound">r</span> <span class="main">&lt;=</span> <span class="free">f</span> <span class="bound">i</span> "</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> kmax <span class="free">f</span> PR"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">∈</span>reduce <span class="free">f</span> PR<span class="main">.</span> <span class="bound">r</span> <span class="main">≤</span> <span class="free">f</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="keyword3"><span class="command">assume</span></span> asm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> reduce <span class="free">f</span> PR"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≤</span> <span class="free">f</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> asm2 <span class="keyword2"><span class="keyword">and</span></span> exist_reduce <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">j</span> <span class="main">∈</span> PR<span class="main">-</span><span class="main">(</span>kmax <span class="free">f</span> PR <span class="main">∪</span> kmin <span class="free">f</span> PR<span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">j</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> 
      <span class="keyword2"><span class="keyword">where</span></span> fjr<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> PR<span class="main">-</span><span class="main">(</span>kmax <span class="free">f</span> PR <span class="main">∪</span> kmin <span class="free">f</span> PR<span class="main">)</span> <span class="main">∧</span> <span class="free">f</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">(</span>PR <span class="main">-</span> kmax <span class="free">f</span> PR<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> this fjr asm  
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> kmax_prop
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> kmin_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">∈</span> <span class="main">(</span>kmin <span class="free">f</span> PR<span class="main">)</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">&lt;=</span> <span class="bound">r</span> "</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> kmin <span class="free">f</span> PR"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">∈</span>reduce <span class="free">f</span> PR<span class="main">.</span> <span class="free">f</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="bound">r</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="keyword3"><span class="command">assume</span></span> asm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> reduce <span class="free">f</span> PR"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">i</span> <span class="main">&lt;=</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> asm2 <span class="keyword2"><span class="keyword">and</span></span> exist_reduce <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">j</span><span class="main">∈</span> PR<span class="main">-</span><span class="main">(</span>kmax <span class="free">f</span> PR <span class="main">∪</span> kmin <span class="free">f</span> PR<span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">j</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> 
      <span class="keyword2"><span class="keyword">where</span></span> fjr<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> PR<span class="main">-</span><span class="main">(</span>kmax <span class="free">f</span> PR <span class="main">∪</span> kmin <span class="free">f</span> PR<span class="main">)</span> <span class="main">∧</span> <span class="free">f</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">(</span>PR <span class="main">-</span> kmin <span class="free">f</span> PR<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> this fjr asm  
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> kmin_prop
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next lemma is used for prove the Precision Enhancement
property. This has been proved in ICS. The proof is in the appendix
\ref{sec:abs_distrib_mult}.  This cannot be prove by a simple <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>arith›</span></span></span></span> or <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>auto›</span></span></span></span> tactic.›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This lemma is true also with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>0 &lt;= c›</span></span></span></span> !!›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> abs_distrib_div<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">c</span><span class="main">::</span>real<span class="main">)</span>  <span class="main">⟹</span> <span class="main">¦</span><span class="free">a</span> <span class="main">/</span> <span class="free">c</span> <span class="main">-</span> <span class="free">b</span> <span class="main">/</span> <span class="free">c</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">¦</span> <span class="main">/</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> ch<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">&lt;</span><span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="main">::</span> <span class="quoted">real</span>
    <span class="keyword3"><span class="command">assume</span></span> dh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">&lt;=</span><span class="skolem">d</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="skolem">d</span> <span class="main">-</span> <span class="free">b</span> <span class="main">*</span> <span class="skolem">d</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">d</span> "</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span> <span class="main">*</span> <span class="skolem">d</span> <span class="main">-</span> <span class="free">b</span> <span class="main">*</span> <span class="skolem">d</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">d</span><span class="main">¦</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> dh <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">¦</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">¦</span> <span class="main">*</span> <span class="skolem">d</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span> <span class="main">*</span> <span class="skolem">d</span> <span class="main">-</span> <span class="free">b</span> <span class="main">*</span> <span class="skolem">d</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">¦</span> <span class="main">*</span> <span class="skolem">d</span>"</span></span>
        <span class="keyword1"><span class="command">.</span></span>
    <span class="comment1">(* This sublemma is solved by ICS, file: abs_distrib_mult.ics *)</span>
    <span class="comment1">(* It is not solved nor 
       by (auto simp add: distrib_right diff_minus)(arith) 
        in Isabelle  *)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> ch <span class="keyword2"><span class="keyword">and</span></span> divide_inverse <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_inverse<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next three lemmas are about the existence of bounds of the
values <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Max <span class="main"><span class="main">(</span></span>reduce <span class="free"><span class="free">f</span></span> PR<span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Min <span class="main"><span class="main">(</span></span>reduce <span class="free"><span class="free">f</span></span> PR<span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. These
are used in the proof of the main property.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> uboundmax<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> 
  hC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> PR"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hCk<span class="main">:</span> <span class="quoted"><span class="quoted">"np <span class="main">&lt;=</span> card <span class="free">C</span> <span class="main">+</span> khl"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> Max <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span> <span class="main">&lt;=</span> <span class="free">f</span> <span class="bound">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> reduce_not_empty <span class="keyword2"><span class="keyword">and</span></span> finite_reduce 
  <span class="keyword1"><span class="command">have</span></span> maxrinr<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span> <span class="main">∈</span> reduce <span class="free">f</span> PR"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> exist_reduce
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">∈</span> PR<span class="main">-</span><span class="main">(</span>kmax <span class="free">f</span> PR <span class="main">∪</span> kmin <span class="free">f</span> PR<span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">=</span> Max <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pmax</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    pmax_in_reduc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pmax</span> <span class="main">∈</span> PR<span class="main">-</span><span class="main">(</span>kmax <span class="free">f</span> PR <span class="main">∪</span> kmin <span class="free">f</span> PR<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    fpmax_ismax<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">pmax</span> <span class="main">=</span> Max <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∩</span> insert <span class="skolem">pmax</span> <span class="main">(</span>kmax <span class="free">f</span> PR<span class="main">)</span>  <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> kmax_prop <span class="keyword2"><span class="keyword">and</span></span> pmax_in_reduc 
      <span class="keyword2"><span class="keyword">and</span></span> finite_kmax <span class="keyword2"><span class="keyword">and</span></span> hCk  <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"card PR <span class="main">&lt;</span> card <span class="free">C</span> <span class="main">+</span> card <span class="main">(</span>insert <span class="skolem">pmax</span> <span class="main">(</span>kmax <span class="free">f</span> PR<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> pmax_in_reduc <span class="keyword2"><span class="keyword">and</span></span> kmax_prop
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">pmax</span> <span class="main">(</span>kmax <span class="free">f</span> PR<span class="main">)</span> <span class="main">⊆</span> PR"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">note</span></span> hC
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> subsets_int<span class="main">[</span><span class="operator">of</span> <span class="quoted">PR</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">pmax</span> <span class="main">(</span>kmax <span class="free">f</span> PR<span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="bound">i</span><span class="main">=</span><span class="skolem">pmax</span> <span class="main">∨</span> <span class="bound">i</span> <span class="main">∈</span> kmax <span class="free">f</span> PR"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    iinC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> altern<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">=</span><span class="skolem">pmax</span> <span class="main">∨</span> <span class="skolem">i</span> <span class="main">∈</span> kmax <span class="free">f</span> PR"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">=</span><span class="skolem">pmax</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> iinC fpmax_ismax <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> altern maxrinr fpmax_ismax kmax_ge
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">pmax</span> <span class="main">&lt;=</span> <span class="free">f</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> iinC fpmax_ismax <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> lboundmin<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> 
  hC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> PR"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hCk<span class="main">:</span> <span class="quoted"><span class="quoted">"np <span class="main">&lt;=</span> card <span class="free">C</span> <span class="main">+</span> khl"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">&lt;=</span> Min <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> reduce_not_empty <span class="keyword2"><span class="keyword">and</span></span> finite_reduce 
  <span class="keyword1"><span class="command">have</span></span> minrinr<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span> <span class="main">∈</span> reduce <span class="free">f</span> PR"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> exist_reduce
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">∈</span> PR<span class="main">-</span><span class="main">(</span>kmax <span class="free">f</span> PR <span class="main">∪</span> kmin <span class="free">f</span> PR<span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">=</span> Min <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pmin</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    pmin_in_reduc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pmin</span> <span class="main">∈</span> PR<span class="main">-</span><span class="main">(</span>kmax <span class="free">f</span> PR <span class="main">∪</span> kmin <span class="free">f</span> PR<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    fpmin_ismin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">pmin</span> <span class="main">=</span> Min <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∩</span> insert <span class="skolem">pmin</span> <span class="main">(</span>kmin <span class="free">f</span> PR<span class="main">)</span>  <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> kmin_prop <span class="keyword2"><span class="keyword">and</span></span> pmin_in_reduc 
      <span class="keyword2"><span class="keyword">and</span></span> finite_kmin <span class="keyword2"><span class="keyword">and</span></span> hCk  <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"card PR <span class="main">&lt;</span> card <span class="free">C</span> <span class="main">+</span> card <span class="main">(</span>insert <span class="skolem">pmin</span> <span class="main">(</span>kmin <span class="free">f</span> PR<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> pmin_in_reduc <span class="keyword2"><span class="keyword">and</span></span> kmin_prop
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">pmin</span> <span class="main">(</span>kmin <span class="free">f</span> PR<span class="main">)</span> <span class="main">⊆</span> PR"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">note</span></span> hC
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> subsets_int<span class="main">[</span><span class="operator">of</span> <span class="quoted">PR</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">pmin</span> <span class="main">(</span>kmin <span class="free">f</span> PR<span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="bound">i</span><span class="main">=</span><span class="skolem">pmin</span> <span class="main">∨</span> <span class="bound">i</span> <span class="main">∈</span> kmin <span class="free">f</span> PR"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    iinC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> altern<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">=</span><span class="skolem">pmin</span> <span class="main">∨</span> <span class="skolem">i</span> <span class="main">∈</span> kmin <span class="free">f</span> PR"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">=</span><span class="skolem">pmin</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> iinC fpmin_ismin <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> altern minrinr fpmin_ismin kmin_le
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">i</span> <span class="main">&lt;=</span> <span class="free">f</span> <span class="skolem">pmin</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> iinC fpmin_ismin <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> same_bound<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> 
  hC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> PR"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hCk<span class="main">:</span> <span class="quoted"><span class="quoted">"np <span class="main">&lt;=</span> card <span class="free">C</span> <span class="main">+</span> khl"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hnk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">*</span> khl <span class="main">&lt;</span> np"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> Min <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span> <span class="main">&lt;=</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">∧</span> <span class="free">g</span> <span class="bound">i</span> <span class="main">&lt;=</span> Max <span class="main">(</span>reduce <span class="free">g</span> PR<span class="main">)</span> "</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> b1<span class="main">:</span> <span class="quoted"><span class="quoted">"khl <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;=</span> card <span class="main">(</span><span class="free">C</span> <span class="main">∩</span> <span class="main">(</span>PR <span class="main">-</span> kmin <span class="free">f</span> PR<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> pigeonhole<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite PR"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> PR"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"PR <span class="main">-</span> kmin <span class="free">f</span> PR <span class="main">⊆</span> PR"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card PR <span class="main">+</span> <span class="main">(</span>khl <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> card <span class="free">C</span> <span class="main">+</span> card <span class="main">(</span>PR <span class="main">-</span> kmin <span class="free">f</span> PR<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> hnk <span class="keyword2"><span class="keyword">and</span></span> hCk <span class="keyword1"><span class="command">have</span></span> 
        <span class="quoted"><span class="quoted">"np <span class="main">+</span> khl <span class="main">&lt;</span> np <span class="main">+</span> card <span class="free">C</span> <span class="main">-</span> khl"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span> 
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword1"><span class="command">from</span></span> kmin_prop
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> np <span class="main">+</span> card <span class="free">C</span> <span class="main">-</span> card <span class="main">(</span>kmin <span class="free">f</span> PR<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="free">C</span> <span class="main">+</span> <span class="main">(</span>card PR <span class="main">-</span> card <span class="main">(</span>kmin <span class="free">f</span> PR<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> kmin_prop <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"card <span class="main">(</span>kmin <span class="free">f</span> PR<span class="main">)</span> <span class="main">&lt;=</span> card PR"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword1"><span class="command">from</span></span> kmin_prop 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="free">C</span> <span class="main">+</span>  card <span class="main">(</span>PR <span class="main">-</span> kmin <span class="free">f</span> PR<span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> kmin_prop <span class="keyword2"><span class="keyword">and</span></span> finite_kmin <span class="keyword1"><span class="command">have</span></span> 
          <span class="quoted"><span class="quoted">"card PR <span class="main">-</span> card <span class="main">(</span>kmin <span class="free">f</span> PR<span class="main">)</span> <span class="main">=</span>  card <span class="main">(</span>PR <span class="main">-</span> kmin <span class="free">f</span> PR<span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_Diff_subset<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
        
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∩</span> <span class="main">(</span>PR <span class="main">-</span> kmin <span class="free">f</span> PR<span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>PR <span class="main">-</span> kmax <span class="free">g</span> PR<span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> subsets_int<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite PR"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∩</span> <span class="main">(</span>PR <span class="main">-</span> kmin <span class="free">f</span> PR<span class="main">)</span> <span class="main">⊆</span> PR"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"PR <span class="main">-</span> kmax <span class="free">g</span> PR <span class="main">⊆</span> PR"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card PR <span class="main">&lt;</span> 
      card <span class="main">(</span><span class="free">C</span> <span class="main">∩</span> <span class="main">(</span>PR <span class="main">-</span> kmin <span class="free">f</span> PR<span class="main">)</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span>PR <span class="main">-</span> kmax <span class="free">g</span> PR<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> kmax_prop <span class="keyword2"><span class="keyword">and</span></span> finite_kmax
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>PR <span class="main">-</span> kmax <span class="free">g</span> PR<span class="main">)</span><span class="main">=</span> card PR <span class="main">-</span> card <span class="main">(</span>kmax <span class="free">g</span> PR<span class="main">)</span> "</span></span> 
        <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">intro</span> card_Diff_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> kmax_prop <span class="keyword1"><span class="command">have</span></span> 
        <span class="quoted"><span class="quoted">"card <span class="main">(</span>PR <span class="main">-</span> kmax <span class="free">g</span> PR<span class="main">)</span> <span class="main">=</span> card PR <span class="main">-</span> khl"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> b1
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">hence</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">C</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">(</span>PR <span class="main">-</span> kmin <span class="free">f</span> PR<span class="main">)</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">(</span>PR <span class="main">-</span> kmax <span class="free">g</span> PR<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    in_C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    not_in_kmin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">(</span>PR <span class="main">-</span> kmin <span class="free">f</span> PR<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    not_in_kmax<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">(</span>PR <span class="main">-</span> kmax <span class="free">g</span> PR<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span> <span class="main">&lt;=</span> <span class="free">f</span> <span class="skolem">i</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> kmax <span class="free">f</span> PR"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> reduce_not_empty <span class="keyword2"><span class="keyword">and</span></span> finite_reduce <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">" Min <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span> <span class="main">∈</span> reduce <span class="free">f</span> PR"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> kmax_ge <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> not_in_kmin  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> PR <span class="main">-</span> <span class="main">(</span>kmax <span class="free">f</span> PR <span class="main">∪</span> kmin <span class="free">f</span> PR<span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> reduce_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">i</span> <span class="main">∈</span> reduce <span class="free">f</span> PR"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> reduce_not_empty <span class="keyword2"><span class="keyword">and</span></span> finite_reduce
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">i</span> <span class="main">&lt;=</span> Max <span class="main">(</span>reduce <span class="free">g</span> PR<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> kmin <span class="free">g</span> PR"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> reduce_not_empty <span class="keyword2"><span class="keyword">and</span></span> finite_reduce <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">" Max <span class="main">(</span>reduce <span class="free">g</span> PR<span class="main">)</span> <span class="main">∈</span> reduce <span class="free">g</span> PR"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> kmin_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> not_in_kmax  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> PR <span class="main">-</span> <span class="main">(</span>kmax <span class="free">g</span> PR <span class="main">∪</span> kmin <span class="free">g</span> PR<span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> reduce_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">i</span> <span class="main">∈</span> reduce <span class="free">g</span> PR"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> reduce_not_empty <span class="keyword2"><span class="keyword">and</span></span> finite_reduce
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> in_C
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Main theorem›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The most part of this theorem can be proved with CVC-lite
using the three previous lemmas (appendix \ref{sec:bound_prec_enh}).›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> prec_enh<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> 
  hC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> PR"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hCF<span class="main">:</span> <span class="quoted"><span class="quoted">"np <span class="main">-</span> <span class="free">nF</span> <span class="main">&lt;=</span> card <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hFn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">*</span> <span class="free">nF</span> <span class="main">&lt;</span> np"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hFk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nF</span> <span class="main">=</span> khl"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hbx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">l</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hby1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">m</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">m</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hby2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">m</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span><span class="free">g</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">m</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hpC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hqC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">∈</span><span class="free">C</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span> cfnl <span class="free">p</span> <span class="free">f</span> <span class="main">-</span> cfnl <span class="free">q</span> <span class="free">g</span> <span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">y</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> hCF <span class="keyword2"><span class="keyword">and</span></span> hFk 
  <span class="keyword1"><span class="command">have</span></span> hCk<span class="main">:</span> <span class="quoted"><span class="quoted">"np <span class="main">&lt;=</span> card <span class="free">C</span> <span class="main">+</span> khl"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">from</span></span> hFn <span class="keyword2"><span class="keyword">and</span></span> hFk 
  <span class="keyword1"><span class="command">have</span></span> hnk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">*</span> khl <span class="main">&lt;</span> np"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">let</span></span>    <span class="var"><span class="quoted"><span class="var">?maxf</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span>  <span class="var"><span class="quoted"><span class="var">?minf</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>  <span class="var"><span class="quoted"><span class="var">?maxg</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>reduce <span class="free">g</span> PR<span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span>  <span class="var"><span class="quoted"><span class="var">?ming</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>reduce <span class="free">g</span> PR<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> abs_distrib_div
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>cfnl <span class="free">p</span> <span class="free">f</span> <span class="main">-</span> cfnl <span class="free">q</span> <span class="free">g</span><span class="main">¦</span> <span class="main">=</span> 
    <span class="main">¦</span><span class="var">?maxf</span> <span class="main">+</span> <span class="var">?minf</span>  <span class="main">+</span>  <span class="main">-</span> <span class="var">?maxg</span> <span class="main">+</span> <span class="main">-</span> <span class="var">?ming</span><span class="main">¦</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> cfnl_def<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="var">?maxf</span> <span class="main">+</span> <span class="var">?minf</span>  <span class="main">+</span>  <span class="main">-</span> <span class="var">?maxg</span> <span class="main">+</span> <span class="main">-</span> <span class="var">?ming</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">y</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">x</span>"</span></span>
    <span class="comment1">― ‹The rest of the property can be proved by CVC-lite
           (see appendix \ref{sec:bound_prec_enh})›</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;=</span> <span class="var">?maxf</span> <span class="main">+</span> <span class="var">?minf</span>  <span class="main">+</span>  <span class="main">-</span> <span class="var">?maxg</span> <span class="main">+</span> <span class="main">-</span> <span class="var">?ming</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="var">?maxf</span> <span class="main">+</span> <span class="var">?minf</span>  <span class="main">+</span>  <span class="main">-</span> <span class="var">?maxg</span> <span class="main">+</span> <span class="main">-</span> <span class="var">?ming</span><span class="main">¦</span> <span class="main">=</span> 
      <span class="var">?maxf</span> <span class="main">+</span> <span class="var">?minf</span>  <span class="main">+</span>  <span class="main">-</span> <span class="var">?maxg</span> <span class="main">+</span> <span class="main">-</span> <span class="var">?ming</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> uboundmax hC hCk 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mxf</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> mxfinC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mxf</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
            maxf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?maxf</span> <span class="main">&lt;=</span> <span class="free">f</span> <span class="skolem">mxf</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> lboundmin hC hCk 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mng</span></span> 
      <span class="keyword2"><span class="keyword">where</span></span> mnginC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mng</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
            ming<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">mng</span> <span class="main">&lt;=</span> <span class="var">?ming</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>    
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> same_bound hC hCk hnk  
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mxn</span></span> 
      <span class="keyword2"><span class="keyword">where</span></span> mxninC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mxn</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
            mxnf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?minf</span>  <span class="main">≤</span> <span class="free">f</span> <span class="skolem">mxn</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            mxng<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">mxn</span> <span class="main">≤</span> <span class="var">?maxg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">¦</span> <span class="var">?maxf</span> <span class="main">+</span> <span class="var">?minf</span>  <span class="main">+</span>  <span class="main">-</span> <span class="var">?maxg</span> <span class="main">+</span> <span class="main">-</span> <span class="var">?ming</span><span class="main">¦</span> <span class="main">&lt;=</span> 
      <span class="main">(</span><span class="free">f</span> <span class="skolem">mxf</span> <span class="main">+</span> <span class="main">-</span> <span class="free">g</span> <span class="skolem">mng</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">mxn</span>  <span class="main">+</span>  <span class="main">-</span> <span class="free">g</span> <span class="skolem">mxn</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">also</span></span> 
    <span class="keyword1"><span class="command">from</span></span>  mxninC hbx abs_le_D1
    <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">mxf</span> <span class="main">+</span> <span class="main">-</span> <span class="free">g</span> <span class="skolem">mng</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">mxf</span> <span class="main">+</span> <span class="main">-</span> <span class="free">f</span> <span class="skolem">mng</span> <span class="main">)</span> <span class="main">+</span> <span class="main">(</span> <span class="free">f</span> <span class="skolem">mng</span> <span class="main">+</span> <span class="main">-</span> <span class="free">g</span> <span class="skolem">mng</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> <span class="free">y</span> <span class="main">+</span> <span class="main">(</span> <span class="free">f</span> <span class="skolem">mng</span> <span class="main">+</span> <span class="main">-</span> <span class="free">g</span> <span class="skolem">mng</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span>  mxfinC mnginC hby1 abs_le_D1
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">mxf</span> <span class="main">+</span> <span class="main">-</span> <span class="free">f</span> <span class="skolem">mng</span> <span class="main">&lt;=</span> <span class="free">y</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">from</span></span>  mnginC hbx abs_le_D1
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> <span class="free">y</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="var">?maxf</span> <span class="main">+</span> <span class="var">?minf</span>  <span class="main">+</span>  <span class="main">-</span> <span class="var">?maxg</span> <span class="main">+</span> <span class="main">-</span> <span class="var">?ming</span><span class="main">¦</span> <span class="main">=</span> 
      <span class="var">?maxg</span> <span class="main">+</span> <span class="var">?ming</span>  <span class="main">+</span>  <span class="main">-</span> <span class="var">?maxf</span> <span class="main">+</span> <span class="main">-</span> <span class="var">?minf</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> uboundmax hC hCk 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mxg</span></span> 
      <span class="keyword2"><span class="keyword">where</span></span> mxginC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mxg</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
            maxg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?maxg</span> <span class="main">&lt;=</span> <span class="free">g</span> <span class="skolem">mxg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> lboundmin hC hCk 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mnf</span></span> 
      <span class="keyword2"><span class="keyword">where</span></span> mnfinC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mnf</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
            minf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">mnf</span> <span class="main">&lt;=</span> <span class="var">?minf</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>    
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> same_bound hC hCk hnk  
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mxn</span></span> 
      <span class="keyword2"><span class="keyword">where</span></span> mxninC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mxn</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
            mxnf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ming</span>  <span class="main">≤</span> <span class="free">g</span> <span class="skolem">mxn</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            mxng<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">mxn</span> <span class="main">≤</span> <span class="var">?maxf</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">¦</span> <span class="var">?maxf</span> <span class="main">+</span> <span class="var">?minf</span>  <span class="main">+</span>  <span class="main">-</span> <span class="var">?maxg</span> <span class="main">+</span> <span class="main">-</span> <span class="var">?ming</span><span class="main">¦</span> <span class="main">&lt;=</span> 
      <span class="main">(</span><span class="free">g</span> <span class="skolem">mxg</span> <span class="main">+</span> <span class="main">-</span> <span class="free">f</span> <span class="skolem">mnf</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">mxn</span>  <span class="main">+</span>  <span class="main">-</span> <span class="free">f</span> <span class="skolem">mxn</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">from</span></span>  mxninC hbx 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">mxg</span> <span class="main">+</span> <span class="main">-</span> <span class="free">f</span> <span class="skolem">mnf</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> abs_le_D2<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">mxg</span> <span class="main">+</span> <span class="main">-</span> <span class="free">g</span> <span class="skolem">mnf</span> <span class="main">)</span> <span class="main">+</span> <span class="main">(</span> <span class="free">g</span> <span class="skolem">mnf</span> <span class="main">+</span> <span class="main">-</span> <span class="free">f</span> <span class="skolem">mnf</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> <span class="free">y</span> <span class="main">+</span> <span class="main">(</span> <span class="free">g</span> <span class="skolem">mnf</span> <span class="main">+</span> <span class="main">-</span> <span class="free">f</span> <span class="skolem">mnf</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span>  mxginC mnfinC hby2 abs_le_D1
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">mxg</span> <span class="main">+</span> <span class="main">-</span> <span class="free">g</span> <span class="skolem">mnf</span> <span class="main">&lt;=</span> <span class="free">y</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">from</span></span>  mnfinC hbx
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;=</span> <span class="free">y</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> abs_le_D2<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Accuracy Preservation property›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹No new lemmas are needed for prove this property. The bound
has been found using the lemmas <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] uboundmax<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>
[source] lboundmin<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theorem can be proved with ICS and CVC-lite assuming
those lemmas (see appendix \ref{sec:accur_pres}).›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> accur_pres<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span>
  hC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> PR"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hCF<span class="main">:</span> <span class="quoted"><span class="quoted">"np <span class="main">-</span> <span class="free">nF</span> <span class="main">&lt;=</span> card <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hFk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nF</span> <span class="main">=</span> khl"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hby<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">m</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">l</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">m</span><span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hqC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">∈</span><span class="free">C</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span> cfnl <span class="free">p</span> <span class="free">f</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">¦</span> <span class="main">&lt;=</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> hCF <span class="keyword2"><span class="keyword">and</span></span> hFk 
  <span class="keyword1"><span class="command">have</span></span> npleCk<span class="main">:</span> <span class="quoted"><span class="quoted">"np <span class="main">&lt;=</span> card <span class="free">C</span> <span class="main">+</span> khl"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">q</span> <span class="main">&lt;=</span> cfnl <span class="free">p</span> <span class="free">f</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> npleCk hC <span class="keyword2"><span class="keyword">and</span></span>  uboundmax 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> Max <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span> <span class="main">&lt;=</span> <span class="free">f</span> <span class="bound">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pi</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      hpiC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pi</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      fpiGeMax<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span> <span class="main">&lt;=</span> <span class="free">f</span> <span class="skolem">pi</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> reduce_not_empty 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span> <span class="main">&lt;=</span> Max <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reduce_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> fpiGeMax <span class="keyword1"><span class="command">have</span></span>
      cfnlLefpi<span class="main">:</span> <span class="quoted"><span class="quoted">"cfnl <span class="free">p</span> <span class="free">f</span> <span class="main">&lt;=</span> <span class="free">f</span> <span class="skolem">pi</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfnl_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> True <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">¦</span> cfnl <span class="free">p</span> <span class="free">f</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">¦</span> <span class="main">&lt;=</span> <span class="main">¦</span> <span class="free">f</span> <span class="skolem">pi</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">¦</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">with</span></span> hpiC <span class="keyword2"><span class="keyword">and</span></span> hqC <span class="keyword2"><span class="keyword">and</span></span> hby <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> npleCk hC <span class="keyword2"><span class="keyword">and</span></span> lboundmin 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">&lt;=</span> Min <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qi</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      hqiC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qi</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      fqiLeMax<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">qi</span> <span class="main">&lt;=</span> Min <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> reduce_not_empty 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span> <span class="main">&lt;=</span> Max <span class="main">(</span>reduce <span class="free">f</span> PR<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reduce_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> fqiLeMax 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">qi</span> <span class="main">&lt;=</span> cfnl <span class="free">p</span> <span class="free">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfnl_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">¦</span> cfnl <span class="free">p</span> <span class="free">f</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">¦</span> <span class="main">&lt;=</span> <span class="main">¦</span> <span class="free">f</span> <span class="skolem">qi</span> <span class="main">-</span> <span class="free">f</span> <span class="free">q</span> <span class="main">¦</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">with</span></span> hqiC <span class="keyword2"><span class="keyword">and</span></span> hqC <span class="keyword2"><span class="keyword">and</span></span> hby <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>