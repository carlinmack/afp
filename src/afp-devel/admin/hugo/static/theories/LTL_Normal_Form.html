<div id="Normal_Form">
<div class="head">
<h1>Theory Normal_Form</h1>
</div>
<pre class="source"><span class="comment1">(*
    Author:   Salomon Sickert
    License:  BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹A Normal Form for Linear Temporal Logic›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Normal_Form <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../LTL_Master_Theorem/Master_Theorem.html">LTL_Master_Theorem.Master_Theorem</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹LTL Equivalences›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Several valid laws of LTL relating strong and weak operators that are useful later.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ltln_strong_weak_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span> <span class="main">⟷</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis1</span>"</span></span><span class="main">)</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span> <span class="main">⟷</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">ψ</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> suffix <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">j</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="skolem">i</span><span class="main">.</span> <span class="main">¬</span> suffix <span class="bound">j</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&gt;</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&gt;</span> <span class="skolem">i</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"suffix <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis1</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ltln_strong_weak <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> suffix <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">j</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">i</span><span class="main">.</span> <span class="main">¬</span> suffix <span class="bound">j</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"suffix <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis2</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ltln_strong_weak <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ltln_weak_strong_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span> <span class="main">⟷</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">ψ</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis1</span>"</span></span><span class="main">)</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span> <span class="main">⟷</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">j</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">i</span> <span class="main">⟹</span> suffix <span class="bound">j</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> suffix <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> that<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis1</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ltln_weak_strong <span class="keyword1"><span class="command">unfolding</span></span> semantics_ltln.simps suffix_suffix <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">j</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">⟹</span> suffix <span class="bound">j</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> suffix <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> that<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis2</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ltln_weak_strong <span class="keyword1"><span class="command">unfolding</span></span> semantics_ltln.simps suffix_suffix <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹$\evalnu{\psi}{M}$, $\evalmu{\psi}{N}$, $\flatten{\psi}{M}$, and $\flattentwo{\psi}{N}$›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following four functions use "promise sets", named $M$ or $N$, to rewrite arbitrary 
  formulas into formulas from the class $\Sigma_1$-, $\Sigma_2$-, $\Pi_1$-, and $\Pi_2$, 
  respectively. In general the obtained formulas are not  equivalent, but under some conditions 
  (as outlined below) they are.›</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> FG_advice <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_<span class="keyword1">]<span class="hidden">⇩</span><sub>μ</sub></span>"</span> <span class="main">[</span>90<span class="main">,</span>60<span class="main">]</span> 89<span class="main">)</span>
<span class="keyword1"><span class="command">no_notation</span></span> GF_advice <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_<span class="keyword1">]<span class="hidden">⇩</span><sub>ν</sub></span>"</span> <span class="main">[</span>90<span class="main">,</span>60<span class="main">]</span> 89<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> FG_advice <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_<span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span> <span class="main">[</span>90<span class="main">,</span>60<span class="main">]</span> 89<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> GF_advice <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_<span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span> <span class="main">[</span>90<span class="main">,</span>60<span class="main">]</span> 89<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">flatten_sigma_2</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltln <span class="main">⇒</span> <span class="tfree">'a</span> ltln set <span class="main">⇒</span> <span class="tfree">'a</span> ltln"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_<span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">X<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">=</span> <span class="keyword1">X<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">flatten_pi_2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltln <span class="main">⇒</span> <span class="tfree">'a</span> ltln set <span class="main">⇒</span> <span class="tfree">'a</span> ltln"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_<span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">X<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">=</span> <span class="keyword1">X<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> GF_advice_restriction<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span><span class="main">[</span>𝒢ℱ <span class="main">(</span><span class="free">φ</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">φ</span><span class="main">[</span>𝒢ℱ <span class="free">φ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ψ</span><span class="main">[</span>𝒢ℱ <span class="main">(</span><span class="free">φ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">ψ</span><span class="main">[</span>𝒢ℱ <span class="free">ψ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> 𝒢ℱ_semantics' inf_commute inf_left_commute inf_sup_absorb subformulas<span class="hidden">⇩</span><sub>μ</sub>.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> GF_advice_inter_subformulas<span class="main">)</span> 
     <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> GF_advice_inter 𝒢ℱ.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> 𝒢ℱ_semantics' 𝒢ℱ_subformulas<span class="hidden">⇩</span><sub>μ</sub> inf.commute sup.boundedE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> FG_advice_restriction<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">ψ</span><span class="main">[</span>ℱ𝒢 <span class="main">(</span><span class="free">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">ψ</span><span class="main">[</span>ℱ𝒢 <span class="free">ψ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span><span class="main">[</span>ℱ𝒢 <span class="main">(</span><span class="free">φ</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">φ</span><span class="main">[</span>ℱ𝒢 <span class="free">φ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> FG_advice_inter ℱ𝒢.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> ℱ𝒢_semantics' ℱ𝒢_subformulas<span class="hidden">⇩</span><sub>ν</sub> inf.commute sup.boundedE<span class="main">)</span> 
     <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> FG_advice_inter ℱ𝒢.simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> ℱ𝒢_semantics' ℱ𝒢_subformulas<span class="hidden">⇩</span><sub>ν</sub> inf.right_idem inf_commute sup.cobounded1<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> flatten_sigma_2_intersection<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∩</span> subformulas<span class="hidden">⇩</span><sub>μ</sub> <span class="free">φ</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">φ</span><span class="main">[</span><span class="free">M</span> <span class="main">∩</span> <span class="free">S</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> GF_advice_inter<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flatten_sigma_2_intersection_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∩</span> subformulas<span class="hidden">⇩</span><sub>μ</sub> <span class="free">φ</span> <span class="main">=</span> <span class="free">M'</span> <span class="main">⟹</span> <span class="free">φ</span><span class="main">[</span><span class="free">M'</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> flatten_sigma_2_intersection <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> flatten_sigma_2_monotone<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">⊆</span> <span class="free">M'</span> <span class="main">⟹</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">[</span><span class="free">M'</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> GF_advice_monotone<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flatten_pi_2_intersection<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">∩</span> subformulas<span class="hidden">⇩</span><sub>ν</sub> <span class="free">φ</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">φ</span><span class="main">[</span><span class="free">N</span> <span class="main">∩</span> <span class="free">S</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">φ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> FG_advice_inter<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flatten_pi_2_intersection_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">∩</span> subformulas<span class="hidden">⇩</span><sub>ν</sub> <span class="free">φ</span> <span class="main">=</span> <span class="free">N'</span> <span class="main">⟹</span> <span class="free">φ</span><span class="main">[</span><span class="free">N'</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">φ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> flatten_pi_2_intersection <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> flatten_pi_2_monotone<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">N</span> <span class="main">⊆</span> <span class="free">N'</span> <span class="main">⟹</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">[</span><span class="free">N'</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> FG_advice_monotone<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ltln_weak_strong_stable_words_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">ψ</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">[</span>𝒢ℱ <span class="free">φ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  
  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> ℱ <span class="free">φ</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">w</span><span class="main">)</span> <span class="main">⊆</span> 𝒢ℱ <span class="free">φ</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> MOST_nat_le 𝒢ℱ_suffix μ_stable_def order_refl suffix_μ_stable<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> ℱ <span class="free">φ</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="main">(</span>suffix <span class="bound">j</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> 𝒢ℱ <span class="free">φ</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ℱ_suffix 𝒢ℱ_ℱ_subset 𝒢ℱ_suffix semiring_normalization_rules<span class="main"><span class="main">(</span></span>24<span class="main"><span class="main">)</span></span> subset_Un_eq suffix_suffix sup.orderE<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">i</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">φ</span><span class="main">[</span>𝒢ℱ <span class="free">φ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> GF_advice_a1<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> ℱ <span class="free">φ</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="main">(</span>suffix <span class="bound">j</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> 𝒢ℱ <span class="free">φ</span> <span class="free">w</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">ultimately</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ltln_weak_to_strong<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ltln_weak_strong_2 <span class="keyword1"><span class="command">unfolding</span></span> semantics_ltln.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝒢ℱ_suffix order_refl GF_advice_a2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ltln_weak_strong_stable_words_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">[</span>𝒢ℱ <span class="free">ψ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  
  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> ℱ <span class="free">ψ</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">w</span><span class="main">)</span> <span class="main">⊆</span> 𝒢ℱ <span class="free">ψ</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> MOST_nat_le 𝒢ℱ_suffix μ_stable_def order_refl suffix_μ_stable<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> ℱ <span class="free">ψ</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="main">(</span>suffix <span class="bound">j</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> 𝒢ℱ <span class="free">ψ</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ℱ_suffix 𝒢ℱ_ℱ_subset 𝒢ℱ_suffix semiring_normalization_rules<span class="main"><span class="main">(</span></span>24<span class="main"><span class="main">)</span></span> subset_Un_eq suffix_suffix sup.orderE<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">i</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">ψ</span><span class="main">[</span>𝒢ℱ <span class="free">ψ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> GF_advice_a1<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> ℱ <span class="free">ψ</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="main">(</span>suffix <span class="bound">j</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> 𝒢ℱ <span class="free">ψ</span> <span class="free">w</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">ultimately</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ltln_weak_to_strong <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ltln_weak_strong_2 <span class="keyword1"><span class="command">unfolding</span></span> semantics_ltln.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> GF_advice_a2 𝒢ℱ_suffix order_refl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ltln_weak_strong_stable_words<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">ψ</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">[</span>𝒢ℱ <span class="main">(</span><span class="free">φ</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">[</span>𝒢ℱ <span class="main">(</span><span class="free">φ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ltln_weak_strong_stable_words_1 ltln_weak_strong_stable_words_2 GF_advice_restriction <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flatten_sigma_2_IH_lifting<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> subfrmlsn <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"suffix <span class="free">i</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">[</span>𝒢ℱ <span class="free">ψ</span> <span class="main">(</span>suffix <span class="free">i</span> <span class="free">w</span><span class="main">)</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> suffix <span class="free">i</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"suffix <span class="free">i</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">[</span>𝒢ℱ <span class="free">φ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> suffix <span class="free">i</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> inf.absorb_iff2 inf_assoc inf_commute assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 𝒢ℱ_suffix flatten_sigma_2_intersection_eq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"𝒢ℱ <span class="free"><span class="free"><span class="free">φ</span></span></span> <span class="free"><span class="free"><span class="free">w</span></span></span>"</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">ψ</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"𝒢ℱ <span class="free"><span class="free"><span class="free">ψ</span></span></span> <span class="free"><span class="free"><span class="free">w</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> 𝒢ℱ_semantics' subformulas<span class="hidden">⇩</span><sub>μ</sub>_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> flatten_sigma_2_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">[</span>𝒢ℱ <span class="free">φ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟷</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> flatten_sigma_2_IH_lifting<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ1</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span>"</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Or_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> flatten_sigma_2_IH_lifting<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ1</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span>"</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Next_ltln <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> flatten_sigma_2_IH_lifting<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="keyword1">X<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ</span>"</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Until_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> flatten_sigma_2_IH_lifting<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ1</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Release_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ltln_weak_strong_stable_words
    <span class="keyword1"><span class="command">using</span></span> flatten_sigma_2_IH_lifting<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ1</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>WeakUntil_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ltln_weak_strong_stable_words
    <span class="keyword1"><span class="command">using</span></span> flatten_sigma_2_IH_lifting<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ1</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>StrongRelease_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> flatten_sigma_2_IH_lifting<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ1</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ltln_strong_weak_stable_words_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span> <span class="main">⟷</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">[</span>ℱ𝒢 <span class="free">ψ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"ν_stable <span class="free">ψ</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> MOST_nat less_Suc_eq suffix_ν_stable<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ψ</span> <span class="main">∈</span> ℱ𝒢 <span class="free">ψ</span> <span class="free">w</span><span class="main">.</span> suffix <span class="skolem">i</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ℱ𝒢_suffix 𝒢_elim ν_stable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">[</span>ℱ𝒢 <span class="free">ψ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">i</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">)</span><span class="main">[</span>ℱ𝒢 <span class="free">ψ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">i</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> FG_advice_b2_helper<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">ψ</span> <span class="main">∈</span> ℱ𝒢 <span class="free">ψ</span> <span class="free">w</span><span class="main">.</span> suffix <span class="skolem">i</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">ψ</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> ltln_weak_to_strong<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> semantics_ltln.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> until_and_left_distrib<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> 

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> suffix <span class="bound">i</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> suffix <span class="bound">i</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">[</span>ℱ𝒢 <span class="free">ψ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ℱ𝒢_suffix <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> FG_advice_b1<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ltln_strong_weak_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ltln_strong_weak_stable_words_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span> <span class="main">⟷</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">ψ</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">[</span>ℱ𝒢 <span class="free">φ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"ν_stable <span class="free">φ</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> MOST_nat less_Suc_eq suffix_ν_stable<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ψ</span> <span class="main">∈</span> ℱ𝒢 <span class="free">φ</span> <span class="free">w</span><span class="main">.</span> suffix <span class="skolem">i</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ℱ𝒢_suffix 𝒢_elim ν_stable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">ψ</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">[</span>ℱ𝒢 <span class="free">φ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">i</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">)</span><span class="main">[</span>ℱ𝒢 <span class="free">φ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">i</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> FG_advice_b2_helper<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">ψ</span> <span class="main">∈</span> ℱ𝒢 <span class="free">φ</span> <span class="free">w</span><span class="main">.</span> suffix <span class="skolem">i</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">ψ</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ltln_weak_to_strong<span class="main">(</span>3<span class="main">)</span> semantics_ltln.simps<span class="main">(</span>5<span class="main">)</span> strong_release_and_right_distrib <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> 

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> suffix <span class="bound">i</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="main">⟹</span> suffix <span class="bound">i</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">[</span>ℱ𝒢 <span class="free">φ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ℱ𝒢_suffix <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> FG_advice_b1<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ltln_strong_weak_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ltln_strong_weak_stable_words<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span> <span class="main">⟷</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">[</span>ℱ𝒢 <span class="main">(</span><span class="free">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span> <span class="main">⟷</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">ψ</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">[</span>ℱ𝒢 <span class="main">(</span><span class="free">φ</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ltln_strong_weak_stable_words_1 ltln_strong_weak_stable_words_2 FG_advice_restriction <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flatten_pi_2_IH_lifting<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> subfrmlsn <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"suffix <span class="free">i</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">[</span>ℱ𝒢 <span class="free">ψ</span> <span class="main">(</span>suffix <span class="free">i</span> <span class="free">w</span><span class="main">)</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> suffix <span class="free">i</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"suffix <span class="free">i</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span><span class="main">[</span>ℱ𝒢 <span class="free">φ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> suffix <span class="free">i</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> inf.absorb_iff2 inf_assoc inf_commute assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ℱ𝒢_suffix flatten_pi_2_intersection_eq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"ℱ𝒢 <span class="free"><span class="free"><span class="free">φ</span></span></span> <span class="free"><span class="free"><span class="free">w</span></span></span>"</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">ψ</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"ℱ𝒢 <span class="free"><span class="free"><span class="free">ψ</span></span></span> <span class="free"><span class="free"><span class="free">w</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> ℱ𝒢_semantics' subformulas<span class="hidden">⇩</span><sub>ν</sub>_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> flatten_pi_2_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">[</span>ℱ𝒢 <span class="free">φ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟷</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> flatten_pi_2_IH_lifting<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ1</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span>"</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Or_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> flatten_pi_2_IH_lifting<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ1</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span>"</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Next_ltln <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> flatten_pi_2_IH_lifting<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="keyword1">X<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ</span>"</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Until_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ltln_strong_weak_stable_words
    <span class="keyword1"><span class="command">using</span></span> flatten_pi_2_IH_lifting<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ1</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Release_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> flatten_pi_2_IH_lifting<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ1</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>WeakUntil_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> flatten_pi_2_IH_lifting<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ1</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>StrongRelease_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ltln_strong_weak_stable_words
    <span class="keyword1"><span class="command">using</span></span> flatten_pi_2_IH_lifting<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ1</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Main Theorem›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Using the four previously defined functions we obtain our normal form.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> normal_form_with_flatten_sigma_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="main">⟷</span> 
    <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">M</span></span> <span class="main">⊆</span> subformulas<span class="hidden">⇩</span><sub>μ</sub> <span class="free">φ</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">N</span></span> <span class="main">⊆</span> subformulas<span class="hidden">⇩</span><sub>ν</sub> <span class="free">φ</span><span class="main">.</span>
      <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">[</span><span class="bound">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span> <span class="main">∈</span> <span class="bound">M</span><span class="main">.</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">ψ</span><span class="main">[</span><span class="bound">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span> <span class="main">∈</span> <span class="bound">N</span><span class="main">.</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">ψ</span><span class="main">[</span><span class="bound">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">[</span>𝒢ℱ <span class="free">φ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flatten_sigma_2_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> 𝒢ℱ_subformulas<span class="hidden">⇩</span><sub>μ</sub> ℱ𝒢_subformulas<span class="hidden">⇩</span><sub>ν</sub> 𝒢ℱ_implies_GF ℱ𝒢_implies_FG <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">[</span><span class="skolem">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">⊆</span> 𝒢ℱ <span class="free">φ</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">⊆</span> ℱ𝒢 <span class="free">φ</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> X_𝒢ℱ_Y_ℱ𝒢 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">[</span>𝒢ℱ <span class="free">φ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flatten_sigma_2_monotone <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> flatten_sigma_2_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> normal_form_with_flatten_pi_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="main">⟷</span> 
    <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">M</span></span> <span class="main">⊆</span> subformulas<span class="hidden">⇩</span><sub>μ</sub> <span class="free">φ</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">N</span></span> <span class="main">⊆</span> subformulas<span class="hidden">⇩</span><sub>ν</sub> <span class="free">φ</span><span class="main">.</span>
      <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">[</span><span class="bound">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span> <span class="main">∈</span> <span class="bound">M</span><span class="main">.</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">ψ</span><span class="main">[</span><span class="bound">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span> <span class="main">∈</span> <span class="bound">N</span><span class="main">.</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">ψ</span><span class="main">[</span><span class="bound">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">[</span>ℱ𝒢 <span class="free">φ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flatten_pi_2_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> 𝒢ℱ_subformulas<span class="hidden">⇩</span><sub>μ</sub> ℱ𝒢_subformulas<span class="hidden">⇩</span><sub>ν</sub> 𝒢ℱ_implies_GF ℱ𝒢_implies_FG <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">[</span><span class="skolem">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">⊆</span> 𝒢ℱ <span class="free">φ</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">⊆</span> ℱ𝒢 <span class="free">φ</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> X_𝒢ℱ_Y_ℱ𝒢 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">[</span>ℱ𝒢 <span class="free">φ</span> <span class="free">w</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flatten_pi_2_monotone <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> flatten_pi_2_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Normal_Form_Complexity">
<div class="head">
<h1>Theory Normal_Form_Complexity</h1>
</div>
<pre class="source"><span class="comment1">(*
    Author:   Salomon Sickert
    License:  BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Size Bounds›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We prove an exponential upper bound for the normalisation procedure. Moreover, we show that 
  the number of proper subformulas, which correspond to states very-weak alternating automata 
  (A1W), is only linear for each disjunct.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Normal_Form_Complexity <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Normal_Form.html">Normal_Form</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inequalities and Identities›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inequality_1<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inequality_2<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">induction</span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size_gr_0<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="free">φ</span> <span class="main">::</span> <span class="tfree">'a</span> ltln<span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_associative<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">+</span> card <span class="free">X</span> <span class="main">*</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Length›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We prove that the length (size) of the resulting formula in normal form is at most exponential.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flatten_sigma_1_length<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="free">φ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">≤</span> size <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> flatten_pi_1_length<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="free">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">≤</span> size <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> flatten_sigma_2_length<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="free">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="free">φ</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span>  <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> inequality_2<span class="main">[</span><span class="operator">OF</span> size_gr_0 size_gr_0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Or_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span>  <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> inequality_2<span class="main">[</span><span class="operator">OF</span> size_gr_0 size_gr_0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Next_ltln <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> le_Suc_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>WeakUntil_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> size <span class="skolem">φ1</span> <span class="main">+</span> <span class="numeral">4</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute add_mono flatten_pi_1_length<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inequality_1<span class="main">[</span><span class="operator">OF</span> size_gr_0<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">φ1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inequality_2<span class="main">[</span><span class="operator">OF</span> size_gr_0 size_gr_0<span class="main">]</span> mult_le_mono2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>StrongRelease_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span>  <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> inequality_2<span class="main">[</span><span class="operator">OF</span> size_gr_0 size_gr_0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Until_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span>  <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> inequality_2<span class="main">[</span><span class="operator">OF</span> size_gr_0 size_gr_0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Release_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> size <span class="skolem">φ2</span> <span class="main">+</span> <span class="numeral">4</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute add_mono flatten_pi_1_length<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inequality_1<span class="main">[</span><span class="operator">OF</span> size_gr_0<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">φ2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inequality_2<span class="main">[</span><span class="operator">OF</span> size_gr_0 size_gr_0<span class="main">]</span> mult_le_mono2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> flatten_pi_2_length<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="free">φ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="free">φ</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span>  <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> inequality_2<span class="main">[</span><span class="operator">OF</span> size_gr_0 size_gr_0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Or_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span>  <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> inequality_2<span class="main">[</span><span class="operator">OF</span> size_gr_0 size_gr_0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Next_ltln <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> le_Suc_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Until_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> size <span class="skolem">φ2</span> <span class="main">+</span> <span class="numeral">4</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute add_mono flatten_sigma_1_length<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inequality_1<span class="main">[</span><span class="operator">OF</span> size_gr_0<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">φ2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inequality_2<span class="main">[</span><span class="operator">OF</span> size_gr_0 size_gr_0<span class="main">]</span> mult_le_mono2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Release_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span>  <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> inequality_2<span class="main">[</span><span class="operator">OF</span> size_gr_0 size_gr_0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>WeakUntil_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span>  <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> inequality_2<span class="main">[</span><span class="operator">OF</span> size_gr_0 size_gr_0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>StrongRelease_ltln <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> size <span class="skolem">φ1</span> <span class="main">+</span> <span class="numeral">4</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute add_mono flatten_sigma_1_length<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inequality_1<span class="main">[</span><span class="operator">OF</span> size_gr_0<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">φ1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="skolem">φ1</span> <span class="main">+</span> size <span class="skolem">φ2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inequality_2<span class="main">[</span><span class="operator">OF</span> size_gr_0 size_gr_0<span class="main">]</span> mult_le_mono2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="main">(</span><span class="skolem">φ1</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted">"<span class="entity">normal_form_length_upper_bound</span>"</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">normal_form_length_upper_bound</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>
    <span class="main">≡</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">^</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted">"<span class="entity">normal_form_disjunct_with_flatten_pi_2_length</span>"</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">normal_form_disjunct_with_flatten_pi_2_length</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span>
    <span class="main">≡</span> size <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ψ</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> size <span class="main">(</span><span class="bound">ψ</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ψ</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">.</span> size <span class="main">(</span><span class="bound">ψ</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted">"<span class="entity">normal_form_with_flatten_pi_2_length</span>"</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">normal_form_with_flatten_pi_2_length</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> 
    <span class="main">≡</span> <span class="main">∑</span><span class="main">(</span><span class="bound">M</span><span class="main">,</span> <span class="bound">N</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">M</span><span class="main">,</span> <span class="bound">N</span><span class="main">)</span> <span class="main">|</span> <span class="bound">M</span> <span class="bound">N</span><span class="main">.</span> <span class="bound">M</span> <span class="main">⊆</span> subformulas<span class="hidden">⇩</span><sub>μ</sub> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="bound">N</span> <span class="main">⊆</span> subformulas<span class="hidden">⇩</span><sub>ν</sub> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span><span class="main">.</span> normal_form_disjunct_with_flatten_pi_2_length <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">M</span> <span class="bound">N</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted">"<span class="entity">normal_form_disjunct_with_flatten_sigma_2_length</span>"</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">normal_form_disjunct_with_flatten_sigma_2_length</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> 
    <span class="main">≡</span> size <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ψ</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> size <span class="main">(</span><span class="bound">ψ</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ψ</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">.</span> size <span class="main">(</span><span class="bound">ψ</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted">"<span class="entity">normal_form_with_flatten_sigma_2_length</span>"</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">normal_form_with_flatten_sigma_2_length</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> 
    <span class="main">≡</span> <span class="main">∑</span><span class="main">(</span><span class="bound">M</span><span class="main">,</span> <span class="bound">N</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">M</span><span class="main">,</span> <span class="bound">N</span><span class="main">)</span> <span class="main">|</span> <span class="bound">M</span> <span class="bound">N</span><span class="main">.</span> <span class="bound">M</span> <span class="main">⊆</span> subformulas<span class="hidden">⇩</span><sub>μ</sub> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="bound">N</span> <span class="main">⊆</span> subformulas<span class="hidden">⇩</span><sub>ν</sub> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span><span class="main">.</span> normal_form_disjunct_with_flatten_sigma_2_length <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">M</span> <span class="bound">N</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> normal_form_disjunct_length_upper_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⊆</span> subformulas<span class="hidden">⇩</span><sub>μ</sub> <span class="free">φ</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">⊆</span> subformulas<span class="hidden">⇩</span><sub>ν</sub> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"normal_form_disjunct_with_flatten_sigma_2_length <span class="free">φ</span> <span class="free">M</span> <span class="free">N</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="free">φ</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>size <span class="free">φ</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis1</span>"</span></span><span class="main">)</span>
    <span class="quoted"><span class="quoted">"normal_form_disjunct_with_flatten_pi_2_length <span class="free">φ</span> <span class="free">M</span> <span class="free">N</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="free">φ</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>size <span class="free">φ</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"size <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="var">?n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="var">?n</span> <span class="main">*</span> <span class="main">(</span><span class="var">?n</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="var">?n</span> <span class="main">*</span> <span class="main">(</span><span class="var">?n</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> finite_M<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> card_M<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">M</span> <span class="main">≤</span> <span class="var">?n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> finite_subset subformulas<span class="hidden">⇩</span><sub>μ</sub>_finite<span class="main">)</span>
       <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> card_mono order_trans subformulas<span class="hidden">⇩</span><sub>μ</sub>_subfrmlsn subfrmlsn_card subfrmlsn_finite<span class="main">)</span> 

  <span class="keyword1"><span class="command">have</span></span> finite_N<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> card_N<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">N</span> <span class="main">≤</span> <span class="var">?n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> finite_subset subformulas<span class="hidden">⇩</span><sub>ν</sub>_finite<span class="main">)</span>
       <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> card_mono order_trans subformulas<span class="hidden">⇩</span><sub>ν</sub>_subfrmlsn subfrmlsn_card subfrmlsn_finite<span class="main">)</span> 

  <span class="keyword1"><span class="command">have</span></span> size_M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">⟹</span> size <span class="bound">ψ</span> <span class="main">≤</span> size <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> size_N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">⟹</span> size <span class="bound">ψ</span> <span class="main">≤</span> size <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eq_iff in_mono less_imp_le subformulas<span class="hidden">⇩</span><sub>μ</sub>_subfrmlsn subfrmlsn_size<span class="main">)</span>
       <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> eq_iff in_mono less_imp_le subformulas<span class="hidden">⇩</span><sub>ν</sub>_subfrmlsn subfrmlsn_size<span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> size_M'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">⟹</span> size <span class="main">(</span><span class="bound">ψ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">≤</span> size <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> size_N'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">⟹</span> size <span class="main">(</span><span class="bound">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">≤</span> size <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flatten_sigma_1_length flatten_pi_1_length order_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">ψ</span> <span class="main">∈</span> <span class="free">M</span><span class="main">.</span> size <span class="main">(</span><span class="bound">ψ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?n</span> <span class="main">*</span> <span class="var">?n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">ψ</span> <span class="main">∈</span> <span class="free">N</span><span class="main">.</span> size <span class="main">(</span><span class="bound">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?n</span> <span class="main">*</span> <span class="var">?n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_bounded_above<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main">,</span> <span class="operator">OF</span> size_M'<span class="main">]</span> sum_bounded_above<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">N</span></span><span class="main">,</span> <span class="operator">OF</span> size_N'<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> mult_le_mono<span class="main">[</span><span class="operator">OF</span> card_M<span class="main">]</span> mult_le_mono<span class="main">[</span><span class="operator">OF</span> card_N<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
     
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">ψ</span> <span class="main">∈</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span>size <span class="main">(</span><span class="bound">ψ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?n</span> <span class="main">*</span> <span class="main">(</span><span class="var">?n</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">ψ</span> <span class="main">∈</span> <span class="free">N</span><span class="main">.</span> <span class="main">(</span>size <span class="main">(</span><span class="bound">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?n</span> <span class="main">*</span> <span class="main">(</span><span class="var">?n</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sum_associative<span class="main">[</span><span class="operator">OF</span> finite_M<span class="main">]</span> sum_associative<span class="main">[</span><span class="operator">OF</span> finite_N<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> card_M card_N <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"normal_form_disjunct_with_flatten_sigma_2_length <span class="free">φ</span> <span class="free">M</span> <span class="free">N</span> <span class="main">≤</span> <span class="var">?b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"normal_form_disjunct_with_flatten_pi_2_length <span class="free">φ</span> <span class="free">M</span> <span class="free">N</span> <span class="main">≤</span> <span class="var">?b</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> normal_form_disjunct_with_flatten_sigma_2_length_def normal_form_disjunct_with_flatten_pi_2_length_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> flatten_sigma_2_length flatten_pi_2_length add_le_mono<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis1</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?thesis2</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> normal_form_length_upper_bound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"normal_form_with_flatten_sigma_2_length <span class="free">φ</span> <span class="main">≤</span> normal_form_length_upper_bound <span class="free">φ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis1</span>"</span></span><span class="main">)</span>
  <span class="quoted"><span class="quoted">"normal_form_with_flatten_pi_2_length <span class="free">φ</span> <span class="main">≤</span> normal_form_length_upper_bound <span class="free">φ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"size <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>size <span class="free">φ</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>size <span class="free">φ</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">M</span><span class="main">,</span> <span class="bound">N</span><span class="main">)</span> <span class="main">|</span> <span class="bound">M</span> <span class="bound">N</span><span class="main">.</span> <span class="bound">M</span> <span class="main">⊆</span> subformulas<span class="hidden">⇩</span><sub>μ</sub> <span class="free">φ</span> <span class="main">∧</span> <span class="bound">N</span> <span class="main">⊆</span> subformulas<span class="hidden">⇩</span><sub>ν</sub> <span class="free">φ</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">⊆</span> subformulas<span class="hidden">⇩</span><sub>μ</sub> <span class="free">φ</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">N</span><span class="main">.</span> <span class="bound">N</span> <span class="main">⊆</span> subformulas<span class="hidden">⇩</span><sub>ν</sub> <span class="free">φ</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?choices</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">moreover</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">⊆</span> subformulas<span class="hidden">⇩</span><sub>μ</sub> <span class="free">φ</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">^</span> <span class="main">(</span>card <span class="main">(</span>subformulas<span class="hidden">⇩</span><sub>μ</sub> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">N</span><span class="main">.</span> <span class="bound">N</span> <span class="main">⊆</span> subformulas<span class="hidden">⇩</span><sub>ν</sub> <span class="free">φ</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">^</span> <span class="main">(</span>card <span class="main">(</span>subformulas<span class="hidden">⇩</span><sub>ν</sub> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_Pow <span class="keyword1"><span class="command">unfolding</span></span> Pow_def <span class="keyword1"><span class="command">using</span></span> subformulas<span class="hidden">⇩</span><sub>μ</sub>_finite subformulas<span class="hidden">⇩</span><sub>ν</sub>_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">ultimately</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?choices</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>card <span class="main">(</span>subfrmlsn <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">≤</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subformulas<span class="hidden">⇩</span><sub>μ</sub><span class="hidden">⇩</span><sub>ν</sub>_card card_cartesian_product subformulas<span class="hidden">⇩</span><sub>μ</sub><span class="hidden">⇩</span><sub>ν</sub>_subfrmlsn subfrmlsn_finite Suc_1 card_mono lessI power_add power_increasing_iff<span class="main">)</span>
  
  <span class="keyword1"><span class="command">moreover</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">^</span> <span class="main">(</span>card <span class="main">(</span>subfrmlsn <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="var">?n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> power_increasing<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">::</span> nat"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subfrmlsn_card<span class="main">)</span>
  
  <span class="keyword1"><span class="command">ultimately</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> bar<span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="main">(</span>card <span class="var">?choices</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">^</span> <span class="var">?n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> of_nat_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"normal_form_with_flatten_sigma_2_length <span class="free">φ</span> <span class="main">≤</span> of_nat <span class="main">(</span>card <span class="var">?choices</span><span class="main">)</span> <span class="main">*</span> <span class="var">?b</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> normal_form_with_flatten_sigma_2_length_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_bounded_above<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> normal_form_disjunct_length_upper_bound<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"normal_form_with_flatten_pi_2_length <span class="free">φ</span> <span class="main">≤</span> of_nat <span class="main">(</span>card <span class="var">?choices</span><span class="main">)</span> <span class="main">*</span> <span class="var">?b</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> normal_form_with_flatten_pi_2_length_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_bounded_above<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> normal_form_disjunct_length_upper_bound<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis1</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?thesis2</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> normal_form_length_upper_bound_def 
    <span class="keyword1"><span class="command">using</span></span> mult_le_mono1 order_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proper Subformulas›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We prove that the number of (proper) subformulas (sf) in a disjunct is linear and not exponential.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltln <span class="main">⇒</span> <span class="tfree">'a</span> ltln set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sf</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">sf</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">sf</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sf</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">sf</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">sf</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sf</span> <span class="main">(</span><span class="keyword1">X<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="keyword1">X<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free">sf</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sf</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free">sf</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">sf</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sf</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free">sf</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">sf</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sf</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free">sf</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">sf</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sf</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free">sf</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">sf</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sf</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sf_finite<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>sf <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sf_subset_subfrmlsn<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"sf <span class="free">φ</span> <span class="main">⊆</span> subfrmlsn <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sf_size<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> sf <span class="free">φ</span> <span class="main">⟹</span> size <span class="free">ψ</span> <span class="main">≤</span> size <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sf_sf_subset<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> sf <span class="free">φ</span> <span class="main">⟹</span> sf <span class="free">ψ</span> <span class="main">⊆</span> sf <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subfrmlsn_sf_subset<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> subfrmlsn <span class="free">φ</span> <span class="main">⟹</span> sf <span class="free">ψ</span> <span class="main">⊆</span> sf <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sf_subset_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sf <span class="free">φ</span> <span class="main">⊆</span> insert <span class="free">φ</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> subfrmlsn <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">≠</span> <span class="free">ψ</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sf <span class="free">ψ</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sf <span class="free">ψ</span> <span class="main">⊆</span> sf <span class="free">φ</span> <span class="main">-</span> <span class="main">{</span><span class="free">φ</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> subfrmlsn_sf_subset sf_size subfrmlsn_size <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flatten_pi_1_sf_subset<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"sf <span class="main">(</span><span class="free">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span><span class="main">∈</span>sf <span class="free">φ</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> flatten_sigma_1_sf_subset<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"sf <span class="main">(</span><span class="free">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span><span class="main">∈</span>sf <span class="free">φ</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> flatten_sigma_2_sf_subset<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"sf <span class="main">(</span><span class="free">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">ψ</span><span class="main">∈</span>sf <span class="free">φ</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sf_set1<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"sf <span class="main">(</span><span class="free">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> sf <span class="main">(</span><span class="free">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">ψ</span> <span class="main">∈</span> <span class="main">(</span>sf <span class="free">φ</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>sf <span class="main">(</span><span class="bound">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> sf <span class="main">(</span><span class="bound">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(* TODO: could be moved *)</span>
<span class="keyword1"><span class="command">lemma</span></span> ltln_not_idempotent <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span> <span class="main">≠</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="main">≠</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">≠</span> <span class="free">φ</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">≠</span> <span class="free">ψ</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span> <span class="main">≠</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="main">≠</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">≠</span> <span class="free">φ</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">≠</span> <span class="free">ψ</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">X<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="main">≠</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">≠</span> <span class="keyword1">X<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span> <span class="main">≠</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">≠</span> <span class="free">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="main">≠</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">≠</span> <span class="free">ψ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span> <span class="main">≠</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">≠</span> <span class="free">φ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="main">≠</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">≠</span> <span class="free">ψ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span> <span class="main">≠</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">≠</span> <span class="free">φ</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="main">≠</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">≠</span> <span class="free">ψ</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span> <span class="main">≠</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">≠</span> <span class="free">φ</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="main">≠</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">≠</span> <span class="free">ψ</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flatten_card_sf_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> sf <span class="bound">x</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="free">X</span> 
   <span class="main">∧</span> card <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="free">X</span> 
   <span class="main">∧</span> card <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> card <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_ranking_induct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">size</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">X</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">ψ</span> <span class="skolem">X</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∉</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">⟹</span> sf <span class="bound">χ</span> <span class="main">⊆</span> <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> sf_subset_subfrmlsn subfrmlsn_size <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span><span class="main">∈</span><span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="skolem">X</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span><span class="main">∈</span><span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="skolem">X</span>"</span></span>        
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span><span class="main">∈</span><span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> card <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      
      <span class="keyword1"><span class="command">moreover</span></span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lower1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> insert <span class="skolem">ψ</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?upper1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lower2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> insert <span class="skolem">ψ</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?upper2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lower3</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> insert <span class="skolem">ψ</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?upper3_cases</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">ψ</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">φ1</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">φ2</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">{</span><span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="bound">φ1</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="main">(</span><span class="bound">φ1</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">φ2</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">{</span><span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="bound">φ2</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?upper3</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="var">?upper3_cases</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> finite_upper1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?upper1</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> finite_upper2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?upper2</span><span class="main">)</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> finite_upper3<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?upper3</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> sf_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> card <span class="main">{</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">}</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> card <span class="main">{</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">}</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_insert_if le_less<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">hence</span></span> card_leq_3<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?upper3_cases</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>

      <span class="keyword1"><span class="command">note</span></span> card_subset_split_rule <span class="main">=</span> le_trans<span class="main">[</span><span class="operator">OF</span> card_mono card_Un_le<span class="main">]</span>

      <span class="keyword1"><span class="command">have</span></span> sf_in_X<span class="main">:</span> <span class="quoted"><span class="quoted">"sf <span class="skolem">ψ</span> <span class="main">⊆</span> insert <span class="skolem">ψ</span> <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lower1</span> <span class="main">⊆</span> <span class="var">?upper1</span> <span class="main">∧</span> <span class="var">?lower2</span> <span class="main">⊆</span> <span class="var">?upper2</span> <span class="main">∧</span> <span class="var">?lower3</span> <span class="main">⊆</span> <span class="var">?upper3</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_ltln <span class="skolem">ψ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">ψ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"sf <span class="skolem">ψ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊆</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"sf <span class="skolem">ψ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊆</span> <span class="skolem">X</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sf_subset_insert<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sf_in_X<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> And_ltln<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sf <span class="main">(</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sf <span class="main">(</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sf <span class="main">(</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">using</span></span> flatten_sigma_2_sf_subset<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> And_ltln<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">using</span></span> flatten_pi_1_sf_subset<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> And_ltln<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> flatten_sigma_1_sf_subset * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> And_ltln<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Or_ltln <span class="skolem">ψ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">ψ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"sf <span class="skolem">ψ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊆</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"sf <span class="skolem">ψ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊆</span> <span class="skolem">X</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sf_subset_insert<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sf_in_X<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> Or_ltln<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sf <span class="main">(</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sf <span class="main">(</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sf <span class="main">(</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">using</span></span> flatten_sigma_2_sf_subset<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Or_ltln<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">using</span></span> flatten_pi_1_sf_subset<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Or_ltln<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> flatten_sigma_1_sf_subset * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Or_ltln<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Next_ltln <span class="skolem">ψ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"sf <span class="skolem">ψ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊆</span> <span class="skolem">X</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sf_subset_insert<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sf_in_X<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> Next_ltln<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sf <span class="main">(</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">}</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sf <span class="main">(</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sf <span class="main">(</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">using</span></span> flatten_sigma_2_sf_subset<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Next_ltln<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">using</span></span> flatten_pi_1_sf_subset<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Next_ltln<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> flatten_sigma_1_sf_subset * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Next_ltln<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Until_ltln <span class="skolem">ψ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">ψ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"sf <span class="skolem">ψ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊆</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"sf <span class="skolem">ψ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊆</span> <span class="skolem">X</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sf_subset_insert<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sf_in_X<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> Until_ltln<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sf <span class="main">(</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">}</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sf <span class="main">(</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sf <span class="main">(</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">using</span></span> flatten_sigma_2_sf_subset<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Until_ltln<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">using</span></span> flatten_pi_1_sf_subset<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Until_ltln<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> flatten_sigma_1_sf_subset * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Until_ltln<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Release_ltln <span class="skolem">ψ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">ψ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"sf <span class="skolem">ψ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊆</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"sf <span class="skolem">ψ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊆</span> <span class="skolem">X</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sf_subset_insert<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sf_in_X<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> Release_ltln<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sf <span class="main">(</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">ψ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span> <span class="main">∪</span> sf <span class="main">(</span><span class="skolem">ψ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sf <span class="main">(</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sf <span class="main">(</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">using</span></span> flatten_sigma_2_sf_subset<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Release_ltln<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">using</span></span> flatten_pi_1_sf_subset<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Release_ltln<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> flatten_sigma_1_sf_subset * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Release_ltln<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
        <span class="keyword1"><span class="command">moreover</span></span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sf <span class="main">(</span><span class="skolem">ψ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span><span class="main">∈</span><span class="skolem">X</span><span class="main">.</span> sf <span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>sf <span class="main">(</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>›</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Release_ltln<span class="main">)</span>
          
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Release_ltln<span class="main">)</span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>WeakUntil_ltln <span class="skolem">ψ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">ψ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"sf <span class="skolem">ψ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊆</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"sf <span class="skolem">ψ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊆</span> <span class="skolem">X</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sf_subset_insert<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sf_in_X<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> WeakUntil_ltln<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sf <span class="main">(</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">ψ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span> <span class="main">∪</span> sf <span class="main">(</span><span class="skolem">ψ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sf <span class="main">(</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sf <span class="main">(</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">using</span></span> flatten_sigma_2_sf_subset<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> WeakUntil_ltln<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">using</span></span> flatten_pi_1_sf_subset<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> WeakUntil_ltln<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> flatten_sigma_1_sf_subset * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> WeakUntil_ltln<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
        <span class="keyword1"><span class="command">moreover</span></span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sf <span class="main">(</span><span class="skolem">ψ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span><span class="main">∈</span><span class="skolem">X</span><span class="main">.</span> sf <span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>sf <span class="main">(</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>›</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> WeakUntil_ltln<span class="main">)</span>
          
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> WeakUntil_ltln<span class="main">)</span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">next</span></span> 
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>StrongRelease_ltln <span class="skolem">ψ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">ψ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"sf <span class="skolem">ψ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊆</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"sf <span class="skolem">ψ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊆</span> <span class="skolem">X</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sf_subset_insert<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sf_in_X<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> StrongRelease_ltln<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
          
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sf <span class="main">(</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">}</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sf <span class="main">(</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sf <span class="main">(</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">using</span></span> flatten_sigma_2_sf_subset<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> StrongRelease_ltln<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">using</span></span> flatten_pi_1_sf_subset<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> StrongRelease_ltln<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> flatten_sigma_1_sf_subset * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> StrongRelease_ltln<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?lower1</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?lower2</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?lower3</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> sf <span class="main">(</span><span class="bound">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> card_subset_split_rule<span class="main">[</span><span class="operator">OF</span> finite_upper1<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?lower1</span></span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">using</span></span> card_subset_split_rule<span class="main">[</span><span class="operator">OF</span> finite_upper2<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?lower2</span></span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> card_subset_split_rule<span class="main">[</span><span class="operator">OF</span> finite_upper3<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?lower3</span></span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> card_leq_3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="skolem">ψ</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> card <span class="skolem">X</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ψ</span> <span class="main">∉</span> <span class="skolem">X</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">X</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">⟹</span> <span class="var">?case</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_absorb<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
      
<span class="keyword1"><span class="command">theorem</span></span> flatten_card_sf<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">⋃</span><span class="bound">ψ</span> <span class="main">∈</span> sf <span class="free">φ</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>sf <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t1</span>"</span></span><span class="main">)</span> 
  <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">⋃</span><span class="bound">ψ</span> <span class="main">∈</span> sf <span class="free">φ</span><span class="main">.</span> sf <span class="main">(</span><span class="bound">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>sf <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t2</span>"</span></span><span class="main">)</span>
  <span class="quoted"><span class="quoted">"card <span class="main">(</span>sf <span class="main">(</span><span class="free">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> sf <span class="main">(</span><span class="free">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> card <span class="main">(</span>sf <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t3</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">⋃</span><span class="bound">ψ</span> <span class="main">∈</span> sf <span class="free">φ</span><span class="main">.</span> sf <span class="bound">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> sf <span class="main">(</span><span class="bound">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> card <span class="main">(</span>sf <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flatten_card_sf_induct<span class="main">[</span><span class="operator">OF</span> sf_finite sf_sf_subset<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>sf <span class="free">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> sf <span class="main">(</span><span class="free">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="bound">ψ</span> <span class="main">∈</span> sf <span class="free">φ</span><span class="main">.</span> sf <span class="bound">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> sf <span class="main">(</span><span class="bound">ψ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_mono<span class="main">[</span><span class="operator">OF</span> _ sf_set1<span class="main">]</span> sf_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span> <span class="var"><span class="quoted"><span class="var">?t2</span></span></span> <span class="var"><span class="quoted"><span class="var">?t3</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> flatten_card_sf_induct<span class="main">[</span><span class="operator">OF</span> sf_finite sf_sf_subset<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> flatten_sigma_2_card_sf<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"card <span class="main">(</span>sf <span class="main">(</span><span class="free">φ</span><span class="main">[</span><span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span>card <span class="main">(</span>sf <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sf_finite order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ flatten_card_sf<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"card <span class="main"><span class="main"><span class="main">(</span></span></span>sf <span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">φ</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="free"><span class="free"><span class="free">M</span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> card_mono<span class="main"><span class="main">]</span></span> finite_UnI Un_upper1<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Normal_Form_Code_Export">
<div class="head">
<h1>Theory Normal_Form_Code_Export</h1>
</div>
<pre class="source"><span class="comment1">(*
    Author:   Salomon Sickert
    License:  BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Code Export›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Normal_Form_Code_Export <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../LTL/Code_Equations.html">LTL.Code_Equations</a>
  <a href="../LTL/Rewriting.html">LTL.Rewriting</a>
  <a href="../LTL/Disjunctive_Normal_Form.html">LTL.Disjunctive_Normal_Form</a>
  <a href="../../HOL/HOL/String.html">HOL.String</a>
  <a href="Normal_Form.html">Normal_Form</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">flatten_pi_1_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"String.literal ltln <span class="main">⇒</span> String.literal ltln list <span class="main">⇒</span> String.literal ltln"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">flatten_pi_1_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">flatten_pi_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">flatten_pi_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">false<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flatten_pi_1_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">flatten_pi_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">flatten_pi_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flatten_pi_1_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">flatten_pi_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">flatten_pi_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">false<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flatten_pi_1_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">flatten_pi_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">flatten_pi_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flatten_pi_1_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">flatten_pi_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">flatten_pi_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flatten_pi_1_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">flatten_pi_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">flatten_pi_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flatten_pi_1_list</span> <span class="main">(</span><span class="keyword1">X<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="keyword1">X<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">flatten_pi_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flatten_pi_1_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">flatten_sigma_1_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"String.literal ltln <span class="main">⇒</span> String.literal ltln list <span class="main">⇒</span> String.literal ltln"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">flatten_sigma_1_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">flatten_sigma_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">flatten_sigma_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flatten_sigma_1_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">flatten_sigma_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">flatten_sigma_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flatten_sigma_1_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">flatten_sigma_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">flatten_sigma_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flatten_sigma_1_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">flatten_sigma_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">flatten_sigma_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flatten_sigma_1_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">flatten_sigma_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">flatten_sigma_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flatten_sigma_1_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">flatten_sigma_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">flatten_sigma_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flatten_sigma_1_list</span> <span class="main">(</span><span class="keyword1">X<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span> <span class="keyword1">X<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">flatten_sigma_1_list</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flatten_sigma_1_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">flatten_sigma_2_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"String.literal ltln <span class="main">⇒</span> String.literal ltln list <span class="main">⇒</span> String.literal ltln"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">flatten_sigma_2_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">flatten_sigma_2_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">flatten_sigma_2_list</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flatten_sigma_2_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">flatten_sigma_2_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="main">(</span><span class="free">flatten_sigma_2_list</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span>flatten_pi_1_list <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flatten_sigma_2_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">flatten_sigma_2_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">flatten_sigma_2_list</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flatten_sigma_2_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">flatten_sigma_2_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span>flatten_pi_1_list <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">flatten_sigma_2_list</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flatten_sigma_2_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">flatten_sigma_2_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">flatten_sigma_2_list</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flatten_sigma_2_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">flatten_sigma_2_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">flatten_sigma_2_list</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flatten_sigma_2_list</span> <span class="main">(</span><span class="keyword1">X<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="keyword1">X<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free">flatten_sigma_2_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flatten_sigma_2_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flatten_code_equations<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span><span class="main">[</span>set <span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> flatten_pi_1_list <span class="free">φ</span> <span class="free">M</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span><span class="main">[</span>set <span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> flatten_sigma_1_list <span class="free">φ</span> <span class="free">M</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span><span class="main">[</span>set <span class="free">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> flatten_sigma_2_list <span class="free">φ</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">and_list</span> <span class="main">≡</span> foldl And_ltln <span class="keyword1">true<span class="hidden">⇩</span><sub>n</sub></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">or_list</span> <span class="main">≡</span> foldl Or_ltln <span class="keyword1">false<span class="hidden">⇩</span><sub>n</sub></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">normal_form_disjunct</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">::</span> String.literal ltln<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> 
  <span class="main">≡</span> <span class="main">(</span>flatten_sigma_2_list <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>
      <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span>and_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span>flatten_sigma_1_list <span class="bound">ψ</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> 
      <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span>and_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span>flatten_pi_1_list    <span class="bound">ψ</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">normal_form</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">::</span> String.literal ltln<span class="main">)</span> 
  <span class="main">≡</span> or_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">M</span><span class="main">,</span> <span class="bound">N</span><span class="main">)</span><span class="main">.</span> normal_form_disjunct <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">M</span> <span class="bound">N</span><span class="main">)</span> <span class="main">(</span>advice_sets <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> and_list_semantic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> and_list <span class="free">xs</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">auto</span> 

<span class="keyword1"><span class="command">lemma</span></span> or_list_semantic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> or_list <span class="free">xs</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> normal_form_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> normal_form <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">⊆</span> subformulas<span class="hidden">⇩</span><sub>μ</sub> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">⊆</span> subformulas<span class="hidden">⇩</span><sub>ν</sub> <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">[</span><span class="skolem">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">M</span><span class="main">.</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">ψ</span><span class="main">[</span><span class="skolem">N</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">ψ</span><span class="main">[</span><span class="skolem">M</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> normal_form_with_flatten_sigma_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ms</span></span> <span class="skolem"><span class="skolem">ns</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> set <span class="skolem">ms</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> set <span class="skolem">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ms_ns_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ms</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>advice_sets <span class="free">φ</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> advice_sets_subformulas<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> normal_form_disjunct <span class="free">φ</span> <span class="skolem">ms</span> <span class="skolem">ns</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c1 c2 c3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_list_semantic normal_form_disjunct_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> normal_form <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> normal_form_def or_list_semantic ms_ns_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> normal_form <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ms</span></span> <span class="skolem"><span class="skolem">ns</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ms</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>advice_sets <span class="free">φ</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> normal_form_disjunct <span class="free">φ</span> <span class="skolem">ms</span> <span class="skolem">ns</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> normal_form_def or_list_semantic <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ms</span> <span class="main">⊆</span> subformulas<span class="hidden">⇩</span><sub>μ</sub> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ns</span> <span class="main">⊆</span> subformulas<span class="hidden">⇩</span><sub>ν</sub> <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span><span class="main">[</span>set <span class="skolem">ms</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ψ</span> <span class="main">∈</span> set <span class="skolem">ms</span><span class="main">.</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">ψ</span><span class="main">[</span>set <span class="skolem">ns</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Σ</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ψ</span> <span class="main">∈</span> set <span class="skolem">ns</span><span class="main">.</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">F<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="keyword1">G<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">ψ</span><span class="main">[</span>set <span class="skolem">ms</span><span class="keyword1">]<span class="hidden">⇩</span><sub>Π</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> advice_sets_element_subfrmlsn 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> and_list_semantic normal_form_disjunct_def<span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> normal_form_with_flatten_sigma_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">normal_form_with_simplifier</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">::</span> String.literal ltln<span class="main">)</span> 
  <span class="main">≡</span> min_dnf <span class="main">(</span>simplify Slow <span class="main">(</span>normal_form <span class="main">(</span>simplify Slow <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> ltl_semantics_min_dnf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">C</span> <span class="main">∈</span> min_dnf <span class="free">φ</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ψ</span><span class="main">.</span> <span class="bound">ψ</span> <span class="main">|∈|</span> <span class="bound">C</span> <span class="main">⟶</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">ψ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">ψ</span><span class="main">.</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">ψ</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ltl_models_equiv_prop_entailment <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fset <span class="skolem">M'</span> <span class="main">⊆</span> <span class="var">?M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">∈</span> min_dnf <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_dnf_iff_prop_assignment_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_mono mem_Collect_eq notin_fset<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">ψ</span><span class="main">.</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">ψ</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fset <span class="skolem">M'</span> <span class="main">⊆</span> <span class="var">?M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">∈</span> min_dnf <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> notin_fset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_dnf_iff_prop_assignment_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ltl_models_equiv_prop_entailment <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">C</span> <span class="main">∈</span> <span class="main">(</span>normal_form_with_simplifier <span class="free">φ</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ψ</span><span class="main">.</span> <span class="bound">ψ</span> <span class="main">|∈|</span> <span class="bound">C</span> <span class="main">⟶</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">ψ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> normal_form_with_simplifier_def ltl_semantics_min_dnf<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
  <span class="keyword1"><span class="command">using</span></span> normal_form_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In order to export the code run \texttt{isabelle build -D [PATH] -e}.›</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">normal_form</span></span> <span class="keyword2"><span class="keyword">in</span></span> SML
<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">normal_form_with_simplifier</span></span> <span class="keyword2"><span class="keyword">in</span></span> SML

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>